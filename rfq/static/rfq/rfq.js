/*
 * RFQ System Application
 */
window.SystemApps = window.SystemApps || {};
window.__RFQ_BUILD_VERSION__ = 'v76_2'; // FINAL SUMMARY - Challenge selected items, selection indicator

window.SystemApps.rfq = {
    title: 'RFQ System',
    options: {
        width: 1100,
        height: 750
    },
    render: function () {
        return `
            <div class="rfq-layout rfq-standalone">
                <div class="rfq-topbar">
                    <div class="rfq-brand">‚ö° OptiChain RFQ</div>
                    <div class="rfq-topbar-spacer"></div>
                    <div id="topbar-datetime" style="margin-right:12px; font-size:13px; white-space:nowrap; color: rgba(255,255,255,0.7); font-weight: 500;"></div>
                    <div id="topbar-user" style="margin-right:10px; font-size:12px; color: rgba(255,255,255,0.92);"></div>
                    <select id="topbar-company-scope" style="display:none; margin-right:8px; font-size:12px; background:#0b1224; color:#e2e8f0; border:1px solid #334155; border-radius:6px; padding:4px 8px;"></select>
                    <a id="topbar-mega-link" href="/mega-admin/" style="display:none; margin-right:8px; color:#bfdbfe; font-size:12px; text-decoration:none;">Mega Admin</a>
                    <a href="/logout/?next=/login/" style="color:#fecaca; font-size:12px; text-decoration:none;">Logout</a>
                </div>


<div class="rfq-main">
  <div class="project-card">
    <div class="project-tabs" role="tablist" aria-label="Project tabs">
            <!-- 1. Main - Blue -->
            <button id="nav-main" class="tab tab-main" type="button" data-color="#3b82f6">üìä Main</button>

            <!-- 2. Global dropdown - Cyan -->
            <div class="nav-dropdown" id="nav-dropdown-global">
                <button class="tab nav-dropdown-btn tab-global" type="button" data-color="#06b6d4">üåê Global ‚ñæ</button>
                <div class="nav-dropdown-menu">
                    <button id="nav-supplier-list" class="nav-dropdown-item" type="button">Supplier List</button>
                    <button id="nav-database" class="nav-dropdown-item" type="button">Database</button>
                    <button id="nav-quotes" class="nav-dropdown-item" type="button">üí∞ Quotes</button>
                    <button id="nav-doc-manager" class="nav-dropdown-item" type="button">üìÇ Document Manager</button>
                </div>
            </div>

            <!-- 3. Project selector - Indigo -->
            <div class="nav-project-separator"></div>
            <button id="btn-open-project-picker" class="tab tab-project" type="button" data-color="#6366f1"><span class="nav-project-label">Project</span> <span id="topbar-project-name">Select...</span></button>

            <!-- 4. Project-specific tabs (hidden until project selected) -->
            <div class="project-tabs-group">
                <!-- Dashboard - Emerald -->
                <button id="nav-dashboard" class="tab tab-dashboard" type="button" data-color="#10b981">üìà Dashboard</button>

                <!-- PROJECT DATA dropdown - Amber -->
                <div class="nav-dropdown" id="nav-dropdown-project">
                    <button class="tab nav-dropdown-btn tab-data" type="button" data-color="#f59e0b">üì¶ Project Data ‚ñæ</button>
                    <div class="nav-dropdown-menu">
                        <button id="nav-project-suppliers" class="nav-dropdown-item" type="button">Project Suppliers</button>
                        <button id="nav-items" class="nav-dropdown-item" type="button">Items</button>
                        <button id="nav-suppliers" class="nav-dropdown-item" type="button">Quote Add</button>
                        <button id="nav-samepart" class="nav-dropdown-item" type="button">üí∞ Price Finder</button>
                    </div>
                </div>

                <!-- Quoting Process - Purple -->
                <button id="nav-quoting" class="tab tab-quoting" type="button" data-color="#8b5cf6">üíº Quoting Process</button>
            </div>

            <!-- 5. + New Project -->
            <button id="nav-new-project" class="tab tab-new-project" type="button">+ New Project</button>

            <!-- Spacer pushes Settings to far right -->
            <div style="flex:1;"></div>

            <!-- 6. Settings dropdown - Rose (far right) -->
            <div class="nav-dropdown" id="nav-dropdown-settings">
                <button class="tab nav-dropdown-btn tab-settings" type="button" data-color="#f43f5e">‚öôÔ∏è Settings ‚ñæ</button>
                <div class="nav-dropdown-menu">
                    <button id="nav-settings" class="nav-dropdown-item" type="button">Settings</button>
                    <button id="nav-export" class="nav-dropdown-item" type="button">Export</button>
                    <button id="nav-data" class="nav-dropdown-item" type="button">Data Manager</button>
                </div>
            </div>
</div>

    <div class="rfq-content project-card-body">

                        

                        <div id="view-main" class="view-section hidden" style="overflow:hidden;">
    <div style="display:flex; flex-direction:column; height:100%; min-height:0; padding:20px; gap:16px;">
        <!-- TOP HEADER BAR -->
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px; flex-shrink:0;">
            <div style="display:flex; align-items:center; gap:16px;">
                <div style="font-size:24px; font-weight:800;">üìä Global Overview</div>
                <span id="main-recent" style="font-size:12px; color:#666; background:#f0f0f5; padding:4px 10px; border-radius:6px;">Last update: ‚Äî</span>
            </div>
            <div style="display:flex; gap:10px; align-items:center;">
                <input type="text" id="main-filter" class="rfq-input" placeholder="Search projects..." style="width:180px; font-size:12px;">
                <select id="main-status-filter" class="rfq-input" style="font-size:12px;">
                    <option value="">All Status</option>
                    <option value="Created">Created</option>
                    <option value="In process">In Process</option>
                    <option value="Done">Done</option>
                </select>
                <button id="btn-main-edit-layout" class="btn-secondary" type="button" style="font-size:11px;">üé® Edit Layout</button>
                <button id="btn-main-refresh" class="btn-primary" type="button">‚Üª Refresh</button>
                <button id="btn-main-new-project" class="btn-success" type="button">+ New Project</button>
            </div>
        </div>

        <!-- DASHBOARD GRID -->
        <div id="main-dashboard-grid" class="main-dashboard-grid" style="flex:1; min-height:0; display:grid; grid-template-columns:repeat(4, 1fr); gap:16px; overflow-y:auto; align-content:start; padding-bottom:24px;">

            <!-- BOX: Key Metrics -->
            <div class="main-box" data-box-id="main-kpis" data-col-span="1" data-row-span="1">
                <div class="main-box-header">
                    <span class="main-box-title">üìà Key Metrics</span>
                    <div class="main-box-controls">
                        <span class="main-box-size-indicator">1√ó1</span>
                        <button class="main-box-btn" data-action="resize-smaller" title="Width ‚àí">‚óÄ</button>
                        <button class="main-box-btn" data-action="resize-larger" title="Width +">‚ñ∂</button>
                        <button class="main-box-btn height-btn" data-action="height-smaller" title="Height ‚àí">‚ñ≤</button>
                        <button class="main-box-btn height-btn" data-action="height-larger" title="Height +">‚ñº</button>
                        <button class="main-box-btn" data-action="toggle-visibility" title="Hide">üëÅ</button>
                        <button class="main-box-btn" data-action="delete-box" title="Delete" style="color:#ef4444;">üóë</button>
                    </div>
                </div>
                <div class="main-box-content">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                        <div class="sd-kpi"><div class="sd-kpi-l">Projects</div><div class="sd-kpi-v" id="main-kpi-projects">0</div></div>
                        <div class="sd-kpi"><div class="sd-kpi-l">Items</div><div class="sd-kpi-v" id="main-kpi-items">0</div></div>
                        <div class="sd-kpi"><div class="sd-kpi-l">Suppliers</div><div class="sd-kpi-v" id="main-kpi-suppliers">0</div></div>
                        <div class="sd-kpi"><div class="sd-kpi-l">RFQ Bundles</div><div class="sd-kpi-v" id="main-kpi-open-bundles">0</div></div>
                    </div>
                    <div class="sd-kpi" style="margin-top:10px; background:linear-gradient(135deg,#dcfce7,#bbf7d0); border:1px solid #22c55e;">
                        <div class="sd-kpi-l" style="color:#166534;">Total Value (EUR)</div>
                        <div class="sd-kpi-v" id="main-kpi-value" style="color:#16a34a; font-size:24px;">‚Ç¨0</div>
                    </div>
                </div>
            </div>

            <!-- BOX: Deadline Alerts -->
            <div class="main-box" data-box-id="main-deadlines" data-col-span="1" data-row-span="1">
                <div class="main-box-header">
                    <span class="main-box-title">‚è∞ Deadline Alerts</span>
                    <div class="main-box-controls">
                        <span class="main-box-size-indicator">1√ó1</span>
                        <button class="main-box-btn" data-action="resize-smaller" title="Width ‚àí">‚óÄ</button>
                        <button class="main-box-btn" data-action="resize-larger" title="Width +">‚ñ∂</button>
                        <button class="main-box-btn height-btn" data-action="height-smaller" title="Height ‚àí">‚ñ≤</button>
                        <button class="main-box-btn height-btn" data-action="height-larger" title="Height +">‚ñº</button>
                        <button class="main-box-btn" data-action="toggle-visibility" title="Hide">üëÅ</button>
                        <button class="main-box-btn" data-action="delete-box" title="Delete" style="color:#ef4444;">üóë</button>
                    </div>
                </div>
                <div class="main-box-content">
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 14px; background:linear-gradient(135deg,#fee2e2,#fecaca); border-radius:8px; border-left:4px solid #dc2626;">
                            <span style="font-size:12px; font-weight:600; color:#991b1b;">üî¥ Overdue</span>
                            <span id="main-overdue" style="font-size:20px; font-weight:800; color:#dc2626;">0</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 14px; background:linear-gradient(135deg,#fef3c7,#fde68a); border-radius:8px; border-left:4px solid #f59e0b;">
                            <span style="font-size:12px; font-weight:600; color:#92400e;">üü° Due 7 days</span>
                            <span id="main-due-7" style="font-size:20px; font-weight:800; color:#d97706;">0</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 14px; background:linear-gradient(135deg,#dbeafe,#bfdbfe); border-radius:8px; border-left:4px solid #3b82f6;">
                            <span style="font-size:12px; font-weight:600; color:#1e40af;">üîµ Due 14 days</span>
                            <span id="main-due-soon" style="font-size:20px; font-weight:800; color:#2563eb;">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BOX: Project Status -->
            <div class="main-box" data-box-id="main-status" data-col-span="1" data-row-span="1">
                <div class="main-box-header">
                    <span class="main-box-title">üö¶ Project Status</span>
                    <div class="main-box-controls">
                        <span class="main-box-size-indicator">1√ó1</span>
                        <button class="main-box-btn" data-action="resize-smaller" title="Width ‚àí">‚óÄ</button>
                        <button class="main-box-btn" data-action="resize-larger" title="Width +">‚ñ∂</button>
                        <button class="main-box-btn height-btn" data-action="height-smaller" title="Height ‚àí">‚ñ≤</button>
                        <button class="main-box-btn height-btn" data-action="height-larger" title="Height +">‚ñº</button>
                        <button class="main-box-btn" data-action="toggle-visibility" title="Hide">üëÅ</button>
                        <button class="main-box-btn" data-action="delete-box" title="Delete" style="color:#ef4444;">üóë</button>
                    </div>
                </div>
                <div class="main-box-content">
                    <div id="main-status-breakdown" style="display:flex; flex-direction:column; gap:8px;"></div>
                </div>
            </div>

            <!-- BOX: Quick Actions -->
            <div class="main-box" data-box-id="main-actions" data-col-span="1" data-row-span="1">
                <div class="main-box-header">
                    <span class="main-box-title">‚ö° Quick Actions</span>
                    <div class="main-box-controls">
                        <span class="main-box-size-indicator">1√ó1</span>
                        <button class="main-box-btn" data-action="resize-smaller" title="Width ‚àí">‚óÄ</button>
                        <button class="main-box-btn" data-action="resize-larger" title="Width +">‚ñ∂</button>
                        <button class="main-box-btn height-btn" data-action="height-smaller" title="Height ‚àí">‚ñ≤</button>
                        <button class="main-box-btn height-btn" data-action="height-larger" title="Height +">‚ñº</button>
                        <button class="main-box-btn" data-action="toggle-visibility" title="Hide">üëÅ</button>
                        <button class="main-box-btn" data-action="delete-box" title="Delete" style="color:#ef4444;">üóë</button>
                    </div>
                </div>
                <div class="main-box-content">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                        <button id="btn-main-export" class="btn-secondary" type="button" style="padding:12px 8px; font-size:11px;">üì§ Export CSV</button>
                        <button class="btn-secondary" type="button" onclick="switchView('database')" style="padding:12px 8px; font-size:11px;">üóÑÔ∏è Database</button>
                        <button class="btn-secondary" type="button" onclick="switchView('supplier-list')" style="padding:12px 8px; font-size:11px;">üë• Suppliers</button>
                        <button class="btn-secondary" type="button" onclick="switchView('settings')" style="padding:12px 8px; font-size:11px;">‚öôÔ∏è Settings</button>
                    </div>
                    <div style="margin-top:10px; padding-top:10px; border-top:1px solid #e5e7eb;">
                        <div id="main-project-quick-open" style="font-size:11px; color:#64748b;">Select a project below to open</div>
                    </div>
                </div>
            </div>

            <!-- BOX: Projects Table (spans 3 columns) -->
            <div class="main-box" data-box-id="main-projects-table-box" data-col-span="3" data-row-span="1" style="grid-column:span 3;">
                <div class="main-box-header">
                    <span class="main-box-title">üìÅ All Projects</span>
                    <div class="main-box-controls">
                        <span id="main-projects-count" style="font-size:11px; color:#64748b; margin-right:10px;">0 projects</span>
                        <span class="main-box-size-indicator">3√ó1</span>
                        <button class="main-box-btn" data-action="resize-smaller" title="Width ‚àí">‚óÄ</button>
                        <button class="main-box-btn" data-action="resize-larger" title="Width +">‚ñ∂</button>
                        <button class="main-box-btn height-btn" data-action="height-smaller" title="Height ‚àí">‚ñ≤</button>
                        <button class="main-box-btn height-btn" data-action="height-larger" title="Height +">‚ñº</button>
                        <button class="main-box-btn" data-action="toggle-visibility" title="Hide">üëÅ</button>
                        <button class="main-box-btn" data-action="delete-box" title="Delete" style="color:#ef4444;">üóë</button>
                    </div>
                </div>
                <div class="main-box-content" style="padding:0; flex:1; overflow:auto;">
                    <table class="main-projects-table draggable-table" id="main-projects-table">
                        <thead style="position:sticky; top:0; background:white; z-index:1;">
                            <tr>
                                <th data-col-id="project" data-sortable="1" onclick="sortMainProjects('name')" style="min-width:180px; cursor:pointer;">Project</th>
                                <th data-col-id="status" data-sortable="1" onclick="sortMainProjects('status')" style="width:90px; cursor:pointer;">Status</th>
                                <th data-col-id="items" data-sortable="1" onclick="sortMainProjects('items')" style="width:50px; text-align:center; cursor:pointer;">Items</th>
                                <th data-col-id="done" data-sortable="1" onclick="sortMainProjects('done')" style="width:50px; text-align:center; cursor:pointer;">Done</th>
                                <th data-col-id="issue" data-sortable="1" onclick="sortMainProjects('issue')" style="width:50px; text-align:center; cursor:pointer;">Issue</th>
                                <th data-col-id="received" data-sortable="1" onclick="sortMainProjects('received')" style="width:90px; cursor:pointer;">Received</th>
                                <th data-col-id="deadline" data-sortable="1" onclick="sortMainProjects('deadline')" style="width:90px; cursor:pointer;">Deadline</th>
                                <th data-col-id="sent" data-sortable="1" onclick="sortMainProjects('sent')" style="width:90px; cursor:pointer;">Sent</th>
                                <th data-col-id="sent_to" style="width:100px;">Sent To</th>
                                <th data-col-id="actions" style="width:140px; text-align:center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="main-projects-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- BOX: Upcoming Deadlines (countdown style) -->
            <div class="main-box" data-box-id="main-countdown" data-col-span="1" data-row-span="1">
                <div class="main-box-header">
                    <span class="main-box-title">üìÖ Upcoming Deadlines</span>
                    <div class="main-box-controls">
                        <span class="main-box-size-indicator">1√ó1</span>
                        <button class="main-box-btn" data-action="resize-smaller" title="Width ‚àí">‚óÄ</button>
                        <button class="main-box-btn" data-action="resize-larger" title="Width +">‚ñ∂</button>
                        <button class="main-box-btn height-btn" data-action="height-smaller" title="Height ‚àí">‚ñ≤</button>
                        <button class="main-box-btn height-btn" data-action="height-larger" title="Height +">‚ñº</button>
                        <button class="main-box-btn" data-action="toggle-visibility" title="Hide">üëÅ</button>
                        <button class="main-box-btn" data-action="delete-box" title="Delete" style="color:#ef4444;">üóë</button>
                    </div>
                </div>
                <div class="main-box-content" style="padding:8px;">
                    <div id="main-upcoming-deadlines" style="display:flex; flex-direction:column; gap:6px; max-height:280px; overflow-y:auto;"></div>
                </div>
            </div>

            <!-- BOX: Top Suppliers -->
            <div class="main-box" data-box-id="main-top-suppliers" data-col-span="2" data-row-span="1" style="grid-column:span 2;">
                <div class="main-box-header">
                    <span class="main-box-title">üè≠ Top Suppliers</span>
                    <div class="main-box-controls">
                        <select id="main-supplier-sort" class="rfq-input" style="font-size:10px; padding:2px 6px;">
                            <option value="value">By Value</option>
                            <option value="items">By Items</option>
                            <option value="bundles">By Bundles</option>
                        </select>
                        <span class="main-box-size-indicator">2√ó1</span>
                        <button class="main-box-btn" data-action="resize-smaller" title="Width ‚àí">‚óÄ</button>
                        <button class="main-box-btn" data-action="resize-larger" title="Width +">‚ñ∂</button>
                        <button class="main-box-btn height-btn" data-action="height-smaller" title="Height ‚àí">‚ñ≤</button>
                        <button class="main-box-btn height-btn" data-action="height-larger" title="Height +">‚ñº</button>
                        <button class="main-box-btn" data-action="toggle-visibility" title="Hide">üëÅ</button>
                        <button class="main-box-btn" data-action="delete-box" title="Delete" style="color:#ef4444;">üóë</button>
                    </div>
                </div>
                <div class="main-box-content" style="padding:12px;">
                    <div id="main-top-suppliers-grid" style="display:grid; grid-template-columns:repeat(2, 1fr); gap:8px;">
                        <!-- Supplier cards will be rendered here -->
                    </div>
                    <div id="main-top-suppliers-tbody" style="display:none;"></div>
                </div>
            </div>

            <!-- BOX: Value by Project Chart -->
            <div class="main-box" data-box-id="main-value-chart" data-col-span="1" data-row-span="1">
                <div class="main-box-header">
                    <span class="main-box-title">üí∞ Value Distribution</span>
                    <div class="main-box-controls">
                        <span class="main-box-size-indicator">1√ó1</span>
                        <button class="main-box-btn" data-action="resize-smaller" title="Width ‚àí">‚óÄ</button>
                        <button class="main-box-btn" data-action="resize-larger" title="Width +">‚ñ∂</button>
                        <button class="main-box-btn height-btn" data-action="height-smaller" title="Height ‚àí">‚ñ≤</button>
                        <button class="main-box-btn height-btn" data-action="height-larger" title="Height +">‚ñº</button>
                        <button class="main-box-btn" data-action="toggle-visibility" title="Hide">üëÅ</button>
                        <button class="main-box-btn" data-action="delete-box" title="Delete" style="color:#ef4444;">üóë</button>
                    </div>
                </div>
                <div class="main-box-content">
                    <canvas id="main-value-chart-canvas" style="max-height:200px;"></canvas>
                </div>
            </div>

        </div>
    </div>
    <div id="main-error" class="main-error hidden"></div>
</div>

<div id="view-data-manager" class="view-section hidden">
  <div class="detail-shell">
    <div class="detail-shell-header">
      <div class="detail-shell-title">DATA ‚Äì Storage & Backup</div>
      <div class="detail-shell-actions">
        <button id="btn-data-refresh" class="btn-secondary" type="button">Refresh</button>
        <button id="btn-data-export-json" class="btn-secondary" type="button">Export Backup (JSON)</button>
        <button id="btn-data-import-json" class="btn-secondary" type="button">Import / Restore</button>
        <button id="btn-data-reset" class="btn-danger" type="button">Reset RFQ Data</button>
      </div>
    </div>
    <div class="detail-shell-body">
      <div id="data-manager-cards" class="data-cards"></div>
      <div class="main-card" style="margin-top:12px;">
        <div class="main-card-title">LocalStorage Keys</div>
        <div class="table-wrapper sd-table-wrap" style="max-height: 340px; overflow:auto;">
          <table id="table-data-keys" class="rfq-table">
            <thead>
              <tr>
                <th style="min-width:260px;">Key</th>
                <th style="width:140px;">Size</th>
                <th>Preview</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="main-card" style="margin-top:12px;">
        <div class="main-card-title">Help</div>
        <div class="muted" style="font-size:12px; line-height:1.6; padding:8px 2px;">
          Data is saved locally in your browser (LocalStorage) on this device. Use <b>Export Backup</b> to move data to another PC or to create a safety copy. 
          Import/Restore merges by project id (new projects are added, existing ids are updated).
        </div>
      </div>
    </div>
  </div>
  <input type="file" id="file-data-import" accept=".json" style="display:none;">
</div>

<div id="view-doc-manager" class="view-section hidden">
    <div class="detail-shell">
        <div class="detail-shell-header">
            <div class="detail-shell-title">üìÇ Document Tracking Manager</div>
            <div class="detail-shell-actions">
                <input type="text" id="doc-manager-filter" class="rfq-input" placeholder="Filter docs..." style="width: 200px;">
                <button onclick="window.renderGlobalDocumentManager()" class="btn-secondary">‚Üª Refresh</button>
            </div>
        </div>
        <div class="detail-shell-body">
             <div class="main-card">
                <div id="doc-manager-content" style="min-height: 400px;"></div>
             </div>
        </div>
    </div>
</div>

<div id="view-project-detail" class="view-section hidden" style="overflow:hidden;">
  <div style="display:flex; flex-direction:column; height:100%; min-height:0; padding:20px;">
    <!-- TOP HEADER BAR -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; flex-shrink:0;">
      <div style="display:flex; align-items:center; gap:16px;">
        <button id="btn-projdetail-back" class="btn-secondary" type="button">‚Üê Back</button>
        <div style="display:flex; align-items:center; gap:12px;">
          <div style="width:50px; height:50px; background:#f0f0f5; border-radius:10px; display:flex; align-items:center; justify-content:center; overflow:hidden;">
            <img id="projdetail-cover-img" src="" alt="" style="max-width:100%; max-height:100%; display:none;">
            <div id="projdetail-cover-empty" style="font-size:28px; color:#999;">üìÅ</div>
          </div>
          <div>
            <div id="projdetail-title" style="font-size:20px; font-weight:800;">‚Äî</div>
            <div id="projdetail-id" style="font-size:11px; color:#999;">‚Äî</div>
          </div>
        </div>
      </div>
      <div style="display:flex; align-items:center; gap:12px;">
        <select id="projdetail-status" class="rfq-input" style="min-width:150px;"></select>
        <button id="btn-projdetail-mark-won" class="btn-success" style="padding:8px 16px;">üèÜ Mark as Won</button>
        <button id="btn-projdetail-mark-done" class="btn-primary" style="padding:8px 16px;">‚úÖ All Set</button>
        <button id="btn-projdetail-edit" class="btn-secondary" type="button">Edit Project</button>
      </div>
    </div>

    <!-- MAIN CONTENT AREA -->
    <div style="display:flex; flex:1; gap:20px; min-height:0;">
      <!-- LEFT SIDEBAR - KPIs & Quick Info -->
      <div style="width:280px; flex-shrink:0; display:flex; flex-direction:column; gap:12px; overflow-y:auto; min-height:0;">
        <!-- Main KPIs -->
        <div class="sd-card" style="padding:16px;">
          <div class="sd-card-title">Project Overview</div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div class="sd-kpi"><div class="sd-kpi-l">Items</div><div class="sd-kpi-v" id="projdetail-kpi-items">0</div></div>
            <div class="sd-kpi"><div class="sd-kpi-l">Suppliers</div><div class="sd-kpi-v" id="projdetail-kpi-suppliers">0</div></div>
            <div class="sd-kpi"><div class="sd-kpi-l">With Quotes</div><div class="sd-kpi-v" id="projdetail-kpi-quoted" style="color:#28a745;">0</div></div>
            <div class="sd-kpi"><div class="sd-kpi-l">Pending</div><div class="sd-kpi-v" id="projdetail-kpi-pending" style="color:#fd7e14;">0</div></div>
          </div>
          <div style="border-top:1px solid #e0e0e0; margin-top:12px; padding-top:12px;">
            <div class="sd-kpi"><div class="sd-kpi-l">Total Value (EUR)</div><div class="sd-kpi-v" id="projdetail-kpi-value" style="color:#28a745; font-size:18px;">‚Ç¨0</div></div>
            <div class="sd-kpi" style="margin-top:8px;"><div class="sd-kpi-l">Target Value (EUR)</div><div class="sd-kpi-v" id="projdetail-kpi-target" style="color:#667eea; font-size:16px;">‚Ç¨0</div></div>
            <div class="sd-kpi" style="margin-top:8px;"><div class="sd-kpi-l">Savings Potential</div><div class="sd-kpi-v" id="projdetail-kpi-savings" style="font-size:14px;">‚Ç¨0</div></div>
          </div>
        </div>

        <!-- Timeline / Key Dates -->
        <div class="sd-card" style="padding:16px;">
          <div class="sd-card-title">Timeline</div>
          <div style="font-size:12px; display:flex; flex-direction:column; gap:8px;">
            <div style="display:flex; justify-content:space-between;"><span style="color:#666;">Created:</span><span id="projdetail-created" style="font-weight:600;">‚Äî</span></div>
            <div style="display:flex; justify-content:space-between;"><span style="color:#666;">Received:</span><span id="projdetail-received" style="font-weight:600;">‚Äî</span></div>
            <div style="display:flex; justify-content:space-between;"><span style="color:#666;">BOM:</span><span id="projdetail-bom" style="font-weight:600;">‚Äî</span></div>
            <div style="display:flex; justify-content:space-between;"><span style="color:#666;">Sent:</span><span id="projdetail-sent" style="font-weight:600;">‚Äî</span></div>
            <div style="display:flex; justify-content:space-between;"><span style="color:#666;">Sent to:</span><span id="projdetail-sentto" style="font-weight:600;">‚Äî</span></div>
            <div id="projdetail-deadline-row" style="display:flex; justify-content:space-between; padding:8px; margin-top:4px; background:#fff3cd; border-radius:6px;">
              <span style="color:#856404; font-weight:600;">Deadline:</span>
              <span id="projdetail-deadline" style="font-weight:700;">‚Äî</span>
            </div>
          </div>
        </div>

        <!-- Items by Status -->
        <div class="sd-card" style="padding:16px;">
          <div class="sd-card-title">Items by Status</div>
          <div id="projdetail-status-breakdown" style="font-size:12px;"></div>
        </div>

        <!-- Quick Actions -->
        <div class="sd-card" style="padding:16px;">
          <div class="sd-card-title">Quick Actions</div>
          <div style="display:flex; flex-direction:column; gap:8px;">
            <button id="btn-projdetail-upload-cover" class="btn-secondary btn-sm" type="button">üì∑ Set Cover Photo</button>
            <button id="btn-projdetail-goto-items" class="btn-secondary btn-sm" type="button">üìã View Items</button>
            <button id="btn-projdetail-goto-quoting" class="btn-secondary btn-sm" type="button">üí∞ Price Comparison</button>
          </div>
        </div>
      </div>

      <!-- RIGHT CONTENT - Tabs -->
      <div style="flex:1; display:flex; flex-direction:column; min-height:0;">
        <!-- Tab Header -->
        <div class="sd-tabs" style="flex-shrink:0; display:flex; gap:4px; border-bottom:2px solid #e0e0e0; padding-bottom:0;">
          <button class="sd-tab active" data-tab="overview">üìä Overview</button>
          <button class="sd-tab" data-tab="suppliers">üè≠ Suppliers</button>
          <button class="sd-tab" data-tab="items-stats">üì¶ Items Stats</button>
          <button class="sd-tab" data-tab="pricing">üíµ Pricing</button>
          <button class="sd-tab" data-tab="files">üìé Files & Links</button>
          <button class="sd-tab" data-tab="notes">üìù Notes</button>
          <button class="sd-tab" data-tab="exports">üì§ Exports</button>
        </div>

        <!-- Tab Panels -->
        <div class="sd-panels">

          <!-- OVERVIEW TAB -->
          <div class="sd-panel active" data-panel="overview">
            <div id="projdetail-overview-content"></div>
          </div>

          <!-- SUPPLIERS TAB -->
          <div class="sd-panel" data-panel="suppliers">
            <div id="projdetail-suppliers-content"></div>
          </div>

          <!-- ITEMS STATS TAB -->
          <div class="sd-panel" data-panel="items-stats">
            <div id="projdetail-items-stats-content"></div>
          </div>

          <!-- PRICING TAB -->
          <div class="sd-panel" data-panel="pricing">
            <div id="projdetail-pricing-content"></div>
          </div>

          <!-- FILES & LINKS TAB -->
          <div class="sd-panel" data-panel="files">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
              <!-- Links Section -->
              <div class="sd-card" style="padding:16px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                  <div class="sd-card-title" style="margin:0;">Project Links</div>
                  <button id="btn-projdetail-add-link" class="btn-primary btn-sm" type="button">+ Add Link</button>
                </div>
                <div class="table-wrapper" style="max-height:300px; overflow:auto;">
                  <table class="items-table" style="font-size:12px;">
                    <thead><tr><th>Title</th><th>URL</th><th style="width:50px;"></th></tr></thead>
                    <tbody id="projdetail-links-tbody"></tbody>
                  </table>
                </div>
              </div>
              <!-- Attachments Section -->
              <div class="sd-card" style="padding:16px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                  <div class="sd-card-title" style="margin:0;">Attachments</div>
                  <button id="btn-projdetail-upload" class="btn-primary btn-sm" type="button">+ Upload File</button>
                </div>
                <input id="projdetail-file" type="file" style="display:none;">
                <input id="projdetail-cover-file" type="file" accept="image/*" style="display:none;">
                <div id="projdetail-attachments" style="max-height:300px; overflow:auto;"></div>
              </div>
            </div>
          </div>

          <!-- NOTES TAB -->
          <div class="sd-panel" data-panel="notes">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
              <div class="sd-card" style="padding:16px;">
                <div class="sd-card-title">Project Notes</div>
                <textarea id="projdetail-notes" class="rfq-input" style="min-height:250px; resize:vertical;" placeholder="Write notes about this project..."></textarea>
                <div style="font-size:11px; color:#999; margin-top:8px;">Auto-saves as you type.</div>
              </div>
              <div class="sd-card" style="padding:16px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                  <div class="sd-card-title" style="margin:0;">Comments</div>
                </div>
                <textarea id="projdetail-comment-text" class="rfq-input" rows="3" style="width:100%; margin-bottom:8px;" placeholder="Write a comment..."></textarea>
                <button id="btn-projdetail-comment-add" class="btn-primary btn-sm" type="button">Add Comment</button>
                <div id="projdetail-comments" style="max-height:200px; overflow-y:auto; margin-top:12px;"></div>
              </div>
            </div>
          </div>

          <!-- EXPORTS TAB -->
          <div class="sd-panel" data-panel="exports">
            <div id="projdetail-exports-content"></div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<div id="view-dashboard" class="view-section">
    <div class="dashboard-content" style="padding: 20px 30px;">

        <!-- Project Control Bar - All in One -->
        <div style="display: flex; align-items: center; gap: 14px; margin-bottom: 20px; padding: 16px 20px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; border: 1px solid #e2e8f0; flex-wrap: wrap;">

            <!-- Status Dropdown + Add -->
            <div style="display: flex; align-items: center; gap: 6px;">
                <select id="dash-project-status" class="rfq-input" style="min-width: 150px; padding: 8px 12px; font-size: 14px;"></select>
                <button class="btn-secondary btn-sm" type="button" data-action="add-project-status" title="Add custom status" style="padding: 8px 12px; font-size: 14px;">+</button>
            </div>

            <!-- Divider -->
            <div style="width: 1px; height: 32px; background: #cbd5e1;"></div>

            <!-- Large Status Badge -->
            <div id="dash-status-big" style="padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600; background: #10b981; color: white; display: flex; align-items: center; gap: 6px;">
                <span style="font-size: 16px;">‚úì</span>
                <span id="dash-status-big-text">Created</span>
            </div>
            <span id="dash-project-status-pill" class="qt-pill gray" style="display:none;">Created</span>

            <!-- Divider -->
            <div style="width: 1px; height: 32px; background: #cbd5e1;"></div>

            <!-- Dates -->
            <div style="display: flex; align-items: center; gap: 14px; font-size: 13px; color: #475569;">
                <span><b>üì• Received:</b> <span id="dash-bar-received">‚Äî</span></span>
                <span style="color: #dc2626; font-weight: 600;"><b>‚è∞ Deadline:</b> <span id="dash-bar-deadline">‚Äî</span></span>
            </div>

            <!-- Divider -->
            <div style="width: 1px; height: 32px; background: #cbd5e1;"></div>

            <!-- Last Comment Display (from any source) - CLICKABLE -->
            <div id="dash-last-comment" style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; min-width: 200px; max-width: 280px; cursor: pointer; transition: all 0.2s;" title="Click to navigate to comment" data-source="" data-item-index="">
                <span style="font-size: 16px;">üí¨</span>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-size: 11px; color: #64748b;" id="dash-last-comment-date">‚Äî</div>
                    <div id="dash-last-comment-text" style="font-size: 13px; color: #1e293b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">No comments yet</div>
                </div>
            </div>

            <!-- Last Project Note -->
            <div id="dash-last-note" style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: #fffbeb; border: 1px solid #fcd34d; border-radius: 8px; min-width: 180px; max-width: 250px; cursor: pointer; transition: all 0.2s;" title="Click to open notes">
                <span style="font-size: 16px;">üìã</span>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-size: 11px; color: #92400e; font-weight: 600;">Last Note</div>
                    <div id="dash-last-note-text" style="font-size: 13px; color: #78350f; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">‚Äî</div>
                </div>
            </div>

            <!-- Last Issue Item -->
            <div id="dash-last-issue" style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: #fef2f2; border: 1px solid #fca5a5; border-radius: 8px; min-width: 180px; max-width: 250px; cursor: pointer; transition: all 0.2s;" title="Click to view issue item" data-item-index="">
                <span style="font-size: 16px;">‚ö†Ô∏è</span>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-size: 11px; color: #991b1b; font-weight: 600;">Last Issue</div>
                    <div id="dash-last-issue-text" style="font-size: 13px; color: #7f1d1d; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">‚Äî</div>
                </div>
            </div>

            <!-- Spacer -->
            <div style="flex: 1;"></div>

            <!-- Action Buttons -->
            <div style="display: flex; align-items: center; gap: 10px;">
                <button id="btn-dash-add-note" class="btn-secondary" style="background: #3b82f6; color: white; padding: 8px 14px; font-size: 13px; font-weight: 600; border: none; border-radius: 6px;">
                    üìù NOTE
                </button>
                <button id="btn-recalculate-all" class="btn-secondary" style="background: #667eea; color: white; padding: 8px 14px; font-size: 13px; font-weight: 600; border: none; border-radius: 6px;" title="Recalculate all item data">
                    üîÑ Recalculate
                </button>
                <button class="btn-secondary btn-sm" id="btn-dash-edit-project-bar" style="padding: 8px 14px; font-size: 13px;">
                    ‚úèÔ∏è Edit
                </button>
                <button id="btn-dash-edit-layout" class="btn-secondary" style="background: #f59e0b; color: white; padding: 8px 14px; font-size: 13px; font-weight: 600; border: none; border-radius: 6px;" title="Customize dashboard layout">
                    üé® Layout
                </button>
            </div>
        </div>
        <div id="dashboard-dates-container" style="display:none;"></div>

        <!-- Dashboard Grid Container -->
        <div id="dashboard-grid" class="dashboard-grid">

            <!-- Project Info Card -->
            <div class="dash-box" data-box-id="project-info" data-box-title="Project Info" data-col-span="2" data-row-span="1">
                <div class="dash-box-header">
                    <span class="dash-box-drag-handle">‚ãÆ‚ãÆ</span>
                    <span class="dash-box-title">Project Info</span>
                    <div class="dash-box-controls">
                        <button class="dash-box-btn" data-action="resize-smaller" title="Smaller">‚àí</button>
                        <button class="dash-box-btn" data-action="resize-larger" title="Larger">+</button>
                        <button class="dash-box-btn" data-action="toggle-visibility" title="Hide">üëÅ</button>
                    </div>
                </div>
                <div class="dash-box-content">
                    <div id="dash-project-info" style="display: grid; grid-template-columns: auto 1fr auto; gap: 20px; align-items: center;">
                        <div id="dash-project-cover" style="width:80px; height:80px; border-radius:12px; background:#f0f0f5; display:flex; align-items:center; justify-content:center; overflow:hidden;">
                            <img id="dash-project-cover-img" src="" alt="" style="max-width:100%; max-height:100%; display:none;">
                            <div id="dash-project-cover-icon" style="font-size:36px; color:#999;">üìã</div>
                        </div>
                        <div>
                            <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                                <div id="dash-project-name" style="font-size:20px; font-weight:800; color:#111;">‚Äî</div>
                                <span id="dash-project-status-badge" style="padding:4px 10px; border-radius:999px; font-size:11px; font-weight:600; background:#e9ecef; color:#495057;">‚Äî</span>
                            </div>
                            <div style="display:flex; gap:20px; margin-top:8px; font-size:13px; color:#666; flex-wrap:wrap;">
                                <span id="dash-info-created"><b>Created:</b> ‚Äî</span>
                                <span id="dash-info-received"><b>Received:</b> ‚Äî</span>
                                <span id="dash-info-bom"><b>BOM:</b> ‚Äî</span>
                                <span id="dash-info-deadline" style="font-weight:600;"><b>Deadline:</b> ‚Äî</span>
                            </div>
                            <div style="display:flex; gap:20px; margin-top:6px; font-size:13px; color:#666; flex-wrap:wrap;">
                                <span id="dash-info-sent"><b>Sent:</b> ‚Äî</span>
                                <span id="dash-info-sentto"><b>Sent to:</b> ‚Äî</span>
                            </div>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:8px;">
                            <button id="btn-dash-view-detail" class="btn-primary btn-sm" style="white-space:nowrap;">View Details</button>
                            <button class="btn-secondary btn-sm" id="btn-dash-edit-project" style="white-space:nowrap;">Edit Project</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Key Metrics -->
            <div class="dash-box" data-box-id="key-metrics" data-box-title="Key Metrics" data-col-span="2" data-row-span="1">
                <div class="dash-box-header">
                    <span class="dash-box-drag-handle">‚ãÆ‚ãÆ</span>
                    <span class="dash-box-title">Key Metrics</span>
                    <div class="dash-box-controls">
                        <button class="dash-box-btn" data-action="resize-smaller" title="Smaller">‚àí</button>
                        <button class="dash-box-btn" data-action="resize-larger" title="Larger">+</button>
                        <button class="dash-box-btn" data-action="toggle-visibility" title="Hide">üëÅ</button>
                    </div>
                </div>
                <div class="dash-box-content">
                    <div class="stats-grid" style="grid-template-columns: repeat(6, 1fr);">
                        <div class="stat-card">
                            <div class="stat-label">Total Items</div>
                            <div id="dash-total-items" class="stat-value">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">QTY 1 Total (All)</div>
                            <div id="dash-total-value" class="stat-value color-blue">‚Ç¨0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Target Total (All)</div>
                            <div id="dash-target-total" class="stat-value" style="color:#667eea;">‚Ç¨0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Suppliers</div>
                            <div id="dash-supplier-count" class="stat-value color-purple">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Quote Rate</div>
                            <div id="dash-quote-rate" class="stat-value color-green">0%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Avg Price</div>
                            <div id="dash-avg-price" class="stat-value">‚Ç¨0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Item Progress -->
            <div class="dash-box" data-box-id="item-progress" data-box-title="Item Progress" data-col-span="1" data-row-span="1">
                <div class="dash-box-header">
                    <span class="dash-box-drag-handle">‚ãÆ‚ãÆ</span>
                    <span class="dash-box-title">Item Progress</span>
                    <div class="dash-box-controls">
                        <button class="dash-box-btn" data-action="resize-smaller" title="Smaller">‚àí</button>
                        <button class="dash-box-btn" data-action="resize-larger" title="Larger">+</button>
                        <button class="dash-box-btn" data-action="toggle-visibility" title="Hide">üëÅ</button>
                    </div>
                </div>
                <div class="dash-box-content">
                    <div id="dash-status-breakdown" class="dash-status-breakdown"></div>
                </div>
            </div>

            <!-- Quoting Progress -->
            <div class="dash-box" data-box-id="quoting-progress" data-box-title="Quoting Progress" data-col-span="1" data-row-span="1">
                <div class="dash-box-header">
                    <span class="dash-box-drag-handle">‚ãÆ‚ãÆ</span>
                    <span class="dash-box-title">Quoting Progress</span>
                    <div class="dash-box-controls">
                        <button class="dash-box-btn" data-action="resize-smaller" title="Smaller">‚àí</button>
                        <button class="dash-box-btn" data-action="resize-larger" title="Larger">+</button>
                        <button class="dash-box-btn" data-action="toggle-visibility" title="Hide">üëÅ</button>
                    </div>
                </div>
                <div class="dash-box-content">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="text-align: center; padding: 15px; background: rgba(52,199,89,0.1); border-radius: 10px;">
                            <div style="font-size: 24px; font-weight: 700; color: #34C759;" id="dash-quotes-received">0</div>
                            <div style="font-size: 11px; color: #666; margin-top: 4px;">Quotes Received</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: rgba(255,149,0,0.1); border-radius: 10px;">
                            <div style="font-size: 24px; font-weight: 700; color: #FF9500;" id="dash-awaiting-quote">0</div>
                            <div style="font-size: 11px; color: #666; margin-top: 4px;">Awaiting Response</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: rgba(0,122,255,0.1); border-radius: 10px;">
                            <div style="font-size: 24px; font-weight: 700; color: #007AFF;" id="dash-not-sent">0</div>
                            <div style="font-size: 11px; color: #666; margin-top: 4px;">Not Yet Sent</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: rgba(88,86,214,0.1); border-radius: 10px;">
                            <div style="font-size: 24px; font-weight: 700; color: #5856D6;" id="dash-rfq-batches">0</div>
                            <div style="font-size: 11px; color: #666; margin-top: 4px;">RFQ Batches</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Suppliers Chart -->
            <div class="dash-box" data-box-id="chart-suppliers" data-box-title="Top Suppliers" data-col-span="1" data-row-span="1">
                <div class="dash-box-header">
                    <span class="dash-box-drag-handle">‚ãÆ‚ãÆ</span>
                    <span class="dash-box-title">Top Suppliers by Items</span>
                    <div class="dash-box-controls">
                        <button class="dash-box-btn" data-action="resize-smaller" title="Smaller">‚àí</button>
                        <button class="dash-box-btn" data-action="resize-larger" title="Larger">+</button>
                        <button class="dash-box-btn" data-action="toggle-visibility" title="Hide">üëÅ</button>
                    </div>
                </div>
                <div class="dash-box-content">
                    <div class="chart-container" style="height: 200px;">
                        <canvas id="chart-suppliers"></canvas>
                    </div>
                </div>
            </div>

            <!-- Value by Supplier Chart -->
            <div class="dash-box" data-box-id="chart-value" data-box-title="Value by Supplier" data-col-span="1" data-row-span="1">
                <div class="dash-box-header">
                    <span class="dash-box-drag-handle">‚ãÆ‚ãÆ</span>
                    <span class="dash-box-title">Value by Supplier</span>
                    <div class="dash-box-controls">
                        <button class="dash-box-btn" data-action="resize-smaller" title="Smaller">‚àí</button>
                        <button class="dash-box-btn" data-action="resize-larger" title="Larger">+</button>
                        <button class="dash-box-btn" data-action="toggle-visibility" title="Hide">üëÅ</button>
                    </div>
                </div>
                <div class="dash-box-content">
                    <div class="chart-container" style="height: 200px;">
                        <canvas id="chart-supplier-value"></canvas>
                    </div>
                </div>
            </div>

            <!-- Issues Alert -->
            <div class="dash-box" data-box-id="issues" data-box-title="Issues" data-col-span="2" data-row-span="1">
                <div class="dash-box-header">
                    <span class="dash-box-drag-handle">‚ãÆ‚ãÆ</span>
                    <span class="dash-box-title">Issues Alert</span>
                    <div class="dash-box-controls">
                        <button class="dash-box-btn" data-action="resize-smaller" title="Smaller">‚àí</button>
                        <button class="dash-box-btn" data-action="resize-larger" title="Larger">+</button>
                        <button class="dash-box-btn" data-action="toggle-visibility" title="Hide">üëÅ</button>
                    </div>
                </div>
                <div class="dash-box-content">
                    <div id="dashboard-issues-container"></div>
                </div>
            </div>

            <!-- Top Items Table -->
            <div class="dash-box" data-box-id="top-items" data-box-title="Top 10 Items" data-col-span="2" data-row-span="1">
                <div class="dash-box-header">
                    <span class="dash-box-drag-handle">‚ãÆ‚ãÆ</span>
                    <span class="dash-box-title">Top 10 Items by Value</span>
                    <div class="dash-box-controls">
                        <button class="dash-box-btn" data-action="resize-smaller" title="Smaller">‚àí</button>
                        <button class="dash-box-btn" data-action="resize-larger" title="Larger">+</button>
                        <button class="dash-box-btn" data-action="toggle-visibility" title="Hide">üëÅ</button>
                    </div>
                </div>
                <div class="dash-box-content">
                    <div class="table-wrapper" style="max-height: 280px; overflow: auto;">
                        <table id="table-top-10" class="rfq-table">
                            <thead>
                                <tr>
                                    <th>Part No.</th>
                                    <th>Description</th>
                                    <th>Qty</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                    <th>Supplier</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Notes Section -->
            <div class="dash-box" data-box-id="notes" data-box-title="Project Notes" data-col-span="2" data-row-span="1">
                <div class="dash-box-header">
                    <span class="dash-box-drag-handle">‚ãÆ‚ãÆ</span>
                    <span class="dash-box-title">Project Notes</span>
                    <div class="dash-box-controls">
                        <button class="dash-box-btn" data-action="resize-smaller" title="Smaller">‚àí</button>
                        <button class="dash-box-btn" data-action="resize-larger" title="Larger">+</button>
                        <button class="dash-box-btn" data-action="toggle-visibility" title="Hide">üëÅ</button>
                    </div>
                </div>
                <div class="dash-box-content">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <textarea id="dash-notes-text" class="rfq-input" rows="2" placeholder="Add a note..." style="flex: 1; resize: none;"></textarea>
                        <button id="btn-dash-note-add" class="btn-primary" type="button" style="align-self: flex-end;">Add</button>
                    </div>
                    <div class="table-wrapper" style="max-height: 200px; overflow: auto;">
                        <table class="rfq-table">
                            <thead>
                                <tr>
                                    <th style="width: 140px;">Date</th>
                                    <th>Note</th>
                                    <th style="width: 80px;"></th>
                                </tr>
                            </thead>
                            <tbody id="dash-notes-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div><!-- end dashboard-grid -->

    </div>
</div>

                        <div id="view-items" class="view-section hidden" style="overflow:hidden;">
                            <div class="toolbar" style="flex-shrink:0;">
                                <button id="btn-add-item" class="btn-primary">+ Add Item</button>
                                <button id="btn-filter-toggle" class="btn-secondary">Filters</button>
                                <input type="text" id="table-filter" placeholder="Search..." class="search-input">
                                <button id="btn-export-excel" class="btn-success">Export Excel</button>
                                <button id="btn-import-target-prices" class="btn-secondary" style="background:#667eea; color:white;">üì• Import Targets</button>
                                <button id="btn-price-list" class="btn-primary" style="background: #5856d6;">üìÑ Price List</button>
                                <input type="file" id="file-import-excel" style="display: none;">
                                <input type="file" id="file-import-targets" accept=".xlsx,.xls,.csv" style="display: none;">
                            </div>

                            <div id="filters-panel" class="filters-panel hidden">
                                <select id="filter-status" class="filter-select"><option value="">All Status</option></select>
                                <select id="filter-supplier" class="filter-select"><option value="">All Suppliers</option></select>
                                <select id="filter-manufacturer" class="filter-select"><option value="">All Manufacturers</option></select>
                                <input type="number" id="filter-price-min" placeholder="Min Price" class="filter-input">
                                <input type="number" id="filter-price-max" placeholder="Max Price" class="filter-input">
                                <button id="btn-clear-filters" class="btn-text">Clear</button>
                            </div>

                            <!-- View Tab Switcher -->
                            <div class="items-view-tabs" style="display:flex; gap:0; border-bottom:1px solid #e0e0e0; background:#fafafa; flex-shrink:0;">
                                <button class="items-view-tab active" data-view="table" style="padding:10px 20px; border:none; background:transparent; cursor:pointer; font-weight:600; color:#007AFF; border-bottom:2px solid #007AFF; margin-bottom:-1px;">Table View</button>
                                <button class="items-view-tab" data-view="pricing" style="padding:10px 20px; border:none; background:transparent; cursor:pointer; font-weight:500; color:#666; border-bottom:2px solid transparent; margin-bottom:-1px;">Pricing View (EUR)</button>
                            </div>

                            <!-- SuperTable Container for Items -->
                            <div id="items-super-table-container" style="flex:1; min-height:0; overflow:auto; position:relative;"></div>

                            <!-- Pricing View Container -->
                            <div id="items-pricing-view" class="hidden" style="flex:1; min-height:0; overflow-y:auto; display:flex; flex-direction:column; background:#f5f5f7;">
                                <!-- Pricing View Simple Toolbar (Select All + Export) -->
                                <div id="pricing-view-toolbar" style="display:flex; align-items:center; gap:12px; padding:8px 16px; background:white; border-bottom:1px solid #e0e0e0; flex-shrink:0;">
                                    <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                                        <input type="checkbox" id="pricing-select-all" style="width:16px; height:16px;">
                                        <span style="font-size:12px; color:#666;">Select All</span>
                                    </label>
                                    <span id="pricing-selection-info" style="font-size:12px; color:#007AFF; font-weight:500;"></span>
                                    <div style="flex:1;"></div>
                                    <button id="pricing-export-excel" class="btn-success" style="padding:6px 14px; font-size:12px;">
                                        Export Excel
                                    </button>
                                </div>
                                <!-- Summary Cards -->
                                <div id="pricing-summary-cards" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:12px; padding:16px; flex-shrink:0;"></div>
                                <!-- Pricing Table -->
                                <div class="pricing-table-wrapper" style="flex:1; overflow:auto; margin:0 16px 16px 16px; background:white; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                                    <table id="pricing-view-table" class="rfq-table" style="width:100%;">
                                        <thead id="pricing-view-thead" style="position:sticky; top:0; z-index:10;"></thead>
                                        <tbody id="pricing-view-tbody"></tbody>
                                    </table>
                                </div>
                                <!-- Totals Footer -->
                                <div id="pricing-totals" style="padding:12px 16px; background:white; border-top:1px solid #e0e0e0; flex-shrink:0;"></div>
                            </div>

                            <!-- Bulk Action Bar (Floating) -->
                            <div id="bulk-action-bar" class="hidden" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 50px; display: flex; align-items: center; gap: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 100;">
                                <div style="font-weight: 600; font-size: 13px;"><span id="bulk-count">0</span> Selected</div>
                                <div style="height: 20px; width: 1px; background: rgba(255,255,255,0.2);"></div>
                                <select id="bulk-status-select" class="rfq-input" style="background: rgba(255,255,255,0.1); border: none; color: white; width: 150px; padding: 4px 8px;">
                                    <option value="">Change Status</option>
                                    <!-- Options populated dynamically from getItemStatuses() -->
                                </select>
                                <button id="btn-bulk-export" class="btn-text" style="color: white; font-weight: 500;">üì§ Export Selected</button>
                                <button id="btn-bulk-clear" style="background: none; border: none; color: #aaa; font-size: 18px; cursor: pointer; padding: 0 4px;">&times;</button>
                            </div>

                            <div id="empty-state" class="empty-state">
                                <div class="empty-icon">üìÅ</div>
                                <div>Select or create a project to view items</div>
                            </div>

                            <div class="table-footer">
                                <span>Total: <b id="stat-total">0</b></span>
                                <span>Done: <b id="stat-done">0</b></span>
                                <span>Pending: <b id="stat-pending">0</b></span>
                            </div>
                        </div>

                        <!-- Item Detail (Page View) -->
                        <div id="view-item-detail" class="view-section hidden" style="overflow:hidden;">
                            <div class="toolbar">
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <button id="btn-item-detail-back" class="btn-secondary">‚Üê Back</button>
                                    <div id="item-detail-page-title" style="font-weight:700; color:#333;">Item Detail</div>
                                </div>
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <button id="btn-item-detail-save" class="btn-success">Ulo≈æit</button>
                                    <button id="btn-item-detail-save-back" class="btn-primary">Ulo≈æit & Back</button>
                                    <button id="btn-item-detail-delete" class="btn-danger">Delete</button>
                                </div>
                            </div>
                            <div id="item-detail-page-body" class="rfq-scroll-page" style="padding:12px; background:#f5f5f7;">
                                <div id="item-detail-page-content"></div>
                            </div>
                        </div>

                        <div id="view-database" class="view-section hidden">
                            <div class="toolbar">
                                <input type="text" id="database-search" placeholder="Search all parts..." class="search-input">
                                <select id="database-project-filter" class="filter-select" style="width: 150px;"><option value="">All Projects</option></select>
                                <button id="btn-db-clear-filters" class="btn-secondary" type="button">Vymazat filtry</button>
                                <button id="btn-refresh-db" class="btn-secondary">Refresh</button>
                                <button id="btn-db-export-selected" class="btn-success" disabled>üì§ Export Selected</button>
                                <button id="btn-db-clear-selection" class="btn-text" disabled>Vymazat v√Ωbƒõr</button>
                                <span id="db-selected-count" class="muted" style="margin-left:8px; font-size:12px;">0 selected</span>
                            </div>
                            <div class="table-wrapper sd-table-wrap">
                                <table id="table-database" class="rfq-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 40px;"><input type="checkbox" id="db-select-all"></th>
                                            <th>Item/Drawing No.</th>
                                            <th>Description</th>
                                            <th>Manufacturer</th>
                                            <th>Price Range (EUR)</th>
                                            <th>Used In Projects</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <div id="view-quotes" class="view-section hidden">
                            <!-- HEADER BAR -->
                            <div class="quotes-header-bar">
                                <div class="quotes-header-left">
                                    <span class="quotes-header-icon">üí∞</span>
                                    <div>
                                        <div class="quotes-header-title">Quotes Center</div>
                                        <div class="quotes-header-sub">Central database of all supplier quotes across projects</div>
                                    </div>
                                </div>
                                <div class="quotes-header-stats">
                                    <div class="quotes-stat"><span id="qs-total-suppliers">0</span><label>Suppliers</label></div>
                                    <div class="quotes-stat"><span id="qs-total-quotes">0</span><label>Quotes</label></div>
                                    <div class="quotes-stat"><span id="qs-total-items">0</span><label>Line Items</label></div>
                                    <div class="quotes-stat qs-active"><span id="qs-active-quotes">0</span><label>Active</label></div>
                                </div>
                            </div>

                            <!-- TOOLBAR -->
                            <div class="quotes-toolbar">
                                <input type="text" id="quotes-search" placeholder="Search supplier, quote #..." class="search-input">
                                <select id="quotes-project-filter" class="filter-select" style="width:150px;"><option value="">All Projects</option></select>
                                <select id="quotes-supplier-filter" class="filter-select" style="width:150px;"><option value="">All Suppliers</option></select>
                                <input type="text" id="quotes-number-filter" placeholder="Quote #..." class="search-input" style="width:130px;">
                                <select id="quotes-status-filter" class="filter-select" style="width:120px;">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="expired">Expired</option>
                                </select>
                                <button id="btn-quotes-clear-filters" class="btn-secondary" type="button">Clear</button>
                                <button id="btn-quotes-refresh" class="btn-secondary">‚Üª Refresh</button>
                                <button id="btn-quotes-import" class="btn-secondary">üì• Import Excel</button>
                                <input type="file" id="file-quotes-import" accept=".xlsx,.xls,.csv" style="display: none;">
                                <button id="btn-quotes-create" class="btn-primary">‚ûï New Quote</button>
                            </div>

                            <!-- BREADCRUMB -->
                            <div id="quotes-breadcrumb" class="quotes-breadcrumb hidden">
                                <button id="quotes-bc-home" class="btn-text" type="button">‚¨Ö All Suppliers</button>
                                <span class="quotes-bc-sep">‚Ä∫</span>
                                <button id="quotes-bc-supplier" class="btn-text" type="button"></button>
                                <span id="quotes-bc-sep2" class="quotes-bc-sep hidden">‚Ä∫</span>
                                <button id="quotes-bc-quote" class="btn-text hidden" type="button"></button>
                            </div>

                            <!-- CONTENT AREA (dynamically swapped between 3 levels) -->
                            <div id="quotes-content" class="quotes-content"></div>
                        </div>

                        <div id="view-export" class="view-section hidden">
                            <div class="detail-shell">
                                <div class="detail-shell-header">
                                    <div class="detail-shell-title">üì§ Export Center</div>
                                    <div class="detail-shell-actions">
                                        <button id="btn-export-generate" class="btn-primary" type="button">Generate Export</button>
                                    </div>
                                </div>
                                <div class="detail-shell-body">
                                    <div class="export-grid">
                                        <div class="export-card">
                                            <div class="export-card-title">Scope</div>
                                            <div class="form-row">
                                                <label>Projects</label>
                                                <select id="export-scope" class="rfq-input">
                                                    <option value="current">Current project</option>
                                                    <option value="selected">Selected projects</option>
                                                    <option value="all">All projects</option>
                                                </select>
                                            </div>
                                            <div class="form-row" id="export-projects-picker-row" style="display:none;">
                                                <label>Select projects</label>
                                                <div id="export-projects-picker" class="export-projects-picker"></div>
                                            </div>
                                        </div>

                                        <div class="export-card">
                                            <div class="export-card-title">Content</div>
                                            <div class="export-checks">
                                                <label class="export-check"><input type="checkbox" id="exp-items" checked> Items</label>
                                                <label class="export-check"><input type="checkbox" id="exp-item-suppliers" checked> Suppliers & Pricing (per item)</label>
                                                <label class="export-check"><input type="checkbox" id="exp-price-breaks" checked> Price breaks</label>
                                                <label class="export-check"><input type="checkbox" id="exp-rfqs" checked> RFQ Bundles</label>
                                                <label class="export-check"><input type="checkbox" id="exp-attachments"> Attachments list (metadata)</label>
                                            </div>
                                            <div class="form-row" style="margin-top:10px;">
                                                <label>Suppliers mode</label>
                                                <select id="export-suppliers-mode" class="rfq-input">
                                                    <option value="all">All suppliers per item</option>
                                                    <option value="main">Main supplier only</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="export-card">
                                            <div class="export-card-title">Output</div>
                                            <div class="form-row">
                                                <label>Format</label>
                                                <select id="export-format" class="rfq-input">
                                                    <option value="xlsx">Excel (.xlsx)</option>
                                                    <option value="pdf">PDF summary</option>
                                                    <option value="csv">CSV (items only)</option>
                                                </select>
                                            </div>
                                            <div class="muted" style="font-size:12px; margin-top:8px;">
                                                Tip: Excel export creates multiple sheets (Projects, Items, ItemSuppliers, RFQs, Suppliers).
                                            </div>
                                            <div id="export-status" class="muted" style="font-size:12px; margin-top:10px;"></div>
                                        </div>

                                        <div class="export-card">
                                            <div class="export-card-title">Import Templates</div>
                                            <div style="font-size: 12px; color: #666; margin-bottom: 12px;">
                                                Download sample Excel templates for importing data.
                                            </div>
                                            <button id="btn-export-multi-supplier-template" class="btn-secondary" type="button" style="width: 100%; margin-bottom: 8px;">
                                                Download Multi-Supplier Import Template
                                            </button>
                                            <div class="muted" style="font-size: 11px;">
                                                Use this template for bulk importing pricing from multiple suppliers. Includes columns: PartNo, Supplier, Qty_1-10, Price_1-10, Currency, MOQ, MOV, LeadTime, Main.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="view-settings" class="view-section hidden">
                            <div class="detail-shell">
                                <div class="detail-shell-header">
                                    <div class="detail-shell-title">Settings</div>
                                    <div class="detail-shell-actions">
                                        <button id="btn-settings-save" class="btn-primary" type="button">Save Settings</button>
                                        <button id="btn-settings-reset" class="btn-secondary" type="button">Reset to Defaults</button>
                                    </div>
                                </div>
                                <div class="detail-shell-body" style="padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <!-- Currency Settings -->
                                    <div class="sd-card">
                                        <div class="sd-card-title">Currency Exchange Rates</div>
                                        <div style="font-size: 11px; color: #666; margin-bottom: 12px;">
                                            Rate = how many EUR for 1 unit of currency.
                                        </div>
                                        <div id="settings-currency-rates" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                        </div>
                                        <div class="form-row" style="margin-top: 16px;">
                                            <label>Decimal Places</label>
                                            <select id="settings-currency-decimals" class="rfq-input">
                                                <option value="2">2 decimals</option>
                                                <option value="3">3 decimals</option>
                                                <option value="4" selected>4 decimals</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Data Management -->
                                    <div class="sd-card">
                                        <div class="sd-card-title">Data Management</div>
                                        <div style="display: flex; flex-direction: column; gap: 10px;">
                                            <button id="btn-settings-export-json" class="btn-secondary" type="button" style="width: 100%;">Export Backup (JSON)</button>
                                            <button id="btn-settings-import-json" class="btn-secondary" type="button" style="width: 100%;">Import / Restore</button>
                                            <button id="btn-settings-reset-data" class="btn-danger" type="button" style="width: 100%;">Reset All Data</button>
                                        </div>
                                        <div style="font-size: 11px; color: #888; margin-top: 12px; line-height: 1.5;">
                                            Data is saved locally in your browser. Use Export to backup or move data to another device.
                                        </div>
                                        <div id="settings-storage-info" style="margin-top: 12px; padding: 10px; background: #f5f5f7; border-radius: 6px; font-size: 11px;">
                                            <!-- Storage info will be rendered here -->
                                        </div>
                                    </div>
                                </div>


                                <!-- Admin Management Section -->
                                <div style="padding: 0 20px 20px 20px;">
                                    <div class="sd-card" style="width: 100%;">
                                        <div class="sd-card-title">Admin Management (Multi-tenant)</div>
                                        <div style="font-size: 11px; color: #666; margin-bottom: 12px;">Manage users/roles and companies (superadmin).</div>
                                        <div style="display:grid; grid-template-columns: 1.4fr 1fr; gap: 12px;">
                                            <div>
                                                <div style="font-size:12px; font-weight:600; margin-bottom:6px;">Users</div>
                                                <div id="settings-admin-users" style="max-height:220px; overflow:auto; border:1px solid #e5e7eb; border-radius:8px; background:#fff;"></div>
                                            </div>
                                            <div>
                                                <div style="font-size:12px; font-weight:600; margin-bottom:6px;">Companies</div>
                                                <div id="settings-admin-companies" style="max-height:220px; overflow:auto; border:1px solid #e5e7eb; border-radius:8px; background:#fff;"></div>
                                                <div style="display:flex; gap:8px; margin-top:8px;">
                                                    <input id="settings-admin-company-name" class="rfq-input" placeholder="New company name" style="flex:1;" />
                                                    <button id="btn-settings-admin-add-company" class="btn-secondary" type="button">Add</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div style="margin-top:10px;">
                                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                                                <div>
                                                    <div style="font-size:12px; font-weight:600; margin-bottom:6px;">Audit Logs</div>
                                                    <div style="display:flex; gap:8px; margin-bottom:6px;">
                                                        <input id="settings-admin-audit-action" class="rfq-input" placeholder="Filter action" style="max-width:180px;" />
                                                        <input id="settings-admin-audit-entity" class="rfq-input" placeholder="Filter entity" style="max-width:180px;" />
                                                        <button id="btn-settings-admin-audit-refresh" class="btn-secondary" type="button">Refresh</button>
                                                    </div>
                                                    <div id="settings-admin-audit" style="max-height:220px; overflow:auto; border:1px solid #e5e7eb; border-radius:8px; background:#fff;"></div>
                                                </div>
                                                <div>
                                                    <div style="font-size:12px; font-weight:600; margin-bottom:6px;">Active Locks</div>
                                                    <button id="btn-settings-admin-locks-refresh" class="btn-secondary" type="button" style="margin-bottom:6px;">Refresh Locks</button>
                                                    <div id="settings-admin-locks" style="max-height:220px; overflow:auto; border:1px solid #e5e7eb; border-radius:8px; background:#fff;"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="settings-admin-note" style="margin-top:8px; font-size:11px; color:#64748b;"></div>
                                    </div>
                                </div>
                                <!-- Status Management Section (half width) -->
                                <div style="padding: 0 20px 20px 20px;">
                                    <div class="sd-card" style="width: 50%; min-width: 400px;">
                                        <div class="sd-card-title">Status Management</div>
                                        <div style="font-size: 11px; color: #666; margin-bottom: 12px;">
                                            Customize status options used throughout the application. Drag to reorder, click color to change.
                                        </div>

                                        <!-- Status Type Tabs -->
                                        <div id="status-tabs" style="display: flex; gap: 4px; margin-bottom: 16px; flex-wrap: wrap;">
                                            <button class="status-tab active" data-status-type="item" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; background: #007AFF; color: white; cursor: pointer; font-size: 12px;">Item Statuses</button>
                                            <button class="status-tab" data-status-type="batch" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f7; color: #333; cursor: pointer; font-size: 12px;">Batch Statuses</button>
                                            <button class="status-tab" data-status-type="supplierQuote" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f7; color: #333; cursor: pointer; font-size: 12px;">Supplier Quote</button>
                                            <button class="status-tab" data-status-type="planner" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f7; color: #333; cursor: pointer; font-size: 12px;">Planner</button>
                                            <button class="status-tab" data-status-type="project" style="padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f7; color: #333; cursor: pointer; font-size: 12px;">Project</button>
                                        </div>

                                        <!-- Status List Container -->
                                        <div id="status-list-container" style="border: 1px solid #e5e5e5; border-radius: 6px; max-height: 400px; overflow-y: auto;">
                                            <!-- Status items will be rendered here -->
                                        </div>

                                        <!-- Status Actions -->
                                        <div style="display: flex; gap: 10px; margin-top: 12px;">
                                            <button id="btn-add-status" class="btn-secondary" type="button" style="flex: 1;">+ Add Status</button>
                                            <button id="btn-reset-statuses" class="btn-danger" type="button" style="flex: 1;">Reset to Defaults</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <input type="file" id="settings-file-import" accept=".json" style="display:none;">
                        </div>

                        <div id="view-suppliers" class="view-section hidden">
                            <div class="toolbar">
                                <div class="toolbar-left">
                                    <div style="font-weight: 600; color: #333; font-size: 14px;">üì¶ Bulk Supplier Pricing</div>
                                </div>
                                <div class="toolbar-right">
                                    <label style="font-size: 12px; font-weight: 600;">Select Supplier:</label>
                                    <select id="bulk-supplier-select" class="filter-select" style="width: 220px;">
                                        <option value="">-- Select Supplier --</option>
                                    </select>
                                    <button id="btn-add-new-supplier" class="btn-secondary" style="font-size: 11px;">+ New Supplier</button>
                                    <button id="btn-upload-bulk-quote" class="btn-secondary" style="font-size: 11px;" disabled title="Upload quote file (Excel/CSV/PDF). If Excel/CSV, it can import prices into the table.">‚¨Ü Upload Quoting</button>
                                    <button id="btn-upload-multi-supplier" class="btn-secondary" style="font-size: 11px;" title="Upload pricing for multiple suppliers at once (Excel/CSV)">‚¨Ü Multi-Supplier Upload</button>
                                    <button id="btn-save-bulk-prices" class="btn-primary" disabled>üíæ Ulo≈æit Bulk Prices</button>
                                </div>
                            </div>
                            <div id="suppliers-content" style="flex: 1; overflow-y: auto; padding: 20px;">
                                <div id="bulk-pricing-empty" style="text-align: center; padding: 60px 20px; color: #999;">
                                    <div style="font-size: 48px; margin-bottom: 16px;">üì¶</div>
                                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No Supplier Selected</div>
                                    <div style="font-size: 13px;">Select a supplier from the dropdown above to start entering bulk prices</div>
                                </div>
                                <div id="bulk-pricing-table-wrapper" class="hidden">
                                    <div style="margin-bottom: 16px; padding: 12px; background: #f0f9ff; border-radius: 8px; border: 1px solid #007AFF;">
                                        <div style="font-size: 13px; font-weight: 600; color: #007AFF; margin-bottom: 4px;">üí° Bulk Pricing Mode</div>
                                        <div style="font-size: 12px; color: #666;">Enter prices for multiple items at once. Leave fields empty to keep existing values. Click "Ulo≈æit Bulk Prices" when done.</div>
                                    </div>
                                    <div class="table-wrapper sd-table-wrap" style="overflow-x: auto;">
                                        <table id="table-bulk-pricing" class="rfq-table">
                                            <thead>
                                                <tr>
                                                    <th style="width: 40px;"><input type="checkbox" id="bulk-select-all"></th>
                                                    <th style="width: 100px;">Part No.</th>
                                                    <th style="width: 250px;">Description</th>
                                                    <th style="width: 100px;">Current Price</th>
                                                    <th style="width: 120px;">New Price</th>
                                                    <th style="width: 100px;">Currency</th>
                                                    <th style="width: 120px;">Price 2 (Optional)</th>
                                                    <th style="width: 100px;">Lead Time</th>
                                                    <th style="width: 100px;">Shipping Cost</th>
                                                    <th style="width: 80px;">Set as Main</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        
                        <div id="view-project-suppliers" class="view-section hidden">
                            <div class="toolbar">
                                <div style="font-weight: 700; color: #333; font-size: 14px;">üè≠ Project Supplier List</div>
                                <input type="text" id="proj-sup-search" placeholder="Search supplier..." class="search-input" style="margin-left: 16px;">
                                <input type="text" id="proj-sup-mfr" placeholder="Filter manufacturer..." class="search-input" style="margin-left: 10px; width: 220px;">
                                <input type="text" id="proj-sup-part" placeholder="Filter part no / MPN..." class="search-input" style="margin-left: 10px; width: 220px;">
                                <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
                                    <button id="btn-merge-suppliers" class="btn-secondary" type="button" title="Merge duplicate suppliers (e.g., Farnell + FARNELL)">üîó Merge Suppliers</button>
                                    <button id="btn-proj-sup-refresh" class="btn-secondary" type="button">Refresh</button>
                                </div>
                            </div>
                            <div class="table-wrapper sd-table-wrap">
                                <table id="table-proj-suppliers" class="rfq-table">
                                    <thead>
                                        <tr>
                                            <th style="min-width:220px;">Supplier</th>
                                            <th style="width:90px;">Items</th>
                                            <th style="width:110px;">Main</th>
                                            <th style="width:130px;">Quoted</th>
                                            <th style="width:130px;">Open RFQs</th>
                                            <th style="width:220px;">Suggestions</th>
                                            <th style="width:120px;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

<div id="view-supplier-list" class="view-section hidden">
                            <div class="toolbar">
                                <div style="font-weight: 600; color: #333; font-size: 14px;">üåé Global Supplier List</div>
                                <input type="text" id="supplier-list-search" placeholder="Search suppliers..." class="search-input" style="margin-left: 20px;">
                                <input type="text" id="supplier-list-mfr" placeholder="Filter manufacturer..." class="search-input" style="margin-left: 10px; width: 220px;">
                                <input type="text" id="supplier-list-part" placeholder="Filter part no / MPN..." class="search-input" style="margin-left: 10px; width: 220px;">
                            </div>
                            <div class="table-wrapper sd-table-wrap">
                                <table id="table-supplier-list" class="rfq-table">
                                    <thead>
                                        <tr>
                                            <th onclick="sortSupplierList('name')" style="cursor: pointer;">Supplier Name ‚Üï</th>
                                            <th onclick="sortSupplierList('status')" style="cursor: pointer;">Status ‚Üï</th>
                                            <th onclick="sortSupplierList('projects')" style="cursor: pointer;">Projects ‚Üï</th>
                                            <th onclick="sortSupplierList('items')" style="cursor: pointer;">Items ‚Üï</th>
                                            <th onclick="sortSupplierList('value')" style="cursor: pointer;">Total Value ‚Üï</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        
                        <!-- Supplier Detail (Page View) -->
                        <div id="view-supplier-detail" class="view-section hidden" style="overflow:hidden;">
                            <div class="toolbar">
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <button id="btn-supplier-detail-back" class="btn-secondary">‚Üê Back</button>
                                    <div id="supplier-detail-page-title" style="font-weight:700; color:#333;">Supplier Detail</div>
                                </div>
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <button id="btn-supplier-detail-save" class="btn-success">Ulo≈æit</button>
                                    <button id="btn-supplier-detail-save-back" class="btn-primary">Ulo≈æit & Back</button>
                                    <button id="btn-supplier-detail-delete" class="btn-danger">Delete</button>
                                </div>
                            </div>
                            <div id="supplier-detail-page-body" class="rfq-scroll-page" style="padding:12px; background:#f5f5f7;">
                                <div id="supplier-detail-page-content"></div>
                            </div>
                        </div>

<div id="view-bundle-detail" class="view-section hidden">
  <div class="toolbar">
    <div style="display:flex; align-items:center; gap:10px;">
      <button id="btn-bundle-detail-back" class="btn-secondary">‚Üê Back</button>
      <div id="bundle-detail-page-title" style="font-weight:700; color:#333;">RFQ Bundle</div>
    </div>
    <div style="display:flex; align-items:center; gap:8px;">
      <button id="btn-bundle-detail-export" class="btn-secondary">Export CSV</button>
      <button id="btn-bundle-detail-delete" class="btn-danger">Delete</button>
      <button id="btn-bundle-detail-save" class="btn-success">Ulo≈æit</button>
    </div>
  </div>
  <div id="bundle-detail-page-body" class="rfq-scroll-page" style="padding:12px; background:#f5f5f7;">
    <div id="bundle-detail-page-content"></div>
  </div>
</div>




<div id="view-quote-compare" class="view-section hidden">
  <div class="toolbar">
    <div style="display:flex; align-items:center; gap:10px;">
      <button id="btn-quote-compare-back" class="btn-secondary">‚Üê Back</button>
      <div style="font-weight:700; color:#333;">Quote Comparison</div>
    </div>
    <div class="toolbar-right"></div>
  </div>
  <div class="rfq-scroll-page" style="padding:12px; background:#f5f5f7;">
    <div id="quote-compare-page-content"></div>
  </div>
</div>

<div id="view-quoting" class="view-section hidden" style="overflow:hidden; display:flex; flex-direction:column; min-height:0;">
  <!-- Quoting Tabs Header -->
  <div class="rfq-tabs-header" style="flex-shrink:0;">
    <button class="rfq-tab active" data-tab="supplier-selection">Supplier Selection</button>
    <button class="rfq-tab" data-tab="rfq-planner">RFQ Planner</button>
    <button class="rfq-tab" data-tab="supplier-interaction">Supplier Interaction</button>
    <button class="rfq-tab" data-tab="price-comparison">Price Comparison</button>
    <button class="rfq-tab" data-tab="final-summary" style="background:linear-gradient(135deg,#fbbf24,#f59e0b); color:#1e293b; font-weight:700;">üèÜ Final Summary</button>
  </div>

  <!-- Tab 1: Price Comparison -->
  <div id="tab-price-comparison" class="rfq-tab-content hidden">
    <div class="rfq-quoting-container">
      <div class="rfq-quoting-header">
        <div class="rfq-quoting-title">
          <h2>Price Comparison</h2>
          <span class="rfq-quoting-subtitle">View all quotes by item</span>
        </div>
        <div class="rfq-quoting-actions">
          <input type="text" id="rfq-item-search" class="rfq-input" placeholder="Search items...">
          <button id="btn-add-quote" class="rfq-btn-primary">+ Add New Quote</button>
        </div>
      </div>
      <div class="rfq-quoting-body">
        <div id="rfq-items-comparison" class="rfq-comparison-grid">
          <!-- Items with supplier quotes rendered here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Tab 2: RFQ Planner -->
  <div id="tab-rfq-planner" class="rfq-tab-content hidden">
    <div class="rfq-planner-layout">
      <!-- Left Panel: Suppliers -->
      <div class="rfq-planner-sidebar">
        <div class="rfq-planner-sidebar-header">
          <h3>Suppliers</h3>
          <span class="rfq-planner-sidebar-count" id="planner-suppliers-count">0</span>
        </div>
        <div class="rfq-planner-sidebar-search">
          <input type="text" id="planner-supplier-search" class="rfq-input" placeholder="Search suppliers...">
        </div>
        <div class="rfq-planner-sidebar-list" id="planner-suppliers-list">
          <!-- Supplier cards rendered here -->
        </div>
        <div class="rfq-planner-sidebar-footer">
          <button id="btn-add-supplier-to-project" class="rfq-btn-secondary" style="width:100%;">+ Add Supplier</button>
        </div>
      </div>

      <!-- Right Panel: Items for selected supplier -->
      <div class="rfq-planner-main">
        <div class="rfq-planner-main-header">
          <div class="rfq-planner-main-title">
            <h3 id="planner-supplier-name">Select a Supplier</h3>
            <span class="rfq-planner-main-subtitle" id="planner-items-count">0 items</span>
          </div>
          <div class="rfq-planner-main-actions">
            <span id="planner-selected-count" style="font-weight: 600; color: #007AFF; margin-right: 8px;">0 selected</span>
            <select id="planner-header-bulk-status" class="rfq-input" style="width: 140px;" disabled>
              <option value="">Set Status...</option>
              <option value="Planned">üìã Planned</option>
              <option value="RFQ Sent">üì§ RFQ Sent</option>
              <option value="Missing Info">‚ö†Ô∏è Missing Info</option>
              <option value="Quoted">üì• Quoted</option>
              <option value="Done">‚úÖ Done</option>
            </select>
            <button id="btn-planner-select-all" class="rfq-btn-secondary">Select All</button>
            <button id="btn-planner-export-excel" class="rfq-btn-secondary" disabled>üìä Excel</button>
            <button id="btn-planner-export-pdf" class="rfq-btn-secondary" disabled>üìÑ PDF</button>
            <button id="btn-planner-enter-prices" class="rfq-btn-primary" disabled>Enter Prices</button>
          </div>
        </div>
        <div class="rfq-planner-main-filters">
          <div class="rfq-planner-status-filters">
            <label class="rfq-filter-chip" data-status="all"><input type="radio" name="planner-status-filter" value="all" checked> All</label>
            <label class="rfq-filter-chip" data-status="Planned"><input type="radio" name="planner-status-filter" value="Planned"> üìã Planned</label>
            <label class="rfq-filter-chip" data-status="RFQ Sent"><input type="radio" name="planner-status-filter" value="RFQ Sent"> üì§ Sent</label>
            <label class="rfq-filter-chip" data-status="Missing Info"><input type="radio" name="planner-status-filter" value="Missing Info"> ‚ö†Ô∏è Missing</label>
            <label class="rfq-filter-chip" data-status="Quoted"><input type="radio" name="planner-status-filter" value="Quoted"> üì• Quoted</label>
            <label class="rfq-filter-chip" data-status="Done"><input type="radio" name="planner-status-filter" value="Done"> ‚úÖ Done</label>
          </div>
          <input type="text" id="planner-items-search" class="rfq-input" placeholder="Search items..." style="width: 200px;">
        </div>
        <!-- Items table -->
        <div class="rfq-planner-items-list" id="planner-items-list">
          <div class="table-wrapper" style="overflow: auto; flex: 1;">
            <table class="planner-items-table resizable-table" id="planner-items-table">
              <thead id="planner-items-thead">
                <!-- Dynamic header rendered by JS -->
              </thead>
              <tbody id="planner-items-tbody">
                <!-- Items rendered here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab: Supplier Interaction -->
  <div id="tab-supplier-interaction" class="rfq-tab-content hidden">
    <div style="padding:20px; height:100%; display:flex; flex-direction:column;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div style="font-size:24px; font-weight:800;">ü§ù Supplier Interaction Manager</div>
            <button class="btn-primary" onclick="window.renderSupplierInteraction()">‚Üª Refresh</button>
        </div>
        <div class="main-card" style="flex:1; display:flex; flex-direction:column; padding:0; overflow:hidden;">
            <div id="supplier-interaction-content" style="flex:1; overflow:auto; padding:20px;"></div>
        </div>
    </div>
  </div>

  <!-- RFQ Detail Modal - for entering received prices -->
  <div id="rfq-detail-modal" class="rfq-modal-overlay hidden">
    <div class="rfq-modal-container" style="max-width: 1625px; width: 95%;">
      <div class="rfq-wizard-header">
        <div>
          <h3 id="rfq-detail-title">Quote Entry</h3>
          <span class="muted" id="rfq-detail-subtitle">Supplier: -</span>
        </div>
        <button id="rfq-detail-close" class="rfq-btn-close">&times;</button>
      </div>

      <!-- Collapsible info sections -->
      <div class="rfq-detail-sections">
        <!-- RFQ Tracking Section -->
        <div class="rfq-detail-section">
          <div class="rfq-detail-section-header" data-section="tracking">
            <span>üìÖ RFQ Tracking</span>
            <span class="rfq-section-toggle">‚ñº</span>
          </div>
          <div class="rfq-detail-section-body" id="section-tracking">
            <div class="rfq-detail-grid-6">
              <div class="rfq-form-group">
                <label>RFQ Sent Date</label>
                <input type="date" id="rfq-detail-sent-date" class="rfq-input">
              </div>
              <div class="rfq-form-group">
                <label>Quote Received</label>
                <input type="date" id="rfq-detail-received-date" class="rfq-input">
              </div>
              <div class="rfq-form-group">
                <label>Quote Date</label>
                <input type="date" id="rfq-detail-date" class="rfq-input">
              </div>
              <div class="rfq-form-group">
                <label>Valid Until</label>
                <input type="date" id="rfq-detail-valid" class="rfq-input">
              </div>
              <div class="rfq-form-group">
                <label>Quote Status</label>
                <select id="rfq-detail-quote-status" class="rfq-input">
                  <option value="Pending">Pending</option>
                  <option value="Active" selected>Active</option>
                  <option value="Expired">Expired</option>
                  <option value="Won">Won</option>
                  <option value="Lost">Lost</option>
                  <option value="No Bid">No Bid</option>
                </select>
              </div>
              <div class="rfq-form-group">
                <label>Quote Number</label>
                <input type="text" id="rfq-detail-quote-number" class="rfq-input" placeholder="e.g. Q-2024-001">
              </div>
            </div>
          </div>
        </div>

        <!-- Pricing & Terms Section -->
        <div class="rfq-detail-section">
          <div class="rfq-detail-section-header" data-section="pricing">
            <span>üí∞ Pricing & Terms</span>
            <span class="rfq-section-toggle">‚ñº</span>
          </div>
          <div class="rfq-detail-section-body" id="section-pricing">
            <div class="rfq-detail-grid-6">
              <div class="rfq-form-group">
                <label>Currency</label>
                <select id="rfq-detail-currency" class="rfq-input">
                  <option value="EUR">EUR</option>
                  <option value="USD">USD</option>
                  <option value="CZK">CZK</option>
                  <option value="GBP">GBP</option>
                  <option value="CHF">CHF</option>
                  <option value="PLN">PLN</option>
                  <option value="CNY">CNY</option>
                </select>
              </div>
              <div class="rfq-form-group">
                <label>Incoterms</label>
                <select id="rfq-detail-incoterms" class="rfq-input">
                  <option value="">-</option>
                  <option>EXW</option>
                  <option>FCA</option>
                  <option>FAS</option>
                  <option>FOB</option>
                  <option>CFR</option>
                  <option>CIF</option>
                  <option>CPT</option>
                  <option>CIP</option>
                  <option>DPU</option>
                  <option>DAP</option>
                  <option>DDP</option>
                </select>
              </div>
              <div class="rfq-form-group">
                <label>Global Lead Time</label>
                <input type="text" id="rfq-detail-lead-time" class="rfq-input" placeholder="e.g. 6-8 weeks">
              </div>
              <div class="rfq-form-group">
                <label>Shipping Cost</label>
                <input type="number" step="0.01" id="rfq-detail-shipping" class="rfq-input" placeholder="0.00">
              </div>
              <div class="rfq-form-group">
                <label>Global MOQ</label>
                <input type="number" id="rfq-detail-moq" class="rfq-input" placeholder="0">
              </div>
              <div class="rfq-form-group">
                <label>MOV (Min Order Value)</label>
                <input type="number" step="0.01" id="rfq-detail-mov" class="rfq-input" placeholder="0.00">
              </div>
            </div>
          </div>
        </div>

        <!-- Bulk Actions Section -->
        <div class="rfq-detail-section">
          <div class="rfq-detail-section-header" data-section="bulk">
            <span>‚ö° Bulk Actions & Comments</span>
            <span class="rfq-section-toggle">‚ñº</span>
          </div>
          <div class="rfq-detail-section-body" id="section-bulk">
            <div class="rfq-detail-grid-3">
              <div class="rfq-form-group">
                <label>Set All Item Status</label>
                <select id="rfq-detail-bulk-status" class="rfq-input">
                  <option value="">Keep current</option>
                  <option value="Planned">üìã Planned</option>
                  <option value="RFQ Sent">üì§ RFQ Sent</option>
                  <option value="Missing Info">‚ö†Ô∏è Missing Info</option>
                  <option value="Quoted">üì• Quoted</option>
                  <option value="Done">‚úÖ Done</option>
                </select>
              </div>
              <div class="rfq-form-group" style="grid-column: span 2;">
                <label>Supplier Comment (applies to all items)</label>
                <textarea id="rfq-detail-global-comment" class="rfq-input" rows="2" placeholder="Add comment for this quote batch..."></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Prices Table -->
      <div class="rfq-detail-table-wrap">
        <table class="rfq-prices-table" id="rfq-detail-table">
          <thead>
            <tr>
              <th style="width: 36px;"><input type="checkbox" id="rfq-detail-select-all" checked></th>
              <th style="width: 120px;">Drawing No</th>
              <th>Description</th>
              <th style="width: 70px;">Qty</th>
              <th style="width: 90px;">Unit Price</th>
              <th style="width: 90px;">Total</th>
              <th style="width: 80px;">Lead Time</th>
              <th style="width: 65px;">MOQ</th>
              <th style="width: 100px;">Status</th>
              <th style="width: 150px;">Comment</th>
            </tr>
          </thead>
          <tbody id="rfq-detail-tbody"></tbody>
          <tfoot>
            <tr>
              <td colspan="5" style="text-align: right; font-weight: 700;">Total Value:</td>
              <td id="rfq-detail-total" style="font-weight: 700;">0.00</td>
              <td colspan="4"></td>
            </tr>
          </tfoot>
        </table>
      </div>
      <div class="rfq-wizard-footer">
        <button id="rfq-detail-cancel" class="rfq-btn-secondary">Cancel</button>
        <div class="rfq-wizard-footer-right">
          <button id="rfq-detail-save-draft" class="rfq-btn-secondary">Save as Draft</button>
          <button id="rfq-detail-save-quote" class="rfq-btn-primary" style="background:#4338ca; color:white;">Save &amp; Create Quote</button>
          <button id="rfq-detail-save" class="rfq-btn-success">Save Quote to Items</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Comment Modal for bulk comments -->
  <div id="planner-comment-modal" class="rfq-modal-overlay hidden">
    <div class="rfq-modal-container" style="max-width: 500px;">
      <div class="rfq-wizard-header">
        <div>
          <h3>Add Comment</h3>
          <span class="muted" id="planner-comment-subtitle">For selected items</span>
        </div>
        <button id="planner-comment-close" class="rfq-btn-close">&times;</button>
      </div>
      <div style="padding: 20px;">
        <div class="rfq-form-group">
          <label>Comment</label>
          <textarea id="planner-comment-text" class="rfq-input" rows="4" placeholder="Enter your comment..."></textarea>
        </div>
        <div class="rfq-form-group">
          <label>Also set status to:</label>
          <select id="planner-comment-status" class="rfq-input">
            <option value="">Keep current status</option>
            <option value="Missing Info">‚ö†Ô∏è Missing Info</option>
            <option value="RFQ Sent">üì§ RFQ Sent</option>
            <option value="Quoted">üì• Quoted</option>
          </select>
        </div>
      </div>
      <div class="rfq-wizard-footer">
        <button id="planner-comment-cancel" class="rfq-btn-secondary">Cancel</button>
        <button id="planner-comment-save" class="rfq-btn-primary">Save Comment</button>
      </div>
    </div>
  </div>

  <!-- Add Supplier Modal -->
  <div id="add-supplier-modal" class="rfq-modal-overlay hidden">
    <div class="rfq-modal-container" style="max-width: 450px;">
      <div class="rfq-wizard-header">
        <div>
          <h3>Add Supplier to Project</h3>
        </div>
        <button id="add-supplier-close" class="rfq-btn-close">&times;</button>
      </div>
      <div style="padding: 20px;">
        <div class="rfq-form-group">
          <label>Supplier Name *</label>
          <input type="text" id="add-supplier-name" class="rfq-input" placeholder="Enter supplier name...">
        </div>
        <div class="rfq-form-group">
          <label>Contact Email</label>
          <input type="email" id="add-supplier-email" class="rfq-input" placeholder="email@example.com">
        </div>
        <div class="rfq-form-group">
          <label>Contact Person</label>
          <input type="text" id="add-supplier-contact" class="rfq-input" placeholder="Contact name">
        </div>
        <div class="rfq-form-group">
          <label>Assign to items:</label>
          <select id="add-supplier-assign" class="rfq-input">
            <option value="none">Don't assign to items yet</option>
            <option value="all">Assign to ALL items</option>
            <option value="no-supplier">Assign to items without supplier</option>
          </select>
        </div>
      </div>
      <div class="rfq-wizard-footer">
        <button id="add-supplier-cancel" class="rfq-btn-secondary">Cancel</button>
        <button id="add-supplier-save" class="rfq-btn-primary">Add Supplier</button>
      </div>
    </div>
  </div>

  <!-- Tab 1: Supplier Selection -->
  <div id="tab-supplier-selection" class="rfq-tab-content active">
    <div class="supplier-selection-container">
      <!-- Header with actions -->
      <div class="supplier-selection-header">
        <div class="supplier-selection-title">
          <h2>Supplier Selection & Assignment</h2>
          <span class="rfq-quoting-subtitle">Assign suppliers to items, import from Excel, create RFQ batches</span>
        </div>
        <div class="supplier-selection-actions">
          <button id="btn-ss-import-excel" class="rfq-btn-secondary">
            <span style="margin-right:4px;">&#8593;</span> Import from Excel
          </button>
          <button id="btn-ss-export-template" class="rfq-btn-secondary">
            <span style="margin-right:4px;">&#8595;</span> Download Template
          </button>
          <button id="btn-ss-create-rfq" class="rfq-btn-primary" disabled>
            Create RFQ for Selected
          </button>
        </div>
      </div>

      <!-- Main Layout: 3 columns -->
      <div class="supplier-selection-layout">
        <!-- Left Panel: Suppliers -->
        <div class="ss-panel ss-suppliers-panel">
          <div class="ss-panel-header">
            <h3>Selected Suppliers</h3>
            <div style="display:flex; gap:4px;">
              <button id="btn-ss-pick-existing" class="rfq-btn-mini" title="Pick from existing suppliers">+ Pick</button>
              <button id="btn-ss-add-supplier" class="rfq-btn-mini" title="Create new supplier">+ New</button>
            </div>
          </div>
          <div class="ss-panel-search">
            <input type="text" id="ss-supplier-search" class="rfq-input" placeholder="Search selected...">
          </div>
          <div class="ss-selected-suppliers" id="ss-selected-suppliers">
            <!-- Selected supplier chips rendered here -->
          </div>
          <div class="ss-panel-list" id="ss-suppliers-list">
            <!-- Available supplier cards rendered here -->
          </div>
        </div>

        <!-- Center Panel: Items to Assign -->
        <div class="ss-panel ss-items-panel">
          <div class="ss-panel-header">
            <h3>Items</h3>
            <div class="ss-items-actions">
              <button id="btn-ss-select-all-items" class="rfq-btn-mini">Select All</button>
              <button id="btn-ss-clear-selection" class="rfq-btn-mini">Clear</button>
            </div>
          </div>
          <div class="ss-panel-filters">
            <input type="text" id="ss-items-search" class="rfq-input" placeholder="Search Drawing No, Description..." style="flex:1;">
            <input type="text" id="ss-items-mpn-filter" class="rfq-input" placeholder="Filter MPN..." style="width:120px;">
            <input type="text" id="ss-items-mfr-filter" class="rfq-input" placeholder="Filter Manufacturer..." style="width:140px;">
            <select id="ss-items-filter" class="rfq-input" style="width:140px;">
              <option value="all">All Items</option>
              <option value="no-supplier">Without Supplier</option>
              <option value="with-supplier">With Supplier</option>
              <option value="needs-rfq">Needs RFQ</option>
            </select>
          </div>
          <div class="ss-items-table-wrapper">
            <table class="ss-items-table" id="ss-items-table">
              <thead>
                <tr>
                  <th style="width:36px;"><input type="checkbox" id="ss-items-check-all"></th>
                  <th style="width:120px;">Drawing No</th>
                  <th style="width:100px;">MPN</th>
                  <th style="width:120px;">Manufacturer</th>
                  <th>Description</th>
                  <th style="width:60px;">Qty</th>
                  <th style="width:150px;">Suppliers</th>
                  <th style="width:80px;">Status</th>
                </tr>
              </thead>
              <tbody id="ss-items-tbody">
                <!-- Items rendered here -->
              </tbody>
            </table>
          </div>
          <div class="ss-items-footer">
            <span id="ss-items-selected-count">0 items selected</span>
            <button id="btn-ss-assign-to-selected" class="rfq-btn-primary" disabled>
              Assign Selected Supplier to Items
            </button>
          </div>
        </div>

        <!-- Right Panel: Assignment Preview / Sourcing Strategy -->
        <div class="ss-panel ss-preview-panel">
          <div class="ss-panel-header">
            <h3>Assignment Preview</h3>
          </div>
          <div class="ss-preview-content" id="ss-preview-content">
            <div class="ss-preview-empty">
              <div style="font-size:48px; margin-bottom:12px; opacity:0.3;">&#128269;</div>
              <div style="color:#888;">Select items and a supplier to preview assignment</div>
            </div>
          </div>
          <div class="ss-preview-actions" id="ss-preview-actions" style="display:none;">
            <button id="btn-ss-confirm-assignment" class="rfq-btn-success" style="width:100%;">
              Confirm Assignment & Add to Sourcing Strategy
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab 4: Final Summary (Premium Feature) - 3 Column Layout -->
  <div id="tab-final-summary" class="rfq-tab-content hidden">
    <div class="fs-3col-layout">
      <!-- LEFT SIDEBAR: Suppliers List -->
      <div class="fs-left-sidebar">
        <!-- Header with stats -->
        <div class="fs-sidebar-header">
          <h3>üèÜ Final Summary</h3>
          <div class="fs-sidebar-stats">
            <span class="fs-mini-stat" title="Total Items"><span id="fs-stat-total-items">0</span> items</span>
            <span class="fs-mini-stat awarded" title="Awarded"><span id="fs-stat-awarded">0</span> awarded</span>
          </div>
        </div>
        <!-- Search -->
        <div class="fs-sidebar-search">
          <input type="text" id="fs-supplier-search" class="rfq-input" placeholder="Search suppliers...">
        </div>
        <!-- Awarded Suppliers List -->
        <div class="fs-sidebar-section">
          <div class="fs-sidebar-section-title">
            <span>üèÖ Awarded Suppliers</span>
            <span class="fs-count-badge" id="fs-awarded-count">0</span>
          </div>
          <div class="fs-suppliers-list" id="fs-awarded-suppliers">
            <!-- Awarded supplier cards rendered here -->
          </div>
        </div>
        <!-- Non-Awarded Suppliers -->
        <div class="fs-sidebar-section non-awarded">
          <div class="fs-sidebar-section-title" onclick="document.getElementById('fs-non-awarded-list').classList.toggle('collapsed')">
            <span>üìß Non-Awarded</span>
            <span class="fs-count-badge secondary" id="fs-non-awarded-count">0</span>
          </div>
          <div class="fs-suppliers-list" id="fs-non-awarded-list">
            <!-- Non-awarded supplier cards rendered here -->
          </div>
        </div>
      </div>

      <!-- MIDDLE: Items List for Selected Supplier -->
      <div class="fs-middle-panel">
        <div class="fs-middle-header">
          <div class="fs-middle-title">
            <h3 id="fs-selected-supplier-name">Select a Supplier</h3>
            <span class="fs-middle-subtitle" id="fs-items-count">0 items</span>
          </div>
          <div class="fs-middle-actions">
            <input type="text" id="fs-items-search" class="rfq-input" placeholder="Search items..." style="width:140px;">
            <select id="fs-items-filter" class="rfq-input" style="width:100px;">
              <option value="all">All</option>
              <option value="awarded">Awarded</option>
              <option value="challenged">Challenged</option>
            </select>
            <button id="btn-fs-refresh" class="rfq-btn-secondary" style="padding:6px 10px;">‚Üª</button>
          </div>
        </div>
        <div class="fs-middle-filters">
          <label class="fs-filter-chip active" data-filter="all"><input type="radio" name="fs-item-filter" value="all" checked> All Items</label>
          <label class="fs-filter-chip" data-filter="awarded"><input type="radio" name="fs-item-filter" value="awarded"> ‚úÖ Awarded</label>
          <label class="fs-filter-chip" data-filter="challenged"><input type="radio" name="fs-item-filter" value="challenged"> ‚ö° Challenged</label>
        </div>
        <div class="fs-items-list" id="fs-items-tbody-container">
          <table class="fs-items-table" id="fs-items-table">
            <thead>
              <tr>
                <th style="width:30px;"><input type="checkbox" id="fs-select-all"></th>
                <th>Drawing No</th>
                <th>MPN</th>
                <th>Mfr</th>
                <th>Description</th>
                <th>Qty1</th>
                <th>Price1</th>
                <th>Qty2</th>
                <th>Price2</th>
                <th>Qty3</th>
                <th>Price3</th>
                <th>LT</th>
                <th>Total</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="fs-items-tbody">
              <!-- Items rendered here -->
            </tbody>
          </table>
        </div>
        <!-- Supplier Summary Footer -->
        <div class="fs-middle-footer" id="fs-supplier-summary">
          <div class="fs-summary-stat">
            <span class="label">Items:</span>
            <span class="value" id="fs-summary-items">0</span>
          </div>
          <div class="fs-summary-stat">
            <span class="label">Total Value:</span>
            <span class="value highlight" id="fs-summary-value">‚Ç¨0</span>
          </div>
          <div class="fs-summary-actions">
            <button class="fs-action-btn" onclick="window.exportCurrentSupplierItems('excel')">üìä Excel</button>
            <button class="fs-action-btn" onclick="window.exportCurrentSupplierItems('pdf')">üìÑ PDF</button>
          </div>
        </div>
      </div>

      <!-- RIGHT SIDEBAR: Actions Panel -->
      <div class="fs-right-sidebar">
        <!-- Total Value Card -->
        <div class="fs-action-card highlight">
          <div class="fs-action-card-header">üí∞ Total Project Value</div>
          <div class="fs-big-value" id="fs-stat-total-value">‚Ç¨0</div>
          <div class="fs-challenged-badge"><span id="fs-stat-challenged">0</span> challenged</div>
        </div>

        <!-- Quick Actions -->
        <div class="fs-action-card">
          <div class="fs-action-card-header">üìÑ Generate Documents</div>
          <div class="fs-action-buttons">
            <button class="fs-toolbar-btn" onclick="window.generateDocument('parts-setup')">üìä Parts Setup</button>
            <button class="fs-toolbar-btn" onclick="window.generateDocument('change-doc')">üìù Change Doc</button>
            <button class="fs-toolbar-btn" onclick="window.generateDocument('loi')">üìú LOI Summary</button>
            <button class="fs-toolbar-btn" onclick="window.openAddSignedDocumentModal()">üìé Add Document</button>
            <button class="fs-toolbar-btn" onclick="window.openLOIGeneratorForSelected()">‚úâÔ∏è Generate LOI</button>
            <button class="fs-toolbar-btn" onclick="window.generateAllLoserNotifications()">üìß Notify Losers</button>
          </div>
        </div>

        <!-- Challenge Center -->
        <div class="fs-action-card challenge">
          <div class="fs-action-card-header" onclick="document.getElementById('fs-challenge-content').classList.toggle('collapsed')">
            ‚ö° Challenge Center
            <span class="toggle-icon">‚ñº</span>
          </div>
          <div id="fs-challenge-content" class="fs-action-card-body">
            <div id="fs-selection-indicator" style="display:none; background:#eff6ff; border:1px solid #3b82f6; border-radius:6px; padding:8px 12px; margin-bottom:10px; font-size:11px; color:#1d4ed8;">
              <strong id="fs-selection-count">0</strong> items selected from <strong id="fs-selection-supplier">‚Äî</strong>
            </div>
            <div id="fs-challenge-history">
              <!-- Challenge history rendered here -->
            </div>
            <button class="fs-action-btn full-width" onclick="window.challengeSelectedItems()" id="btn-challenge-selected">‚ö° Challenge Selected Items</button>
          </div>
        </div>

        <!-- Document Tracking -->
        <div class="fs-action-card">
          <div class="fs-action-card-header" onclick="document.getElementById('fs-doctrack-content').classList.toggle('collapsed')">
            üìé Document Tracking
            <span class="toggle-icon">‚ñº</span>
          </div>
          <div id="fs-doctrack-content" class="fs-action-card-body">
            <div id="fs-doc-tracking-list">
              <!-- Tracked documents rendered here -->
            </div>
          </div>
        </div>

        <!-- Export All -->
        <div class="fs-action-card">
          <div class="fs-action-card-header">üì§ Export All</div>
          <div class="fs-action-buttons">
            <button class="fs-toolbar-btn primary" onclick="window.exportAllSummary('excel')">üìä Full Excel</button>
            <button class="fs-toolbar-btn primary" onclick="window.exportAllSummary('pdf')">üìÑ Full PDF</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Challenge Modal -->
  <div id="fs-challenge-modal" class="rfq-modal-overlay hidden">
    <div class="rfq-modal-container" style="max-width:600px;">
      <div class="rfq-wizard-header" style="background:linear-gradient(135deg,#f59e0b,#d97706);">
        <div>
          <h3 style="color:white;">‚ö° Challenge Supplier Price</h3>
          <span style="color:rgba(255,255,255,0.8);" id="fs-challenge-subtitle">Request better pricing</span>
        </div>
        <button id="fs-challenge-close" class="rfq-btn-close" style="color:white;">&times;</button>
      </div>
      <div style="padding:20px;">
        <div class="fs-challenge-info" id="fs-challenge-info">
          <!-- Item info rendered here -->
        </div>
        <div class="fs-challenge-form">
          <div class="rfq-form-group">
            <label>Challenge Type</label>
            <select id="fs-challenge-type" class="rfq-input">
              <option value="price">Request Lower Price</option>
              <option value="terms">Better Payment Terms</option>
              <option value="delivery">Faster Delivery</option>
              <option value="other">Other Request</option>
            </select>
          </div>
          <div class="rfq-form-group">
            <label>Target Price (optional)</label>
            <input type="number" id="fs-challenge-target-price" class="rfq-input" placeholder="Enter target price...">
          </div>
          <div class="rfq-form-group">
            <label>Message to Supplier</label>
            <textarea id="fs-challenge-message" class="rfq-input" rows="3" placeholder="Explain your request..."></textarea>
          </div>
          <div class="rfq-form-group">
            <label>Response Deadline</label>
            <input type="date" id="fs-challenge-deadline" class="rfq-input">
          </div>
        </div>
      </div>
      <div class="rfq-wizard-footer">
        <button id="fs-challenge-cancel" class="rfq-btn-secondary">Cancel</button>
        <button id="fs-challenge-send" class="rfq-btn-warning">Send Challenge</button>
      </div>
    </div>
  </div>

  <!-- Challenge Response Modal -->
  <div id="fs-response-modal" class="rfq-modal-overlay hidden">
    <div class="rfq-modal-container" style="max-width:500px;">
      <div class="rfq-wizard-header" style="background:linear-gradient(135deg,#22c55e,#16a34a);">
        <div>
          <h3 style="color:white;">üì• Record Challenge Response</h3>
          <span style="color:rgba(255,255,255,0.8);" id="fs-response-subtitle">Enter supplier's response</span>
        </div>
        <button id="fs-response-close" class="rfq-btn-close" style="color:white;">&times;</button>
      </div>
      <div style="padding:20px;">
        <div id="fs-response-info" style="background:#f1f5f9; padding:12px; border-radius:8px; margin-bottom:16px;">
          <!-- Challenge info -->
        </div>
        <div class="rfq-form-group">
          <label>Response Type</label>
          <select id="fs-response-type" class="rfq-input">
            <option value="accepted">‚úÖ New Price Accepted</option>
            <option value="partial">üîÑ Partial Improvement</option>
            <option value="rejected">‚ùå No Change (Rejected)</option>
          </select>
        </div>
        <div class="rfq-form-group" id="fs-response-price-group">
          <label>New Unit Price</label>
          <input type="number" id="fs-response-new-price" class="rfq-input" step="0.01" placeholder="Enter new price...">
        </div>
        <div class="rfq-form-group">
          <label>Notes</label>
          <textarea id="fs-response-notes" class="rfq-input" rows="2" placeholder="Additional notes..."></textarea>
        </div>
      </div>
      <div class="rfq-wizard-footer">
        <button id="fs-response-cancel" class="rfq-btn-secondary">Cancel</button>
        <button id="fs-response-save" class="rfq-btn-success">Save & Update Price</button>
      </div>
    </div>
  </div>

  <!-- Add Document Modal -->
  <div id="fs-add-doc-modal" class="rfq-modal-overlay hidden">
    <div class="rfq-modal-container" style="max-width:500px;">
      <div class="rfq-wizard-header">
        <div>
          <h3>üìé Add Signed Document</h3>
          <span class="muted">Upload and track signed documents</span>
        </div>
        <button id="fs-add-doc-close" class="rfq-btn-close">&times;</button>
      </div>
      <div style="padding:20px;">
        <div class="rfq-form-group">
          <label>Document Type</label>
          <select id="fs-doc-type" class="rfq-input">
            <option value="loi-signed">LOI (Signed)</option>
            <option value="po">Purchase Order</option>
            <option value="contract">Contract</option>
            <option value="nda">NDA</option>
            <option value="quality-agreement">Quality Agreement</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="rfq-form-group">
          <label>Related Supplier</label>
          <select id="fs-doc-supplier" class="rfq-input">
            <option value="">‚Äî Select Supplier ‚Äî</option>
          </select>
        </div>
        <div class="rfq-form-group">
          <label>Document Name</label>
          <input type="text" id="fs-doc-name" class="rfq-input" placeholder="e.g., LOI - Supplier ABC">
        </div>
        <div class="rfq-form-group">
          <label>Due Date</label>
          <input type="date" id="fs-doc-due-date" class="rfq-input">
        </div>
        <div class="rfq-form-group">
          <label>Status</label>
          <select id="fs-doc-status" class="rfq-input">
            <option value="pending">‚è≥ Pending</option>
            <option value="sent">üì§ Sent</option>
            <option value="received">üì• Received</option>
            <option value="signed">‚úÖ Signed</option>
            <option value="expired">‚ùå Expired</option>
          </select>
        </div>
        <div class="rfq-form-group">
          <label>Upload File (optional)</label>
          <div class="fs-upload-zone" id="fs-doc-upload-zone">
            <span style="font-size:24px;">üìÑ</span>
            <span style="font-size:12px; color:#64748b;">Drop file or click to upload</span>
            <input type="file" id="fs-doc-file" style="display:none;">
          </div>
          <div id="fs-doc-file-info" style="display:none; margin-top:8px; padding:8px; background:#f1f5f9; border-radius:6px;">
            <span id="fs-doc-file-name"></span>
            <button id="fs-doc-file-clear" class="rfq-btn-mini" style="margin-left:8px;">√ó</button>
          </div>
        </div>
        <div class="rfq-form-group">
          <label>Notes</label>
          <textarea id="fs-doc-notes" class="rfq-input" rows="2" placeholder="Additional notes..."></textarea>
        </div>
      </div>
      <div class="rfq-wizard-footer">
        <button id="fs-add-doc-cancel" class="rfq-btn-secondary">Cancel</button>
        <button id="fs-add-doc-save" class="rfq-btn-primary">Add Document</button>
      </div>
    </div>
  </div>

  <!-- Import Excel Modal for Supplier Selection -->
  <div id="ss-import-modal" class="rfq-modal-overlay hidden">
    <div class="rfq-modal-container" style="max-width:800px; width:95%;">
      <div class="rfq-wizard-header">
        <div>
          <h3>Import Supplier Assignments from Excel</h3>
          <span class="muted">Format: Drawing No, Supplier 1, Supplier 2, Supplier 3, ...</span>
        </div>
        <button id="ss-import-close" class="rfq-btn-close">&times;</button>
      </div>
      <div style="padding:20px;">
        <div class="ss-import-dropzone" id="ss-import-dropzone">
          <div style="font-size:48px; margin-bottom:12px;">&#128196;</div>
          <div style="font-weight:600; margin-bottom:8px;">Drop Excel file here or click to browse</div>
          <div style="color:#888; font-size:12px;">Supports .xlsx, .xls, .csv files</div>
          <input type="file" id="ss-import-file" accept=".xlsx,.xls,.csv" style="display:none;">
        </div>
        <div id="ss-import-preview" class="ss-import-preview hidden">
          <div class="ss-import-preview-header">
            <span id="ss-import-filename">filename.xlsx</span>
            <button id="ss-import-clear" class="rfq-btn-mini">Clear</button>
          </div>
          <div class="ss-import-preview-stats">
            <div class="ss-import-stat">
              <span class="ss-import-stat-value" id="ss-import-rows">0</span>
              <span class="ss-import-stat-label">Rows</span>
            </div>
            <div class="ss-import-stat">
              <span class="ss-import-stat-value" id="ss-import-matched">0</span>
              <span class="ss-import-stat-label">Items Matched</span>
            </div>
            <div class="ss-import-stat">
              <span class="ss-import-stat-value" id="ss-import-suppliers">0</span>
              <span class="ss-import-stat-label">Suppliers Found</span>
            </div>
          </div>
          <div class="ss-import-preview-table-wrap">
            <table class="ss-import-preview-table" id="ss-import-preview-table">
              <thead id="ss-import-preview-thead"></thead>
              <tbody id="ss-import-preview-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="rfq-wizard-footer">
        <button id="ss-import-cancel" class="rfq-btn-secondary">Cancel</button>
        <button id="ss-import-confirm" class="rfq-btn-primary" disabled>Import & Assign Suppliers</button>
      </div>
    </div>
  </div>

  <!-- Pick Existing Supplier Modal -->
  <div id="ss-pick-supplier-modal" class="rfq-modal-overlay hidden">
    <div class="rfq-modal-container" style="max-width:500px;">
      <div class="rfq-wizard-header">
        <div>
          <h3>Select Existing Suppliers</h3>
          <span class="muted">From all projects</span>
        </div>
        <button id="ss-pick-supplier-close" class="rfq-btn-close">&times;</button>
      </div>
      <div style="padding:16px;">
        <div class="ss-pick-search" style="margin-bottom:12px;">
          <input type="text" id="ss-pick-search" class="rfq-input" placeholder="Search suppliers..." style="width:100%;">
        </div>
        <div class="ss-pick-list" id="ss-pick-list" style="max-height:350px; overflow-y:auto; border:1px solid #e5e7eb; border-radius:8px;">
          <!-- Suppliers rendered here -->
        </div>
        <div style="margin-top:12px; font-size:11px; color:#666;">
          <span id="ss-pick-selected-count">0</span> supplier(s) selected
        </div>
      </div>
      <div class="rfq-wizard-footer">
        <button id="ss-pick-supplier-cancel" class="rfq-btn-secondary">Cancel</button>
        <button id="ss-pick-supplier-add" class="rfq-btn-primary">Add Selected</button>
      </div>
    </div>
  </div>

  <!-- Add New Supplier Modal for Supplier Selection -->
  <div id="ss-new-supplier-modal" class="rfq-modal-overlay hidden">
    <div class="rfq-modal-container" style="max-width:400px;">
      <div class="rfq-wizard-header">
        <div>
          <h3>Add New Supplier</h3>
        </div>
        <button id="ss-new-supplier-close" class="rfq-btn-close">&times;</button>
      </div>
      <div style="padding:20px;">
        <div class="rfq-form-group">
          <label>Supplier Name *</label>
          <input type="text" id="ss-new-supplier-name" class="rfq-input" placeholder="Enter supplier name...">
        </div>
        <div class="rfq-form-group">
          <label>Contact Email</label>
          <input type="email" id="ss-new-supplier-email" class="rfq-input" placeholder="email@example.com">
        </div>
        <div class="rfq-form-group">
          <label>Contact Person</label>
          <input type="text" id="ss-new-supplier-contact" class="rfq-input" placeholder="Contact name">
        </div>
      </div>
      <div class="rfq-wizard-footer">
        <button id="ss-new-supplier-cancel" class="rfq-btn-secondary">Cancel</button>
        <button id="ss-new-supplier-save" class="rfq-btn-primary">Create Supplier</button>
      </div>
    </div>
  </div>

  <!-- Assignment Result Modal -->
  <div id="ss-result-modal" class="rfq-modal-overlay hidden">
    <div class="rfq-modal-container" style="max-width:500px;">
      <div class="rfq-wizard-header">
        <div style="display:flex; align-items:center; gap:12px;">
          <span id="ss-result-icon" style="font-size:32px;">&#10003;</span>
          <div>
            <h3 id="ss-result-title">Assignment Complete</h3>
            <span class="muted" id="ss-result-subtitle">Suppliers added to Sourcing Strategy</span>
          </div>
        </div>
        <button id="ss-result-close" class="rfq-btn-close">&times;</button>
      </div>
      <div style="padding:20px;">
        <div class="ss-result-stats" id="ss-result-stats" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-bottom:16px;">
          <!-- Stats rendered here -->
        </div>
        <div class="ss-result-details" id="ss-result-details" style="max-height:200px; overflow-y:auto;">
          <!-- Details rendered here -->
        </div>
      </div>
      <div class="rfq-wizard-footer">
        <button id="ss-result-ok" class="rfq-btn-primary" style="min-width:120px;">OK</button>
      </div>
    </div>
  </div>

  <!-- Recalculate Result Modal -->
  <div id="recalc-result-modal" class="rfq-modal-overlay hidden">
    <div class="rfq-modal-container" style="max-width:550px;">
      <div class="rfq-wizard-header">
        <div style="display:flex; align-items:center; gap:12px;">
          <span id="recalc-result-icon" style="font-size:32px;">&#10003;</span>
          <div>
            <h3 id="recalc-result-title">Recalculation Complete</h3>
            <span class="muted" id="recalc-result-subtitle">Data synchronized and refreshed</span>
          </div>
        </div>
        <button id="recalc-result-close" class="rfq-btn-close">&times;</button>
      </div>
      <div style="padding:20px;">
        <div class="ss-result-stats" id="recalc-result-stats" style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:12px; margin-bottom:16px;">
          <!-- Stats rendered here -->
        </div>
        <div class="ss-result-details" id="recalc-result-details" style="max-height:250px; overflow-y:auto;">
          <!-- Details rendered here -->
        </div>
      </div>
      <div class="rfq-wizard-footer">
        <button id="recalc-result-ok" class="rfq-btn-primary" style="min-width:120px;">OK</button>
      </div>
    </div>
  </div>

  <!-- Quote Wizard Modal -->
  <div id="quote-wizard-modal" class="rfq-modal-overlay hidden">
    <div class="rfq-modal-container">
      <!-- Wizard Header -->
      <div class="rfq-wizard-header">
        <h3 id="wizard-title">New Quote</h3>
        <button id="wizard-close" class="rfq-btn-close">&times;</button>
      </div>

      <!-- Step Indicators -->
      <div class="rfq-wizard-steps">
        <div class="rfq-step active" data-step="1">
          <span class="rfq-step-num">1</span>
          <span class="rfq-step-label">Basic Info</span>
        </div>
        <div class="rfq-step" data-step="2">
          <span class="rfq-step-num">2</span>
          <span class="rfq-step-label">Select Items</span>
        </div>
        <div class="rfq-step" data-step="3">
          <span class="rfq-step-num">3</span>
          <span class="rfq-step-label">Enter Prices</span>
        </div>
        <div class="rfq-step" data-step="4">
          <span class="rfq-step-num">4</span>
          <span class="rfq-step-label">Review</span>
        </div>
      </div>

      <!-- Wizard Body -->
      <div class="rfq-wizard-body">
        <!-- Step 1: Basic Info -->
        <div id="wizard-step-1" class="rfq-wizard-step active">
          <div class="rfq-form-grid">
            <div class="rfq-form-group full">
              <label>Supplier *</label>
              <div class="rfq-input-group">
                <select id="wiz-supplier" class="rfq-input"></select>
                <input type="text" id="wiz-supplier-new" class="rfq-input" placeholder="Or type new supplier name">
              </div>
            </div>
            <div class="rfq-form-group">
              <label>Due Date</label>
              <input type="date" id="wiz-due-date" class="rfq-input">
            </div>
            <div class="rfq-form-group">
              <label>Currency</label>
              <select id="wiz-currency" class="rfq-input">
                <option value="EUR">EUR</option>
                <option value="USD">USD</option>
                <option value="CZK">CZK</option>
                <option value="GBP">GBP</option>
              </select>
            </div>
            <div class="rfq-form-group">
              <label>Incoterms</label>
              <select id="wiz-incoterms" class="rfq-input">
                <option value="">-- Select --</option>
                <option>EXW</option>
                <option>FCA</option>
                <option>DAP</option>
                <option>DDP</option>
                <option>FOB</option>
                <option>CIF</option>
              </select>
            </div>
            <div class="rfq-form-group">
              <label>Status</label>
              <select id="wiz-status" class="rfq-input">
                <option value="Draft">Draft</option>
                <option value="Sent">Sent</option>
                <option value="Quote Received">Quote Received</option>
                <option value="Closed">Closed</option>
                <option value="Zru≈°itled">Zru≈°itled</option>
              </select>
            </div>
            <div class="rfq-form-group">
              <label>Contact Person</label>
              <input type="text" id="wiz-contact" class="rfq-input" placeholder="Name">
            </div>
            <div class="rfq-form-group">
              <label>Contact Email</label>
              <input type="email" id="wiz-email" class="rfq-input" placeholder="email@example.com">
            </div>
            <div class="rfq-form-group full">
              <label>Notes</label>
              <textarea id="wiz-notes" class="rfq-input" rows="2" placeholder="Additional notes..."></textarea>
            </div>
          </div>
        </div>

        <!-- Step 2: Select Items -->
        <div id="wizard-step-2" class="rfq-wizard-step hidden">
          <div class="rfq-items-toolbar">
            <input type="text" id="wiz-items-search" class="rfq-input" placeholder="Search items...">
            <button id="wiz-select-all" class="rfq-btn-secondary">Select All</button>
            <span id="wiz-selected-count">0 selected</span>
          </div>
          <div class="rfq-items-list" id="wiz-items-list">
            <!-- Items checkboxes rendered here -->
          </div>
        </div>

        <!-- Step 3: Enter Prices -->
        <div id="wizard-step-3" class="rfq-wizard-step hidden">
          <div class="rfq-prices-header">
            <span>Enter prices for selected items</span>
          </div>
          <div class="rfq-prices-table-wrap">
            <table class="rfq-prices-table" id="wiz-prices-table">
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Description</th>
                  <th>Qty 1</th>
                  <th>Price 1</th>
                  <th>Qty 2</th>
                  <th>Price 2</th>
                  <th>Lead Time</th>
                  <th>MOQ</th>
                </tr>
              </thead>
              <tbody id="wiz-prices-tbody"></tbody>
            </table>
          </div>
        </div>

        <!-- Step 4: Review -->
        <div id="wizard-step-4" class="rfq-wizard-step hidden">
          <div class="rfq-review-section">
            <h4>Quote Summary</h4>
            <div id="wiz-review-summary" class="rfq-review-grid"></div>
          </div>
          <div class="rfq-review-section">
            <h4>Items & Prices</h4>
            <div id="wiz-review-items" class="rfq-review-items"></div>
          </div>
        </div>
      </div>

      <!-- Wizard Footer -->
      <div class="rfq-wizard-footer">
        <button id="wizard-prev" class="rfq-btn-secondary" disabled>‚Üê Back</button>
        <div class="rfq-wizard-footer-right">
          <button id="wizard-cancel" class="rfq-btn-text">Cancel</button>
          <button id="wizard-next" class="rfq-btn-primary">Next ‚Üí</button>
          <button id="wizard-save" class="rfq-btn-success hidden">Save Quote</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden elements for compatibility -->
  <div style="display:none;">
    <div id="quoting-wizard-panel"></div>
    <div id="quoting-suppliers-list"></div>
    <span id="qt-suppliers-count">0</span>
  </div>
</div>

<!-- SAME PARTS VIEW -->
<div id="view-samepart" class="view-section hidden" style="overflow:hidden; display:flex; flex-direction:column; min-height:0;">
  <div id="samepart-content" style="flex:1; overflow-y:auto; padding:20px;"></div>
</div>

                <div id="sheet-new-project" class="modal-overlay hidden">
                    <div class="modal-content small" style="width: 400px;">
                        <h3>New Project</h3>
                        <div class="form-row" style="margin-bottom: 15px;">
                            <label>Project Name *</label>
                            <input type="text" id="new-project-name" placeholder="E.g. Project Alpha Q1" class="modal-input">
                        </div>
                        <div class="form-row" style="margin-bottom: 15px;">
                            <label>Project Status</label>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <select id="new-project-status" class="modal-input" style="flex:1;"></select>
                                <button class="btn-secondary btn-sm" type="button" data-action="add-project-status" title="Add custom status">+</button>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="form-row">
                                <label>Received Date</label>
                                <input type="date" id="new-project-received" class="modal-input">
                            </div>
                            <div class="form-row">
                                <label>BOM Received</label>
                                <input type="date" id="new-project-bom" class="modal-input">
                            </div>
                        </div>
                        <div class="form-row" style="margin-bottom: 20px;">
                            <label>Deadline</label>
                            <input type="date" id="new-project-deadline" class="modal-input">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="form-row">
                                <label>Sent Date</label>
                                <input type="date" id="new-project-sent" class="modal-input">
                            </div>
                            <div class="form-row">
                                <label>Sent To</label>
                                <input type="text" id="new-project-sent-to" placeholder="Client/Supplier" class="modal-input">
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button id="btn-cancel-project" class="btn-secondary">Zru≈°it</button>
                            <button id="btn-create-project" class="btn-primary">Create Project</button>
                        </div>
                    </div>
                </div>

                <div id="sheet-edit-project" class="modal-overlay hidden">
                    <div class="modal-content small" style="width: 400px;">
                        <h3>Edit Project Details</h3>
                        <div class="form-row" style="margin-bottom: 15px;">
                            <label>Project Name</label>
                            <input type="text" id="edit-project-name" class="modal-input">
                        </div>
                        <div class="form-row" style="margin-bottom: 15px;">
                            <label>Project Status</label>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <select id="edit-project-status" class="modal-input" style="flex:1;"></select>
                                <button class="btn-secondary btn-sm" type="button" data-action="add-project-status" title="Add custom status">+</button>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div class="form-row">
                                <label>Received Date</label>
                                <input type="date" id="edit-project-received" class="modal-input">
                            </div>
                            <div class="form-row">
                                <label>BOM Received</label>
                                <input type="date" id="edit-project-bom" class="modal-input">
                            </div>
                        </div>
                        <div class="form-row" style="margin-bottom: 15px;">
                            <label>Deadline</label>
                            <input type="date" id="edit-project-deadline" class="modal-input">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div class="form-row">
                                <label>Sent Date</label>
                                <input type="date" id="edit-project-sent" class="modal-input">
                            </div>
                            <div class="form-row">
                                <label>Sent To</label>
                                <input type="text" id="edit-project-sent-to" class="modal-input">
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button id="btn-cancel-edit-project" class="btn-secondary">Zru≈°it</button>
                            <button id="btn-save-edit-project" class="btn-primary">Ulo≈æit Changes</button>
                        </div>
                    </div>
                </div>

                <div id="sheet-add-choice" class="modal-overlay hidden">
                    <div class="modal-content small text-center">
                        <h3>Add Items</h3>
                        <button id="btn-choice-manual" class="btn-primary full-width mb-10">Manual Entry</button>
                        <button id="btn-choice-import" class="btn-success full-width">Import Excel</button>
                    </div>
                </div>

                <div id="sheet-manual-entry" class="modal-overlay hidden">
                    <div class="modal-content large">
                        <div class="modal-header">New Item</div>
                        <div id="manual-entry-form" class="modal-body form-grid">
                            </div>
                        <div class="modal-footer">
                            <button id="btn-cancel-manual" class="btn-secondary">Zru≈°it</button>
                            <button id="btn-save-manual" class="btn-primary">Ulo≈æit Item</button>
                        </div>
                    </div>
                </div>

                <div id="detail-window" class="detail-overlay hidden"><div class="detail-card">
                    <div class="detail-header">
                        <div class="window-controls">
                            <div class="window-control close" id="btn-close-detail"></div>
                            <div class="window-control minimize" style="opacity: 0.3; pointer-events: none;"></div>
                            <div class="window-control maximize" style="opacity: 0.3; pointer-events: none;"></div>
                        </div>
                        <span class="detail-title">Item Details</span>
                    </div>
                    <div id="detail-content" class="detail-body">
                        </div>
                    <div class="detail-footer">
                        <button id="btn-delete-detail" class="btn-danger">Delete</button>
                        <div class="footer-actions">
                            <button id="btn-cancel-detail-footer" class="btn-secondary">Close</button>
                            <button id="btn-save-detail-no-close" class="btn-success" style="margin-right: 8px;">Ulo≈æit</button>
                            <button id="btn-save-detail" class="btn-primary">Ulo≈æit & Close</button>
                        </div>
                    </div>
                </div></div>

                <!-- Supplier Detail Window (Overlay) -->
                <div id="supplier-detail-window" class="detail-overlay hidden" style="z-index: 2000;"><div class="detail-card">
                    <div class="detail-header">
                        <div class="window-controls">
                            <div class="window-control close" id="btn-close-supplier-detail"></div>
                            <div class="window-control minimize" style="opacity: 0.3; pointer-events: none;"></div>
                            <div class="window-control maximize" style="opacity: 0.3; pointer-events: none;"></div>
                        </div>
                        <span class="detail-title">Supplier Details</span>
                    </div>
                    <div id="supplier-detail-content" class="detail-body" style="padding: 0; background: #f5f5f7;">
                        <!-- Content generated by JS -->
                    </div>
                    <div class="detail-footer">
                        <button id="btn-export-supplier" class="btn-success">Export Supplier Data</button>
                        <div class="footer-actions">
                            <button id="btn-close-supplier-footer" class="btn-secondary">Close</button>
                        </div>
                    </div>
                </div></div>

                <!-- Price List Modal -->
                <div id="sheet-price-list" class="modal-overlay hidden" style="z-index: 3000;">
                    <div class="modal-content large" style="width: 900px; height: 80vh;">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Price List Preview</span>
                            <div style="display: flex; gap: 10px;">
                                <button id="btn-print-list" class="btn-primary">üñ®Ô∏è Print / PDF</button>
                                <button id="btn-close-list" class="btn-secondary">Close</button>
                            </div>
                        </div>
                        <div id="price-list-body" class="modal-body" style="background: white; padding: 40px; overflow-y: auto;">
                            <!-- Content generated by JS -->
                        </div>
                    </div>
                </div>

                <style>
                    /* Global box-sizing fix - ensures padding is included in height/width calculations */
                    .rfq-layout *, .rfq-layout *::before, .rfq-layout *::after { box-sizing: border-box; }

                    /* Scoped Styles for RFQ App */
                    .rfq-layout { display: flex; height: 100%; background: #f5f5f7; font-family: -apple-system, BlinkMacSystemFont, sans-serif; box-sizing: border-box; }
                    .rfq-sidebar { width: 250px; background: rgba(255,255,255,0.5); backdrop-filter: blur(20px); border-right: 1px solid rgba(0,0,0,0.1); display: flex; flex-direction: column; }
                    .sidebar-header { padding: 15px; border-bottom: 1px solid rgba(0,0,0,0.05); }
                    .sidebar-list { flex: 1; overflow-y: auto; padding: 10px; }
                    .sidebar-item { padding: 8px 12px; border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; font-size: 13px; color: #333; margin-bottom: 2px; }
                    .sidebar-item:hover { background: rgba(0,0,0,0.05); }
                    .sidebar-item.active { background: rgba(0,122,255,0.15); color: #007AFF; font-weight: 500; }
                    .sidebar-footer { padding: 15px; border-top: 1px solid rgba(0,0,0,0.05); font-size: 11px; color: #999; text-align: center; }
                    
                    .rfq-main { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: white; min-height: 0; }
                    .rfq-nav { height: 50px; border-bottom: 1px solid #eee; display: flex; align-items: center; padding: 0 20px; justify-content: space-between; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); }
                    .nav-group { display: flex; gap: 25px; }
                    .nav-item { cursor: pointer; font-size: 13px; font-weight: 500; color: #666; padding: 16px 0; position: relative; }
                    .nav-item.active { color: #007AFF; }
                    .nav-item.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background: #007AFF; }
                    .current-project-title { font-weight: 600; font-size: 14px; }

                    .rfq-content { flex: 1; overflow: hidden; position: relative; min-height: 0; }
                    .view-section { height: 100%; overflow-y: auto; display: flex; flex-direction: column; min-height: 0; }
                    .rfq-scroll-page { flex: 1; overflow-y: auto; min-height: 0; }
                    .hidden, .view-section.hidden, .modal-overlay.hidden, .detail-overlay.hidden { display: none !important; }
                    
                    .dashboard-controls { padding: 20px 30px 0; }
                    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; padding: 20px 30px; }
                    .stat-card { background: white; border: 1px solid #eee; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
                    .stat-label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500; }
                    .stat-value { font-size: 28px; font-weight: 700; margin-top: 8px; letter-spacing: -0.5px; }
                    .color-green { color: #34C759; }
                    .color-orange { color: #FF9500; }
                    .color-blue { color: #007AFF; }
                    .color-purple { color: #5856D6; }
                    .color-red { color: #FF3B30; }

                    .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 0 30px 30px; }
                    .chart-card { background: white; border: 1px solid #eee; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
                    .chart-card h3 { font-size: 14px; margin-bottom: 15px; font-weight: 600; }
                    .chart-container { height: 250px; position: relative; }

                    .toolbar { padding: 12px 20px; border-bottom: 1px solid #eee; display: flex; gap: 10px; align-items: center; background: #fafafa; }
                    .filters-panel { padding: 12px 20px; background: #f5f5f7; border-bottom: 1px solid #eee; display: flex; gap: 10px; align-items: center; }
                    .table-wrapper { flex: 1; overflow: auto; width: 100%; }
                    #table-bulk-pricing { min-width: 100%; width: max-content; }
                    .pagination-controls { padding: 10px 20px; background: #fafafa; border-top: 1px solid #eee; display: flex; justify-content: center; align-items: center; gap: 15px; }
                    .page-btn { padding: 4px 12px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; }
                    .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
                    .page-info { font-size: 12px; font-weight: 500; color: #555; }
                    .rfq-table { width: 100%; border-collapse: collapse; font-size: 12px; }
                    .rfq-table th { text-align: left; padding: 10px 15px; border-bottom: 1px solid #ddd; background: #f9f9f9; position: sticky; top: 0; font-weight: 600; color: #555; white-space: nowrap; }
                    .rfq-table td { padding: 10px 15px; border-bottom: 1px solid #eee; color: #333; white-space: nowrap; }
                    .rfq-table tr:hover { background: #f0f7ff; cursor: pointer; }
                    .table-footer { padding: 10px 20px; background: #fafafa; border-top: 1px solid #eee; font-size: 11px; display: flex; gap: 20px; color: #666; }

                    /* Items View Tabs */
                    .items-view-tab { transition: all 0.2s; }
                    .items-view-tab:hover { color: #007AFF; }
                    .items-view-tab.active { font-weight: 600; color: #007AFF; border-bottom: 2px solid #007AFF !important; }

                    /* Pricing View Styles */
                    .pricing-summary-card { background: white; padding: 16px 20px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
                    .pricing-summary-card .label { font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
                    .pricing-summary-card .value { font-size: 24px; font-weight: 700; color: #333; }
                    .pricing-summary-card .sub { font-size: 11px; color: #666; margin-top: 4px; }
                    .pricing-summary-card.highlight { background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%); }
                    .pricing-summary-card.highlight .label { color: rgba(255,255,255,0.8); }
                    .pricing-summary-card.highlight .value { color: white; }
                    .pricing-summary-card.highlight .sub { color: rgba(255,255,255,0.7); }

                    #pricing-view-table th { background: #f8f9fa; font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.3px; color: #555; }
                    #pricing-view-table td { font-size: 12px; }
                    #pricing-view-table .price-cell { font-family: 'SF Mono', Monaco, monospace; text-align: right; }
                    #pricing-view-table .total-cell { font-weight: 600; color: #007AFF; }
                    #pricing-view-table tr.has-price { background: #f8fff8; }
                    #pricing-view-table tr.no-price { background: #fff8f8; opacity: 0.7; }
                    #pricing-view-table tr.selected { background: #e3f2fd !important; }
                    #pricing-view-table tr:hover { background: #f0f7ff !important; }

                    .btn-primary { background: #007AFF; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; transition: background 0.2s; }
                    .btn-primary:hover { background: #0063CC; }
                    .btn-secondary { background: white; border: 1px solid #ddd; color: #333; padding: 6px 12px; border-radius: 6px; font-size: 13px; cursor: pointer; }
                    .btn-secondary:hover { background: #f5f5f5; }
                    .btn-success { background: #34C759; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 13px; cursor: pointer; }
                    .btn-success:hover { background: #2fb34d; }
                    .btn-success:disabled { background: #9ae6b4; cursor: default; }
                    .btn-warning { background: #f59e0b; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 13px; cursor: pointer; }
                    .btn-warning:hover { background: #d97706; }
                    .btn-danger { background: #FF3B30; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 13px; cursor: pointer; }
                    .btn-text { background: none; border: none; color: #007AFF; cursor: pointer; font-size: 12px; }
                    
                    .macos-select, .filter-select, .filter-input, .search-input, .modal-input { padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; outline: none; }
                    .search-input { flex: 1; }
                    .full-width { width: 100%; }
                    .mb-10 { margin-bottom: 10px; }
                    .text-center { text-align: center; }

                    .empty-state { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; }
                    .empty-icon { font-size: 48px; margin-bottom: 10px; opacity: 0.5; }

                    /* Project Detail Styles */
                    .sd-card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 1px solid #e8e8e8; }
                    .sd-card-title { font-size: 12px; font-weight: 700; color: #555; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
                    .sd-kpi { display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background:#f8fafc; border-radius:6px; }
                    .sd-kpi-l { font-size: 11px; color: #666; }
                    .sd-kpi-v { font-size: 14px; font-weight: 700; color: #333; }

                    /* Main Dashboard Grid */
                    .main-dashboard-grid { grid-auto-rows: minmax(180px, auto); }

                    /* Main Dashboard Box Styles */
                    .main-box { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 1px solid #e2e8f0; display:flex; flex-direction:column; overflow:hidden; transition: box-shadow 0.2s, transform 0.2s; min-height:180px; }
                    .main-box:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.12); }
                    .main-box-header { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; background:linear-gradient(135deg,#f8fafc,#f1f5f9); border-bottom:1px solid #e2e8f0; flex-shrink:0; }
                    .main-box-title { font-size:13px; font-weight:700; color:#334155; }
                    .main-box[data-box-id="main-projects-table-box"] { min-height:250px; }
                    .main-box[data-box-id="main-projects-table-box"] .main-box-title { color:#2563eb; font-size:14px; }
                    .main-box-controls { display:flex; gap:6px; align-items:center; }
                    .main-box-btn { background:#f1f5f9; border:1px solid #e2e8f0; border-radius:4px; width:24px; height:24px; cursor:pointer; font-size:12px; display:none; align-items:center; justify-content:center; transition:all 0.2s; }
                    .main-box-btn:hover { background:#e2e8f0; border-color:#cbd5e1; }
                    .main-dashboard-grid.edit-mode .main-box-btn { display:flex; }
                    .main-box-content { padding:16px; flex:1; overflow:auto; }
                    .main-dashboard-grid.edit-mode .main-box { cursor:move; border:2px dashed #3b82f6; }
                    .main-dashboard-grid.edit-mode .main-box:hover { transform:scale(1.02); }
                    .main-box.dragging { opacity:0.5; transform:scale(0.95); }
                    .main-box.hidden-box { display:none !important; }
                    .main-dashboard-grid.edit-mode .main-box.hidden-box { display:flex !important; opacity:0.4; filter:grayscale(0.5); }
                    .main-dashboard-grid.edit-mode .main-box.hidden-box .main-box-content { display:none; }
                    .main-box .main-box-btn[data-action="delete-box"] { display:none; }
                    .main-dashboard-grid.edit-mode .main-box .main-box-btn[data-action="delete-box"] { display:flex; }
                    .main-box[data-row-span="2"] { grid-row:span 2; }
                    .main-box[data-row-span="3"] { grid-row:span 3; }
                    .main-box[data-row-span="4"] { grid-row:span 4; }
                    .main-box-btn.height-btn { background:#e0f2fe; border-color:#7dd3fc; }
                    .main-box-btn.height-btn:hover { background:#bae6fd; }
                    .main-box-size-indicator { font-size:9px; color:#94a3b8; margin-right:4px; display:none; font-family:monospace; }
                    .main-dashboard-grid.edit-mode .main-box-size-indicator { display:inline; }

                    /* Top Suppliers Card Styles */
                    .supplier-card { display:flex; align-items:center; gap:12px; padding:12px 14px; background:#f8fafc; border-radius:10px; cursor:pointer; transition:all 0.2s; border:1px solid #e2e8f0; }
                    .supplier-card:hover { background:#eef2ff; border-color:#818cf8; transform:translateX(4px); box-shadow:0 2px 8px rgba(99,102,241,0.15); }
                    .supplier-rank { width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:12px; flex-shrink:0; }
                    .supplier-rank.gold { background:linear-gradient(135deg,#fbbf24,#f59e0b); color:#fff; box-shadow:0 2px 6px rgba(245,158,11,0.4); }
                    .supplier-rank.silver { background:linear-gradient(135deg,#94a3b8,#64748b); color:#fff; }
                    .supplier-rank.bronze { background:linear-gradient(135deg,#d97706,#b45309); color:#fff; }
                    .supplier-rank.normal { background:#e2e8f0; color:#475569; }
                    .supplier-info { flex:1; min-width:0; }
                    .supplier-name { font-weight:600; color:#1e293b; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
                    .supplier-stats { display:flex; gap:12px; font-size:11px; color:#64748b; margin-top:3px; }
                    .supplier-value { text-align:right; }
                    .supplier-value-main { font-size:14px; font-weight:700; color:#10b981; }
                    .supplier-value-bar { width:60px; height:4px; background:#e2e8f0; border-radius:2px; margin-top:4px; overflow:hidden; }
                    .supplier-value-bar-fill { height:100%; background:linear-gradient(90deg,#10b981,#34d399); border-radius:2px; }
                    .sd-tabs { display: flex; gap: 4px; }
                    .sd-tab { background: transparent; border: none; padding: 10px 16px; font-size: 13px; font-weight: 500; color: #666; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
                    .sd-tab:hover { color: #007AFF; background: #f0f7ff; }
                    .sd-tab.active { color: #007AFF; border-bottom-color: #007AFF; background: transparent; }
                    .sd-panel { display: none; }
                    .sd-panel.active { display: block; overflow-y: auto; max-height: calc(100vh - 220px); padding-bottom: 40px; }
                    .sd-panels { padding: 16px 0; padding-bottom: 40px; overflow-y: auto !important; max-height: calc(100vh - 260px); }

                    .modal-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); z-index: 100; display: flex; align-items: center; justify-content: center; }
                    .modal-content { background: white; border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); overflow: hidden; display: flex; flex-direction: column; }
                    .modal-content.small { width: 320px; padding: 20px; }
                    .modal-content.large { width: 800px; height: 600px; }
                    .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; font-weight: 600; background: #fafafa; }
                    .modal-body { flex: 1; overflow-y: auto; padding: 20px; }
                    .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; background: #fafafa; }
                    
                    .detail-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #f8f9fa; z-index: 200; display: flex; flex-direction: column; }
                    .detail-header { padding: 15px 30px; border-bottom: 2px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(to bottom, #ffffff, #f5f5f5); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
                    .detail-title { font-weight: 600; font-size: 15px; color: #333; }
                    .control-close { background: #ff5f57; border: none; width: 28px; height: 28px; border-radius: 50%; font-size: 16px; color: white; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
                    .control-close:hover { transform: scale(1.1); box-shadow: 0 3px 8px rgba(0,0,0,0.25); }
                    .detail-body { flex: 1; overflow-y: auto; padding: 30px 40px; max-width: 1000px; margin: 0 auto; width: 100%; }
                    .detail-footer { padding: 18px 40px; border-top: 2px solid #e0e0e0; display: flex; justify-content: space-between; background: linear-gradient(to top, #ffffff, #f9f9f9); box-shadow: 0 -2px 8px rgba(0,0,0,0.03); }
                    .footer-actions { display: flex; gap: 12px; }

                    .detail-section { margin-bottom: 35px; background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 12px rgba(0,0,0,0.05); border: 1px solid #e8e8e8; }
                    .detail-section h3 { font-size: 14px; font-weight: 600; text-transform: uppercase; color: #555; border-bottom: 2px solid #007AFF; padding-bottom: 10px; margin-bottom: 20px; letter-spacing: 0.8px; }
                    .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 22px; }
                    .form-row { display: flex; flex-direction: column; }

                    /* Missing MacOS Styles */
                    .macos-btn { background: white; border: 1px solid #ddd; color: #333; padding: 6px 12px; border-radius: 6px; font-size: 13px; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
                    .macos-btn:hover { background: #f5f5f5; border-color: #ccc; }
                    .rfq-input { width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; outline: none; background: white; transition: border-color 0.2s; }
                    .rfq-input:focus { border-color: #007AFF; box-shadow: 0 0 0 2px rgba(0,122,255,0.1); }
                    textarea.rfq-input { resize: vertical; min-height: 60px; }
                    .form-row label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 8px; color: #333; text-transform: uppercase; letter-spacing: 0.3px; font-size: 11px; }
                    .form-row input, .form-row select { width: 100%; padding: 10px 12px; border: 1.5px solid #ddd; border-radius: 8px; font-size: 13px; transition: all 0.2s; background: white; }

                    /* Navigation Dropdown Styles */
                    .nav-dropdown {
                        position: relative;
                        display: inline-block;
                    }
                    .nav-dropdown-btn {
                        background: transparent;
                        border: none;
                        padding: 8px 12px;
                        font-size: 13px;
                        cursor: pointer;
                        color: #666;
                        transition: all 0.2s;
                    }
                    .nav-dropdown-btn:hover, .nav-dropdown.open .nav-dropdown-btn {
                        color: #007AFF;
                        background: rgba(0,122,255,0.08);
                    }
                    .nav-dropdown-btn.active {
                        color: #007AFF;
                        background: rgba(0,122,255,0.12);
                        font-weight: 600;
                    }
                    .nav-dropdown-menu {
                        display: none;
                        position: absolute;
                        top: 100%;
                        left: 0;
                        background: white;
                        min-width: 160px;
                        box-shadow: 0 8px 30px rgba(0,0,0,0.25);
                        border-radius: 8px;
                        border: 1px solid #ccc;
                        z-index: 99999;
                        padding: 6px 0;
                        margin-top: 2px;
                    }
                    .nav-dropdown.open .nav-dropdown-menu {
                        display: block;
                    }
                    .nav-dropdown-item {
                        display: block;
                        width: 100%;
                        padding: 10px 16px;
                        background: none;
                        border: none;
                        text-align: left;
                        font-size: 13px;
                        color: #333;
                        cursor: pointer;
                        transition: background 0.15s;
                    }
                    .nav-dropdown-item:hover {
                        background: #f0f7ff;
                        color: #007AFF;
                    }
                    .nav-dropdown-item.active {
                        background: #007AFF;
                        color: white;
                    }

                    /* Item Detail Layout */
                    .item-detail-layout {
                        display: grid;
                        grid-template-columns: 280px 1fr;
                        gap: 16px;
                        flex: 1;
                        min-height: 0;
                    }
                    .item-detail-left {
                        display: flex;
                        flex-direction: column;
                        gap: 12px;
                        overflow-y: auto;
                        min-height: 0;
                        padding-right: 4px;
                    }
                    .item-detail-right {
                        display: flex;
                        flex-direction: column;
                        overflow-y: auto;
                        min-height: 0;
                        padding-right: 4px;
                    }
                    .item-detail-card {
                        background: white;
                        border-radius: 10px;
                        padding: 14px;
                        box-shadow: 0 1px 4px rgba(0,0,0,0.06);
                        border: 1px solid #e8e8e8;
                    }
                    .item-detail-card-title {
                        font-size: 11px;
                        font-weight: 700;
                        color: #666;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        margin-bottom: 10px;
                        padding-bottom: 8px;
                        border-bottom: 1px solid #eee;
                    }
                    .item-header-card {
                        text-align: center;
                        padding: 16px;
                    }
                    .item-header-image {
                        width: 80px;
                        height: 80px;
                        margin: 0 auto 10px;
                        border-radius: 10px;
                        background: #f5f5f7;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        overflow: hidden;
                    }
                    .item-header-title {
                        font-size: 15px;
                        font-weight: 700;
                        color: #333;
                        margin-bottom: 4px;
                        word-break: break-word;
                    }
                    .item-header-subtitle {
                        font-size: 12px;
                        color: #666;
                        word-break: break-word;
                    }
                    .item-kpi-grid {
                        display: flex;
                        flex-direction: column;
                        gap: 8px;
                    }
                    .item-kpi {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 6px 0;
                        border-bottom: 1px solid #f0f0f0;
                    }
                    .item-kpi:last-child { border-bottom: none; }
                    .item-kpi-label {
                        font-size: 11px;
                        color: #888;
                        font-weight: 500;
                    }
                    .item-kpi-value {
                        font-size: 13px;
                        font-weight: 600;
                        color: #333;
                        text-align: right;
                    }
                    .item-kpi-value.success { color: #28a745; }
                    .item-kpi-value.info { color: #007AFF; }
                    .item-quick-actions {
                        display: flex;
                        flex-direction: column;
                        gap: 6px;
                    }
                    .item-quick-actions button {
                        width: 100%;
                        padding: 8px 10px;
                        font-size: 12px;
                        border-radius: 6px;
                        border: 1px solid #ddd;
                        background: #fafafa;
                        cursor: pointer;
                        transition: all 0.15s;
                    }
                    .item-quick-actions button:hover {
                        background: #f0f0f0;
                        border-color: #ccc;
                    }
                    .item-detail-mini-tabs {
                        display: flex;
                        gap: 4px;
                        margin-bottom: 12px;
                    }
                    .item-detail-mini-tab {
                        padding: 5px 10px;
                        font-size: 11px;
                        font-weight: 600;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        background: #e9ecef;
                        color: #666;
                        transition: all 0.15s;
                    }
                    .item-detail-mini-tab.active {
                        background: #007AFF;
                        color: white;
                    }
                    .item-detail-mini-tab:hover:not(.active) {
                        background: #dee2e6;
                    }

                    /* ====== NEW Quoting Process Styles ====== */
                    .rfq-quoting-container {
                        display: flex;
                        flex-direction: column;
                        flex: 1;
                        min-height: 0;
                        background: #f5f7fa;
                    }
                    .rfq-quoting-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 20px 24px;
                        background: white;
                        border-bottom: 1px solid #e0e0e0;
                    }
                    .rfq-quoting-title h2 {
                        margin: 0;
                        font-size: 22px;
                        font-weight: 700;
                        color: #1a1a2e;
                    }
                    .rfq-quoting-subtitle {
                        font-size: 13px;
                        color: #666;
                    }
                    .rfq-quoting-actions {
                        display: flex;
                        gap: 12px;
                        align-items: center;
                    }
                    .rfq-quoting-body {
                        flex: 1;
                        overflow-y: auto;
                        padding: 20px 24px;
                    }
                    .rfq-input {
                        padding: 10px 14px;
                        border: 1px solid #ddd;
                        border-radius: 8px;
                        font-size: 13px;
                        background: white;
                        transition: border-color 0.2s;
                    }
                    .rfq-input:focus {
                        outline: none;
                        border-color: #4361ee;
                    }
                    .rfq-btn-primary {
                        background: #4361ee;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 8px;
                        font-size: 13px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.2s;
                    }
                    .rfq-btn-primary:hover { background: #3a56d4; }
                    .rfq-btn-secondary {
                        background: white;
                        color: #333;
                        border: 1px solid #ddd;
                        padding: 10px 20px;
                        border-radius: 8px;
                        font-size: 13px;
                        cursor: pointer;
                    }
                    .rfq-btn-secondary:hover { background: #f5f5f5; }
                    .rfq-btn-success {
                        background: #10b981;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 8px;
                        font-size: 13px;
                        font-weight: 600;
                        cursor: pointer;
                    }
                    .rfq-btn-success:hover { background: #059669; }
                    .rfq-btn-text {
                        background: none;
                        border: none;
                        color: #666;
                        padding: 10px;
                        cursor: pointer;
                        font-size: 13px;
                    }
                    .rfq-btn-text:hover { color: #333; }
                    .rfq-btn-close {
                        background: none;
                        border: none;
                        font-size: 24px;
                        color: #999;
                        cursor: pointer;
                        padding: 0;
                        line-height: 1;
                    }
                    .rfq-btn-close:hover { color: #333; }

                    /* Toast Notification */
                    .rfq-toast {
                        position: fixed;
                        bottom: 30px;
                        left: 50%;
                        transform: translateX(-50%) translateY(100px);
                        background: #333;
                        color: white;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-size: 14px;
                        font-weight: 500;
                        z-index: 10000;
                        opacity: 0;
                        transition: transform 0.3s ease, opacity 0.3s ease;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        max-width: 90%;
                        text-align: center;
                    }
                    .rfq-toast.show {
                        transform: translateX(-50%) translateY(0);
                        opacity: 1;
                    }
                    .rfq-toast-success { background: #10b981; }
                    .rfq-toast-error { background: #ef4444; }
                    .rfq-toast-warning { background: #f59e0b; }
                    .rfq-toast-info { background: #3b82f6; }

                    /* Item Comparison Grid */
                    .rfq-comparison-grid {
                        display: flex;
                        flex-direction: column;
                        gap: 16px;
                    }
                    .rfq-item-card {
                        background: white;
                        border-radius: 12px;
                        border: 1px solid #e0e0e0;
                        overflow: hidden;
                    }
                    .rfq-item-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 16px 20px;
                        background: #f8fafc;
                        border-bottom: 1px solid #e0e0e0;
                    }
                    .rfq-item-title {
                        font-size: 15px;
                        font-weight: 700;
                        color: #1a1a2e;
                    }
                    .rfq-item-desc {
                        font-size: 12px;
                        color: #666;
                        margin-top: 2px;
                    }
                    .rfq-item-qty {
                        font-size: 12px;
                        color: #4361ee;
                        font-weight: 600;
                    }
                    .rfq-quotes-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                        gap: 12px;
                        padding: 16px 20px;
                    }
                    .rfq-quote-card {
                        padding: 14px;
                        background: #f8fafc;
                        border-radius: 8px;
                        border: 1px solid #e8e8e8;
                    }
                    .rfq-quote-card.best {
                        border-color: #10b981;
                        background: #ecfdf5;
                    }
                    .rfq-quote-supplier {
                        font-size: 13px;
                        font-weight: 600;
                        color: #333;
                        margin-bottom: 8px;
                    }
                    .rfq-quote-price {
                        font-size: 18px;
                        font-weight: 700;
                        color: #1a1a2e;
                    }
                    .rfq-quote-price.best { color: #10b981; }
                    .rfq-quote-meta {
                        font-size: 11px;
                        color: #888;
                        margin-top: 6px;
                    }
                    .rfq-no-quotes {
                        padding: 20px;
                        text-align: center;
                        color: #999;
                        font-size: 13px;
                    }

                    /* Modal Overlay */
                    .rfq-modal-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0,0,0,0.5);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 1000;
                    }
                    .rfq-modal-overlay.hidden { display: none !important; }
                    .rfq-modal-container {
                        background: white;
                        border-radius: 16px;
                        width: 90%;
                        max-width: 800px;
                        max-height: 90vh;
                        display: flex;
                        flex-direction: column;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    }

                    /* Wizard Header */
                    .rfq-wizard-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 20px 24px;
                        border-bottom: 1px solid #e0e0e0;
                    }
                    .rfq-wizard-header h3 {
                        margin: 0;
                        font-size: 18px;
                        font-weight: 700;
                        color: #1a1a2e;
                    }

                    /* Wizard Steps */
                    .rfq-wizard-steps {
                        display: flex;
                        padding: 20px 24px;
                        background: #f8fafc;
                        border-bottom: 1px solid #e0e0e0;
                        gap: 8px;
                    }
                    .rfq-step {
                        flex: 1;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                        padding: 12px;
                        border-radius: 8px;
                        background: #e9ecef;
                        color: #666;
                        font-size: 12px;
                        font-weight: 500;
                        transition: all 0.2s;
                    }
                    .rfq-step.active {
                        background: #4361ee;
                        color: white;
                    }
                    .rfq-step.completed {
                        background: #10b981;
                        color: white;
                    }
                    .rfq-step-num {
                        width: 24px;
                        height: 24px;
                        border-radius: 50%;
                        background: rgba(255,255,255,0.2);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: 700;
                    }
                    .rfq-step-label { font-weight: 600; }

                    /* Wizard Body */
                    .rfq-wizard-body {
                        flex: 1;
                        overflow-y: auto;
                        padding: 24px;
                    }
                    .rfq-wizard-step { display: block; }
                    .rfq-wizard-step.hidden { display: none !important; }

                    /* Form Grid */
                    .rfq-form-grid {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 16px;
                    }
                    .rfq-form-group {
                        display: flex;
                        flex-direction: column;
                        gap: 6px;
                    }
                    .rfq-form-group.full { grid-column: 1 / -1; }
                    .rfq-form-group label {
                        font-size: 12px;
                        font-weight: 600;
                        color: #555;
                        text-transform: uppercase;
                    }
                    .rfq-input-group {
                        display: flex;
                        gap: 8px;
                    }
                    .rfq-input-group .rfq-input { flex: 1; }

                    /* Items List (Step 2) */
                    .rfq-items-toolbar {
                        display: flex;
                        gap: 12px;
                        align-items: center;
                        margin-bottom: 16px;
                    }
                    .rfq-items-toolbar .rfq-input { flex: 1; }
                    .rfq-items-list {
                        max-height: 400px;
                        overflow-y: auto;
                        border: 1px solid #e0e0e0;
                        border-radius: 8px;
                    }
                    .rfq-item-row {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 12px 16px;
                        border-bottom: 1px solid #f0f0f0;
                        cursor: pointer;
                        transition: background 0.15s;
                    }
                    .rfq-item-row:hover { background: #f8fafc; }
                    .rfq-item-row:last-child { border-bottom: none; }
                    .rfq-item-row.selected { background: #eff6ff; }
                    .rfq-item-row input[type="checkbox"] {
                        width: 18px;
                        height: 18px;
                        accent-color: #4361ee;
                    }
                    .rfq-item-info { flex: 1; }
                    .rfq-item-info-title {
                        font-size: 13px;
                        font-weight: 600;
                        color: #333;
                    }
                    .rfq-item-info-desc {
                        font-size: 11px;
                        color: #888;
                    }

                    /* Prices Table (Step 3) */
                    .rfq-prices-header {
                        margin-bottom: 16px;
                        font-size: 14px;
                        color: #555;
                    }
                    .rfq-prices-table-wrap {
                        overflow-x: auto;
                        border: 1px solid #e0e0e0;
                        border-radius: 8px;
                    }
                    .rfq-prices-table {
                        width: 100%;
                        border-collapse: collapse;
                        font-size: 13px;
                    }
                    .rfq-prices-table th {
                        background: #f8fafc;
                        padding: 12px;
                        text-align: left;
                        font-weight: 600;
                        color: #555;
                        border-bottom: 1px solid #e0e0e0;
                        white-space: nowrap;
                    }
                    .rfq-prices-table td {
                        padding: 10px 12px;
                        border-bottom: 1px solid #f0f0f0;
                    }
                    .rfq-prices-table tr:last-child td { border-bottom: none; }
                    .rfq-prices-table input {
                        width: 80px;
                        padding: 8px;
                        border: 1px solid #ddd;
                        border-radius: 6px;
                        font-size: 13px;
                    }
                    .rfq-prices-table input:focus {
                        outline: none;
                        border-color: #4361ee;
                    }

                    /* Review Section (Step 4) */
                    .rfq-review-section {
                        margin-bottom: 24px;
                    }
                    .rfq-review-section h4 {
                        margin: 0 0 12px 0;
                        font-size: 14px;
                        font-weight: 700;
                        color: #333;
                        padding-bottom: 8px;
                        border-bottom: 2px solid #4361ee;
                    }
                    .rfq-review-grid {
                        display: grid;
                        grid-template-columns: repeat(3, 1fr);
                        gap: 12px;
                    }
                    .rfq-review-item {
                        padding: 12px;
                        background: #f8fafc;
                        border-radius: 8px;
                    }
                    .rfq-review-label {
                        font-size: 11px;
                        color: #888;
                        text-transform: uppercase;
                    }
                    .rfq-review-value {
                        font-size: 14px;
                        font-weight: 600;
                        color: #333;
                        margin-top: 4px;
                    }
                    .rfq-review-items {
                        border: 1px solid #e0e0e0;
                        border-radius: 8px;
                        overflow: hidden;
                    }

                    /* Wizard Footer */
                    .rfq-wizard-footer {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 16px 24px;
                        border-top: 1px solid #e0e0e0;
                        background: #f8fafc;
                    }
                    .rfq-wizard-footer-right {
                        display: flex;
                        gap: 12px;
                    }

                    /* Empty state */
                    .rfq-empty-state {
                        text-align: center;
                        padding: 60px 20px;
                        color: #888;
                    }
                    .rfq-empty-icon {
                        font-size: 64px;
                        margin-bottom: 16px;
                        opacity: 0.5;
                    }
                    .rfq-empty-title {
                        font-size: 18px;
                        font-weight: 600;
                        color: #333;
                        margin-bottom: 8px;
                    }

                    /* Quoting Tabs */
                    .rfq-tabs-header {
                        display: flex;
                        gap: 4px;
                        padding: 12px 24px;
                        background: white;
                        border-bottom: 1px solid #e0e0e0;
                    }
                    .rfq-tab {
                        padding: 10px 24px;
                        border: none;
                        background: #f0f0f5;
                        color: #666;
                        font-size: 13px;
                        font-weight: 600;
                        border-radius: 8px 8px 0 0;
                        cursor: pointer;
                        transition: all 0.2s;
                    }
                    .rfq-tab:hover {
                        background: #e5e5ea;
                    }
                    .rfq-tab.active {
                        background: #4361ee;
                        color: white;
                    }
                    .rfq-tab-content {
                        display: flex;
                        flex-direction: column;
                        flex: 1;
                        min-height: 0;
                        overflow-y: auto;
                    }
                    .rfq-tab-content.hidden {
                        display: none !important;
                    }

                    /* RFQ Planner */
                    .rfq-planner-filters {
                        display: flex;
                        gap: 20px;
                        align-items: center;
                        padding: 12px 16px;
                        background: #f8fafc;
                        border-radius: 8px;
                        margin-bottom: 16px;
                        flex-wrap: wrap;
                    }
                    .rfq-planner-filters label {
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        font-size: 13px;
                        color: #555;
                        cursor: pointer;
                    }
                    .rfq-planner-filters input[type="checkbox"] {
                        width: 16px;
                        height: 16px;
                        accent-color: #4361ee;
                    }
                    .rfq-planner-grid {
                        display: flex;
                        flex-direction: column;
                        gap: 12px;
                    }
                    .rfq-planner-supplier-group {
                        background: white;
                        border-radius: 12px;
                        border: 1px solid #e0e0e0;
                        overflow: hidden;
                    }
                    .rfq-planner-supplier-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 14px 20px;
                        background: #f8fafc;
                        border-bottom: 1px solid #e0e0e0;
                        cursor: pointer;
                    }
                    .rfq-planner-supplier-header:hover {
                        background: #f0f4f8;
                    }
                    .rfq-planner-supplier-name {
                        font-size: 15px;
                        font-weight: 700;
                        color: #1a1a2e;
                    }
                    .rfq-planner-supplier-count {
                        font-size: 12px;
                        color: #666;
                        background: #e9ecef;
                        padding: 4px 12px;
                        border-radius: 12px;
                    }
                    .rfq-planner-items {
                        padding: 12px 20px;
                    }
                    .rfq-planner-item {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 10px 0;
                        border-bottom: 1px solid #f0f0f0;
                    }
                    .rfq-planner-item:last-child {
                        border-bottom: none;
                    }
                    .rfq-planner-item input[type="checkbox"] {
                        width: 18px;
                        height: 18px;
                        accent-color: #4361ee;
                    }
                    .rfq-planner-item-info {
                        flex: 1;
                    }
                    .rfq-planner-item-dn {
                        font-size: 13px;
                        font-weight: 600;
                        color: #333;
                    }
                    .rfq-planner-item-desc {
                        font-size: 11px;
                        color: #888;
                    }
                    .rfq-planner-item-qty {
                        font-size: 13px;
                        font-weight: 600;
                        color: #4361ee;
                        min-width: 80px;
                        text-align: right;
                    }
                    .rfq-planner-item-status {
                        font-size: 11px;
                        padding: 3px 10px;
                        border-radius: 4px;
                        background: #fff3cd;
                        color: #856404;
                    }
                    .rfq-planner-item-status.has-quote {
                        background: #d4edda;
                        color: #155724;
                    }
                    .rfq-planner-no-supplier {
                        background: white;
                        border-radius: 12px;
                        border: 1px solid #e0e0e0;
                        padding: 20px;
                    }
                    .rfq-planner-no-supplier-title {
                        font-size: 14px;
                        font-weight: 700;
                        color: #dc3545;
                        margin-bottom: 12px;
                    }

                    /* New RFQ Planner Layout - 2 columns */
                    .rfq-planner-layout {
                        display: grid;
                        grid-template-columns: 280px 1fr;
                        gap: 0;
                        flex: 1;
                        min-height: 0;
                        background: white;
                        border-radius: 12px;
                        border: 1px solid #e0e0e0;
                        overflow: hidden;
                    }
                    .rfq-planner-sidebar {
                        background: #f8fafc;
                        border-right: 1px solid #e0e0e0;
                        display: flex;
                        flex-direction: column;
                        min-height: 0;
                        overflow: hidden;
                    }
                    .rfq-planner-sidebar-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 16px 20px;
                        border-bottom: 1px solid #e0e0e0;
                    }
                    .rfq-planner-sidebar-header h3 {
                        font-size: 15px;
                        font-weight: 700;
                        color: #1a1a2e;
                        margin: 0;
                    }
                    .rfq-planner-sidebar-count {
                        background: #4361ee;
                        color: white;
                        padding: 2px 10px;
                        border-radius: 12px;
                        font-size: 12px;
                        font-weight: 600;
                    }
                    .rfq-planner-sidebar-search {
                        padding: 12px 16px;
                        border-bottom: 1px solid #e0e0e0;
                    }
                    .rfq-planner-sidebar-search input {
                        width: 100%;
                        padding: 8px 12px;
                        border: 1px solid #ddd;
                        border-radius: 6px;
                        font-size: 13px;
                    }
                    .rfq-planner-sidebar-list {
                        flex: 1;
                        overflow-y: auto;
                        padding: 8px;
                    }
                    .planner-supplier-card {
                        padding: 12px 14px;
                        border-radius: 8px;
                        cursor: pointer;
                        margin-bottom: 4px;
                        transition: all 0.15s;
                        border: 1px solid transparent;
                    }
                    .planner-supplier-card:hover {
                        background: white;
                        border-color: #ddd;
                    }
                    .planner-supplier-card.active {
                        background: white;
                        border-color: #4361ee;
                        box-shadow: 0 2px 8px rgba(67, 97, 238, 0.15);
                    }
                    .planner-supplier-card-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                        margin-bottom: 4px;
                    }
                    .planner-supplier-card-name {
                        font-weight: 600;
                        font-size: 13px;
                        color: #333;
                    }
                    .planner-supplier-detail-btn {
                        width: 18px;
                        height: 18px;
                        border-radius: 50%;
                        border: 1px solid #ccc;
                        background: white;
                        color: #666;
                        font-size: 11px;
                        font-weight: 600;
                        cursor: pointer;
                        line-height: 1;
                        padding: 0;
                        flex-shrink: 0;
                    }
                    .planner-supplier-detail-btn:hover {
                        background: #4361ee;
                        border-color: #4361ee;
                        color: white;
                    }
                    .planner-supplier-card-stats {
                        display: flex;
                        gap: 10px;
                        font-size: 11px;
                        color: #888;
                    }
                    .planner-supplier-card-stats .needs-quote {
                        color: #e67700;
                        font-weight: 600;
                    }
                    .planner-supplier-card-stats .has-quote {
                        color: #2f9e44;
                    }

                    /* Right panel - main */
                    .rfq-planner-main {
                        display: flex;
                        flex-direction: column;
                        min-height: 0;
                        overflow: hidden;
                        background: white;
                    }
                    .rfq-planner-main-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 16px 24px;
                        border-bottom: 1px solid #e0e0e0;
                        background: #fafbfc;
                    }
                    .rfq-planner-main-title h3 {
                        font-size: 16px;
                        font-weight: 700;
                        color: #1a1a2e;
                        margin: 0;
                    }
                    .rfq-planner-main-subtitle {
                        font-size: 12px;
                        color: #888;
                    }
                    .rfq-planner-main-actions {
                        display: flex;
                        gap: 10px;
                    }
                    .rfq-planner-main-filters {
                        display: flex;
                        gap: 20px;
                        align-items: center;
                        padding: 12px 24px;
                        background: #f8f9fa;
                        border-bottom: 1px solid #eee;
                        font-size: 13px;
                    }
                    .rfq-planner-main-filters label {
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        cursor: pointer;
                        color: #555;
                    }
                    .rfq-planner-main-filters input[type="checkbox"] {
                        width: 16px;
                        height: 16px;
                        accent-color: #4361ee;
                    }
                    .rfq-planner-items-list {
                        flex: 1;
                        min-height: 0;
                        overflow: auto;
                        padding: 0;
                        background: #fff;
                        border-radius: 8px;
                        border: 1px solid #e0e0e0;
                        margin-bottom: 0;
                    }
                    /* Table styles - matching MAIN style */
                    .planner-items-table {
                        width: 100%;
                        border-collapse: collapse;
                        font-size: 14px;
                    }
                    .planner-items-table thead {
                        position: sticky;
                        top: 0;
                        z-index: 10;
                    }
                    .planner-items-table thead th {
                        background: #f8f9fa;
                        border: 1px solid #dee2e6;
                        border-top: none;
                        border-left: none;
                        padding: 12px 14px;
                        font-size: 13px;
                        font-weight: 700;
                        color: #495057;
                        text-align: left;
                        white-space: nowrap;
                    }
                    .planner-items-table thead th:first-child {
                        border-left: none;
                    }
                    .planner-items-table thead th:last-child {
                        border-right: none;
                    }
                    .planner-items-table tbody td {
                        border: 1px solid #e9ecef;
                        border-left: none;
                        border-right: none;
                        padding: 14px;
                        font-size: 14px;
                        color: #212529;
                        vertical-align: middle;
                    }
                    .planner-items-table tbody tr {
                        transition: background-color 0.15s ease;
                    }
                    .planner-items-table tbody tr:hover {
                        background-color: #f1f3f5;
                    }
                    .planner-items-table tbody tr:nth-child(even) {
                        background-color: #fafbfc;
                    }
                    .planner-items-table tbody tr:nth-child(even):hover {
                        background-color: #f1f3f5;
                    }
                    .planner-items-table tbody tr.selected {
                        background: #e3f2fd !important;
                    }
                    .planner-items-table input[type="checkbox"] {
                        width: 16px;
                        height: 16px;
                        cursor: pointer;
                    }
                    .planner-item-link {
                        color: #007AFF;
                        text-decoration: none;
                        font-weight: 600;
                    }
                    .planner-item-link:hover {
                        text-decoration: underline;
                    }
                    .status-badge {
                        display: inline-flex;
                        align-items: center;
                        gap: 4px;
                        font-size: 10px;
                        padding: 3px 8px;
                        border-radius: 12px;
                        white-space: nowrap;
                    }
                    .status-badge.status-planned {
                        background: #f5f5f5;
                        color: #666;
                    }
                    .status-badge.status-sent {
                        background: #e3f2fd;
                        color: #1565c0;
                    }
                    .status-badge.status-missing {
                        background: #fff3e0;
                        color: #e65100;
                    }
                    .status-badge.status-quoted {
                        background: #e8f5e9;
                        color: #2e7d32;
                    }
                    .status-badge.status-done {
                        background: #e0f7fa;
                        color: #00838f;
                    }
                    .planner-item-action-btn {
                        background: none;
                        border: none;
                        font-size: 16px;
                        cursor: pointer;
                        padding: 4px 8px;
                        border-radius: 4px;
                        color: #888;
                    }
                    .planner-item-action-btn:hover {
                        background: #e0e0e0;
                    }
                    /* Resizable columns */
                    .planner-items-table th {
                        position: relative;
                        user-select: none;
                    }
                    .planner-items-table .col-resize-handle {
                        position: absolute;
                        right: 0;
                        top: 0;
                        bottom: 0;
                        width: 6px;
                        cursor: col-resize;
                        background: transparent;
                        transition: background 0.15s;
                        z-index: 10;
                    }
                    .planner-items-table .col-resize-handle:hover,
                    .planner-items-table .col-resize-handle.resizing {
                        background: rgba(0, 122, 255, 0.4);
                    }
                    .planner-items-table.resizing {
                        cursor: col-resize;
                        user-select: none;
                    }
                    .planner-items-table.resizing * {
                        cursor: col-resize !important;
                    }
                    .rfq-planner-footer {
                        display: flex !important;
                        justify-content: space-between;
                        align-items: center;
                        padding: 14px 20px;
                        background: linear-gradient(to bottom, #f0f2f5, #e8eaed);
                        border-top: 2px solid #007AFF;
                        font-size: 13px;
                        flex-shrink: 0;
                        min-height: 56px;
                        box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
                    }
                    .rfq-planner-footer-left {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    }
                    .rfq-planner-footer-left span {
                        font-weight: 700;
                        color: #007AFF;
                        font-size: 14px;
                    }
                    .rfq-planner-footer-actions {
                        display: flex;
                        gap: 10px;
                    }
                    .rfq-planner-footer-actions button {
                        padding: 8px 16px;
                        font-size: 13px;
                        font-weight: 600;
                    }

                    /* Planner Item Row */
                    .planner-item-row {
                        display: grid;
                        grid-template-columns: 36px 1fr 80px 100px 90px;
                        gap: 12px;
                        align-items: center;
                        padding: 12px 0;
                        border-bottom: 1px solid #f0f0f0;
                    }
                    .planner-item-row:last-child {
                        border-bottom: none;
                    }
                    .planner-item-row input[type="checkbox"] {
                        width: 18px;
                        height: 18px;
                        accent-color: #4361ee;
                    }
                    .planner-item-info {
                        overflow: hidden;
                    }
                    .planner-item-dn {
                        font-size: 13px;
                        font-weight: 600;
                        color: #333;
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }
                    .planner-item-link {
                        color: #4361ee;
                        text-decoration: none;
                    }
                    .planner-item-link:hover {
                        text-decoration: underline;
                    }
                    .planner-item-desc {
                        font-size: 11px;
                        color: #888;
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }
                    .planner-item-qty {
                        font-size: 13px;
                        font-weight: 600;
                        color: #4361ee;
                        text-align: right;
                    }
                    .planner-item-price {
                        font-size: 13px;
                        color: #555;
                        text-align: right;
                    }
                    .planner-item-price.no-price {
                        color: #e67700;
                        font-style: italic;
                    }
                    .planner-item-status {
                        font-size: 11px;
                        padding: 4px 10px;
                        border-radius: 4px;
                        text-align: center;
                    }
                    .planner-item-status.needs {
                        background: #fff3cd;
                        color: #856404;
                    }
                    .planner-item-status.quoted {
                        background: #d4edda;
                        color: #155724;
                    }

                    .planner-empty-state {
                        text-align: center;
                        padding: 60px 20px;
                        color: #888;
                    }
                    .planner-empty-state-icon {
                        font-size: 48px;
                        margin-bottom: 16px;
                    }
                    .planner-empty-state-title {
                        font-size: 18px;
                        font-weight: 600;
                        color: #555;
                        margin-bottom: 8px;
                    }

                    /* RFQ Detail Modal styles */
                    .rfq-detail-info {
                        padding: 16px 24px;
                        background: #f8fafc;
                        border-bottom: 1px solid #e0e0e0;
                    }
                    .rfq-detail-info-grid {
                        display: grid;
                        grid-template-columns: repeat(4, 1fr);
                        gap: 16px;
                    }
                    .rfq-detail-table-wrap {
                        padding: 16px 24px;
                        overflow-x: auto;
                        max-height: 400px;
                        overflow-y: auto;
                    }
                    .rfq-prices-table {
                        width: 100%;
                        border-collapse: collapse;
                        font-size: 13px;
                    }
                    .rfq-prices-table th {
                        background: #f8fafc;
                        padding: 10px 12px;
                        text-align: left;
                        font-weight: 600;
                        color: #555;
                        border-bottom: 2px solid #e0e0e0;
                        position: sticky;
                        top: 0;
                    }
                    .rfq-prices-table td {
                        padding: 10px 12px;
                        border-bottom: 1px solid #f0f0f0;
                        vertical-align: middle;
                    }
                    .rfq-prices-table tbody tr:hover {
                        background: #f8fafc;
                    }
                    .rfq-prices-table input[type="number"],
                    .rfq-prices-table input[type="text"] {
                        width: 100%;
                        padding: 6px 8px;
                        border: 1px solid #ddd;
                        border-radius: 4px;
                        font-size: 13px;
                    }
                    .rfq-prices-table input[type="number"]:focus,
                    .rfq-prices-table input[type="text"]:focus {
                        outline: none;
                        border-color: #4361ee;
                    }
                    .rfq-prices-table tfoot td {
                        background: #f8fafc;
                        font-weight: 600;
                        border-top: 2px solid #e0e0e0;
                    }

                    @media print {
                        body * {
                            visibility: hidden;
                        }
                        #view-dashboard, #view-dashboard * {
                            visibility: visible;
                        }
                        #view-dashboard {
                            position: absolute;
                            left: 0;
                            top: 0;
                            width: 100%;
                            height: 100%;
                            margin: 0;
                            padding: 20px;
                            background: white;
                            z-index: 9999;
                            overflow: visible !important;
                            display: block !important;
                        }
                        .stat-card {
                            border: 1px solid #ccc;
                            box-shadow: none;
                            break-inside: avoid;
                        }
                        .chart-container {
                            break-inside: avoid;
                            page-break-inside: avoid;
                        }
                        /* Hide buttons inside dashboard when printing */
                        #view-dashboard button, .btn-export-dashboard {
                            display: none !important;
                        }
                    }

                    /* ====== Supplier Selection Tab Styles ====== */
                    .supplier-selection-container {
                        display: flex;
                        flex-direction: column;
                        height: 100%;
                        overflow: hidden;
                        padding: 16px;
                        gap: 16px;
                    }
                    .supplier-selection-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        flex-shrink: 0;
                        padding-bottom: 12px;
                        border-bottom: 1px solid #e5e7eb;
                    }
                    .supplier-selection-title h2 {
                        margin: 0 0 4px 0;
                        font-size: 20px;
                        font-weight: 700;
                        color: #1f2937;
                    }
                    .supplier-selection-actions {
                        display: flex;
                        gap: 8px;
                    }
                    .supplier-selection-layout {
                        display: grid;
                        grid-template-columns: 250px 1fr 300px;
                        gap: 16px;
                        flex: 1;
                        min-height: 0;
                        overflow: hidden;
                    }
                    .ss-panel {
                        display: flex;
                        flex-direction: column;
                        background: white;
                        border: 1px solid #e5e7eb;
                        border-radius: 12px;
                        overflow: hidden;
                    }
                    .ss-panel-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px 16px;
                        background: #f9fafb;
                        border-bottom: 1px solid #e5e7eb;
                    }
                    .ss-panel-header h3 {
                        margin: 0;
                        font-size: 14px;
                        font-weight: 700;
                        color: #374151;
                    }
                    .ss-panel-search {
                        padding: 12px;
                        border-bottom: 1px solid #e5e7eb;
                    }
                    .ss-panel-list {
                        flex: 1;
                        overflow-y: auto;
                        padding: 8px;
                    }
                    .ss-supplier-card {
                        padding: 10px 12px;
                        border: 1px solid #e5e7eb;
                        border-radius: 8px;
                        margin-bottom: 6px;
                        cursor: pointer;
                        transition: all 0.15s ease;
                    }
                    .ss-supplier-card:hover {
                        border-color: #10b981;
                        background: #ecfdf5;
                    }
                    .ss-supplier-card.selected {
                        border-color: #10b981;
                        background: #d1fae5;
                        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3);
                    }
                    .ss-supplier-name {
                        font-weight: 600;
                        font-size: 13px;
                        color: #1f2937;
                    }
                    .ss-supplier-info {
                        font-size: 11px;
                        color: #6b7280;
                        margin-top: 4px;
                    }
                    .ss-selected-suppliers {
                        padding: 8px;
                        border-bottom: 1px solid #e5e7eb;
                        display: flex;
                        flex-wrap: wrap;
                        gap: 6px;
                        max-height: 100px;
                        overflow-y: auto;
                        background: #f0fdf4;
                    }
                    .ss-selected-chip {
                        display: inline-flex;
                        align-items: center;
                        gap: 6px;
                        padding: 4px 8px 4px 10px;
                        background: #10b981;
                        color: white;
                        border-radius: 16px;
                        font-size: 11px;
                        font-weight: 500;
                    }
                    .ss-selected-chip .ss-chip-remove {
                        width: 16px;
                        height: 16px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        background: rgba(255,255,255,0.3);
                        border-radius: 50%;
                        cursor: pointer;
                        font-size: 10px;
                    }
                    .ss-selected-chip .ss-chip-remove:hover {
                        background: rgba(255,255,255,0.5);
                    }
                    .ss-pick-item {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        padding: 10px 12px;
                        border-bottom: 1px solid #f3f4f6;
                        cursor: pointer;
                        transition: background 0.15s;
                    }
                    .ss-pick-item:hover {
                        background: #f9fafb;
                    }
                    .ss-pick-item.selected {
                        background: #ecfdf5;
                    }
                    .ss-pick-item input[type="checkbox"] {
                        width: 16px;
                        height: 16px;
                        accent-color: #10b981;
                    }
                    .ss-result-stat {
                        text-align: center;
                        padding: 16px;
                        background: #f9fafb;
                        border-radius: 8px;
                    }
                    .ss-result-stat-value {
                        font-size: 28px;
                        font-weight: 700;
                        color: #10b981;
                    }
                    .ss-result-stat-label {
                        font-size: 11px;
                        color: #6b7280;
                        margin-top: 4px;
                    }
                    .ss-result-stat.warning .ss-result-stat-value {
                        color: #f59e0b;
                    }
                    .ss-result-stat.success {
                        background: #d1fae5;
                    }
                    .ss-result-stat.success .ss-result-stat-value {
                        color: #059669;
                    }
                    .ss-result-detail-item {
                        display: flex;
                        justify-content: space-between;
                        padding: 8px 12px;
                        border-bottom: 1px solid #f3f4f6;
                        font-size: 12px;
                    }
                    .ss-result-detail-item:last-child {
                        border-bottom: none;
                    }
                    .ss-panel-filters {
                        display: flex;
                        gap: 8px;
                        padding: 12px;
                        border-bottom: 1px solid #e5e7eb;
                    }
                    .ss-items-table-wrapper {
                        flex: 1;
                        overflow: auto;
                    }
                    .ss-items-table {
                        width: 100%;
                        border-collapse: collapse;
                        font-size: 12px;
                    }
                    .ss-items-table th {
                        position: sticky;
                        top: 0;
                        background: #f9fafb;
                        padding: 10px 12px;
                        text-align: left;
                        font-weight: 600;
                        color: #374151;
                        border-bottom: 1px solid #e5e7eb;
                        z-index: 1;
                        user-select: none;
                        white-space: nowrap;
                    }
                    .ss-items-table th[data-sort-col]:hover {
                        background: #f3f4f6;
                    }
                    .ss-sort-indicator {
                        display: inline-block;
                        margin-left: 4px;
                        font-size: 10px;
                        color: #3b82f6;
                    }
                    .ss-items-table td {
                        padding: 10px 12px;
                        border-bottom: 1px solid #f3f4f6;
                        vertical-align: middle;
                    }
                    .ss-items-table tr:hover {
                        background: #f9fafb;
                    }
                    .ss-items-table tr.selected {
                        background: #eff6ff;
                    }
                    .ss-items-footer {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px 16px;
                        background: #f9fafb;
                        border-top: 1px solid #e5e7eb;
                    }
                    .ss-preview-content {
                        flex: 1;
                        overflow-y: auto;
                        padding: 16px;
                    }
                    .ss-preview-empty {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        height: 100%;
                        text-align: center;
                    }
                    .ss-preview-actions {
                        padding: 12px 16px;
                        background: #f9fafb;
                        border-top: 1px solid #e5e7eb;
                    }
                    .ss-preview-item {
                        padding: 8px 12px;
                        background: #f3f4f6;
                        border-radius: 6px;
                        margin-bottom: 6px;
                        font-size: 12px;
                    }
                    .ss-preview-item .drawing-no {
                        font-weight: 600;
                        color: #1f2937;
                    }
                    .ss-preview-item .desc {
                        color: #6b7280;
                        margin-top: 2px;
                    }
                    .ss-import-dropzone {
                        border: 2px dashed #d1d5db;
                        border-radius: 12px;
                        padding: 40px 20px;
                        text-align: center;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    }
                    .ss-import-dropzone:hover {
                        border-color: #3b82f6;
                        background: #eff6ff;
                    }
                    .ss-import-dropzone.dragover {
                        border-color: #3b82f6;
                        background: #dbeafe;
                    }
                    .ss-import-preview {
                        margin-top: 20px;
                    }
                    .ss-import-preview-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px;
                        background: #f3f4f6;
                        border-radius: 8px 8px 0 0;
                        font-weight: 600;
                    }
                    .ss-import-preview-stats {
                        display: flex;
                        gap: 16px;
                        padding: 16px;
                        background: #f9fafb;
                        border: 1px solid #e5e7eb;
                        border-top: none;
                    }
                    .ss-import-stat {
                        text-align: center;
                    }
                    .ss-import-stat-value {
                        display: block;
                        font-size: 24px;
                        font-weight: 700;
                        color: #3b82f6;
                    }
                    .ss-import-stat-label {
                        font-size: 11px;
                        color: #6b7280;
                    }
                    .ss-import-preview-table-wrap {
                        max-height: 300px;
                        overflow: auto;
                        border: 1px solid #e5e7eb;
                        border-top: none;
                        border-radius: 0 0 8px 8px;
                    }
                    .ss-import-preview-table {
                        width: 100%;
                        border-collapse: collapse;
                        font-size: 12px;
                    }
                    .ss-import-preview-table th {
                        position: sticky;
                        top: 0;
                        background: #f3f4f6;
                        padding: 8px 12px;
                        text-align: left;
                        font-weight: 600;
                    }
                    .ss-import-preview-table td {
                        padding: 8px 12px;
                        border-bottom: 1px solid #f3f4f6;
                    }
                    .ss-import-preview-table tr.matched {
                        background: #ecfdf5;
                    }
                    .ss-import-preview-table tr.unmatched {
                        background: #fef2f2;
                    }
                    .ss-supplier-badge {
                        display: inline-block;
                        padding: 2px 8px;
                        background: #e5e7eb;
                        border-radius: 12px;
                        font-size: 11px;
                        margin: 2px;
                    }
                    .ss-supplier-badge.new {
                        background: #dbeafe;
                        color: #1d4ed8;
                    }
                    .ss-items-actions {
                        display: flex;
                        gap: 6px;
                    }
                    .rfq-btn-mini {
                        padding: 4px 10px;
                        font-size: 11px;
                        border-radius: 6px;
                        border: 1px solid #d1d5db;
                        background: white;
                        color: #374151;
                        cursor: pointer;
                        transition: all 0.15s ease;
                    }
                    .rfq-btn-mini:hover {
                        background: #f3f4f6;
                        border-color: #9ca3af;
                    }
                    .rfq-btn-success {
                        background: #10b981;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: background 0.15s ease;
                    }
                    .rfq-btn-success:hover {
                        background: #059669;
                    }
                    .rfq-btn-success:disabled {
                        background: #d1d5db;
                        cursor: not-allowed;
                    }
                    .rfq-btn-warning {
                        background: linear-gradient(135deg, #f59e0b, #d97706);
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.2s;
                    }
                    .rfq-btn-warning:hover { background: linear-gradient(135deg, #d97706, #b45309); }
                    .rfq-btn-warning:disabled { background: #d1d5db; cursor: not-allowed; }

                    /* ====== FINAL SUMMARY STYLES ====== */
                    .final-summary-container {
                        display: flex;
                        flex-direction: column;
                        flex: 1;
                        min-height: 0;
                        background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%);
                    }
                    .final-summary-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 20px 24px;
                        background: linear-gradient(135deg, #1e293b, #334155);
                        color: white;
                    }
                    .final-summary-title h2 {
                        margin: 0;
                        font-size: 24px;
                        font-weight: 800;
                        color: #fbbf24;
                    }
                    .final-summary-layout {
                        display: flex;
                        flex: 1;
                        gap: 20px;
                        padding: 20px;
                        min-height: 0;
                        overflow: auto;
                    }
                    .fs-main-panel {
                        flex: 1;
                        min-width: 0;
                        display: flex;
                        flex-direction: column;
                        gap: 16px;
                        min-height: 0;
                        overflow-y: auto;
                    }
                    .fs-side-panel {
                        width: 320px;
                        min-width: 320px;
                        flex-shrink: 0;
                        display: flex;
                        flex-direction: column;
                        gap: 12px;
                        overflow-y: auto;
                        max-height: calc(100vh - 200px);
                    }
                    .fs-section {
                        background: white;
                        border-radius: 12px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                        border: 1px solid #e2e8f0;
                    }
                    .fs-section-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 14px 18px;
                        background: linear-gradient(135deg, #f8fafc, #f1f5f9);
                        border-bottom: 1px solid #e2e8f0;
                        border-radius: 12px 12px 0 0;
                    }
                    .fs-section-header h3 {
                        margin: 0;
                        font-size: 15px;
                        font-weight: 700;
                        color: #1e293b;
                    }
                    .fs-section-badge {
                        background: #3b82f6;
                        color: white;
                        padding: 4px 10px;
                        border-radius: 12px;
                        font-size: 11px;
                        font-weight: 600;
                    }
                    .fs-section-content {
                        padding: 16px;
                    }
                    .fs-card {
                        background: white;
                        border-radius: 12px;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.06);
                        border: 1px solid #e2e8f0;
                        overflow: hidden;
                    }
                    .fs-card-title {
                        font-size: 13px;
                        font-weight: 700;
                        color: #1e293b;
                        padding: 12px 14px;
                        background: linear-gradient(135deg, #f8fafc, #f1f5f9);
                        border-bottom: 1px solid #e2e8f0;
                    }
                    .fs-card-content {
                        padding: 14px;
                    }
                    .fs-stats-grid {
                        display: grid;
                        grid-template-columns: repeat(3, 1fr);
                        gap: 10px;
                    }
                    .fs-stat {
                        text-align: center;
                        padding: 10px;
                        background: #f8fafc;
                        border-radius: 8px;
                    }
                    .fs-stat:last-child {
                        grid-column: span 3;
                        background: linear-gradient(135deg, #dcfce7, #bbf7d0);
                    }
                    .fs-stat-value {
                        font-size: 20px;
                        font-weight: 800;
                        color: #1e293b;
                    }
                    .fs-stat-value-large {
                        font-size: 24px;
                        color: #16a34a;
                    }
                    .fs-stat-label {
                        font-size: 10px;
                        color: #64748b;
                        text-transform: uppercase;
                        margin-top: 2px;
                    }
                    .fs-items-table-wrap {
                        max-height: 400px;
                        overflow: auto;
                        border: 1px solid #e2e8f0;
                        border-radius: 8px;
                        margin: 16px;
                    }
                    .fs-items-table {
                        width: 100%;
                        border-collapse: collapse;
                        font-size: 10px;
                        min-width: 1200px;
                    }
                    .fs-items-table th {
                        background: linear-gradient(135deg, #1e293b, #334155);
                        color: white;
                        padding: 6px 6px;
                        text-align: left;
                        font-weight: 600;
                        font-size: 9px;
                        position: sticky;
                        top: 0;
                        border-bottom: 2px solid #e2e8f0;
                        white-space: nowrap;
                        z-index: 1;
                    }
                    .fs-items-table td {
                        padding: 6px 6px;
                        border-bottom: 1px solid #f1f5f9;
                    }
                    .fs-items-table tr:hover {
                        background: #f8fafc;
                    }
                    .fs-items-table tr.challenged {
                        background: #fef3c7;
                    }
                    .fs-items-table tr.awarded {
                        background: #dcfce7;
                    }
                    .fs-supplier-card {
                        background: linear-gradient(135deg, #f0fdf4, #dcfce7);
                        border: 2px solid #22c55e;
                        border-radius: 12px;
                        padding: 16px;
                        margin-bottom: 12px;
                    }
                    .fs-supplier-card-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 12px;
                    }
                    .fs-supplier-name {
                        font-size: 16px;
                        font-weight: 700;
                        color: #166534;
                    }
                    .fs-supplier-value {
                        font-size: 18px;
                        font-weight: 800;
                        color: #16a34a;
                    }
                    .fs-supplier-items {
                        font-size: 11px;
                        color: #64748b;
                        max-height: 120px;
                        overflow-y: auto;
                    }
                    .fs-supplier-item {
                        display: flex;
                        justify-content: space-between;
                        padding: 6px 8px;
                        background: rgba(255,255,255,0.7);
                        border-radius: 6px;
                        margin-bottom: 4px;
                    }
                    .fs-doc-list {
                        display: flex;
                        flex-direction: column;
                        gap: 8px;
                    }
                    .fs-doc-item {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        padding: 10px 12px;
                        background: #f8fafc;
                        border-radius: 8px;
                        border: 1px solid #e2e8f0;
                    }
                    .fs-doc-icon {
                        font-size: 20px;
                    }
                    .fs-doc-info {
                        flex: 1;
                    }
                    .fs-doc-name {
                        font-weight: 600;
                        font-size: 12px;
                        color: #1e293b;
                    }
                    .fs-doc-desc {
                        font-size: 10px;
                        color: #64748b;
                    }
                    .fs-doc-btn {
                        padding: 6px 12px;
                        font-size: 11px;
                        font-weight: 600;
                        border: 1px solid #3b82f6;
                        background: white;
                        color: #3b82f6;
                        border-radius: 6px;
                        cursor: pointer;
                        transition: all 0.2s;
                    }
                    .fs-doc-btn:hover {
                        background: #3b82f6;
                        color: white;
                    }
                    .fs-challenge-btn {
                        padding: 4px 8px;
                        font-size: 10px;
                        font-weight: 600;
                        background: linear-gradient(135deg, #f59e0b, #d97706);
                        color: white;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                    }
                    .fs-challenge-btn:hover {
                        background: linear-gradient(135deg, #d97706, #b45309);
                    }
                    .fs-response-btn {
                        padding: 4px 8px;
                        font-size: 10px;
                        font-weight: 600;
                        background: #22c55e;
                        color: white;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                    }
                    .fs-toolbar-btn {
                        padding: 6px 12px;
                        font-size: 11px;
                        font-weight: 600;
                        background: white;
                        border: 1px solid #d1d5db;
                        border-radius: 6px;
                        cursor: pointer;
                        transition: all 0.2s;
                        color: #374151;
                    }
                    .fs-toolbar-btn:hover {
                        background: #3b82f6;
                        color: white;
                        border-color: #3b82f6;
                    }
                    .fs-status-badge {
                        padding: 3px 8px;
                        border-radius: 10px;
                        font-size: 10px;
                        font-weight: 600;
                    }
                    .fs-status-awarded { background: #dcfce7; color: #166534; }
                    .fs-status-challenged { background: #fef3c7; color: #92400e; }
                    .fs-status-pending { background: #e0e7ff; color: #4338ca; }
                    .fs-status-updated { background: #dbeafe; color: #1d4ed8; }
                    .fs-upload-zone {
                        border: 2px dashed #d1d5db;
                        border-radius: 8px;
                        padding: 20px;
                        text-align: center;
                        cursor: pointer;
                        transition: all 0.2s;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        gap: 4px;
                    }
                    .fs-upload-zone:hover {
                        border-color: #3b82f6;
                        background: #eff6ff;
                    }
                    .fs-doc-tracking-item {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        padding: 10px;
                        background: #f8fafc;
                        border-radius: 8px;
                        margin-bottom: 8px;
                        border-left: 3px solid #3b82f6;
                    }
                    .fs-doc-tracking-item.overdue {
                        border-left-color: #ef4444;
                        background: #fef2f2;
                    }
                    .fs-doc-tracking-item.completed {
                        border-left-color: #22c55e;
                        background: #f0fdf4;
                    }
                    .fs-non-awarded-item {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 8px 10px;
                        background: #fef2f2;
                        border-radius: 6px;
                        margin-bottom: 6px;
                        border-left: 3px solid #ef4444;
                    }
                    .fs-challenge-info {
                        background: #f8fafc;
                        padding: 14px;
                        border-radius: 8px;
                        margin-bottom: 16px;
                    }
                    .fs-challenge-form .rfq-form-group {
                        margin-bottom: 14px;
                    }
                    .fs-challenge-form .rfq-form-group label {
                        display: block;
                        font-size: 12px;
                        font-weight: 600;
                        color: #475569;
                        margin-bottom: 6px;
                    }

                    /* ====== FINAL SUMMARY 3-COLUMN LAYOUT ====== */
                    .fs-3col-layout {
                        display: grid;
                        grid-template-columns: 280px 1fr 320px;
                        gap: 0;
                        height: calc(100vh - 120px);
                        background: #f8fafc;
                        border-radius: 12px;
                        margin: 8px;
                        border: 1px solid #e0e0e0;
                        overflow: hidden;
                    }

                    /* LEFT SIDEBAR */
                    .fs-left-sidebar {
                        background: #f8fafc;
                        border-right: 1px solid #e0e0e0;
                        display: flex;
                        flex-direction: column;
                        min-height: 0;
                        overflow: hidden;
                    }
                    .fs-sidebar-header {
                        padding: 16px 16px 12px;
                        background: linear-gradient(135deg, #1e293b, #334155);
                        border-bottom: 1px solid #e0e0e0;
                    }
                    .fs-sidebar-header h3 {
                        font-size: 16px;
                        font-weight: 800;
                        color: #fbbf24;
                        margin: 0 0 6px 0;
                    }
                    .fs-sidebar-stats {
                        display: flex;
                        gap: 10px;
                    }
                    .fs-mini-stat {
                        font-size: 11px;
                        color: rgba(255,255,255,0.8);
                        background: rgba(255,255,255,0.1);
                        padding: 3px 8px;
                        border-radius: 10px;
                    }
                    .fs-mini-stat.awarded {
                        color: #4ade80;
                        background: rgba(34,197,94,0.2);
                    }
                    .fs-sidebar-search {
                        padding: 10px 12px;
                        border-bottom: 1px solid #e0e0e0;
                    }
                    .fs-sidebar-search input {
                        width: 100%;
                        padding: 8px 10px;
                        border: 1px solid #ddd;
                        border-radius: 6px;
                        font-size: 12px;
                    }
                    .fs-sidebar-section {
                        padding: 8px 0;
                    }
                    .fs-sidebar-section.non-awarded {
                        border-top: 1px solid #e0e0e0;
                        background: #fef2f2;
                    }
                    .fs-sidebar-section-title {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 8px 14px;
                        font-size: 12px;
                        font-weight: 700;
                        color: #475569;
                        cursor: pointer;
                    }
                    .fs-sidebar-section.non-awarded .fs-sidebar-section-title {
                        color: #991b1b;
                    }
                    .fs-count-badge {
                        background: #4361ee;
                        color: white;
                        padding: 2px 8px;
                        border-radius: 10px;
                        font-size: 11px;
                        font-weight: 600;
                    }
                    .fs-count-badge.secondary {
                        background: #ef4444;
                    }
                    .fs-suppliers-list {
                        flex: 1;
                        overflow-y: auto;
                        padding: 4px 8px;
                        max-height: 280px;
                    }
                    .fs-suppliers-list.collapsed {
                        display: none;
                    }
                    .fs-supplier-card-new {
                        padding: 10px 12px;
                        border-radius: 8px;
                        cursor: pointer;
                        margin-bottom: 4px;
                        transition: all 0.15s;
                        border: 1px solid transparent;
                        background: white;
                    }
                    .fs-supplier-card-new:hover {
                        border-color: #ddd;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                    }
                    .fs-supplier-card-new.active {
                        border-color: #4361ee;
                        background: #eff6ff;
                        box-shadow: 0 2px 8px rgba(67, 97, 238, 0.15);
                    }
                    .fs-supplier-card-new .name {
                        font-weight: 600;
                        font-size: 13px;
                        color: #333;
                        margin-bottom: 3px;
                    }
                    .fs-supplier-card-new .stats {
                        display: flex;
                        gap: 8px;
                        font-size: 10px;
                        color: #64748b;
                    }
                    .fs-supplier-card-new .stats .value {
                        color: #16a34a;
                        font-weight: 600;
                    }
                    .fs-non-awarded-card {
                        padding: 8px 12px;
                        border-radius: 6px;
                        cursor: pointer;
                        margin-bottom: 4px;
                        background: white;
                        border: 1px solid #fecaca;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }
                    .fs-non-awarded-card .name {
                        font-size: 12px;
                        color: #991b1b;
                    }
                    .fs-non-awarded-card .action-btn {
                        padding: 2px 8px;
                        font-size: 9px;
                        background: #fef2f2;
                        border: 1px solid #fecaca;
                        border-radius: 4px;
                        cursor: pointer;
                        color: #991b1b;
                    }
                    .fs-non-awarded-card .action-btn:hover {
                        background: #ef4444;
                        color: white;
                    }

                    /* MIDDLE PANEL */
                    .fs-middle-panel {
                        display: flex;
                        flex-direction: column;
                        min-height: 0;
                        overflow: hidden;
                        background: white;
                    }
                    .fs-middle-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 14px 20px;
                        border-bottom: 1px solid #e0e0e0;
                        background: #fafbfc;
                    }
                    .fs-middle-title h3 {
                        font-size: 15px;
                        font-weight: 700;
                        color: #1a1a2e;
                        margin: 0;
                    }
                    .fs-middle-subtitle {
                        font-size: 11px;
                        color: #64748b;
                    }
                    .fs-middle-actions {
                        display: flex;
                        gap: 8px;
                        align-items: center;
                    }
                    .fs-middle-filters {
                        display: flex;
                        gap: 6px;
                        padding: 10px 20px;
                        background: #f8f9fa;
                        border-bottom: 1px solid #eee;
                    }
                    .fs-filter-chip {
                        display: flex;
                        align-items: center;
                        gap: 4px;
                        padding: 5px 10px;
                        font-size: 11px;
                        color: #555;
                        background: white;
                        border: 1px solid #ddd;
                        border-radius: 16px;
                        cursor: pointer;
                        transition: all 0.15s;
                    }
                    .fs-filter-chip:hover {
                        border-color: #4361ee;
                    }
                    .fs-filter-chip.active {
                        background: #4361ee;
                        color: white;
                        border-color: #4361ee;
                    }
                    .fs-filter-chip input {
                        display: none;
                    }
                    .fs-items-list {
                        flex: 1;
                        overflow: auto;
                        padding: 0;
                    }
                    .fs-middle-footer {
                        display: flex;
                        align-items: center;
                        gap: 20px;
                        padding: 12px 20px;
                        background: linear-gradient(135deg, #f0fdf4, #dcfce7);
                        border-top: 1px solid #bbf7d0;
                    }
                    .fs-summary-stat {
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    }
                    .fs-summary-stat .label {
                        font-size: 11px;
                        color: #64748b;
                    }
                    .fs-summary-stat .value {
                        font-size: 14px;
                        font-weight: 700;
                        color: #1e293b;
                    }
                    .fs-summary-stat .value.highlight {
                        font-size: 18px;
                        color: #16a34a;
                    }
                    .fs-summary-actions {
                        margin-left: auto;
                        display: flex;
                        gap: 8px;
                    }
                    .fs-action-btn {
                        padding: 6px 12px;
                        font-size: 11px;
                        font-weight: 600;
                        background: white;
                        border: 1px solid #16a34a;
                        color: #16a34a;
                        border-radius: 6px;
                        cursor: pointer;
                    }
                    .fs-action-btn:hover {
                        background: #16a34a;
                        color: white;
                    }
                    .fs-action-btn.full-width {
                        width: 100%;
                        margin-top: 10px;
                    }

                    /* RIGHT SIDEBAR */
                    .fs-right-sidebar {
                        background: #f1f5f9;
                        border-left: 1px solid #e0e0e0;
                        display: flex;
                        flex-direction: column;
                        gap: 12px;
                        padding: 12px;
                        overflow-y: auto;
                        min-height: 0;
                    }
                    .fs-action-card {
                        background: white;
                        border-radius: 10px;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.06);
                        border: 1px solid #e2e8f0;
                        overflow: hidden;
                    }
                    .fs-action-card.highlight {
                        background: linear-gradient(135deg, #1e293b, #334155);
                        border: none;
                    }
                    .fs-action-card.challenge {
                        border-color: #fde68a;
                        background: #fffbeb;
                    }
                    .fs-action-card-header {
                        padding: 10px 14px;
                        font-size: 12px;
                        font-weight: 700;
                        color: #475569;
                        background: #f8fafc;
                        border-bottom: 1px solid #e2e8f0;
                        cursor: pointer;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }
                    .fs-action-card.highlight .fs-action-card-header {
                        background: transparent;
                        color: #fbbf24;
                        border-bottom: 1px solid rgba(255,255,255,0.1);
                    }
                    .fs-action-card.challenge .fs-action-card-header {
                        background: linear-gradient(135deg, #fef3c7, #fde68a);
                        color: #92400e;
                        border-bottom: 1px solid #fde68a;
                    }
                    .fs-action-card-header .toggle-icon {
                        font-size: 10px;
                    }
                    .fs-action-card-body {
                        padding: 12px;
                        overflow-y: auto;
                        max-height: 300px;
                    }
                    .fs-action-card-body.collapsed {
                        display: none;
                    }
                    .fs-big-value {
                        font-size: 28px;
                        font-weight: 800;
                        color: #4ade80;
                        text-align: center;
                        padding: 12px 0 4px;
                    }
                    .fs-challenged-badge {
                        text-align: center;
                        font-size: 11px;
                        color: #fbbf24;
                        padding-bottom: 12px;
                    }
                    .fs-action-buttons {
                        display: flex;
                        flex-wrap: wrap;
                        gap: 6px;
                        padding: 10px 12px;
                    }
                    .fs-toolbar-btn.primary {
                        background: #3b82f6;
                        color: white;
                        border-color: #3b82f6;
                    }
                    .fs-toolbar-btn.primary:hover {
                        background: #2563eb;
                    }

                </style>

                    </div>
                </div>

                <div id="project-picker" class="modal-overlay hidden" aria-hidden="true">
                    <div class="modal-card">
                        <div class="modal-header">
                            <div class="modal-title">Select Project</div>
                            <div class="modal-actions">
                                <button id="btn-close-project-picker" class="btn-secondary">Leave</button>
                                <button id="btn-project-picker-ok" class="btn-primary">OK</button>
                            </div>
                        </div>
                        <div class="modal-body">
                            <div id="project-picker-filters" style="display:flex; gap:12px; align-items:center; padding:12px; border-bottom:1px solid #e0e0e0; flex-wrap:wrap;">
                                <select id="project-picker-status-filter" style="padding:6px 12px; border:1px solid #ddd; border-radius:4px; font-size:12px;">
                                    <option value="all">All Status</option>
                                    <option value="open">Open (Active)</option>
                                    <option value="done">Done / Closed</option>
                                    <option value="Created">Created</option>
                                    <option value="RFQ Sent">RFQ Sent</option>
                                    <option value="Quote Received">Quote Received</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Won">Won</option>
                                    <option value="Lost">Lost</option>
                                    <option value="Closed">Closed</option>
                                </select>
                                <select id="project-picker-sort" style="padding:6px 12px; border:1px solid #ddd; border-radius:4px; font-size:12px;">
                                    <option value="name">Sort: Name A-Z</option>
                                    <option value="name-desc">Sort: Name Z-A</option>
                                    <option value="status-open">Sort: Open first</option>
                                    <option value="status-done">Sort: Done first</option>
                                    <option value="items">Sort: Most items</option>
                                    <option value="recent">Sort: Recently sent</option>
                                </select>
                                <input type="text" id="project-picker-search" placeholder="Search project..." style="padding:6px 12px; border:1px solid #ddd; border-radius:4px; font-size:12px; width:150px;">
                            </div>
                            <div id="sidebar-projects" class="sidebar-list project-picker-list"></div>
                        </div>
                        <div class="modal-footer">
                            <div id="menu-time" class="muted"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>
        `;
    },
    init: function (container) {
        const RFQ = window.RFQData || {};
        const FIELDS = Array.isArray(RFQ.FIELDS) ? RFQ.FIELDS : [];
        const CURRENCY_RATES = RFQ.CURRENCY_RATES && typeof RFQ.CURRENCY_RATES === 'object' ? RFQ.CURRENCY_RATES : { EUR: 1 };
        const getProjects = (typeof RFQ.getProjects === 'function') ? RFQ.getProjects : function () { return []; };
        const createProject = (typeof RFQ.createProject === 'function') ? RFQ.createProject : function () { showToast('RFQData not loaded: createProject', 'error'); return null; };
        const updateProject = (typeof RFQ.updateProject === 'function') ? RFQ.updateProject : function () { return false; };

        // State
        let projects = [];
        let currentProject = null;

        // =========================================================
        // Centralized Status Configuration
        // =========================================================
        // Note: These are now dynamic getters that read from localStorage config
        // Use getItemStatuses(), getBatchStatuses(), getSupplierQuoteStatuses() functions instead
        // Legacy constants kept for backwards compatibility but now call dynamic functions
        let _ITEM_STATUSES_CACHE = null;
        let _BATCH_STATUSES_CACHE = null;
        let _SUPPLIER_QUOTE_STATUSES_CACHE = null;

        // Refresh status caches - call this after changing status config
        function refreshStatusCaches() {
            _ITEM_STATUSES_CACHE = null;
            _BATCH_STATUSES_CACHE = null;
            _SUPPLIER_QUOTE_STATUSES_CACHE = null;
        }

        // Dynamic getters for status arrays
        Object.defineProperty(window, 'ITEM_STATUSES', {
            get: function () {
                if (!_ITEM_STATUSES_CACHE && typeof getItemStatuses === 'function') {
                    _ITEM_STATUSES_CACHE = getItemStatuses();
                }
                return _ITEM_STATUSES_CACHE || ['New', 'TO-QUOTE', 'RFQ TO BE SENT', 'RFQ Sent', 'Quote Received', 'Pending', 'RE-QUOTING', 'WITH ENG', 'WITH TEAM', 'Done', 'Won', 'Lost', 'Expired', 'OBSOLETE', 'Issue', 'Zru≈°itled'];
            }
        });

        Object.defineProperty(window, 'RFQ_BATCH_STATUSES', {
            get: function () {
                if (!_BATCH_STATUSES_CACHE && typeof getBatchStatuses === 'function') {
                    _BATCH_STATUSES_CACHE = getBatchStatuses();
                }
                return _BATCH_STATUSES_CACHE || ['Draft', 'Sent', 'Quote Received', 'Closed', 'Zru≈°itled'];
            }
        });

        Object.defineProperty(window, 'SUPPLIER_QUOTE_STATUSES', {
            get: function () {
                if (!_SUPPLIER_QUOTE_STATUSES_CACHE && typeof getSupplierQuoteStatuses === 'function') {
                    _SUPPLIER_QUOTE_STATUSES_CACHE = getSupplierQuoteStatuses();
                }
                return _SUPPLIER_QUOTE_STATUSES_CACHE || ['Pending', 'Active', 'Expired', 'Won', 'Lost', 'No Bid'];
            }
        });

        // Local aliases for use within the init function scope
        const ITEM_STATUSES_DEFAULT = ['New', 'TO-QUOTE', 'RFQ TO BE SENT', 'RFQ Sent', 'Quote Received', 'Pending', 'RE-QUOTING', 'WITH ENG', 'WITH TEAM', 'Done', 'Won', 'Lost', 'Expired', 'OBSOLETE', 'Issue', 'Zru≈°itled'];
        const RFQ_BATCH_STATUSES_DEFAULT = ['Draft', 'Sent', 'Quote Received', 'Closed', 'Zru≈°itled'];
        const SUPPLIER_QUOTE_STATUSES_DEFAULT = ['Pending', 'Active', 'Expired', 'Won', 'Lost', 'No Bid'];

        // Status categories for dashboard calculations - DYNAMIC from config
        // These are getter functions that build sets from current config
        function getDoneStatuses() {
            const config = getStatusConfig();
            return new Set(config.itemStatuses.filter(s => s.category === 'done').map(s => s.name));
        }
        function getInProgressStatuses() {
            const config = getStatusConfig();
            return new Set(config.itemStatuses.filter(s => s.category === 'in_progress').map(s => s.name));
        }
        function getIssueStatuses() {
            const config = getStatusConfig();
            return new Set(config.itemStatuses.filter(s => s.category === 'issue').map(s => s.name));
        }
        function getNewStatuses() {
            const config = getStatusConfig();
            return new Set(config.itemStatuses.filter(s => s.category === 'new').map(s => s.name));
        }
        // Get category for any status name
        // =========================================================
        // Status Configuration Storage System
        // =========================================================
        const STATUS_CONFIG_KEY = 'rfq_status_config_v1';

        function getStatusCategory(statusName) {
            if (!statusName) return 'new';
            const config = getStatusConfig();
            // Handle status with count like "Done (3)"
            const baseName = statusName.replace(/\s*\(\d+\)$/, '').trim();
            const statusObj = config.itemStatuses.find(s => s.name === baseName);

            // If we found the status in config and it has a category, use it
            if (statusObj && statusObj.category) {
                return statusObj.category;
            }

            // Fallback: determine category by status name (for old configs without category)
            const lowerName = baseName.toLowerCase();
            if (['done', 'won', 'lost', 'closed', 'obsolete', 'zru≈°itled', 'completed'].some(s => lowerName.includes(s))) {
                return 'done';
            }
            if (['issue', 'expired', 'error', 'problem'].some(s => lowerName.includes(s))) {
                return 'issue';
            }
            if (['new'].some(s => lowerName === s)) {
                return 'new';
            }
            // Default to in_progress for anything else (TO-QUOTE, RFQ Sent, etc.)
            if (baseName && baseName !== 'New') {
                return 'in_progress';
            }
            return 'new';
        }
        // Legacy compatibility - these are now computed dynamically
        let DONE_STATUSES = getDoneStatuses();
        let IN_PROGRESS_STATUSES = getInProgressStatuses();
        let ISSUE_STATUSES = getIssueStatuses();

        // Status colors (unified)
        const STATUS_COLORS = {
            'New': '#007AFF',        // Blue - new item
            'TO-QUOTE': '#00BCD4',   // Cyan - needs to be quoted
            'RFQ TO BE SENT': '#9C27B0', // Deep purple - RFQ prepared but not sent
            'RFQ Sent': '#5856D6',   // Purple - sent for quote
            'Quote Received': '#AF52DE', // Magenta - quote received
            'Pending': '#FF9500',    // Orange - waiting
            'RE-QUOTING': '#E91E63', // Pink - need to renegotiate (price above target)
            'WITH ENG': '#3F51B5',   // Indigo - with engineering team
            'WITH TEAM': '#009688',  // Teal - with team for review
            'Done': '#34C759',       // Green - completed
            'Won': '#30D158',        // Bright green - won
            'Lost': '#8e8e93',       // Gray - lost
            'Expired': '#FF3B30',    // Red - expired
            'OBSOLETE': '#795548',   // Brown - obsolete item
            'Issue': '#FF3B30',      // Red - has issue
            'Zru≈°itled': '#8e8e93',  // Gray - cancelled
            'Closed': '#34C759',     // Green - closed
            'Draft': '#007AFF',      // Blue - draft
            'Sent': '#5856D6',       // Purple - sent
            'Active': '#34C759',     // Green - active quote
            'No Bid': '#8e8e93',     // Gray - no bid
            'default': '#999'
        };

        function getStatusColorUnified(status, type = 'item') {
            // First try the dynamic config
            const config = getStatusConfig();
            let statuses;
            switch (type) {
                case 'batch': statuses = config.batchStatuses; break;
                case 'supplierQuote': statuses = config.supplierQuoteStatuses; break;
                case 'planner': statuses = config.plannerStatuses; break;
                case 'project': statuses = config.projectStatuses; break;
                default: statuses = config.itemStatuses;
            }
            // Handle statuses with count like "RFQ Sent (3)"
            const baseStatus = status ? status.replace(/\s*\(\d+\)$/, '').trim() : '';
            const found = statuses.find(s => s.name === status || s.name === baseStatus);
            if (found?.color) return found.color;
            // Fallback to static colors
            return STATUS_COLORS[status] || STATUS_COLORS[baseStatus] || STATUS_COLORS['default'];
        }

        // Calculate contrasting text color (black or white) based on background color
        function getContrastTextColor(hexColor) {
            if (!hexColor || hexColor === 'transparent') return '#000000';
            // Remove # if present
            const hex = hexColor.replace('#', '');
            // Parse RGB
            let r, g, b;
            if (hex.length === 3) {
                r = parseInt(hex[0] + hex[0], 16);
                g = parseInt(hex[1] + hex[1], 16);
                b = parseInt(hex[2] + hex[2], 16);
            } else {
                r = parseInt(hex.substring(0, 2), 16);
                g = parseInt(hex.substring(2, 4), 16);
                b = parseInt(hex.substring(4, 6), 16);
            }
            // Calculate luminance
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            // Return black for light backgrounds, white for dark backgrounds
            return luminance > 0.5 ? '#000000' : '#FFFFFF';
        }

        // Get row style based on item status (for table row coloring)
        function getItemRowStyle(item) {
            const status = getItemStatusDisplay(item);
            const bgColor = getStatusColorUnified(status, 'item');
            const textColor = getContrastTextColor(bgColor);
            // Use lighter version of color for background (30% opacity)
            return {
                backgroundColor: bgColor + '30', // 30% opacity
                color: textColor === '#FFFFFF' ? '#333' : textColor, // Use dark text on light bg
                borderLeft: `4px solid ${bgColor}`
            };
        }

        // =========================================================
        // Status Configuration Storage System
        // =========================================================


        function getDefaultStatusConfig() {
            return {
                itemStatuses: [
                    { id: 1, name: 'New', color: '#007AFF', sortOrder: 10, category: 'new' },
                    { id: 2, name: 'TO-QUOTE', color: '#00BCD4', sortOrder: 20, category: 'in_progress' },
                    { id: 3, name: 'RFQ TO BE SENT', color: '#9C27B0', sortOrder: 30, category: 'in_progress' },
                    { id: 4, name: 'RFQ Sent', color: '#5856D6', sortOrder: 40, category: 'in_progress' },
                    { id: 5, name: 'Quote Received', color: '#AF52DE', sortOrder: 50, category: 'in_progress' },
                    { id: 6, name: 'Pending', color: '#FF9500', sortOrder: 60, category: 'in_progress' },
                    { id: 7, name: 'RE-QUOTING', color: '#E91E63', sortOrder: 70, category: 'in_progress' },
                    { id: 8, name: 'WITH ENG', color: '#3F51B5', sortOrder: 80, category: 'in_progress' },
                    { id: 9, name: 'WITH TEAM', color: '#009688', sortOrder: 90, category: 'in_progress' },
                    { id: 10, name: 'Done', color: '#34C759', sortOrder: 100, category: 'done' },
                    { id: 11, name: 'Won', color: '#30D158', sortOrder: 110, category: 'done' },
                    { id: 12, name: 'Lost', color: '#8e8e93', sortOrder: 120, category: 'done' },
                    { id: 13, name: 'Expired', color: '#FF3B30', sortOrder: 130, category: 'issue' },
                    { id: 14, name: 'OBSOLETE', color: '#795548', sortOrder: 140, category: 'done' },
                    { id: 15, name: 'Issue', color: '#FF3B30', sortOrder: 150, category: 'issue' },
                    { id: 16, name: 'Zru≈°itled', color: '#8e8e93', sortOrder: 160, category: 'done' }
                ],
                batchStatuses: [
                    { id: 101, name: 'Draft', color: '#007AFF', sortOrder: 10 },
                    { id: 102, name: 'Sent', color: '#5856D6', sortOrder: 20 },
                    { id: 103, name: 'Quote Received', color: '#AF52DE', sortOrder: 30 },
                    { id: 104, name: 'Closed', color: '#34C759', sortOrder: 40 },
                    { id: 105, name: 'Zru≈°itled', color: '#8e8e93', sortOrder: 50 }
                ],
                supplierQuoteStatuses: [
                    { id: 201, name: 'Pending', color: '#FF9500', sortOrder: 10 },
                    { id: 202, name: 'Active', color: '#34C759', sortOrder: 20 },
                    { id: 203, name: 'Expired', color: '#FF3B30', sortOrder: 30 },
                    { id: 204, name: 'Won', color: '#30D158', sortOrder: 40 },
                    { id: 205, name: 'Lost', color: '#8e8e93', sortOrder: 50 },
                    { id: 206, name: 'No Bid', color: '#8e8e93', sortOrder: 60 }
                ],
                plannerStatuses: [
                    { id: 301, name: 'Planned', color: '#007AFF', icon: 'üìã', sortOrder: 10 },
                    { id: 302, name: 'RFQ Sent', color: '#5856D6', icon: 'üì§', sortOrder: 20 },
                    { id: 303, name: 'Missing Info', color: '#FF9500', icon: '‚ùì', sortOrder: 30 },
                    { id: 304, name: 'Quoted', color: '#AF52DE', icon: 'üí∞', sortOrder: 40 },
                    { id: 305, name: 'Done', color: '#34C759', icon: '‚úÖ', sortOrder: 50 }
                ],
                projectStatuses: [
                    { id: 401, name: 'Reopen', color: '#dc3545', sortOrder: 5, category: 'priority' },
                    { id: 402, name: 'Created', color: '#6c757d', sortOrder: 10, category: 'new' },
                    { id: 403, name: 'In process', color: '#007bff', sortOrder: 20, category: 'in_progress' },
                    { id: 404, name: 'Done', color: '#28a745', sortOrder: 100, category: 'done' }
                ],
                statusCategories: {
                    'priority': { sortOrder: 0 },
                    'new': { sortOrder: 1 },
                    'in_progress': { sortOrder: 2 },
                    'issue': { sortOrder: 2 },
                    'done': { sortOrder: 3 }
                }
            };
        }

        function getStatusConfig() {
            try {
                const stored = localStorage.getItem(STATUS_CONFIG_KEY);
                if (stored) {
                    const parsed = JSON.parse(stored);
                    const defaults = getDefaultStatusConfig();

                    // Helper to merge status arrays - adds missing category from defaults
                    const mergeStatuses = (parsedArr, defaultArr) => {
                        if (!Array.isArray(parsedArr)) return defaultArr;
                        return parsedArr.map(status => {
                            if (!status.category) {
                                // Find matching default status by name or id
                                const defaultMatch = defaultArr.find(d =>
                                    d.name === status.name || d.id === status.id
                                );
                                if (defaultMatch && defaultMatch.category) {
                                    return { ...status, category: defaultMatch.category };
                                }
                            }
                            return status;
                        });
                    };

                    return {
                        itemStatuses: mergeStatuses(parsed.itemStatuses, defaults.itemStatuses),
                        batchStatuses: parsed.batchStatuses || defaults.batchStatuses,
                        supplierQuoteStatuses: parsed.supplierQuoteStatuses || defaults.supplierQuoteStatuses,
                        plannerStatuses: parsed.plannerStatuses || defaults.plannerStatuses,
                        projectStatuses: mergeStatuses(parsed.projectStatuses, defaults.projectStatuses),
                        statusCategories: parsed.statusCategories || defaults.statusCategories
                    };
                }
            } catch (e) {
                console.warn('Error loading status config:', e);
            }
            return getDefaultStatusConfig();
        }

        function saveStatusConfig(config) {
            try {
                localStorage.setItem(STATUS_CONFIG_KEY, JSON.stringify(config));
                return true;
            } catch (e) {
                console.error('Error saving status config:', e);
                return false;
            }
        }

        // Status retrieval functions (returns arrays of names for backwards compatibility)
        function getItemStatuses() {
            const config = getStatusConfig();
            return config.itemStatuses
                .slice()
                .sort((a, b) => a.sortOrder - b.sortOrder)
                .map(s => s.name);
        }

        function getBatchStatuses() {
            const config = getStatusConfig();
            return config.batchStatuses
                .slice()
                .sort((a, b) => a.sortOrder - b.sortOrder)
                .map(s => s.name);
        }

        function getSupplierQuoteStatuses() {
            const config = getStatusConfig();
            return config.supplierQuoteStatuses
                .slice()
                .sort((a, b) => a.sortOrder - b.sortOrder)
                .map(s => s.name);
        }

        function getPlannerStatuses() {
            const config = getStatusConfig();
            return config.plannerStatuses
                .slice()
                .sort((a, b) => a.sortOrder - b.sortOrder)
                .map(s => s.name);
        }

        function getProjectStatuses() {
            const config = getStatusConfig();
            return config.projectStatuses
                .slice()
                .sort((a, b) => a.sortOrder - b.sortOrder)
                .map(s => s.name);
        }

        // Status lookup functions
        function getStatusById(type, id) {
            const config = getStatusConfig();
            let statuses;
            switch (type) {
                case 'item': statuses = config.itemStatuses; break;
                case 'batch': statuses = config.batchStatuses; break;
                case 'supplierQuote': statuses = config.supplierQuoteStatuses; break;
                case 'planner': statuses = config.plannerStatuses; break;
                case 'project': statuses = config.projectStatuses; break;
                default: return null;
            }
            return statuses.find(s => s.id === id) || null;
        }

        function getStatusByName(type, name) {
            const config = getStatusConfig();
            let statuses;
            switch (type) {
                case 'item': statuses = config.itemStatuses; break;
                case 'batch': statuses = config.batchStatuses; break;
                case 'supplierQuote': statuses = config.supplierQuoteStatuses; break;
                case 'planner': statuses = config.plannerStatuses; break;
                case 'project': statuses = config.projectStatuses; break;
                default: return null;
            }
            // Handle statuses with count like "RFQ Sent (3)"
            const baseStatus = name ? name.replace(/\s*\(\d+\)$/, '').trim() : '';
            return statuses.find(s => s.name === name || s.name === baseStatus) || null;
        }

        // =========================================================
        // Status ID-based system for items
        // Items store status_id, display uses current name from config
        // =========================================================

        // Get the display name for an item's status (resolves from status_id)
        function getItemStatusDisplay(item) {
            if (!item) return 'New';

            // If item has status_id, use it to get current name
            if (item.status_id) {
                const statusObj = getStatusById('item', item.status_id);
                if (statusObj) {
                    // Handle count suffix if present
                    const count = item.status_count;
                    if (count && count > 1) {
                        return `${statusObj.name} (${count})`;
                    }
                    return statusObj.name;
                }
            }

            // Fallback to legacy status text
            return item.status || 'New';
        }

        // Set item status by name (stores both status_id and status for backwards compatibility)
        function setItemStatus(item, statusName, count = null) {
            if (!item) return;

            // Handle status with count like "RFQ Sent (3)"
            let baseName = statusName;
            let extractedCount = count;
            const countMatch = statusName ? statusName.match(/^(.+?)\s*\((\d+)\)$/) : null;
            if (countMatch) {
                baseName = countMatch[1].trim();
                extractedCount = parseInt(countMatch[2], 10);
            }

            // Find status by name
            const statusObj = getStatusByName('item', baseName);
            if (statusObj) {
                item.status_id = statusObj.id;
                item.status_count = extractedCount || null;
                // Also store name for backwards compatibility and display
                item.status = extractedCount && extractedCount > 1 ? `${statusObj.name} (${extractedCount})` : statusObj.name;
            } else {
                // Unknown status - store as text only
                item.status = statusName;
                item.status_id = null;
                item.status_count = null;
            }
        }

        // Get status ID from name (for setting status)
        function getStatusIdFromName(type, name) {
            const statusObj = getStatusByName(type, name);
            return statusObj ? statusObj.id : null;
        }

        // Migrate existing items to use status_id
        function migrateItemsToStatusId(projectOrItems) {
            const items = Array.isArray(projectOrItems) ? projectOrItems :
                (projectOrItems && Array.isArray(projectOrItems.items)) ? projectOrItems.items : [];

            let migrated = 0;
            items.forEach(item => {
                if (!item.status_id && item.status) {
                    const statusObj = getStatusByName('item', item.status);
                    if (statusObj) {
                        item.status_id = statusObj.id;
                        // Extract count if present
                        const countMatch = item.status.match(/\((\d+)\)$/);
                        if (countMatch) {
                            item.status_count = parseInt(countMatch[1], 10);
                        }
                        migrated++;
                    }
                }

                // Also migrate supplier statuses
                if (Array.isArray(item.suppliers)) {
                    item.suppliers.forEach(sup => {
                        if (!sup.status_id && sup.status) {
                            const supStatusObj = getStatusByName('planner', sup.status);
                            if (supStatusObj) {
                                sup.status_id = supStatusObj.id;
                            }
                        }
                    });
                }
            });

            return migrated;
        }

        // Migrate all projects on load
        function migrateAllProjectsToStatusId() {
            if (typeof projects === 'undefined' || !Array.isArray(projects)) return;

            let totalMigrated = 0;
            projects.forEach(project => {
                totalMigrated += migrateItemsToStatusId(project);

                // Migrate project status
                if (!project.project_status_id && project.project_status) {
                    const statusObj = getStatusByName('project', project.project_status);
                    if (statusObj) {
                        project.project_status_id = statusObj.id;
                    }
                }
            });

            if (totalMigrated > 0) {
                console.log(`Migrated ${totalMigrated} items to status_id system`);
                // Save migrated data
                if (typeof updateProject === 'function') {
                    projects.forEach(p => updateProject(p));
                }
            }
        }

        // CRUD operations for statuses
        function addStatus(type, name, color, icon = null) {
            const config = getStatusConfig();
            let statuses;
            let idBase;
            switch (type) {
                case 'item': statuses = config.itemStatuses; idBase = 1; break;
                case 'batch': statuses = config.batchStatuses; idBase = 100; break;
                case 'supplierQuote': statuses = config.supplierQuoteStatuses; idBase = 200; break;
                case 'planner': statuses = config.plannerStatuses; idBase = 300; break;
                case 'project': statuses = config.projectStatuses; idBase = 400; break;
                default: return null;
            }

            // Generate new ID
            const maxId = statuses.reduce((max, s) => Math.max(max, s.id), idBase);
            const newId = maxId + 1;

            // Get max sort order
            const maxSort = statuses.reduce((max, s) => Math.max(max, s.sortOrder), 0);

            const newStatus = {
                id: newId,
                name: name,
                color: color || '#999999',
                sortOrder: maxSort + 10,
                category: 'in_progress'
            };
            if (icon) newStatus.icon = icon;

            statuses.push(newStatus);
            saveStatusConfig(config);
            refreshAllStatusDropdowns();
            refreshCurrentView();
            return newStatus;
        }

        function updateStatus(type, id, updates) {
            const config = getStatusConfig();
            let statuses;
            switch (type) {
                case 'item': statuses = config.itemStatuses; break;
                case 'batch': statuses = config.batchStatuses; break;
                case 'supplierQuote': statuses = config.supplierQuoteStatuses; break;
                case 'planner': statuses = config.plannerStatuses; break;
                case 'project': statuses = config.projectStatuses; break;
                default: return false;
            }

            const idx = statuses.findIndex(s => s.id === id);
            if (idx === -1) return false;

            Object.assign(statuses[idx], updates);
            saveStatusConfig(config);
            refreshAllStatusDropdowns();
            // Re-render current view to show updated status names/colors
            refreshCurrentView();
            return true;
        }

        // Helper to refresh the current view after status changes
        function refreshCurrentView() {
            try {
                if (currentView === 'items' && typeof renderCompactTable === 'function') {
                    renderCompactTable();
                } else if (currentView === 'dashboard' && typeof renderDashboard === 'function') {
                    renderDashboard();
                    if (typeof renderDashboardProjects === 'function') renderDashboardProjects();
                } else if (currentView === 'quoting') {
                    if (typeof renderItemComparison === 'function') renderItemComparison();
                    if (typeof renderRFQPlanner === 'function') renderRFQPlanner();
                } else if (currentView === 'main' && typeof renderMainOverview === 'function') {
                    renderMainOverview();
                }
            } catch (e) { console.warn('Could not refresh view:', e); }
        }

        function deleteStatus(type, id) {
            const config = getStatusConfig();
            let statuses;
            switch (type) {
                case 'item': statuses = config.itemStatuses; break;
                case 'batch': statuses = config.batchStatuses; break;
                case 'supplierQuote': statuses = config.supplierQuoteStatuses; break;
                case 'planner': statuses = config.plannerStatuses; break;
                case 'project': statuses = config.projectStatuses; break;
                default: return false;
            }

            const idx = statuses.findIndex(s => s.id === id);
            if (idx === -1) return false;

            statuses.splice(idx, 1);
            saveStatusConfig(config);
            refreshAllStatusDropdowns();
            refreshCurrentView();
            return true;
        }

        function reorderStatuses(type, orderedIds) {
            const config = getStatusConfig();
            let statuses;
            switch (type) {
                case 'item': statuses = config.itemStatuses; break;
                case 'batch': statuses = config.batchStatuses; break;
                case 'supplierQuote': statuses = config.supplierQuoteStatuses; break;
                case 'planner': statuses = config.plannerStatuses; break;
                case 'project': statuses = config.projectStatuses; break;
                default: return false;
            }

            orderedIds.forEach((id, index) => {
                const status = statuses.find(s => s.id === id);
                if (status) status.sortOrder = (index + 1) * 10;
            });
            saveStatusConfig(config);
            refreshAllStatusDropdowns();
            refreshCurrentView();
            return true;
        }

        function resetStatusesToDefaults() {
            const defaults = getDefaultStatusConfig();
            saveStatusConfig(defaults);
            refreshAllStatusDropdowns();
            refreshCurrentView();
            return defaults;
        }

        // Refresh all status dropdowns across the application
        function refreshAllStatusDropdowns() {
            // Clear caches
            refreshStatusCaches();

            // Refresh Items filter-status dropdown
            const filterStatus = document.getElementById('filter-status');
            if (filterStatus) {
                const currentValue = filterStatus.value;
                filterStatus.innerHTML = '<option value="">All Status</option>' +
                    getItemStatuses().map(st => `<option value="${escapeHtml(st)}">${escapeHtml(st)}</option>`).join('');
                filterStatus.value = currentValue;
            }

            // Refresh Price Comparison filter dropdown
            const pcStatusFilter = document.getElementById('pc-filter-status');
            if (pcStatusFilter) {
                const currentValue = pcStatusFilter.value;
                pcStatusFilter.innerHTML = '<option value="">All Status</option>' +
                    getItemStatuses().map(st => `<option value="${escapeHtml(st)}">${escapeHtml(st)}</option>`).join('');
                pcStatusFilter.value = currentValue;
            }

            // Refresh main project status filter
            const mainStatusFilter = document.getElementById('main-status-filter');
            if (mainStatusFilter) {
                const currentValue = mainStatusFilter.value;
                mainStatusFilter.innerHTML = '<option value="">All</option>' +
                    getProjectStatuses().map(st => `<option value="${escapeHtml(st)}">${escapeHtml(st)}</option>`).join('');
                mainStatusFilter.value = currentValue;
            }

            // Refresh bulk status select dropdown in Items view
            const bulkStatusSelect = document.getElementById('bulk-status-select');
            if (bulkStatusSelect) {
                const currentValue = bulkStatusSelect.value;
                bulkStatusSelect.innerHTML = '<option value="">Change Status</option>' +
                    getItemStatuses().map(st => `<option value="${escapeHtml(st)}">${escapeHtml(st)}</option>`).join('');
                bulkStatusSelect.value = currentValue;
            }

            console.log('Status dropdowns refreshed');
        }

        // Project status category helper for sorting
        function getProjectStatusCategory(status) {
            const config = getStatusConfig();
            const statusObj = config.projectStatuses.find(s => s.name === status);
            return statusObj?.category || 'new';
        }

        function getProjectSortValue(project) {
            const status = project.project_status || project.status || 'Created';
            const category = getProjectStatusCategory(status);
            const categoryOrder = { 'priority': 0, 'new': 1, 'in_progress': 2, 'issue': 2, 'done': 3 };
            return categoryOrder[category] ?? 2;
        }

        // Status matching helper - handles statuses with counts like "RFQ Sent (3)"
        // Returns true if itemStatus matches the filterStatus (with or without count)
        function statusMatchesFilter(itemStatus, filterStatus) {
            if (!filterStatus) return true;
            const itemSt = String(itemStatus || '').trim();
            const filterSt = String(filterStatus).trim();
            if (!filterSt) return true;

            // Exact match
            if (itemSt === filterSt) return true;

            // Handle statuses with counts - extract base status
            const baseItemStatus = itemSt.replace(/\s*\(\d+\)$/, '').trim();
            const baseFilterStatus = filterSt.replace(/\s*\(\d+\)$/, '').trim();

            return baseItemStatus === baseFilterStatus;
        }

        // =========================================================
        // Supplier Master DB helpers (deepfix)
        // - prevents crashes in Supplier modal + unifies supplier identity
        // - stored on project.supplierMaster (array)
        // =========================================================
        const _uid = () => `${Date.now()}_${Math.random().toString(16).slice(2)}`;

        const _normName = (v) => String(v ?? '').trim().toLowerCase();

        function ensureProjectSuppliers(project) {
            if (!project || typeof project !== 'object') return;
            if (!Array.isArray(project.supplierMaster)) project.supplierMaster = [];
            if (!Array.isArray(project.suppliers)) project.suppliers = []; // legacy bucket (optional)
            // RFQ bundles storage aliases (keep both, same array reference)
            if (!Array.isArray(project.rfqBatches) && Array.isArray(project.rfq_batches)) project.rfqBatches = project.rfq_batches;
            if (!Array.isArray(project.rfq_batches) && Array.isArray(project.rfqBatches)) project.rfq_batches = project.rfqBatches;
            if (!Array.isArray(project.rfqBatches)) project.rfqBatches = [];
            project.rfq_batches = project.rfqBatches;
        }

        function getSupplierMasterById(project, id) {
            ensureProjectSuppliers(project);
            if (!id) return null;
            return (project.supplierMaster || []).find(r => String(r.id) === String(id)) || null;
        }

        function getSupplierMasterByName(project, name) {
            ensureProjectSuppliers(project);
            const nn = _normName(name);
            if (!nn) return null;
            return (project.supplierMaster || []).find(r => _normName(r.name) === nn) || null;
        }

        function upsertSupplierMaster(project, rec) {
            ensureProjectSuppliers(project);
            if (!rec || typeof rec !== 'object') return null;
            const r = { ...rec };
            if (!r.id) r.id = _uid();
            if (!r.name) r.name = '';
            if (!r.pipeline) r.pipeline = 'Prospect';
            if (!r.nda) r.nda = { signed: false, signed_date: '', storage: '' };
            if (!Array.isArray(r.custom)) r.custom = [];
            if (typeof r.notes !== 'string') r.notes = '';
            const idx = (project.supplierMaster || []).findIndex(x => String(x.id) === String(r.id));
            if (idx >= 0) project.supplierMaster[idx] = r;
            else project.supplierMaster.push(r);
            return r;
        }

        // Debounce utility function
        function debounce(fn, delay) {
            let timer = null;
            return function (...args) {
                clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        function getOrCreateSupplierMaster(project, name) {
            ensureProjectSuppliers(project);
            const n = String(name || '').trim();
            if (!n) return null;
            let m = getSupplierMasterByName(project, n);
            if (m) return m;
            m = upsertSupplierMaster(project, {
                id: _uid(),
                name: n,
                pipeline: 'Prospect',
                nda: { signed: false, signed_date: '', storage: '' },
                custom: [],
                notes: '',
                created_at: new Date().toISOString(),
            });
            return m;
        }

        function linkItemSupplierToMaster(itemSup, masterRec) {
            if (!itemSup || typeof itemSup !== 'object' || !masterRec) return;
            itemSup.master_id = masterRec.id;
            if (!itemSup.name && masterRec.name) itemSup.name = masterRec.name;
        }

        // =========================================================
        // Project normalization + RFQ bundle access helpers
        // =========================================================
        function getProjectBatches(project) {
            if (!project) return [];
            // prefer RFQData storage
            if (window.RFQData && typeof window.RFQData.getRFQBatches === 'function' && project.id) {
                const arr = window.RFQData.getRFQBatches(project.id);
                return Array.isArray(arr) ? arr : [];
            }
            // fallback
            if (Array.isArray(project.rfqBatches)) return project.rfqBatches;
            if (Array.isArray(project.rfq_batches)) return project.rfq_batches;
            return [];
        }

        function syncProjectBatchesIntoMemory(project) {
            if (!project) return;
            ensureProjectSuppliers(project);
            const batches = getProjectBatches(project);
            project.rfqBatches = batches;
            project.rfq_batches = batches;
        }

        function ensureItemShape(item) {
            if (!item || typeof item !== 'object') return;
            if (!Array.isArray(item.suppliers)) item.suppliers = [];

            const INCOS = (window.RFQData && Array.isArray(window.RFQData.INCOTERMS))
                ? window.RFQData.INCOTERMS
                : ['EXW', 'FCA', 'FAS', 'FOB', 'CFR', 'CIF', 'CPT', 'CIP', 'DPU', 'DAP', 'DDP'];
            const isIncoterm = (v) => {
                const s = String(v ?? '').trim().toUpperCase();
                return !!s && INCOS.includes(s);
            };

            // --- Heal common legacy mixups (shipping_cost accidentally holds Incoterms etc.) ---
            if (isIncoterm(item.shipping_cost) && !String(item.incoterms || '').trim()) {
                item.incoterms = String(item.shipping_cost || '').trim().toUpperCase();
                item.shipping_cost = '';
            }

            // normalize supplier records (aliases + repairs)
            item.suppliers.forEach(s => {
                if (!s || typeof s !== 'object') return;

                // shipping aliasing
                if (s.shipping === undefined && s.shipping_cost !== undefined) s.shipping = s.shipping_cost;
                if (s.shipping_cost === undefined && s.shipping !== undefined) s.shipping_cost = s.shipping;

                // accidental incoterms stored in shipping
                if (isIncoterm(s.shipping) && !String(s.incoterms || '').trim()) {
                    s.incoterms = String(s.shipping || '').trim().toUpperCase();
                    s.shipping = '';
                    s.shipping_cost = '';
                }

                // prefer numeric-like string for shipping fields (do not crash number inputs)
                const shipStr = String(s.shipping ?? '').trim();
                if (shipStr && !/^[0-9]+([.,][0-9]+)?$/.test(shipStr) && !isIncoterm(shipStr)) {
                    // keep as-is, but avoid mirroring into item-level numeric field later
                }

                // legacy price aliases
                if (s.price_1 === undefined && s.price !== undefined) s.price_1 = s.price;
                if (s.price === undefined && s.price_1 !== undefined) s.price = s.price_1;
                if (!Array.isArray(s.prices)) s.prices = [];
            });

            // legacy main supplier -> ensure exists as record (optional, only if there is a name)
            const mainName = String(item.supplier || '').trim();
            if (mainName && !item.suppliers.some(s => _normName(s.name) === _normName(mainName))) {
                item.suppliers.push({
                    id: _uid(),
                    name: mainName,
                    currency: item.currency || 'EUR',
                    isMain: true,
                    status: item.status || 'New',
                    prices: [],
                    price: item.price_1 || '',
                    price_1: item.price_1 || '',
                    price_2: item.price_2 || '',
                    incoterms: item.incoterms || '',
                    moq: item.moq || '',
                    mov: item.mov || '',
                    lead_time: item.lead_time || '',
                    shipping: item.shipping_cost || '',
                    shipping_cost: item.shipping_cost || '',
                    quote_valid_until: item.quote_valid_until || '',
                    quote_status: item.quote_status || '',
                });
            }

            // ensure at least one main supplier if suppliers exist and none marked main
            if (item.suppliers.length) {
                const anyMain = item.suppliers.some(s => !!s.isMain);
                if (!anyMain) item.suppliers[0].isMain = true;
            }
        }




        // =========================================================
        // Quantity tier helpers (dynamic qty_1..qty_N)
        // - keeps Item Quantities, Suppliers & Pricing, and RFQ Bundles in sync
        // =========================================================
        function getItemQtyKeys(item) {
            if (!item || typeof item !== 'object') return [];
            return Object.keys(item)
                .filter(k => /^qty_\d+$/.test(k))
                .sort((a, b) => Number(a.split('_')[1]) - Number(b.split('_')[1]));
        }

        function getMaxQtyIndex(item, minDefault = 5) {
            const keys = getItemQtyKeys(item);
            let max = minDefault;
            keys.forEach(k => {
                const n = Number(k.split('_')[1]);
                if (Number.isFinite(n) && n > max) max = n;
            });
            return max;
        }

        function getItemQtyTiers(item, { includeBlanks = false, minDefault = 5 } = {}) {
            if (!item || typeof item !== 'object') return [];
            const max = getMaxQtyIndex(item, minDefault);
            const out = [];
            for (let i = 1; i <= max; i++) {
                const key = `qty_${i}`;
                const raw = item[key];
                const hasVal = String(raw ?? '').trim() !== '' && !Number.isNaN(Number(raw));
                if (!includeBlanks && !hasVal) continue;
                out.push({ index: i, key, value: raw });
            }
            // filter out non-positive if not blanks
            return out.filter(t => includeBlanks ? true : (String(t.value ?? '').trim() !== '' && Number(t.value) > 0));
        }

        function getSupplierPriceByIndex(sup, idx) {
            if (!sup) return '';
            if (idx === 1) return (sup.price_1 ?? sup.price ?? '');
            const k = `price_${idx}`;
            return (sup[k] ?? '');
        }

        function setSupplierPriceByIndex(sup, idx, val) {
            if (!sup) return;
            const v = String(val ?? '').trim();
            if (idx === 1) { sup.price = v; sup.price_1 = v; return; }
            sup[`price_${idx}`] = v;
        }

        function getDefaultQtyKey(item) {
            if (!item || typeof item !== 'object') return 'qty_1';
            const keys = getItemQtyKeys(item);
            for (const k of keys) {
                const v = parseFloat(item[k]);
                if (v > 0) return k;
            }
            return 'qty_1';
        }

        function getTierIndex(qtyKey) {
            if (!qtyKey || typeof qtyKey !== 'string') return 1;
            const m = qtyKey.match(/^qty_(\d+)$/);
            return m ? parseInt(m[1], 10) : 1;
        }

        // Ensure supplier.prices array mirrors current qty tiers (by index)
        function syncSupplierPricingToQtyTiers(item) {
            if (!item || typeof item !== 'object') return;
            ensureItemShape(item);
            const tiers = getItemQtyTiers(item, { includeBlanks: true });
            (item.suppliers || []).forEach(sup => {
                if (!sup || typeof sup !== 'object') return;
                if (!Array.isArray(sup.prices)) sup.prices = [];
                const newPrices = [];
                tiers.forEach(t => {
                    const qRaw = t.value;
                    const q = (String(qRaw ?? '').trim() !== '' && !Number.isNaN(Number(qRaw))) ? Number(qRaw) : null;

                    // pick price: first try matching old prices by qty, else by index
                    let p = '';
                    if (q !== null) {
                        const found = (sup.prices || []).find(r => Number(r.qty) === Number(q));
                        if (found && String(found.price ?? '').trim() !== '') p = String(found.price).trim();
                    }
                    if (p === '') p = String(getSupplierPriceByIndex(sup, t.index) ?? '').trim();

                    if (q !== null) newPrices.push({ qty: q, price: p });
                    setSupplierPriceByIndex(sup, t.index, p);
                });
                sup.prices = newPrices.filter(r => String(r.price ?? '').trim() !== '');
                sup.prices.sort((a, b) => Number(a.qty) - Number(b.qty));
                // keep legacy mirrors for first 5 tiers
                sup.price = getSupplierPriceByIndex(sup, 1);
                sup.price_1 = getSupplierPriceByIndex(sup, 1);
                sup.price_2 = getSupplierPriceByIndex(sup, 2);
                sup.price_3 = getSupplierPriceByIndex(sup, 3);
                sup.price_4 = getSupplierPriceByIndex(sup, 4);
                sup.price_5 = getSupplierPriceByIndex(sup, 5);
            });
        }

        // Update bundle lines to reflect latest item quantities (prices kept by tier index)
        function syncBundlesQtyFromItem(project, item) {
            if (!project || !item) return;
            const dn = String(item.item_drawing_no || '').trim();
            if (!dn) return;
            const batches = getProjectBatches(project);
            const max = getMaxQtyIndex(item, 5);
            let touched = false;
            (batches || []).forEach(b => {
                if (!b || !Array.isArray(b.items)) return;
                b.items.forEach(line => {
                    if (!line) return;
                    if (String(line.drawing_no || '').trim() !== dn) return;
                    // ensure line has price slots for current tiers (keep values)
                    for (let i = 1; i <= max; i++) {
                        const k = `price_${i}`;
                        if (i === 1) {
                            if (line.price === undefined && line.price_1 !== undefined) line.price = line.price_1;
                            if (line.price_1 === undefined && line.price !== undefined) line.price_1 = line.price;
                        } else {
                            if (line[k] === undefined) line[k] = '';
                        }
                    }
                    touched = true;
                });
            });
            if (touched && window.RFQData && typeof window.RFQData.saveRFQBatch === 'function' && project.id) {
                // Ulo≈æit all touched batches back (best-effort)
                (batches || []).forEach(b => window.RFQData.saveRFQBatch(project.id, b));
            }
        }

        function upsertSupplierOnItem(item, supplierName) {
            ensureItemShape(item);
            const name = String(supplierName || '').trim();
            if (!name) return null;
            let sup = item.suppliers.find(s => s && _normName(s.name) === _normName(name));
            if (!sup) {
                const mRec = (currentProject ? getOrCreateSupplierMaster(currentProject, name) : null);
                const defCur = (mRec && mRec.defaults && mRec.defaults.currency) ? mRec.defaults.currency : 'EUR';
                const defInc = (mRec && mRec.defaults && mRec.defaults.incoterms) ? mRec.defaults.incoterms : '';
                const defPay = (mRec && mRec.defaults && mRec.defaults.payment_terms) ? mRec.defaults.payment_terms : '';
                const defLead = (mRec && mRec.defaults && mRec.defaults.lead_time) ? mRec.defaults.lead_time : '';
                const defShip = (mRec && mRec.defaults && mRec.defaults.shipping_cost) ? mRec.defaults.shipping_cost : '';
                sup = { id: _uid(), name, currency: defCur, incoterms: defInc, payment_terms: defPay, lead_time: defLead, shipping_cost: defShip, shipping: defShip, isMain: item.suppliers.length === 0, status: 'Planned', prices: [] };
                if (mRec) linkItemSupplierToMaster(sup, mRec);
                item.suppliers.push(sup);
            }
            return sup;
        }

        function upsertPriceTier(sup, qty, price) {
            if (!sup) return;
            if (!Array.isArray(sup.prices)) sup.prices = [];
            const q = qty !== undefined && qty !== null && String(qty).trim() !== '' ? Number(qty) : null;
            const p = String(price ?? '').trim();
            if (!p) return;
            if (q === null || Number.isNaN(q)) {
                // fallback: store as legacy price_1
                sup.price = p;
                sup.price_1 = p;
                return;
            }
            const idx = sup.prices.findIndex(r => Number(r.qty) === Number(q));
            if (idx >= 0) sup.prices[idx] = { qty: q, price: p };
            else sup.prices.push({ qty: q, price: p });
            sup.prices.sort((a, b) => Number(a.qty) - Number(b.qty));

            // keep legacy mirrors (up to 5 tiers)
            sup.price = sup.prices[0]?.price || sup.price || '';
            sup.price_1 = sup.prices[0]?.price || sup.price_1 || '';
            sup.price_2 = sup.prices[1]?.price || sup.price_2 || '';
            sup.price_3 = sup.prices[2]?.price || sup.price_3 || '';
            sup.price_4 = sup.prices[3]?.price || sup.price_4 || '';
            sup.price_5 = sup.prices[4]?.price || sup.price_5 || '';
        }

        function applyBatchToItems(project, batch, mode) {
            if (!project || !batch) return;
            const supName = String(batch.supplier_name || batch.supplier || '').trim();
            if (!supName) return;
            const itemsByDn = new Map((project.items || []).map(it => [String(it.item_drawing_no || '').trim(), it]));
            (batch.items || []).forEach(line => {
                const dn = String(line.drawing_no || line.item_drawing_no || line.item_no || line.part_no || line.dn || '').trim();
                if (!dn) return;
                const it = itemsByDn.get(dn);
                if (!it) return;
                ensureItemShape(it);

                const sup = upsertSupplierOnItem(it, supName);
                // link to master
                const m = getOrCreateSupplierMaster(project, supName);
                if (m) linkItemSupplierToMaster(sup, m);

                // status propagation
                const lineStatus = String(line.quote_status || '').trim();
                if (mode === 'sent' || String(batch.status || '') === 'Sent') {
                    sup.status = 'RFQ Sent';
                    if (String(it.status || '') === 'New') it.status = 'RFQ Sent';
                }
                if (mode === 'received' || String(batch.status || '') === 'Quote Received') {
                    sup.status = (String(lineStatus || '').toLowerCase() === 'no bid') ? 'No Bid' : 'Quote Received';
                    // update item high-level status unless Done
                    if (!['Done', 'Closed'].includes(String(it.status || ''))) it.status = 'Quote Received';
                }

                // quote fields
                sup.currency = line.currency || batch.currency || sup.currency || 'EUR';
                sup.incoterms = batch.incoterms || sup.incoterms || '';
                if (line.valid_until) sup.quote_valid_until = line.valid_until;
                if (line.moq !== undefined) sup.moq = line.moq;
                if (line.mov !== undefined) sup.mov = line.mov;
                if (line.shipping_cost !== undefined) sup.shipping = line.shipping_cost;
                if (line.payment_terms !== undefined) sup.payment_terms = line.payment_terms;
                if (line.packaging !== undefined) sup.packaging = line.packaging;
                if (line.note !== undefined) sup.notes = line.note;
                if (line.lead_time_days !== undefined) sup.lead_time_days = line.lead_time_days;
                if (line.lead_time_days !== undefined && !sup.lead_time) sup.lead_time = String(line.lead_time_days || '').trim();
                if (lineStatus) sup.quote_status = lineStatus;

                // pricing (dynamic qty tiers)
                let hasAnyQuotedPrice = false;
                const tiers = getItemQtyTiers(it, { includeBlanks: false });
                if (String(lineStatus || '').toLowerCase() !== 'no bid') {
                    if (tiers.length === 0) {
                        const p = String((line.price_1 ?? line.price ?? '') ?? '').trim();
                        if (p !== '') {
                            hasAnyQuotedPrice = true;
                            upsertPriceTier(sup, null, p);
                        }
                    } else {
                        tiers.forEach(t => {
                            const k = `price_${t.index}`;
                            const pRaw = (t.index === 1)
                                ? (line.price_1 ?? line.price ?? '')
                                : (line[k] ?? '');
                            const p = String(pRaw ?? '').trim();
                            if (String(t.value ?? '').trim() !== '' && p !== '') {
                                hasAnyQuotedPrice = true;
                                upsertPriceTier(sup, t.value, p);
                            }
                        });
                    }
                }

                // Auto-promote supplier status from Quoting:
                // If line Quote status = Quoted and user entered any price, treat it as Quote Received
                // on the item supplier (no need to press "Mark Quote Received" on the bundle).
                if (String(lineStatus || '').toLowerCase() === 'quoted' && hasAnyQuotedPrice) {
                    sup.status = 'Quote Received';
                    if (!['Done', 'Closed'].includes(String(it.status || ''))) it.status = 'Quote Received';
                }

                // if supplier is main, mirror to item main fields
                if (sup.isMain) {
                    it.supplier = sup.name;
                    it.currency = sup.currency || it.currency;
                    it.incoterms = sup.incoterms || it.incoterms;
                    it.price_1 = sup.price_1 || sup.price || it.price_1;
                    it.price_2 = sup.price_2 || it.price_2;
                    it.moq = sup.moq || it.moq;
                    it.mov = sup.mov || it.mov;
                    it.lead_time = sup.lead_time || it.lead_time;
                    it.shipping_cost = sup.shipping || it.shipping_cost;
                    it.quote_valid_until = sup.quote_valid_until || it.quote_valid_until;
                    if (typeof calculateEuroValues === 'function') calculateEuroValues(it);
                }
            });
        }

        function syncAllBatchesToItems(project) {
            if (!project) return;
            const batches = getProjectBatches(project);
            batches.forEach(b => {
                // apply best-effort mapping without forcing statuses unless bundle is sent/received
                const st = String(b.status || '').trim();
                const mode = (st === 'Sent') ? 'sent' : (st === 'Quote Received' ? 'received' : 'save');
                applyBatchToItems(project, b, mode);
            });
        }

        // Project Picker (deferred selection)
        let projectPickerIsOpen = false;
        let projectPickerPendingId = null;

        function setProjectNameUI(name) {
            const label = name && String(name).trim() ? String(name).trim() : 'Select...';
            if (currentProjectName) currentProjectName.textContent = label;
            if (topbarProjectName) topbarProjectName.textContent = label;

            // Fix: Re-render Document Tracking when project changes (data isolation)
            if (typeof window.renderDocumentTracking === 'function') {
                try { window.renderDocumentTracking(); } catch (e) { console.warn('DocTrack refresh failed', e); }
            }
        }

        let filterText = '';
        let currentDetailIndex = null;
        let activeFilters = { status: '', supplier: '', manufacturer: '', priceMin: '', priceMax: '' };
        let currentView = 'dashboard';
        let supplierDetailReturnView = 'suppliers';
        let supplierDetailCurrentName = '';
        let currentViewedSupplier = '';
        let itemDetailReturnView = 'items';

        // Collaborative edit-lock state (item-detail first)
        let __editLock = {
            resourceKey: '',
            projectId: '',
            context: '',
            heartbeatTimer: null,
            readOnly: false,
            ownerDisplay: '',
            expiresAt: ''
        };

        let selectedItems = new Set(); // Track selected item indices

        // Items SuperTable instance (shared across handlers)
        let itemsSuperTable = null;

        let selectedDbParts = new Set(); // Track selected database MPN keys
        let __dbIndex = {}; // { key: {mpn, description, manufacturer, ... , refs: [{projectId, projectName, drawingNo}] } }


        // Bulk Pricing State
        let bulkCurrentPage = 1;
        const bulkItemsPerPage = 50;
        let bulkPricingFilterText = '';
        let bulkPricingFilterPart = '';
        let bulkPricingFilterMfr = '';
        let bulkPricingFilterDesc = '';

        // Charts
        let suppliersChart = null;
        let supplierValueChart = null;

        const getEl = (id) => {
            if (container) {
                return container.querySelector('#' + id) || document.getElementById(id);
            }
            return document.getElementById(id);
        };


        async function _lockFetchJson(url, options = {}) {
            const opts = {
                method: options.method || 'GET',
                headers: { 'Content-Type': 'application/json', ...(options.headers || {}) },
                credentials: 'same-origin'
            };
            if (options.body !== undefined) opts.body = JSON.stringify(options.body);
            const r = await fetch(url, opts);
            let data = {};
            try { data = await r.json(); } catch (_) { }
            if (!r.ok) throw new Error(data?.error || `HTTP ${r.status}`);
            return data;
        }

        function _buildItemResourceKey(item, index) {
            const pid = String(currentProject?.id || '');
            const iid = String(item?.id || item?.item_drawing_no || item?.drawing_no || item?.mpn || index || '').trim();
            return `project:${pid}:item:${iid}:view:item-detail`;
        }

        function _itemDetailSetReadOnly(on, message = '') {
            const root = getEl('view-item-detail');
            if (!root) return;
            __editLock.readOnly = !!on;

            const saveIds = ['btn-item-detail-save', 'btn-item-detail-save-back', 'btn-save-detail', 'btn-save-detail-no-close', 'btn-item-detail-delete'];
            saveIds.forEach(id => {
                const b = getEl(id);
                if (b) b.disabled = !!on;
            });

            root.querySelectorAll('input, textarea, select, button').forEach(el => {
                if (!on) {
                    if (el.dataset && el.dataset.lockReadonly === '1') {
                        el.disabled = false;
                        delete el.dataset.lockReadonly;
                    }
                    return;
                }

                const id = el.id || '';
                const safeIds = new Set(['btn-item-detail-back', 'btn-close-detail-window']);
                if (safeIds.has(id)) return;

                // Keep non-mutating nav clickable; disable mutating controls + form fields.
                const isField = ['INPUT', 'TEXTAREA', 'SELECT'].includes(el.tagName);
                const isSaveBtn = /save|delete|ulo≈æit|post|upload|add|create|import|export/i.test((el.textContent || '') + ' ' + id + ' ' + (el.className || ''));
                if (isField || isSaveBtn) {
                    if (el.dataset) el.dataset.lockReadonly = '1';
                    el.disabled = true;
                }
            });

            const bid = 'item-detail-lock-banner';
            let banner = document.getElementById(bid);
            if (on) {
                if (!banner) {
                    banner = document.createElement('div');
                    banner.id = bid;
                    banner.style.cssText = 'margin:8px 0; padding:10px 12px; border:1px solid #f59e0b; background:#fffbeb; color:#92400e; border-radius:8px; font-size:12px; font-weight:600;';
                    const body = getEl('item-detail-page-body') || root;
                    body.prepend(banner);
                }
                banner.textContent = message || '‚ö†Ô∏è Item is currently edited by another user. Read-only mode is active.';
            } else if (banner) {
                banner.remove();
            }
        }

        function _clearEditLockTimers() {
            if (__editLock.heartbeatTimer) {
                clearInterval(__editLock.heartbeatTimer);
                __editLock.heartbeatTimer = null;
            }
        }

        async function _releaseEditLock() {
            try {
                const key = __editLock.resourceKey;
                if (!key) return;
                await _lockFetchJson('/api/locks/release', { method: 'POST', body: { resource_key: key } });
            } catch (_) { }
            finally {
                _clearEditLockTimers();
                __editLock.resourceKey = '';
                __editLock.readOnly = false;
                __editLock.ownerDisplay = '';
                __editLock.expiresAt = '';
                _itemDetailSetReadOnly(false);
            }
        }

        async function _acquireGenericViewLock(context) {
            if (!currentProject || !context) return;
            const key = `project:${String(currentProject.id || '')}:view:${context}`;
            __editLock.resourceKey = key;
            __editLock.projectId = String(currentProject.id || '');
            __editLock.context = String(context);
            try {
                const res = await _lockFetchJson('/api/locks/acquire', {
                    method: 'POST',
                    body: { resource_key: key, project_id: __editLock.projectId, context: String(context), ttl_sec: 180 }
                });
                if (!res?.acquired) {
                    const owner = res?.owner?.display || 'another user';
                    const until = res?.expires_at ? new Date(res.expires_at).toLocaleTimeString() : '';
                    showToast(`View locked by ${owner}${until ? ` until ${until}` : ''}. Opened read-only mode.`, 'warning');
                }
            } catch (_) { }
        }

        async function _acquireItemDetailLock(item, index) {
            if (!currentProject) return;
            const key = _buildItemResourceKey(item, index);
            __editLock.resourceKey = key;
            __editLock.projectId = String(currentProject.id || '');
            __editLock.context = 'item-detail';

            try {
                const res = await _lockFetchJson('/api/locks/acquire', {
                    method: 'POST',
                    body: {
                        resource_key: key,
                        project_id: __editLock.projectId,
                        context: 'item-detail',
                        ttl_sec: 180
                    }
                });

                if (!res?.acquired) {
                    const owner = res?.owner?.display || 'another user';
                    const until = res?.expires_at ? new Date(res.expires_at).toLocaleTimeString() : '';
                    const msg = `‚ö†Ô∏è This item is currently edited by ${owner}${until ? ` (until ${until})` : ''}. Read-only mode is active.`;
                    __editLock.readOnly = true;
                    __editLock.ownerDisplay = owner;
                    __editLock.expiresAt = res?.expires_at || '';
                    _itemDetailSetReadOnly(true, msg);
                    return;
                }

                __editLock.readOnly = false;
                _itemDetailSetReadOnly(false);
                _clearEditLockTimers();
                __editLock.heartbeatTimer = setInterval(async () => {
                    try {
                        const hb = await _lockFetchJson('/api/locks/heartbeat', {
                            method: 'POST',
                            body: { resource_key: key, ttl_sec: 180 }
                        });
                        if (!hb?.renewed) {
                            _clearEditLockTimers();
                            __editLock.readOnly = true;
                            _itemDetailSetReadOnly(true, '‚ö†Ô∏è Your edit lock expired. Read-only mode is active. Reopen item detail to continue editing.');
                            showToast('Edit lock expired ‚Äî switched to read-only', 'warning');
                        }
                    } catch (_) {
                        // do not spam toasts on transient network errors
                    }
                }, 60000);
            } catch (e) {
                console.warn('Lock acquire failed:', e);
                // soft fallback: keep editable when lock service unavailable
            }
        }

        // Global formatMoney function that uses settings for decimal places
        const formatMoney = (n, forceDecimals) => {
            const decimals = forceDecimals !== undefined ? forceDecimals :
                (window.RFQData && typeof window.RFQData.getCurrencyDecimals === 'function'
                    ? window.RFQData.getCurrencyDecimals() : 4);
            const v = Number(n || 0);
            return isFinite(v) ? v.toLocaleString('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }) : '0.' + '0'.repeat(decimals);
        };

        // Format price with specified decimals (default from settings)
        const formatPrice = (n) => {
            const decimals = window.RFQData && typeof window.RFQData.getCurrencyDecimals === 'function'
                ? window.RFQData.getCurrencyDecimals() : 4;
            const v = Number(n || 0);
            return isFinite(v) ? v.toFixed(decimals) : '0.' + '0'.repeat(decimals);
        };

        // Pagination constant
        const PAGINATION_PAGE_SIZE = 100;

        // Get currency settings helper - also expose globally
        const getCurrencySettings = window.getCurrencySettings || function () {
            const decimals = window.RFQData && typeof window.RFQData.getCurrencyDecimals === 'function'
                ? window.RFQData.getCurrencyDecimals() : 4;
            return {
                decimals: decimals,
                baseCurrency: 'EUR'
            };
        };
        window.getCurrencySettings = getCurrencySettings;

        // Format number with specified decimals - also expose globally
        const formatNumber = window.formatNumber || function (n, decimals) {
            decimals = decimals !== undefined ? decimals : 2;
            const v = Number(n || 0);
            if (!isFinite(v)) return '0.' + '0'.repeat(decimals);
            return v.toLocaleString('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        };
        window.formatNumber = formatNumber;

        // Show toast notification - also expose globally
        const showToast = window.showToast || function (message, type) {
            type = type || 'info';
            // Remove existing toast
            const existing = document.querySelector('.rfq-toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = 'rfq-toast rfq-toast-' + type;
            toast.textContent = message;
            document.body.appendChild(toast);

            // Trigger animation
            setTimeout(function () { toast.classList.add('show'); }, 10);

            // Auto remove
            setTimeout(function () {
                toast.classList.remove('show');
                setTimeout(function () { toast.remove(); }, 300);
            }, 3000);
        };
        window.showToast = showToast;

        // Universal Confirm Dialog - returns Promise<boolean>
        // Creates modal dynamically in document.body to ensure it shows on all views
        window.showConfirmDialog = function (arg1, arg2, arg3, arg4) {
            return new Promise((resolve) => {
                // Polymorphic argument handling
                let opts = {};
                let onConfirmLegacy = null;
                let onCancelLegacy = null;

                if (typeof arg1 === 'object' && arg1 !== null) {
                    // Usage: showConfirmDialog({ ... })
                    opts = arg1;
                } else if (typeof arg2 === 'string') {
                    // Usage: showConfirmDialog(title, message, [onConfirm], [onCancel])
                    opts = { title: arg1, message: arg2 };
                    if (typeof arg3 === 'function') onConfirmLegacy = arg3;
                    if (typeof arg4 === 'function') onCancelLegacy = arg4;
                } else {
                    // Usage: showConfirmDialog(message) or unexpected
                    opts = { message: String(arg1 || 'Confirm') };
                }

                // Ensure modal exists in body (create if needed)
                let overlay = document.getElementById('confirm-dialog-overlay-global');
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.id = 'confirm-dialog-overlay-global';
                    overlay.className = 'rfq-modal-overlay hidden';
                    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:99999;padding:20px;';
                    overlay.innerHTML = `
                        <div class="rfq-modal-container" style="max-width:420px;background:#fff;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:hidden;">
                            <div class="confirm-dialog-header" style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid #e5e7eb;">
                                <div style="display:flex;align-items:center;gap:12px;">
                                    <span class="confirm-dialog-icon" style="font-size:28px;">‚ö†Ô∏è</span>
                                    <div>
                                        <h3 class="confirm-dialog-title" style="margin:0;font-size:16px;font-weight:600;color:#111;">Confirm Action</h3>
                                        <span class="confirm-dialog-subtitle" style="font-size:12px;color:#6b7280;display:none;"></span>
                                    </div>
                                </div>
                                <button class="confirm-dialog-close" style="background:none;border:none;font-size:24px;color:#9ca3af;cursor:pointer;padding:0;line-height:1;">&times;</button>
                            </div>
                            <div style="padding:20px;">
                                <p class="confirm-dialog-message" style="font-size:14px;line-height:1.6;color:#374151;margin:0;white-space:pre-wrap;"></p>
                            </div>
                            <div style="display:flex;gap:10px;justify-content:flex-end;padding:16px 20px;background:#f9fafb;border-top:1px solid #e5e7eb;">
                                <button class="confirm-dialog-cancel rfq-btn-secondary" style="min-width:100px;">Cancel</button>
                                <button class="confirm-dialog-ok rfq-btn-primary" style="min-width:100px;">OK</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(overlay);
                }

                const titleEl = overlay.querySelector('.confirm-dialog-title');
                const subtitleEl = overlay.querySelector('.confirm-dialog-subtitle');
                const messageEl = overlay.querySelector('.confirm-dialog-message');
                const iconEl = overlay.querySelector('.confirm-dialog-icon');
                const headerEl = overlay.querySelector('.confirm-dialog-header');
                const okBtn = overlay.querySelector('.confirm-dialog-ok');
                const cancelBtn = overlay.querySelector('.confirm-dialog-cancel');
                const closeBtn = overlay.querySelector('.confirm-dialog-close');

                // Set content
                titleEl.textContent = opts.title || 'Confirm Action';
                subtitleEl.textContent = opts.subtitle || '';
                subtitleEl.style.display = opts.subtitle ? 'block' : 'none';
                messageEl.textContent = opts.message || 'Are you sure you want to proceed?';
                okBtn.textContent = opts.okText || 'OK';
                cancelBtn.textContent = opts.cancelText || 'Cancel';

                // Set icon and color based on type
                const type = opts.type || 'warning';
                const typeConfig = {
                    warning: { icon: '‚ö†Ô∏è', bg: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)' },
                    danger: { icon: 'üóëÔ∏è', bg: 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)' },
                    info: { icon: '‚ÑπÔ∏è', bg: 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)' },
                    success: { icon: '‚úì', bg: 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)' },
                    question: { icon: '‚ùì', bg: 'linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%)' }
                };
                const cfg = typeConfig[type] || typeConfig.warning;
                iconEl.textContent = opts.icon || cfg.icon;
                headerEl.style.background = cfg.bg;
                okBtn.style.background = type === 'danger' ? '#ef4444' : '';
                okBtn.className = type === 'danger' ? 'confirm-dialog-ok rfq-btn-danger' : 'confirm-dialog-ok rfq-btn-primary';

                // Show overlay
                overlay.classList.remove('hidden');
                overlay.style.display = 'flex';

                // Cleanup function
                const cleanup = () => {
                    overlay.classList.add('hidden');
                    overlay.style.display = 'none';
                    okBtn.onclick = null;
                    cancelBtn.onclick = null;
                    closeBtn.onclick = null;
                    overlay.onclick = null;
                    document.removeEventListener('keydown', keyHandler);
                };

                const finish = (result) => {
                    resolve(result);
                    cleanup();
                    if (result && onConfirmLegacy) onConfirmLegacy();
                    if (!result && onCancelLegacy) onCancelLegacy();
                };

                // Key handler for ESC and Enter
                const keyHandler = (e) => {
                    if (e.key === 'Escape') finish(false);
                    if (e.key === 'Enter') finish(true);
                };
                document.addEventListener('keydown', keyHandler);

                // Button handlers
                okBtn.onclick = () => finish(true);
                cancelBtn.onclick = () => finish(false);
                closeBtn.onclick = () => finish(false);

                // Click outside to cancel
                overlay.onclick = (e) => {
                    if (e.target === overlay) finish(false);
                };
                // Focus OK button
                setTimeout(() => {
                    if (okBtn) okBtn.focus();
                }, 50);
            });
        };

        // Universal Alert Dialog - returns Promise<void> (just OK button)
        window.showAlertDialog = function (options) {
            return new Promise((resolve) => {
                let overlay = document.getElementById('alert-dialog-overlay-global');
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.id = 'alert-dialog-overlay-global';
                    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:99999;padding:20px;';
                    overlay.innerHTML = `
                        <div style="max-width:420px;background:#fff;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:hidden;width:100%;">
                            <div class="alert-dialog-header" style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid #e5e7eb;">
                                <div style="display:flex;align-items:center;gap:12px;">
                                    <span class="alert-dialog-icon" style="font-size:28px;">‚ÑπÔ∏è</span>
                                    <h3 class="alert-dialog-title" style="margin:0;font-size:16px;font-weight:600;color:#111;">Information</h3>
                                </div>
                                <button class="alert-dialog-close" style="background:none;border:none;font-size:24px;color:#9ca3af;cursor:pointer;padding:0;line-height:1;">&times;</button>
                            </div>
                            <div style="padding:20px;">
                                <p class="alert-dialog-message" style="font-size:14px;line-height:1.6;color:#374151;margin:0;white-space:pre-wrap;"></p>
                            </div>
                            <div style="display:flex;justify-content:flex-end;padding:16px 20px;background:#f9fafb;border-top:1px solid #e5e7eb;">
                                <button class="alert-dialog-ok rfq-btn-primary" style="min-width:100px;">OK</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(overlay);
                }

                const opts = typeof options === 'string' ? { message: options } : options;
                const titleEl = overlay.querySelector('.alert-dialog-title');
                const messageEl = overlay.querySelector('.alert-dialog-message');
                const iconEl = overlay.querySelector('.alert-dialog-icon');
                const headerEl = overlay.querySelector('.alert-dialog-header');
                const okBtn = overlay.querySelector('.alert-dialog-ok');
                const closeBtn = overlay.querySelector('.alert-dialog-close');

                titleEl.textContent = opts.title || 'Information';
                messageEl.textContent = opts.message || '';
                okBtn.textContent = opts.okText || 'OK';

                const type = opts.type || 'info';
                const typeConfig = {
                    info: { icon: '‚ÑπÔ∏è', bg: 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)' },
                    success: { icon: '‚úì', bg: 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)' },
                    warning: { icon: '‚ö†Ô∏è', bg: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)' },
                    error: { icon: '‚ùå', bg: 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)' }
                };
                const cfg = typeConfig[type] || typeConfig.info;
                iconEl.textContent = opts.icon || cfg.icon;
                headerEl.style.background = cfg.bg;

                overlay.style.display = 'flex';

                const cleanup = () => {
                    overlay.style.display = 'none';
                    okBtn.onclick = null;
                    closeBtn.onclick = null;
                    overlay.onclick = null;
                    document.removeEventListener('keydown', keyHandler);
                };

                const keyHandler = (e) => {
                    if (e.key === 'Escape' || e.key === 'Enter') { cleanup(); resolve(); }
                };
                document.addEventListener('keydown', keyHandler);

                okBtn.onclick = () => { cleanup(); resolve(); };
                closeBtn.onclick = () => { cleanup(); resolve(); };
                overlay.onclick = (e) => { if (e.target === overlay) { cleanup(); resolve(); } };

                setTimeout(() => okBtn.focus(), 50);
            });
        };

        // Universal Prompt Dialog - returns Promise<string|null>
        window.showPromptDialog = function (options) {
            return new Promise((resolve) => {
                let overlay = document.getElementById('prompt-dialog-overlay-global');
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.id = 'prompt-dialog-overlay-global';
                    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:99999;padding:20px;';
                    overlay.innerHTML = `
                        <div style="max-width:420px;background:#fff;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:hidden;width:100%;">
                            <div class="prompt-dialog-header" style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid #e5e7eb;background:linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);">
                                <div style="display:flex;align-items:center;gap:12px;">
                                    <span class="prompt-dialog-icon" style="font-size:28px;">‚úèÔ∏è</span>
                                    <h3 class="prompt-dialog-title" style="margin:0;font-size:16px;font-weight:600;color:#111;">Enter Value</h3>
                                </div>
                                <button class="prompt-dialog-close" style="background:none;border:none;font-size:24px;color:#9ca3af;cursor:pointer;padding:0;line-height:1;">&times;</button>
                            </div>
                            <div style="padding:20px;">
                                <p class="prompt-dialog-message" style="font-size:14px;line-height:1.6;color:#374151;margin:0 0 12px 0;"></p>
                                <input type="text" class="prompt-dialog-input" style="width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;outline:none;box-sizing:border-box;" />
                            </div>
                            <div style="display:flex;gap:10px;justify-content:flex-end;padding:16px 20px;background:#f9fafb;border-top:1px solid #e5e7eb;">
                                <button class="prompt-dialog-cancel rfq-btn-secondary" style="min-width:100px;">Cancel</button>
                                <button class="prompt-dialog-ok rfq-btn-primary" style="min-width:100px;">OK</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(overlay);
                }

                const opts = typeof options === 'string' ? { message: options } : options;
                const titleEl = overlay.querySelector('.prompt-dialog-title');
                const messageEl = overlay.querySelector('.prompt-dialog-message');
                const inputEl = overlay.querySelector('.prompt-dialog-input');
                const okBtn = overlay.querySelector('.prompt-dialog-ok');
                const cancelBtn = overlay.querySelector('.prompt-dialog-cancel');
                const closeBtn = overlay.querySelector('.prompt-dialog-close');

                titleEl.textContent = opts.title || 'Enter Value';
                messageEl.textContent = opts.message || '';
                inputEl.value = opts.defaultValue || '';
                inputEl.placeholder = opts.placeholder || '';
                okBtn.textContent = opts.okText || 'OK';
                cancelBtn.textContent = opts.cancelText || 'Cancel';

                overlay.style.display = 'flex';

                const cleanup = () => {
                    overlay.style.display = 'none';
                    okBtn.onclick = null;
                    cancelBtn.onclick = null;
                    closeBtn.onclick = null;
                    overlay.onclick = null;
                    inputEl.onkeydown = null;
                };

                inputEl.onkeydown = (e) => {
                    if (e.key === 'Enter') { cleanup(); resolve(inputEl.value); }
                    if (e.key === 'Escape') { cleanup(); resolve(null); }
                };

                okBtn.onclick = () => { cleanup(); resolve(inputEl.value); };
                cancelBtn.onclick = () => { cleanup(); resolve(null); };
                closeBtn.onclick = () => { cleanup(); resolve(null); };
                overlay.onclick = (e) => { if (e.target === overlay) { cleanup(); resolve(null); } };

                setTimeout(() => { inputEl.focus(); inputEl.select(); }, 50);
            });
        };

        // DOM Elements
        const navMain = getEl('nav-main');
        const navData = getEl('nav-data');
        const navDashboard = getEl('nav-dashboard');
        const navItems = getEl('nav-items');
        const navSuppliers = getEl('nav-suppliers');
        const navProjectSuppliers = getEl('nav-project-suppliers');
        const navSupplierList = getEl('nav-supplier-list');
        const navDatabase = getEl('nav-database');
        const navQuotes = getEl('nav-quotes');
        const navExport = getEl('nav-export');
        const navSettings = getEl('nav-settings');
        const navSamepart = getEl('nav-samepart');
        const viewMain = getEl('view-main');
        const viewDataManager = getEl('view-data-manager');
        const viewDashboard = getEl('view-dashboard');
        const viewProjectDetail = getEl('view-project-detail');
        const viewItems = getEl('view-items');
        const viewItemDetail = getEl('view-item-detail');
        const viewSuppliers = getEl('view-suppliers');
        const viewProjectSuppliers = getEl('view-project-suppliers');
        const viewSupplierList = getEl('view-supplier-list');

        const viewSupplierDetail = getEl('view-supplier-detail');
        const viewBundleDetail = getEl('view-bundle-detail');
        const viewQuoteCompare = getEl('view-quote-compare');
        const viewQuoting = getEl('view-quoting');
        const viewSamepart = getEl('view-samepart');
        const viewDatabase = getEl('view-database');
        const viewQuotes = getEl('view-quotes');
        const viewExport = getEl('view-export');
        const viewSettings = getEl('view-settings');

        const btnSupplierDetailBack = getEl('btn-supplier-detail-back');
        const btnSupplierDetailUlo≈æit = getEl('btn-supplier-detail-save');
        const btnSupplierDetailUlo≈æitBack = getEl('btn-supplier-detail-save-back');
        const btnSupplierDetailDelete = getEl('btn-supplier-detail-delete');

        const btnBundleDetailBack = getEl('btn-bundle-detail-back');
        const btnBundleDetailSave = getEl('btn-bundle-detail-save');
        const btnBundleDetailDelete = getEl('btn-bundle-detail-delete');
        const btnBundleDetailExport = getEl('btn-bundle-detail-export');
        const bundleDetailPageTitle = getEl('bundle-detail-page-title');
        const bundleDetailPageContent = getEl('bundle-detail-page-content');

        const btnItemDetailBack = getEl('btn-item-detail-back');
        const btnItemDetailUlo≈æit = getEl('btn-item-detail-save');
        const btnItemDetailUlo≈æitBack = getEl('btn-item-detail-save-back');
        const btnItemDetailDelete = getEl('btn-item-detail-delete');



        // Navigation Elements
        const navQuoting = getEl('nav-quoting');

        // Additional DOM Elements for functions
        const sidebarProjects = getEl('sidebar-projects');
        const currentProjectName = getEl('current-project-name');
        const topbarProjectName = getEl('topbar-project-name');
        const btnTopbarMain = getEl('btn-topbar-main');
        const btnTopbarData = getEl('btn-topbar-data');
        const btnTopbarUploadQuote = getEl('btn-topbar-upload-quote');
        // const dashboardProjectSelect = getEl('dashboard-project-select'); // Removed
        const sheetNewProject = getEl('sheet-new-project');
        const inputNewProjectName = getEl('new-project-name');

        const sheetManualEntry = getEl('sheet-manual-entry');
        const manualEntryForm = getEl('manual-entry-form');

        const emptyState = container ? container.querySelector('.empty-state') : null;
        const dataTableBody = viewItems ? viewItems.querySelector('tbody') : null;
        const tableDatabaseBody = viewDatabase ? viewDatabase.querySelector('tbody') : null;

        // Overlay Elements
        const detailWindow = getEl('detail-window');
        const detailContent = getEl('detail-content');
        const supplierDetailWindow = getEl('supplier-detail-window');
        const supplierDetailContent = getEl('supplier-detail-content');
        const sheetPriceList = getEl('sheet-price-list');
        const fileImportExcel = getEl('file-import-excel');

        // Filter Elements
        const tableFilter = getEl('table-filter');
        const filterStatus = getEl('filter-status');
        const filterSupplier = getEl('filter-supplier');
        const filterManufacturer = getEl('filter-manufacturer');
        const filterPriceMin = getEl('filter-price-min');
        const filterPriceMax = getEl('filter-price-max');

        // Stats
        const statTotal = getEl('stat-total');
        const statDone = getEl('stat-done');
        const statPending = getEl('stat-pending');

        // Database Elements
        const databaseSearch = getEl('database-search');
        const databaseProjectFilter = getEl('database-project-filter');

        // =========================================================
        // Project status (per project)
        // - 3 defaults + custom statuses (stored in LocalStorage)
        // =========================================================

        function normStatusValue(v) {
            const s = String(v || '').trim();
            return s ? s : 'Created';
        }

        function getStatusOptions() {
            try {
                // First try to use the dynamic status config
                if (typeof getProjectStatuses === 'function') {
                    return getProjectStatuses();
                }
                if (window.RFQData && typeof window.RFQData.getProjectStatusOptions === 'function') {
                    return window.RFQData.getProjectStatusOptions();
                }
            } catch (e) { }
            return ['Created', 'In process', 'Done'];
        }

        function fillProjectStatusSelect(selectEl, currentValue) {
            if (!selectEl) return;
            const cur = normStatusValue(currentValue);
            const opts = getStatusOptions();
            selectEl.innerHTML = opts.map(s => {
                const sel = String(s).toLowerCase() === String(cur).toLowerCase() ? 'selected' : '';
                return `<option value="${escapeHtml(String(s))}" ${sel}>${escapeHtml(String(s))}</option>`;
            }).join('');
            // if current is custom and missing (edge case), add it
            if (cur && !opts.some(s => String(s).toLowerCase() === String(cur).toLowerCase())) {
                const opt = document.createElement('option');
                opt.value = cur;
                opt.textContent = cur;
                opt.selected = true;
                selectEl.appendChild(opt);
            }
            selectEl.value = cur;
        }

        function getCurrentProjectStatus() {
            if (!currentProject) return 'Created';
            return normStatusValue(currentProject.project_status || currentProject.status);
        }

        function setCurrentProjectStatus(newStatus) {
            if (!currentProject) return;
            currentProject.project_status = normStatusValue(newStatus);
            if (typeof updateProject === 'function') updateProject(currentProject);
            try { renderSidebar(); } catch (e) { }
            try { renderDashboardProjectStatus(); } catch (e) { }
            try { renderProjectDetail(); } catch (e) { }
            try { updateDashboardStatusBadge(); } catch (e) { }
        }

        // Update big status badge in dashboard
        function updateDashboardStatusBadge() {
            if (!currentProject) return;
            const ps = currentProject.project_status || 'Created';
            const elStatusBig = document.getElementById('dash-status-big');
            const elStatusBigText = document.getElementById('dash-status-big-text');
            if (elStatusBig && elStatusBigText) {
                elStatusBigText.textContent = ps;
                const psL = String(ps).toLowerCase();
                let bgColor = '#64748b', icon = 'üìã';
                if (psL.includes('done') || psL.includes('completed') || psL.includes('closed')) {
                    bgColor = '#10b981'; icon = '‚úì';
                } else if (psL.includes('process') || psL.includes('active') || psL.includes('progress')) {
                    bgColor = '#3b82f6'; icon = '‚è≥';
                } else if (psL.includes('hold') || psL.includes('wait')) {
                    bgColor = '#f59e0b'; icon = '‚è∏';
                } else if (psL.includes('cancel') || psL.includes('reject')) {
                    bgColor = '#ef4444'; icon = '‚úï';
                } else if (psL.includes('new') || psL.includes('created')) {
                    bgColor = '#8b5cf6'; icon = 'üÜï';
                }
                elStatusBig.style.background = bgColor;
                const iconEl = elStatusBig.querySelector('span:first-child');
                if (iconEl) iconEl.textContent = icon;
            }
        }

        function openAddProjectStatusModal(onAdded) {
            const id = 'project-status-editor-modal';
            let overlay = document.getElementById(id);
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = id;
                overlay.className = 'modal-overlay';
                overlay.style.zIndex = '3600';
                overlay.innerHTML = `
            <div class="modal-content small" style="width: 420px;">
                <h3 style="margin-top:0;">Add Project Status</h3>
                <div class="form-row" style="margin-bottom: 12px;">
                    <label>Status name</label>
                    <input type="text" id="proj-status-new-name" class="modal-input" placeholder="e.g. Waiting for customer">
                </div>
                <div class="muted" style="font-size:12px; margin-top:-4px; margin-bottom: 12px;">
                    This status will be available in all projects on this PC (LocalStorage).
                </div>
                <div class="modal-actions">
                    <button id="btn-proj-status-cancel" class="btn-secondary" type="button">Cancel</button>
                    <button id="btn-proj-status-add" class="btn-primary" type="button">Add</button>
                </div>
            </div>
        `;
                document.body.appendChild(overlay);
            }

            const close = () => { overlay.classList.add('hidden'); overlay.setAttribute('aria-hidden', 'true'); };
            overlay.classList.remove('hidden');
            overlay.setAttribute('aria-hidden', 'false');

            const input = document.getElementById('proj-status-new-name');
            const btnCancel = document.getElementById('btn-proj-status-cancel');
            const btnAdd = document.getElementById('btn-proj-status-add');

            if (input) {
                input.value = '';
                try { input.focus(); } catch (e) { }
            }

            if (btnCancel) btnCancel.onclick = close;
            overlay.onclick = (e) => { if (e.target === overlay) close(); };

            if (btnAdd) btnAdd.onclick = () => {
                const name = input ? String(input.value || '').trim() : '';
                if (!name) { if (window.showToast) window.showToast('Enter a status name', 'warning'); return; }
                try {
                    if (window.RFQData && typeof window.RFQData.addProjectStatusOption === 'function') {
                        window.RFQData.addProjectStatusOption(name);
                    } else {
                        // fallback
                        const key = 'rfq_project_status_options_v1';
                        const arr = (() => { try { return JSON.parse(localStorage.getItem(key) || '[]'); } catch { return []; } })();
                        arr.push(name);
                        localStorage.setItem(key, JSON.stringify(arr));
                    }
                } catch (e) { }
                try { if (typeof onAdded === 'function') onAdded(name); } catch (e) { }
                close();
            };
        }

        function bindProjectStatusPlusButtonsOnce() {
            if (window.__RFQ_STATUS_PLUS_BOUND__) return;
            window.__RFQ_STATUS_PLUS_BOUND__ = true;
            document.addEventListener('click', (ev) => {
                const btn = ev.target && ev.target.closest ? ev.target.closest('[data-action="add-project-status"]') : null;
                if (!btn) return;
                ev.preventDefault();
                ev.stopPropagation();
                openAddProjectStatusModal(() => {
                    // refresh all known selects
                    try { fillProjectStatusSelect(getEl('new-project-status'), getCurrentProjectStatus()); } catch (e) { }
                    try { fillProjectStatusSelect(getEl('edit-project-status'), getCurrentProjectStatus()); } catch (e) { }
                    try { fillProjectStatusSelect(getEl('dash-project-status'), getCurrentProjectStatus()); } catch (e) { }
                    try { fillProjectStatusSelect(getEl('projdetail-status'), getCurrentProjectStatus()); } catch (e) { }
                });
            }, true);
        }
        bindProjectStatusPlusButtonsOnce();

        function renderDashboardProjectStatus() {
            const sel = getEl('dash-project-status');
            const pill = getEl('dash-project-status-pill');

            if (!currentProject) {
                if (sel) {
                    fillProjectStatusSelect(sel, 'Created');
                    sel.disabled = true;
                }
                if (pill) pill.textContent = 'Select a project';
                return;
            }

            if (sel) {
                sel.disabled = false;
                fillProjectStatusSelect(sel, getCurrentProjectStatus());
                if (!sel.dataset.bound) {
                    sel.dataset.bound = '1';
                    sel.onchange = () => setCurrentProjectStatus(sel.value);
                }
            }
            if (pill) pill.textContent = getCurrentProjectStatus();

            // Bind Recalculate All button
            const btnRecalc = getEl('btn-recalculate-all');
            if (btnRecalc && !btnRecalc.dataset.bound) {
                btnRecalc.dataset.bound = '1';
                btnRecalc.onclick = () => {
                    if (!currentProject) {
                        if (window.showToast) window.showToast('Please select a project first', 'warning');
                        return;
                    }
                    if (window.recalculateAllProjectData) {
                        window.recalculateAllProjectData();
                    }
                };
            }

            // Bind Dashboard Add Note button
            const btnDashAddNote = getEl('btn-dash-add-note');
            if (btnDashAddNote && !btnDashAddNote.dataset.bound) {
                btnDashAddNote.dataset.bound = '1';
                btnDashAddNote.onclick = () => {
                    if (!currentProject) {
                        if (window.showToast) window.showToast('Please select a project first', 'warning');
                        return;
                    }
                    openDashboardNoteModal();
                };
            }
        }

        // Dashboard Note Modal
        function openDashboardNoteModal() {
            // Remove existing modal if any
            const existing = document.getElementById('dash-note-modal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'dash-note-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:999999;';

            modal.innerHTML = `
        <div style="background:white;border-radius:16px;width:90%;max-width:600px;max-height:80vh;display:flex;flex-direction:column;box-shadow:0 25px 50px rgba(0,0,0,0.25);">
            <div style="padding:20px 24px;border-bottom:1px solid #e5e5e5;display:flex;justify-content:space-between;align-items:center;">
                <h2 style="margin:0;font-size:18px;font-weight:700;color:#111;">üìù Project Notes</h2>
                <button id="dash-note-close" style="background:none;border:none;font-size:24px;cursor:pointer;color:#999;line-height:1;">&times;</button>
            </div>
            <div style="padding:24px;flex:1;overflow-y:auto;">
                <div style="margin-bottom:16px;">
                    <label style="display:block;font-size:13px;font-weight:600;color:#333;margin-bottom:8px;">Add New Note</label>
                    <textarea id="dash-note-text" rows="4" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px;resize:vertical;font-family:inherit;" placeholder="Write your note here..."></textarea>
                </div>
                <button id="dash-note-save" class="btn-primary" style="width:100%;padding:12px;font-size:14px;font-weight:600;">üíæ Save Note</button>

                <div style="margin-top:24px;border-top:1px solid #e5e5e5;padding-top:16px;">
                    <h3 style="font-size:14px;font-weight:600;color:#333;margin-bottom:12px;">Previous Notes</h3>
                    <div id="dash-note-history" style="max-height:200px;overflow-y:auto;"></div>
                </div>
            </div>
        </div>
    `;

            document.body.appendChild(modal);

            // Render existing notes
            renderDashboardNoteHistory();

            // Close button
            document.getElementById('dash-note-close').onclick = () => modal.remove();
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

            // Save button
            document.getElementById('dash-note-save').onclick = () => {
                const textarea = document.getElementById('dash-note-text');
                const text = textarea.value.trim();
                if (!text) return;

                if (!currentProject.project_notes) currentProject.project_notes = [];
                currentProject.project_notes.unshift({
                    id: Date.now().toString(),
                    text: text,
                    created_at: new Date().toISOString()
                });

                if (window.RFQData && typeof window.RFQData.updateProject === 'function') {
                    window.RFQData.updateProject(currentProject);
                } else if (typeof updateProject === 'function') {
                    updateProject(currentProject);
                }

                textarea.value = '';
                renderDashboardNoteHistory();

                // Show success feedback
                const btn = document.getElementById('dash-note-save');
                const origText = btn.textContent;
                btn.textContent = '‚úì Saved!';
                btn.style.background = '#10b981';
                setTimeout(() => {
                    btn.textContent = origText;
                    btn.style.background = '';
                }, 1500);
            };

            // Focus textarea
            document.getElementById('dash-note-text').focus();
        }

        function renderDashboardNoteHistory() {
            const container = document.getElementById('dash-note-history');
            if (!container || !currentProject) return;

            const notes = currentProject.project_notes || [];

            if (notes.length === 0) {
                container.innerHTML = '<div style="color:#999;font-size:13px;text-align:center;padding:20px;">No notes yet</div>';
                return;
            }

            container.innerHTML = notes.map(n => {
                const d = new Date(n.created_at);
                const dateStr = isNaN(d.getTime()) ? n.created_at : d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                return `
            <div style="padding:12px;background:#f8fafc;border-radius:8px;margin-bottom:8px;border-left:3px solid #3b82f6;">
                <div style="font-size:11px;color:#64748b;margin-bottom:4px;">${dateStr}</div>
                <div style="font-size:13px;color:#1e293b;">${escapeHtml(n.text)}</div>
                <button onclick="deleteDashboardNote('${n.id}')" style="margin-top:8px;font-size:11px;color:#ef4444;background:none;border:none;cursor:pointer;">üóë Delete</button>
            </div>
        `;
            }).join('');
        }

        window.deleteDashboardNote = function (noteId) {
            if (!currentProject || !currentProject.project_notes) return;
            currentProject.project_notes = currentProject.project_notes.filter(n => n.id !== noteId);

            if (window.RFQData && typeof window.RFQData.updateProject === 'function') {
                window.RFQData.updateProject(currentProject);
            } else if (typeof updateProject === 'function') {
                updateProject(currentProject);
            }

            renderDashboardNoteHistory();
        };

        // ============================================
        // Dashboard Layout Editor
        // ============================================

        let dashboardEditMode = false;
        let dashboardLayoutBackup = null;

        function getDashboardLayoutConfig() {
            const grid = document.getElementById('dashboard-grid');
            if (!grid) return null;

            const boxes = grid.querySelectorAll('.dash-box');
            const config = {
                order: [],
                visibility: {},
                sizes: {}
            };

            boxes.forEach(box => {
                const id = box.dataset.boxId;
                config.order.push(id);
                config.visibility[id] = !box.classList.contains('hidden-box');
                config.sizes[id] = {
                    colSpan: parseInt(box.dataset.colSpan) || 1,
                    rowSpan: parseInt(box.dataset.rowSpan) || 1
                };
            });

            return config;
        }

        function saveDashboardLayout() {
            const config = getDashboardLayoutConfig();
            if (config) {
                localStorage.setItem('rfq_dashboard_layout', JSON.stringify(config));
            }
        }

        function loadDashboardLayout() {
            const saved = localStorage.getItem('rfq_dashboard_layout');
            if (!saved) return;

            try {
                const config = JSON.parse(saved);
                applyDashboardLayout(config);
            } catch (e) {
                console.warn('Failed to load dashboard layout:', e);
            }
        }

        function applyDashboardLayout(config) {
            const grid = document.getElementById('dashboard-grid');
            if (!grid || !config) return;

            const boxes = Array.from(grid.querySelectorAll('.dash-box'));
            const boxMap = {};
            boxes.forEach(box => { boxMap[box.dataset.boxId] = box; });

            // Reorder boxes
            if (config.order && Array.isArray(config.order)) {
                config.order.forEach(id => {
                    const box = boxMap[id];
                    if (box) grid.appendChild(box);
                });
            }

            // Apply visibility
            if (config.visibility) {
                Object.keys(config.visibility).forEach(id => {
                    const box = boxMap[id];
                    if (box) {
                        if (config.visibility[id]) {
                            box.classList.remove('hidden-box');
                        } else {
                            box.classList.add('hidden-box');
                        }
                    }
                });
            }

            // Apply sizes
            if (config.sizes) {
                Object.keys(config.sizes).forEach(id => {
                    const box = boxMap[id];
                    if (box && config.sizes[id]) {
                        box.dataset.colSpan = config.sizes[id].colSpan || 1;
                        box.dataset.rowSpan = config.sizes[id].rowSpan || 1;
                        updateBoxGridStyle(box);
                    }
                });
            }
        }

        function updateBoxGridStyle(box) {
            const colSpan = parseInt(box.dataset.colSpan) || 1;
            box.style.gridColumn = `span ${colSpan}`;
        }

        function toggleDashboardEditMode() {
            const grid = document.getElementById('dashboard-grid');
            if (!grid) return;

            dashboardEditMode = !dashboardEditMode;

            if (dashboardEditMode) {
                // Entering edit mode
                dashboardLayoutBackup = getDashboardLayoutConfig();
                grid.classList.add('edit-mode');
                showDashboardEditOverlay();
                initDashboardDragDrop();
            } else {
                // Exiting edit mode
                grid.classList.remove('edit-mode');
                hideDashboardEditOverlay();
            }
        }

        function showDashboardEditOverlay() {
            let overlay = document.getElementById('dashboard-edit-overlay');
            if (overlay) overlay.remove();

            overlay = document.createElement('div');
            overlay.id = 'dashboard-edit-overlay';
            overlay.className = 'dashboard-edit-overlay';
            overlay.innerHTML = `
        <span>üé® <b>Layout Edit Mode</b> ‚Äî Drag boxes to reorder, use +/- to resize</span>
        <button class="btn-add-box" id="btn-dash-add-box">+ Add Box</button>
        <button class="btn-save" id="btn-dash-layout-save">‚úì Save</button>
        <button class="btn-cancel" id="btn-dash-layout-cancel">‚úï Cancel</button>
        <button class="btn-reset" id="btn-dash-layout-reset">‚Ü∫ Reset</button>
    `;
            document.body.appendChild(overlay);

            document.getElementById('btn-dash-add-box').onclick = openAddBoxModal;

            document.getElementById('btn-dash-layout-save').onclick = () => {
                saveDashboardLayout();
                saveCustomBoxes();
                toggleDashboardEditMode();
                if (window.showToast) window.showToast('Dashboard layout saved!', 'success');
            };

            document.getElementById('btn-dash-layout-cancel').onclick = () => {
                if (dashboardLayoutBackup) {
                    applyDashboardLayout(dashboardLayoutBackup);
                }
                toggleDashboardEditMode();
            };

            document.getElementById('btn-dash-layout-reset').onclick = async () => {
                const confirmed = await window.showConfirmDialog({
                    title: 'Reset Dashboard',
                    message: 'Reset dashboard to default layout? This will also remove custom boxes.',
                    type: 'warning',
                    okText: 'Reset',
                    cancelText: 'Cancel'
                });
                if (confirmed) {
                    localStorage.removeItem('rfq_dashboard_layout');
                    localStorage.removeItem('rfq_custom_boxes');
                    location.reload();
                }
            };
        }

        function hideDashboardEditOverlay() {
            const overlay = document.getElementById('dashboard-edit-overlay');
            if (overlay) overlay.remove();
        }

        // ============================================
        // Custom Box Creation System
        // ============================================

        const BOX_TYPES = {
            // === METRICS & DATA ===
            'stat-single': {
                name: 'Single Metric',
                icon: 'üìä',
                category: 'Metrics',
                description: 'Display one key number (count, sum, average)',
                fields: ['title', 'metric', 'filter', 'color']
            },
            'stat-multi': {
                name: 'Multiple Metrics',
                icon: 'üìà',
                category: 'Metrics',
                description: 'Display 2-6 metrics in a grid',
                fields: ['title', 'metrics']
            },
            'progress-bar': {
                name: 'Progress Bar',
                icon: '‚è≥',
                category: 'Metrics',
                description: 'Visual progress indicator',
                fields: ['title', 'metric', 'target']
            },
            'gauge': {
                name: 'Gauge Meter',
                icon: 'üéØ',
                category: 'Metrics',
                description: 'Circular progress gauge',
                fields: ['title', 'metric', 'target', 'color']
            },

            // === CHARTS ===
            'chart-pie': {
                name: 'Pie Chart',
                icon: 'ü•ß',
                category: 'Charts',
                description: 'Pie/Donut chart for distribution',
                fields: ['title', 'dataSource', 'groupBy']
            },
            'chart-bar': {
                name: 'Bar Chart',
                icon: 'üìä',
                category: 'Charts',
                description: 'Bar chart for comparisons',
                fields: ['title', 'dataSource', 'groupBy', 'metric']
            },

            // === LISTS & TABLES ===
            'item-list': {
                name: 'Item List',
                icon: 'üìã',
                category: 'Lists',
                description: 'Filtered list of items',
                fields: ['title', 'filter', 'columns', 'limit', 'sortBy']
            },
            'supplier-list': {
                name: 'Supplier Summary',
                icon: 'üè≠',
                category: 'Lists',
                description: 'Suppliers with stats',
                fields: ['title', 'sortBy', 'limit']
            },
            'supplier-contacts': {
                name: 'Supplier Contacts',
                icon: 'üìá',
                category: 'Lists',
                description: 'Supplier email & contact cards',
                fields: ['title', 'limit']
            },
            'last-quotes': {
                name: 'Last Quotes Received',
                icon: 'üí∞',
                category: 'Lists',
                description: 'Recently received quotes',
                fields: ['title', 'limit']
            },
            'todo-list': {
                name: 'TODO List',
                icon: '‚úÖ',
                category: 'Lists',
                description: 'Task checklist for project',
                fields: ['title']
            },

            // === TIME & DATES ===
            'countdown': {
                name: 'Deadline Countdown',
                icon: '‚è∞',
                category: 'Time',
                description: 'Days until project deadline',
                fields: ['title']
            },
            'countdown-custom': {
                name: 'Custom Countdown',
                icon: 'üìÖ',
                category: 'Time',
                description: 'Countdown to custom date',
                fields: ['title', 'targetDate', 'label']
            },
            'recent-activity': {
                name: 'Recent Activity',
                icon: 'üïê',
                category: 'Time',
                description: 'Latest changes and comments',
                fields: ['title', 'limit']
            },

            // === TOOLS & ACTIONS ===
            'quick-actions': {
                name: 'Quick Actions',
                icon: '‚ö°',
                category: 'Tools',
                description: 'Buttons for common actions',
                fields: ['title', 'actions']
            },
            'currency-rates': {
                name: 'Currency Rates',
                icon: 'üí±',
                category: 'Tools',
                description: 'Exchange rates display',
                fields: ['title', 'currencies']
            },
            'calculator': {
                name: 'Quick Calculator',
                icon: 'üî¢',
                category: 'Tools',
                description: 'Price/margin calculator',
                fields: ['title']
            },

            // === INFO & CONTENT ===
            'text-block': {
                name: 'Text / Info',
                icon: 'üìù',
                category: 'Content',
                description: 'Custom text or HTML content',
                fields: ['title', 'content']
            },
            'project-summary': {
                name: 'Project Summary',
                icon: 'üìë',
                category: 'Content',
                description: 'Key project information',
                fields: ['title']
            },
            'status-overview': {
                name: 'Status Overview',
                icon: 'üö¶',
                category: 'Content',
                description: 'Visual status breakdown',
                fields: ['title']
            }
        };

        const METRIC_OPTIONS = [
            // === ITEM COUNTS ===
            { value: 'items_total', label: 'Total Items', category: 'Counts' },
            { value: 'items_quoted', label: 'Items with Quotes', category: 'Counts' },
            { value: 'items_no_quote', label: 'Items without Quote', category: 'Counts' },
            { value: 'items_issue', label: 'Items with Issues', category: 'Counts' },
            { value: 'items_done', label: 'Completed Items', category: 'Counts' },
            { value: 'items_in_progress', label: 'Items In Progress', category: 'Counts' },
            { value: 'items_pending', label: 'Pending Items', category: 'Counts' },
            { value: 'items_with_supplier', label: 'Items with Supplier', category: 'Counts' },
            { value: 'items_no_supplier', label: 'Items without Supplier', category: 'Counts' },

            // === SUPPLIERS ===
            { value: 'suppliers_count', label: 'Number of Suppliers', category: 'Suppliers' },
            { value: 'suppliers_with_quotes', label: 'Suppliers with Quotes', category: 'Suppliers' },
            { value: 'avg_suppliers_per_item', label: 'Avg Suppliers per Item', category: 'Suppliers' },

            // === VALUES & PRICES ===
            { value: 'total_value', label: 'Total Value (‚Ç¨)', category: 'Values' },
            { value: 'total_value_qty1', label: 'Value QTY1 (‚Ç¨)', category: 'Values' },
            { value: 'total_value_qty2', label: 'Value QTY2 (‚Ç¨)', category: 'Values' },
            { value: 'total_value_qty3', label: 'Value QTY3 (‚Ç¨)', category: 'Values' },
            { value: 'avg_price', label: 'Average Price (‚Ç¨)', category: 'Values' },
            { value: 'max_price', label: 'Highest Price (‚Ç¨)', category: 'Values' },
            { value: 'min_price', label: 'Lowest Price (‚Ç¨)', category: 'Values' },
            { value: 'median_price', label: 'Median Price (‚Ç¨)', category: 'Values' },

            // === TARGETS & SAVINGS ===
            { value: 'target_total', label: 'Target Total (‚Ç¨)', category: 'Targets' },
            { value: 'savings', label: 'Savings vs Target (‚Ç¨)', category: 'Targets' },
            { value: 'savings_pct', label: 'Savings (%)', category: 'Targets' },
            { value: 'over_target', label: 'Items Over Target', category: 'Targets' },
            { value: 'under_target', label: 'Items Under Target', category: 'Targets' },
            { value: 'budget_remaining', label: 'Budget Remaining (‚Ç¨)', category: 'Targets' },

            // === PERCENTAGES & RATES ===
            { value: 'quote_rate', label: 'Quote Rate (%)', category: 'Rates' },
            { value: 'completion_rate', label: 'Completion Rate (%)', category: 'Rates' },
            { value: 'issue_rate', label: 'Issue Rate (%)', category: 'Rates' },
            { value: 'supplier_coverage', label: 'Supplier Coverage (%)', category: 'Rates' },

            // === QUANTITIES ===
            { value: 'total_qty1', label: 'Total Quantity (QTY1)', category: 'Quantities' },
            { value: 'total_qty2', label: 'Total Quantity (QTY2)', category: 'Quantities' },
            { value: 'total_qty3', label: 'Total Quantity (QTY3)', category: 'Quantities' },
            { value: 'unique_parts', label: 'Unique Part Numbers', category: 'Quantities' },

            // === TIME ===
            { value: 'days_to_deadline', label: 'Days to Deadline', category: 'Time' },
            { value: 'project_age', label: 'Project Age (days)', category: 'Time' },
            { value: 'avg_lead_time', label: 'Avg Lead Time (days)', category: 'Time' }
        ];

        const FILTER_OPTIONS = [
            { value: 'all', label: 'All Items' },
            { value: 'status_issue', label: 'Status: Issue' },
            { value: 'status_done', label: 'Status: Done/Completed' },
            { value: 'status_progress', label: 'Status: In Progress' },
            { value: 'status_pending', label: 'Status: Pending' },
            { value: 'status_cancelled', label: 'Status: Cancelled' },
            { value: 'has_quote', label: 'Has Quote' },
            { value: 'no_quote', label: 'No Quote' },
            { value: 'has_supplier', label: 'Has Supplier Assigned' },
            { value: 'no_supplier', label: 'No Supplier' },
            { value: 'over_target', label: 'Over Target Price' },
            { value: 'under_target', label: 'Under Target Price' },
            { value: 'high_value', label: 'High Value (>‚Ç¨1000)' },
            { value: 'medium_value', label: 'Medium Value (‚Ç¨100-‚Ç¨1000)' },
            { value: 'low_value', label: 'Low Value (<‚Ç¨100)' },
            { value: 'recently_updated', label: 'Recently Updated (7 days)' },
            { value: 'has_comments', label: 'Has Comments' }
        ];

        const COLOR_OPTIONS = [
            { value: '#3b82f6', label: 'Blue' },
            { value: '#10b981', label: 'Green' },
            { value: '#f59e0b', label: 'Orange' },
            { value: '#ef4444', label: 'Red' },
            { value: '#8b5cf6', label: 'Purple' },
            { value: '#ec4899', label: 'Pink' },
            { value: '#06b6d4', label: 'Cyan' },
            { value: '#64748b', label: 'Gray' }
        ];

        function openAddBoxModal() {
            const existing = document.getElementById('add-box-modal');
            if (existing) existing.remove();

            // Group box types by category
            const categories = {};
            Object.entries(BOX_TYPES).forEach(([key, type]) => {
                const cat = type.category || 'Other';
                if (!categories[cat]) categories[cat] = [];
                categories[cat].push({ key, ...type });
            });

            const modal = document.createElement('div');
            modal.id = 'add-box-modal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:999999;';

            modal.innerHTML = `
        <div style="background:white;border-radius:16px;width:95%;max-width:900px;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 25px 50px rgba(0,0,0,0.3);">
            <div style="padding:20px 24px;border-bottom:1px solid #e5e5e5;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:16px 16px 0 0;">
                <h2 style="margin:0;font-size:20px;font-weight:700;color:white;">‚ûï Add New Dashboard Box</h2>
                <button id="add-box-close" style="background:rgba(255,255,255,0.2);border:none;font-size:20px;cursor:pointer;color:white;width:32px;height:32px;border-radius:50%;line-height:1;">&times;</button>
            </div>
            <div style="padding:24px;flex:1;overflow-y:auto;">
                <div id="box-type-selection">
                    ${Object.entries(categories).map(([catName, types]) => `
                        <div style="margin-bottom:20px;">
                            <h4 style="margin:0 0 10px;font-size:13px;font-weight:600;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;">${catName}</h4>
                            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;">
                                ${types.map(type => `
                                    <div class="box-type-card" data-type="${type.key}" style="padding:12px;border:2px solid #e2e8f0;border-radius:10px;cursor:pointer;transition:all 0.2s;text-align:center;">
                                        <div style="font-size:24px;margin-bottom:6px;">${type.icon}</div>
                                        <div style="font-size:12px;font-weight:600;color:#1e293b;">${type.name}</div>
                                        <div style="font-size:10px;color:#94a3b8;margin-top:2px;line-height:1.3;">${type.description}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div id="box-config-panel" style="display:none;margin-top:20px;padding-top:20px;border-top:1px solid #e5e5e5;">
                    <h3 style="margin:0 0 16px;font-size:16px;color:#334155;">Configure Box</h3>
                    <div id="box-config-fields"></div>
                </div>
            </div>
            <div style="padding:16px 24px;border-top:1px solid #e5e5e5;display:flex;justify-content:flex-end;gap:12px;">
                <button id="add-box-cancel" class="btn-secondary" style="padding:10px 20px;">Cancel</button>
                <button id="add-box-create" class="btn-primary" style="padding:10px 20px;display:none;">Create Box</button>
            </div>
        </div>
    `;

            document.body.appendChild(modal);

            // Close handlers
            document.getElementById('add-box-close').onclick = () => modal.remove();
            document.getElementById('add-box-cancel').onclick = () => modal.remove();
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

            // Type selection
            let selectedType = null;
            modal.querySelectorAll('.box-type-card').forEach(card => {
                card.onmouseenter = () => { card.style.borderColor = '#667eea'; card.style.background = '#f8fafc'; };
                card.onmouseleave = () => {
                    if (card.dataset.type !== selectedType) {
                        card.style.borderColor = '#e2e8f0';
                        card.style.background = 'white';
                    }
                };
                card.onclick = () => {
                    selectedType = card.dataset.type;
                    modal.querySelectorAll('.box-type-card').forEach(c => {
                        c.style.borderColor = '#e2e8f0';
                        c.style.background = 'white';
                    });
                    card.style.borderColor = '#667eea';
                    card.style.background = '#eff6ff';
                    showBoxConfigFields(selectedType);
                    document.getElementById('add-box-create').style.display = 'block';
                };
            });

            // Create handler
            document.getElementById('add-box-create').onclick = () => {
                if (!selectedType) return;
                const config = collectBoxConfig(selectedType);
                if (config) {
                    createCustomBox(selectedType, config);
                    modal.remove();
                    if (window.showToast) window.showToast('Box created!', 'success');
                }
            };
        }

        function showBoxConfigFields(type) {
            const panel = document.getElementById('box-config-panel');
            const fields = document.getElementById('box-config-fields');
            panel.style.display = 'block';

            let html = `
        <div style="margin-bottom:16px;">
            <label style="display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:6px;">Box Title</label>
            <input type="text" id="box-cfg-title" class="rfq-input" style="width:100%;padding:10px 12px;" placeholder="Enter title..." value="${BOX_TYPES[type].name}">
        </div>
    `;

            switch (type) {
                case 'stat-single':
                    html += `
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                    <div>
                        <label style="display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:6px;">Metric</label>
                        <select id="box-cfg-metric" class="rfq-input" style="width:100%;padding:10px;">
                            ${METRIC_OPTIONS.map(o => `<option value="${o.value}">${o.label}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label style="display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:6px;">Color</label>
                        <select id="box-cfg-color" class="rfq-input" style="width:100%;padding:10px;">
                            ${COLOR_OPTIONS.map(o => `<option value="${o.value}">${o.label}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div style="margin-top:16px;">
                    <label style="display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:6px;">Filter (optional)</label>
                    <select id="box-cfg-filter" class="rfq-input" style="width:100%;padding:10px;">
                        ${FILTER_OPTIONS.map(o => `<option value="${o.value}">${o.label}</option>`).join('')}
                    </select>
                </div>
            `;
                    break;

                case 'stat-multi':
                    html += `
                <div style="margin-bottom:16px;">
                    <label style="display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:6px;">Select Metrics (2-4)</label>
                    <div id="box-cfg-metrics" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        ${METRIC_OPTIONS.map(o => `
                            <label style="display:flex;align-items:center;gap:8px;padding:8px;border:1px solid #e2e8f0;border-radius:6px;cursor:pointer;">
                                <input type="checkbox" name="metrics" value="${o.value}">
                                <span style="font-size:12px;">${o.label}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;
                    break;

                case 'chart-pie':
                case 'chart-bar':
                    html += `
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                    <div>
                        <label style="display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:6px;">Data Source</label>
                        <select id="box-cfg-datasource" class="rfq-input" style="width:100%;padding:10px;">
                            <option value="items">Items</option>
                            <option value="suppliers">Suppliers</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:6px;">Group By</label>
                        <select id="box-cfg-groupby" class="rfq-input" style="width:100%;padding:10px;">
                            <option value="status">Status</option>
                            <option value="supplier">Supplier</option>
                            <option value="manufacturer">Manufacturer</option>
                        </select>
                    </div>
                </div>
            `;
                    break;

                case 'item-list':
                    html += `
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                    <div>
                        <label style="display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:6px;">Filter</label>
                        <select id="box-cfg-filter" class="rfq-input" style="width:100%;padding:10px;">
                            ${FILTER_OPTIONS.map(o => `<option value="${o.value}">${o.label}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label style="display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:6px;">Max Items</label>
                        <input type="number" id="box-cfg-limit" class="rfq-input" style="width:100%;padding:10px;" value="10" min="1" max="50">
                    </div>
                </div>
                <div style="margin-top:16px;">
                    <label style="display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:6px;">Columns</label>
                    <div id="box-cfg-columns" style="display:flex;flex-wrap:wrap;gap:8px;">
                        ${['Part No.', 'Description', 'Qty', 'Price', 'Supplier', 'Status'].map(col => `
                            <label style="display:flex;align-items:center;gap:4px;padding:6px 10px;border:1px solid #e2e8f0;border-radius:6px;cursor:pointer;">
                                <input type="checkbox" name="columns" value="${col.toLowerCase().replace(/[^a-z]/g, '_')}" checked>
                                <span style="font-size:12px;">${col}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;
                    break;

                case 'supplier-list':
                    html += `
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                    <div>
                        <label style="display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:6px;">Sort By</label>
                        <select id="box-cfg-sortby" class="rfq-input" style="width:100%;padding:10px;">
                            <option value="items">Number of Items</option>
                            <option value="value">Total Value</option>
                            <option value="name">Name (A-Z)</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:6px;">Max Suppliers</label>
                        <input type="number" id="box-cfg-limit" class="rfq-input" style="width:100%;padding:10px;" value="10" min="1" max="50">
                    </div>
                </div>
            `;
                    break;

                case 'progress-bar':
                    html += `
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                    <div>
                        <label style="display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:6px;">Track Progress Of</label>
                        <select id="box-cfg-metric" class="rfq-input" style="width:100%;padding:10px;">
                            <option value="quote_rate">Quote Rate</option>
                            <option value="items_done">Completed Items</option>
                            <option value="budget_used">Budget Used</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:6px;">Target (%)</label>
                        <input type="number" id="box-cfg-target" class="rfq-input" style="width:100%;padding:10px;" value="100" min="1" max="100">
                    </div>
                </div>
            `;
                    break;

                case 'quick-actions':
                    html += `
                <div>
                    <label style="display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:6px;">Select Actions</label>
                    <div id="box-cfg-actions" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        ${[
                            { id: 'add_item', label: '‚ûï Add Item' },
                            { id: 'export_excel', label: 'üì• Export Excel' },
                            { id: 'recalculate', label: 'üîÑ Recalculate' },
                            { id: 'add_note', label: 'üìù Add Note' },
                            { id: 'send_rfq', label: 'üìß Send RFQ' },
                            { id: 'import_prices', label: 'üì§ Import Prices' }
                        ].map(a => `
                            <label style="display:flex;align-items:center;gap:8px;padding:8px;border:1px solid #e2e8f0;border-radius:6px;cursor:pointer;">
                                <input type="checkbox" name="actions" value="${a.id}">
                                <span style="font-size:12px;">${a.label}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;
                    break;

                case 'text-block':
                    html += `
                <div>
                    <label style="display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:6px;">Content</label>
                    <textarea id="box-cfg-content" class="rfq-input" style="width:100%;padding:10px;min-height:120px;resize:vertical;" placeholder="Enter text or HTML..."></textarea>
                    <div style="font-size:11px;color:#64748b;margin-top:4px;">Supports basic HTML tags</div>
                </div>
            `;
                    break;

                case 'countdown':
                    html += `
                <div style="font-size:13px;color:#64748b;padding:16px;background:#f8fafc;border-radius:8px;">
                    This box will automatically show days remaining until the project deadline.
                </div>
            `;
                    break;

                case 'countdown-custom':
                    html += `
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                    <div>
                        <label style="display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:6px;">Target Date</label>
                        <input type="date" id="box-cfg-target-date" class="rfq-input" style="width:100%;padding:10px;">
                    </div>
                    <div>
                        <label style="display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:6px;">Event Label</label>
                        <input type="text" id="box-cfg-event-label" class="rfq-input" style="width:100%;padding:10px;" placeholder="e.g., Quote Deadline">
                    </div>
                </div>
            `;
                    break;

                case 'recent-activity':
                    html += `
                <div>
                    <label style="display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:6px;">Max Items to Show</label>
                    <input type="number" id="box-cfg-limit" class="rfq-input" style="width:100%;padding:10px;" value="5" min="1" max="20">
                </div>
            `;
                    break;

                case 'todo-list':
                    html += `
                <div style="font-size:13px;color:#64748b;padding:16px;background:#f8fafc;border-radius:8px;">
                    Create an interactive TODO list. You can add, check off, and delete tasks after creating the box.
                </div>
            `;
                    break;

                case 'supplier-contacts':
                    html += `
                <div>
                    <label style="display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:6px;">Max Contacts to Show</label>
                    <input type="number" id="box-cfg-limit" class="rfq-input" style="width:100%;padding:10px;" value="5" min="1" max="20">
                </div>
            `;
                    break;

                case 'last-quotes':
                    html += `
                <div>
                    <label style="display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:6px;">Number of Recent Quotes</label>
                    <input type="number" id="box-cfg-limit" class="rfq-input" style="width:100%;padding:10px;" value="5" min="1" max="20">
                </div>
            `;
                    break;

                case 'currency-rates':
                    html += `
                <div>
                    <label style="display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:6px;">Select Currencies</label>
                    <div id="box-cfg-currencies" style="display:flex;flex-wrap:wrap;gap:8px;">
                        ${['USD', 'GBP', 'CZK', 'PLN', 'CHF', 'JPY', 'CNY'].map(cur => `
                            <label style="display:flex;align-items:center;gap:4px;padding:6px 12px;border:1px solid #e2e8f0;border-radius:6px;cursor:pointer;">
                                <input type="checkbox" name="currencies" value="${cur}" ${cur === 'USD' || cur === 'CZK' ? 'checked' : ''}>
                                <span style="font-size:12px;">${cur}</span>
                            </label>
                        `).join('')}
                    </div>
                    <div style="font-size:11px;color:#94a3b8;margin-top:8px;">Base currency: EUR</div>
                </div>
            `;
                    break;

                case 'gauge':
                    html += `
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                    <div>
                        <label style="display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:6px;">Metric</label>
                        <select id="box-cfg-metric" class="rfq-input" style="width:100%;padding:10px;">
                            ${METRIC_OPTIONS.filter(o => o.category === 'Rates').map(o => `<option value="${o.value}">${o.label}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label style="display:block;font-size:13px;font-weight:600;color:#475569;margin-bottom:6px;">Color</label>
                        <select id="box-cfg-color" class="rfq-input" style="width:100%;padding:10px;">
                            ${COLOR_OPTIONS.map(o => `<option value="${o.value}">${o.label}</option>`).join('')}
                        </select>
                    </div>
                </div>
            `;
                    break;

                case 'calculator':
                    html += `
                <div style="font-size:13px;color:#64748b;padding:16px;background:#f8fafc;border-radius:8px;">
                    Quick calculator for price/margin calculations. Enter values directly in the box.
                </div>
            `;
                    break;

                case 'project-summary':
                case 'status-overview':
                    html += `
                <div style="font-size:13px;color:#64748b;padding:16px;background:#f8fafc;border-radius:8px;">
                    This box will automatically display ${type === 'project-summary' ? 'key project information' : 'visual status breakdown'}.
                </div>
            `;
                    break;
            }

            fields.innerHTML = html;
        }

        function collectBoxConfig(type) {
            const config = {
                id: 'custom-' + Date.now(),
                type: type,
                title: document.getElementById('box-cfg-title')?.value || BOX_TYPES[type].name
            };

            switch (type) {
                case 'stat-single':
                    config.metric = document.getElementById('box-cfg-metric')?.value;
                    config.color = document.getElementById('box-cfg-color')?.value;
                    config.filter = document.getElementById('box-cfg-filter')?.value;
                    break;
                case 'stat-multi':
                    const checked = document.querySelectorAll('#box-cfg-metrics input:checked');
                    config.metrics = Array.from(checked).map(c => c.value);
                    if (config.metrics.length < 2) {
                        if (window.showToast) window.showToast('Please select at least 2 metrics', 'warning');
                        return null;
                    }
                    break;
                case 'chart-pie':
                case 'chart-bar':
                    config.dataSource = document.getElementById('box-cfg-datasource')?.value;
                    config.groupBy = document.getElementById('box-cfg-groupby')?.value;
                    break;
                case 'item-list':
                    config.filter = document.getElementById('box-cfg-filter')?.value;
                    config.limit = parseInt(document.getElementById('box-cfg-limit')?.value) || 10;
                    const cols = document.querySelectorAll('#box-cfg-columns input:checked');
                    config.columns = Array.from(cols).map(c => c.value);
                    break;
                case 'supplier-list':
                    config.sortBy = document.getElementById('box-cfg-sortby')?.value;
                    config.limit = parseInt(document.getElementById('box-cfg-limit')?.value) || 10;
                    break;
                case 'progress-bar':
                    config.metric = document.getElementById('box-cfg-metric')?.value;
                    config.target = parseInt(document.getElementById('box-cfg-target')?.value) || 100;
                    break;
                case 'quick-actions':
                    const actions = document.querySelectorAll('#box-cfg-actions input:checked');
                    config.actions = Array.from(actions).map(c => c.value);
                    if (config.actions.length === 0) {
                        if (window.showToast) window.showToast('Please select at least one action', 'warning');
                        return null;
                    }
                    break;
                case 'text-block':
                    config.content = document.getElementById('box-cfg-content')?.value || '';
                    break;
                case 'recent-activity':
                case 'supplier-contacts':
                case 'last-quotes':
                    config.limit = parseInt(document.getElementById('box-cfg-limit')?.value) || 5;
                    break;
                case 'countdown-custom':
                    config.targetDate = document.getElementById('box-cfg-target-date')?.value;
                    config.eventLabel = document.getElementById('box-cfg-event-label')?.value || 'Event';
                    if (!config.targetDate) {
                        if (window.showToast) window.showToast('Please select a target date', 'warning');
                        return null;
                    }
                    break;
                case 'currency-rates':
                    const currencies = document.querySelectorAll('#box-cfg-currencies input:checked');
                    config.currencies = Array.from(currencies).map(c => c.value);
                    if (config.currencies.length === 0) {
                        if (window.showToast) window.showToast('Please select at least one currency', 'warning');
                        return null;
                    }
                    break;
                case 'gauge':
                    config.metric = document.getElementById('box-cfg-metric')?.value;
                    config.color = document.getElementById('box-cfg-color')?.value;
                    break;
                case 'todo-list':
                    config.todos = []; // Initialize empty todo list
                    break;
            }

            return config;
        }

        function createCustomBox(type, config) {
            const grid = document.getElementById('dashboard-grid');
            if (!grid) return;

            const box = document.createElement('div');
            box.className = 'dash-box';
            box.dataset.boxId = config.id;
            box.dataset.boxTitle = config.title;
            box.dataset.colSpan = '1';
            box.dataset.rowSpan = '1';
            box.dataset.customBox = 'true';
            box.dataset.boxConfig = JSON.stringify(config);

            box.innerHTML = `
        <div class="dash-box-header">
            <span class="dash-box-drag-handle">‚ãÆ‚ãÆ</span>
            <span class="dash-box-title">${escapeHtml(config.title)}</span>
            <div class="dash-box-controls">
                <button class="dash-box-btn" data-action="resize-smaller" title="Smaller">‚àí</button>
                <button class="dash-box-btn" data-action="resize-larger" title="Larger">+</button>
                <button class="dash-box-btn" data-action="toggle-visibility" title="Hide">üëÅ</button>
                <button class="dash-box-btn" data-action="delete-box" title="Delete" style="color:#ef4444;">üóë</button>
            </div>
        </div>
        <div class="dash-box-content" id="content-${config.id}">
            <div style="text-align:center;padding:20px;color:#64748b;">Loading...</div>
        </div>
    `;

            grid.appendChild(box);
            updateBoxGridStyle(box);
            renderCustomBoxContent(config);

            // Attach delete handler directly to ensure it always works
            const deleteBtn = box.querySelector('[data-action="delete-box"]');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', async function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const confirmed = await window.showConfirmDialog({
                        title: 'Delete Box',
                        message: 'Delete this custom box?',
                        type: 'danger',
                        okText: 'Delete',
                        cancelText: 'Cancel'
                    });
                    if (confirmed) {
                        box.remove();
                        saveCustomBoxes();
                        if (window.showToast) window.showToast('Box deleted', 'success');
                    }
                });
            }

            // Re-init drag/drop for new box
            if (dashboardEditMode) {
                initDashboardDragDrop();
            }
        }

        function renderCustomBoxContent(config) {
            const container = document.getElementById('content-' + config.id);
            if (!container || !currentProject) return;

            const items = Array.isArray(currentProject.items) ? currentProject.items : [];

            switch (config.type) {
                case 'stat-single':
                    const value = calculateMetric(config.metric, items, config.filter);
                    container.innerHTML = `
                <div style="text-align:center;padding:10px;">
                    <div style="font-size:36px;font-weight:800;color:${config.color || '#3b82f6'};">${value}</div>
                    <div style="font-size:12px;color:#64748b;margin-top:4px;">${METRIC_OPTIONS.find(m => m.value === config.metric)?.label || config.metric}</div>
                </div>
            `;
                    break;

                case 'stat-multi':
                    container.innerHTML = `
                <div style="display:grid;grid-template-columns:repeat(${Math.min(config.metrics.length, 4)},1fr);gap:12px;">
                    ${config.metrics.map((m, i) => {
                        const val = calculateMetric(m, items);
                        const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'];
                        return `
                            <div style="text-align:center;padding:12px;background:${colors[i % 4]}10;border-radius:8px;">
                                <div style="font-size:24px;font-weight:700;color:${colors[i % 4]};">${val}</div>
                                <div style="font-size:10px;color:#64748b;margin-top:4px;">${METRIC_OPTIONS.find(o => o.value === m)?.label || m}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
                    break;

                case 'progress-bar':
                    const progress = calculateMetric(config.metric, items);
                    const pctVal = typeof progress === 'string' ? parseFloat(progress) : progress;
                    const pct = Math.min(100, Math.max(0, (pctVal / config.target) * 100));
                    container.innerHTML = `
                <div style="padding:10px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;font-size:13px;">
                        <span>${METRIC_OPTIONS.find(m => m.value === config.metric)?.label || config.metric}</span>
                        <span style="font-weight:600;">${progress} / ${config.target}%</span>
                    </div>
                    <div style="height:20px;background:#e2e8f0;border-radius:10px;overflow:hidden;">
                        <div style="height:100%;width:${pct}%;background:linear-gradient(90deg,#3b82f6,#10b981);border-radius:10px;transition:width 0.5s;"></div>
                    </div>
                </div>
            `;
                    break;

                case 'countdown':
                    const deadline = currentProject.dates?.deadline;
                    if (deadline) {
                        const dlDate = new Date(deadline);
                        const today = new Date();
                        const days = Math.ceil((dlDate - today) / (1000 * 60 * 60 * 24));
                        const color = days < 0 ? '#ef4444' : days <= 7 ? '#f59e0b' : '#10b981';
                        container.innerHTML = `
                    <div style="text-align:center;padding:20px;">
                        <div style="font-size:48px;font-weight:800;color:${color};">${days < 0 ? Math.abs(days) : days}</div>
                        <div style="font-size:14px;color:#64748b;margin-top:4px;">${days < 0 ? 'days overdue' : 'days remaining'}</div>
                        <div style="font-size:12px;color:#94a3b8;margin-top:8px;">Deadline: ${deadline}</div>
                    </div>
                `;
                    } else {
                        container.innerHTML = '<div style="text-align:center;padding:20px;color:#94a3b8;">No deadline set</div>';
                    }
                    break;

                case 'item-list':
                    let filtered = filterItems(items, config.filter);
                    filtered = filtered.slice(0, config.limit || 10);
                    if (filtered.length === 0) {
                        container.innerHTML = '<div style="text-align:center;padding:20px;color:#94a3b8;">No items found</div>';
                    } else {
                        container.innerHTML = `
                    <div style="max-height:200px;overflow:auto;">
                        <table class="rfq-table" style="font-size:11px;">
                            <thead><tr>
                                ${config.columns?.includes('part_no_') ? '<th>Part No.</th>' : ''}
                                ${config.columns?.includes('description') ? '<th>Description</th>' : ''}
                                ${config.columns?.includes('qty') ? '<th>Qty</th>' : ''}
                                ${config.columns?.includes('price') ? '<th>Price</th>' : ''}
                                ${config.columns?.includes('supplier') ? '<th>Supplier</th>' : ''}
                                ${config.columns?.includes('status') ? '<th>Status</th>' : ''}
                            </tr></thead>
                            <tbody>
                                ${filtered.map(it => `<tr>
                                    ${config.columns?.includes('part_no_') ? `<td>${escapeHtml(it.item_drawing_no || it.part_no || '‚Äî')}</td>` : ''}
                                    ${config.columns?.includes('description') ? `<td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;">${escapeHtml((it.description || '').substring(0, 40))}</td>` : ''}
                                    ${config.columns?.includes('qty') ? `<td>${it.qty_1 || 0}</td>` : ''}
                                    ${config.columns?.includes('price') ? `<td>‚Ç¨${(parseFloat(it.price_1) || 0).toFixed(2)}</td>` : ''}
                                    ${config.columns?.includes('supplier') ? `<td>${escapeHtml(it.main_supplier || '‚Äî')}</td>` : ''}
                                    ${config.columns?.includes('status') ? `<td><span class="status-badge">${escapeHtml(it.status || '‚Äî')}</span></td>` : ''}
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                    }
                    break;

                case 'quick-actions':
                    const actionBtns = {
                        'add_item': { label: '‚ûï Add Item', fn: 'document.getElementById("btn-add-item")?.click()' },
                        'export_excel': { label: 'üì• Export Excel', fn: 'document.getElementById("btn-export-excel")?.click()' },
                        'recalculate': { label: 'üîÑ Recalculate', fn: 'document.getElementById("btn-recalculate-all")?.click()' },
                        'add_note': { label: 'üìù Add Note', fn: 'document.getElementById("btn-dash-add-note")?.click()' },
                        'send_rfq': { label: 'üìß Send RFQ', fn: 'window.switchView && switchView("quoting")' },
                        'import_prices': { label: 'üì§ Import', fn: 'document.getElementById("file-import-targets")?.click()' }
                    };
                    container.innerHTML = `
                <div style="display:flex;flex-wrap:wrap;gap:8px;padding:8px;">
                    ${(config.actions || []).map(a => `
                        <button onclick="${actionBtns[a]?.fn}" class="btn-secondary" style="padding:8px 14px;font-size:12px;">
                            ${actionBtns[a]?.label || a}
                        </button>
                    `).join('')}
                </div>
            `;
                    break;

                case 'text-block':
                    container.innerHTML = `<div style="padding:10px;font-size:13px;color:#334155;">${config.content || ''}</div>`;
                    break;

                case 'recent-activity':
                    const activities = collectRecentActivity(config.limit || 5);
                    if (activities.length === 0) {
                        container.innerHTML = '<div style="text-align:center;padding:20px;color:#94a3b8;">No recent activity</div>';
                    } else {
                        container.innerHTML = `
                    <div style="max-height:200px;overflow:auto;">
                        ${activities.map(a => `
                            <div style="padding:8px 12px;border-bottom:1px solid #f1f5f9;font-size:12px;">
                                <span style="color:#64748b;">${a.time}</span>
                                <span style="margin-left:8px;">${a.icon} ${escapeHtml(a.text)}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
                    }
                    break;

                case 'supplier-list':
                    const supStats = collectSupplierStats(items);
                    let sorted = Object.entries(supStats);
                    if (config.sortBy === 'value') sorted.sort((a, b) => b[1].value - a[1].value);
                    else if (config.sortBy === 'name') sorted.sort((a, b) => a[0].localeCompare(b[0]));
                    else sorted.sort((a, b) => b[1].count - a[1].count);
                    sorted = sorted.slice(0, config.limit || 10);
                    container.innerHTML = `
                <div style="max-height:200px;overflow:auto;">
                    ${sorted.map(([name, stats]) => `
                        <div style="display:flex;justify-content:space-between;padding:8px 12px;border-bottom:1px solid #f1f5f9;font-size:12px;">
                            <span style="font-weight:500;">${escapeHtml(name)}</span>
                            <span style="color:#64748b;">${stats.count} items ¬∑ ‚Ç¨${stats.value.toFixed(0)}</span>
                        </div>
                    `).join('')}
                </div>
            `;
                    break;

                case 'chart-pie':
                case 'chart-bar':
                    container.innerHTML = `<div style="text-align:center;padding:30px;color:#94a3b8;">Chart will render after save</div>`;
                    break;

                case 'countdown-custom':
                    if (config.targetDate) {
                        const targetDt = new Date(config.targetDate);
                        const today = new Date();
                        const daysLeft = Math.ceil((targetDt - today) / (1000 * 60 * 60 * 24));
                        const color = daysLeft < 0 ? '#ef4444' : daysLeft <= 7 ? '#f59e0b' : '#10b981';
                        container.innerHTML = `
                    <div style="text-align:center;padding:20px;">
                        <div style="font-size:48px;font-weight:800;color:${color};">${daysLeft < 0 ? Math.abs(daysLeft) : daysLeft}</div>
                        <div style="font-size:14px;color:#64748b;margin-top:4px;">${daysLeft < 0 ? 'days past' : 'days until'}</div>
                        <div style="font-size:13px;font-weight:600;color:#334155;margin-top:8px;">${escapeHtml(config.eventLabel || 'Event')}</div>
                        <div style="font-size:11px;color:#94a3b8;margin-top:4px;">${config.targetDate}</div>
                    </div>
                `;
                    }
                    break;

                case 'todo-list':
                    const todos = config.todos || [];
                    container.innerHTML = `
                <div style="padding:8px;">
                    <div style="display:flex;gap:8px;margin-bottom:12px;">
                        <input type="text" id="todo-input-${config.id}" class="rfq-input" style="flex:1;padding:8px 10px;font-size:12px;" placeholder="Add new task...">
                        <button onclick="addTodoItem('${config.id}')" class="btn-primary" style="padding:8px 12px;font-size:12px;">+</button>
                    </div>
                    <div id="todo-list-${config.id}" style="max-height:180px;overflow:auto;">
                        ${todos.map((t, i) => `
                            <div style="display:flex;align-items:center;gap:8px;padding:8px;border-bottom:1px solid #f1f5f9;${t.done ? 'opacity:0.5;' : ''}">
                                <input type="checkbox" ${t.done ? 'checked' : ''} onchange="toggleTodoItem('${config.id}', ${i})">
                                <span style="flex:1;font-size:12px;${t.done ? 'text-decoration:line-through;' : ''}">${escapeHtml(t.text)}</span>
                                <button onclick="deleteTodoItem('${config.id}', ${i})" style="background:none;border:none;color:#ef4444;cursor:pointer;font-size:14px;">√ó</button>
                            </div>
                        `).join('')}
                        ${todos.length === 0 ? '<div style="text-align:center;padding:20px;color:#94a3b8;font-size:12px;">No tasks yet</div>' : ''}
                    </div>
                    <div style="margin-top:8px;font-size:11px;color:#64748b;">
                        ${todos.filter(t => t.done).length}/${todos.length} completed
                    </div>
                </div>
            `;
                    break;

                case 'supplier-contacts':
                    const contacts = collectSupplierContacts(items, config.limit || 5);
                    if (contacts.length === 0) {
                        container.innerHTML = '<div style="text-align:center;padding:20px;color:#94a3b8;">No supplier contacts found</div>';
                    } else {
                        container.innerHTML = `
                    <div style="max-height:220px;overflow:auto;">
                        ${contacts.map(c => `
                            <div style="padding:10px;border-bottom:1px solid #f1f5f9;display:flex;align-items:center;gap:10px;">
                                <div style="width:36px;height:36px;background:${c.color};border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:600;font-size:14px;">
                                    ${c.initials}
                                </div>
                                <div style="flex:1;min-width:0;">
                                    <div style="font-size:13px;font-weight:600;color:#1e293b;">${escapeHtml(c.name)}</div>
                                    <div style="font-size:11px;color:#64748b;">${c.items} items ¬∑ ‚Ç¨${c.value.toFixed(0)}</div>
                                </div>
                                ${c.email ? `<a href="mailto:${escapeHtml(c.email)}" style="font-size:18px;" title="${escapeHtml(c.email)}">üìß</a>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
                    }
                    break;

                case 'last-quotes':
                    const quotes = collectLastQuotes(items, config.limit || 5);
                    if (quotes.length === 0) {
                        container.innerHTML = '<div style="text-align:center;padding:20px;color:#94a3b8;">No quotes received yet</div>';
                    } else {
                        container.innerHTML = `
                    <div style="max-height:220px;overflow:auto;">
                        ${quotes.map(q => `
                            <div style="padding:10px;border-bottom:1px solid #f1f5f9;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <span style="font-size:12px;font-weight:600;color:#1e293b;">${escapeHtml(q.partNo)}</span>
                                    <span style="font-size:14px;font-weight:700;color:#10b981;">‚Ç¨${q.price.toFixed(2)}</span>
                                </div>
                                <div style="font-size:11px;color:#64748b;margin-top:2px;">
                                    ${escapeHtml(q.supplier)} ¬∑ Qty: ${q.qty}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                    }
                    break;

                case 'currency-rates':
                    const rates = getCurrencyRates(config.currencies || ['USD', 'CZK']);
                    container.innerHTML = `
                <div style="padding:8px;">
                    <div style="display:grid;grid-template-columns:repeat(${Math.min(rates.length, 3)},1fr);gap:10px;">
                        ${rates.map(r => `
                            <div style="text-align:center;padding:12px;background:#f8fafc;border-radius:8px;">
                                <div style="font-size:11px;color:#64748b;margin-bottom:4px;">1 EUR =</div>
                                <div style="font-size:20px;font-weight:700;color:#1e293b;">${r.rate}</div>
                                <div style="font-size:13px;font-weight:600;color:#3b82f6;">${r.currency}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div style="text-align:center;font-size:10px;color:#94a3b8;margin-top:8px;">
                        Rates are approximate
                    </div>
                </div>
            `;
                    break;

                case 'gauge':
                    const gaugeVal = calculateMetric(config.metric, items);
                    const gaugePct = typeof gaugeVal === 'string' ? parseFloat(gaugeVal) : gaugeVal;
                    const gaugeColor = config.color || '#3b82f6';
                    container.innerHTML = `
                <div style="text-align:center;padding:15px;">
                    <div style="position:relative;width:120px;height:60px;margin:0 auto;overflow:hidden;">
                        <div style="position:absolute;width:120px;height:120px;border-radius:50%;border:12px solid #e2e8f0;border-bottom-color:transparent;border-left-color:transparent;transform:rotate(45deg);"></div>
                        <div style="position:absolute;width:120px;height:120px;border-radius:50%;border:12px solid ${gaugeColor};border-bottom-color:transparent;border-left-color:transparent;transform:rotate(${45 + (gaugePct * 1.8)}deg);clip-path:inset(0 0 50% 0);"></div>
                    </div>
                    <div style="font-size:28px;font-weight:800;color:${gaugeColor};margin-top:10px;">${gaugeVal}</div>
                    <div style="font-size:11px;color:#64748b;">${METRIC_OPTIONS.find(m => m.value === config.metric)?.label || config.metric}</div>
                </div>
            `;
                    break;

                case 'calculator':
                    container.innerHTML = `
                <div style="padding:10px;">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
                        <div>
                            <label style="font-size:11px;color:#64748b;">Unit Price</label>
                            <input type="number" id="calc-price-${config.id}" class="rfq-input" style="width:100%;padding:8px;" placeholder="0.00" oninput="updateCalculator('${config.id}')">
                        </div>
                        <div>
                            <label style="font-size:11px;color:#64748b;">Quantity</label>
                            <input type="number" id="calc-qty-${config.id}" class="rfq-input" style="width:100%;padding:8px;" placeholder="1" value="1" oninput="updateCalculator('${config.id}')">
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
                        <div>
                            <label style="font-size:11px;color:#64748b;">Margin %</label>
                            <input type="number" id="calc-margin-${config.id}" class="rfq-input" style="width:100%;padding:8px;" placeholder="20" value="20" oninput="updateCalculator('${config.id}')">
                        </div>
                        <div>
                            <label style="font-size:11px;color:#64748b;">Discount %</label>
                            <input type="number" id="calc-discount-${config.id}" class="rfq-input" style="width:100%;padding:8px;" placeholder="0" value="0" oninput="updateCalculator('${config.id}')">
                        </div>
                    </div>
                    <div style="background:#f8fafc;padding:12px;border-radius:8px;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                            <span style="font-size:12px;color:#64748b;">Total:</span>
                            <span id="calc-total-${config.id}" style="font-size:14px;font-weight:700;color:#1e293b;">‚Ç¨0.00</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;">
                            <span style="font-size:12px;color:#64748b;">With Margin:</span>
                            <span id="calc-with-margin-${config.id}" style="font-size:14px;font-weight:700;color:#10b981;">‚Ç¨0.00</span>
                        </div>
                    </div>
                </div>
            `;
                    break;

                case 'project-summary':
                    const proj = currentProject;
                    const d = proj.dates || {};
                    container.innerHTML = `
                <div style="padding:8px;font-size:12px;">
                    <div style="display:grid;grid-template-columns:auto 1fr;gap:8px 12px;">
                        <span style="color:#64748b;">Name:</span><span style="font-weight:600;">${escapeHtml(proj.name || '‚Äî')}</span>
                        <span style="color:#64748b;">Status:</span><span style="font-weight:600;">${escapeHtml(proj.project_status || '‚Äî')}</span>
                        <span style="color:#64748b;">Items:</span><span style="font-weight:600;">${items.length}</span>
                        <span style="color:#64748b;">Received:</span><span>${d.received || '‚Äî'}</span>
                        <span style="color:#64748b;">Deadline:</span><span style="font-weight:600;color:#ef4444;">${d.deadline || '‚Äî'}</span>
                        <span style="color:#64748b;">Total Value:</span><span style="font-weight:600;color:#10b981;">${calculateMetric('total_value', items)}</span>
                    </div>
                </div>
            `;
                    break;

                case 'status-overview':
                    const statusCounts = {};
                    items.forEach(it => {
                        const st = it.status || 'Unknown';
                        statusCounts[st] = (statusCounts[st] || 0) + 1;
                    });
                    const total = items.length || 1;
                    const statusColors = {
                        'Done': '#10b981', 'Completed': '#10b981',
                        'In Progress': '#3b82f6', 'Active': '#3b82f6',
                        'Issue': '#ef4444', 'Problem': '#ef4444',
                        'Pending': '#f59e0b', 'Waiting': '#f59e0b'
                    };
                    container.innerHTML = `
                <div style="padding:8px;">
                    ${Object.entries(statusCounts).map(([status, count]) => {
                        const pct = Math.round((count / total) * 100);
                        const color = statusColors[status] || '#64748b';
                        return `
                            <div style="margin-bottom:10px;">
                                <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px;">
                                    <span style="font-weight:500;">${escapeHtml(status)}</span>
                                    <span style="color:#64748b;">${count} (${pct}%)</span>
                                </div>
                                <div style="height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden;">
                                    <div style="height:100%;width:${pct}%;background:${color};border-radius:4px;"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
                    break;
            }
        }

        function calculateMetric(metric, items, filter = 'all') {
            let filtered = filter ? filterItems(items, filter) : items;

            switch (metric) {
                case 'items_total': return filtered.length;
                case 'items_quoted': return filtered.filter(i => parseFloat(i.price_1) > 0).length;
                case 'items_issue': return filtered.filter(i => (i.status || '').toLowerCase().includes('issue')).length;
                case 'items_done': return filtered.filter(i => (i.status || '').toLowerCase().includes('done')).length;
                case 'suppliers_count':
                    const sups = new Set();
                    filtered.forEach(i => { if (i.main_supplier) sups.add(i.main_supplier); });
                    return sups.size;
                case 'total_value':
                    return '‚Ç¨' + filtered.reduce((s, i) => s + (parseFloat(i.price_1) || 0) * (parseFloat(i.qty_1) || 0), 0).toFixed(0);
                case 'avg_price':
                    const prices = filtered.map(i => parseFloat(i.price_1) || 0).filter(p => p > 0);
                    return '‚Ç¨' + (prices.length ? (prices.reduce((a, b) => a + b, 0) / prices.length).toFixed(2) : '0');
                case 'quote_rate':
                    const quoted = filtered.filter(i => parseFloat(i.price_1) > 0).length;
                    return filtered.length ? Math.round((quoted / filtered.length) * 100) + '%' : '0%';
                case 'target_total':
                    return '‚Ç¨' + filtered.reduce((s, i) => s + (parseFloat(i.target_price) || 0) * (parseFloat(i.qty_1) || 0), 0).toFixed(0);
                case 'savings':
                    const target = filtered.reduce((s, i) => s + (parseFloat(i.target_price) || 0) * (parseFloat(i.qty_1) || 0), 0);
                    const actual = filtered.reduce((s, i) => s + (parseFloat(i.price_1) || 0) * (parseFloat(i.qty_1) || 0), 0);
                    return '‚Ç¨' + (target - actual).toFixed(0);
                case 'savings_pct':
                    const t = filtered.reduce((s, i) => s + (parseFloat(i.target_price) || 0) * (parseFloat(i.qty_1) || 0), 0);
                    const a = filtered.reduce((s, i) => s + (parseFloat(i.price_1) || 0) * (parseFloat(i.qty_1) || 0), 0);
                    return t > 0 ? Math.round(((t - a) / t) * 100) + '%' : '0%';

                // New metrics
                case 'items_no_quote': return filtered.filter(i => !parseFloat(i.price_1)).length;
                case 'items_in_progress': return filtered.filter(i => (i.status || '').toLowerCase().includes('progress')).length;
                case 'items_pending': return filtered.filter(i => (i.status || '').toLowerCase().includes('pending')).length;
                case 'items_with_supplier': return filtered.filter(i => i.main_supplier).length;
                case 'items_no_supplier': return filtered.filter(i => !i.main_supplier).length;

                case 'suppliers_with_quotes':
                    const swq = new Set();
                    filtered.forEach(i => { if (i.main_supplier && parseFloat(i.price_1) > 0) swq.add(i.main_supplier); });
                    return swq.size;

                case 'avg_suppliers_per_item':
                    let totalSups = 0;
                    filtered.forEach(i => { totalSups += (Array.isArray(i.suppliers) ? i.suppliers.length : 0); });
                    return filtered.length ? (totalSups / filtered.length).toFixed(1) : '0';

                case 'total_value_qty1':
                    return '‚Ç¨' + filtered.reduce((s, i) => s + (parseFloat(i.price_1) || 0) * (parseFloat(i.qty_1) || 0), 0).toFixed(0);
                case 'total_value_qty2':
                    return '‚Ç¨' + filtered.reduce((s, i) => s + (parseFloat(i.price_2) || 0) * (parseFloat(i.qty_2) || 0), 0).toFixed(0);
                case 'total_value_qty3':
                    return '‚Ç¨' + filtered.reduce((s, i) => s + (parseFloat(i.price_3) || 0) * (parseFloat(i.qty_3) || 0), 0).toFixed(0);

                case 'max_price':
                    const maxP = Math.max(...filtered.map(i => parseFloat(i.price_1) || 0));
                    return '‚Ç¨' + (maxP || 0).toFixed(2);
                case 'min_price':
                    const nonZero = filtered.map(i => parseFloat(i.price_1) || 0).filter(p => p > 0);
                    return '‚Ç¨' + (nonZero.length ? Math.min(...nonZero).toFixed(2) : '0');
                case 'median_price':
                    const sortedP = filtered.map(i => parseFloat(i.price_1) || 0).filter(p => p > 0).sort((a, b) => a - b);
                    const mid = Math.floor(sortedP.length / 2);
                    return '‚Ç¨' + (sortedP.length ? (sortedP.length % 2 ? sortedP[mid] : (sortedP[mid - 1] + sortedP[mid]) / 2).toFixed(2) : '0');

                case 'over_target': return filtered.filter(i => (parseFloat(i.price_1) || 0) > (parseFloat(i.target_price) || Infinity)).length;
                case 'under_target': return filtered.filter(i => (parseFloat(i.price_1) || 0) > 0 && (parseFloat(i.price_1) || 0) <= (parseFloat(i.target_price) || 0)).length;
                case 'budget_remaining':
                    const budgetTarget = filtered.reduce((s, i) => s + (parseFloat(i.target_price) || 0) * (parseFloat(i.qty_1) || 0), 0);
                    const budgetActual = filtered.reduce((s, i) => s + (parseFloat(i.price_1) || 0) * (parseFloat(i.qty_1) || 0), 0);
                    return '‚Ç¨' + (budgetTarget - budgetActual).toFixed(0);

                case 'completion_rate':
                    const done = filtered.filter(i => (i.status || '').toLowerCase().includes('done') || (i.status || '').toLowerCase().includes('completed')).length;
                    return filtered.length ? Math.round((done / filtered.length) * 100) + '%' : '0%';
                case 'issue_rate':
                    const issues = filtered.filter(i => (i.status || '').toLowerCase().includes('issue')).length;
                    return filtered.length ? Math.round((issues / filtered.length) * 100) + '%' : '0%';
                case 'supplier_coverage':
                    const withSup = filtered.filter(i => i.main_supplier).length;
                    return filtered.length ? Math.round((withSup / filtered.length) * 100) + '%' : '0%';

                case 'total_qty1': return filtered.reduce((s, i) => s + (parseFloat(i.qty_1) || 0), 0);
                case 'total_qty2': return filtered.reduce((s, i) => s + (parseFloat(i.qty_2) || 0), 0);
                case 'total_qty3': return filtered.reduce((s, i) => s + (parseFloat(i.qty_3) || 0), 0);
                case 'unique_parts':
                    const parts = new Set();
                    filtered.forEach(i => { if (i.item_drawing_no || i.part_no) parts.add(i.item_drawing_no || i.part_no); });
                    return parts.size;

                case 'days_to_deadline':
                    if (currentProject?.dates?.deadline) {
                        const dl = new Date(currentProject.dates.deadline);
                        const now = new Date();
                        return Math.ceil((dl - now) / (1000 * 60 * 60 * 24));
                    }
                    return '‚Äî';
                case 'project_age':
                    if (currentProject?.created_at) {
                        const created = new Date(currentProject.created_at);
                        const now = new Date();
                        return Math.floor((now - created) / (1000 * 60 * 60 * 24));
                    }
                    return '‚Äî';
                case 'avg_lead_time':
                    const leadTimes = filtered.map(i => parseFloat(i.lead_time) || 0).filter(l => l > 0);
                    return leadTimes.length ? Math.round(leadTimes.reduce((a, b) => a + b, 0) / leadTimes.length) : '‚Äî';

                default: return '‚Äî';
            }
        }

        function filterItems(items, filter) {
            if (!filter || filter === 'all') return items;
            switch (filter) {
                case 'status_issue': return items.filter(i => (i.status || '').toLowerCase().includes('issue'));
                case 'status_done': return items.filter(i => (i.status || '').toLowerCase().includes('done') || (i.status || '').toLowerCase().includes('completed'));
                case 'status_progress': return items.filter(i => (i.status || '').toLowerCase().includes('progress'));
                case 'status_pending': return items.filter(i => (i.status || '').toLowerCase().includes('pending'));
                case 'status_cancelled': return items.filter(i => (i.status || '').toLowerCase().includes('cancel'));
                case 'has_quote': return items.filter(i => parseFloat(i.price_1) > 0);
                case 'no_quote': return items.filter(i => !parseFloat(i.price_1));
                case 'has_supplier': return items.filter(i => i.main_supplier);
                case 'no_supplier': return items.filter(i => !i.main_supplier);
                case 'over_target': return items.filter(i => (parseFloat(i.price_1) || 0) > (parseFloat(i.target_price) || Infinity));
                case 'under_target': return items.filter(i => (parseFloat(i.price_1) || 0) > 0 && (parseFloat(i.price_1) || 0) <= (parseFloat(i.target_price) || 0));
                case 'high_value': return items.filter(i => (parseFloat(i.price_1) || 0) * (parseFloat(i.qty_1) || 0) > 1000);
                case 'medium_value': return items.filter(i => {
                    const v = (parseFloat(i.price_1) || 0) * (parseFloat(i.qty_1) || 0);
                    return v >= 100 && v <= 1000;
                });
                case 'low_value': return items.filter(i => (parseFloat(i.price_1) || 0) * (parseFloat(i.qty_1) || 0) < 100);
                case 'recently_updated': return items.filter(i => {
                    if (!i.updated_at) return false;
                    const updated = new Date(i.updated_at);
                    const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                    return updated >= weekAgo;
                });
                case 'has_comments': return items.filter(i => Array.isArray(i.comments) && i.comments.length > 0);
                default: return items;
            }
        }

        function collectRecentActivity(limit) {
            if (!currentProject) return [];
            const activities = [];

            // Collect from project notes
            (currentProject.project_notes || []).forEach(n => {
                activities.push({
                    time: new Date(n.created_at).toLocaleDateString(),
                    icon: 'üìù',
                    text: 'Note: ' + (n.text || '').substring(0, 50),
                    timestamp: new Date(n.created_at).getTime()
                });
            });

            // Collect from item comments
            (currentProject.items || []).forEach(item => {
                (item.comments || []).forEach(c => {
                    activities.push({
                        time: new Date(c.timestamp).toLocaleDateString(),
                        icon: 'üí¨',
                        text: `Comment on ${item.item_drawing_no || 'item'}`,
                        timestamp: new Date(c.timestamp).getTime()
                    });
                });
            });

            activities.sort((a, b) => b.timestamp - a.timestamp);
            return activities.slice(0, limit);
        }

        function collectSupplierStats(items) {
            const stats = {};
            items.forEach(item => {
                const sup = item.main_supplier || 'Unknown';
                if (!stats[sup]) stats[sup] = { count: 0, value: 0 };
                stats[sup].count++;
                stats[sup].value += (parseFloat(item.price_1) || 0) * (parseFloat(item.qty_1) || 0);
            });
            return stats;
        }

        function collectSupplierContacts(items, limit) {
            const suppliers = {};
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4'];

            items.forEach(item => {
                const supName = item.main_supplier;
                if (!supName) return;

                if (!suppliers[supName]) {
                    suppliers[supName] = {
                        name: supName,
                        items: 0,
                        value: 0,
                        email: null,
                        initials: supName.split(/\s+/).map(w => w[0]).join('').toUpperCase().substring(0, 2),
                        color: colors[Object.keys(suppliers).length % colors.length]
                    };
                }
                suppliers[supName].items++;
                suppliers[supName].value += (parseFloat(item.price_1) || 0) * (parseFloat(item.qty_1) || 0);

                // Try to get email from supplier data
                if (Array.isArray(item.suppliers)) {
                    item.suppliers.forEach(s => {
                        if ((s.name === supName || s.supplier === supName) && s.email) {
                            suppliers[supName].email = s.email;
                        }
                    });
                }
            });

            return Object.values(suppliers)
                .sort((a, b) => b.value - a.value)
                .slice(0, limit);
        }

        function collectLastQuotes(items, limit) {
            const quotes = [];

            items.forEach(item => {
                if (parseFloat(item.price_1) > 0) {
                    quotes.push({
                        partNo: item.item_drawing_no || item.part_no || 'Unknown',
                        price: parseFloat(item.price_1) || 0,
                        qty: parseFloat(item.qty_1) || 0,
                        supplier: item.main_supplier || 'Unknown',
                        timestamp: item.quote_date || item.updated_at || 0
                    });
                }
            });

            // Sort by timestamp (most recent first) or just return as-is if no timestamp
            quotes.sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0));
            return quotes.slice(0, limit);
        }

        function getCurrencyRates(currencies) {
            // Approximate exchange rates (EUR base) - in production, use API
            const ratesData = {
                'USD': 1.08,
                'GBP': 0.86,
                'CZK': 25.20,
                'PLN': 4.32,
                'CHF': 0.95,
                'JPY': 162.50,
                'CNY': 7.85
            };

            return currencies.map(cur => ({
                currency: cur,
                rate: ratesData[cur] ? ratesData[cur].toFixed(2) : '‚Äî'
            }));
        }

        // TODO List Functions
        window.addTodoItem = function (boxId) {
            const input = document.getElementById('todo-input-' + boxId);
            if (!input || !input.value.trim()) return;

            const box = document.querySelector(`[data-box-id="${boxId}"]`);
            if (!box) return;

            try {
                const config = JSON.parse(box.dataset.boxConfig || '{}');
                if (!config.todos) config.todos = [];
                config.todos.push({ text: input.value.trim(), done: false });
                box.dataset.boxConfig = JSON.stringify(config);
                input.value = '';
                renderCustomBoxContent(config);
                saveCustomBoxes();
            } catch (e) { console.warn('addTodoItem error:', e); }
        };

        window.toggleTodoItem = function (boxId, index) {
            const box = document.querySelector(`[data-box-id="${boxId}"]`);
            if (!box) return;

            try {
                const config = JSON.parse(box.dataset.boxConfig || '{}');
                if (config.todos && config.todos[index] !== undefined) {
                    config.todos[index].done = !config.todos[index].done;
                    box.dataset.boxConfig = JSON.stringify(config);
                    renderCustomBoxContent(config);
                    saveCustomBoxes();
                }
            } catch (e) { console.warn('toggleTodoItem error:', e); }
        };

        window.deleteTodoItem = function (boxId, index) {
            const box = document.querySelector(`[data-box-id="${boxId}"]`);
            if (!box) return;

            try {
                const config = JSON.parse(box.dataset.boxConfig || '{}');
                if (config.todos) {
                    config.todos.splice(index, 1);
                    box.dataset.boxConfig = JSON.stringify(config);
                    renderCustomBoxContent(config);
                    saveCustomBoxes();
                }
            } catch (e) { console.warn('deleteTodoItem error:', e); }
        };

        // Calculator Functions
        window.updateCalculator = function (boxId) {
            const price = parseFloat(document.getElementById('calc-price-' + boxId)?.value) || 0;
            const qty = parseFloat(document.getElementById('calc-qty-' + boxId)?.value) || 1;
            const margin = parseFloat(document.getElementById('calc-margin-' + boxId)?.value) || 0;
            const discount = parseFloat(document.getElementById('calc-discount-' + boxId)?.value) || 0;

            const total = price * qty;
            const afterDiscount = total * (1 - discount / 100);
            const withMargin = afterDiscount * (1 + margin / 100);

            const elTotal = document.getElementById('calc-total-' + boxId);
            const elWithMargin = document.getElementById('calc-with-margin-' + boxId);

            if (elTotal) elTotal.textContent = '‚Ç¨' + afterDiscount.toFixed(2);
            if (elWithMargin) elWithMargin.textContent = '‚Ç¨' + withMargin.toFixed(2);
        };

        function saveCustomBoxes() {
            const grid = document.getElementById('dashboard-grid');
            if (!grid) return;

            const customBoxes = [];
            grid.querySelectorAll('.dash-box[data-custom-box="true"]').forEach(box => {
                try {
                    const config = JSON.parse(box.dataset.boxConfig || '{}');
                    config.colSpan = box.dataset.colSpan;
                    config.hidden = box.classList.contains('hidden-box');
                    customBoxes.push(config);
                } catch (e) { }
            });

            localStorage.setItem('rfq_custom_boxes', JSON.stringify(customBoxes));
        }

        function loadCustomBoxes() {
            const saved = localStorage.getItem('rfq_custom_boxes');
            if (!saved) return;

            try {
                const boxes = JSON.parse(saved);
                boxes.forEach(config => {
                    createCustomBox(config.type, config);
                    const box = document.querySelector(`[data-box-id="${config.id}"]`);
                    if (box) {
                        if (config.colSpan) {
                            box.dataset.colSpan = config.colSpan;
                            updateBoxGridStyle(box);
                        }
                        if (config.hidden) box.classList.add('hidden-box');
                    }
                });
            } catch (e) {
                console.warn('Failed to load custom boxes:', e);
            }
        }

        function refreshCustomBoxes() {
            document.querySelectorAll('.dash-box[data-custom-box="true"]').forEach(box => {
                try {
                    const config = JSON.parse(box.dataset.boxConfig || '{}');
                    renderCustomBoxContent(config);
                } catch (e) { }
            });
        }

        // Add delete handler for custom boxes
        window.deleteCustomBox = async function (boxId) {
            const box = document.querySelector(`[data-box-id="${boxId}"]`);
            if (box && box.dataset.customBox === 'true') {
                const confirmed = await window.showConfirmDialog({
                    title: 'Delete Box',
                    message: 'Delete this custom box?',
                    type: 'danger',
                    okText: 'Delete',
                    cancelText: 'Cancel'
                });
                if (confirmed) {
                    box.remove();
                    saveCustomBoxes();
                    if (window.showToast) window.showToast('Box deleted', 'success');
                }
            }
        };

        // Note: Delete functionality is handled by direct addEventListener in createCustomBox

        function initDashboardDragDrop() {
            const grid = document.getElementById('dashboard-grid');
            if (!grid) return;

            const boxes = grid.querySelectorAll('.dash-box');
            let draggedBox = null;

            boxes.forEach(box => {
                const handle = box.querySelector('.dash-box-drag-handle');

                // Make draggable
                box.draggable = true;

                box.ondragstart = (e) => {
                    if (!dashboardEditMode) { e.preventDefault(); return; }
                    draggedBox = box;
                    box.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', box.dataset.boxId);
                };

                box.ondragend = () => {
                    box.classList.remove('dragging');
                    draggedBox = null;
                    boxes.forEach(b => b.classList.remove('drag-over'));
                };

                box.ondragover = (e) => {
                    if (!dashboardEditMode || !draggedBox || draggedBox === box) return;
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    box.classList.add('drag-over');
                };

                box.ondragleave = () => {
                    box.classList.remove('drag-over');
                };

                box.ondrop = (e) => {
                    e.preventDefault();
                    box.classList.remove('drag-over');
                    if (!draggedBox || draggedBox === box) return;

                    // Swap positions
                    const allBoxes = Array.from(grid.querySelectorAll('.dash-box'));
                    const draggedIdx = allBoxes.indexOf(draggedBox);
                    const targetIdx = allBoxes.indexOf(box);

                    if (draggedIdx < targetIdx) {
                        box.parentNode.insertBefore(draggedBox, box.nextSibling);
                    } else {
                        box.parentNode.insertBefore(draggedBox, box);
                    }
                };

                // Size controls and actions
                const controls = box.querySelectorAll('.dash-box-btn');
                controls.forEach(btn => {
                    btn.onclick = (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        const action = btn.dataset.action;

                        if (action === 'resize-smaller') {
                            // Sizes: 4 (full) -> 2 (half) -> 1 (quarter)
                            const current = parseInt(box.dataset.colSpan) || 2;
                            if (current === 4) {
                                box.dataset.colSpan = 2;
                            } else if (current === 2) {
                                box.dataset.colSpan = 1;
                            }
                            updateBoxGridStyle(box);
                        } else if (action === 'resize-larger') {
                            // Sizes: 1 (quarter) -> 2 (half) -> 4 (full)
                            const current = parseInt(box.dataset.colSpan) || 2;
                            if (current === 1) {
                                box.dataset.colSpan = 2;
                            } else if (current === 2) {
                                box.dataset.colSpan = 4;
                            }
                            updateBoxGridStyle(box);
                        } else if (action === 'toggle-visibility') {
                            box.classList.toggle('hidden-box');
                            btn.textContent = box.classList.contains('hidden-box') ? 'üëÅ‚Äçüó®' : 'üëÅ';
                        }
                        // Note: delete-box is handled by direct addEventListener in createCustomBox
                    };
                });
            });
        }

        // Bind Layout Edit button
        function bindDashboardLayoutButton() {
            const btn = document.getElementById('btn-dash-edit-layout');
            if (btn && !btn.dataset.bound) {
                btn.dataset.bound = '1';
                btn.onclick = toggleDashboardEditMode;
            }
        }

        // Initialize dashboard layout on load
        function initDashboardLayout() {
            loadDashboardLayout();
            loadCustomBoxes();
            bindDashboardLayoutButton();

            // Apply grid styles to all boxes
            const boxes = document.querySelectorAll('.dash-box');
            boxes.forEach(updateBoxGridStyle);
        }

        // Make functions globally available
        window.toggleDashboardEditMode = toggleDashboardEditMode;
        window.initDashboardLayout = initDashboardLayout;
        window.openAddBoxModal = openAddBoxModal;
        window.refreshCustomBoxes = refreshCustomBoxes;

        function initApp() {
            // Load projects from storage
            if (typeof getProjects === 'function') {
                projects = getProjects();
            }

            renderSidebar();
            setupEventListeners();
            // Fill Project Status selects (New/Edit/Dashboard)
            try { fillProjectStatusSelect(getEl('new-project-status'), 'Created'); } catch (e) { }
            try { fillProjectStatusSelect(getEl('edit-project-status'), getCurrentProjectStatus()); } catch (e) { }
            try { renderDashboardProjectStatus(); } catch (e) { }
            showEmptyState();
            generateManualEntryForm();
            updateMenuTime();
            setInterval(updateMenuTime, 1000);
            loadSessionInfo();

            // Initialize dashboard layout system
            try { initDashboardLayout(); } catch (e) { console.warn('Dashboard layout init:', e); }

            // 1. Read saved view state FIRST (before openProject overwrites it)
            let pendingViewRestore = null;
            try {
                const savedViewState = localStorage.getItem('rfq_current_view_state');
                if (savedViewState) {
                    const viewState = JSON.parse(savedViewState);
                    const isRecent = (Date.now() - viewState.timestamp) < 30 * 60 * 1000;
                    const restorable = ['dashboard', 'items', 'quoting', 'suppliers', 'project-suppliers', 'supplier-list', 'database', 'quotes', 'settings', 'export', 'main', 'data', 'samepart'];
                    if (isRecent && viewState.view && restorable.includes(viewState.view)) {
                        pendingViewRestore = viewState;
                    }
                }
            } catch (e) { console.warn('Could not read view state:', e); }

            // 2. Restore last active project
            const lastProjectId = localStorage.getItem('rfq_active_project_id');
            if (lastProjectId) {
                const found = projects.find(p => p.id === lastProjectId);
                if (found) {
                    currentProject = found;
                    openProject(found); // calls switchView('dashboard') internally
                }
            }

            // 3. Restore the saved view (overrides the dashboard set by openProject)
            if (pendingViewRestore) {
                // Global/main views reset project themselves, so always restore them
                const globalViews = ['main', 'supplier-list', 'database', 'quotes', 'settings', 'export'];
                const isGlobalView = globalViews.includes(pendingViewRestore.view);
                const sameProject = isGlobalView || !pendingViewRestore.projectId ||
                    (currentProject && pendingViewRestore.projectId === currentProject.id);
                if (sameProject) {
                    setTimeout(() => {
                        try { switchView(pendingViewRestore.view); } catch (e) { }
                    }, 50);
                }
            }

            // 4. If no active project, start on MAIN view
            if (!currentProject) {
                switchView('main');
                renderSidebarProjects();
                showEmptyState();
            }
        }

        function setupEventListeners() {
            const projectPicker = getEl('project-picker');
            const btnOpenProjectPicker = getEl('btn-open-project-picker');
            const btnCloseProjectPicker = getEl('btn-close-project-picker'); // Leave
            const btnOkProjectPicker = getEl('btn-project-picker-ok'); // OK

            const openProjectPicker = () => {
                if (!projectPicker) return;
                projectPickerIsOpen = true;
                projectPickerPendingId = currentProject ? currentProject.id : null;
                projectPicker.classList.remove('hidden');
                projectPicker.setAttribute('aria-hidden', 'false');
                renderSidebar(); // renders project list with pending selection
            };

            const closeProjectPicker = () => {
                if (!projectPicker) return;
                projectPickerIsOpen = false;
                projectPickerPendingId = null;
                projectPicker.classList.add('hidden');
                projectPicker.setAttribute('aria-hidden', 'true');
                renderSidebar(); // refresh active state
            };

            const applyProjectPickerSelection = () => {
                if (!projectPickerPendingId) return;
                const proj = (projects || []).find(p => String(p.id) === String(projectPickerPendingId));
                if (!proj) return;
                openProject(proj);
                closeProjectPicker();
            };

            if (btnOpenProjectPicker) btnOpenProjectPicker.onclick = openProjectPicker;
            if (btnCloseProjectPicker) btnCloseProjectPicker.onclick = closeProjectPicker;
            if (btnOkProjectPicker) btnOkProjectPicker.onclick = applyProjectPickerSelection;

            if (projectPicker) {
                projectPicker.addEventListener('click', (e) => {
                    if (e.target === projectPicker) closeProjectPicker();
                });
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && !projectPicker.classList.contains('hidden')) closeProjectPicker();
                });
            }
            // Navigation
            if (navMain) navMain.onclick = () => switchView('main');
            if (navData) navData.onclick = () => switchView('data');
            if (btnTopbarMain) btnTopbarMain.onclick = () => switchView('main');
            if (btnTopbarData) btnTopbarData.onclick = () => switchView('data');
            if (btnTopbarUploadQuote) btnTopbarUploadQuote.onclick = () => {
                try { switchView('suppliers'); } catch (e) { }
                setTimeout(() => {
                    const sel = getEl('bulk-supplier-select');
                    const supplierName = sel ? String(sel.value || '').trim() : '';
                    if (!supplierName) {
                        showToast('Select supplier in Suppliers ‚Üí Bulk Pricing first.', 'warning');
                        try { if (sel) sel.focus(); } catch (e) { }
                        return;
                    }
                    const b = getEl('btn-upload-bulk-quote');
                    if (b) b.click();
                }, 60);
            };
            if (navDashboard) navDashboard.onclick = () => switchView('dashboard');
            if (navItems) navItems.onclick = () => { closeAllNavDropdowns(); switchView('items'); };
            if (navSuppliers) navSuppliers.onclick = () => { closeAllNavDropdowns(); switchView('suppliers'); };
            if (navSupplierList) navSupplierList.onclick = () => { closeAllNavDropdowns(); switchView('supplier-list'); };
            if (navProjectSuppliers) navProjectSuppliers.onclick = () => { closeAllNavDropdowns(); switchView('project-suppliers'); };
            if (navSamepart) navSamepart.onclick = () => { closeAllNavDropdowns(); switchView('samepart'); };
            if (navExport) navExport.onclick = () => { closeAllNavDropdowns(); switchView('export'); };
            if (navQuoting) navQuoting.onclick = () => switchView('quoting');
            if (navDatabase) navDatabase.onclick = () => { closeAllNavDropdowns(); switchView('database'); };
            if (navQuotes) navQuotes.onclick = () => { closeAllNavDropdowns(); switchView('quotes'); };
            if (navSettings) navSettings.onclick = () => { closeAllNavDropdowns(); switchView('settings'); };
            if (navData) navData.onclick = () => { closeAllNavDropdowns(); switchView('data'); };

            // Initialize navigation dropdowns
            initNavDropdowns();

            // =========================================================
            // Navigation Dropdown Functions
            // =========================================================
            window.closeAllNavDropdowns = function () {
                document.querySelectorAll('.nav-dropdown.open').forEach(dd => dd.classList.remove('open'));
            };

            window.highlightDropdownParent = function (dropdownId) {
                const dropdown = document.getElementById(dropdownId);
                if (dropdown) {
                    const btn = dropdown.querySelector('.nav-dropdown-btn');
                    if (btn) btn.classList.add('active');
                }
            };

            // Global function to open new project modal
            window.openNewProjectModal = function () {
                const modal = document.getElementById('sheet-new-project');
                const input = document.getElementById('new-project-name');
                if (modal) {
                    modal.classList.remove('hidden');
                    if (input) input.focus();
                }
            };

            function initNavDropdowns() {
                const dropdowns = document.querySelectorAll('.nav-dropdown');
                dropdowns.forEach(dropdown => {
                    const btn = dropdown.querySelector('.nav-dropdown-btn');
                    if (btn && !btn.dataset.ddBound) {
                        btn.dataset.ddBound = '1';
                        btn.onclick = (e) => {
                            e.stopPropagation();
                            const isOpen = dropdown.classList.contains('open');
                            closeAllNavDropdowns();
                            if (!isOpen) {
                                dropdown.classList.add('open');
                            }
                        };
                    }
                });

                // Close dropdowns when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.nav-dropdown')) {
                        closeAllNavDropdowns();
                    }
                });

                // Close dropdowns on Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        closeAllNavDropdowns();
                    }
                });
            }

            // MAIN controls (global overview)
            const btnMainRefresh = getEl('btn-main-refresh');
            const btnMainExport = getEl('btn-main-export');
            const mainTableBody = getEl('main-projects-tbody');
            if (btnMainRefresh) btnMainRefresh.onclick = () => { try { renderMainOverview(); } catch (e) { console.error(e); } };
            if (btnMainExport) btnMainExport.onclick = () => { try { exportMainProjectsCSV(); } catch (e) { console.error(e); } };



            // DATA MANAGER controls
            const btnDataRefresh = getEl('btn-data-refresh');
            const btnDataExport = getEl('btn-data-export-json');
            const btnDataImport = getEl('btn-data-import-json');
            const btnDataReset = getEl('btn-data-reset');
            const fileDataImport = getEl('file-data-import');

            if (btnDataRefresh) btnDataRefresh.onclick = () => { try { renderDataManager(); } catch (e) { console.error(e); } };
            if (btnDataExport) btnDataExport.onclick = () => { try { dmExportBackup(); } catch (e) { console.error(e); } };
            if (btnDataImport) btnDataImport.onclick = () => { try { if (fileDataImport) fileDataImport.click(); } catch (e) { console.error(e); } };
            if (btnDataReset) btnDataReset.onclick = () => { try { dmResetAllRFQ(); } catch (e) { console.error(e); } };

            if (fileDataImport && !fileDataImport.dataset.listenerAdded) {
                fileDataImport.addEventListener('change', (e) => {
                    const f = e.target.files && e.target.files[0];
                    if (!f) return;
                    dmImportBackupFile(f);
                    e.target.value = '';
                });
                fileDataImport.dataset.listenerAdded = 'true';
            }

            if (mainTableBody) {
                mainTableBody.addEventListener('click', async (e) => {
                    const el = e.target && e.target.closest ? e.target.closest('[data-main-action]') : null;
                    if (!el) return;
                    const action = el.getAttribute('data-main-action');
                    const pid = el.getAttribute('data-proj');
                    if (!pid) return;

                    // Handle delete action separately
                    if (action === 'delete-project') {
                        e.stopPropagation();
                        const projName = el.getAttribute('data-proj-name') || pid;
                        const confirmed = await window.showConfirmDialog({
                            title: 'Delete Project',
                            message: `Are you sure you want to delete project "${projName}"?\n\nThis action cannot be undone.`,
                            type: 'danger',
                            okText: 'Delete',
                            cancelText: 'Cancel'
                        });
                        if (!confirmed) return;
                        if (window.RFQData && typeof window.RFQData.deleteProject === 'function') {
                            window.RFQData.deleteProject(pid);
                            projects = window.RFQData.getProjects();
                            // If we deleted the current project, clear it
                            if (currentProject && String(currentProject.id) === String(pid)) {
                                currentProject = projects[0] || null;
                                if (currentProject) localStorage.setItem('rfq_active_project_id', currentProject.id);
                            }
                            // Refresh the main view immediately
                            try { if (typeof renderMainOverview === 'function') renderMainOverview(); } catch (err) { console.error(err); }
                            try { if (typeof renderSidebar === 'function') renderSidebar(); } catch (err) { console.error(err); }
                            try { if (typeof renderDashboardProjects === 'function') renderDashboardProjects(); } catch (err) { }
                        }
                        return;
                    }

                    const proj = (projects || []).find(p => String(p.id) === String(pid));
                    if (!proj) return;
                    openProject(proj);
                    if (action === 'open-dashboard') switchView('dashboard');
                    if (action === 'open-items') switchView('items');
                    if (action === 'open-quoting') switchView('quoting');
                    if (action === 'open-suppliers') switchView('project-suppliers');
                    if (action === 'open-project-detail') switchView('project-detail');
                });
            }

            // Top Suppliers - click to open supplier detail (new card grid)
            const mainTopSuppliersGrid = getEl('main-top-suppliers-grid');
            if (mainTopSuppliersGrid) {
                mainTopSuppliersGrid.addEventListener('click', (e) => {
                    const el = e.target && e.target.closest ? e.target.closest('[data-main-action]') : null;
                    if (!el) return;
                    const action = el.getAttribute('data-main-action');
                    if (action === 'open-supplier-detail') {
                        const supplierName = el.getAttribute('data-supplier');
                        if (supplierName && typeof openGlobalSupplierDetail === 'function') {
                            openGlobalSupplierDetail(supplierName);
                        }
                    }
                });
            }

            // Upcoming Deadlines - click to open project, change to edit date
            const upcomingDeadlinesEl = getEl('main-upcoming-deadlines');
            if (upcomingDeadlinesEl) {
                upcomingDeadlinesEl.addEventListener('click', (e) => {
                    const el = e.target && e.target.closest ? e.target.closest('[data-main-action]') : null;
                    if (!el) return;
                    const action = el.getAttribute('data-main-action');
                    const pid = el.getAttribute('data-proj');
                    if (!pid) return;

                    if (action === 'open-dashboard') {
                        const proj = (projects || []).find(p => String(p.id) === String(pid));
                        if (proj) {
                            openProject(proj);
                            switchView('dashboard');
                        }
                    }
                });

                upcomingDeadlinesEl.addEventListener('change', (e) => {
                    const el = e.target && e.target.closest ? e.target.closest('[data-main-action="edit-deadline"]') : null;
                    if (!el) return;
                    const pid = el.getAttribute('data-proj');
                    if (!pid) return;
                    const newDate = el.value;
                    const proj = (projects || []).find(p => String(p.id) === String(pid));
                    if (proj) {
                        if (!proj.dates) proj.dates = {};
                        proj.dates.deadline = newDate;
                        proj.dates.Deadline = newDate;
                        if (window.RFQData && typeof window.RFQData.updateProject === 'function') {
                            window.RFQData.updateProject(proj);
                        } else if (typeof updateProject === 'function') {
                            updateProject(proj);
                        }
                        // Refresh the main view
                        try { renderMainOverview(); } catch (ex) { console.error(ex); }
                    }
                });
            }

            const btnNew = getEl('btn-new-project');
            if (btnNew) btnNew.onclick = () => {
                sheetNewProject.classList.remove('hidden');
                inputNewProjectName.focus();
            };
            const navNewProject = getEl('nav-new-project');
            if (navNewProject) navNewProject.onclick = () => {
                sheetNewProject.classList.remove('hidden');
                inputNewProjectName.focus();
            };

            const btnZru≈°itProject = getEl('btn-cancel-project');
            const btnCreateProject = getEl('btn-create-project');
            if (btnZru≈°itProject) btnZru≈°itProject.onclick = () => sheetNewProject.classList.add('hidden');
            if (btnCreateProject) btnCreateProject.onclick = handleCreateProject;
            // Export button removed by user request

            // Dashboard interactivity

            // Dashboard Notes / Comments
            const btnDashNoteAdd = getEl('btn-dash-note-add');
            const dashNotesText = getEl('dash-notes-text');
            const dashNotesTbody = getEl('dash-notes-tbody');

            if (btnDashNoteAdd) btnDashNoteAdd.onclick = () => {
                if (!currentProject) return;
                const txt = dashNotesText ? String(dashNotesText.value || '').trim() : '';
                if (!txt) return;
                if (!Array.isArray(currentProject.dashboard_notes)) currentProject.dashboard_notes = [];
                currentProject.dashboard_notes.unshift({
                    id: (window.RFQData && window.RFQData.uid) ? window.RFQData.uid() : (Date.now() + '_' + Math.random().toString(16).slice(2)),
                    text: txt,
                    created_at: new Date().toISOString()
                });
                if (dashNotesText) dashNotesText.value = '';
                if (window.RFQData && typeof window.RFQData.updateProject === 'function') window.RFQData.updateProject(currentProject);
                else updateProject(currentProject);
                renderDashboardNotes();
            };

            if (dashNotesTbody) {
                dashNotesTbody.addEventListener('click', async (e) => {
                    const btn = e.target && e.target.closest ? e.target.closest('[data-dash-note-action]') : null;
                    if (!btn) return;
                    if (!currentProject) return;
                    const action = btn.getAttribute('data-dash-note-action');
                    const id = btn.getAttribute('data-id');
                    if (!id) return;
                    if (!Array.isArray(currentProject.dashboard_notes)) currentProject.dashboard_notes = [];
                    const idx = currentProject.dashboard_notes.findIndex(n => n && String(n.id) === String(id));
                    if (idx < 0) return;

                    if (action === 'delete') {
                        currentProject.dashboard_notes.splice(idx, 1);
                    } else if (action === 'edit') {
                        const cur = currentProject.dashboard_notes[idx];
                        const next = await window.showPromptDialog({
                            title: 'Edit Comment',
                            message: 'Edit dashboard comment:',
                            defaultValue: cur ? String(cur.text || '') : '',
                            placeholder: 'Comment text'
                        });
                        if (next === null) return;
                        currentProject.dashboard_notes[idx] = { ...(cur || {}), text: String(next).trim() };
                    }
                    if (window.RFQData && typeof window.RFQData.updateProject === 'function') window.RFQData.updateProject(currentProject);
                    else updateProject(currentProject);
                    renderDashboardNotes();
                });
            }


            const cardDone = getEl('dash-done-items');
            if (cardDone && cardDone.parentElement) cardDone.parentElement.onclick = () => {
                switchView('items');
                filterStatus.value = 'Done';
                applyFilters();
            };
            const cardPending = getEl('dash-pending-items');
            if (cardPending && cardPending.parentElement) cardPending.parentElement.onclick = () => {
                switchView('items');
                filterStatus.value = 'Pending';
                applyFilters();
            };
            const cardTotal = getEl('dash-total-items');
            if (cardTotal && cardTotal.parentElement) cardTotal.parentElement.onclick = () => {
                switchView('items');
                filterStatus.value = ''; // All
                applyFilters();
            };

            // Items View Actions
            const btnAddItem = getEl('btn-add-item');
            const btnFilterToggle = getEl('btn-filter-toggle');
            const btnExportExcel = getEl('btn-export-excel');
            const fileImport = getEl('file-import-excel');
            const sheetAddChoice = getEl('sheet-add-choice');

            if (btnAddItem) btnAddItem.onclick = () => {
                if (!currentProject) { if (window.showToast) window.showToast('Select a project first', 'warning'); return; }
                sheetAddChoice.classList.remove('hidden');
            };

            if (btnFilterToggle) btnFilterToggle.onclick = () => {
                const panel = getEl('filters-panel');
                if (panel) panel.classList.toggle('hidden');
            };

            if (btnExportExcel) btnExportExcel.onclick = exportToExcel;
            if (fileImport) fileImport.onchange = handleImportExcel;

            // Import Target Prices
            const btnImportTargets = getEl('btn-import-target-prices');
            const fileImportTargets = getEl('file-import-targets');
            if (btnImportTargets) btnImportTargets.onclick = () => {
                if (!currentProject) { if (window.showToast) window.showToast('Select a project first', 'warning'); return; }
                if (fileImportTargets) fileImportTargets.click();
            };
            if (fileImportTargets) fileImportTargets.onchange = handleImportTargetPrices;

            // Add Choice Modal
            const btnChoiceManual = getEl('btn-choice-manual');
            const btnChoiceImport = getEl('btn-choice-import');

            if (btnChoiceManual) btnChoiceManual.onclick = () => {
                sheetAddChoice.classList.add('hidden');
                openManualEntryForm();
            };
            if (btnChoiceImport) btnChoiceImport.onclick = () => {
                sheetAddChoice.classList.add('hidden');
                if (fileImport) fileImport.click();
            };

            window.onclick = (event) => {
                if (event.target === sheetAddChoice) sheetAddChoice.classList.add('hidden');
                if (event.target === sheetNewProject) sheetNewProject.classList.add('hidden');
            };

            // Manual Entry Form
            const btnZru≈°itManual = getEl('btn-cancel-manual');
            const btnUlo≈æitManual = getEl('btn-save-manual');
            if (btnZru≈°itManual) btnZru≈°itManual.onclick = () => sheetManualEntry.classList.add('hidden');
            if (btnUlo≈æitManual) btnUlo≈æitManual.onclick = saveManualEntry;

            // Detail Window
            const btnCloseDetail = getEl('btn-close-detail');
            const btnZru≈°itDetailFooter = getEl('btn-cancel-detail-footer');
            const btnUlo≈æitDetail = getEl('btn-save-detail');
            const btnDeleteDetail = getEl('btn-delete-detail');

            if (btnCloseDetail) btnCloseDetail.onclick = closeDetailWindow;
            if (btnZru≈°itDetailFooter) btnZru≈°itDetailFooter.onclick = closeDetailWindow;
            if (btnUlo≈æitDetail) btnUlo≈æitDetail.onclick = saveDetailChanges;
            if (btnDeleteDetail) btnDeleteDetail.onclick = deleteCurrentItem;

            // Filters
            if (tableFilter) tableFilter.addEventListener('input', () => { filterText = tableFilter.value.toLowerCase(); applyFilters(); });

            [filterStatus, filterSupplier, filterManufacturer, filterPriceMin, filterPriceMax].forEach(el => {
                if (el) el.addEventListener('change', applyFilters);
                if (el) el.addEventListener('input', applyFilters);
            });

            const btnClearFilters = getEl('btn-clear-filters');
            if (btnClearFilters) btnClearFilters.onclick = () => {
                filterStatus.value = '';
                filterSupplier.value = '';
                filterManufacturer.value = '';
                filterPriceMin.value = '';
                filterPriceMax.value = '';
                tableFilter.value = '';
                filterText = '';
                applyFilters();
            };

            // Items View Tab Switching (Table View / Pricing View)
            const itemsViewTabs = document.querySelectorAll('.items-view-tab');
            const itemsTableContainer = getEl('items-super-table-container');
            const itemsPricingView = getEl('items-pricing-view');

            // Function to switch between table and pricing view
            function switchItemsView(viewType) {
                // Update tab styling
                itemsViewTabs.forEach(t => {
                    const isActive = t.dataset.view === viewType;
                    t.classList.toggle('active', isActive);
                    t.style.fontWeight = isActive ? '600' : '500';
                    t.style.color = isActive ? '#007AFF' : '#666';
                    t.style.borderBottom = isActive ? '2px solid #007AFF' : '2px solid transparent';
                });

                if (viewType === 'table') {
                    // Show Table View, hide Pricing View completely
                    if (itemsTableContainer) {
                        itemsTableContainer.classList.remove('hidden');
                        itemsTableContainer.style.display = '';
                    }
                    if (itemsPricingView) {
                        itemsPricingView.classList.add('hidden');
                        itemsPricingView.style.display = 'none';
                    }
                } else if (viewType === 'pricing') {
                    // Show Pricing View, hide Table View completely
                    if (itemsTableContainer) {
                        itemsTableContainer.classList.add('hidden');
                        itemsTableContainer.style.display = 'none';
                    }
                    if (itemsPricingView) {
                        itemsPricingView.classList.remove('hidden');
                        itemsPricingView.style.display = 'flex';
                    }
                    // Render pricing view
                    if (typeof renderPricingView === 'function') {
                        renderPricingView();
                    }
                }
            }

            itemsViewTabs.forEach(tab => {
                tab.addEventListener('click', () => switchItemsView(tab.dataset.view));
            });

            // Ensure correct initial state (Table View visible)
            if (itemsPricingView) {
                itemsPricingView.style.display = 'none';
            }

            // Database Search
            if (databaseSearch) databaseSearch.addEventListener('input', renderDatabase);
            if (databaseProjectFilter) databaseProjectFilter.addEventListener('change', renderDatabase);
            const btnRefreshDb = getEl('btn-refresh-db');
            const btnDbClearFilters = getEl('btn-db-clear-filters');
            const btnDbExportSelected = getEl('btn-db-export-selected');
            const btnDbClearSelection = getEl('btn-db-clear-selection');
            const dbSelectAll = getEl('db-select-all');
            if (btnRefreshDb) btnRefreshDb.onclick = renderDatabase;
            if (btnDbClearFilters) btnDbClearFilters.onclick = () => { try { if (databaseSearch) databaseSearch.value = ''; if (databaseProjectFilter) databaseProjectFilter.value = ''; renderDatabase(); } catch (e) { } };

            // Database selection + open detail
            if (btnDbExportSelected) btnDbExportSelected.onclick = () => { try { exportDatabaseSelection(); } catch (e) { } };
            if (btnDbClearSelection) btnDbClearSelection.onclick = () => { try { selectedDbParts.clear(); renderDatabase(); } catch (e) { } };

            if (dbSelectAll && !dbSelectAll.dataset.bound) {
                dbSelectAll.dataset.bound = '1';
                dbSelectAll.addEventListener('change', (e) => {
                    const checked = !!e.target.checked;
                    const boxes = Array.from(document.querySelectorAll('#table-database tbody .db-row-checkbox'));
                    const visible = boxes.filter(b => {
                        const tr = b.closest('tr');
                        return tr && tr.offsetParent !== null;
                    });
                    visible.forEach(b => {
                        b.checked = checked;
                        const k = String(b.getAttribute('data-db-key') || '').trim().toLowerCase();
                        if (!k) return;
                        if (checked) selectedDbParts.add(k); else selectedDbParts.delete(k);
                    });
                    updateDbSelectionUI();
                });
            }

            const dbTbody = document.querySelector('#table-database tbody');
            if (dbTbody && !dbTbody.dataset.bound) {
                dbTbody.dataset.bound = '1';

                dbTbody.addEventListener('change', (e) => {
                    const cb = e.target && e.target.classList && e.target.classList.contains('db-row-checkbox') ? e.target : null;
                    if (!cb) return;
                    const k = String(cb.getAttribute('data-db-key') || '').trim().toLowerCase();
                    if (!k) return;
                    if (cb.checked) selectedDbParts.add(k); else selectedDbParts.delete(k);
                    updateDbSelectionUI();
                });

                dbTbody.addEventListener('click', (e) => {
                    const tgt = e.target;
                    if (!tgt) return;
                    if (tgt.closest && tgt.closest('input.db-row-checkbox')) return;

                    const openCell = tgt.closest ? tgt.closest('.db-open-cell') : null;
                    if (openCell) {
                        const k = String(openCell.getAttribute('data-db-key') || '').trim().toLowerCase();
                        if (!k) return;
                        openDatabaseKey(k);
                        return;
                    }
                });
            }

            // Bulk Actions
            const checkSelectAll = getEl('select-all-items');
            if (checkSelectAll) checkSelectAll.addEventListener('change', (e) => toggleAllItems(e.target.checked));

            const btnBulkClear = getEl('btn-bulk-clear');
            if (btnBulkClear) btnBulkClear.onclick = () => {
                selectedItems.clear();
                const allChecks = document.querySelectorAll('.item-checkbox');
                allChecks.forEach(cb => cb.checked = false);
                updateBulkActionBar();
                const sa = getEl('select-all-items');
                if (sa) { sa.checked = false; sa.indeterminate = false; }
            };

            const btnBulkExport = getEl('btn-bulk-export');
            if (btnBulkExport) btnBulkExport.onclick = handleBulkExport;

            const selBulkStatus = getEl('bulk-status-select');
            if (selBulkStatus) selBulkStatus.onchange = (e) => handleBulkStatusChange(e.target.value);
        }

        function switchView(view) {
            const prevView = currentView;
            if (prevView === 'item-detail' && view !== 'item-detail') {
                try { _releaseEditLock(); } catch (_) { }
            }
            currentView = view;

            // Close any open dropdowns
            closeAllNavDropdowns();

            // Save current view and project to localStorage for F5 persistence
            try {
                const viewState = {
                    view: view,
                    projectId: currentProject ? currentProject.id : null,
                    timestamp: Date.now()
                };
                localStorage.setItem('rfq_current_view_state', JSON.stringify(viewState));
            } catch (e) { console.warn('Could not save view state:', e); }

            [viewMain, viewDataManager, viewDashboard, viewProjectDetail, viewItems, viewItemDetail, viewSuppliers, viewProjectSuppliers, viewSupplierList, viewSupplierDetail, viewBundleDetail, viewQuoteCompare, viewExport, viewQuoting, viewSamepart, viewDatabase, viewQuotes, viewSettings].forEach(el => el && el.classList.add('hidden'));
            [navMain, navData, navDashboard, navItems, navSuppliers, navProjectSuppliers, navSupplierList, navSamepart, navQuoting, navDatabase, navExport, navSettings].forEach(el => el && el.classList.remove('active'));

            // Also remove active from dropdown items
            document.querySelectorAll('.nav-dropdown-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-dropdown-btn').forEach(el => el.classList.remove('active'));

            // Toggle project-tabs-group active state (blue underlines) + visibility
            const projectTabsGroup = document.querySelector('.project-tabs-group');
            const projectViews = ['dashboard', 'items', 'suppliers', 'project-suppliers', 'samepart', 'quoting', 'item-detail', 'bundle-detail', 'quote-compare'];
            if (projectTabsGroup) {
                // Keep project tabs visible as long as a project is selected
                if (currentProject) {
                    projectTabsGroup.classList.add('has-project');
                } else {
                    projectTabsGroup.classList.remove('has-project');
                }
                // Blue underlines only on project-specific views
                if (projectViews.includes(view)) {
                    projectTabsGroup.classList.add('active');
                } else {
                    projectTabsGroup.classList.remove('active');
                }
            }

            if (view === 'main' && viewMain) {
                // Reset project when going to MAIN
                currentProject = null;
                window.currentProject = null;
                localStorage.removeItem('rfq_active_project_id');
                setProjectNameUI(null);
                if (projectTabsGroup) projectTabsGroup.classList.remove('has-project');

                viewMain.classList.remove('hidden');
                if (navMain) navMain.classList.add('active');
                try {
                    const mf = getEl('main-filter');
                    const ms = getEl('main-status-filter');
                    if (mf) mf.value = '';
                    if (ms) ms.value = '';
                    renderMainOverview();
                } catch (e) { console.error(e); const me = getEl('main-error'); if (me) { me.textContent = 'MAIN render error: ' + (e && e.message ? e.message : String(e)); me.classList.remove('hidden'); } }
            } else if (view === 'data' && viewDataManager) {
                viewDataManager.classList.remove('hidden');
                if (navData) navData.classList.add('active');
                try { renderDataManager(); } catch (e) { console.error(e); showToast('DATA render error: ' + (e && e.message ? e.message : String(e)), 'error'); }
            } else if (view === 'dashboard' && viewDashboard) {
                viewDashboard.classList.remove('hidden');
                if (navDashboard) navDashboard.classList.add('active');
                renderDashboardProjects();
                renderDashboard();
            } else if (view === 'project-detail' && viewProjectDetail) {
                viewProjectDetail.classList.remove('hidden');
                // No nav tab is active for detail pages
                try { renderProjectDetail(); } catch (e) { console.error(e); }
            } else if (view === 'items' && viewItems) {
                viewItems.classList.remove('hidden');
                if (navItems) navItems.classList.add('active');
                highlightDropdownParent('nav-dropdown-project');
                refreshAllStatusDropdowns(); // Ensure status dropdown has latest values
                renderCompactTable();
                updateStats();
                updateSupplierFilter();
                updateManufacturerFilter();
            } else if (view === 'suppliers' && viewSuppliers) {
                try { _acquireGenericViewLock('suppliers'); } catch (_) { }
                viewSuppliers.classList.remove('hidden');
                if (navSuppliers) navSuppliers.classList.add('active');
                highlightDropdownParent('nav-dropdown-project');
                if (typeof renderSuppliers === 'function') renderSuppliers();
            } else if (view === 'project-suppliers' && viewProjectSuppliers) {
                try { _acquireGenericViewLock('project-suppliers'); } catch (_) { }
                viewProjectSuppliers.classList.remove('hidden');
                if (navProjectSuppliers) navProjectSuppliers.classList.add('active');
                highlightDropdownParent('nav-dropdown-project');
                try { renderProjectSupplierList(); } catch (e) { console.error(e); }
            } else if (view === 'samepart' && viewSamepart) {
                viewSamepart.classList.remove('hidden');
                if (navSamepart) navSamepart.classList.add('active');
                highlightDropdownParent('nav-dropdown-project');
                try { renderSamePartView(); } catch (e) { console.error(e); }
            } else if (view === 'supplier-list' && viewSupplierList) {
                // Reset project when going to GLOBAL view
                currentProject = null;
                window.currentProject = null;
                localStorage.removeItem('rfq_active_project_id');
                setProjectNameUI(null);
                if (projectTabsGroup) projectTabsGroup.classList.remove('has-project');

                viewSupplierList.classList.remove('hidden');
                if (navSupplierList) navSupplierList.classList.add('active');
                highlightDropdownParent('nav-dropdown-global');
                renderGlobalSupplierList();
            } else if (view === 'supplier-detail' && viewSupplierDetail) {
                viewSupplierDetail.classList.remove('hidden');
                // No nav tab is active for detail pages
            } else if (view === 'bundle-detail' && viewBundleDetail) {
                viewBundleDetail.classList.remove('hidden');
                // No nav tab is active for detail pages
                try { renderBundleDetailPage(); } catch (e) { console.error(e); }
            } else if (view === 'quote-compare' && viewQuoteCompare) {
                viewQuoteCompare.classList.remove('hidden');
                // No nav tab is active for detail pages
                try { renderQuoteComparePage(); } catch (e) { console.error(e); }
            } else if (view === 'item-detail' && viewItemDetail) {
                viewItemDetail.classList.remove('hidden');
                // No nav tab is active for detail pages
            } else if (view === 'quoting' && viewQuoting) {
                try { _acquireGenericViewLock('quoting'); } catch (_) { }
                viewQuoting.classList.remove('hidden');
                if (navQuoting) navQuoting.classList.add('active');
                renderQuotingView();
            } else if (view === 'export' && viewExport) {
                viewExport.classList.remove('hidden');
                if (navExport) navExport.classList.add('active');
                highlightDropdownParent('nav-dropdown-settings');
                try { renderExportCenter(); } catch (e) { console.error(e); }
            } else if (view === 'database' && viewDatabase) {
                // Reset project when going to GLOBAL view
                currentProject = null;
                window.currentProject = null;
                localStorage.removeItem('rfq_active_project_id');
                setProjectNameUI(null);
                if (projectTabsGroup) projectTabsGroup.classList.remove('has-project');

                viewDatabase.classList.remove('hidden');
                if (navDatabase) navDatabase.classList.add('active');
                highlightDropdownParent('nav-dropdown-global');
                renderDatabase();
            } else if (view === 'quotes' && viewQuotes) {
                // Reset project when going to GLOBAL view
                currentProject = null;
                window.currentProject = null;
                localStorage.removeItem('rfq_active_project_id');
                setProjectNameUI(null);
                if (projectTabsGroup) projectTabsGroup.classList.remove('has-project');

                viewQuotes.classList.remove('hidden');
                if (navQuotes) navQuotes.classList.add('active');
                highlightDropdownParent('nav-dropdown-global');
                if (typeof window.renderQuotes === 'function') window.renderQuotes();
            } else if (view === 'settings' && viewSettings) {
                viewSettings.classList.remove('hidden');
                if (navSettings) navSettings.classList.add('active');
                highlightDropdownParent('nav-dropdown-settings');
                try { renderSettings(); } catch (e) { console.error(e); }
            }


            // Apply unified table behaviors for tables that exist in this view
            initUnifiedTablesForCurrentView(view);
        }

        function initUnifiedTablesForCurrentView(view) {
            // NOTE: Only apply to tables that exist in DOM (some views render tables lazily)
            const configs = [
                { id: 'table-database', key: 'rfq_database' },
                { id: 'table-supplier-list', key: 'rfq_supplier_list' },
                { id: 'table-proj-suppliers', key: 'rfq_project_suppliers' },
                { id: 'table-bulk-pricing', key: 'rfq_bulk_pricing' },
                { id: 'sd-items-table', key: 'rfq_supplier_detail_items' },
                { id: 'sd-rfq-history-table', key: 'rfq_supplier_detail_rfq_history' },
            ];

            configs.forEach(cfg => {
                if (document.getElementById(cfg.id)) {
                    ensureUnifiedTable(cfg.id, cfg.key, cfg.options || {});
                }
            });
        }




        // =========================================================
        // MAIN ‚Äì Global Overview (across all projects)
        // =========================================================

        function mainParseIsoDate(v) {
            const s = String(v || '').trim();
            if (!s) return null;
            // accept yyyy-mm-dd
            if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
                const d = new Date(s + 'T00:00:00');
                return isNaN(d.getTime()) ? null : d;
            }
            const d = new Date(s);
            return isNaN(d.getTime()) ? null : d;
        }
        // =========================================================
        // DATA MANAGER ‚Äì Local storage, backup, restore
        // =========================================================

        function dmFormatBytes(bytes) {
            const b = Number(bytes) || 0;
            if (b < 1024) return b + ' B';
            if (b < 1024 * 1024) return (b / 1024).toFixed(1) + ' KB';
            return (b / (1024 * 1024)).toFixed(2) + ' MB';
        }

        function dmGetProjectsRaw() {
            try {
                if (window.RFQData && typeof window.RFQData.getProjects === 'function') return window.RFQData.getProjects();
            } catch (e) { }
            try {
                const raw = localStorage.getItem('rfq_projects_v1');
                return raw ? JSON.parse(raw) : [];
            } catch (e) { }
            return [];
        }

        function dmSetProjectsRaw(projects) {
            try {
                localStorage.setItem('rfq_projects_v1', JSON.stringify(Array.isArray(projects) ? projects : []));
                try { if (window.RFQData && typeof window.RFQData.syncNow === 'function') window.RFQData.syncNow(); } catch (e) { }
                return true;
            } catch (e) { console.error(e); return false; }
        }

        function dmMergeProjects(existing, incoming) {
            const ex = Array.isArray(existing) ? existing : [];
            const inc = Array.isArray(incoming) ? incoming : [];
            const map = new Map();
            ex.forEach(p => { if (p && p.id) map.set(String(p.id), p); });
            inc.forEach(p => { if (p && p.id) map.set(String(p.id), p); });
            return Array.from(map.values());
        }

        function renderDataManager() {
            const cards = getEl('data-manager-cards');
            const tb = getEl('table-data-keys') ? getEl('table-data-keys').querySelector('tbody') : null;
            if (!cards || !tb) return;

            const projectsRaw = dmGetProjectsRaw();
            const projectsCount = Array.isArray(projectsRaw) ? projectsRaw.length : 0;
            const itemsCount = (Array.isArray(projectsRaw) ? projectsRaw.reduce((acc, p) => acc + (Array.isArray(p.items) ? p.items.length : 0), 0) : 0);
            const activeId = localStorage.getItem('rfq_active_project_id') || '';

            // localStorage key sizes
            const keys = [];
            let totalBytes = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const k = localStorage.key(i);
                const v = localStorage.getItem(k) || '';
                const bytes = (k.length + v.length) * 2; // rough UTF-16 bytes
                totalBytes += bytes;
                keys.push({ key: k, bytes, preview: v.slice(0, 120) });
            }
            keys.sort((a, b) => a.key.localeCompare(b.key));

            cards.innerHTML = `
      <div class="main-grid" style="grid-template-columns: repeat(4, 1fr); gap: 12px;">
        <div class="main-kpi"><div class="main-kpi-label">Build</div><div class="main-kpi-value">${window.__RFQ_BUILD_VERSION__ || '-'}</div></div>
        <div class="main-kpi"><div class="main-kpi-label">Projects</div><div class="main-kpi-value">${projectsCount}</div></div>
        <div class="main-kpi"><div class="main-kpi-label">Items</div><div class="main-kpi-value">${itemsCount}</div></div>
        <div class="main-kpi"><div class="main-kpi-label">LocalStorage Size</div><div class="main-kpi-value">${dmFormatBytes(totalBytes)}</div></div>
      </div>
      <div class="main-card" style="margin-top:12px;">
        <div class="main-card-title">Active Project</div>
        <div style="font-size:12px; color:#444; padding:6px 2px;">
          <b>ID:</b> ${activeId || '-'} 
        </div>
      </div>
    `;

            tb.innerHTML = keys.map(k => `
      <tr>
        <td style="font-weight:600;">${k.key}</td>
        <td>${dmFormatBytes(k.bytes)}</td>
        <td style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 11px; color:#555;">
          ${String(k.preview || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}
        </td>
      </tr>
    `).join('');
        }

        function dmDownloadJson(obj, filename) {
            try {
                const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 0);
            } catch (e) { console.error(e); showToast('Export failed: ' + (e && e.message ? e.message : String(e)), 'error'); }
        }

        function dmExportBackup() {
            const payload = {
                schema: 'rfq_backup_v1',
                created_at: new Date().toISOString(),
                build: window.__RFQ_BUILD_VERSION__ || '',
                active_project_id: localStorage.getItem('rfq_active_project_id') || '',
                projects: dmGetProjectsRaw()
            };
            const ts = payload.created_at.replace(/[:.]/g, '-');
            dmDownloadJson(payload, `rfq_backup_${ts}.json`);
        }

        function dmImportBackupFile(file) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const parsed = JSON.parse(String(ev.target.result || ''));
                    if (!parsed || !Array.isArray(parsed.projects)) throw new Error('Invalid backup format (missing projects[])');
                    const existing = dmGetProjectsRaw();
                    const merged = dmMergeProjects(existing, parsed.projects);
                    if (!dmSetProjectsRaw(merged)) throw new Error('Failed to write rfq_projects_v1');
                    if (parsed.active_project_id) localStorage.setItem('rfq_active_project_id', String(parsed.active_project_id));
                    // refresh in-memory + UI
                    try { projects = getAllProjectsSafe(); } catch (e) { }
                    try { if (typeof renderSidebar === 'function') renderSidebar(); } catch (e) { }
                    try { if (typeof renderSidebarProjects === 'function') renderSidebarProjects(); } catch (e) { }
                    showToast('Import OK. Projects merged: ' + merged.length, 'success');
                    try { renderDataManager(); } catch (e) { }
                } catch (e) {
                    console.error(e);
                    showToast('Import failed: ' + (e && e.message ? e.message : String(e)), 'error');
                }
            };
            reader.readAsText(file);
        }

        async function dmResetAllRFQ() {
            const confirmed = await window.showConfirmDialog({
                title: 'Reset All Data',
                message: 'This will remove all RFQ data from this browser (projects, items, suppliers, quotes). Continue?',
                type: 'danger',
                okText: 'Reset All',
                cancelText: 'Cancel'
            });
            if (!confirmed) return;
            const toRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const k = localStorage.key(i);
                if (k && (k.startsWith('rfq_') || k.toLowerCase().includes('rfq'))) toRemove.push(k);
            }
            toRemove.forEach(k => { try { localStorage.removeItem(k); } catch (e) { } });

            // also reset server storage (Django)
            try {
                fetch('/api/projects/reset', { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin' }).catch(() => { });
            } catch (e) { }
            if (window.showToast) window.showToast('RFQ data cleared. Reloading‚Ä¶', 'success');
            setTimeout(() => location.reload(), 500);
        }


        function mainFmtYMD(d) {
            if (!d) return '';
            try {
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${y}-${m}-${day}`;
            } catch { return ''; }
        }

        function getAllProjectsSafe() {
            try {
                if (window.RFQData && typeof window.RFQData.getProjects === 'function') return window.RFQData.getProjects();
                if (typeof getProjects === 'function') return getProjects();
            } catch (e) { console.error(e); }
            return Array.isArray(projects) ? projects : [];
        }

        function getProjectBundlesSafe(p) {
            if (!p || typeof p !== 'object') return [];
            if (Array.isArray(p.rfqBatches)) return p.rfqBatches;
            if (Array.isArray(p.rfq_batches)) return p.rfq_batches;
            return [];
        }

        function getProjectSuppliersCountSafe(p) {
            const set = new Set();
            const master = Array.isArray(p && p.supplierMaster) ? p.supplierMaster : [];
            master.forEach(s => { if (s && (s.name || s.supplier)) set.add(String(s.name || s.supplier)); });
            const items = Array.isArray(p && p.items) ? p.items : [];
            items.forEach(it => {
                if (!it) return;
                const supArr = Array.isArray(it.suppliers) ? it.suppliers : [];
                supArr.forEach(s => {
                    const nm = s && (s.supplier || s.name || s.company);
                    if (nm) set.add(String(nm));
                });
                if (it.supplier) set.add(String(it.supplier));
                if (it.main_supplier) set.add(String(it.main_supplier));
            });
            return set.size;
        }

        function isBundleOpen(b) {
            const st = String((b && b.status) ? b.status : '').toLowerCase();
            if (!st) return true;
            return !(st.includes('closed') || st.includes('done') || st.includes('archiv'));
        }

        function renderMainOverview() {
            // Export to window for global access
            window.renderMainOverview = renderMainOverview;

            const errEl = getEl('main-error');
            if (errEl) { errEl.textContent = ''; errEl.classList.add('hidden'); }

            // Safety: always show core main boxes (users may accidentally hide them in layout edit mode)
            ['main-kpis','main-projects-table-box','main-countdown','main-top-suppliers'].forEach(id => {
                const bx = document.querySelector(`.main-box[data-box-id="${id}"]`);
                if (bx) bx.classList.remove('hidden-box');
            });

            // Bind action buttons (re-bind each time to ensure they work)
            const btnMainRefresh = getEl('btn-main-refresh');
            const btnMainExport = getEl('btn-main-export');
            const btnMainNewProject = getEl('btn-main-new-project');

            if (btnMainRefresh && !btnMainRefresh.dataset.mainBound) {
                btnMainRefresh.dataset.mainBound = '1';
                btnMainRefresh.onclick = () => { try { renderMainOverview(); } catch (e) { console.error(e); } };
            }
            if (btnMainExport && !btnMainExport.dataset.mainBound) {
                btnMainExport.dataset.mainBound = '1';
                btnMainExport.onclick = () => { try { exportMainProjectsCSV(); } catch (e) { console.error(e); } };
            }
            if (btnMainNewProject && !btnMainNewProject.dataset.mainBound) {
                btnMainNewProject.dataset.mainBound = '1';
                btnMainNewProject.onclick = () => { try { openNewProjectModal(); } catch (e) { console.error(e); } };
            }

            const freshProjects = getAllProjectsSafe();
            // Resilience: if provider temporarily returns empty, keep in-memory list
            if (Array.isArray(freshProjects) && freshProjects.length) {
                projects = freshProjects;
            } else if (!Array.isArray(projects)) {
                projects = [];
            }

            const list = Array.isArray(projects) ? projects : [];
            const tb = getEl('main-projects-tbody');
            const tbSup = getEl('main-top-suppliers-tbody');

            const kProjects = getEl('main-kpi-projects');
            const kItems = getEl('main-kpi-items');
            const kSuppliers = getEl('main-kpi-suppliers');
            const kOpenBundles = getEl('main-kpi-open-bundles');
            const kValue = getEl('main-kpi-value');

            const kOverdue = getEl('main-overdue');
            const kDue7 = getEl('main-due-7');
            const kDueSoon = getEl('main-due-soon');
            const kRecent = getEl('main-recent');

            const statusBreakdown = getEl('main-status-breakdown');
            const upcomingDeadlines = getEl('main-upcoming-deadlines');

            let totalItems = 0;
            let totalSuppliers = 0;
            let totalOpenBundles = 0;
            let totalValue = 0;

            const today = new Date();
            const t0 = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
            let overdue = 0;
            let due7 = 0;
            let dueSoon = 0;
            let mostRecent = null;

            const statusCounts = {};
            const deadlinesList = [];

            // Aggregate suppliers across projects
            const supplierAgg = new Map(); // name -> {bundles, items, value}
            const rows = list.map(p => {
                const itemsArr = Array.isArray(p.items) ? p.items : [];
                const items = itemsArr.length;
                const suppliers = getProjectSuppliersCountSafe(p);
                const bundles = getProjectBundlesSafe(p);
                const openBundles = bundles.filter(isBundleOpen).length;

                // Calculate project value = sum of (price_1 √ó qty_1) in EUR for 1 machine
                let projValue = 0;
                let quotedItems = 0;
                let doneItems = 0;
                let issueItems = 0;
                itemsArr.forEach(it => {
                    const qty1 = parseFloat(it.qty_1) || 0;
                    let priceEur = parseFloat(it.price_1_euro) || 0;
                    if (!priceEur) {
                        const price1 = parseFloat(it.price_1) || 0;
                        const currency = it.currency || 'EUR';
                        const rate = CURRENCY_RATES[currency] || 1;
                        priceEur = price1 * rate;
                    }
                    projValue += priceEur * qty1;
                    const st = String(it.status || '').toLowerCase();
                    if (st.includes('quote') || st.includes('won') || st.includes('done')) quotedItems++;
                    // Count Done items
                    if (st === 'done' || st.includes('done') || st.includes('complete')) doneItems++;
                    // Count Issue items
                    if (st === 'issue' || st.includes('issue') || st.includes('problem') || st.includes('error')) issueItems++;
                });
                const quoteRate = items > 0 ? Math.round((quotedItems / items) * 100) : 0;

                totalItems += items;
                totalSuppliers += suppliers;
                totalOpenBundles += openBundles;
                totalValue += projValue;

                // Project status count
                const ps = p.project_status || 'Created';
                statusCounts[ps] = (statusCounts[ps] || 0) + 1;

                // deadline / due
                const deadlineStr = p && p.dates ? (p.dates.deadline || p.dates.Deadline || '') : '';
                const d = mainParseIsoDate(deadlineStr);
                let diffDays = null;
                if (d) {
                    const t = new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime();
                    diffDays = Math.ceil((t - t0) / (24 * 3600 * 1000));
                    if (diffDays < 0) overdue += 1;
                    else if (diffDays <= 7) due7 += 1;
                    else if (diffDays <= 14) dueSoon += 1;

                    if (diffDays >= 0 && diffDays <= 30) {
                        deadlinesList.push({ name: p.name || 'Untitled', id: p.id, deadline: deadlineStr, days: diffDays });
                    }
                }

                // recently updated
                const upd = p.updated_at || p.created_at || '';
                const ud = mainParseIsoDate(upd);
                if (ud && (!mostRecent || ud.getTime() > mostRecent.getTime())) mostRecent = ud;

                // supplier agg
                bundles.forEach(b => {
                    const sup = String((b && (b.supplier || b.supplier_name || b.supplierName)) || '').trim();
                    if (!sup) return;
                    const rec = supplierAgg.get(sup) || { bundles: 0, items: 0, value: 0 };
                    rec.bundles += 1;
                    const lines = Array.isArray(b && b.items) ? b.items.length : 0;
                    rec.items += lines;
                    supplierAgg.set(sup, rec);
                });

                // Also aggregate item suppliers
                itemsArr.forEach(it => {
                    const sup = String(it.supplier || '').trim();
                    if (!sup) return;
                    const rec = supplierAgg.get(sup) || { bundles: 0, items: 0, value: 0 };
                    rec.items += 1;
                    const p1 = parseFloat(it.price_1_euro || it.price_1 || 0) || 0;
                    const q1 = parseFloat(it.qty_1 || 1) || 1;
                    rec.value += p1 * q1;
                    supplierAgg.set(sup, rec);
                });

                const sentTo = p && p.dates ? (p.dates.sent_to || p.dates.sentTo || '') : '';
                const receivedDate = p && p.dates ? (p.dates.received || p.dates.Received || p.dates.rfq_received || '') : '';
                const sentDate = p && p.dates ? (p.dates.sent || p.dates.Sent || p.dates.rfq_sent || '') : '';
                return {
                    id: p.id,
                    name: p.name || 'Untitled',
                    status: ps,
                    items,
                    doneItems,
                    issueItems,
                    value: projValue,
                    suppliers,
                    bundles: bundles.length,
                    quoteRate,
                    received: receivedDate,
                    deadline: deadlineStr,
                    deadlineDays: diffDays,
                    sent: sentDate,
                    sentTo: String(sentTo || '').trim()
                };
            });

            // Update KPIs
            if (kProjects) kProjects.textContent = String(list.length);
            if (kItems) kItems.textContent = String(totalItems);
            if (kSuppliers) kSuppliers.textContent = String(totalSuppliers);
            if (kOpenBundles) kOpenBundles.textContent = String(totalOpenBundles);
            if (kValue) kValue.textContent = '‚Ç¨' + totalValue.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

            if (kOverdue) kOverdue.textContent = String(overdue);
            if (kDue7) kDue7.textContent = String(due7);
            if (kDueSoon) kDueSoon.textContent = String(dueSoon);
            if (kRecent) kRecent.textContent = mostRecent ? ('Last update: ' + mainFmtYMD(mostRecent)) : 'Last update: ‚Äî';

            // Status breakdown
            if (statusBreakdown) {
                const total = list.length || 1;
                statusBreakdown.innerHTML = Object.entries(statusCounts).map(([st, cnt]) => {
                    const pct = Math.round((cnt / total) * 100);
                    // Use dynamic color from config
                    const color = getStatusColorUnified(st, 'project');
                    return `
                <div style="display:flex; align-items:center; gap:8px;">
                    <div style="flex:1; height:8px; background:#e9ecef; border-radius:4px; overflow:hidden;">
                        <div style="width:${pct}%; height:100%; background:${color};"></div>
                    </div>
                    <span style="font-size:11px; min-width:80px;">${escapeHtml(st)}</span>
                    <span style="font-size:11px; font-weight:700; min-width:30px;">${cnt}</span>
                </div>
            `;
                }).join('') || '<div style="color:#999; font-size:12px;">No projects</div>';
            }

            // Upcoming deadlines - countdown card style
            if (upcomingDeadlines) {
                deadlinesList.sort((a, b) => a.days - b.days);
                upcomingDeadlines.innerHTML = deadlinesList.slice(0, 6).map(d => {
                    let borderColor = '#22c55e';
                    let bgGradient = 'linear-gradient(135deg,#f0fdf4,#dcfce7)';
                    let textColor = '#166534';
                    let icon = 'üü¢';
                    if (d.days <= 3) {
                        borderColor = '#dc2626'; bgGradient = 'linear-gradient(135deg,#fef2f2,#fecaca)'; textColor = '#991b1b'; icon = 'üî¥';
                    } else if (d.days <= 7) {
                        borderColor = '#f59e0b'; bgGradient = 'linear-gradient(135deg,#fffbeb,#fef3c7)'; textColor = '#92400e'; icon = 'üü°';
                    } else if (d.days <= 14) {
                        borderColor = '#3b82f6'; bgGradient = 'linear-gradient(135deg,#eff6ff,#dbeafe)'; textColor = '#1e40af'; icon = 'üîµ';
                    }
                    return `
                <div style="display:flex; align-items:center; gap:10px; padding:10px 12px; background:${bgGradient}; border-radius:8px; border-left:4px solid ${borderColor}; cursor:pointer;"
                     data-main-action="open-dashboard" data-proj="${escapeHtml(String(d.id))}">
                    <div style="font-size:28px; font-weight:800; color:${borderColor}; min-width:40px; text-align:center;">${d.days}</div>
                    <div style="flex:1; min-width:0;">
                        <div style="font-size:10px; color:${textColor}; text-transform:uppercase;">days left</div>
                        <div style="font-size:12px; font-weight:600; color:#0f172a; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${escapeHtml(d.name)}">${escapeHtml(d.name)}</div>
                        <div style="font-size:10px; color:#64748b;">${escapeHtml(d.deadline)}</div>
                    </div>
                    <div style="font-size:14px;">${icon}</div>
                </div>
            `;
                }).join('') || '<div style="color:#999; font-size:12px; padding:20px; text-align:center;">No upcoming deadlines<br><span style="font-size:10px;">Set deadlines in project settings</span></div>';
            }

            // Projects table
            if (tb) {
                if (!rows.length) {
                    tb.innerHTML = '<tr><td colspan="10" style="padding:30px; text-align:center; color:#6b7280; font-size:14px;">No projects found. Click "+ New Project" to create one.</td></tr>';
                } else {
                    // Sort rows by status category: priority (Reopen) at top, Done at bottom
                    rows.sort((a, b) => {
                        const catA = getProjectStatusCategory(a.status);
                        const catB = getProjectStatusCategory(b.status);
                        const catOrder = { 'priority': 0, 'new': 1, 'in_progress': 2, 'issue': 2, 'done': 3 };
                        const orderA = catOrder[catA] ?? 2;
                        const orderB = catOrder[catB] ?? 2;
                        return orderA - orderB;
                    });

                    tb.innerHTML = rows.map(r => {
                        // Status badge color - use dynamic config
                        const stColor = getStatusColorUnified(r.status, 'project');
                        const stBg = stColor + '20';

                        // Deadline styling
                        let dlStyle = 'color:#64748b;';
                        let dlIcon = '';
                        if (r.deadlineDays !== null) {
                            if (r.deadlineDays < 0) { dlStyle = 'color:#dc2626; font-weight:600;'; dlIcon = 'üî¥ '; }
                            else if (r.deadlineDays <= 7) { dlStyle = 'color:#d97706; font-weight:600;'; dlIcon = 'üü° '; }
                            else if (r.deadlineDays <= 14) { dlStyle = 'color:#2563eb;'; dlIcon = 'üîµ '; }
                        }

                        return `
                    <tr style="border-bottom:1px solid #f1f5f9;">
                        <td style="padding:10px 12px;">
                            <div class="proj-name" data-main-action="open-dashboard" data-proj="${escapeHtml(String(r.id))}" style="font-weight:600; color:#0f172a; cursor:pointer;">${escapeHtml(String(r.name))}</div>
                        </td>
                        <td style="padding:10px 8px;"><span class="status-badge" style="background:${stBg}; color:${stColor}; font-size:10px; padding:3px 8px;">${escapeHtml(r.status)}</span></td>
                        <td style="text-align:center; font-weight:700; font-size:13px; padding:10px 8px;">${r.items}</td>
                        <td style="text-align:center; font-weight:600; font-size:13px; padding:10px 8px; color:#16a34a;">${r.doneItems || 0}</td>
                        <td style="text-align:center; font-weight:600; font-size:13px; padding:10px 8px; color:${r.issueItems > 0 ? '#dc2626' : '#94a3b8'};">${r.issueItems || 0}</td>
                        <td style="font-size:11px; padding:10px 8px; color:#64748b;">${escapeHtml(String(r.received || '‚Äî'))}</td>
                        <td style="${dlStyle} font-size:11px; padding:10px 8px;">${dlIcon}${escapeHtml(String(r.deadline || '‚Äî'))}</td>
                        <td style="font-size:11px; padding:10px 8px; color:#64748b;">${escapeHtml(String(r.sent || '‚Äî'))}</td>
                        <td style="font-size:11px; padding:10px 8px; color:#64748b; max-width:100px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${escapeAttr(r.sentTo)}">${escapeHtml(String(r.sentTo || '‚Äî'))}</td>
                        <td style="white-space:nowrap; text-align:center; padding:10px 8px;">
                            <div style="display:inline-flex; gap:3px; align-items:center;">
                                <button class="btn-sm btn-primary" data-main-action="open-dashboard" data-proj="${escapeHtml(String(r.id))}" style="font-size:10px; padding:4px 8px;" title="Dashboard">üìä</button>
                                <button class="btn-sm btn-secondary" data-main-action="open-project-detail" data-proj="${escapeHtml(String(r.id))}" style="font-size:10px; padding:4px 8px;" title="Project Detail">üìÑ</button>
                                <button class="btn-sm btn-secondary" data-main-action="open-items" data-proj="${escapeHtml(String(r.id))}" style="font-size:10px; padding:4px 8px;" title="Items">üìã</button>
                                <button class="btn-sm btn-secondary" data-main-action="open-quoting" data-proj="${escapeHtml(String(r.id))}" style="font-size:10px; padding:4px 8px;" title="Quoting">üí∞</button>
                                <button class="btn-sm btn-secondary" data-main-action="open-suppliers" data-proj="${escapeHtml(String(r.id))}" style="font-size:10px; padding:4px 8px;" title="Suppliers">üè≠</button>
                                <button class="btn-sm btn-danger" data-main-action="delete-project" data-proj="${escapeHtml(String(r.id))}" data-proj-name="${escapeAttr(r.name)}" style="font-size:10px; padding:4px 6px;" title="Delete">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `;
                    }).join('');

                    // Update projects count
                    const countEl = getEl('main-projects-count');
                    if (countEl) countEl.textContent = rows.length + ' projects';
                }
            }

            // Top suppliers - with clickable card design
            const suppliersGrid = getEl('main-top-suppliers-grid');
            if (suppliersGrid) {
                const top = Array.from(supplierAgg.entries())
                    .map(([name, rec]) => ({ name, bundles: rec.bundles, items: rec.items, value: rec.value }))
                    .sort((a, b) => (b.value - a.value) || (b.bundles - a.bundles))
                    .slice(0, 10);

                if (!top.length) {
                    suppliersGrid.innerHTML = '<div style="grid-column:span 2; text-align:center; padding:24px; color:#94a3b8;">No supplier data yet. Add suppliers to your projects to see them here.</div>';
                } else {
                    const maxValue = Math.max(...top.map(r => r.value), 1);
                    suppliersGrid.innerHTML = top.map((r, idx) => {
                        const rankClass = idx === 0 ? 'gold' : idx === 1 ? 'silver' : idx === 2 ? 'bronze' : 'normal';
                        const barWidth = Math.round((r.value / maxValue) * 100);
                        return `
                    <div class="supplier-card" data-main-action="open-supplier-detail" data-supplier="${escapeHtml(String(r.name))}">
                        <div class="supplier-rank ${rankClass}">${idx + 1}</div>
                        <div class="supplier-info">
                            <div class="supplier-name">${escapeHtml(String(r.name))}</div>
                            <div class="supplier-stats">
                                <span>üì¶ ${r.bundles} bundles</span>
                                <span>üìã ${r.items} items</span>
                            </div>
                        </div>
                        <div class="supplier-value">
                            <div class="supplier-value-main">‚Ç¨${r.value.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                            <div class="supplier-value-bar"><div class="supplier-value-bar-fill" style="width:${barWidth}%;"></div></div>
                        </div>
                    </div>
                `;
                    }).join('');
                }
            }
            // Keep old tbody for backward compatibility (hidden)
            if (tbSup) tbSup.innerHTML = '';

            // Bind filter events
            const filterInput = getEl('main-filter');
            const statusFilter = getEl('main-status-filter');
            const newProjectBtn = getEl('btn-main-new-project');

            if (filterInput && !filterInput.dataset.bound) {
                filterInput.dataset.bound = '1';
                filterInput.oninput = () => filterMainProjects();
            }
            if (statusFilter && !statusFilter.dataset.bound) {
                statusFilter.dataset.bound = '1';
                statusFilter.onchange = () => filterMainProjects();
            }
            if (newProjectBtn && !newProjectBtn.dataset.bound) {
                newProjectBtn.dataset.bound = '1';
                newProjectBtn.onclick = () => { try { openNewProjectModal(); } catch (e) { } };
            }

            // Bind supplier sort dropdown
            const supplierSortEl = getEl('main-supplier-sort');
            if (supplierSortEl && !supplierSortEl.dataset.bound) {
                supplierSortEl.dataset.bound = '1';
                supplierSortEl.onchange = () => {
                    const sortBy = supplierSortEl.value;
                    const top = Array.from(supplierAgg.entries())
                        .map(([name, rec]) => ({ name, bundles: rec.bundles, items: rec.items, value: rec.value }))
                        .sort((a, b) => {
                            if (sortBy === 'items') return (b.items - a.items) || (b.value - a.value);
                            if (sortBy === 'bundles') return (b.bundles - a.bundles) || (b.value - a.value);
                            return (b.value - a.value) || (b.bundles - a.bundles);
                        })
                        .slice(0, 10);

                    const grid = getEl('main-top-suppliers-grid');
                    if (grid && top.length) {
                        const maxValue = Math.max(...top.map(r => r.value), 1);
                        grid.innerHTML = top.map((r, idx) => {
                            const rankClass = idx === 0 ? 'gold' : idx === 1 ? 'silver' : idx === 2 ? 'bronze' : 'normal';
                            const barWidth = Math.round((r.value / maxValue) * 100);
                            return `
                        <div class="supplier-card" data-main-action="open-supplier-detail" data-supplier="${escapeHtml(String(r.name))}">
                            <div class="supplier-rank ${rankClass}">${idx + 1}</div>
                            <div class="supplier-info">
                                <div class="supplier-name">${escapeHtml(String(r.name))}</div>
                                <div class="supplier-stats">
                                    <span>üì¶ ${r.bundles} bundles</span>
                                    <span>üìã ${r.items} items</span>
                                </div>
                            </div>
                            <div class="supplier-value">
                                <div class="supplier-value-main">‚Ç¨${r.value.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                                <div class="supplier-value-bar"><div class="supplier-value-bar-fill" style="width:${barWidth}%;"></div></div>
                            </div>
                        </div>
                    `;
                        }).join('');
                    }
                };
            }

            // Initialize resizable columns
            initMainTableResizableColumns();

            // Migrate existing items to use status_id system
            migrateAllProjectsToStatusId();

            // Initialize status dropdowns with dynamic values from config
            refreshAllStatusDropdowns();

            // Initialize pagination for main projects table
            setTimeout(() => {
                initTablePagination('main-projects-table', { storageKey: 'rfq_main_projects_page' });
            }, 50);

            // Render charts
            _renderMainSuppliersChart(supplierAgg);
            _renderMainValueChart(rows);

            // Bind edit layout button
            const btnEditLayout = getEl('btn-main-edit-layout');
            if (btnEditLayout && !btnEditLayout.dataset.bound) {
                btnEditLayout.dataset.bound = '1';
                btnEditLayout.onclick = () => toggleMainEditMode();
            }
        }

        // =========================================================
        // Main Dashboard Charts
        // =========================================================
        let mainSuppliersChartInstance = null;
        let mainValueChartInstance = null;

        function _renderMainSuppliersChart(supplierAgg) {
            const canvas = document.getElementById('main-suppliers-chart');
            if (!canvas || !window.Chart) return;

            const top = Array.from(supplierAgg.entries())
                .map(([name, rec]) => ({ name, value: rec.value, items: rec.items, bundles: rec.bundles }))
                .sort((a, b) => b.value - a.value)
                .slice(0, 8);

            if (mainSuppliersChartInstance) {
                mainSuppliersChartInstance.destroy();
            }

            const colors = ['#3b82f6', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'];

            mainSuppliersChartInstance = new Chart(canvas.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: top.map(t => t.name),
                    datasets: [{
                        data: top.map(t => t.value),
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `‚Ç¨${ctx.raw.toLocaleString()}`
                            }
                        }
                    }
                }
            });
        }

        function _renderMainValueChart(rows) {
            const canvas = document.getElementById('main-value-chart-canvas');
            if (!canvas || !window.Chart) return;

            const top = rows.filter(r => r.value > 0).sort((a, b) => b.value - a.value).slice(0, 6);

            if (mainValueChartInstance) {
                mainValueChartInstance.destroy();
            }

            const colors = ['#22c55e', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];

            mainValueChartInstance = new Chart(canvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: top.map(t => t.name.length > 12 ? t.name.substring(0, 12) + '...' : t.name),
                    datasets: [{
                        data: top.map(t => t.value),
                        backgroundColor: colors,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `‚Ç¨${ctx.raw.toLocaleString()}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: (v) => '‚Ç¨' + (v >= 1000 ? (v / 1000).toFixed(0) + 'k' : v)
                            }
                        },
                        y: {
                            ticks: { font: { size: 10 } }
                        }
                    }
                }
            });
        }

        // =========================================================
        // Main Dashboard Edit Mode
        // =========================================================
        let mainEditMode = false;

        function toggleMainEditMode() {
            const grid = document.getElementById('main-dashboard-grid');
            if (!grid) return;

            mainEditMode = !mainEditMode;

            if (mainEditMode) {
                grid.classList.add('edit-mode');
                showMainEditOverlay();
            } else {
                grid.classList.remove('edit-mode');
                hideMainEditOverlay();
            }
        }

        function showMainEditOverlay() {
            let overlay = document.getElementById('main-edit-overlay');
            if (overlay) overlay.remove();

            overlay = document.createElement('div');
            overlay.id = 'main-edit-overlay';
            overlay.style.cssText = 'position:fixed; top:0; left:0; right:0; background:linear-gradient(135deg,#3b82f6,#1d4ed8); color:white; padding:12px 24px; display:flex; align-items:center; justify-content:space-between; z-index:9999; box-shadow:0 4px 12px rgba(0,0,0,0.2);';
            overlay.innerHTML = `
        <div style="display:flex; align-items:center; gap:12px;">
            <span style="font-size:18px;">üé®</span>
            <span style="font-weight:600;">Layout Edit Mode</span>
            <span style="font-size:12px; opacity:0.8;">Drag boxes, use +/- to resize</span>
        </div>
        <div style="display:flex; gap:10px;">
            <button id="btn-main-add-box" style="background:#8b5cf6; border:none; color:white; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:600;">+ Add Box</button>
            <button id="btn-main-layout-save" style="background:#22c55e; border:none; color:white; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:600;">‚úì Save</button>
            <button id="btn-main-layout-cancel" style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.4); color:white; padding:8px 16px; border-radius:6px; cursor:pointer;">Cancel</button>
            <button id="btn-main-layout-reset" style="background:#ef4444; border:none; color:white; padding:8px 16px; border-radius:6px; cursor:pointer;">‚Ü∫ Reset</button>
        </div>
    `;
            document.body.appendChild(overlay);

            document.getElementById('btn-main-add-box').onclick = openMainAddBoxModal;

            document.getElementById('btn-main-layout-save').onclick = () => {
                saveMainLayout();
                toggleMainEditMode();
                showToast('Layout saved!', 'success');
            };

            document.getElementById('btn-main-layout-cancel').onclick = () => {
                toggleMainEditMode();
            };

            document.getElementById('btn-main-layout-reset').onclick = async () => {
                const confirmed = await window.showConfirmDialog({
                    title: 'Reset Main Layout',
                    message: 'Reset dashboard to default layout? This will remove custom boxes and restore default sizes.',
                    type: 'warning',
                    okText: 'Reset',
                    cancelText: 'Cancel'
                });
                if (confirmed) {
                    localStorage.removeItem('rfq_main_layout');
                    localStorage.removeItem('rfq_main_custom_boxes');
                    location.reload();
                }
            };

            initMainDragDrop();
        }

        function hideMainEditOverlay() {
            const overlay = document.getElementById('main-edit-overlay');
            if (overlay) overlay.remove();
        }

        function saveMainLayout() {
            const grid = document.getElementById('main-dashboard-grid');
            if (!grid) return;

            const boxes = Array.from(grid.querySelectorAll('.main-box'));
            const order = boxes.map(box => box.dataset.boxId);
            const sizes = {};
            const visibility = {};

            boxes.forEach(box => {
                const id = box.dataset.boxId;
                sizes[id] = {
                    colSpan: parseInt(box.dataset.colSpan) || 1,
                    rowSpan: parseInt(box.dataset.rowSpan) || 1
                };
                visibility[id] = !box.classList.contains('hidden-box');
            });

            localStorage.setItem('rfq_main_layout', JSON.stringify({ order, sizes, visibility }));
        }

        function loadMainLayout() {
            const saved = localStorage.getItem('rfq_main_layout');
            if (!saved) return;

            try {
                const config = JSON.parse(saved);
                const grid = document.getElementById('main-dashboard-grid');
                if (!grid) return;

                const boxMap = {};
                grid.querySelectorAll('.main-box').forEach(box => {
                    boxMap[box.dataset.boxId] = box;
                });

                // Apply order
                if (config.order) {
                    config.order.forEach(id => {
                        const box = boxMap[id];
                        if (box) grid.appendChild(box);
                    });
                }

                // Apply sizes
                if (config.sizes) {
                    Object.keys(config.sizes).forEach(id => {
                        const box = boxMap[id];
                        if (box && config.sizes[id]) {
                            box.dataset.colSpan = config.sizes[id].colSpan || 1;
                            box.dataset.rowSpan = config.sizes[id].rowSpan || 1;
                            updateMainBoxGridStyle(box);
                        }
                    });
                }

                // Apply visibility
                if (config.visibility) {
                    Object.keys(config.visibility).forEach(id => {
                        const box = boxMap[id];
                        if (box) {
                            if (config.visibility[id]) {
                                box.classList.remove('hidden-box');
                            } else {
                                box.classList.add('hidden-box');
                            }
                        }
                    });
                }

                // Load custom boxes
                loadMainCustomBoxes();
            } catch (e) {
                console.warn('Failed to load main layout:', e);
            }
        }

        function updateMainBoxGridStyle(box) {
            const colSpan = parseInt(box.dataset.colSpan) || 1;
            const rowSpan = parseInt(box.dataset.rowSpan) || 1;
            box.style.gridColumn = `span ${colSpan}`;
            box.style.gridRow = rowSpan > 1 ? `span ${rowSpan}` : '';
            // Update size indicator
            const indicator = box.querySelector('.main-box-size-indicator');
            if (indicator) indicator.textContent = `${colSpan}√ó${rowSpan}`;
        }

        function initMainDragDrop() {
            const grid = document.getElementById('main-dashboard-grid');
            if (!grid) return;

            let draggedBox = null;

            grid.querySelectorAll('.main-box').forEach(box => {
                box.draggable = true;

                box.ondragstart = (e) => {
                    if (!mainEditMode) return;
                    draggedBox = box;
                    box.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                };

                box.ondragend = () => {
                    box.classList.remove('dragging');
                    draggedBox = null;
                };

                box.ondragover = (e) => {
                    if (!mainEditMode || !draggedBox || draggedBox === box) return;
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';

                    const rect = box.getBoundingClientRect();
                    const midY = rect.top + rect.height / 2;
                    if (e.clientY < midY) {
                        box.parentNode.insertBefore(draggedBox, box);
                    } else {
                        box.parentNode.insertBefore(draggedBox, box.nextSibling);
                    }
                };

                // Size controls and actions
                const controls = box.querySelectorAll('.main-box-btn');
                controls.forEach(btn => {
                    btn.onclick = async (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        const action = btn.dataset.action;

                        if (action === 'resize-smaller') {
                            const current = parseInt(box.dataset.colSpan) || 1;
                            if (current === 4) box.dataset.colSpan = 3;
                            else if (current === 3) box.dataset.colSpan = 2;
                            else if (current === 2) box.dataset.colSpan = 1;
                            updateMainBoxGridStyle(box);
                        } else if (action === 'resize-larger') {
                            const current = parseInt(box.dataset.colSpan) || 1;
                            if (current === 1) box.dataset.colSpan = 2;
                            else if (current === 2) box.dataset.colSpan = 3;
                            else if (current === 3) box.dataset.colSpan = 4;
                            updateMainBoxGridStyle(box);
                        } else if (action === 'height-smaller') {
                            const current = parseInt(box.dataset.rowSpan) || 1;
                            if (current === 4) box.dataset.rowSpan = 3;
                            else if (current === 3) box.dataset.rowSpan = 2;
                            else if (current === 2) box.dataset.rowSpan = 1;
                            updateMainBoxGridStyle(box);
                        } else if (action === 'height-larger') {
                            const current = parseInt(box.dataset.rowSpan) || 1;
                            if (current === 1) box.dataset.rowSpan = 2;
                            else if (current === 2) box.dataset.rowSpan = 3;
                            else if (current === 3) box.dataset.rowSpan = 4;
                            updateMainBoxGridStyle(box);
                        } else if (action === 'toggle-visibility') {
                            box.classList.toggle('hidden-box');
                            btn.textContent = box.classList.contains('hidden-box') ? 'üëÅ‚Äçüó®' : 'üëÅ';
                        } else if (action === 'delete-box') {
                            if (box.dataset.boxId === 'main-projects-table-box') {
                                showToast('The All Projects box cannot be deleted', 'warning');
                            } else if (box.dataset.customBox === 'true') {
                                handleDeleteMainBox(box);
                            } else {
                                const hideConfirmed = await window.showConfirmDialog({
                                    title: 'Hide Box',
                                    message: 'Hide this box from the dashboard? You can restore it with Reset Layout.',
                                    type: 'warning',
                                    okText: 'Hide',
                                    cancelText: 'Cancel'
                                });
                                if (hideConfirmed) {
                                    box.classList.add('hidden-box');
                                    saveMainLayout();
                                    showToast('Box hidden. Use Reset Layout to restore.', 'info');
                                }
                            }
                        }
                    };
                });
            });
        }

        async function handleDeleteMainBox(box) {
            const confirmed = await window.showConfirmDialog({
                title: 'Delete Box',
                message: 'Delete this custom box?',
                type: 'danger',
                okText: 'Delete',
                cancelText: 'Cancel'
            });
            if (confirmed) {
                box.remove();
                saveMainCustomBoxes();
                showToast('Box deleted', 'success');
            }
        }

        // =========================================================
        // Main Dashboard Custom Box System - $23M Premium Edition
        // =========================================================
        const MAIN_BOX_TYPES = {
            // === METRICS & KPIs ===
            'main-stat': { name: 'Single Metric', icon: 'üìä', category: 'Metrics', description: 'Display one key number with trend' },
            'main-multi-stat': { name: 'Multi Metrics', icon: 'üìà', category: 'Metrics', description: 'Display 2-6 metrics in grid' },
            'main-gauge': { name: 'Gauge Meter', icon: 'üéØ', category: 'Metrics', description: 'Circular progress gauge' },
            'main-progress': { name: 'Progress Bar', icon: '‚è≥', category: 'Metrics', description: 'Linear progress indicator' },
            'main-comparison': { name: 'Comparison', icon: '‚öñÔ∏è', category: 'Metrics', description: 'Compare two values side by side' },

            // === PROJECTS ===
            'main-project-filter': { name: 'Filtered Projects', icon: 'üìã', category: 'Projects', description: 'Projects by status filter' },
            'main-project-cards': { name: 'Project Cards', icon: 'üóÇÔ∏è', category: 'Projects', description: 'Visual project cards' },
            'main-recent-projects': { name: 'Recent Projects', icon: 'üïê', category: 'Projects', description: 'Recently updated projects' },

            // === DEADLINES & TIME ===
            'main-countdown': { name: 'Countdown Timer', icon: '‚è±Ô∏è', category: 'Time', description: 'Days to specific date' },
            'main-deadline-list': { name: 'Deadline List', icon: 'üìÜ', category: 'Time', description: 'Upcoming deadlines sorted' },
            'main-overdue': { name: 'Overdue Alert', icon: 'üö®', category: 'Time', description: 'Overdue items summary' },

            // === SUPPLIERS ===
            'main-supplier-ranking': { name: 'Supplier Ranking', icon: 'üèÜ', category: 'Suppliers', description: 'Top suppliers by value/items' },
            'main-supplier-cards': { name: 'Supplier Cards', icon: 'üè≠', category: 'Suppliers', description: 'Supplier contact cards' },

            // === ITEMS ===
            'main-items-summary': { name: 'Items Summary', icon: 'üìù', category: 'Items', description: 'Items status breakdown' },
            'main-items-done': { name: 'Items Done', icon: '‚úÖ', category: 'Items', description: 'Items with Done status' },
            'main-items-issues': { name: 'Items with Issues', icon: '‚ö†Ô∏è', category: 'Items', description: 'Items needing attention' },
            'main-items-in-progress': { name: 'Items In Progress', icon: 'üîÑ', category: 'Items', description: 'Items being worked on' },
            'main-unquoted-items': { name: 'Unquoted Items', icon: '‚ùì', category: 'Items', description: 'Items without prices' },

            // === FINANCIAL ===
            'main-currency-rates': { name: 'Currency Rates', icon: 'üí±', category: 'Financial', description: 'Exchange rates display' },

            // === ACTIONS & TOOLS ===
            'main-link-buttons': { name: 'Quick Links', icon: 'üîó', category: 'Actions', description: 'Custom navigation buttons' },
            'main-action-buttons': { name: 'Action Buttons', icon: '‚ö°', category: 'Actions', description: 'Quick action shortcuts' },

            // === ACTIVITY & NOTES ===
            'main-todo-list': { name: 'Todo List', icon: '‚úÖ', category: 'Activity', description: 'Task checklist' },
            'main-notes': { name: 'Notes', icon: 'üìù', category: 'Activity', description: 'Quick notes widget' },

            // === INFO & DISPLAY ===
            'main-note': { name: 'Text Block', icon: 'üìÑ', category: 'Info', description: 'Custom text content' },
            'main-image': { name: 'Image/Logo', icon: 'üñºÔ∏è', category: 'Info', description: 'Display image or logo' },
            'main-iframe': { name: 'Embed Widget', icon: 'üåê', category: 'Info', description: 'Embed external content' },
            'main-clock': { name: 'World Clock', icon: 'üïê', category: 'Info', description: 'Multiple timezone clocks' }
        };

        function openMainAddBoxModal() {
            const existing = document.getElementById('main-add-box-modal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'main-add-box-modal';
            modal.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:10000; display:flex; align-items:center; justify-content:center;';

            // Find hidden boxes
            const hiddenBoxes = [];
            document.querySelectorAll('.main-dashboard-grid .main-box.hidden-box').forEach(box => {
                const id = box.dataset.boxId;
                const title = box.querySelector('.main-box-title')?.textContent || id;
                hiddenBoxes.push({ id, title, box });
            });

            // Group box types by category
            const categories = {};
            Object.entries(MAIN_BOX_TYPES).forEach(([key, val]) => {
                const cat = val.category || 'Other';
                if (!categories[cat]) categories[cat] = [];
                categories[cat].push({ key, ...val });
            });

            const categoryColors = {
                'Metrics': '#3b82f6', 'Charts': '#8b5cf6', 'Projects': '#22c55e', 'Time': '#f59e0b',
                'Suppliers': '#ec4899', 'Items': '#06b6d4', 'Financial': '#10b981', 'Actions': '#6366f1',
                'Activity': '#f97316', 'Info': '#64748b', 'Hidden': '#ef4444'
            };

            let categoryTabs = Object.keys(categories).map((cat, i) =>
                `<button class="main-box-cat-tab ${i === 0 ? 'active' : ''}" data-cat="${cat}" style="padding:8px 12px; border:none; background:${i === 0 ? categoryColors[cat] || '#3b82f6' : '#f1f5f9'}; color:${i === 0 ? 'white' : '#64748b'}; border-radius:6px; cursor:pointer; font-size:11px; font-weight:600; transition:all 0.2s;">${cat}</button>`
            ).join('');

            // Add Hidden tab if there are hidden boxes
            if (hiddenBoxes.length > 0) {
                categoryTabs += `<button class="main-box-cat-tab" data-cat="Hidden" style="padding:8px 12px; border:none; background:#f1f5f9; color:#ef4444; border-radius:6px; cursor:pointer; font-size:11px; font-weight:600; transition:all 0.2s;">üôà Hidden (${hiddenBoxes.length})</button>`;
            }

            const firstCat = Object.keys(categories)[0];
            const renderCategoryBoxes = (cat) => {
                if (cat === 'Hidden') {
                    if (hiddenBoxes.length === 0) {
                        return '<div style="grid-column:span 2; text-align:center; padding:40px; color:#94a3b8;">No hidden boxes</div>';
                    }
                    return hiddenBoxes.map(hb =>
                        `<div class="main-box-restore-option" data-box-id="${hb.id}" style="padding:12px 14px; border:2px dashed #fecaca; border-radius:8px; cursor:pointer; transition:all 0.2s; display:flex; align-items:center; gap:10px; background:#fef2f2;">
                    <span style="font-size:20px;">üôà</span>
                    <div style="flex:1; min-width:0;">
                        <div style="font-weight:600; color:#991b1b; font-size:13px;">${hb.title.replace(/^[\s\S]*?([^\s]+)\s*$/, '$1') || hb.id}</div>
                        <div style="font-size:10px; color:#dc2626;">Click to restore this box</div>
                    </div>
                    <span style="font-size:16px; color:#22c55e;">üëÅ</span>
                </div>`
                    ).join('');
                }
                return categories[cat].map(val =>
                    `<div class="main-box-type-option" data-type="${val.key}" style="padding:10px 12px; border:1px solid #e2e8f0; border-radius:8px; cursor:pointer; transition:all 0.2s; display:flex; align-items:center; gap:10px; background:white;">
                <span style="font-size:20px;">${val.icon}</span>
                <div style="flex:1; min-width:0;">
                    <div style="font-weight:600; color:#1e293b; font-size:13px;">${val.name}</div>
                    <div style="font-size:10px; color:#94a3b8; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${val.description}</div>
                </div>
            </div>`
                ).join('');
            };

            modal.innerHTML = `
        <div style="background:white; border-radius:16px; box-shadow:0 25px 50px rgba(0,0,0,0.25); width:600px; max-height:85vh; overflow:hidden; display:flex; flex-direction:column;">
            <div style="padding:20px 24px; background:linear-gradient(135deg,#1e293b,#334155); color:white; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-size:18px; font-weight:700;">‚ûï Add Dashboard Box</div>
                    <div style="font-size:11px; opacity:0.7; margin-top:2px;">Choose from 40+ premium widgets</div>
                </div>
                <button id="btn-close-main-add-box" style="background:rgba(255,255,255,0.1); border:none; width:32px; height:32px; border-radius:8px; font-size:18px; cursor:pointer; color:white;">&times;</button>
            </div>
            <div style="padding:16px 20px; border-bottom:1px solid #e2e8f0; background:#f8fafc;">
                <div style="margin-bottom:12px;">
                    <input type="text" id="main-box-title" class="rfq-input" placeholder="Box title (optional)" style="width:100%; padding:10px 14px; font-size:14px;">
                </div>
                <div style="display:flex; flex-wrap:wrap; gap:6px;">
                    ${categoryTabs}
                </div>
            </div>
            <div style="flex:1; overflow-y:auto; padding:16px 20px;">
                <div id="main-box-types" style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                    ${renderCategoryBoxes(firstCat)}
                </div>
                <div id="main-box-config-fields" style="display:none; margin-top:16px; padding-top:16px; border-top:1px solid #e2e8f0;"></div>
            </div>
            <div style="padding:16px 20px; border-top:1px solid #e2e8f0; background:#f8fafc; display:flex; justify-content:space-between; align-items:center;">
                <div id="main-box-selection-info" style="font-size:12px; color:#64748b;">Select a box type</div>
                <div style="display:flex; gap:10px;">
                    <button id="btn-cancel-main-add-box" class="btn-secondary">Cancel</button>
                    <button id="btn-create-main-box" class="btn-primary" disabled style="padding:10px 20px;">Create Box</button>
                </div>
            </div>
        </div>
    `;
            document.body.appendChild(modal);

            let selectedType = null;

            // Category tab switching
            modal.querySelectorAll('.main-box-cat-tab').forEach(tab => {
                tab.onclick = () => {
                    const cat = tab.dataset.cat;
                    modal.querySelectorAll('.main-box-cat-tab').forEach(t => {
                        t.style.background = '#f1f5f9';
                        t.style.color = cat === 'Hidden' ? '#ef4444' : '#64748b';
                        t.classList.remove('active');
                    });
                    tab.style.background = categoryColors[cat] || '#3b82f6';
                    tab.style.color = 'white';
                    tab.classList.add('active');
                    document.getElementById('main-box-types').innerHTML = renderCategoryBoxes(cat);
                    bindTypeOptions();
                    bindRestoreOptions();
                    selectedType = null;
                    document.getElementById('btn-create-main-box').disabled = true;
                    document.getElementById('main-box-config-fields').style.display = 'none';
                    document.getElementById('main-box-selection-info').textContent = cat === 'Hidden' ? 'Click a box to restore it' : 'Select a box type';
                };
            });

            function bindRestoreOptions() {
                modal.querySelectorAll('.main-box-restore-option').forEach(opt => {
                    opt.onclick = () => {
                        const boxId = opt.dataset.boxId;
                        const box = document.querySelector(`.main-box[data-box-id="${boxId}"]`);
                        if (box) {
                            box.classList.remove('hidden-box');
                            const visBtn = box.querySelector('[data-action="toggle-visibility"]');
                            if (visBtn) visBtn.textContent = 'üëÅ';
                            saveMainLayout();
                            modal.remove();
                            showToast('Box restored!', 'success');
                        }
                    };
                });
            }

            function bindTypeOptions() {
                modal.querySelectorAll('.main-box-type-option').forEach(opt => {
                    opt.onclick = () => {
                        modal.querySelectorAll('.main-box-type-option').forEach(o => {
                            o.style.borderColor = '#e2e8f0';
                            o.style.background = 'white';
                        });
                        opt.style.borderColor = '#3b82f6';
                        opt.style.background = '#eff6ff';
                        selectedType = opt.dataset.type;
                        document.getElementById('btn-create-main-box').disabled = false;
                        const info = MAIN_BOX_TYPES[selectedType];
                        document.getElementById('main-box-selection-info').innerHTML = `<span style="color:#3b82f6; font-weight:600;">${info.icon} ${info.name}</span> selected`;
                        showMainBoxConfigFields(selectedType);
                    };
                });
            }
            bindTypeOptions();
            bindRestoreOptions();

            document.getElementById('btn-close-main-add-box').onclick = () => modal.remove();
            document.getElementById('btn-cancel-main-add-box').onclick = () => modal.remove();

            document.getElementById('btn-create-main-box').onclick = () => {
                if (!selectedType) return;
                const title = document.getElementById('main-box-title').value || MAIN_BOX_TYPES[selectedType].name;
                const config = collectMainBoxConfig(selectedType, title);
                if (config) {
                    createMainCustomBox(config);
                    saveMainCustomBoxes();
                    modal.remove();
                    showToast('Box created!', 'success');
                }
            };
        }

        function showMainBoxConfigFields(type) {
            const container = document.getElementById('main-box-config-fields');
            container.style.display = 'block';

            const metricOptions = `
        <optgroup label="Counts">
            <option value="total-projects">Total Projects</option>
            <option value="total-items">Total Items</option>
            <option value="total-suppliers">Total Suppliers</option>
            <option value="total-bundles">Total RFQ Bundles</option>
            <option value="open-bundles">Open RFQ Bundles</option>
            <option value="quoted-items">Quoted Items</option>
            <option value="unquoted-items">Unquoted Items</option>
        </optgroup>
        <optgroup label="Values">
            <option value="total-value">Total Value (EUR)</option>
            <option value="avg-project-value">Avg Project Value</option>
            <option value="max-project-value">Max Project Value</option>
            <option value="total-savings">Total Savings</option>
        </optgroup>
        <optgroup label="Rates">
            <option value="avg-quote-rate">Average Quote Rate %</option>
            <option value="supplier-coverage">Supplier Coverage %</option>
            <option value="completion-rate">Completion Rate %</option>
        </optgroup>
        <optgroup label="Time">
            <option value="overdue-projects">Overdue Projects</option>
            <option value="due-7-days">Due in 7 Days</option>
            <option value="due-14-days">Due in 14 Days</option>
            <option value="avg-days-to-deadline">Avg Days to Deadline</option>
        </optgroup>
    `;

            const colorOptions = `
        <option value="blue">Blue</option>
        <option value="green">Green</option>
        <option value="purple">Purple</option>
        <option value="orange">Orange</option>
        <option value="red">Red</option>
        <option value="cyan">Cyan</option>
        <option value="pink">Pink</option>
    `;

            let html = '';
            switch (type) {
                case 'main-note':
                case 'main-notes':
                    html = `<label class="cfg-label">CONTENT</label>
                <textarea id="main-box-cfg-content" class="rfq-input" style="width:100%; min-height:100px;" placeholder="Enter text..."></textarea>`;
                    break;

                case 'main-countdown':
                    html = `<div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                <div><label class="cfg-label">TARGET DATE</label><input type="date" id="main-box-cfg-date" class="rfq-input" style="width:100%;"></div>
                <div><label class="cfg-label">EVENT LABEL</label><input type="text" id="main-box-cfg-label" class="rfq-input" style="width:100%;" placeholder="e.g., Deadline"></div>
            </div>`;
                    break;

                case 'main-link-buttons':
                case 'main-action-buttons':
                    html = `<label class="cfg-label">BUTTONS (Label|action per line)</label>
                <textarea id="main-box-cfg-links" class="rfq-input" style="width:100%; min-height:100px;" placeholder="Dashboard|dashboard\nExport|export\nSuppliers|supplier-list"></textarea>
                <div style="font-size:10px; color:#94a3b8; margin-top:6px;">Views: dashboard, items, quoting, suppliers, export, settings, database</div>`;
                    break;

                case 'main-project-filter':
                case 'main-project-cards':
                case 'main-recent-projects':
                    html = `<div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                <div><label class="cfg-label">FILTER BY STATUS</label>
                    <select id="main-box-cfg-status" class="rfq-input" style="width:100%;">
                        <option value="">All Status</option><option value="Created">Created</option><option value="In process">In Process</option><option value="Done">Done</option>
                    </select></div>
                <div><label class="cfg-label">MAX ITEMS</label><input type="number" id="main-box-cfg-limit" class="rfq-input" style="width:100%;" value="5" min="1" max="20"></div>
            </div>`;
                    break;

                case 'main-stat':
                case 'main-gauge':
                case 'main-progress':
                    html = `<div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                <div><label class="cfg-label">METRIC</label><select id="main-box-cfg-metric" class="rfq-input" style="width:100%;">${metricOptions}</select></div>
                <div><label class="cfg-label">COLOR</label><select id="main-box-cfg-color" class="rfq-input" style="width:100%;">${colorOptions}</select></div>
            </div>
            ${type === 'main-progress' || type === 'main-gauge' ? '<div style="margin-top:12px;"><label class="cfg-label">TARGET VALUE</label><input type="number" id="main-box-cfg-target" class="rfq-input" style="width:100%;" value="100" min="1"></div>' : ''}`;
                    break;

                case 'main-multi-stat':
                    html = `<label class="cfg-label">SELECT METRICS (2-6)</label>
                <div id="main-box-cfg-metrics" style="display:grid; grid-template-columns:1fr 1fr; gap:6px; max-height:200px; overflow-y:auto;">
                    ${['total-projects', 'total-items', 'total-suppliers', 'total-value', 'avg-quote-rate', 'overdue-projects', 'quoted-items', 'unquoted-items', 'open-bundles', 'completion-rate'].map(m =>
                        `<label style="display:flex; align-items:center; gap:6px; padding:6px 8px; border:1px solid #e2e8f0; border-radius:4px; cursor:pointer; font-size:11px;">
                            <input type="checkbox" name="metrics" value="${m}"> ${m.replace(/-/g, ' ')}
                        </label>`
                    ).join('')}
                </div>`;
                    break;

                case 'main-comparison':
                    html = `<div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                <div><label class="cfg-label">METRIC 1</label><select id="main-box-cfg-metric1" class="rfq-input" style="width:100%;">${metricOptions}</select></div>
                <div><label class="cfg-label">METRIC 2</label><select id="main-box-cfg-metric2" class="rfq-input" style="width:100%;">${metricOptions}</select></div>
            </div>`;
                    break;

                case 'main-pie-chart':
                case 'main-bar-chart':
                    html = `<div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                <div><label class="cfg-label">DATA SOURCE</label>
                    <select id="main-box-cfg-source" class="rfq-input" style="width:100%;">
                        <option value="projects-by-status">Projects by Status</option>
                        <option value="items-by-status">Items by Status</option>
                        <option value="value-by-project">Value by Project</option>
                        <option value="items-by-supplier">Items by Supplier</option>
                        <option value="bundles-by-status">Bundles by Status</option>
                    </select></div>
                <div><label class="cfg-label">MAX ITEMS</label><input type="number" id="main-box-cfg-limit" class="rfq-input" style="width:100%;" value="8" min="3" max="20"></div>
            </div>`;
                    break;

                case 'main-supplier-ranking':
                case 'main-supplier-cards':
                    html = `<div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                <div><label class="cfg-label">SORT BY</label>
                    <select id="main-box-cfg-sort" class="rfq-input" style="width:100%;">
                        <option value="value">Total Value</option><option value="items">Item Count</option><option value="bundles">Bundle Count</option><option value="name">Name</option>
                    </select></div>
                <div><label class="cfg-label">MAX ITEMS</label><input type="number" id="main-box-cfg-limit" class="rfq-input" style="width:100%;" value="10" min="1" max="50"></div>
            </div>`;
                    break;

                case 'main-deadline-list':
                case 'main-overdue':
                case 'main-items-done':
                case 'main-items-issues':
                case 'main-items-in-progress':
                case 'main-unquoted-items':
                case 'main-items-summary':
                    html = `<div><label class="cfg-label">MAX ITEMS</label><input type="number" id="main-box-cfg-limit" class="rfq-input" style="width:100%;" value="10" min="1" max="50"></div>`;
                    break;

                case 'main-todo-list':
                    html = `<label class="cfg-label">INITIAL TASKS (one per line)</label>
                <textarea id="main-box-cfg-todos" class="rfq-input" style="width:100%; min-height:80px;" placeholder="Review quotes\nSend RFQ\nUpdate prices"></textarea>`;
                    break;

                case 'main-currency-rates':
                    html = `<label class="cfg-label">CURRENCIES TO SHOW</label>
                <div id="main-box-cfg-currencies" style="display:flex; flex-wrap:wrap; gap:6px;">
                    ${['USD', 'GBP', 'CZK', 'PLN', 'CHF', 'JPY', 'CNY', 'SEK', 'HUF'].map(c =>
                        `<label style="display:flex; align-items:center; gap:4px; padding:6px 10px; border:1px solid #e2e8f0; border-radius:4px; cursor:pointer; font-size:11px;">
                            <input type="checkbox" name="currencies" value="${c}" ${['USD', 'GBP', 'CZK'].includes(c) ? 'checked' : ''}> ${c}
                        </label>`
                    ).join('')}
                </div>`;
                    break;

                case 'main-clock':
                    html = `<label class="cfg-label">TIMEZONES (one per line: Label|Timezone)</label>
                <textarea id="main-box-cfg-timezones" class="rfq-input" style="width:100%; min-height:80px;" placeholder="Prague|Europe/Prague\nNew York|America/New_York\nTokyo|Asia/Tokyo"></textarea>`;
                    break;

                case 'main-image':
                    html = `<label class="cfg-label">IMAGE URL</label>
                <input type="text" id="main-box-cfg-url" class="rfq-input" style="width:100%;" placeholder="https://...">`;
                    break;

                case 'main-iframe':
                    html = `<label class="cfg-label">EMBED URL</label>
                <input type="text" id="main-box-cfg-url" class="rfq-input" style="width:100%;" placeholder="https://...">
                <div style="font-size:10px; color:#94a3b8; margin-top:6px;">Use embed URLs for YouTube, Google Docs, etc.</div>`;
                    break;

                default:
                    html = `<div style="padding:16px; background:#f8fafc; border-radius:8px; text-align:center; color:#64748b; font-size:12px;">
                This box type has no additional configuration. Click "Create Box" to add it.
            </div>`;
            }

            container.innerHTML = `<style>.cfg-label{display:block;font-size:11px;font-weight:600;color:#64748b;margin-bottom:6px;text-transform:uppercase;}</style>${html}`;
        }

        function collectMainBoxConfig(type, title) {
            const config = {
                id: 'main-custom-' + Date.now(),
                type: type,
                title: title
            };

            switch (type) {
                case 'main-note':
                case 'main-notes':
                    config.content = document.getElementById('main-box-cfg-content')?.value || '';
                    break;

                case 'main-countdown':
                    config.targetDate = document.getElementById('main-box-cfg-date')?.value;
                    config.eventLabel = document.getElementById('main-box-cfg-label')?.value || 'Event';
                    if (!config.targetDate) { showToast('Please select a target date', 'warning'); return null; }
                    break;

                case 'main-link-buttons':
                case 'main-action-buttons':
                    config.links = document.getElementById('main-box-cfg-links')?.value || '';
                    break;

                case 'main-project-filter':
                case 'main-project-cards':
                case 'main-recent-projects':
                    config.status = document.getElementById('main-box-cfg-status')?.value || '';
                    config.limit = parseInt(document.getElementById('main-box-cfg-limit')?.value) || 5;
                    break;

                case 'main-stat':
                case 'main-gauge':
                case 'main-progress':
                    config.metric = document.getElementById('main-box-cfg-metric')?.value || 'total-projects';
                    config.color = document.getElementById('main-box-cfg-color')?.value || 'blue';
                    config.target = parseInt(document.getElementById('main-box-cfg-target')?.value) || 100;
                    break;

                case 'main-multi-stat':
                    const checked = document.querySelectorAll('#main-box-cfg-metrics input:checked');
                    config.metrics = Array.from(checked).map(c => c.value);
                    if (config.metrics.length < 2) { showToast('Select at least 2 metrics', 'warning'); return null; }
                    break;

                case 'main-comparison':
                    config.metric1 = document.getElementById('main-box-cfg-metric1')?.value || 'total-projects';
                    config.metric2 = document.getElementById('main-box-cfg-metric2')?.value || 'total-items';
                    break;

                case 'main-pie-chart':
                case 'main-bar-chart':
                    config.source = document.getElementById('main-box-cfg-source')?.value || 'projects-by-status';
                    config.limit = parseInt(document.getElementById('main-box-cfg-limit')?.value) || 8;
                    break;

                case 'main-supplier-ranking':
                case 'main-supplier-cards':
                    config.sortBy = document.getElementById('main-box-cfg-sort')?.value || 'value';
                    config.limit = parseInt(document.getElementById('main-box-cfg-limit')?.value) || 10;
                    break;

                case 'main-deadline-list':
                case 'main-overdue':
                case 'main-items-issues':
                case 'main-unquoted-items':
                case 'main-price-alerts':
                case 'main-rfq-bundles':
                case 'main-quote-validity':
                case 'main-recent-quotes':
                case 'main-activity-feed':
                    config.limit = parseInt(document.getElementById('main-box-cfg-limit')?.value) || 10;
                    break;

                case 'main-todo-list':
                    const todosText = document.getElementById('main-box-cfg-todos')?.value || '';
                    config.todos = todosText.split('\n').filter(t => t.trim()).map((t, i) => ({ id: i, text: t.trim(), done: false }));
                    break;

                case 'main-currency-rates':
                    const currChecked = document.querySelectorAll('#main-box-cfg-currencies input:checked');
                    config.currencies = Array.from(currChecked).map(c => c.value);
                    if (config.currencies.length === 0) { showToast('Select at least 1 currency', 'warning'); return null; }
                    break;

                case 'main-clock':
                    config.timezones = document.getElementById('main-box-cfg-timezones')?.value || 'Prague|Europe/Prague';
                    break;

                case 'main-image':
                case 'main-iframe':
                    config.url = document.getElementById('main-box-cfg-url')?.value || '';
                    break;
            }

            return config;
        }

        function createMainCustomBox(config) {
            const grid = document.getElementById('main-dashboard-grid');
            if (!grid) return;

            const box = document.createElement('div');
            box.className = 'main-box';
            box.dataset.boxId = config.id;
            box.dataset.colSpan = config.colSpan || '1';
            box.dataset.rowSpan = config.rowSpan || '1';
            box.dataset.customBox = 'true';
            box.dataset.boxConfig = JSON.stringify(config);

            const icon = MAIN_BOX_TYPES[config.type]?.icon || 'üì¶';

            box.innerHTML = `
        <div class="main-box-header">
            <span class="main-box-title">${icon} ${escapeHtml(config.title)}</span>
            <div class="main-box-controls">
                <span class="main-box-size-indicator">1√ó1</span>
                <button class="main-box-btn" data-action="resize-smaller" title="Width ‚àí">‚óÄ</button>
                <button class="main-box-btn" data-action="resize-larger" title="Width +">‚ñ∂</button>
                <button class="main-box-btn height-btn" data-action="height-smaller" title="Height ‚àí">‚ñ≤</button>
                <button class="main-box-btn height-btn" data-action="height-larger" title="Height +">‚ñº</button>
                <button class="main-box-btn" data-action="toggle-visibility" title="Hide">üëÅ</button>
                <button class="main-box-btn" data-action="delete-box" title="Delete" style="color:#ef4444;">üóë</button>
            </div>
        </div>
        <div class="main-box-content" id="content-${config.id}">
            <div style="text-align:center; padding:20px; color:#64748b;">Loading...</div>
        </div>
    `;

            grid.appendChild(box);
            updateMainBoxGridStyle(box);
            renderMainCustomBoxContent(config);
            initMainDragDrop(); // Rebind controls
        }

        function renderMainCustomBoxContent(config) {
            const container = document.getElementById('content-' + config.id);
            if (!container) return;

            const projects = typeof getProjects === 'function' ? getProjects() : [];
            const colorMap = { blue: '#3b82f6', green: '#22c55e', purple: '#8b5cf6', orange: '#f59e0b', red: '#ef4444', cyan: '#06b6d4', pink: '#ec4899' };
            const mainColor = colorMap[config.color] || '#3b82f6';

            // Helper to calculate metrics
            const calcMetric = (metric) => {
                const now = new Date();
                const allItems = projects.flatMap(p => p.items || []);
                const allBundles = projects.flatMap(p => [...(p.rfqBatches || []), ...(p.rfq_batches || [])]);
                const allSuppliers = new Set();
                projects.forEach(p => (p.items || []).forEach(i => (i.suppliers || []).forEach(s => allSuppliers.add((s.name || '').toLowerCase()))));

                switch (metric) {
                    case 'total-projects': return { value: projects.length, label: 'Projects' };
                    case 'total-items': return { value: allItems.length, label: 'Items' };
                    case 'total-suppliers': return { value: allSuppliers.size, label: 'Suppliers' };
                    case 'total-bundles': return { value: allBundles.length, label: 'RFQ Bundles' };
                    case 'open-bundles': return { value: allBundles.filter(b => !['done', 'completed', 'closed'].includes((b.status || '').toLowerCase())).length, label: 'Open Bundles' };
                    case 'quoted-items': return { value: allItems.filter(i => parseFloat(i.price_1) > 0 || (i.suppliers || []).some(s => s.price || s.price_1)).length, label: 'Quoted Items' };
                    case 'unquoted-items': return { value: allItems.filter(i => !(parseFloat(i.price_1) > 0) && !(i.suppliers || []).some(s => s.price || s.price_1)).length, label: 'Unquoted Items' };
                    case 'total-value': {
                        const v = projects.reduce((sum, p) => {
                            return sum + (p.items || []).reduce((s, i) => s + (parseFloat(i.price_1_euro || i.price_1) || 0) * (parseFloat(i.qty_1) || 1), 0);
                        }, 0);
                        return { value: '‚Ç¨' + v.toLocaleString('en-US', { maximumFractionDigits: 0 }), label: 'Total Value' };
                    }
                    case 'avg-project-value': {
                        const vals = projects.map(p => (p.items || []).reduce((s, i) => s + (parseFloat(i.price_1_euro || i.price_1) || 0) * (parseFloat(i.qty_1) || 1), 0));
                        return { value: '‚Ç¨' + (vals.reduce((a, b) => a + b, 0) / (vals.length || 1)).toLocaleString('en-US', { maximumFractionDigits: 0 }), label: 'Avg Value' };
                    }
                    case 'total-savings': {
                        const sav = allItems.reduce((sum, i) => {
                            const target = parseFloat(i.target_price) || 0;
                            const actual = parseFloat(i.price_1_euro || i.price_1) || 0;
                            return sum + (target > actual ? (target - actual) * (parseFloat(i.qty_1) || 1) : 0);
                        }, 0);
                        return { value: '‚Ç¨' + sav.toLocaleString('en-US', { maximumFractionDigits: 0 }), label: 'Total Savings' };
                    }
                    case 'avg-quote-rate': {
                        const rates = projects.map(p => {
                            const items = p.items || [];
                            const quoted = items.filter(i => parseFloat(i.price_1) > 0 || (i.suppliers || []).some(s => s.price || s.price_1)).length;
                            return items.length ? (quoted / items.length * 100) : 0;
                        });
                        return { value: (rates.reduce((a, b) => a + b, 0) / (rates.length || 1)).toFixed(0) + '%', label: 'Quote Rate' };
                    }
                    case 'supplier-coverage': {
                        const withSup = allItems.filter(i => i.supplier || (i.suppliers || []).length > 0).length;
                        return { value: ((withSup / (allItems.length || 1)) * 100).toFixed(0) + '%', label: 'Supplier Coverage' };
                    }
                    case 'completion-rate': {
                        const done = allItems.filter(i => ['done', 'completed', 'won'].includes((i.status || '').toLowerCase())).length;
                        return { value: ((done / (allItems.length || 1)) * 100).toFixed(0) + '%', label: 'Completion' };
                    }
                    case 'overdue-projects': return {
                        value: projects.filter(p => {
                            const d = p.dates?.deadline || p.dates?.Deadline;
                            return d && new Date(d) < now;
                        }).length, label: 'Overdue'
                    };
                    case 'due-7-days': return {
                        value: projects.filter(p => {
                            const d = p.dates?.deadline || p.dates?.Deadline;
                            if (!d) return false;
                            const diff = (new Date(d) - now) / (1000 * 60 * 60 * 24);
                            return diff >= 0 && diff <= 7;
                        }).length, label: 'Due 7 Days'
                    };
                    case 'due-14-days': return {
                        value: projects.filter(p => {
                            const d = p.dates?.deadline || p.dates?.Deadline;
                            if (!d) return false;
                            const diff = (new Date(d) - now) / (1000 * 60 * 60 * 24);
                            return diff >= 0 && diff <= 14;
                        }).length, label: 'Due 14 Days'
                    };
                    default: return { value: '‚Äî', label: metric };
                }
            };

            switch (config.type) {
                case 'main-note':
                case 'main-notes':
                    container.innerHTML = `<div style="white-space:pre-wrap; font-size:13px; color:#334155; line-height:1.5;">${escapeHtml(config.content || '')}</div>`;
                    break;

                case 'main-countdown': {
                    const target = new Date(config.targetDate);
                    const now = new Date();
                    const days = Math.ceil((target - now) / (1000 * 60 * 60 * 24));
                    const color = days < 0 ? '#ef4444' : days <= 7 ? '#f59e0b' : '#22c55e';
                    container.innerHTML = `
                <div style="text-align:center; padding:16px;">
                    <div style="font-size:11px; color:#64748b; margin-bottom:8px; text-transform:uppercase;">${escapeHtml(config.eventLabel)}</div>
                    <div style="font-size:48px; font-weight:800; color:${color}; line-height:1;">${Math.abs(days)}</div>
                    <div style="font-size:13px; color:${color}; font-weight:600;">${days < 0 ? 'days overdue' : 'days remaining'}</div>
                    <div style="font-size:11px; color:#94a3b8; margin-top:10px;">${config.targetDate}</div>
                </div>
            `;
                    break;
                }

                case 'main-link-buttons':
                case 'main-action-buttons': {
                    const links = (config.links || '').split('\n').filter(l => l.trim());
                    container.innerHTML = `<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(100px, 1fr)); gap:8px;">
                ${links.map(l => {
                        const [label, view] = l.split('|');
                        return `<button class="btn-secondary" onclick="switchView('${escapeHtml(view?.trim() || '')}')" style="padding:12px 8px; font-size:12px; font-weight:600;">${escapeHtml(label?.trim() || '')}</button>`;
                    }).join('')}
            </div>`;
                    break;
                }

                case 'main-project-filter':
                case 'main-project-cards':
                case 'main-recent-projects': {
                    let filtered = projects.filter(p => !config.status || (p.project_status || p.status) === config.status);
                    if (config.type === 'main-recent-projects') {
                        filtered = filtered.sort((a, b) => new Date(b.updated_at || b.created_at || 0) - new Date(a.updated_at || a.created_at || 0));
                    }
                    filtered = filtered.slice(0, config.limit || 5);
                    if (filtered.length === 0) {
                        container.innerHTML = `<div style="text-align:center; color:#94a3b8; padding:30px;">No projects found</div>`;
                    } else {
                        container.innerHTML = `<div style="display:flex; flex-direction:column; gap:8px;">
                    ${filtered.map(p => {
                            const ps = p.project_status || 'Created';
                            const color = getStatusColorUnified ? getStatusColorUnified(ps, 'project') : '#64748b';
                            return `<div data-main-action="open-dashboard" data-proj="${p.id}" style="padding:10px 14px; background:linear-gradient(135deg,#f8fafc,#f1f5f9); border-radius:8px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; border:1px solid #e2e8f0; transition:all 0.2s;" onmouseover="this.style.borderColor='#3b82f6'" onmouseout="this.style.borderColor='#e2e8f0'">
                            <div style="min-width:0;">
                                <div style="font-size:13px; font-weight:600; color:#0f172a; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(p.name || 'Untitled')}</div>
                                <div style="font-size:10px; color:#64748b;">${(p.items || []).length} items</div>
                            </div>
                            <span style="background:${color}20; color:${color}; font-size:10px; padding:3px 8px; border-radius:4px; font-weight:600;">${escapeHtml(ps)}</span>
                        </div>`;
                        }).join('')}
                </div>`;
                    }
                    break;
                }

                case 'main-stat':
                case 'main-gauge':
                case 'main-progress': {
                    const m = calcMetric(config.metric);
                    if (config.type === 'main-gauge') {
                        const numVal = parseFloat(String(m.value).replace(/[^0-9.-]/g, '')) || 0;
                        const pct = Math.min(100, (numVal / (config.target || 100)) * 100);
                        container.innerHTML = `
                    <div style="text-align:center; padding:16px;">
                        <div style="position:relative; width:120px; height:120px; margin:0 auto;">
                            <svg viewBox="0 0 36 36" style="transform:rotate(-90deg);">
                                <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#e2e8f0" stroke-width="3"/>
                                <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="${mainColor}" stroke-width="3" stroke-dasharray="${pct}, 100"/>
                            </svg>
                            <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center;">
                                <div style="font-size:20px; font-weight:800; color:${mainColor};">${m.value}</div>
                            </div>
                        </div>
                        <div style="font-size:12px; color:#64748b; margin-top:8px;">${m.label}</div>
                    </div>
                `;
                    } else if (config.type === 'main-progress') {
                        const numVal = parseFloat(String(m.value).replace(/[^0-9.-]/g, '')) || 0;
                        const pct = Math.min(100, (numVal / (config.target || 100)) * 100);
                        container.innerHTML = `
                    <div style="padding:16px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                            <span style="font-size:12px; color:#64748b;">${m.label}</span>
                            <span style="font-size:14px; font-weight:700; color:${mainColor};">${m.value}</span>
                        </div>
                        <div style="height:12px; background:#e2e8f0; border-radius:6px; overflow:hidden;">
                            <div style="width:${pct}%; height:100%; background:${mainColor}; border-radius:6px; transition:width 0.5s;"></div>
                        </div>
                        <div style="font-size:10px; color:#94a3b8; margin-top:4px;">Target: ${config.target || 100}</div>
                    </div>
                `;
                    } else {
                        container.innerHTML = `
                    <div style="text-align:center; padding:20px;">
                        <div style="font-size:42px; font-weight:800; color:${mainColor}; line-height:1;">${m.value}</div>
                        <div style="font-size:12px; color:#64748b; margin-top:6px;">${m.label}</div>
                    </div>
                `;
                    }
                    break;
                }

                case 'main-multi-stat': {
                    const metrics = (config.metrics || ['total-projects', 'total-items']).map(m => calcMetric(m));
                    container.innerHTML = `<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(80px, 1fr)); gap:10px;">
                ${metrics.map((m, i) => {
                        const colors = ['#3b82f6', '#22c55e', '#8b5cf6', '#f59e0b', '#ef4444', '#06b6d4'];
                        return `<div style="text-align:center; padding:12px 8px; background:#f8fafc; border-radius:8px;">
                        <div style="font-size:24px; font-weight:800; color:${colors[i % colors.length]};">${m.value}</div>
                        <div style="font-size:10px; color:#64748b;">${m.label}</div>
                    </div>`;
                    }).join('')}
            </div>`;
                    break;
                }

                case 'main-comparison': {
                    const m1 = calcMetric(config.metric1);
                    const m2 = calcMetric(config.metric2);
                    container.innerHTML = `
                <div style="display:flex; gap:16px; padding:10px;">
                    <div style="flex:1; text-align:center; padding:16px; background:#eff6ff; border-radius:10px;">
                        <div style="font-size:28px; font-weight:800; color:#3b82f6;">${m1.value}</div>
                        <div style="font-size:11px; color:#64748b;">${m1.label}</div>
                    </div>
                    <div style="display:flex; align-items:center; font-size:20px; color:#94a3b8;">vs</div>
                    <div style="flex:1; text-align:center; padding:16px; background:#f0fdf4; border-radius:10px;">
                        <div style="font-size:28px; font-weight:800; color:#22c55e;">${m2.value}</div>
                        <div style="font-size:11px; color:#64748b;">${m2.label}</div>
                    </div>
                </div>
            `;
                    break;
                }

                case 'main-supplier-ranking':
                case 'main-supplier-cards': {
                    const supplierAgg = new Map();
                    projects.forEach(p => {
                        (p.items || []).forEach(i => {
                            const sup = (i.supplier || '').trim();
                            if (sup) {
                                const rec = supplierAgg.get(sup) || { items: 0, value: 0, bundles: 0 };
                                rec.items++;
                                rec.value += (parseFloat(i.price_1_euro || i.price_1) || 0) * (parseFloat(i.qty_1) || 1);
                                supplierAgg.set(sup, rec);
                            }
                            (i.suppliers || []).forEach(s => {
                                const sn = (s.name || s.supplier || '').trim();
                                if (sn) {
                                    const rec = supplierAgg.get(sn) || { items: 0, value: 0, bundles: 0 };
                                    rec.items++;
                                    supplierAgg.set(sn, rec);
                                }
                            });
                        });
                    });
                    let suppliers = Array.from(supplierAgg.entries()).map(([name, rec]) => ({ name, ...rec }));
                    suppliers.sort((a, b) => config.sortBy === 'name' ? a.name.localeCompare(b.name) : config.sortBy === 'items' ? b.items - a.items : b.value - a.value);
                    suppliers = suppliers.slice(0, config.limit || 10);

                    if (config.type === 'main-supplier-cards') {
                        container.innerHTML = `<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:8px;">
                    ${suppliers.map(s => `
                        <div style="padding:12px; background:#f8fafc; border-radius:8px; text-align:center;">
                            <div style="width:40px; height:40px; border-radius:50%; background:linear-gradient(135deg,#3b82f6,#8b5cf6); color:white; display:flex; align-items:center; justify-content:center; margin:0 auto 8px; font-weight:700;">${s.name.charAt(0).toUpperCase()}</div>
                            <div style="font-size:12px; font-weight:600; color:#0f172a; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(s.name)}</div>
                            <div style="font-size:10px; color:#64748b;">${s.items} items</div>
                        </div>
                    `).join('')}
                </div>`;
                    } else {
                        container.innerHTML = `<div style="display:flex; flex-direction:column; gap:6px;">
                    ${suppliers.map((s, i) => `
                        <div style="display:flex; align-items:center; gap:10px; padding:8px 10px; background:${i < 3 ? '#fef3c7' : '#f8fafc'}; border-radius:6px;">
                            <span style="font-size:14px; font-weight:700; color:${i < 3 ? '#f59e0b' : '#64748b'}; width:20px;">#${i + 1}</span>
                            <span style="flex:1; font-size:12px; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(s.name)}</span>
                            <span style="font-size:11px; color:#64748b;">${s.items}</span>
                            <span style="font-size:11px; font-weight:600; color:#22c55e;">‚Ç¨${s.value.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span>
                        </div>
                    `).join('')}
                </div>`;
                    }
                    break;
                }

                case 'main-deadline-list':
                case 'main-overdue': {
                    const now = new Date();
                    let deadlines = projects.map(p => {
                        const d = p.dates?.deadline || p.dates?.Deadline;
                        if (!d) return null;
                        const days = Math.ceil((new Date(d) - now) / (1000 * 60 * 60 * 24));
                        return { name: p.name || 'Untitled', id: p.id, days, date: d };
                    }).filter(d => d && (config.type === 'main-overdue' ? d.days < 0 : true));
                    deadlines.sort((a, b) => a.days - b.days);
                    deadlines = deadlines.slice(0, config.limit || 10);

                    container.innerHTML = `<div style="display:flex; flex-direction:column; gap:6px;">
                ${deadlines.length === 0 ? '<div style="text-align:center; color:#94a3b8; padding:20px;">No deadlines</div>' :
                            deadlines.map(d => {
                                const color = d.days < 0 ? '#ef4444' : d.days <= 7 ? '#f59e0b' : '#22c55e';
                                return `<div data-main-action="open-dashboard" data-proj="${d.id}" style="display:flex; align-items:center; gap:10px; padding:8px 12px; background:#f8fafc; border-radius:6px; cursor:pointer; border-left:3px solid ${color};">
                        <span style="font-size:18px; font-weight:700; color:${color}; min-width:40px;">${Math.abs(d.days)}d</span>
                        <div style="flex:1; min-width:0;">
                            <div style="font-size:12px; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(d.name)}</div>
                            <div style="font-size:10px; color:#64748b;">${d.date}</div>
                        </div>
                    </div>`;
                            }).join('')}
            </div>`;
                    break;
                }

                case 'main-items-done':
                case 'main-items-issues':
                case 'main-items-in-progress':
                case 'main-unquoted-items':
                case 'main-items-summary': {
                    const allItems = [];
                    projects.forEach(p => {
                        (p.items || []).forEach(i => {
                            allItems.push({ ...i, projectName: p.name || 'Untitled', projectId: p.id });
                        });
                    });

                    let filtered = allItems;
                    let title = 'Items';
                    let emptyMsg = 'No items found';
                    let iconColor = '#64748b';

                    if (config.type === 'main-items-done') {
                        filtered = allItems.filter(i => ['done', 'completed', 'won', 'finished'].includes((i.status || '').toLowerCase()));
                        title = 'Done Items';
                        emptyMsg = 'No completed items';
                        iconColor = '#22c55e';
                    } else if (config.type === 'main-items-issues') {
                        filtered = allItems.filter(i => ['issue', 'problem', 'blocked', 'error', 'failed'].includes((i.status || '').toLowerCase()));
                        title = 'Items with Issues';
                        emptyMsg = 'No issues found';
                        iconColor = '#ef4444';
                    } else if (config.type === 'main-items-in-progress') {
                        filtered = allItems.filter(i => ['in progress', 'progress', 'working', 'pending', 'processing'].includes((i.status || '').toLowerCase()));
                        title = 'In Progress';
                        emptyMsg = 'No items in progress';
                        iconColor = '#f59e0b';
                    } else if (config.type === 'main-unquoted-items') {
                        filtered = allItems.filter(i => !(parseFloat(i.price_1) > 0) && !(i.suppliers || []).some(s => s.price || s.price_1));
                        title = 'Unquoted Items';
                        emptyMsg = 'All items have quotes';
                        iconColor = '#8b5cf6';
                    }

                    filtered = filtered.slice(0, config.limit || 10);

                    if (config.type === 'main-items-summary') {
                        // Show summary breakdown
                        const statusCounts = {};
                        allItems.forEach(i => {
                            const st = (i.status || 'No Status').toLowerCase();
                            statusCounts[st] = (statusCounts[st] || 0) + 1;
                        });
                        const entries = Object.entries(statusCounts).sort((a, b) => b[1] - a[1]).slice(0, config.limit || 10);
                        container.innerHTML = `<div style="display:flex; flex-direction:column; gap:6px;">
                    <div style="display:flex; justify-content:space-between; padding:8px 12px; background:linear-gradient(135deg,#eff6ff,#dbeafe); border-radius:8px; margin-bottom:4px;">
                        <span style="font-weight:600; color:#1e40af;">Total Items</span>
                        <span style="font-size:18px; font-weight:800; color:#3b82f6;">${allItems.length}</span>
                    </div>
                    ${entries.map(([st, cnt]) => {
                            const pct = Math.round((cnt / allItems.length) * 100);
                            const color = st.includes('done') || st.includes('complete') ? '#22c55e' : st.includes('issue') || st.includes('error') ? '#ef4444' : st.includes('progress') ? '#f59e0b' : '#64748b';
                            return `<div style="display:flex; align-items:center; gap:8px; padding:6px 10px; background:#f8fafc; border-radius:6px;">
                            <div style="flex:1; height:6px; background:#e2e8f0; border-radius:3px; overflow:hidden;">
                                <div style="width:${pct}%; height:100%; background:${color};"></div>
                            </div>
                            <span style="font-size:11px; min-width:70px; text-transform:capitalize;">${escapeHtml(st)}</span>
                            <span style="font-size:12px; font-weight:600; min-width:30px; text-align:right;">${cnt}</span>
                        </div>`;
                        }).join('')}
                </div>`;
                    } else {
                        container.innerHTML = `<div style="display:flex; flex-direction:column; gap:6px;">
                    ${filtered.length === 0 ? `<div style="text-align:center; color:#94a3b8; padding:30px;">${emptyMsg}</div>` :
                                filtered.map(i => `
                        <div style="padding:8px 12px; background:#f8fafc; border-radius:6px; border-left:3px solid ${iconColor};">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                <div style="flex:1; min-width:0;">
                                    <div style="font-size:12px; font-weight:600; color:#0f172a; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${escapeHtml(i.description || i.item_drawing_no || '')}">${escapeHtml(i.item_drawing_no || i.description || 'No ID')}</div>
                                    <div style="font-size:10px; color:#64748b; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(i.projectName)}</div>
                                </div>
                                <span style="font-size:10px; padding:2px 6px; background:${iconColor}20; color:${iconColor}; border-radius:4px; font-weight:500;">${escapeHtml(i.status || '‚Äî')}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>`;
                    }
                    break;
                }

                case 'main-todo-list': {
                    const todos = config.todos || [];
                    container.innerHTML = `<div id="todo-list-${config.id}" style="display:flex; flex-direction:column; gap:6px;">
                ${todos.map(t => `
                    <label style="display:flex; align-items:center; gap:10px; padding:8px 10px; background:#f8fafc; border-radius:6px; cursor:pointer;">
                        <input type="checkbox" ${t.done ? 'checked' : ''} onchange="toggleMainTodo('${config.id}', ${t.id})" style="width:18px; height:18px;">
                        <span style="flex:1; font-size:12px; ${t.done ? 'text-decoration:line-through; color:#94a3b8;' : 'color:#334155;'}">${escapeHtml(t.text)}</span>
                    </label>
                `).join('')}
                <input type="text" id="todo-input-${config.id}" class="rfq-input" placeholder="+ Add task..." style="padding:8px 10px; font-size:12px;" onkeypress="if(event.key==='Enter')addMainTodo('${config.id}', this.value)">
            </div>`;
                    break;
                }

                case 'main-currency-rates': {
                    const rates = window.RFQData?.getExchangeRates?.() || window.CURRENCY_RATES || { USD: 0.92, GBP: 1.17, CZK: 0.041, PLN: 0.23, CHF: 1.05 };
                    const currencies = config.currencies || ['USD', 'GBP', 'CZK'];
                    container.innerHTML = `<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(80px, 1fr)); gap:8px;">
                ${currencies.map(c => `
                    <div style="text-align:center; padding:12px 8px; background:#f8fafc; border-radius:8px;">
                        <div style="font-size:11px; color:#64748b;">1 EUR =</div>
                        <div style="font-size:18px; font-weight:700; color:#3b82f6;">${(1 / (rates[c] || 1)).toFixed(2)}</div>
                        <div style="font-size:12px; font-weight:600; color:#0f172a;">${c}</div>
                    </div>
                `).join('')}
            </div>`;
                    break;
                }

                case 'main-clock': {
                    const zones = (config.timezones || 'Prague|Europe/Prague').split('\n').filter(z => z.trim());
                    container.innerHTML = `<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(100px, 1fr)); gap:10px;">
                ${zones.map(z => {
                        const [label, tz] = z.split('|');
                        let time = '--:--';
                        try { time = new Date().toLocaleTimeString('en-GB', { timeZone: tz?.trim(), hour: '2-digit', minute: '2-digit' }); } catch (e) { }
                        return `<div style="text-align:center; padding:12px; background:#f8fafc; border-radius:8px;">
                        <div style="font-size:24px; font-weight:700; color:#0f172a; font-family:monospace;">${time}</div>
                        <div style="font-size:11px; color:#64748b;">${escapeHtml(label?.trim() || tz)}</div>
                    </div>`;
                    }).join('')}
            </div>`;
                    break;
                }

                case 'main-image':
                    container.innerHTML = config.url ? `<img src="${escapeHtml(config.url)}" style="max-width:100%; max-height:100%; object-fit:contain; border-radius:8px;">` : '<div style="text-align:center; color:#94a3b8; padding:20px;">No image URL</div>';
                    break;

                case 'main-iframe':
                    container.innerHTML = config.url ? `<iframe src="${escapeHtml(config.url)}" style="width:100%; height:200px; border:none; border-radius:8px;"></iframe>` : '<div style="text-align:center; color:#94a3b8; padding:20px;">No URL</div>';
                    break;

                default:
                    container.innerHTML = `<div style="text-align:center; padding:30px; color:#94a3b8;">
                <div style="font-size:32px; margin-bottom:8px;">${MAIN_BOX_TYPES[config.type]?.icon || 'üì¶'}</div>
                <div style="font-size:12px;">${MAIN_BOX_TYPES[config.type]?.name || config.type}</div>
            </div>`;
            }
        }

        // Helper functions for todo list
        window.toggleMainTodo = function (boxId, todoId) {
            const box = document.querySelector(`.main-box[data-box-id="${boxId}"]`);
            if (!box) return;
            try {
                const config = JSON.parse(box.dataset.boxConfig || '{}');
                const todo = (config.todos || []).find(t => t.id === todoId);
                if (todo) todo.done = !todo.done;
                box.dataset.boxConfig = JSON.stringify(config);
                renderMainCustomBoxContent(config);
                saveMainCustomBoxes();
            } catch (e) { }
        };

        window.addMainTodo = function (boxId, text) {
            if (!text?.trim()) return;
            const box = document.querySelector(`.main-box[data-box-id="${boxId}"]`);
            if (!box) return;
            try {
                const config = JSON.parse(box.dataset.boxConfig || '{}');
                config.todos = config.todos || [];
                config.todos.push({ id: Date.now(), text: text.trim(), done: false });
                box.dataset.boxConfig = JSON.stringify(config);
                renderMainCustomBoxContent(config);
                saveMainCustomBoxes();
            } catch (e) { }
        };

        function saveMainCustomBoxes() {
            const grid = document.getElementById('main-dashboard-grid');
            if (!grid) return;

            const customBoxes = [];
            grid.querySelectorAll('.main-box[data-custom-box="true"]').forEach(box => {
                try {
                    const config = JSON.parse(box.dataset.boxConfig || '{}');
                    config.colSpan = parseInt(box.dataset.colSpan) || 1;
                    config.rowSpan = parseInt(box.dataset.rowSpan) || 1;
                    config.hidden = box.classList.contains('hidden-box');
                    customBoxes.push(config);
                } catch (e) { }
            });

            localStorage.setItem('rfq_main_custom_boxes', JSON.stringify(customBoxes));
        }

        function loadMainCustomBoxes() {
            const saved = localStorage.getItem('rfq_main_custom_boxes');
            if (!saved) return;

            try {
                const customBoxes = JSON.parse(saved);
                customBoxes.forEach(config => {
                    createMainCustomBox(config);
                    // Apply saved size and visibility
                    const box = document.querySelector(`.main-box[data-box-id="${config.id}"]`);
                    if (box) {
                        if (config.colSpan) box.dataset.colSpan = config.colSpan;
                        if (config.rowSpan) box.dataset.rowSpan = config.rowSpan;
                        updateMainBoxGridStyle(box);
                        if (config.hidden) {
                            box.classList.add('hidden-box');
                        }
                    }
                });
            } catch (e) {
                console.warn('Failed to load main custom boxes:', e);
            }
        }

        // Load main layout on init
        setTimeout(() => loadMainLayout(), 100);

        // =========================================================
        // Resizable Columns for Main Projects Table
        // =========================================================
        const MAIN_TABLE_COL_WIDTHS_KEY = 'rfq_main_table_col_widths';

        function getMainTableColumnWidths() {
            try {
                const saved = localStorage.getItem(MAIN_TABLE_COL_WIDTHS_KEY);
                return saved ? JSON.parse(saved) : {};
            } catch (e) { return {}; }
        }

        function saveMainTableColumnWidths(widths) {
            try {
                localStorage.setItem(MAIN_TABLE_COL_WIDTHS_KEY, JSON.stringify(widths));
            } catch (e) { }
        }

        function initMainTableResizableColumns(tableId = 'main-projects-table') {
            const table = document.getElementById(tableId);
            if (!table) return;

            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            if (!thead || !tbody) return;

            const headerRow = thead.querySelector('tr');
            if (!headerRow) return;

            const storageKeyPrefix = 'rfq_main_table';
            const widthsKey = `${storageKeyPrefix}_widths`;

            // Ensure col IDs
            Array.from(headerRow.querySelectorAll('th')).forEach((th, idx) => {
                if (!th.dataset.colId) th.dataset.colId = `col_${idx}`;
            });

            // Load saved widths
            let savedWidths = {};
            try {
                const saved = localStorage.getItem(widthsKey);
                if (saved) savedWidths = JSON.parse(saved) || {};
            } catch (e) { }

            // Apply saved widths
            Array.from(headerRow.querySelectorAll('th')).forEach((th) => {
                const colId = th.dataset.colId;
                const w = savedWidths[colId];
                if (w) th.style.width = w + 'px';
            });

            const saveWidths = () => {
                const widths = {};
                Array.from(headerRow.querySelectorAll('th')).forEach((th) => {
                    widths[th.dataset.colId] = th.offsetWidth;
                });
                try {
                    localStorage.setItem(widthsKey, JSON.stringify(widths));
                } catch (e) { }
            };

            // Add resize handles (idempotent)
            Array.from(headerRow.querySelectorAll('th')).forEach((th) => {
                if (th.classList.contains('col-checkbox') || th.classList.contains('col-actions')) return;
                if (th.querySelector('.col-resize-handle')) return;

                const handle = document.createElement('div');
                handle.className = 'col-resize-handle';
                th.style.position = th.style.position || 'relative';
                th.appendChild(handle);

                let resizingTh = null;
                let startX = 0;
                let startWidth = 0;

                const onMove = (e) => {
                    if (!resizingTh) return;
                    const diff = e.clientX - startX;
                    const newWidth = Math.max(60, startWidth + diff);
                    resizingTh.style.width = newWidth + 'px';
                };

                const onUp = () => {
                    if (!resizingTh) return;
                    table.classList.remove('resizing');
                    handle.classList.remove('resizing');
                    resizingTh = null;
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onUp);
                    saveWidths();
                };

                handle.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    resizingTh = th;
                    startX = e.clientX;
                    startWidth = th.offsetWidth;
                    table.classList.add('resizing');
                    handle.classList.add('resizing');
                    document.addEventListener('mousemove', onMove);
                    document.addEventListener('mouseup', onUp);
                });
            });

            // Enable column dragging (main table uses dedicated storage key)
            initMainTableColumnDragging(tableId, storageKeyPrefix);
        }

        function initMainTableColumnDragging(tableId = 'main-projects-table', storageKeyPrefix = 'rfq_main_table') {
            const table = document.getElementById(tableId);
            if (!table) return;

            // Guard
            if (table.dataset.mainColDragInit === '1') return;
            table.dataset.mainColDragInit = '1';

            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            if (!thead || !tbody) return;

            const headerRow = thead.querySelector('tr');
            if (!headerRow) return;

            const orderKey = `${storageKeyPrefix}_col_order`;

            // Ensure col IDs
            Array.from(headerRow.querySelectorAll('th')).forEach((th, idx) => {
                if (!th.dataset.colId) th.dataset.colId = `col_${idx}`;
            });

            const reorderRowCells = (rowEl, fromIdx, toIdx) => {
                const cells = Array.from(rowEl.children);
                if (fromIdx < 0 || toIdx < 0 || fromIdx >= cells.length || toIdx >= cells.length) return;
                const moved = cells[fromIdx];
                if (!moved) return;
                if (toIdx >= cells.length - 1) rowEl.appendChild(moved);
                else rowEl.insertBefore(moved, cells[toIdx]);
            };

            const applyOrder = (order) => {
                if (!Array.isArray(order) || order.length === 0) return;
                const currentIds = Array.from(headerRow.querySelectorAll('th')).map(th => th.dataset.colId);
                const resolvedOrder = order.filter(id => currentIds.includes(id));
                const remaining = currentIds.filter(id => !resolvedOrder.includes(id));
                const finalOrder = [...resolvedOrder, ...remaining];

                const idToIdx = {};
                currentIds.forEach((id, idx) => idToIdx[id] = idx);

                finalOrder.forEach((colId, targetIdx) => {
                    const curIdx = idToIdx[colId];
                    if (curIdx === undefined || curIdx === targetIdx) return;
                    reorderRowCells(headerRow, curIdx, targetIdx);
                    Array.from(tbody.querySelectorAll('tr')).forEach(tr => reorderRowCells(tr, curIdx, targetIdx));
                    Array.from(headerRow.querySelectorAll('th')).forEach((th, idx) => idToIdx[th.dataset.colId] = idx);
                });
            };

            // Restore order
            try {
                const saved = localStorage.getItem(orderKey);
                if (saved) applyOrder(JSON.parse(saved));
            } catch (e) { }

            const saveOrder = () => {
                const order = Array.from(headerRow.querySelectorAll('th')).map(th => th.dataset.colId);
                try { localStorage.setItem(orderKey, JSON.stringify(order)); } catch (e) { }
            };

            let draggedTh = null;

            const clear = () => {
                thead.querySelectorAll('th').forEach(th => th.classList.remove('dragging', 'drag-over'));
            };

            Array.from(headerRow.querySelectorAll('th')).forEach((th) => {
                if (th.classList.contains('col-checkbox') || th.classList.contains('col-actions')) return;

                if (th.querySelector('.col-drag-handle')) {
                    // Keep existing handle
                } else {
                    const dragHandle = document.createElement('span');
                    dragHandle.className = 'col-drag-handle';
                    dragHandle.innerHTML = '‚ãÆ‚ãÆ';
                    th.insertBefore(dragHandle, th.firstChild);
                }

                th.draggable = true;
                th.style.cursor = 'grab';

                th.addEventListener('dragstart', (e) => {
                    draggedTh = th;
                    th.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    try { e.dataTransfer.setData('text/plain', th.dataset.colId); } catch (err) { }
                });

                th.addEventListener('dragend', () => {
                    draggedTh = null;
                    clear();
                });

                th.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (!draggedTh || draggedTh === th) return;
                    th.classList.add('drag-over');
                });

                th.addEventListener('dragleave', () => {
                    th.classList.remove('drag-over');
                });

                th.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (!draggedTh || draggedTh === th) return;

                    const ths = Array.from(headerRow.querySelectorAll('th'));
                    const fromIdx = ths.indexOf(draggedTh);
                    const toIdx = ths.indexOf(th);
                    if (fromIdx === -1 || toIdx === -1) return;

                    reorderRowCells(headerRow, fromIdx, toIdx);
                    Array.from(tbody.querySelectorAll('tr')).forEach(tr => reorderRowCells(tr, fromIdx, toIdx));

                    clear();
                    saveOrder();
                });
            });
        }



        // =========================================================
        // Generic Resizable & Draggable Columns for Any Table
        // =========================================================

        function getTableSettings(storageKey) {
            try {
                const saved = localStorage.getItem(storageKey + 'settings');
                return saved ? JSON.parse(saved) : { widths: {}, order: [] };
            } catch (e) { return { widths: {}, order: [] }; }
        }

        function saveTableSettings(storageKey, settings) {
            try {
                localStorage.setItem(storageKey + 'settings', JSON.stringify(settings));
            } catch (e) { }
        }

        function initResizableDraggableTable(tableId, storageKeyPrefix = '') {
            const table = document.getElementById(tableId);
            if (!table) return;

            // Guard: avoid double binding
            if (table.dataset.rdtInit === '1') return;
            table.dataset.rdtInit = '1';

            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            if (!thead || !tbody) return;

            const headerRows = Array.from(thead.querySelectorAll('tr'));
            if (headerRows.length === 0) return;
            const headerRow = headerRows[0];

            // Ensure column IDs exist on the first header row
            const headerCells = Array.from(headerRow.querySelectorAll('th'));
            headerCells.forEach((th, idx) => {
                if (!th.dataset.colId) {
                    const txt = (th.textContent || '').trim().toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
                    th.dataset.colId = txt ? `col_${txt}` : `col_${idx}`;
                }
            });

            const storageKey = (storageKeyPrefix ? `${storageKeyPrefix}_${tableId}` : tableId) + '_rdt_settings';

            // Helpers
            const getCurrentColIds = () => Array.from(headerRow.querySelectorAll('th')).map(th => th.dataset.colId);

            const reorderRowCells = (rowEl, fromIdx, toIdx) => {
                const cells = Array.from(rowEl.children);
                if (fromIdx < 0 || toIdx < 0 || fromIdx >= cells.length || toIdx >= cells.length) return;
                const moved = cells[fromIdx];
                if (!moved) return;
                if (toIdx >= cells.length - 1) rowEl.appendChild(moved);
                else rowEl.insertBefore(moved, cells[toIdx]);
            };

            const applyOrder = (order) => {
                if (!Array.isArray(order) || order.length === 0) return;
                const currentIds = getCurrentColIds();
                const resolvedOrder = order.filter(id => currentIds.includes(id));
                const remaining = currentIds.filter(id => !resolvedOrder.includes(id));
                const finalOrder = [...resolvedOrder, ...remaining];

                // Build index map based on current positions
                const idToIdx = {};
                getCurrentColIds().forEach((id, idx) => { idToIdx[id] = idx; });

                // For each desired column in finalOrder, move it to the right place across ALL header rows and body rows
                finalOrder.forEach((colId, targetIdx) => {
                    const curIdx = idToIdx[colId];
                    if (curIdx === undefined || curIdx === targetIdx) return;

                    headerRows.forEach(hr => reorderRowCells(hr, curIdx, targetIdx));
                    Array.from(tbody.querySelectorAll('tr')).forEach(tr => reorderRowCells(tr, curIdx, targetIdx));

                    // Recompute map after each move
                    getCurrentColIds().forEach((id, idx) => { idToIdx[id] = idx; });
                });
            };

            // Load settings
            let settings = { widths: {}, order: [] };
            try {
                const saved = localStorage.getItem(storageKey);
                if (saved) settings = { ...settings, ...JSON.parse(saved) };
            } catch (e) { }

            // Apply saved order
            if (settings.order && settings.order.length) {
                applyOrder(settings.order);
            }

            // Apply saved widths (apply only to first header row)
            if (settings.widths) {
                const thsNow = Array.from(headerRow.querySelectorAll('th'));
                thsNow.forEach(th => {
                    const colId = th.dataset.colId;
                    const w = settings.widths[colId];
                    if (w) th.style.width = w + 'px';
                });
            }

            const saveSettings = () => {
                const currentOrder = getCurrentColIds();
                const widths = {};
                Array.from(headerRow.querySelectorAll('th')).forEach(th => {
                    widths[th.dataset.colId] = th.offsetWidth;
                });
                try {
                    localStorage.setItem(storageKey, JSON.stringify({ order: currentOrder, widths }));
                } catch (e) { }
            };

            // Add resize handles to header cells (first header row only)
            Array.from(headerRow.querySelectorAll('th')).forEach((th) => {
                // Skip if explicitly disabled
                if (th.classList.contains('no-resize')) return;
                if (th.querySelector('.col-resize-handle')) return;

                const handle = document.createElement('div');
                handle.className = 'col-resize-handle';
                th.style.position = th.style.position || 'relative';
                th.appendChild(handle);

                let startX = 0;
                let startWidth = 0;
                let resizingTh = null;

                const onMouseMove = (e) => {
                    if (!resizingTh) return;
                    const diff = e.clientX - startX;
                    const newWidth = Math.max(50, startWidth + diff);
                    resizingTh.style.width = newWidth + 'px';
                };

                const onMouseUp = () => {
                    if (!resizingTh) return;
                    table.classList.remove('resizing');
                    handle.classList.remove('resizing');
                    resizingTh = null;
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                    saveSettings();
                };

                handle.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    resizingTh = th;
                    startX = e.clientX;
                    startWidth = th.offsetWidth;
                    table.classList.add('resizing');
                    handle.classList.add('resizing');
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
            });

            // Enable column dragging (will also save order)
            initTableColumnDragging(tableId, storageKeyPrefix);

            // Ensure drag cursor
            Array.from(headerRow.querySelectorAll('th')).forEach(th => {
                if (th.classList.contains('no-drag')) return;
                th.style.cursor = 'grab';
            });
        }

        function initTableColumnDragging(tableId, storageKeyPrefix = '') {
            const table = document.getElementById(tableId);
            if (!table) return;

            // Guard: avoid double binding
            if (table.dataset.colDragInit === '1') return;
            table.dataset.colDragInit = '1';

            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            if (!thead || !tbody) return;

            const headerRows = Array.from(thead.querySelectorAll('tr'));
            if (headerRows.length === 0) return;
            const headerRow = headerRows[0];

            // Ensure col IDs
            Array.from(headerRow.querySelectorAll('th')).forEach((th, idx) => {
                if (!th.dataset.colId) {
                    const txt = (th.textContent || '').trim().toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
                    th.dataset.colId = txt ? `col_${txt}` : `col_${idx}`;
                }
            });

            const storageKey = (storageKeyPrefix ? `${storageKeyPrefix}_${tableId}` : tableId) + '_rdt_settings';

            const saveOrderOnly = () => {
                const order = Array.from(headerRow.querySelectorAll('th')).map(th => th.dataset.colId);
                try {
                    const saved = localStorage.getItem(storageKey);
                    const settings = saved ? JSON.parse(saved) : {};
                    settings.order = order;
                    localStorage.setItem(storageKey, JSON.stringify(settings));
                } catch (e) { }
            };

            const reorderRowCells = (rowEl, fromIdx, toIdx) => {
                const cells = Array.from(rowEl.children);
                if (fromIdx < 0 || toIdx < 0 || fromIdx >= cells.length || toIdx >= cells.length) return;
                const moved = cells[fromIdx];
                if (!moved) return;
                if (toIdx >= cells.length - 1) rowEl.appendChild(moved);
                else rowEl.insertBefore(moved, cells[toIdx]);
            };

            let draggedTh = null;

            const clearDragClasses = () => {
                thead.querySelectorAll('th').forEach(th => th.classList.remove('dragging', 'drag-over'));
            };

            Array.from(headerRow.querySelectorAll('th')).forEach((th) => {
                if (th.classList.contains('no-drag')) return;

                th.draggable = true;

                th.addEventListener('dragstart', (e) => {
                    draggedTh = th;
                    th.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    try { e.dataTransfer.setData('text/plain', th.dataset.colId); } catch (err) { }
                });

                th.addEventListener('dragend', () => {
                    draggedTh = null;
                    clearDragClasses();
                });

                th.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (!draggedTh || draggedTh === th) return;
                    if (th.classList.contains('no-drag')) return;
                    th.classList.add('drag-over');
                    e.dataTransfer.dropEffect = 'move';
                });

                th.addEventListener('dragleave', () => {
                    th.classList.remove('drag-over');
                });

                th.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (!draggedTh || draggedTh === th) return;

                    const ths = Array.from(headerRow.querySelectorAll('th'));
                    const fromIdx = ths.indexOf(draggedTh);
                    const toIdx = ths.indexOf(th);
                    if (fromIdx === -1 || toIdx === -1) return;

                    headerRows.forEach(hr => reorderRowCells(hr, fromIdx, toIdx));
                    Array.from(tbody.querySelectorAll('tr')).forEach(tr => reorderRowCells(tr, fromIdx, toIdx));

                    clearDragClasses();
                    saveOrderOnly();
                });
            });
        }

        function createPagination(tableId, options = {}) {
            const table = document.getElementById(tableId);
            if (!table) return null;

            const tbody = table.querySelector('tbody');
            if (!tbody) return null;

            const pageSizeDefault = options.pageSize || PAGINATION_PAGE_SIZE;
            const storageKey = options.storageKey || `pagination_${tableId}`;

            let currentPage = 1;
            try {
                const saved = localStorage.getItem(storageKey);
                if (saved) currentPage = parseInt(saved, 10) || 1;
            } catch (e) { }

            const paginationState = {
                currentPage,
                pageSize: pageSizeDefault,
                totalRows: 0,
                totalPages: 0,
                filteredRows: []
            };

            // Remove existing pagination wrapper if any
            const existingWrapper = document.getElementById(`${tableId}-pagination`);
            if (existingWrapper) existingWrapper.remove();

            // Create pagination wrapper
            const paginationWrapper = document.createElement('div');
            paginationWrapper.id = `${tableId}-pagination`;
            paginationWrapper.className = 'pagination-controls';
            paginationWrapper.innerHTML = `
            <div class="pagination-info">
                Showing <span class="page-start">0</span>-<span class="page-end">0</span> of <span class="page-total">0</span> rows
            </div>
            <div class="pagination-controls-right">
                <select class="page-size-select">
                    <option value="50">50 / page</option>
                    <option value="100">100 / page</option>
                    <option value="200">200 / page</option>
                    <option value="500">500 / page</option>
                </select>
                <div class="page-nav">
                    <button class="prev-page">‚Üê Prev</button>
                    <div class="page-numbers"></div>
                    <button class="next-page">Next ‚Üí</button>
                </div>
                <div class="page-jump">
                    <span>Go to:</span>
                    <input type="number" min="1" value="1">
                </div>
            </div>
        `;

            // Insert after table wrapper if it exists, else after table
            const parent = table.parentElement;
            if (parent) parent.appendChild(paginationWrapper);
            else table.insertAdjacentElement('afterend', paginationWrapper);

            // Set initial page size select
            const pageSizeSelect = paginationWrapper.querySelector('.page-size-select');
            if (pageSizeSelect) {
                pageSizeSelect.value = String(paginationState.pageSize);
                pageSizeSelect.addEventListener('change', () => {
                    paginationState.pageSize = parseInt(pageSizeSelect.value, 10) || pageSizeDefault;
                    paginationState.currentPage = 1;
                    savePage();
                    updatePagination();
                });
            }

            const savePage = () => {
                try {
                    localStorage.setItem(storageKey, String(paginationState.currentPage));
                } catch (e) { }
            };

            // Determine if a row is filtered out by any filter mechanism (built-in or legacy)
            const isFilteredOut = (row) => {
                if (!row) return true;
                if (row.dataset && (row.dataset.filtered === '1' || row.dataset.utFiltered === '1')) return true;
                return false;
            };

            // Detect if a row is hidden by something outside of pagination (legacy filters usually set style.display = 'none')
            const isExternallyHidden = (row) => {
                if (!row) return true;
                if (row.style && row.style.display === 'none' && row.dataset.paginationHidden !== '1' && !isFilteredOut(row)) return true;
                return false;
            };

            const getEligibleRows = () => {
                const allRows = Array.from(tbody.querySelectorAll('tr'));
                return allRows.filter(row => !isFilteredOut(row) && !isExternallyHidden(row));
            };

            const renderPageNumbers = () => {
                const pageNumbersEl = paginationWrapper.querySelector('.page-numbers');
                if (!pageNumbersEl) return;

                pageNumbersEl.innerHTML = '';
                const totalPages = paginationState.totalPages;

                // No need to show pagination if only one page
                if (totalPages <= 1) return;

                const maxPagesToShow = 7;
                const half = Math.floor(maxPagesToShow / 2);
                let startPage = Math.max(1, paginationState.currentPage - half);
                let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
                if (endPage - startPage < maxPagesToShow - 1) {
                    startPage = Math.max(1, endPage - maxPagesToShow + 1);
                }

                const addBtn = (p, label = null, isActive = false) => {
                    const btn = document.createElement('button');
                    btn.className = 'page-number' + (isActive ? ' active' : '');
                    btn.textContent = label || String(p);
                    btn.addEventListener('click', () => {
                        paginationState.currentPage = p;
                        savePage();
                        updatePagination();
                    });
                    pageNumbersEl.appendChild(btn);
                };

                if (startPage > 1) {
                    addBtn(1);
                    if (startPage > 2) {
                        const span = document.createElement('span');
                        span.textContent = '...';
                        span.style.color = '#999';
                        span.style.padding = '0 6px';
                        pageNumbersEl.appendChild(span);
                    }
                }

                for (let p = startPage; p <= endPage; p++) {
                    addBtn(p, null, p === paginationState.currentPage);
                }

                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) {
                        const span = document.createElement('span');
                        span.textContent = '...';
                        span.style.color = '#999';
                        span.style.padding = '0 6px';
                        pageNumbersEl.appendChild(span);
                    }
                    addBtn(totalPages);
                }
            };

            const updatePagination = () => {
                const allRows = Array.from(tbody.querySelectorAll('tr'));
                const eligibleRows = getEligibleRows();

                paginationState.filteredRows = eligibleRows;
                paginationState.totalRows = eligibleRows.length;
                paginationState.totalPages = Math.max(1, Math.ceil(paginationState.totalRows / paginationState.pageSize));

                if (paginationState.currentPage > paginationState.totalPages) {
                    paginationState.currentPage = paginationState.totalPages;
                    savePage();
                }
                if (paginationState.currentPage < 1) {
                    paginationState.currentPage = 1;
                    savePage();
                }

                // Hide all rows that are not eligible
                allRows.forEach(row => {
                    if (eligibleRows.indexOf(row) === -1) {
                        // Keep hidden; clear paginationHidden so external filters remain the owner
                        row.dataset.paginationHidden = '';
                        row.style.display = 'none';
                    }
                });

                // Apply pagination to eligible rows
                const startIdx = (paginationState.currentPage - 1) * paginationState.pageSize;
                const endIdx = Math.min(startIdx + paginationState.pageSize, eligibleRows.length);

                eligibleRows.forEach((row, idx) => {
                    if (idx >= startIdx && idx < endIdx) {
                        row.dataset.paginationHidden = '';
                        row.style.display = '';
                    } else {
                        row.dataset.paginationHidden = '1';
                        row.style.display = 'none';
                    }
                });

                // Update info
                const startEl = paginationWrapper.querySelector('.page-start');
                const endEl = paginationWrapper.querySelector('.page-end');
                const totalEl = paginationWrapper.querySelector('.page-total');
                if (startEl) startEl.textContent = eligibleRows.length ? String(startIdx + 1) : '0';
                if (endEl) endEl.textContent = eligibleRows.length ? String(endIdx) : '0';
                if (totalEl) totalEl.textContent = String(eligibleRows.length);

                // Update nav buttons
                const prevBtn = paginationWrapper.querySelector('.prev-page');
                const nextBtn = paginationWrapper.querySelector('.next-page');
                if (prevBtn) prevBtn.disabled = paginationState.currentPage <= 1;
                if (nextBtn) nextBtn.disabled = paginationState.currentPage >= paginationState.totalPages;

                // Jump input
                const jumpInput = paginationWrapper.querySelector('.page-jump input');
                if (jumpInput) {
                    jumpInput.max = String(paginationState.totalPages);
                    jumpInput.value = String(paginationState.currentPage);
                }

                renderPageNumbers();
            };

            // Prev/Next handlers
            const prevBtn = paginationWrapper.querySelector('.prev-page');
            const nextBtn = paginationWrapper.querySelector('.next-page');
            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    paginationState.currentPage = Math.max(1, paginationState.currentPage - 1);
                    savePage();
                    updatePagination();
                });
            }
            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    paginationState.currentPage = Math.min(paginationState.totalPages, paginationState.currentPage + 1);
                    savePage();
                    updatePagination();
                });
            }

            // Jump handler
            const jumpInput = paginationWrapper.querySelector('.page-jump input');
            if (jumpInput) {
                jumpInput.addEventListener('keydown', (e) => {
                    if (e.key !== 'Enter') return;
                    const v = parseInt(jumpInput.value, 10) || 1;
                    paginationState.currentPage = Math.max(1, Math.min(v, paginationState.totalPages));
                    savePage();
                    updatePagination();
                });
                jumpInput.addEventListener('change', () => {
                    const v = parseInt(jumpInput.value, 10) || 1;
                    paginationState.currentPage = Math.max(1, Math.min(v, paginationState.totalPages));
                    savePage();
                    updatePagination();
                });
            }

            // Initial render
            updatePagination();

            return {
                refresh: updatePagination,
                goToPage: (p) => {
                    paginationState.currentPage = Math.max(1, Math.min(parseInt(p, 10) || 1, paginationState.totalPages));
                    savePage();
                    updatePagination();
                },
                setPageSize: (s) => {
                    paginationState.pageSize = parseInt(s, 10) || pageSizeDefault;
                    if (pageSizeSelect) pageSizeSelect.value = String(paginationState.pageSize);
                    paginationState.currentPage = 1;
                    savePage();
                    updatePagination();
                }
            };
        }

        const paginationInstances = {};

        function initTablePagination(tableId, options = {}) {
            const instance = createPagination(tableId, options);
            if (instance) {
                paginationInstances[tableId] = instance;
            }
            return instance;
        }

        function refreshTablePagination(tableId) {
            if (paginationInstances[tableId]) {
                paginationInstances[tableId].refresh();
            }
        }

        // ---------------------------
        // Unified table styling + behavior (filters + resize + drag + persistence)
        // ---------------------------
        const unifiedTableRegistry = {};

        function ensureUnifiedTable(tableId, storageKeyPrefix = '', options = {}) {
            const table = document.getElementById(tableId);
            if (!table) return;

            table.classList.add('unified-table', 'resizable-table', 'draggable-table');

            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            if (!thead || !tbody) return;

            const headerRows = Array.from(thead.querySelectorAll('tr'));
            if (headerRows.length === 0) return;
            const headerRow = headerRows[0];

            // Ensure stable col IDs
            const headerCells = Array.from(headerRow.querySelectorAll('th'));
            headerCells.forEach((th, idx) => {
                if (!th.dataset.colId) {
                    const txt = (th.textContent || '').trim().toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
                    th.dataset.colId = txt ? `col_${txt}` : `col_${idx}`;
                }
            });

            unifiedTableRegistry[tableId] = {
                storageKeyPrefix,
                options
            };

            // Add Excel-like filter row (if enabled)
            if (options.enableHeaderFilters !== false) {
                addUnifiedFilterRow(tableId);
            }

            // Init resize + drag + persistence
            initResizableDraggableTable(tableId, storageKeyPrefix);

            // Apply current filters (header row + optional global filter)
            applyUnifiedTableFilters(tableId);
        }

        function addUnifiedFilterRow(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;

            const thead = table.querySelector('thead');
            if (!thead) return;

            const rows = Array.from(thead.querySelectorAll('tr'));
            if (rows.length === 0) return;

            // Avoid double row
            if (thead.querySelector('tr.ut-filter-row')) return;

            const headerRow = rows[0];
            const headerCells = Array.from(headerRow.querySelectorAll('th'));

            const filterRow = document.createElement('tr');
            filterRow.className = 'ut-filter-row';

            headerCells.forEach((th) => {
                const cell = document.createElement('th');
                cell.dataset.colId = th.dataset.colId || '';
                cell.className = 'ut-filter-cell';

                const isNonFilter = th.classList.contains('col-checkbox') ||
                    th.classList.contains('col-actions') ||
                    th.classList.contains('no-filter') ||
                    th.dataset.noFilter === '1';

                if (!isNonFilter) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'ut-filter-input';
                    input.placeholder = 'filter‚Ä¶';
                    input.dataset.colId = th.dataset.colId || '';
                    input.addEventListener('input', () => {
                        applyUnifiedTableFilters(tableId);
                        refreshTablePagination(tableId);
                    });
                    cell.appendChild(input);
                }

                filterRow.appendChild(cell);
            });

            thead.appendChild(filterRow);
        }

        function applyUnifiedTableFilters(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;

            const tbody = table.querySelector('tbody');
            const thead = table.querySelector('thead');
            if (!tbody || !thead) return;

            const registry = unifiedTableRegistry[tableId] || {};
            const options = registry.options || {};

            const headerFilterInputs = Array.from(thead.querySelectorAll('.ut-filter-row .ut-filter-input'));
            const colFilters = {};
            headerFilterInputs.forEach(inp => {
                const colId = inp.dataset.colId;
                const val = (inp.value || '').trim().toLowerCase();
                if (colId && val) colFilters[colId] = val;
            });

            let globalFilter = '';
            if (options.globalSearchSelector) {
                const el = document.querySelector(options.globalSearchSelector);
                if (el) globalFilter = (el.value || '').trim().toLowerCase();
            }

            const headerRow = thead.querySelector('tr');
            const ths = headerRow ? Array.from(headerRow.querySelectorAll('th')) : [];
            const colIdToIndex = {};
            ths.forEach((th, idx) => {
                if (th.dataset.colId) colIdToIndex[th.dataset.colId] = idx;
            });

            const rows = Array.from(tbody.querySelectorAll('tr'));

            rows.forEach(row => {
                const tds = Array.from(row.children);

                let matches = true;

                // Column filters
                for (const [colId, q] of Object.entries(colFilters)) {
                    const idx = colIdToIndex[colId];
                    if (idx === undefined) continue;
                    const cellText = ((tds[idx]?.textContent) || '').trim().toLowerCase();
                    if (!cellText.includes(q)) { matches = false; break; }
                }

                // Global filter (search across entire row)
                if (matches && globalFilter) {
                    const rowText = (row.textContent || '').trim().toLowerCase();
                    if (!rowText.includes(globalFilter)) matches = false;
                }

                // Apply as dataset flag, but keep pagination in control of actual showing/hiding
                row.dataset.utFiltered = matches ? '' : '1';

                // If there is no pagination instance, hide/show directly
                if (!paginationInstances[tableId]) {
                    row.style.display = matches ? '' : 'none';
                }
            });
        }



        // =========================================================
        // SUPER TABLE - High Performance Virtual Table with Excel Filters
        // =========================================================
        const superTableInstances = {};

        class SuperTable {
            constructor(containerId, options = {}) {
                this.containerId = containerId;
                this.container = document.getElementById(containerId);
                if (!this.container) {
                    console.error(`SuperTable: Container #${containerId} not found`);
                    return;
                }

                // Default options
                this.options = {
                    columns: [],           // Column definitions
                    data: [],              // Data array
                    rowHeight: 40,         // Height of each row in px
                    pageSize: 100,         // Items per page
                    storageKey: `super_table_${containerId}`,
                    onRowClick: null,      // Callback when row is clicked
                    onSelectionChange: null, // Callback when selection changes
                    onDataChange: null,    // Callback when data changes
                    renderCell: null,      // Custom cell renderer
                    getRowClass: null,     // Custom row class
                    ...options
                };

                // State
                this.allData = [];          // Original data
                this.filteredData = [];     // After filters applied
                this.sortedData = [];       // After sorting
                this.currentPage = 1;
                this.selectedRows = new Set();
                this.columnFilters = {};
                this.sortColumn = null;
                this.sortDirection = 'asc';
                this.columnWidths = {};
                this.columnOrder = [];
                this.isInitialized = false;

                // Load saved settings
                this.loadSettings();

                // Build the table
                this.build();
                this.isInitialized = true;
            }

            loadSettings() {
                try {
                    const saved = localStorage.getItem(this.options.storageKey);
                    if (saved) {
                        const settings = JSON.parse(saved);
                        this.columnWidths = settings.widths || {};
                        this.columnOrder = settings.order || [];
                        this.currentPage = settings.page || 1;
                        this.sortColumn = settings.sortCol || null;
                        this.sortDirection = settings.sortDir || 'asc';
                    }
                } catch (e) { }
            }

            saveSettings() {
                try {
                    localStorage.setItem(this.options.storageKey, JSON.stringify({
                        widths: this.columnWidths,
                        order: this.columnOrder,
                        page: this.currentPage,
                        sortCol: this.sortColumn,
                        sortDir: this.sortDirection
                    }));
                } catch (e) { }
            }

            build() {
                // Clear container
                this.container.innerHTML = '';
                this.container.className = 'super-table-container';

                // Create scrollable wrapper for the table
                this.bodyContainer = document.createElement('div');
                this.bodyContainer.className = 'super-table-body-container';

                // Create table
                this.table = document.createElement('table');
                this.table.className = 'super-table';
                this.table.id = `${this.containerId}-table`;

                // Create thead
                this.thead = document.createElement('thead');
                this.buildHeader();
                this.table.appendChild(this.thead);

                // Create actual tbody - keep it inside the table
                this.tbody = document.createElement('tbody');
                this.table.appendChild(this.tbody);

                // Add table to body container
                this.bodyContainer.appendChild(this.table);
                this.container.appendChild(this.bodyContainer);

                // Create status bar
                this.statusBar = document.createElement('div');
                this.statusBar.className = 'super-table-status-bar';
                this.container.appendChild(this.statusBar);

                // Setup scroll handler for potential virtual scrolling
                this.setupVirtualScroll();

                // Setup resize handlers
                this.setupResizeHandlers();

                // Setup drag handlers
                this.setupDragHandlers();
            }

            buildHeader() {
                this.thead.innerHTML = '';
                const tr = document.createElement('tr');

                // Get ordered columns
                const orderedCols = this.getOrderedColumns();

                orderedCols.forEach((col, idx) => {
                    const th = document.createElement('th');
                    th.dataset.colId = col.id;

                    // Apply column classes
                    if (col.type === 'checkbox') th.className = 'col-checkbox';
                    else if (col.type === 'action') th.className = 'col-action';

                    // Apply saved width
                    if (this.columnWidths[col.id]) {
                        th.style.width = this.columnWidths[col.id] + 'px';
                    } else if (col.width) {
                        th.style.width = typeof col.width === 'number' ? col.width + 'px' : col.width;
                    }

                    // Build header content
                    const headerWrap = document.createElement('div');
                    headerWrap.className = 'col-header-wrap';

                    // Title row
                    const titleRow = document.createElement('div');
                    titleRow.className = 'col-title-row';

                    if (col.type === 'checkbox') {
                        // Checkbox column - select all
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'select-all-checkbox';
                        checkbox.addEventListener('change', () => this.toggleSelectAll(checkbox.checked));
                        titleRow.appendChild(checkbox);
                    } else {
                        // Drag handle
                        if (col.type !== 'action') {
                            const dragHandle = document.createElement('span');
                            dragHandle.className = 'col-drag-handle';
                            dragHandle.textContent = '‚ãÆ‚ãÆ';
                            titleRow.appendChild(dragHandle);
                        }

                        // Title text
                        const titleText = document.createElement('span');
                        titleText.className = 'col-title-text';
                        titleText.textContent = col.title || col.id;
                        titleRow.appendChild(titleText);

                        // Sort icon (if sortable)
                        if (col.sortable !== false && col.type !== 'action') {
                            const sortIcon = document.createElement('span');
                            sortIcon.className = 'col-sort-icon';
                            if (this.sortColumn === col.id) {
                                sortIcon.className += ' active';
                                sortIcon.textContent = this.sortDirection === 'asc' ? '‚ñ≤' : '‚ñº';
                            } else {
                                sortIcon.textContent = '‚Üï';
                            }
                            titleRow.appendChild(sortIcon);

                            // Sort on click
                            titleRow.addEventListener('click', (e) => {
                                if (!e.target.closest('.col-drag-handle')) {
                                    this.handleSort(col.id);
                                }
                            });
                        }
                    }

                    headerWrap.appendChild(titleRow);

                    // Filter row (for filterable columns)
                    if (col.filterable !== false && col.type !== 'checkbox' && col.type !== 'action') {
                        const filterRow = document.createElement('div');
                        filterRow.className = 'col-filter-row';

                        const filterInput = document.createElement('input');
                        filterInput.type = 'text';
                        filterInput.className = 'col-filter-input';
                        filterInput.placeholder = 'Filter...';
                        filterInput.dataset.colId = col.id;
                        filterInput.value = this.columnFilters[col.id] || '';

                        // Debounced filter
                        let filterTimeout;
                        filterInput.addEventListener('input', () => {
                            clearTimeout(filterTimeout);
                            filterTimeout = setTimeout(() => {
                                this.columnFilters[col.id] = filterInput.value;
                                this.applyFiltersAndSort();
                            }, 200);
                        });

                        filterInput.addEventListener('keydown', (e) => {
                            if (e.key === 'Escape') {
                                filterInput.value = '';
                                this.columnFilters[col.id] = '';
                                this.applyFiltersAndSort();
                            }
                        });

                        filterRow.appendChild(filterInput);
                        headerWrap.appendChild(filterRow);
                    }

                    th.appendChild(headerWrap);

                    // Resize handle
                    if (col.resizable !== false && col.type !== 'checkbox') {
                        const resizeHandle = document.createElement('div');
                        resizeHandle.className = 'col-resize-handle';
                        th.appendChild(resizeHandle);
                    }

                    tr.appendChild(th);
                });

                this.thead.appendChild(tr);
            }

            getOrderedColumns() {
                const cols = [...this.options.columns];
                if (this.columnOrder.length > 0) {
                    // Sort by saved order
                    cols.sort((a, b) => {
                        const aIdx = this.columnOrder.indexOf(a.id);
                        const bIdx = this.columnOrder.indexOf(b.id);
                        if (aIdx === -1 && bIdx === -1) return 0;
                        if (aIdx === -1) return 1;
                        if (bIdx === -1) return -1;
                        return aIdx - bIdx;
                    });
                }
                return cols;
            }

            setupVirtualScroll() {
                this.bodyContainer.addEventListener('scroll', () => {
                    this.renderVisibleRows();
                });
            }

            setupResizeHandlers() {
                let resizing = null;
                let startX = 0;
                let startWidth = 0;

                const onMouseMove = (e) => {
                    if (!resizing) return;
                    const diff = e.clientX - startX;
                    const newWidth = Math.max(50, startWidth + diff);
                    resizing.th.style.width = newWidth + 'px';
                };

                const onMouseUp = () => {
                    if (resizing) {
                        const colId = resizing.th.dataset.colId;
                        this.columnWidths[colId] = resizing.th.offsetWidth;
                        this.saveSettings();
                        resizing.handle.classList.remove('resizing');
                        this.table.classList.remove('resizing');
                    }
                    resizing = null;
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                };

                this.thead.addEventListener('mousedown', (e) => {
                    const handle = e.target.closest('.col-resize-handle');
                    if (!handle) return;

                    e.preventDefault();
                    const th = handle.parentElement;
                    resizing = { th, handle };
                    startX = e.clientX;
                    startWidth = th.offsetWidth;
                    handle.classList.add('resizing');
                    this.table.classList.add('resizing');

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
            }

            setupDragHandlers() {
                let draggedTh = null;

                this.thead.addEventListener('dragstart', (e) => {
                    const th = e.target.closest('th');
                    if (!th || th.classList.contains('col-checkbox') || th.classList.contains('col-action')) return;

                    draggedTh = th;
                    th.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', th.dataset.colId);
                });

                this.thead.addEventListener('dragend', (e) => {
                    if (draggedTh) {
                        draggedTh.classList.remove('dragging');
                        draggedTh = null;
                    }
                    this.thead.querySelectorAll('th').forEach(th => th.classList.remove('drag-over'));
                });

                this.thead.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    const th = e.target.closest('th');
                    if (th && th !== draggedTh && !th.classList.contains('col-checkbox') && !th.classList.contains('col-action')) {
                        th.classList.add('drag-over');
                    }
                });

                this.thead.addEventListener('dragleave', (e) => {
                    const th = e.target.closest('th');
                    if (th) th.classList.remove('drag-over');
                });

                this.thead.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const targetTh = e.target.closest('th');
                    if (!targetTh || targetTh === draggedTh || !draggedTh) return;
                    if (targetTh.classList.contains('col-checkbox') || targetTh.classList.contains('col-action')) return;

                    targetTh.classList.remove('drag-over');

                    const draggedId = draggedTh.dataset.colId;
                    const targetId = targetTh.dataset.colId;

                    // Update column order
                    const cols = this.getOrderedColumns().map(c => c.id);
                    const draggedIdx = cols.indexOf(draggedId);
                    const targetIdx = cols.indexOf(targetId);

                    cols.splice(draggedIdx, 1);
                    cols.splice(targetIdx, 0, draggedId);

                    this.columnOrder = cols;
                    this.saveSettings();

                    // Rebuild header and re-render
                    this.buildHeader();
                    this.setupResizeHandlers();
                    this.setupDragHandlers();
                    this.renderVisibleRows();

                    // Make headers draggable
                    this.thead.querySelectorAll('th').forEach(th => {
                        if (!th.classList.contains('col-checkbox') && !th.classList.contains('col-action')) {
                            th.draggable = true;
                        }
                    });
                });

                // Make headers draggable
                this.thead.querySelectorAll('th').forEach(th => {
                    if (!th.classList.contains('col-checkbox') && !th.classList.contains('col-action')) {
                        th.draggable = true;
                    }
                });
            }

            setData(data) {
                this.allData = Array.isArray(data) ? data : [];
                this.indexMap = new Map();
                // Build a fast object->index map to avoid O(n) indexOf and -1 issues
                try {
                    this.allData.forEach((it, i) => {
                        try { this.indexMap.set(it, i); } catch (e) { }
                    });
                } catch (e) { }

                this.selectedRows.clear();
                this.applyFiltersAndSort();
            }

            applyFiltersAndSort() {
                // Apply filters
                this.filteredData = this.allData.filter(item => {
                    // External/legacy filters (provided by the view)
                    if (typeof this.options.externalFilterFn === 'function') {
                        try {
                            if (!this.options.externalFilterFn(item)) return false;
                        } catch (e) {
                            // If external filter throws, do not block row
                        }
                    }

                    for (const colId in this.columnFilters) {
                        const filterVal = String(this.columnFilters[colId] || '').toLowerCase().trim();
                        if (!filterVal) continue;

                        const col = this.options.columns.find(c => c.id === colId);
                        if (!col) continue;

                        let cellVal = '';
                        if (col.getValue) {
                            cellVal = String(col.getValue(item) || '').toLowerCase();
                        } else {
                            cellVal = String(item[colId] || '').toLowerCase();
                        }

                        if (!cellVal.includes(filterVal)) {
                            return false;
                        }
                    }
                    return true;
                });

                // Apply sorting
                if (this.sortColumn) {
                    const col = this.options.columns.find(c => c.id === this.sortColumn);
                    this.filteredData.sort((a, b) => {
                        let aVal, bVal;
                        if (col && col.getValue) {
                            aVal = col.getValue(a);
                            bVal = col.getValue(b);
                        } else {
                            aVal = a[this.sortColumn];
                            bVal = b[this.sortColumn];
                        }

                        // Handle numeric values
                        if (col && col.type === 'number') {
                            aVal = parseFloat(aVal) || 0;
                            bVal = parseFloat(bVal) || 0;
                        } else {
                            aVal = String(aVal || '').toLowerCase();
                            bVal = String(bVal || '').toLowerCase();
                        }

                        let cmp = 0;
                        if (aVal < bVal) cmp = -1;
                        else if (aVal > bVal) cmp = 1;

                        return this.sortDirection === 'asc' ? cmp : -cmp;
                    });
                }

                this.sortedData = this.filteredData;

                // Reset to page 1 if current page is out of range
                const totalPages = Math.ceil(this.sortedData.length / this.options.pageSize);
                if (this.currentPage > totalPages) {
                    this.currentPage = Math.max(1, totalPages);
                }

                this.renderVisibleRows();
                this.renderStatusBar();
            }

            handleSort(colId) {
                if (this.sortColumn === colId) {
                    this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    this.sortColumn = colId;
                    this.sortDirection = 'asc';
                }
                this.saveSettings();
                this.buildHeader();
                this.setupResizeHandlers();
                this.setupDragHandlers();
                this.applyFiltersAndSort();
            }

            renderVisibleRows() {
                const pageSize = this.options.pageSize;
                const startIdx = (this.currentPage - 1) * pageSize;
                const endIdx = Math.min(startIdx + pageSize, this.sortedData.length);
                const pageData = this.sortedData.slice(startIdx, endIdx);

                this.tbody.innerHTML = '';

                if (pageData.length === 0) {
                    // Show no results
                    const tr = document.createElement('tr');
                    const td = document.createElement('td');
                    td.colSpan = this.options.columns.length;
                    td.className = 'super-table-no-results';
                    td.innerHTML = `
                <div class="super-table-no-results-icon">üì≠</div>
                <div>No items match your filters</div>
            `;
                    tr.appendChild(td);
                    this.tbody.appendChild(tr);
                    return;
                }

                const orderedCols = this.getOrderedColumns();

                pageData.forEach((item, pageIdx) => {
                    const dataIdx = startIdx + pageIdx;
                    const originalIdx = (this.indexMap && this.indexMap.has(item)) ? this.indexMap.get(item) : this.allData.indexOf(item);
                    const tr = document.createElement('tr');
                    tr.dataset.index = originalIdx;
                    tr.dataset.dataIndex = dataIdx;

                    // Apply row class
                    if (this.options.getRowClass) {
                        const cls = this.options.getRowClass(item, originalIdx);
                        if (cls) tr.className = cls;
                    }

                    // Apply row style (for status-based coloring)
                    if (this.options.getRowStyle) {
                        const style = this.options.getRowStyle(item, originalIdx);
                        if (style) {
                            Object.assign(tr.style, style);
                        }
                    }

                    // Selection
                    if (this.selectedRows.has(originalIdx)) {
                        tr.classList.add('selected');
                    }

                    orderedCols.forEach(col => {
                        const td = document.createElement('td');

                        if (col.type === 'checkbox') {
                            td.className = 'col-checkbox';
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.className = 'row-checkbox';
                            checkbox.checked = this.selectedRows.has(originalIdx);
                            checkbox.addEventListener('click', (e) => e.stopPropagation());
                            checkbox.addEventListener('change', () => {
                                this.toggleRowSelection(originalIdx, checkbox.checked);
                            });
                            td.appendChild(checkbox);
                        } else if (col.type === 'action') {
                            td.className = 'col-action';
                            td.textContent = 'üëÅÔ∏è';
                            td.addEventListener('click', (e) => {
                                e.stopPropagation();
                                if (this.options.onRowClick) {
                                    this.options.onRowClick(item, originalIdx);
                                }
                            });
                        } else if (this.options.renderCell) {
                            // Custom renderer
                            const content = this.options.renderCell(col, item, originalIdx);
                            if (typeof content === 'string') {
                                td.innerHTML = content;
                            } else if (content instanceof HTMLElement) {
                                td.appendChild(content);
                            }
                        } else if (col.render) {
                            // Column-specific renderer
                            const content = col.render(item, originalIdx);
                            if (typeof content === 'string') {
                                td.innerHTML = content;
                            } else if (content instanceof HTMLElement) {
                                td.appendChild(content);
                            }
                        } else {
                            // Default: get value
                            let value = col.getValue ? col.getValue(item) : item[col.id];
                            td.textContent = value ?? '';
                        }

                        tr.appendChild(td);
                    });

                    // Row click handler - add cursor style for clickable rows
                    tr.style.cursor = 'pointer';
                    tr.addEventListener('click', (e) => {
                        // Don't trigger row click if clicking on checkbox, action column, select, or input
                        if (e.target.closest('.row-checkbox') ||
                            e.target.closest('.col-action') ||
                            e.target.closest('select') ||
                            e.target.closest('input')) {
                            return;
                        }
                        if (this.options.onRowClick) {
                            this.options.onRowClick(item, originalIdx);
                        }
                    });

                    this.tbody.appendChild(tr);
                });

                // Update select-all checkbox
                this.updateSelectAllCheckbox();
            }

            renderStatusBar() {
                const total = this.allData.length;
                const filtered = this.sortedData.length;
                const pageSize = this.options.pageSize;
                const totalPages = Math.ceil(filtered / pageSize);
                const startItem = filtered > 0 ? (this.currentPage - 1) * pageSize + 1 : 0;
                const endItem = Math.min(this.currentPage * pageSize, filtered);

                const hasFilters = Object.values(this.columnFilters).some(v => v);

                // Generate page numbers
                let pageNumbers = '';
                const maxPagesToShow = 5;
                let startPage = Math.max(1, this.currentPage - Math.floor(maxPagesToShow / 2));
                let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
                if (endPage - startPage < maxPagesToShow - 1) {
                    startPage = Math.max(1, endPage - maxPagesToShow + 1);
                }

                if (startPage > 1) {
                    pageNumbers += `<button class="page-number" data-page="1">1</button>`;
                    if (startPage > 2) pageNumbers += `<span style="color:#999;">...</span>`;
                }
                for (let i = startPage; i <= endPage; i++) {
                    pageNumbers += `<button class="page-number ${i === this.currentPage ? 'active' : ''}" data-page="${i}">${i}</button>`;
                }
                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) pageNumbers += `<span style="color:#999;">...</span>`;
                    pageNumbers += `<button class="page-number" data-page="${totalPages}">${totalPages}</button>`;
                }

                this.statusBar.innerHTML = `
            <div class="super-table-status-left">
                <span><b>${this.selectedRows.size}</b> selected</span>
                <span>${filtered !== total ? `Showing ${filtered} of ${total} items (filtered)` : `${total} items`}</span>
                ${hasFilters ? `<button class="super-table-clear-filters">Clear Filters</button>` : ''}
            </div>
            <div class="super-table-status-right">
                <span>Rows: ${startItem}-${endItem}</span>
                <select class="super-table-page-size-select">
                    <option value="50" ${pageSize === 50 ? 'selected' : ''}>50 / page</option>
                    <option value="100" ${pageSize === 100 ? 'selected' : ''}>100 / page</option>
                    <option value="200" ${pageSize === 200 ? 'selected' : ''}>200 / page</option>
                    <option value="500" ${pageSize === 500 ? 'selected' : ''}>500 / page</option>
                </select>
                <div class="super-table-page-nav">
                    <button class="prev-page" ${this.currentPage <= 1 ? 'disabled' : ''}>‚Üê Prev</button>
                    ${pageNumbers}
                    <button class="next-page" ${this.currentPage >= totalPages ? 'disabled' : ''}>Next ‚Üí</button>
                </div>
                <div class="super-table-jump">
                    <span>Go to:</span>
                    <input type="number" min="1" max="${totalPages}" value="${this.currentPage}">
                </div>
            </div>
        `;

                // Attach handlers
                this.statusBar.querySelector('.prev-page')?.addEventListener('click', () => this.goToPage(this.currentPage - 1));
                this.statusBar.querySelector('.next-page')?.addEventListener('click', () => this.goToPage(this.currentPage + 1));
                this.statusBar.querySelectorAll('.page-number').forEach(btn => {
                    btn.addEventListener('click', () => this.goToPage(parseInt(btn.dataset.page)));
                });

                const jumpInput = this.statusBar.querySelector('.super-table-jump input');
                if (jumpInput) {
                    jumpInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') this.goToPage(parseInt(jumpInput.value) || 1);
                    });
                    jumpInput.addEventListener('change', () => {
                        this.goToPage(parseInt(jumpInput.value) || 1);
                    });
                }

                const pageSizeSelect = this.statusBar.querySelector('.super-table-page-size-select');
                if (pageSizeSelect) {
                    pageSizeSelect.addEventListener('change', () => {
                        this.options.pageSize = parseInt(pageSizeSelect.value);
                        this.currentPage = 1;
                        this.applyFiltersAndSort();
                    });
                }

                const clearBtn = this.statusBar.querySelector('.super-table-clear-filters');
                if (clearBtn) {
                    clearBtn.addEventListener('click', () => this.clearFilters());
                }
            }

            goToPage(page) {
                const totalPages = Math.ceil(this.sortedData.length / this.options.pageSize);
                this.currentPage = Math.max(1, Math.min(page, totalPages));
                this.saveSettings();
                this.renderVisibleRows();
                this.renderStatusBar();
            }

            clearFilters() {
                this.columnFilters = {};
                this.thead.querySelectorAll('.col-filter-input').forEach(input => {
                    input.value = '';
                });
                this.applyFiltersAndSort();
            }

            toggleSelectAll(checked) {
                const pageSize = this.options.pageSize;
                const startIdx = (this.currentPage - 1) * pageSize;
                const endIdx = Math.min(startIdx + pageSize, this.sortedData.length);

                for (let i = startIdx; i < endIdx; i++) {
                    const item = this.sortedData[i];
                    const originalIdx = (this.indexMap && this.indexMap.has(item)) ? this.indexMap.get(item) : this.allData.indexOf(item);
                    if (originalIdx == null || originalIdx < 0) continue;
                    if (checked) {
                        this.selectedRows.add(originalIdx);
                    } else {
                        this.selectedRows.delete(originalIdx);
                    }
                }

                this.renderVisibleRows();
                this.renderStatusBar();
                if (this.options.onSelectionChange) {
                    this.options.onSelectionChange(this.getSelectedItems());
                }
            }

            toggleRowSelection(idx, checked) {
                if (checked) {
                    this.selectedRows.add(idx);
                } else {
                    this.selectedRows.delete(idx);
                }
                this.updateSelectAllCheckbox();
                this.renderStatusBar();
                if (this.options.onSelectionChange) {
                    this.options.onSelectionChange(this.getSelectedItems());
                }
            }

            updateSelectAllCheckbox() {
                const selectAll = this.thead.querySelector('.select-all-checkbox');
                if (!selectAll) return;

                const pageSize = this.options.pageSize;
                const startIdx = (this.currentPage - 1) * pageSize;
                const endIdx = Math.min(startIdx + pageSize, this.sortedData.length);

                let allSelected = true;
                let anySelected = false;

                for (let i = startIdx; i < endIdx; i++) {
                    const item = this.sortedData[i];
                    const originalIdx = (this.indexMap && this.indexMap.has(item)) ? this.indexMap.get(item) : this.allData.indexOf(item);
                    if (originalIdx == null || originalIdx < 0) continue;
                    if (this.selectedRows.has(originalIdx)) {
                        anySelected = true;
                    } else {
                        allSelected = false;
                    }
                }

                selectAll.checked = allSelected && anySelected;
                selectAll.indeterminate = anySelected && !allSelected;
            }

            getSelectedItems() {
                return Array.from(this.selectedRows).map(idx => this.allData[idx]).filter(Boolean);
            }

            getSelectedIndices() {
                return Array.from(this.selectedRows);
            }

            clearSelection() {
                this.selectedRows.clear();
                this.renderVisibleRows();
                this.renderStatusBar();
            }

            refresh() {
                this.applyFiltersAndSort();
            }

            destroy() {
                this.container.innerHTML = '';
                delete superTableInstances[this.containerId];
            }
        }

        // Factory function
        function createSuperTable(containerId, options) {
            if (superTableInstances[containerId]) {
                superTableInstances[containerId].destroy();
            }
            const instance = new SuperTable(containerId, options);
            superTableInstances[containerId] = instance;
            return instance;
        }
        window.createSuperTable = createSuperTable;

        function getSuperTable(containerId) {
            return superTableInstances[containerId];
        }

        function filterMainProjects() {
            const filterInput = getEl('main-filter');
            const statusFilter = getEl('main-status-filter');
            const tb = getEl('main-projects-tbody');
            if (!tb) return;

            const search = String(filterInput?.value || '').toLowerCase().trim();
            const status = String(statusFilter?.value || '').toLowerCase();

            const rows = tb.querySelectorAll('tr');
            rows.forEach(row => {
                const name = row.querySelector('td:first-child')?.textContent?.toLowerCase() || '';
                const rowStatus = row.querySelector('td:nth-child(2)')?.textContent?.toLowerCase() || '';

                let show = true;
                if (search && !name.includes(search)) show = false;
                if (status && !rowStatus.includes(status)) show = false;

                row.style.display = show ? '' : 'none';
            });

            refreshTablePagination('main-projects-table');

        }

        // Main Projects Table Sorting
        let mainProjectsSortState = { field: null, dir: 'asc' };

        window.sortMainProjects = function (field) {
            const tb = document.getElementById('main-projects-tbody');
            if (!tb) return;

            // Toggle sort direction
            if (mainProjectsSortState.field === field) {
                mainProjectsSortState.dir = mainProjectsSortState.dir === 'asc' ? 'desc' : 'asc';
            } else {
                mainProjectsSortState.field = field;
                mainProjectsSortState.dir = 'asc';
            }

            const rows = Array.from(tb.querySelectorAll('tr'));

            // Update sort indicators
            document.querySelectorAll('#main-projects-table .sort-indicator').forEach(ind => {
                const sortField = ind.dataset.sort;
                if (sortField === field) {
                    ind.textContent = mainProjectsSortState.dir === 'asc' ? ' ‚Üë' : ' ‚Üì';
                    ind.style.opacity = '1';
                } else {
                    ind.textContent = '';
                    ind.style.opacity = '0.3';
                }
            });

            // Get column index for sorting
            const colMap = { name: 0, status: 1, items: 2, value: 3, deadline: 7 };
            const colIdx = colMap[field];
            if (colIdx === undefined) return;

            rows.sort((a, b) => {
                const cellA = a.querySelector(`td:nth-child(${colIdx + 1})`);
                const cellB = b.querySelector(`td:nth-child(${colIdx + 1})`);
                let valA = cellA?.textContent?.trim() || '';
                let valB = cellB?.textContent?.trim() || '';

                // Numeric fields
                if (field === 'items' || field === 'value') {
                    valA = parseFloat(valA.replace(/[^0-9.-]/g, '')) || 0;
                    valB = parseFloat(valB.replace(/[^0-9.-]/g, '')) || 0;
                    return mainProjectsSortState.dir === 'asc' ? valA - valB : valB - valA;
                }

                // Date field
                if (field === 'deadline') {
                    const dA = new Date(valA);
                    const dB = new Date(valB);
                    const tA = isNaN(dA.getTime()) ? 0 : dA.getTime();
                    const tB = isNaN(dB.getTime()) ? 0 : dB.getTime();
                    return mainProjectsSortState.dir === 'asc' ? tA - tB : tB - tA;
                }

                // String fields (name, status)
                valA = valA.toLowerCase();
                valB = valB.toLowerCase();
                if (valA < valB) return mainProjectsSortState.dir === 'asc' ? -1 : 1;
                if (valA > valB) return mainProjectsSortState.dir === 'asc' ? 1 : -1;
                return 0;
            });

            // Re-append sorted rows
            rows.forEach(row => tb.appendChild(row));

            // Refresh pagination after sort
            refreshTablePagination('main-projects-table');
        };

        function exportMainProjectsCSV() {
            projects = getAllProjectsSafe();
            const list = Array.isArray(projects) ? projects : [];
            const headers = ['Project ID', 'Project Name', 'Items', 'Suppliers', 'Bundles', 'Deadline', 'Sent To', 'Dashboard Notes'];
            const rows = list.map(p => {
                const items = Array.isArray(p.items) ? p.items.length : 0;
                const suppliers = getProjectSuppliersCountSafe(p);
                const bundles = getProjectBundlesSafe(p).length;
                const deadline = p && p.dates ? (p.dates.deadline || '') : '';
                const sentTo = p && p.dates ? (p.dates.sent_to || p.dates.sentTo || '') : '';
                const notes = Array.isArray(p.dashboard_notes) ? p.dashboard_notes.map(n => (n && n.text) ? String(n.text).replace(/\s+/g, ' ').trim() : '').filter(Boolean).join(' | ') : '';
                return [p.id, p.name, items, suppliers, bundles, deadline, sentTo, notes];
            });
            const csv = [headers, ...rows].map(r => r.map(v => {
                const s = String(v ?? '');
                if (s.includes('"') || s.includes(',') || s.includes('\n')) return '"' + s.replace(/"/g, '""') + '"';
                return s;
            }).join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `RFQ_MAIN_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Make functions globally accessible for Main tab Actions
        window.exportMainProjectsCSV = exportMainProjectsCSV;
        window.renderMainOverview = typeof renderMainOverview === 'function' ? renderMainOverview : function () { };

        // =========================================================
        // Global Supplier Detail (from Main view)
        // =========================================================
        function openGlobalSupplierDetail(supplierName) {
            if (!supplierName) return;

            projects = getAllProjectsSafe();
            const allProjects = Array.isArray(projects) ? projects : [];

            // Find a project that has this supplier
            let targetProject = null;
            for (const p of allProjects) {
                const items = Array.isArray(p.items) ? p.items : [];
                for (const it of items) {
                    if (it.supplier === supplierName || it.main_supplier === supplierName) {
                        targetProject = p;
                        break;
                    }
                    const supArr = Array.isArray(it.suppliers) ? it.suppliers : [];
                    for (const s of supArr) {
                        const nm = s && (s.supplier || s.name || s.company);
                        if (nm === supplierName) {
                            targetProject = p;
                            break;
                        }
                    }
                    if (targetProject) break;
                }
                if (targetProject) break;

                // Also check bundles
                const bundles = getProjectBundlesSafe(p);
                for (const b of bundles) {
                    const sup = String((b && (b.supplier || b.supplier_name || b.supplierName)) || '').trim();
                    if (sup === supplierName) {
                        targetProject = p;
                        break;
                    }
                }
                if (targetProject) break;
            }

            if (targetProject) {
                // Open the project and then the supplier detail
                if (typeof openProject === 'function') {
                    openProject(targetProject);
                }
                if (window.openSupplierDetail && typeof window.openSupplierDetail === 'function') {
                    window.openSupplierDetail(supplierName);
                }
            } else {
                showToast('Supplier "' + supplierName + '" not found in any project.', 'warning');
            }
        }

        // =========================================================
        // Dashboard Notes / Comments (project-level)
        // =========================================================

        function renderDashboardNotes() {
            const tb = getEl('dash-notes-tbody');
            if (!tb) return;
            if (!currentProject) { tb.innerHTML = '<tr><td colspan="3" class="muted" style="padding:12px;">Select a project to see comments.</td></tr>'; return; }
            const notes = Array.isArray(currentProject.dashboard_notes) ? currentProject.dashboard_notes : [];
            if (!notes.length) { tb.innerHTML = '<tr><td colspan="3" class="muted" style="padding:12px;">No comments yet.</td></tr>'; return; }
            tb.innerHTML = notes.map(n => {
                const dt = n && n.created_at ? String(n.created_at).slice(0, 19).replace('T', ' ') : '';
                const txt = n && n.text ? String(n.text) : '';
                const id = n && n.id ? String(n.id) : '';
                return `
            <tr>
                <td>${escapeHtml(dt)}</td>
                <td>${escapeHtml(txt)}</td>
                <td style="white-space:nowrap;">
                    <button class="btn-secondary btn-sm" data-dash-note-action="edit" data-id="${escapeHtml(id)}">Edit</button>
                    <button class="btn-secondary btn-sm" data-dash-note-action="delete" data-id="${escapeHtml(id)}">Del</button>
                </td>
            </tr>
        `;
            }).join('');
        }

        // =========================================================
        // Project Detail (per project)
        // - links, notes, comments, attachments, cover photo
        // =========================================================

        const __PROJ_DETAIL_CACHE__ = window.__PROJ_DETAIL_CACHE__ || { attachments: new Map() };
        window.__PROJ_DETAIL_CACHE__ = __PROJ_DETAIL_CACHE__;

        function ensureProjectDetailFields(proj) {
            if (!proj || typeof proj !== 'object') return;
            if (!Array.isArray(proj.project_links)) proj.project_links = [];
            if (!Array.isArray(proj.project_comments)) proj.project_comments = [];
            if (proj.project_notes_text === undefined || proj.project_notes_text === null) proj.project_notes_text = '';
            if (proj.cover_attachment_id === undefined || proj.cover_attachment_id === null) proj.cover_attachment_id = '';
        }

        function projDetailApiUrl(pid) {
            return `/api/projects/${encodeURIComponent(String(pid))}/attachments`;
        }
        function projDetailApiUrlOne(pid, aid) {
            return `/api/projects/${encodeURIComponent(String(pid))}/attachments/${encodeURIComponent(String(aid))}`;
        }

        async function projDetailFetchJson(url, opts) {
            const o = opts || {};
            const res = await fetch(url, { method: o.method || 'GET', body: o.body, credentials: 'same-origin' });
            if (!res.ok) {
                const t = await res.text().catch(() => '');
                throw new Error(t || ('HTTP ' + res.status));
            }
            return await res.json();
        }

        async function loadProjectAttachments(pid) {
            if (!pid) return [];
            try {
                const data = await projDetailFetchJson(projDetailApiUrl(pid));
                const arr = data && Array.isArray(data.attachments) ? data.attachments : [];
                __PROJ_DETAIL_CACHE__.attachments.set(String(pid), arr);
                return arr;
            } catch (e) {
                __PROJ_DETAIL_CACHE__.attachments.set(String(pid), []);
                return [];
            }
        }

        async function uploadProjectAttachment(pid, file, kind) {
            if (!pid || !file) return null;
            const fd = new FormData();
            fd.append('file', file);
            if (kind) fd.append('kind', String(kind));
            const data = await projDetailFetchJson(projDetailApiUrl(pid), { method: 'POST', body: fd });
            return data && data.attachment ? data.attachment : null;
        }

        async function deleteProjectAttachment(pid, aid) {
            if (!pid || !aid) return false;
            await projDetailFetchJson(projDetailApiUrlOne(pid, aid), { method: 'DELETE' });
            return true;
        }

        function openAddProjectLinkModal(onAdd) {
            const id = 'proj-link-editor-modal';
            let overlay = document.getElementById(id);
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = id;
                overlay.className = 'modal-overlay';
                overlay.style.zIndex = '3700';
                overlay.innerHTML = `
            <div class="modal-content" style="max-width: 620px; width: 92vw;">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                    <h3 style="margin:0;">Add Project Link</h3>
                    <button class="btn-secondary" id="btn-proj-link-close" type="button">Close</button>
                </div>
                <div class="form-row" style="margin-top:12px;">
                    <label>Title</label>
                    <input id="proj-link-title" class="modal-input" type="text" placeholder="e.g. Customer portal, SharePoint, Drawing folder">
                </div>
                <div class="form-row">
                    <label>URL</label>
                    <input id="proj-link-url" class="modal-input" type="url" placeholder="https://...">
                </div>
                <div class="modal-actions">
                    <button class="btn-secondary" id="btn-proj-link-cancel" type="button">Cancel</button>
                    <button class="btn-primary" id="btn-proj-link-add" type="button">Add</button>
                </div>
            </div>
        `;
                document.body.appendChild(overlay);
            }

            const close = () => { overlay.classList.add('hidden'); overlay.setAttribute('aria-hidden', 'true'); };
            overlay.classList.remove('hidden');
            overlay.setAttribute('aria-hidden', 'false');

            const t = document.getElementById('proj-link-title');
            const u = document.getElementById('proj-link-url');
            if (t) t.value = '';
            if (u) u.value = '';

            const btnClose = document.getElementById('btn-proj-link-close');
            const btnCancel = document.getElementById('btn-proj-link-cancel');
            const btnAdd = document.getElementById('btn-proj-link-add');

            if (btnClose) btnClose.onclick = close;
            if (btnCancel) btnCancel.onclick = close;
            overlay.onclick = (e) => { if (e.target === overlay) close(); };

            if (btnAdd) btnAdd.onclick = () => {
                const title = t ? String(t.value || '').trim() : '';
                const url = u ? String(u.value || '').trim() : '';
                if (!url) { if (window.showToast) window.showToast('URL is required', 'warning'); return; }
                try { new URL(url); } catch (e) { if (window.showToast) window.showToast('Invalid URL', 'error'); return; }
                try { if (typeof onAdd === 'function') onAdd({ title, url }); } catch (e) { }
                close();
            };
        }

        let __projdetail_notes_timer = null;

        // ===================================================================================
        // COMPREHENSIVE DATA VALIDATION & REPAIR SYSTEM
        // ===================================================================================
        // This system scans ALL data, finds inconsistencies, validates fields,
        // and shows a detailed report with options to fix issues.
        // ===================================================================================

        window.recalculateAllProjectData = function () {
            console.log('[DataValidator] Starting comprehensive data validation...');

            if (!currentProject || !Array.isArray(currentProject.items)) {
                window.showDataValidationReport({ error: true, message: 'No project selected' });
                return;
            }

            const items = currentProject.items;
            const total = items.length;
            const CURRENCY_RATES = window.RFQData?.CURRENCY_RATES || { EUR: 1, USD: 0.92, CZK: 0.041, GBP: 1.17 };

            // Show progress modal
            const progressModal = document.createElement('div');
            progressModal.id = 'data-validator-progress';
            progressModal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:999999;';
            progressModal.innerHTML = `
        <div style="background:white;border-radius:16px;padding:32px 48px;min-width:450px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
            <div style="font-size:20px;font-weight:600;margin-bottom:8px;">Data Validation</div>
            <div style="font-size:13px;color:#666;margin-bottom:20px;">Scanning all data for issues...</div>
            <div style="font-size:14px;color:#333;margin-bottom:12px;">
                <span id="validator-current">0</span> / <span id="validator-total">${total}</span> items
            </div>
            <div style="background:#e5e7eb;border-radius:8px;height:8px;overflow:hidden;margin-bottom:16px;">
                <div id="validator-progress" style="background:linear-gradient(90deg,#667eea,#764ba2);height:100%;width:0%;transition:width 0.15s;"></div>
            </div>
            <div id="validator-status" style="font-size:12px;color:#888;">Initializing...</div>
        </div>
    `;
            document.body.appendChild(progressModal);

            const progressBar = document.getElementById('validator-progress');
            const currentEl = document.getElementById('validator-current');
            const statusEl = document.getElementById('validator-status');

            // Comprehensive validation results
            const report = {
                totalItems: total,
                timestamp: new Date().toISOString(),
                issues: [],           // All found issues
                fixes: [],            // Applied fixes
                warnings: [],         // Non-critical warnings
                statistics: {
                    itemsWithPrices: 0,
                    itemsWithSuppliers: 0,
                    itemsWithStatus: 0,
                    itemsMissingData: 0,
                    statusBreakdown: {},
                    supplierBreakdown: {},
                    currencyBreakdown: {},
                    totalValue: 0,
                    invalidCharacters: 0
                }
            };

            // Helper: Check for invalid/problematic characters
            const checkInvalidChars = (str, fieldName, itemId) => {
                if (!str || typeof str !== 'string') return null;
                // Check for control characters, null bytes, etc.
                const invalidPattern = /[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g;
                const matches = str.match(invalidPattern);
                if (matches) {
                    return {
                        type: 'invalid_chars',
                        severity: 'error',
                        itemId,
                        field: fieldName,
                        message: `Invalid characters found in ${fieldName}`,
                        current: str,
                        suggestion: str.replace(invalidPattern, '')
                    };
                }
                return null;
            };

            // Helper: Derive status from item data
            const deriveStatusFromData = (item) => {
                const suppliers = item.suppliers || [];
                const hasPrice = parseFloat(item.price_1) > 0 || parseFloat(item.price_1_euro) > 0;
                const hasQuotedSupplier = suppliers.some(s =>
                    s.status === 'Quoted' || s.status === 'Done' || s.quote_status === 'Quoted' ||
                    (s.prices && s.prices.length > 0 && s.prices.some(p => parseFloat(p.price) > 0)) ||
                    parseFloat(s.price_1) > 0 || parseFloat(s.price) > 0
                );
                const hasRfqSentSupplier = suppliers.some(s => s.status === 'RFQ Sent');
                const hasPlannedSupplier = suppliers.some(s => s.status === 'Planned');
                const allDone = suppliers.length > 0 && suppliers.every(s => s.status === 'Done');

                if (allDone) return 'Done';
                if (hasQuotedSupplier || hasPrice) return 'Quote Received';
                if (hasRfqSentSupplier) return 'RFQ Sent';
                if (hasPlannedSupplier) return 'TO-QUOTE';
                if (suppliers.length > 0) return 'TO-QUOTE';
                return 'New';
            };

            // Process items in batches
            const batchSize = 20;
            let currentIndex = 0;

            function processBatch() {
                const endIndex = Math.min(currentIndex + batchSize, total);

                for (let i = currentIndex; i < endIndex; i++) {
                    const item = items[i];
                    const itemId = item.item_drawing_no || item.drawing_no || item.part_no || `Item ${i + 1}`;

                    try {
                        // 1. STRUCTURE VALIDATION - Ensure arrays exist
                        if (!Array.isArray(item.suppliers)) {
                            item.suppliers = [];
                            report.fixes.push({ itemId, field: 'suppliers', action: 'initialized_array' });
                        }

                        // 2. CHECK FOR INVALID CHARACTERS in key fields
                        ['item_drawing_no', 'description', 'manufacturer', 'mpn', 'supplier'].forEach(field => {
                            const issue = checkInvalidChars(item[field], field, itemId);
                            if (issue) report.issues.push(issue);
                        });

                        // 3. PRICE SYNCHRONIZATION from suppliers
                        const mainSupplier = item.suppliers.find(s => s.isMain) || item.suppliers[0];
                        if (mainSupplier) {
                            // Sync supplier name
                            const supName = mainSupplier.supplier_name || mainSupplier.name || mainSupplier.supplier || '';
                            if (supName && !item.supplier) {
                                report.issues.push({
                                    type: 'missing_supplier_name',
                                    severity: 'warning',
                                    itemId,
                                    field: 'supplier',
                                    message: 'Item has suppliers but no main supplier name set',
                                    current: item.supplier || '(empty)',
                                    suggestion: supName,
                                    autoFix: true
                                });
                                item.supplier = supName;
                                report.fixes.push({ itemId, field: 'supplier', action: 'synced_from_suppliers', value: supName });
                            }

                            // Sync price from supplier prices array or price_1
                            let supplierPrice = 0;
                            if (mainSupplier.prices && mainSupplier.prices.length > 0) {
                                supplierPrice = parseFloat(mainSupplier.prices[0].price) || 0;
                            }
                            if (!supplierPrice) {
                                supplierPrice = parseFloat(mainSupplier.price_1 || mainSupplier.price) || 0;
                            }

                            if (supplierPrice > 0 && !parseFloat(item.price_1)) {
                                report.issues.push({
                                    type: 'missing_item_price',
                                    severity: 'warning',
                                    itemId,
                                    field: 'price_1',
                                    message: 'Supplier has price but item price_1 is empty',
                                    current: item.price_1 || '(empty)',
                                    suggestion: supplierPrice,
                                    autoFix: true
                                });
                                item.price_1 = supplierPrice;
                                report.fixes.push({ itemId, field: 'price_1', action: 'synced_from_supplier', value: supplierPrice });
                            }

                            // Sync currency
                            if (mainSupplier.currency && !item.currency) {
                                item.currency = mainSupplier.currency;
                                report.fixes.push({ itemId, field: 'currency', action: 'synced_from_supplier', value: mainSupplier.currency });
                            }
                        }

                        // 4. EUR VALUE CALCULATION
                        const price1 = parseFloat(item.price_1) || 0;
                        const currency = item.currency || 'EUR';
                        const rate = CURRENCY_RATES[currency] || 1;
                        const calculatedEur = price1 * rate;
                        const currentEur = parseFloat(item.price_1_euro) || 0;

                        if (price1 > 0 && Math.abs(calculatedEur - currentEur) > 0.01) {
                            report.issues.push({
                                type: 'eur_mismatch',
                                severity: 'info',
                                itemId,
                                field: 'price_1_euro',
                                message: 'EUR value recalculated',
                                current: currentEur || '(empty)',
                                suggestion: calculatedEur.toFixed(2),
                                autoFix: true
                            });
                            item.price_1_euro = calculatedEur.toFixed(2);
                            report.fixes.push({ itemId, field: 'price_1_euro', action: 'recalculated', value: calculatedEur.toFixed(2) });
                        }

                        // Also calculate price_2_euro, price_3_euro, etc.
                        [2, 3, 4, 5].forEach(tier => {
                            const p = parseFloat(item['price_' + tier]) || 0;
                            if (p > 0) {
                                const eurVal = (p * rate).toFixed(2);
                                if (item['price_' + tier + '_euro'] !== eurVal) {
                                    item['price_' + tier + '_euro'] = eurVal;
                                }
                            }
                        });

                        // 5. STATUS VALIDATION - Check if status matches data
                        const currentStatus = item.status || 'New';
                        const derivedStatus = deriveStatusFromData(item);
                        const statusPriority = { 'New': 0, 'TO-QUOTE': 1, 'RFQ Sent': 2, 'Quote Received': 3, 'Done': 4 };

                        // Only suggest status upgrade if derived is higher priority
                        if ((statusPriority[derivedStatus] || 0) > (statusPriority[currentStatus] || 0)) {
                            report.issues.push({
                                type: 'status_mismatch',
                                severity: 'warning',
                                itemId,
                                field: 'status',
                                message: `Status "${currentStatus}" may be outdated based on supplier data`,
                                current: currentStatus,
                                suggestion: derivedStatus,
                                autoFix: false // Don't auto-fix status - let user decide
                            });
                        }

                        // 6. COLLECT STATISTICS
                        if (price1 > 0) report.statistics.itemsWithPrices++;
                        if (item.suppliers.length > 0) report.statistics.itemsWithSuppliers++;
                        if (currentStatus && currentStatus !== 'New') report.statistics.itemsWithStatus++;
                        if (!price1 && item.suppliers.length === 0) report.statistics.itemsMissingData++;

                        report.statistics.statusBreakdown[currentStatus] = (report.statistics.statusBreakdown[currentStatus] || 0) + 1;
                        if (item.supplier) {
                            report.statistics.supplierBreakdown[item.supplier] = (report.statistics.supplierBreakdown[item.supplier] || 0) + 1;
                        }
                        report.statistics.currencyBreakdown[currency] = (report.statistics.currencyBreakdown[currency] || 0) + 1;

                        const qty = parseFloat(item.qty_1) || 1;
                        report.statistics.totalValue += (parseFloat(item.price_1_euro) || 0) * qty;

                        // 7. ENSURE ITEM SHAPE (legacy field healing)
                        ensureItemShape(item);

                    } catch (e) {
                        console.error('[DataValidator] Error processing item', i, e);
                        report.issues.push({
                            type: 'processing_error',
                            severity: 'error',
                            itemId,
                            message: `Error processing item: ${e.message}`,
                            current: 'N/A',
                            suggestion: 'Check item data manually'
                        });
                    }
                }

                // Update progress
                currentIndex = endIndex;
                const percent = Math.round((currentIndex / total) * 100);
                progressBar.style.width = percent + '%';
                currentEl.textContent = currentIndex;
                statusEl.textContent = `Validating item ${currentIndex} of ${total}...`;

                if (currentIndex < total) {
                    setTimeout(processBatch, 0);
                } else {
                    finishValidation();
                }
            }

            function finishValidation() {
                statusEl.textContent = 'Generating report...';

                // Update project timestamp
                currentProject.last_recalc = report.timestamp;

                // Save changes
                try {
                    updateProject(currentProject);
                } catch (e) {
                    console.error('[DataValidator] Error saving:', e);
                    report.warnings.push('Failed to save changes to server (changes kept locally)');
                }

                // Refresh all views
                try { renderCompactTable(); } catch (e) { }
                try { updateStats(); } catch (e) { }
                try { updateSupplierFilter(); } catch (e) { }
                try { renderDashboard(); } catch (e) { }
                try { renderMainOverview(); } catch (e) { }
                try { renderSidebar(); } catch (e) { }
                try { if (typeof renderItemComparison === 'function') renderItemComparison(); } catch (e) { }
                try { if (typeof renderRFQPlanner === 'function') renderRFQPlanner(); } catch (e) { }

                // Remove progress modal
                progressModal.remove();

                // Show detailed report
                window.showDataValidationReport(report);
            }

            // Start processing
            setTimeout(processBatch, 50);
        };

        // ===================================================================================
        // DATA VALIDATION REPORT MODAL
        // ===================================================================================
        window.showDataValidationReport = function (report) {
            console.log('[DataValidator] Showing report:', report);

            // Remove existing modal
            const existing = document.getElementById('data-validation-report');
            if (existing) existing.remove();

            if (report.error) {
                showToast(report.message || 'Error during validation', 'error');
                return;
            }

            const errorCount = report.issues.filter(i => i.severity === 'error').length;
            const warningCount = report.issues.filter(i => i.severity === 'warning').length;
            const infoCount = report.issues.filter(i => i.severity === 'info').length;
            const fixCount = report.fixes.length;

            // Build status breakdown HTML
            const statusHtml = Object.entries(report.statistics.statusBreakdown)
                .sort((a, b) => b[1] - a[1])
                .map(([status, count]) => `<div style="display:flex;justify-content:space-between;padding:4px 0;"><span>${status}</span><strong>${count}</strong></div>`)
                .join('');

            // Build issues list HTML
            const issuesHtml = report.issues.length === 0
                ? '<div style="padding:20px;text-align:center;color:#888;">No issues found!</div>'
                : report.issues.slice(0, 50).map(issue => `
            <div style="padding:10px 12px;border-bottom:1px solid #f0f0f0;font-size:13px;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                    <span style="padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600;background:${issue.severity === 'error' ? '#fee2e2;color:#dc2626' :
                        issue.severity === 'warning' ? '#fef3c7;color:#d97706' :
                            '#dbeafe;color:#2563eb'
                    };">${issue.severity.toUpperCase()}</span>
                    <span style="font-weight:600;color:#374151;">${issue.itemId}</span>
                    <span style="color:#6b7280;">‚Üí ${issue.field}</span>
                </div>
                <div style="color:#4b5563;margin-bottom:4px;">${issue.message}</div>
                <div style="font-size:12px;color:#888;">
                    Current: <code style="background:#f3f4f6;padding:1px 4px;border-radius:3px;">${issue.current}</code>
                    ${issue.suggestion ? ` ‚Üí Suggested: <code style="background:#d1fae5;padding:1px 4px;border-radius:3px;">${issue.suggestion}</code>` : ''}
                    ${issue.autoFix ? ' <span style="color:#10b981;">(auto-fixed)</span>' : ''}
                </div>
            </div>
        `).join('') + (report.issues.length > 50 ? `<div style="padding:12px;text-align:center;color:#888;">... and ${report.issues.length - 50} more issues</div>` : '');

            // Create modal
            const modal = document.createElement('div');
            modal.id = 'data-validation-report';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:999999;';
            modal.innerHTML = `
        <div style="background:white;border-radius:16px;width:95%;max-width:900px;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 25px 80px rgba(0,0,0,0.4);">
            <!-- Header -->
            <div style="padding:20px 24px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <h2 style="margin:0;font-size:20px;font-weight:600;">Data Validation Report</h2>
                    <div style="font-size:13px;color:#888;margin-top:4px;">${report.totalItems} items scanned ‚Ä¢ ${new Date(report.timestamp).toLocaleString('cs-CZ')}</div>
                </div>
                <button id="report-close" style="background:none;border:none;font-size:28px;cursor:pointer;color:#888;padding:0 8px;">&times;</button>
            </div>

            <!-- Stats Cards -->
            <div style="padding:16px 24px;background:#f9fafb;border-bottom:1px solid #e5e7eb;">
                <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:12px;">
                    <div style="background:white;padding:16px;border-radius:10px;text-align:center;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                        <div style="font-size:28px;font-weight:700;color:#10b981;">${fixCount}</div>
                        <div style="font-size:11px;color:#666;">Auto-Fixed</div>
                    </div>
                    <div style="background:white;padding:16px;border-radius:10px;text-align:center;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                        <div style="font-size:28px;font-weight:700;color:${errorCount > 0 ? '#dc2626' : '#10b981'};">${errorCount}</div>
                        <div style="font-size:11px;color:#666;">Errors</div>
                    </div>
                    <div style="background:white;padding:16px;border-radius:10px;text-align:center;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                        <div style="font-size:28px;font-weight:700;color:${warningCount > 0 ? '#d97706' : '#10b981'};">${warningCount}</div>
                        <div style="font-size:11px;color:#666;">Warnings</div>
                    </div>
                    <div style="background:white;padding:16px;border-radius:10px;text-align:center;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                        <div style="font-size:28px;font-weight:700;color:#2563eb;">${report.statistics.itemsWithPrices}</div>
                        <div style="font-size:11px;color:#666;">With Prices</div>
                    </div>
                    <div style="background:white;padding:16px;border-radius:10px;text-align:center;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                        <div style="font-size:28px;font-weight:700;color:#8b5cf6;">‚Ç¨${Math.round(report.statistics.totalValue).toLocaleString()}</div>
                        <div style="font-size:11px;color:#666;">Total Value</div>
                    </div>
                </div>
            </div>

            <!-- Content -->
            <div style="flex:1;overflow:hidden;display:flex;">
                <!-- Left: Status Breakdown -->
                <div style="width:220px;border-right:1px solid #e5e7eb;padding:16px;overflow-y:auto;">
                    <div style="font-size:12px;font-weight:600;color:#888;margin-bottom:12px;text-transform:uppercase;">Status Breakdown</div>
                    ${statusHtml}
                    <div style="margin-top:16px;padding-top:16px;border-top:1px solid #e5e7eb;">
                        <div style="font-size:12px;font-weight:600;color:#888;margin-bottom:8px;text-transform:uppercase;">Data Quality</div>
                        <div style="display:flex;justify-content:space-between;padding:4px 0;"><span>With Suppliers</span><strong>${report.statistics.itemsWithSuppliers}</strong></div>
                        <div style="display:flex;justify-content:space-between;padding:4px 0;"><span>Missing Data</span><strong style="color:${report.statistics.itemsMissingData > 0 ? '#dc2626' : '#10b981'};">${report.statistics.itemsMissingData}</strong></div>
                    </div>
                </div>

                <!-- Right: Issues List -->
                <div style="flex:1;overflow-y:auto;">
                    <div style="font-size:12px;font-weight:600;color:#888;padding:12px 16px;background:#f9fafb;border-bottom:1px solid #e5e7eb;text-transform:uppercase;position:sticky;top:0;">
                        Issues & Changes (${report.issues.length})
                    </div>
                    ${issuesHtml}
                </div>
            </div>

            <!-- Footer -->
            <div style="padding:16px 24px;border-top:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                <div style="font-size:12px;color:#888;">
                    ${fixCount > 0 ? `${fixCount} issues were automatically fixed and saved.` : 'No automatic fixes were needed.'}
                </div>
                <div style="display:flex;gap:10px;">
                    <button id="report-export" style="background:#10b981;color:white;border:none;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;">üìä Export to Excel</button>
                    <button id="report-ok" style="background:#667eea;color:white;border:none;padding:10px 32px;border-radius:8px;font-weight:600;cursor:pointer;">OK</button>
                </div>
            </div>
        </div>
    `;

            document.body.appendChild(modal);

            // Event handlers
            const closeModal = () => modal.remove();
            modal.querySelector('#report-close').onclick = closeModal;
            modal.querySelector('#report-ok').onclick = closeModal;
            modal.onclick = (e) => { if (e.target === modal) closeModal(); };

            // Export to Excel handler
            modal.querySelector('#report-export').onclick = () => {
                exportValidationReportToExcel(report);
            };
        };

        // Export Data Validation Report to Excel
        function exportValidationReportToExcel(report) {
            const rows = [];

            // Header
            rows.push(['Data Validation Report']);
            rows.push(['Generated:', new Date(report.timestamp).toLocaleString('cs-CZ')]);
            rows.push(['Total Items:', report.totalItems]);
            rows.push([]);

            // Statistics
            rows.push(['=== STATISTICS ===']);
            rows.push(['Items with Prices:', report.statistics.itemsWithPrices]);
            rows.push(['Items with Suppliers:', report.statistics.itemsWithSuppliers]);
            rows.push(['Items Missing Data:', report.statistics.itemsMissingData]);
            rows.push(['Total Value (EUR):', report.statistics.totalValue.toFixed(2)]);
            rows.push([]);

            // Status Breakdown
            rows.push(['=== STATUS BREAKDOWN ===']);
            Object.entries(report.statistics.statusBreakdown || {}).forEach(([status, count]) => {
                rows.push([status, count]);
            });
            rows.push([]);

            // Issues
            rows.push(['=== ISSUES & CHANGES ===']);
            rows.push(['Severity', 'Item ID', 'Field', 'Message', 'Current Value', 'Suggested Value', 'Auto-Fixed']);
            report.issues.forEach(issue => {
                rows.push([
                    issue.severity || '',
                    issue.itemId || '',
                    issue.field || '',
                    issue.message || '',
                    String(issue.current || ''),
                    String(issue.suggestion || ''),
                    issue.autoFix ? 'Yes' : 'No'
                ]);
            });
            rows.push([]);

            // Fixes Applied
            rows.push(['=== FIXES APPLIED ===']);
            rows.push(['Item ID', 'Field', 'Action', 'Value']);
            report.fixes.forEach(fix => {
                rows.push([
                    fix.itemId || '',
                    fix.field || '',
                    fix.action || '',
                    String(fix.value || '')
                ]);
            });

            // Convert to CSV
            const csvContent = rows.map(row =>
                row.map(cell => {
                    const str = String(cell || '');
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return '"' + str.replace(/"/g, '""') + '"';
                    }
                    return str;
                }).join(',')
            ).join('\n');

            // Add BOM for Excel UTF-8 compatibility
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `validation_report_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ===================================================================================
        // UNIVERSAL SUCCESS/INFO MODAL
        // ===================================================================================
        // Replaces ugly alert() boxes with nice styled modals
        // Usage: showSuccessModal({ title, message, details, exportData, exportFilename })
        // ===================================================================================
        window.showSuccessModal = function (options = {}) {
            const {
                title = 'Success',
                message = '',
                details = [],  // Array of {label, value} or strings
                icon = '‚úì',
                iconColor = '#10b981',
                exportData = null,  // If provided, shows export button
                exportFilename = 'export.csv',
                autoClose = 0  // Auto close after ms, 0 = no auto close
            } = options;

            // Remove existing modal
            const existing = document.getElementById('success-modal-universal');
            if (existing) existing.remove();

            // Build details HTML
            let detailsHtml = '';
            if (details.length > 0) {
                detailsHtml = `
            <div style="background:#f9fafb;border-radius:8px;padding:12px;margin-top:16px;max-height:200px;overflow-y:auto;">
                ${details.map(d => {
                    if (typeof d === 'string') {
                        return `<div style="padding:4px 0;font-size:13px;color:#374151;">${d}</div>`;
                    }
                    return `<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:13px;">
                        <span style="color:#6b7280;">${d.label}</span>
                        <span style="font-weight:600;color:#374151;">${d.value}</span>
                    </div>`;
                }).join('')}
            </div>
        `;
            }

            const modal = document.createElement('div');
            modal.id = 'success-modal-universal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:999999;';
            modal.innerHTML = `
        <div style="background:white;border-radius:16px;width:90%;max-width:420px;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:hidden;">
            <div style="padding:24px;text-align:center;">
                <div style="width:60px;height:60px;border-radius:50%;background:${iconColor}15;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;">
                    <span style="font-size:28px;color:${iconColor};">${icon}</span>
                </div>
                <h3 style="margin:0 0 8px;font-size:18px;font-weight:600;color:#1f2937;">${title}</h3>
                ${message ? `<p style="margin:0;font-size:14px;color:#6b7280;">${message}</p>` : ''}
                ${detailsHtml}
            </div>
            <div style="padding:16px 24px;background:#f9fafb;display:flex;justify-content:center;gap:10px;">
                ${exportData ? `<button id="success-modal-export" style="background:#10b981;color:white;border:none;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;">üìä Export</button>` : ''}
                <button id="success-modal-ok" style="background:#667eea;color:white;border:none;padding:10px 32px;border-radius:8px;font-weight:600;cursor:pointer;">OK</button>
            </div>
        </div>
    `;

            document.body.appendChild(modal);

            // Event handlers
            const closeModal = () => modal.remove();
            modal.querySelector('#success-modal-ok').onclick = closeModal;
            modal.onclick = (e) => { if (e.target === modal) closeModal(); };

            if (exportData) {
                modal.querySelector('#success-modal-export').onclick = () => {
                    exportArrayToCSV(exportData, exportFilename);
                };
            }

            if (autoClose > 0) {
                setTimeout(closeModal, autoClose);
            }

            return modal;
        };

        // Helper: Export array data to CSV
        function exportArrayToCSV(data, filename) {
            if (!Array.isArray(data) || data.length === 0) return;

            const rows = data.map(row =>
                (Array.isArray(row) ? row : Object.values(row)).map(cell => {
                    const str = String(cell || '');
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return '"' + str.replace(/"/g, '""') + '"';
                    }
                    return str;
                }).join(',')
            );

            const BOM = '\uFEFF';
            const blob = new Blob([BOM + rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function renderProjectDetail() {
            if (!currentProject) {
                const titleEl = getEl('projdetail-title');
                if (titleEl) titleEl.textContent = '‚Äî';
                return;
            }

            ensureProjectDetailFields(currentProject);

            // Get all elements
            const titleEl = getEl('projdetail-title');
            const idEl = getEl('projdetail-id');
            const selStatus = getEl('projdetail-status');
            const coverImg = getEl('projdetail-cover-img');
            const coverEmpty = getEl('projdetail-cover-empty');

            // Header info
            if (titleEl) titleEl.textContent = currentProject.name || 'Untitled';
            if (idEl) idEl.textContent = `ID: ${String(currentProject.id || '').slice(0, 8)}...`;

            // =========================================================
            // CALCULATE ALL STATISTICS
            // =========================================================
            const items = Array.isArray(currentProject.items) ? currentProject.items : [];
            const rates = window.RFQData && window.RFQData.CURRENCY_RATES ? window.RFQData.CURRENCY_RATES : { EUR: 1, USD: 0.92, CZK: 0.041, GBP: 1.17 };

            // Collect suppliers and calculate values
            const supplierStats = {};
            const statusCounts = {};
            let totalValue = 0;
            let targetValue = 0;
            let quotedItems = 0;
            let pendingItems = 0;

            items.forEach(it => {
                // Status breakdown
                const st = getItemStatusDisplay(it);
                statusCounts[st] = (statusCounts[st] || 0) + 1;

                // Check if quoted
                const hasQuote = (it.suppliers || []).some(s => {
                    return (s.prices && s.prices.some(p => parseFloat(p.price) > 0)) || parseFloat(s.price_1 || s.price) > 0;
                });
                if (hasQuote) quotedItems++;
                else pendingItems++;

                // Calculate item value
                const qty1 = parseFloat(it.qty_1) || 0;
                const mainSup = (it.suppliers || []).find(s => s.isMain);

                let priceEur = 0;
                if (mainSup) {
                    const supCurrency = mainSup.currency || 'EUR';
                    const supRate = rates[supCurrency] || 1;
                    let mainPrice = 0;
                    if (mainSup.prices && mainSup.prices[0]) mainPrice = parseFloat(mainSup.prices[0].price) || 0;
                    if (!mainPrice) mainPrice = parseFloat(mainSup.price_1 || mainSup.price) || 0;
                    priceEur = mainPrice * supRate;
                } else {
                    priceEur = parseFloat(it.price_1_euro) || 0;
                    if (!priceEur) {
                        const price1 = parseFloat(it.price_1) || 0;
                        const currency = it.currency || 'EUR';
                        const rate = rates[currency] || 1;
                        priceEur = price1 * rate;
                    }
                }
                totalValue += priceEur * qty1;

                // Target value
                const targetPrice = parseFloat(it.target_price) || 0;
                const targetCurrency = it.target_currency || 'EUR';
                const targetRate = rates[targetCurrency] || 1;
                targetValue += (targetPrice * targetRate) * qty1;

                // Collect supplier stats
                (it.suppliers || []).forEach(s => {
                    const supName = s.supplier_name || s.name || s.supplier || '';
                    if (!supName) return;
                    if (!supplierStats[supName]) {
                        supplierStats[supName] = {
                            name: supName,
                            itemsCount: 0,
                            mainCount: 0,
                            totalValue: 0,
                            avgLeadTime: 0,
                            leadTimes: [],
                            currency: s.currency || 'EUR',
                            isAlt: false
                        };
                    }
                    supplierStats[supName].itemsCount++;
                    if (s.isMain) {
                        supplierStats[supName].mainCount++;
                        const supCurrency = s.currency || 'EUR';
                        const supRate = rates[supCurrency] || 1;
                        let supPrice = 0;
                        if (s.prices && s.prices[0]) supPrice = parseFloat(s.prices[0].price) || 0;
                        if (!supPrice) supPrice = parseFloat(s.price_1 || s.price) || 0;
                        supplierStats[supName].totalValue += (supPrice * supRate) * qty1;
                    } else {
                        supplierStats[supName].isAlt = true;
                    }
                    const lt = parseInt(s.lead_time) || parseInt(s.lead_time_days) || 0;
                    if (lt > 0) supplierStats[supName].leadTimes.push(lt);
                });
            });

            // Calculate averages for suppliers
            Object.values(supplierStats).forEach(s => {
                if (s.leadTimes.length > 0) {
                    s.avgLeadTime = Math.round(s.leadTimes.reduce((a, b) => a + b, 0) / s.leadTimes.length);
                }
            });

            const supplierCount = Object.keys(supplierStats).length;
            const savings = targetValue > 0 ? targetValue - totalValue : 0;

            // =========================================================
            // UPDATE SIDEBAR KPIs
            // =========================================================
            const elKpiItems = getEl('projdetail-kpi-items');
            const elKpiSuppliers = getEl('projdetail-kpi-suppliers');
            const elKpiQuoted = getEl('projdetail-kpi-quoted');
            const elKpiPending = getEl('projdetail-kpi-pending');
            const elKpiValue = getEl('projdetail-kpi-value');
            const elKpiTarget = getEl('projdetail-kpi-target');
            const elKpiSavings = getEl('projdetail-kpi-savings');

            if (elKpiItems) elKpiItems.textContent = items.length;
            if (elKpiSuppliers) elKpiSuppliers.textContent = supplierCount;
            if (elKpiQuoted) elKpiQuoted.textContent = quotedItems;
            if (elKpiPending) elKpiPending.textContent = pendingItems;
            if (elKpiValue) elKpiValue.textContent = '‚Ç¨' + formatNumber(totalValue, 0);
            if (elKpiTarget) elKpiTarget.textContent = targetValue > 0 ? '‚Ç¨' + formatNumber(targetValue, 0) : '‚Äî';
            if (elKpiSavings) {
                if (savings > 0) {
                    elKpiSavings.innerHTML = `<span style="color:#28a745;">+‚Ç¨${formatNumber(savings, 0)}</span>`;
                } else if (savings < 0) {
                    elKpiSavings.innerHTML = `<span style="color:#dc3545;">-‚Ç¨${formatNumber(Math.abs(savings), 0)}</span>`;
                } else {
                    elKpiSavings.textContent = '‚Äî';
                }
            }

            // =========================================================
            // TIMELINE / DATES
            // =========================================================
            const d = currentProject.dates || {};
            const createdEl = getEl('projdetail-created');
            const receivedEl = getEl('projdetail-received');
            const bomEl = getEl('projdetail-bom');
            const sentEl = getEl('projdetail-sent');
            const sentToEl = getEl('projdetail-sentto');
            const deadlineEl = getEl('projdetail-deadline');
            const deadlineRow = getEl('projdetail-deadline-row');

            if (createdEl) {
                const created = currentProject.created_at || currentProject.server_created_at;
                createdEl.textContent = created ? new Date(created).toLocaleDateString() : '‚Äî';
            }
            if (receivedEl) receivedEl.textContent = d.received || '‚Äî';
            if (bomEl) bomEl.textContent = d.bom_received || d.bom || '‚Äî';
            if (sentEl) sentEl.textContent = d.sent || '‚Äî';
            if (sentToEl) sentToEl.textContent = d.sent_to || d.sentTo || '‚Äî';

            if (deadlineEl) {
                const dl = d.deadline || '';
                if (dl) {
                    const dlDate = new Date(dl);
                    const today = new Date();
                    const daysLeft = Math.ceil((dlDate - today) / (1000 * 60 * 60 * 24));
                    let color = '#333';
                    let bgColor = '#fff3cd';
                    if (daysLeft < 0) { color = '#dc3545'; bgColor = '#f8d7da'; }
                    else if (daysLeft <= 7) { color = '#fd7e14'; bgColor = '#fff3cd'; }
                    else if (daysLeft <= 14) { color = '#ffc107'; bgColor = '#fff8e1'; }
                    else { color = '#28a745'; bgColor = '#d4edda'; }

                    deadlineEl.innerHTML = `<span style="color:${color}; font-weight:700;">${dl}</span>`;
                    if (daysLeft >= 0) deadlineEl.innerHTML += ` <span style="font-size:10px;">(${daysLeft}d)</span>`;
                    else deadlineEl.innerHTML += ` <span style="font-size:10px;">(overdue!)</span>`;
                    if (deadlineRow) deadlineRow.style.background = bgColor;
                } else {
                    deadlineEl.textContent = '‚Äî';
                    if (deadlineRow) deadlineRow.style.background = '#f5f5f5';
                }
            }

            // =========================================================
            // STATUS BREAKDOWN
            // =========================================================
            const statusBreakdownEl = getEl('projdetail-status-breakdown');
            if (statusBreakdownEl) {
                const statusHtml = Object.entries(statusCounts)
                    .sort((a, b) => b[1] - a[1])
                    .map(([status, count]) => {
                        const color = getStatusColorUnified(status, 'item');
                        const pct = items.length > 0 ? Math.round((count / items.length) * 100) : 0;
                        return `
                    <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                        <div style="width:10px; height:10px; border-radius:50%; background:${color};"></div>
                        <div style="flex:1;">${escapeHtml(status)}</div>
                        <div style="font-weight:600;">${count}</div>
                        <div style="color:#999; font-size:10px;">(${pct}%)</div>
                    </div>
                `;
                    }).join('');
                statusBreakdownEl.innerHTML = statusHtml || '<div class="muted">No items</div>';
            }

            // =========================================================
            // STATUS SELECT
            // =========================================================
            if (selStatus) {
                selStatus.disabled = false;
                fillProjectStatusSelect(selStatus, getCurrentProjectStatus());
                if (!selStatus.dataset.bound) {
                    selStatus.dataset.bound = '1';
                    selStatus.onchange = () => setCurrentProjectStatus(selStatus.value);
                }
            }

            // =========================================================
            // TAB SWITCHING
            // =========================================================
            const projDetailRoot = getEl('view-project-detail');

            // Fix scroll: dynamically compute available height for .sd-panels
            function fixProjDetailPanelScroll() {
                if (!projDetailRoot) return;
                const panels = projDetailRoot.querySelector('.sd-panels');
                if (!panels) return;
                const rect = panels.getBoundingClientRect();
                const availH = window.innerHeight - rect.top - 20;
                if (availH > 100) {
                    panels.style.maxHeight = availH + 'px';
                    panels.style.overflowY = 'auto';
                }
            }

            if (projDetailRoot && !projDetailRoot.dataset.tabsBound) {
                projDetailRoot.dataset.tabsBound = '1';
                projDetailRoot.querySelectorAll('.sd-tab').forEach(tab => {
                    tab.onclick = () => {
                        projDetailRoot.querySelectorAll('.sd-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        projDetailRoot.querySelectorAll('.sd-panel').forEach(p => p.classList.remove('active'));
                        const panel = projDetailRoot.querySelector(`.sd-panel[data-panel="${tab.dataset.tab}"]`);
                        if (panel) panel.classList.add('active');
                        // Render tab content on switch
                        renderProjectDetailTabContent(tab.dataset.tab, items, supplierStats, statusCounts, rates, totalValue, targetValue);
                        // Fix scroll after tab switch
                        requestAnimationFrame(fixProjDetailPanelScroll);
                    };
                });
            }

            // Fix scroll on initial render
            requestAnimationFrame(fixProjDetailPanelScroll);
            // Fix scroll on window resize
            window.__projDetailResizeHandler && window.removeEventListener('resize', window.__projDetailResizeHandler);
            window.__projDetailResizeHandler = fixProjDetailPanelScroll;
            window.addEventListener('resize', fixProjDetailPanelScroll);

            // =========================================================
            // BUTTON HANDLERS
            // =========================================================
            const btnBack = getEl('btn-projdetail-back');
            const btnEdit = getEl('btn-projdetail-edit');
            const btnMarkWon = getEl('btn-projdetail-mark-won');
            const btnMarkDone = getEl('btn-projdetail-mark-done');
            const btnGotoItems = getEl('btn-projdetail-goto-items');
            const btnGotoQuoting = getEl('btn-projdetail-goto-quoting');
            const btnUploadCover = getEl('btn-projdetail-upload-cover');
            const coverInput = getEl('projdetail-cover-file');

            if (btnBack && !btnBack.dataset.bound) {
                btnBack.dataset.bound = '1';
                btnBack.onclick = () => switchView('dashboard');
            }
            if (btnEdit && !btnEdit.dataset.bound) {
                btnEdit.dataset.bound = '1';
                btnEdit.onclick = () => openEditProjectModal();
            }
            if (btnMarkWon && !btnMarkWon.dataset.bound) {
                btnMarkWon.dataset.bound = '1';
                btnMarkWon.onclick = () => {
                    setCurrentProjectStatus('Done');
                    renderProjectDetail();
                };
            }
            if (btnMarkDone && !btnMarkDone.dataset.bound) {
                btnMarkDone.dataset.bound = '1';
                btnMarkDone.onclick = () => {
                    setCurrentProjectStatus('Done');
                    renderProjectDetail();
                };
            }
            if (btnGotoItems && !btnGotoItems.dataset.bound) {
                btnGotoItems.dataset.bound = '1';
                btnGotoItems.onclick = () => switchView('items');
            }
            if (btnGotoQuoting && !btnGotoQuoting.dataset.bound) {
                btnGotoQuoting.dataset.bound = '1';
                btnGotoQuoting.onclick = () => switchView('quoting');
            }
            if (btnUploadCover && coverInput && !btnUploadCover.dataset.bound) {
                btnUploadCover.dataset.bound = '1';
                btnUploadCover.onclick = () => coverInput.click();
            }
            if (coverInput && !coverInput.dataset.bound) {
                coverInput.dataset.bound = '1';
                coverInput.addEventListener('change', async (e) => {
                    const f = e.target.files && e.target.files[0];
                    if (!f) return;
                    try {
                        const att = await uploadProjectAttachment(String(currentProject.id), f, 'cover');
                        if (att && att.id) {
                            currentProject.cover_attachment_id = String(att.id);
                            updateProject(currentProject);
                        }
                        await loadProjectAttachments(String(currentProject.id));
                        renderProjectDetail();
                    } catch (err) {
                        showToast('Upload failed: ' + (err && err.message ? err.message : String(err)), 'error');
                    } finally {
                        e.target.value = '';
                    }
                });
            }

            // =========================================================
            // COVER IMAGE
            // =========================================================
            const pid = String(currentProject.id || '');
            let atts = __PROJ_DETAIL_CACHE__.attachments.get(pid);
            if (!Array.isArray(atts)) {
                atts = [];
                loadProjectAttachments(pid).then(() => { try { renderProjectDetail(); } catch (e) { } });
            }
            const coverId = String(currentProject.cover_attachment_id || '');
            const coverAtt = coverId ? atts.find(a => String(a && a.id) === coverId) : null;
            const coverUrl = coverAtt && coverAtt.url ? String(coverAtt.url) : '';
            if (coverImg && coverEmpty) {
                if (coverUrl) {
                    coverImg.src = coverUrl;
                    coverImg.style.display = 'block';
                    coverEmpty.style.display = 'none';
                } else {
                    coverImg.src = '';
                    coverImg.style.display = 'none';
                    coverEmpty.style.display = 'block';
                }
            }

            // =========================================================
            // RENDER INITIAL TAB CONTENT (Overview)
            // =========================================================
            renderProjectDetailTabContent('overview', items, supplierStats, statusCounts, rates, totalValue, targetValue);

            // =========================================================
            // RENDER FILES & LINKS TAB (always needed for existing functionality)
            // =========================================================
            renderProjectDetailFilesTab(atts);

            // =========================================================
            // RENDER NOTES TAB
            // =========================================================
            renderProjectDetailNotesTab();

            // =========================================================
            // DELEGATED ACTIONS
            // =========================================================
            if (projDetailRoot && !projDetailRoot.dataset.delegated) {
                projDetailRoot.dataset.delegated = '1';
                projDetailRoot.addEventListener('click', async (ev) => {
                    const el = ev.target && ev.target.closest ? ev.target.closest('[data-projdetail-action]') : null;
                    if (!el) return;
                    const action = el.getAttribute('data-projdetail-action');
                    const id = el.getAttribute('data-id');
                    const supName = el.getAttribute('data-supplier');
                    if (!currentProject) return;

                    if (action === 'del-link') {
                        currentProject.project_links = (currentProject.project_links || []).filter(x => String(x && x.id) !== String(id));
                        updateProject(currentProject);
                        renderProjectDetail();
                    }
                    if (action === 'del-comment') {
                        currentProject.project_comments = (currentProject.project_comments || []).filter(x => String(x && x.id) !== String(id));
                        updateProject(currentProject);
                        renderProjectDetail();
                    }
                    if (action === 'del-attachment') {
                        const confirmed = await window.showConfirmDialog({
                            title: 'Delete Attachment',
                            message: 'Delete this attachment?',
                            type: 'danger',
                            okText: 'Delete',
                            cancelText: 'Cancel'
                        });
                        if (!confirmed) return;
                        try {
                            await deleteProjectAttachment(String(currentProject.id), String(id));
                            await loadProjectAttachments(String(currentProject.id));
                            if (String(currentProject.cover_attachment_id || '') === String(id)) {
                                currentProject.cover_attachment_id = '';
                                updateProject(currentProject);
                            }
                            renderProjectDetail();
                        } catch (err) {
                            showToast('Delete failed: ' + (err && err.message ? err.message : String(err)), 'error');
                        }
                    }
                    if (action === 'mark-supplier-won' && supName) {
                        // Mark all items with this supplier as main to "Won"
                        items.forEach(item => {
                            const sup = (item.suppliers || []).find(s => (s.supplier_name || s.name || s.supplier) === supName && s.isMain);
                            if (sup) {
                                sup.status = 'Won';
                                setItemStatus(item, 'Done');
                            }
                        });
                        // Save project
                        if (currentProject) {
                            if (window.RFQData && typeof window.RFQData.updateProject === 'function') {
                                window.RFQData.updateProject(currentProject);
                            } else if (typeof updateProject === 'function') {
                                updateProject(currentProject);
                            }
                        }
                        renderProjectDetail();
                    }

                    // Open item detail
                    if (action === 'open-item') {
                        ev.preventDefault();
                        const drawingNo = el.getAttribute('data-drawing-no');
                        const itemId = el.getAttribute('data-item-id');
                        const itemsArr = currentProject.items || [];
                        let idx = -1;
                        // Find by ID first
                        if (itemId) {
                            idx = itemsArr.findIndex(it => String(it.id) === String(itemId));
                        }
                        // Fallback to drawing number
                        if (idx < 0 && drawingNo) {
                            idx = itemsArr.findIndex(it => String(it.item_drawing_no || it.drawing_no || '').trim() === String(drawingNo).trim());
                        }
                        if (idx >= 0 && typeof openDetailWindow === 'function') {
                            switchView('items');
                            setTimeout(() => {
                                try { openDetailWindow(idx); } catch (e) { console.error(e); }
                            }, 100);
                        }
                    }

                    // Open supplier detail
                    if (action === 'open-supplier' && supName) {
                        ev.preventDefault();
                        if (typeof openGlobalSupplierDetail === 'function') {
                            openGlobalSupplierDetail(supName);
                        }
                    }

                    // Items Stats pagination
                    if (action === 'items-stats-page') {
                        ev.preventDefault();
                        const listType = el.getAttribute('data-list');
                        const newPage = parseInt(el.getAttribute('data-page')) || 0;
                        if (listType === 'noQuotes' || listType === 'noMain') {
                            __itemsStatsPage[listType] = newPage;
                            const container = getEl('projdetail-items-stats-content');
                            if (container && container.__items) {
                                renderProjectDetailItemsStatsTab(container.__items, container.__statusCounts, container.__rates);
                            }
                        }
                    }

                    // Export actions
                    if (action === 'export-items-excel') {
                        ev.preventDefault();
                        try {
                            if (typeof window.exportToExcel === 'function') window.exportToExcel();
                            else showToast('Export function not available', 'error');
                        } catch (e) { showToast('Export failed: ' + e.message, 'error'); }
                    }
                    if (action === 'export-pricing-excel') {
                        ev.preventDefault();
                        try {
                            if (typeof window.exportPricingViewExcel === 'function') window.exportPricingViewExcel();
                            else showToast('Export function not available', 'error');
                        } catch (e) { showToast('Export failed: ' + e.message, 'error'); }
                    }
                    if (action === 'export-project-json') {
                        ev.preventDefault();
                        try {
                            if (!currentProject) { if (window.showToast) window.showToast('No project selected', 'warning'); return; }
                            const data = JSON.stringify(currentProject, null, 2);
                            const blob = new Blob([data], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `project_${(currentProject.name || 'backup').replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().slice(0, 10)}.json`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                        } catch (e) { showToast('Export failed: ' + e.message, 'error'); }
                    }
                    if (action === 'export-full-backup') {
                        ev.preventDefault();
                        try {
                            if (typeof dmExportBackup === 'function') dmExportBackup();
                            else showToast('Backup function not available', 'error');
                        } catch (e) { showToast('Backup failed: ' + e.message, 'error'); }
                    }
                    if (action === 'copy-quick-stats') {
                        ev.preventDefault();
                        const ta = getEl('projdetail-quick-stats');
                        if (ta) {
                            navigator.clipboard.writeText(ta.value).then(() => window.showToast && window.showToast('Copied!', 'success')).catch(() => window.showToast && window.showToast('Failed to copy', 'error'));
                        }
                    }
                    if (action === 'copy-email-summary') {
                        ev.preventDefault();
                        const ta = getEl('projdetail-email-summary');
                        if (ta) {
                            navigator.clipboard.writeText(ta.value).then(() => window.showToast && window.showToast('Copied!', 'success')).catch(() => window.showToast && window.showToast('Failed to copy', 'error'));
                        }
                    }
                });
            }
        }

        // =========================================================
        // PROJECT DETAIL TAB CONTENT RENDERERS
        // =========================================================

        function renderProjectDetailTabContent(tabId, items, supplierStats, statusCounts, rates, totalValue, targetValue) {
            if (tabId === 'overview') renderProjectDetailOverviewTab(items, supplierStats, statusCounts, rates, totalValue, targetValue);
            else if (tabId === 'suppliers') renderProjectDetailSuppliersTab(items, supplierStats, rates);
            else if (tabId === 'items-stats') renderProjectDetailItemsStatsTab(items, statusCounts, rates);
            else if (tabId === 'pricing') renderProjectDetailPricingTab(items, supplierStats, rates, totalValue, targetValue);
            else if (tabId === 'exports') renderProjectDetailExportsTab(items);
        }

        // OVERVIEW TAB
        function renderProjectDetailOverviewTab(items, supplierStats, statusCounts, rates, totalValue, targetValue) {
            const container = getEl('projdetail-overview-content');
            if (!container) return;

            const topSuppliers = Object.values(supplierStats)
                .filter(s => s.mainCount > 0)
                .sort((a, b) => b.totalValue - a.totalValue)
                .slice(0, 5);

            const recentItems = items.slice(-5).reverse();

            container.innerHTML = `
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
            <!-- Value Summary -->
            <div class="sd-card" style="padding:16px;">
                <div class="sd-card-title">Value Summary</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                    <div style="text-align:center; padding:16px; background:#f8f9fa; border-radius:8px;">
                        <div style="font-size:24px; font-weight:800; color:#28a745;">‚Ç¨${formatNumber(totalValue, 0)}</div>
                        <div style="font-size:12px; color:#666; margin-top:4px;">Total Value (EUR)</div>
                    </div>
                    <div style="text-align:center; padding:16px; background:#f8f9fa; border-radius:8px;">
                        <div style="font-size:24px; font-weight:800; color:#667eea;">‚Ç¨${formatNumber(targetValue, 0)}</div>
                        <div style="font-size:12px; color:#666; margin-top:4px;">Target Value (EUR)</div>
                    </div>
                </div>
                ${targetValue > 0 ? `
                <div style="margin-top:16px; padding:12px; background:${totalValue <= targetValue ? '#d4edda' : '#f8d7da'}; border-radius:8px; text-align:center;">
                    <div style="font-size:14px; font-weight:600; color:${totalValue <= targetValue ? '#155724' : '#721c24'};">
                        ${totalValue <= targetValue ? '‚úì Under Target' : '‚ö†Ô∏è Over Target'} by ‚Ç¨${formatNumber(Math.abs(totalValue - targetValue), 0)}
                    </div>
                </div>
                ` : ''}
            </div>

            <!-- Top 5 Main Suppliers -->
            <div class="sd-card" style="padding:16px;">
                <div class="sd-card-title">Top 5 Main Suppliers by Value</div>
                ${topSuppliers.length > 0 ? `
                <table style="width:100%; font-size:12px; border-collapse:collapse;">
                    <thead><tr style="border-bottom:1px solid #e0e0e0;">
                        <th style="text-align:left; padding:8px 4px;">Supplier</th>
                        <th style="text-align:center; padding:8px 4px;">Items</th>
                        <th style="text-align:right; padding:8px 4px;">Value (EUR)</th>
                    </tr></thead>
                    <tbody>
                    ${topSuppliers.map((s, i) => `
                        <tr style="border-bottom:1px solid #f0f0f0;">
                            <td style="padding:8px 4px;"><span style="color:#999; margin-right:6px;">#${i + 1}</span><a href="#" data-projdetail-action="open-supplier" data-supplier="${escapeHtml(s.name)}" style="color:#007AFF; text-decoration:none; font-weight:600;">${escapeHtml(s.name)}</a></td>
                            <td style="text-align:center; padding:8px 4px;">${s.mainCount}</td>
                            <td style="text-align:right; padding:8px 4px; font-weight:600; color:#28a745;">‚Ç¨${formatNumber(s.totalValue, 0)}</td>
                        </tr>
                    `).join('')}
                    </tbody>
                </table>
                ` : '<div class="muted">No main suppliers selected yet</div>'}
            </div>

            <!-- Status Distribution Chart -->
            <div class="sd-card" style="padding:16px;">
                <div class="sd-card-title">Item Status Distribution</div>
                <div style="display:flex; flex-direction:column; gap:8px;">
                ${Object.entries(statusCounts).sort((a, b) => b[1] - a[1]).map(([status, count]) => {
                const color = getStatusColorUnified(status, 'item');
                const pct = items.length > 0 ? Math.round((count / items.length) * 100) : 0;
                return `
                        <div>
                            <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:4px;">
                                <span>${escapeHtml(status)}</span>
                                <span>${count} (${pct}%)</span>
                            </div>
                            <div style="height:8px; background:#f0f0f0; border-radius:4px; overflow:hidden;">
                                <div style="width:${pct}%; height:100%; background:${color}; border-radius:4px;"></div>
                            </div>
                        </div>
                    `;
            }).join('')}
                </div>
            </div>

            <!-- Recent Items -->
            <div class="sd-card" style="padding:16px;">
                <div class="sd-card-title">Recent Items</div>
                ${recentItems.length > 0 ? `
                <div style="display:flex; flex-direction:column; gap:8px;">
                ${recentItems.map(it => {
                const dn = it.item_drawing_no || it.drawing_no || '‚Äî';
                const st = getItemStatusDisplay(it);
                const stColor = getStatusColorUnified(st, 'item');
                const itemId = it.id || it.item_drawing_no || it.drawing_no || '';
                return `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; background:#f8f9fa; border-radius:6px; cursor:pointer; transition:background 0.2s;"
                             data-projdetail-action="open-item" data-item-id="${escapeHtml(String(itemId))}" data-drawing-no="${escapeHtml(dn)}"
                             onmouseover="this.style.background='#e3f2fd'" onmouseout="this.style.background='#f8f9fa'">
                            <div>
                                <div style="font-weight:600; font-size:12px; color:#007AFF;">${escapeHtml(dn)}</div>
                                <div style="font-size:11px; color:#666;">${escapeHtml((it.description || '').slice(0, 40))}</div>
                            </div>
                            <span style="background:${stColor}; color:white; padding:2px 8px; border-radius:4px; font-size:10px;">${escapeHtml(st)}</span>
                        </div>
                    `;
            }).join('')}
                </div>
                ` : '<div class="muted">No items yet</div>'}
            </div>
        </div>
    `;
        }

        // SUPPLIERS TAB
        function renderProjectDetailSuppliersTab(items, supplierStats, rates) {
            const container = getEl('projdetail-suppliers-content');
            if (!container) return;

            const mainSuppliers = Object.values(supplierStats).filter(s => s.mainCount > 0).sort((a, b) => b.totalValue - a.totalValue);
            const altSuppliers = Object.values(supplierStats).filter(s => s.mainCount === 0).sort((a, b) => b.itemsCount - a.itemsCount);

            container.innerHTML = `
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
            <!-- Main Suppliers -->
            <div class="sd-card" style="padding:16px;">
                <div class="sd-card-title">üèÜ Main Suppliers (${mainSuppliers.length})</div>
                ${mainSuppliers.length > 0 ? `
                <div style="max-height:400px; overflow-y:auto;">
                <table style="width:100%; font-size:12px; border-collapse:collapse;">
                    <thead><tr style="border-bottom:2px solid #e0e0e0; position:sticky; top:0; background:white;">
                        <th style="text-align:left; padding:8px 4px;">Supplier</th>
                        <th style="text-align:center; padding:8px 4px;">Items</th>
                        <th style="text-align:right; padding:8px 4px;">Value</th>
                        <th style="text-align:center; padding:8px 4px;">Avg LT</th>
                        <th style="text-align:center; padding:8px 4px;">Action</th>
                    </tr></thead>
                    <tbody>
                    ${mainSuppliers.map(s => `
                        <tr style="border-bottom:1px solid #f0f0f0;">
                            <td style="padding:8px 4px; font-weight:600;"><a href="#" data-projdetail-action="open-supplier" data-supplier="${escapeHtml(s.name)}" style="color:#007AFF; text-decoration:none;">${escapeHtml(s.name)}</a></td>
                            <td style="text-align:center; padding:8px 4px;">${s.mainCount}</td>
                            <td style="text-align:right; padding:8px 4px; color:#28a745; font-weight:600;">‚Ç¨${formatNumber(s.totalValue, 0)}</td>
                            <td style="text-align:center; padding:8px 4px;">${s.avgLeadTime > 0 ? s.avgLeadTime + 'd' : '‚Äî'}</td>
                            <td style="text-align:center; padding:8px 4px;">
                                <button class="btn-success btn-sm" data-projdetail-action="mark-supplier-won" data-supplier="${escapeHtml(s.name)}" style="font-size:10px; padding:4px 8px;">üèÜ Won</button>
                            </td>
                        </tr>
                    `).join('')}
                    </tbody>
                </table>
                </div>
                ` : '<div class="muted">No main suppliers selected</div>'}
            </div>

            <!-- Alt Suppliers -->
            <div class="sd-card" style="padding:16px;">
                <div class="sd-card-title">üìã Alternative Suppliers (${altSuppliers.length})</div>
                ${altSuppliers.length > 0 ? `
                <div style="max-height:400px; overflow-y:auto;">
                <table style="width:100%; font-size:12px; border-collapse:collapse;">
                    <thead><tr style="border-bottom:2px solid #e0e0e0; position:sticky; top:0; background:white;">
                        <th style="text-align:left; padding:8px 4px;">Supplier</th>
                        <th style="text-align:center; padding:8px 4px;">Quoted Items</th>
                        <th style="text-align:center; padding:8px 4px;">Avg LT</th>
                    </tr></thead>
                    <tbody>
                    ${altSuppliers.slice(0, 20).map(s => `
                        <tr style="border-bottom:1px solid #f0f0f0;">
                            <td style="padding:8px 4px;"><a href="#" data-projdetail-action="open-supplier" data-supplier="${escapeHtml(s.name)}" style="color:#007AFF; text-decoration:none;">${escapeHtml(s.name)}</a></td>
                            <td style="text-align:center; padding:8px 4px;">${s.itemsCount}</td>
                            <td style="text-align:center; padding:8px 4px;">${s.avgLeadTime > 0 ? s.avgLeadTime + 'd' : '‚Äî'}</td>
                        </tr>
                    `).join('')}
                    </tbody>
                </table>
                </div>
                ` : '<div class="muted">No alternative suppliers</div>'}
            </div>
        </div>

        <!-- Top 10 by Spending -->
        <div class="sd-card" style="padding:16px; margin-top:16px;">
            <div class="sd-card-title">üìä Top 10 Suppliers by Planned Spending</div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
            ${mainSuppliers.slice(0, 10).map((s, i) => {
                const maxVal = mainSuppliers[0]?.totalValue || 1;
                const pct = Math.round((s.totalValue / maxVal) * 100);
                return `
                    <div style="flex:1; min-width:120px; max-width:200px; background:#f8f9fa; border-radius:8px; padding:12px; text-align:center; cursor:pointer; transition:background 0.2s;"
                         data-projdetail-action="open-supplier" data-supplier="${escapeHtml(s.name)}"
                         onmouseover="this.style.background='#e3f2fd'" onmouseout="this.style.background='#f8f9fa'">
                        <div style="font-size:20px; font-weight:800; color:#667eea;">#${i + 1}</div>
                        <div style="font-size:11px; font-weight:600; margin:4px 0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; color:#007AFF;" title="${escapeHtml(s.name)}">${escapeHtml(s.name)}</div>
                        <div style="font-size:14px; font-weight:700; color:#28a745;">‚Ç¨${formatNumber(s.totalValue, 0)}</div>
                        <div style="height:4px; background:#e0e0e0; border-radius:2px; margin-top:8px;">
                            <div style="width:${pct}%; height:100%; background:#667eea; border-radius:2px;"></div>
                        </div>
                    </div>
                `;
            }).join('')}
            </div>
        </div>
    `;
        }

        // ITEMS STATS TAB - Pagination state
        let __itemsStatsPage = { noQuotes: 0, noMain: 0 };
        const ITEMS_STATS_PAGE_SIZE = 50;

        // ITEMS STATS TAB
        function renderProjectDetailItemsStatsTab(items, statusCounts, rates) {
            const container = getEl('projdetail-items-stats-content');
            if (!container) return;

            // Calculate price statistics
            const prices = items.map(it => {
                const mainSup = (it.suppliers || []).find(s => s.isMain);
                if (mainSup) {
                    const cur = mainSup.currency || 'EUR';
                    const rate = rates[cur] || 1;
                    let p = 0;
                    if (mainSup.prices && mainSup.prices[0]) p = parseFloat(mainSup.prices[0].price) || 0;
                    if (!p) p = parseFloat(mainSup.price_1 || mainSup.price) || 0;
                    return p * rate;
                }
                return parseFloat(it.price_1_euro) || (parseFloat(it.price_1) || 0) * (rates[it.currency || 'EUR'] || 1);
            }).filter(p => p > 0);

            const avgPrice = prices.length > 0 ? prices.reduce((a, b) => a + b, 0) / prices.length : 0;
            const minPrice = prices.length > 0 ? Math.min(...prices) : 0;
            const maxPrice = prices.length > 0 ? Math.max(...prices) : 0;
            const medianPrice = prices.length > 0 ? prices.sort((a, b) => a - b)[Math.floor(prices.length / 2)] : 0;

            // Items without quotes
            const noQuotes = items.filter(it => {
                return !(it.suppliers || []).some(s => {
                    return (s.prices && s.prices.some(p => parseFloat(p.price) > 0)) || parseFloat(s.price_1 || s.price) > 0;
                });
            });

            // Items without main supplier
            const noMain = items.filter(it => !(it.suppliers || []).some(s => s.isMain));

            // Pagination helper
            const renderItemsList = (itemsList, listType, page) => {
                const totalPages = Math.ceil(itemsList.length / ITEMS_STATS_PAGE_SIZE);
                const start = page * ITEMS_STATS_PAGE_SIZE;
                const end = Math.min(start + ITEMS_STATS_PAGE_SIZE, itemsList.length);
                const pageItems = itemsList.slice(start, end);

                return `
            <div style="max-height:350px; overflow-y:auto;" id="items-stats-list-${listType}">
                <table style="width:100%; font-size:12px; border-collapse:collapse;">
                    <thead><tr style="border-bottom:2px solid #e0e0e0; position:sticky; top:0; background:white;">
                        <th style="text-align:left; padding:6px 4px;">Drawing No</th>
                        <th style="text-align:left; padding:6px 4px;">Description</th>
                        <th style="text-align:center; padding:6px 4px;">Qty</th>
                        <th style="text-align:center; padding:6px 4px;">Status</th>
                    </tr></thead>
                    <tbody>
                    ${pageItems.map(it => {
                    const dn = it.item_drawing_no || it.drawing_no || '‚Äî';
                    const desc = (it.description || '').slice(0, 40);
                    const qty = it.qty_1 || '‚Äî';
                    const st = getItemStatusDisplay(it);
                    const stColor = getStatusColorUnified(st, 'item');
                    const itemId = it.id || dn;
                    return `
                            <tr style="border-bottom:1px solid #f0f0f0; cursor:pointer;"
                                data-projdetail-action="open-item" data-item-id="${escapeHtml(String(itemId))}" data-drawing-no="${escapeHtml(dn)}"
                                onmouseover="this.style.background='#e3f2fd'" onmouseout="this.style.background='transparent'">
                                <td style="padding:6px 4px; font-weight:600; color:#007AFF;">${escapeHtml(dn)}</td>
                                <td style="padding:6px 4px; color:#666;">${escapeHtml(desc)}</td>
                                <td style="padding:6px 4px; text-align:center;">${qty}</td>
                                <td style="padding:6px 4px; text-align:center;">
                                    <span style="background:${stColor}; color:white; padding:2px 6px; border-radius:4px; font-size:10px;">${escapeHtml(st)}</span>
                                </td>
                            </tr>
                        `;
                }).join('')}
                    </tbody>
                </table>
            </div>
            ${totalPages > 1 ? `
            <div style="display:flex; justify-content:center; align-items:center; gap:8px; margin-top:12px; padding-top:12px; border-top:1px solid #e0e0e0;">
                <button class="btn-secondary btn-sm" data-projdetail-action="items-stats-page" data-list="${listType}" data-page="${page - 1}" ${page === 0 ? 'disabled' : ''}>‚Üê Prev</button>
                <span style="font-size:12px; color:#666;">Page ${page + 1} of ${totalPages} (${start + 1}-${end} of ${itemsList.length})</span>
                <button class="btn-secondary btn-sm" data-projdetail-action="items-stats-page" data-list="${listType}" data-page="${page + 1}" ${page >= totalPages - 1 ? 'disabled' : ''}>Next ‚Üí</button>
            </div>
            ` : `<div style="font-size:11px; color:#999; margin-top:8px; text-align:center;">Showing all ${itemsList.length} items</div>`}
        `;
            };

            container.innerHTML = `
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:16px; margin-bottom:16px;">
            <div class="sd-card" style="padding:16px; text-align:center;">
                <div style="font-size:11px; color:#666;">Average Price</div>
                <div style="font-size:20px; font-weight:800; color:#667eea;">‚Ç¨${formatNumber(avgPrice, 2)}</div>
            </div>
            <div class="sd-card" style="padding:16px; text-align:center;">
                <div style="font-size:11px; color:#666;">Min Price</div>
                <div style="font-size:20px; font-weight:800; color:#28a745;">‚Ç¨${formatNumber(minPrice, 2)}</div>
            </div>
            <div class="sd-card" style="padding:16px; text-align:center;">
                <div style="font-size:11px; color:#666;">Max Price</div>
                <div style="font-size:20px; font-weight:800; color:#dc3545;">‚Ç¨${formatNumber(maxPrice, 2)}</div>
            </div>
            <div class="sd-card" style="padding:16px; text-align:center;">
                <div style="font-size:11px; color:#666;">Median Price</div>
                <div style="font-size:20px; font-weight:800; color:#fd7e14;">‚Ç¨${formatNumber(medianPrice, 2)}</div>
            </div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
            <!-- Items without quotes -->
            <div class="sd-card" style="padding:16px;">
                <div class="sd-card-title">‚ö†Ô∏è Items Without Quotes (${noQuotes.length})</div>
                ${noQuotes.length > 0 ? renderItemsList(noQuotes, 'noQuotes', __itemsStatsPage.noQuotes) : '<div style="color:#28a745; font-weight:600;">‚úì All items have quotes!</div>'}
            </div>

            <!-- Items without main supplier -->
            <div class="sd-card" style="padding:16px;">
                <div class="sd-card-title">üìã Items Without Main Supplier (${noMain.length})</div>
                ${noMain.length > 0 ? renderItemsList(noMain, 'noMain', __itemsStatsPage.noMain) : '<div style="color:#28a745; font-weight:600;">‚úì All items have main supplier!</div>'}
            </div>
        </div>
    `;

            // Store items for pagination
            container.__noQuotes = noQuotes;
            container.__noMain = noMain;
            container.__rates = rates;
            container.__statusCounts = statusCounts;
            container.__items = items;
        }

        // PRICING TAB
        function renderProjectDetailPricingTab(items, supplierStats, rates, totalValue, targetValue) {
            const container = getEl('projdetail-pricing-content');
            if (!container) return;

            // Calculate pricing by supplier
            const supplierPricing = Object.values(supplierStats)
                .filter(s => s.mainCount > 0)
                .sort((a, b) => b.totalValue - a.totalValue);

            const totalSupplierValue = supplierPricing.reduce((sum, s) => sum + s.totalValue, 0);

            // Calculate item-level price data
            const itemPrices = items.map(it => {
                const qty = parseFloat(it.qty_1) || 1;
                const mainSup = (it.suppliers || []).find(s => s.isMain);
                let unitPriceEur = 0;
                let totalPriceEur = 0;
                let supName = '';

                if (mainSup) {
                    supName = mainSup.supplier_name || mainSup.name || mainSup.supplier || '';
                    const cur = mainSup.currency || 'EUR';
                    const rate = rates[cur] || 1;
                    let p = 0;
                    if (mainSup.prices && mainSup.prices[0]) p = parseFloat(mainSup.prices[0].price) || 0;
                    if (!p) p = parseFloat(mainSup.price_1 || mainSup.price) || 0;
                    unitPriceEur = p * rate;
                } else {
                    unitPriceEur = parseFloat(it.price_1_euro) || (parseFloat(it.price_1) || 0) * (rates[it.currency || 'EUR'] || 1);
                }
                totalPriceEur = unitPriceEur * qty;

                return {
                    item: it,
                    drawingNo: it.item_drawing_no || it.drawing_no || '‚Äî',
                    description: it.description || '',
                    qty,
                    unitPrice: unitPriceEur,
                    totalPrice: totalPriceEur,
                    supplier: supName,
                    id: it.id || it.item_drawing_no || it.drawing_no
                };
            }).filter(p => p.unitPrice > 0);

            // Sort by total price descending for top expensive
            const topExpensive = [...itemPrices].sort((a, b) => b.totalPrice - a.totalPrice).slice(0, 10);

            // Price distribution
            const priceRanges = [
                { label: '< ‚Ç¨10', min: 0, max: 10, count: 0, value: 0 },
                { label: '‚Ç¨10-50', min: 10, max: 50, count: 0, value: 0 },
                { label: '‚Ç¨50-100', min: 50, max: 100, count: 0, value: 0 },
                { label: '‚Ç¨100-500', min: 100, max: 500, count: 0, value: 0 },
                { label: '‚Ç¨500-1K', min: 500, max: 1000, count: 0, value: 0 },
                { label: '> ‚Ç¨1K', min: 1000, max: Infinity, count: 0, value: 0 }
            ];
            itemPrices.forEach(p => {
                const range = priceRanges.find(r => p.unitPrice >= r.min && p.unitPrice < r.max);
                if (range) { range.count++; range.value += p.totalPrice; }
            });

            // Calculate statistics
            const unitPrices = itemPrices.map(p => p.unitPrice);
            const avgUnitPrice = unitPrices.length > 0 ? unitPrices.reduce((a, b) => a + b, 0) / unitPrices.length : 0;
            const minUnitPrice = unitPrices.length > 0 ? Math.min(...unitPrices) : 0;
            const maxUnitPrice = unitPrices.length > 0 ? Math.max(...unitPrices) : 0;

            container.innerHTML = `
        <!-- Key Metrics Row -->
        <div style="display:grid; grid-template-columns:repeat(5, 1fr); gap:12px; margin-bottom:16px;">
            <div class="sd-card" style="padding:12px; text-align:center;">
                <div style="font-size:10px; color:#666;">Total Value</div>
                <div style="font-size:18px; font-weight:800; color:#28a745;">‚Ç¨${formatNumber(totalValue, 0)}</div>
            </div>
            <div class="sd-card" style="padding:12px; text-align:center;">
                <div style="font-size:10px; color:#666;">Target Value</div>
                <div style="font-size:18px; font-weight:800; color:#667eea;">${targetValue > 0 ? '‚Ç¨' + formatNumber(targetValue, 0) : '‚Äî'}</div>
            </div>
            <div class="sd-card" style="padding:12px; text-align:center;">
                <div style="font-size:10px; color:#666;">Avg Unit Price</div>
                <div style="font-size:18px; font-weight:800; color:#007AFF;">‚Ç¨${formatNumber(avgUnitPrice, 2)}</div>
            </div>
            <div class="sd-card" style="padding:12px; text-align:center;">
                <div style="font-size:10px; color:#666;">Min Unit Price</div>
                <div style="font-size:18px; font-weight:800; color:#28a745;">‚Ç¨${formatNumber(minUnitPrice, 2)}</div>
            </div>
            <div class="sd-card" style="padding:12px; text-align:center;">
                <div style="font-size:10px; color:#666;">Max Unit Price</div>
                <div style="font-size:18px; font-weight:800; color:#dc3545;">‚Ç¨${formatNumber(maxUnitPrice, 2)}</div>
            </div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
            <!-- Cost Breakdown by Supplier -->
            <div class="sd-card" style="padding:16px;">
                <div class="sd-card-title">üí∞ Cost Breakdown by Supplier</div>
                ${supplierPricing.length > 0 ? `
                <div style="max-height:300px; overflow-y:auto;">
                <table style="width:100%; font-size:12px; border-collapse:collapse;">
                    <thead><tr style="border-bottom:2px solid #e0e0e0; position:sticky; top:0; background:white;">
                        <th style="text-align:left; padding:6px 4px;">Supplier</th>
                        <th style="text-align:center; padding:6px 4px;">Items</th>
                        <th style="text-align:right; padding:6px 4px;">Value</th>
                        <th style="text-align:right; padding:6px 4px;">%</th>
                    </tr></thead>
                    <tbody>
                    ${supplierPricing.map(s => {
                const pct = totalSupplierValue > 0 ? ((s.totalValue / totalSupplierValue) * 100).toFixed(1) : 0;
                return `
                            <tr style="border-bottom:1px solid #f0f0f0;">
                                <td style="padding:6px 4px;"><a href="#" data-projdetail-action="open-supplier" data-supplier="${escapeHtml(s.name)}" style="color:#007AFF; text-decoration:none; font-weight:600;">${escapeHtml(s.name)}</a></td>
                                <td style="text-align:center; padding:6px 4px;">${s.mainCount}</td>
                                <td style="text-align:right; padding:6px 4px; color:#28a745; font-weight:600;">‚Ç¨${formatNumber(s.totalValue, 0)}</td>
                                <td style="text-align:right; padding:6px 4px;">${pct}%</td>
                            </tr>
                        `;
            }).join('')}
                    <tr style="border-top:2px solid #333; font-weight:700; background:#f8f9fa;">
                        <td style="padding:6px 4px;">TOTAL</td>
                        <td style="text-align:center; padding:6px 4px;">${supplierPricing.reduce((sum, s) => sum + s.mainCount, 0)}</td>
                        <td style="text-align:right; padding:6px 4px; color:#28a745;">‚Ç¨${formatNumber(totalSupplierValue, 0)}</td>
                        <td style="text-align:right; padding:6px 4px;">100%</td>
                    </tr>
                    </tbody>
                </table>
                </div>
                ` : '<div class="muted">No pricing data available</div>'}
            </div>

            <!-- Top 10 Most Expensive Items -->
            <div class="sd-card" style="padding:16px;">
                <div class="sd-card-title">üî• Top 10 Most Expensive Items</div>
                ${topExpensive.length > 0 ? `
                <div style="max-height:300px; overflow-y:auto;">
                <table style="width:100%; font-size:11px; border-collapse:collapse;">
                    <thead><tr style="border-bottom:2px solid #e0e0e0; position:sticky; top:0; background:white;">
                        <th style="text-align:left; padding:6px 4px;">Item</th>
                        <th style="text-align:center; padding:6px 4px;">Qty</th>
                        <th style="text-align:right; padding:6px 4px;">Unit ‚Ç¨</th>
                        <th style="text-align:right; padding:6px 4px;">Total ‚Ç¨</th>
                    </tr></thead>
                    <tbody>
                    ${topExpensive.map(p => `
                        <tr style="border-bottom:1px solid #f0f0f0; cursor:pointer;"
                            data-projdetail-action="open-item" data-item-id="${escapeHtml(String(p.id))}" data-drawing-no="${escapeHtml(p.drawingNo)}"
                            onmouseover="this.style.background='#e3f2fd'" onmouseout="this.style.background='transparent'">
                            <td style="padding:6px 4px; color:#007AFF; font-weight:600;">${escapeHtml(p.drawingNo)}</td>
                            <td style="text-align:center; padding:6px 4px;">${p.qty}</td>
                            <td style="text-align:right; padding:6px 4px;">‚Ç¨${formatNumber(p.unitPrice, 2)}</td>
                            <td style="text-align:right; padding:6px 4px; font-weight:700; color:#dc3545;">‚Ç¨${formatNumber(p.totalPrice, 0)}</td>
                        </tr>
                    `).join('')}
                    </tbody>
                </table>
                </div>
                ` : '<div class="muted">No pricing data</div>'}
            </div>
        </div>

        <!-- Price Distribution -->
        <div class="sd-card" style="padding:16px; margin-top:16px;">
            <div class="sd-card-title">üìä Price Distribution (Unit Price)</div>
            <div style="display:grid; grid-template-columns:repeat(6, 1fr); gap:12px;">
            ${priceRanges.map(r => `
                <div style="text-align:center; padding:12px; background:#f8f9fa; border-radius:8px;">
                    <div style="font-size:11px; color:#666; font-weight:600;">${r.label}</div>
                    <div style="font-size:18px; font-weight:800; color:#667eea; margin:4px 0;">${r.count}</div>
                    <div style="font-size:10px; color:#666;">items</div>
                    <div style="font-size:11px; color:#28a745; margin-top:4px;">‚Ç¨${formatNumber(r.value, 0)}</div>
                </div>
            `).join('')}
            </div>
        </div>

        <!-- Simulation Section -->
        <div class="sd-card" style="padding:16px; margin-top:16px;">
            <div class="sd-card-title">üîÆ What-If Simulation</div>
            <div style="display:grid; grid-template-columns:repeat(5, 1fr); gap:12px; margin-bottom:16px;">
                <div style="text-align:center; padding:12px; background:#d4edda; border-radius:8px;">
                    <div style="font-size:11px; color:#155724; margin-bottom:6px;">5% discount</div>
                    <div style="font-size:16px; font-weight:700; color:#155724;">‚Ç¨${formatNumber(totalValue * 0.95, 0)}</div>
                    <div style="font-size:10px; color:#28a745;">Save ‚Ç¨${formatNumber(totalValue * 0.05, 0)}</div>
                </div>
                <div style="text-align:center; padding:12px; background:#d4edda; border-radius:8px;">
                    <div style="font-size:11px; color:#155724; margin-bottom:6px;">10% discount</div>
                    <div style="font-size:16px; font-weight:700; color:#155724;">‚Ç¨${formatNumber(totalValue * 0.90, 0)}</div>
                    <div style="font-size:10px; color:#28a745;">Save ‚Ç¨${formatNumber(totalValue * 0.10, 0)}</div>
                </div>
                <div style="text-align:center; padding:12px; background:#d4edda; border-radius:8px;">
                    <div style="font-size:11px; color:#155724; margin-bottom:6px;">15% discount</div>
                    <div style="font-size:16px; font-weight:700; color:#155724;">‚Ç¨${formatNumber(totalValue * 0.85, 0)}</div>
                    <div style="font-size:10px; color:#28a745;">Save ‚Ç¨${formatNumber(totalValue * 0.15, 0)}</div>
                </div>
                <div style="text-align:center; padding:12px; background:#d4edda; border-radius:8px;">
                    <div style="font-size:11px; color:#155724; margin-bottom:6px;">20% discount</div>
                    <div style="font-size:16px; font-weight:700; color:#155724;">‚Ç¨${formatNumber(totalValue * 0.80, 0)}</div>
                    <div style="font-size:10px; color:#28a745;">Save ‚Ç¨${formatNumber(totalValue * 0.20, 0)}</div>
                </div>
                <div style="text-align:center; padding:12px; background:#fff3cd; border-radius:8px;">
                    <div style="font-size:11px; color:#856404; margin-bottom:6px;">Custom %</div>
                    <div style="display:flex; align-items:center; justify-content:center; gap:4px;">
                        <input type="number" id="projdetail-custom-discount" class="rfq-input" style="width:50px; padding:4px; text-align:center;" value="25" min="0" max="100">
                        <span style="font-size:10px;">%</span>
                    </div>
                    <div id="projdetail-custom-result" style="font-size:14px; font-weight:700; color:#856404; margin-top:4px;">‚Ç¨${formatNumber(totalValue * 0.75, 0)}</div>
                </div>
            </div>

            <!-- Quantity Simulation -->
            <div style="border-top:1px solid #e0e0e0; padding-top:16px;">
                <div style="font-size:12px; font-weight:600; color:#555; margin-bottom:12px;">üì¶ Quantity Multiplier (if you order X machines)</div>
                <div style="display:grid; grid-template-columns:repeat(5, 1fr); gap:12px;">
                    ${[1, 2, 5, 10, 20].map(mult => `
                        <div style="text-align:center; padding:12px; background:#e3f2fd; border-radius:8px;">
                            <div style="font-size:11px; color:#0d47a1; margin-bottom:4px;">${mult}x quantity</div>
                            <div style="font-size:16px; font-weight:700; color:#1565c0;">‚Ç¨${formatNumber(totalValue * mult, 0)}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>

        ${targetValue > 0 ? `
        <!-- Target Analysis -->
        <div class="sd-card" style="padding:16px; margin-top:16px; background:${totalValue <= targetValue ? '#d4edda' : '#f8d7da'};">
            <div class="sd-card-title" style="color:${totalValue <= targetValue ? '#155724' : '#721c24'};">üéØ Target Analysis</div>
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; text-align:center;">
                <div>
                    <div style="font-size:12px; color:#666;">Difference</div>
                    <div style="font-size:24px; font-weight:800; color:${totalValue <= targetValue ? '#28a745' : '#dc3545'};">
                        ${totalValue <= targetValue ? '-' : '+'}‚Ç¨${formatNumber(Math.abs(totalValue - targetValue), 0)}
                    </div>
                    <div style="font-size:11px; color:${totalValue <= targetValue ? '#28a745' : '#dc3545'};">${totalValue <= targetValue ? 'Under budget' : 'Over budget'}</div>
                </div>
                <div>
                    <div style="font-size:12px; color:#666;">% of Target</div>
                    <div style="font-size:24px; font-weight:800; color:${totalValue <= targetValue ? '#28a745' : '#dc3545'};">
                        ${((totalValue / targetValue) * 100).toFixed(1)}%
                    </div>
                </div>
                <div>
                    <div style="font-size:12px; color:#666;">Needed Discount to Hit Target</div>
                    <div style="font-size:24px; font-weight:800; color:${totalValue <= targetValue ? '#28a745' : '#fd7e14'};">
                        ${totalValue <= targetValue ? '0%' : ((1 - targetValue / totalValue) * 100).toFixed(1) + '%'}
                    </div>
                </div>
            </div>
        </div>
        ` : ''}
    `;

            // Custom discount input handler
            const customInput = getEl('projdetail-custom-discount');
            const customResult = getEl('projdetail-custom-result');
            if (customInput && customResult) {
                customInput.oninput = () => {
                    const pct = Math.min(100, Math.max(0, parseFloat(customInput.value) || 0));
                    const newVal = totalValue * (1 - pct / 100);
                    customResult.textContent = '‚Ç¨' + formatNumber(newVal, 0);
                };
            }
        }

        // FILES & LINKS TAB (helper)
        function renderProjectDetailFilesTab(atts) {
            const linksTbody = getEl('projdetail-links-tbody');
            const attachBox = getEl('projdetail-attachments');
            const btnAddLink = getEl('btn-projdetail-add-link');
            const btnUpload = getEl('btn-projdetail-upload');
            const fileInput = getEl('projdetail-file');

            // Links
            if (btnAddLink && !btnAddLink.dataset.bound) {
                btnAddLink.dataset.bound = '1';
                btnAddLink.onclick = () => {
                    openAddProjectLinkModal(({ title, url }) => {
                        const rec = { id: uid(), title: title || '', url, created_at: new Date().toISOString() };
                        currentProject.project_links.push(rec);
                        updateProject(currentProject);
                        renderProjectDetail();
                    });
                };
            }
            if (linksTbody) {
                const links = Array.isArray(currentProject.project_links) ? currentProject.project_links : [];
                if (!links.length) {
                    linksTbody.innerHTML = '<tr><td colspan="3" class="muted" style="padding:12px;">No links yet.</td></tr>';
                } else {
                    linksTbody.innerHTML = links.map(l => {
                        const lid = String(l && l.id ? l.id : '');
                        const title = String(l && l.title ? l.title : '');
                        const url = String(l && l.url ? l.url : '');
                        return `
                    <tr>
                        <td style="font-size:12px;">${escapeHtml(title)}</td>
                        <td><a href="${escapeHtml(url)}" target="_blank" rel="noopener" style="font-size:11px; color:#007AFF;">${escapeHtml(url.slice(0, 40))}${url.length > 40 ? '...' : ''}</a></td>
                        <td><button class="btn-secondary btn-sm" data-projdetail-action="del-link" data-id="${escapeHtml(lid)}">√ó</button></td>
                    </tr>
                `;
                    }).join('');
                }
            }

            // Attachments
            if (btnUpload && fileInput && !btnUpload.dataset.bound) {
                btnUpload.dataset.bound = '1';
                btnUpload.onclick = () => fileInput.click();
            }
            if (fileInput && !fileInput.dataset.bound) {
                fileInput.dataset.bound = '1';
                fileInput.addEventListener('change', async (e) => {
                    const f = e.target.files && e.target.files[0];
                    if (!f) return;
                    try {
                        await uploadProjectAttachment(String(currentProject.id), f, 'file');
                        await loadProjectAttachments(String(currentProject.id));
                        renderProjectDetail();
                    } catch (err) {
                        showToast('Upload failed: ' + (err && err.message ? err.message : String(err)), 'error');
                    } finally {
                        e.target.value = '';
                    }
                });
            }
            if (attachBox) {
                if (!atts || !atts.length) {
                    attachBox.innerHTML = '<div class="muted">No files yet.</div>';
                } else {
                    attachBox.innerHTML = atts.map(a => {
                        const aid = String(a && a.id ? a.id : '');
                        const name = String(a && a.filename ? a.filename : (a && a.name ? a.name : 'file'));
                        const url = String(a && a.url ? a.url : '');
                        const size = a && a.size ? (a.size > 1024 * 1024 ? (a.size / 1024 / 1024).toFixed(1) + ' MB' : (a.size / 1024).toFixed(1) + ' KB') : '';
                        const dt = a && a.uploaded_at ? new Date(a.uploaded_at).toLocaleDateString() : '';
                        const ext = name.split('.').pop().toUpperCase();
                        const iconMap = { PDF: 'üìÑ', DOC: 'üìù', DOCX: 'üìù', XLS: 'üìä', XLSX: 'üìä', JPG: 'üñºÔ∏è', JPEG: 'üñºÔ∏è', PNG: 'üñºÔ∏è', ZIP: 'üì¶' };
                        const icon = iconMap[ext] || 'üìÅ';
                        return `
                    <div style="display:flex; align-items:center; gap:10px; padding:8px; border:1px solid #e0e0e0; border-radius:6px; margin-bottom:6px;">
                        <div style="font-size:20px;">${icon}</div>
                        <div style="flex:1; min-width:0;">
                            <div style="font-weight:600; font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(name)}</div>
                            <div style="font-size:10px; color:#999;">${dt} ${size ? '‚Ä¢ ' + size : ''}</div>
                        </div>
                        <div style="display:flex; gap:4px;">
                            ${url ? `<a class="btn-secondary btn-sm" href="${escapeHtml(url)}" target="_blank">Open</a>` : ''}
                            <button class="btn-secondary btn-sm" data-projdetail-action="del-attachment" data-id="${escapeHtml(aid)}">√ó</button>
                        </div>
                    </div>
                `;
                    }).join('');
                }
            }
        }

        // NOTES TAB (helper)
        function renderProjectDetailNotesTab() {
            const notesTa = getEl('projdetail-notes');
            const commentTa = getEl('projdetail-comment-text');
            const commentsBox = getEl('projdetail-comments');
            const btnAddComment = getEl('btn-projdetail-comment-add');

            // Notes (autosave)
            if (notesTa) {
                if (!notesTa.dataset.bound) {
                    notesTa.dataset.bound = '1';
                    notesTa.addEventListener('input', () => {
                        if (__projdetail_notes_timer) clearTimeout(__projdetail_notes_timer);
                        __projdetail_notes_timer = setTimeout(() => {
                            if (!currentProject) return;
                            currentProject.project_notes_text = String(notesTa.value || '');
                            updateProject(currentProject);
                        }, 400);
                    });
                }
                const curText = String(currentProject.project_notes_text || '');
                if (notesTa.value !== curText) notesTa.value = curText;
            }

            // Comments
            if (btnAddComment && !btnAddComment.dataset.bound) {
                btnAddComment.dataset.bound = '1';
                btnAddComment.onclick = () => {
                    const t = commentTa ? String(commentTa.value || '').trim() : '';
                    if (!t) return;
                    const rec = { id: uid(), text: t, created_at: new Date().toISOString() };
                    currentProject.project_comments.unshift(rec);
                    updateProject(currentProject);
                    if (commentTa) commentTa.value = '';
                    renderProjectDetail();
                };
            }
            if (commentsBox) {
                const comments = Array.isArray(currentProject.project_comments) ? currentProject.project_comments : [];
                if (!comments.length) {
                    commentsBox.innerHTML = '<div class="muted" style="padding:10px 0; font-size:12px;">No comments yet.</div>';
                } else {
                    commentsBox.innerHTML = comments.slice(0, 20).map(c => {
                        const cid = String(c && c.id ? c.id : '');
                        const dt = c && c.created_at ? new Date(c.created_at).toLocaleString() : '';
                        const t = c && c.text ? String(c.text) : '';
                        return `
                    <div style="border:1px solid #e0e0e0; border-radius:8px; padding:10px; margin-bottom:8px; background:#fff;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div class="muted" style="font-size:10px;">${escapeHtml(dt)}</div>
                            <button class="btn-secondary btn-sm" style="padding:2px 6px; font-size:10px;" data-projdetail-action="del-comment" data-id="${escapeHtml(cid)}">√ó</button>
                        </div>
                        <div style="margin-top:6px; font-size:12px; white-space:pre-wrap;">${escapeHtml(t)}</div>
                    </div>
                `;
                    }).join('');
                }
            }
        }

        // EXPORTS TAB
        function renderProjectDetailExportsTab(items) {
            const container = getEl('projdetail-exports-content');
            if (!container) return;

            // Calculate stats for quick stats
            const supplierSet = new Set();
            let totalValue = 0;
            let quotedCount = 0;
            const rates = window.RFQData && window.RFQData.CURRENCY_RATES ? window.RFQData.CURRENCY_RATES : { EUR: 1, USD: 0.92, CZK: 0.041 };

            items.forEach(it => {
                const qty = parseFloat(it.qty_1) || 0;
                (it.suppliers || []).forEach(s => {
                    const name = s.supplier_name || s.name || s.supplier;
                    if (name) supplierSet.add(name);
                });
                const mainSup = (it.suppliers || []).find(s => s.isMain);
                if (mainSup) {
                    const cur = mainSup.currency || 'EUR';
                    const rate = rates[cur] || 1;
                    let p = 0;
                    if (mainSup.prices && mainSup.prices[0]) p = parseFloat(mainSup.prices[0].price) || 0;
                    if (!p) p = parseFloat(mainSup.price_1 || mainSup.price) || 0;
                    totalValue += (p * rate) * qty;
                    if (p > 0) quotedCount++;
                }
            });

            const quickStats = `Project: ${currentProject?.name || '‚Äî'}
Project ID: ${currentProject?.id || '‚Äî'}
Status: ${getCurrentProjectStatus()}
Created: ${currentProject?.created_at ? new Date(currentProject.created_at).toLocaleDateString() : '‚Äî'}

ITEMS:
- Total Items: ${items.length}
- With Quotes: ${quotedCount}
- Without Quotes: ${items.length - quotedCount}

SUPPLIERS:
- Total Unique: ${supplierSet.size}

VALUE:
- Total Value (EUR): ‚Ç¨${formatNumber(totalValue, 2)}
- Average per Item: ‚Ç¨${formatNumber(items.length > 0 ? totalValue / items.length : 0, 2)}
`;

            container.innerHTML = `
        <div class="sd-card" style="padding:16px;">
            <div class="sd-card-title">üì§ Export Options</div>
            <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:16px; margin-top:16px;">
                <button class="btn-primary" data-projdetail-action="export-items-excel" style="padding:16px; display:flex; flex-direction:column; align-items:center; gap:8px;">
                    <span style="font-size:24px;">üìä</span>
                    <span style="font-size:12px;">Export Items (Excel)</span>
                </button>
                <button class="btn-success" data-projdetail-action="export-pricing-excel" style="padding:16px; display:flex; flex-direction:column; align-items:center; gap:8px;">
                    <span style="font-size:24px;">üí∞</span>
                    <span style="font-size:12px;">Export Pricing (Excel)</span>
                </button>
                <button class="btn-secondary" data-projdetail-action="export-project-json" style="padding:16px; display:flex; flex-direction:column; align-items:center; gap:8px;">
                    <span style="font-size:24px;">üíæ</span>
                    <span style="font-size:12px;">Backup Project (JSON)</span>
                </button>
                <button class="btn-secondary" data-projdetail-action="export-full-backup" style="padding:16px; display:flex; flex-direction:column; align-items:center; gap:8px;">
                    <span style="font-size:24px;">üìÅ</span>
                    <span style="font-size:12px;">Full Backup (All Projects)</span>
                </button>
            </div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:16px;">
            <div class="sd-card" style="padding:16px;">
                <div class="sd-card-title">üìã Quick Stats</div>
                <textarea id="projdetail-quick-stats" class="rfq-input" readonly style="width:100%; min-height:200px; font-family:monospace; font-size:11px;">${escapeHtml(quickStats)}</textarea>
                <button class="btn-secondary btn-sm" data-projdetail-action="copy-quick-stats" style="margin-top:8px;">Copy to Clipboard</button>
            </div>

            <div class="sd-card" style="padding:16px;">
                <div class="sd-card-title">üìß Email Summary</div>
                <textarea id="projdetail-email-summary" class="rfq-input" readonly style="width:100%; min-height:200px; font-family:monospace; font-size:11px;">${escapeHtml(`Subject: RFQ Status Update - ${currentProject?.name || 'Project'}

Dear Team,

Here is the current status for project "${currentProject?.name || '‚Äî'}":

- Total Items: ${items.length}
- Items with Quotes: ${quotedCount}
- Total Suppliers: ${supplierSet.size}
- Estimated Value: ‚Ç¨${formatNumber(totalValue, 2)}

Please let me know if you have any questions.

Best regards`)}</textarea>
                <button class="btn-secondary btn-sm" data-projdetail-action="copy-email-summary" style="margin-top:8px;">Copy to Clipboard</button>
            </div>
        </div>
    `;
        }

        // ============================================================
        // PRICE FINDER VIEW - Find & Transfer Prices from Other Projects
        // ============================================================

        // Transfer log for current session
        window.__priceTransferLog = window.__priceTransferLog || [];

        function renderSamePartView() {
            const container = getEl('samepart-content');
            if (!container) return;

            if (!currentProject) {
                container.innerHTML = '<div style="padding:40px; text-align:center; color:#999;">No project selected</div>';
                return;
            }

            // Show loading
            container.innerHTML = `
        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; padding:60px 20px;">
            <div style="width:50px; height:50px; border:4px solid #e5e7eb; border-top-color:#3b82f6; border-radius:50%; animation:spin 1s linear infinite;"></div>
            <div style="margin-top:16px; font-size:14px; color:#64748b;">Searching for matching prices...</div>
        </div>
        <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
    `;

            setTimeout(async () => {
                try {
                    await _renderPriceFinderContent(container);
                } catch (err) {
                    console.error("Price Finder load failed:", err);
                    container.innerHTML = `<div style="padding:24px; background:#fef2f2; border:1px solid #fecaca; border-radius:10px; color:#991b1b;">Price Finder failed to load quotes data. Please try Refresh.</div>`;
                }
            }, 30);
        }

        async function _renderPriceFinderContent(container) {
            const items = currentProject.items || [];
            const rates = window.RFQData?.getExchangeRates?.() || { EUR: 1, USD: 0.92, CZK: 0.04 };

            const _n = (v) => String(v || '').trim().toLowerCase();
            const _num = (v) => {
                const n = parseFloat(v);
                return Number.isFinite(n) ? n : 0;
            };

            // Collect all matches with pricing data FROM QUOTES DB
            const results = [];

            // 1) Load quotes index
            const idxRes = await _qFetchJson('/api/quotes/?limit=500&offset=0', { method: 'GET' });
            const quoteIndex = (idxRes && idxRes.quotes) ? idxRes.quotes : [];

            // 2) Load quote details (with lines) for all quotes outside current project
            const quoteDetails = [];
            for (const q of quoteIndex) {
                if (!q || !q.id) continue;
                if (String(q.project_id || '') === String(currentProject.id || '')) continue;
                try {
                    const det = await _qFetchJson(`/api/quotes/${q.id}/`, { method: 'GET' });
                    if (det && det.quote) quoteDetails.push(det.quote);
                } catch (e) {
                    console.warn('PriceFinder: failed to load quote detail', q.id, e);
                }
            }

            // 3) Match current project items to quote lines by drawing_no / mpn
            items.forEach((item, itemIdx) => {
                const dn = item.item_drawing_no || item.drawing_no || '';
                const mpn = item.mpn || '';
                if (!dn && !mpn) return;

                const dnKey = _n(dn);
                const mpnKey = _n(mpn);
                const ourQty = parseFloat(item.qty_1) || 1;
                const hasCurrentQuote = (item.suppliers || []).some(s => parseFloat(s.price_1 || s.price) > 0);

                const quotes = [];
                const seen = new Set();

                quoteDetails.forEach(qd => {
                    const lines = Array.isArray(qd.lines) ? qd.lines : [];
                    lines.forEach(ln => {
                        const ldn = _n(ln.drawing_number || ln.item_drawing_no || ln.drawing_no);
                        const lmpn = _n(ln.mpn);
                        if (!(dnKey && ldn && dnKey === ldn) && !(mpnKey && lmpn && mpnKey === lmpn)) return;

                        // base price: prefer price_1, fallback first available tier
                        let basePrice = _num(ln.price_1);
                        if (!basePrice) {
                            for (let i = 2; i <= 10; i++) {
                                const p = _num(ln[`price_${i}`]);
                                if (p > 0) { basePrice = p; break; }
                            }
                        }
                        if (basePrice <= 0) return;

                        const cur = String(qd.currency || 'EUR').toUpperCase();
                        const eur = basePrice * (rates[cur] || 1);

                        const allPrices = [];
                        for (let i = 1; i <= 10; i++) {
                            const qv = ln[`qty_${i}`];
                            const pv = ln[`price_${i}`];
                            if (qv && pv !== null && pv !== undefined && String(pv).trim() !== '') {
                                allPrices.push({ qty: qv, price: pv, index: i });
                            }
                        }

                        const sourceQty = _num(ln.qty_1) || 1;
                        const supplier = qd.supplier_name || 'Unknown';
                        const dedupKey = `${qd.id}|${supplier}|${ln.line_number || ln.id || ldn || lmpn}`;
                        if (seen.has(dedupKey)) return;
                        seen.add(dedupKey);

                        quotes.push({
                            projectId: qd.project_id,
                            projectName: qd.project_name || '',
                            matchType: (dnKey && ldn && dnKey === ldn) ? 'drawing_no' : 'mpn',
                            matchedDn: ln.drawing_number || '',
                            matchedMpn: ln.mpn || '',
                            sourceQty: sourceQty,
                            supplier: supplier,
                            email: '',
                            quoteNo: qd.quote_number || '',
                            quoteDate: qd.create_date || '',
                            validUntil: qd.expire_date || '',
                            price: basePrice,
                            currency: cur,
                            priceEur: eur,
                            leadTime: ln.supplier_lead_time || ln.manufacturing_lead_time || '',
                            moq: ln.moq || '',
                            incoterms: qd.incoterm || qd.incoterms || '',
                            allPrices: allPrices
                        });
                    });
                });

                if (quotes.length === 0) return;
                quotes.sort((a, b) => a.priceEur - b.priceEur);

                results.push({
                    itemIdx,
                    dn,
                    mpn,
                    description: item.description || '',
                    ourQty,
                    hasCurrentQuote,
                    quotes,
                    bestEur: quotes[0].priceEur
                });
            });
            // Statistics
            const needQuote = results.filter(r => !r.hasCurrentQuote);
            const suppliers = [...new Set(results.flatMap(r => r.quotes.map(q => q.supplier)))];
            const totalEur = results.reduce((s, r) => s + r.bestEur * r.ourQty, 0);

            // Get transfer log for current project
            const transferLog = (window.__priceTransferLog || []).filter(t => t.projectId === currentProject.id);

            // Render
            container.innerHTML = `
        <div style="margin-bottom:16px; padding-bottom:12px; border-bottom:1px solid #e2e8f0;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <div>
                    <h2 style="margin:0; font-size:20px; font-weight:700; color:#0f172a;">üí∞ Price Finder</h2>
                    <div style="font-size:12px; color:#64748b; margin-top:2px;">
                        Find existing quotes and transfer to <strong>${escapeHtml(currentProject.name)}</strong>
                    </div>
                </div>
                <div style="display:flex; gap:6px; flex-wrap:wrap;">
                    <button id="pf-btn-excel" class="btn-secondary" style="font-size:11px; padding:5px 10px;">üìä Excel</button>
                    <button id="pf-btn-supplier-export" class="btn-secondary" style="font-size:11px; padding:5px 10px;">üìß Supplier Request</button>
                    <button id="pf-btn-transfer-all" class="btn-primary" style="font-size:11px; padding:5px 12px;" ${needQuote.length === 0 ? 'disabled' : ''}>
                        üì• Transfer All (${needQuote.length})
                    </button>
                    <button id="pf-btn-rfq" class="btn-success" style="font-size:11px; padding:5px 12px;">Open RFQ Planner</button>
                </div>
            </div>
        </div>

        <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:16px;">
            <div style="background:linear-gradient(135deg,#22c55e,#16a34a); padding:12px; border-radius:8px; text-align:center; color:white;">
                <div style="font-size:10px; opacity:.85;">Items with Matches</div>
                <div style="font-size:26px; font-weight:800;">${results.length}</div>
            </div>
            <div style="background:linear-gradient(135deg,#f59e0b,#d97706); padding:12px; border-radius:8px; text-align:center; color:white;">
                <div style="font-size:10px; opacity:.85;">Need Quote</div>
                <div style="font-size:26px; font-weight:800;">${needQuote.length}</div>
            </div>
            <div style="background:linear-gradient(135deg,#6366f1,#4f46e5); padding:12px; border-radius:8px; text-align:center; color:white;">
                <div style="font-size:10px; opacity:.85;">Suppliers</div>
                <div style="font-size:26px; font-weight:800;">${suppliers.length}</div>
            </div>
            <div style="background:linear-gradient(135deg,#ec4899,#db2777); padding:12px; border-radius:8px; text-align:center; color:white;">
                <div style="font-size:10px; opacity:.85;">Value (EUR)</div>
                <div style="font-size:22px; font-weight:800;">‚Ç¨${formatNumber(totalEur, 0)}</div>
            </div>
        </div>

        ${results.length === 0 ? `
            <div style="text-align:center; padding:40px; background:#f8fafc; border-radius:8px;">
                <div style="font-size:36px; margin-bottom:10px;">üîç</div>
                <div style="font-size:15px; font-weight:600; color:#334155;">No matching prices found</div>
                <div style="font-size:12px; color:#64748b; margin-top:4px;">Request new quotes in RFQ Planner</div>
            </div>
        ` : `
            <div style="margin-bottom:10px; display:flex; gap:10px; align-items:center;">
                <input id="pf-search" type="text" placeholder="Search DN, MPN, Supplier..." style="flex:1; max-width:250px; padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; font-size:11px;">
                <select id="pf-filter" style="padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; font-size:11px;">
                    <option value="all">All</option>
                    <option value="need">Need Quote</option>
                    <option value="has">Has Quote</option>
                </select>
            </div>

            <div id="pf-list" style="display:flex; flex-direction:column; gap:8px;">
                ${results.map((r, ri) => {
                // Check if any supplier already transferred to this item
                const currentItem = currentProject.items[r.itemIdx];
                const existingSuppliers = (currentItem?.suppliers || []).map(s => (s.name || '').toLowerCase());

                return `
                    <div class="pf-card" data-ri="${ri}" data-item-idx="${r.itemIdx}" data-status="${r.hasCurrentQuote ? 'has' : 'need'}"
                         data-search="${(r.dn + ' ' + r.mpn + ' ' + r.description + ' ' + r.quotes.map(q => q.supplier).join(' ')).toLowerCase()}"
                         style="border:1px solid #e2e8f0; border-radius:8px; overflow:hidden; background:white;">

                        <div class="pf-card-header" data-action="open-item" data-item-idx="${r.itemIdx}"
                             style="display:flex; align-items:center; padding:10px 12px; background:${r.hasCurrentQuote ? '#f0fdf4' : '#fffbeb'}; border-bottom:1px solid #e2e8f0; gap:12px; cursor:pointer; transition:background .15s;"
                             onmouseover="this.style.background='${r.hasCurrentQuote ? '#dcfce7' : '#fef3c7'}'"
                             onmouseout="this.style.background='${r.hasCurrentQuote ? '#f0fdf4' : '#fffbeb'}'">
                            <div style="width:20px; height:20px; border-radius:50%; background:${r.hasCurrentQuote ? '#22c55e' : '#f59e0b'}; color:white; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:700;">
                                ${r.hasCurrentQuote ? '‚úì' : '!'}
                            </div>
                            <div style="flex:1; min-width:0;">
                                <div style="font-weight:700; color:#2563eb; font-size:13px; text-decoration:underline;">${escapeHtml(r.dn)} ‚Üí</div>
                                ${r.mpn ? `<div style="font-size:10px; color:#6366f1; font-weight:500;">MPN: ${escapeHtml(r.mpn)}</div>` : ''}
                                <div style="font-size:10px; color:#64748b; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(r.description)}</div>
                            </div>
                            <div style="text-align:center; min-width:50px;">
                                <div style="font-size:9px; color:#64748b;">QTY</div>
                                <div style="font-weight:700; color:#0f172a;">${r.ourQty}</div>
                            </div>
                            <div style="text-align:center; min-width:70px;">
                                <div style="font-size:9px; color:#64748b;">Best Price</div>
                                <div style="font-weight:700; color:#16a34a; font-size:14px;">‚Ç¨${formatNumber(r.bestEur, 2)}</div>
                            </div>
                            <div style="text-align:center; min-width:40px;">
                                <div style="font-size:9px; color:#64748b;">Quotes</div>
                                <div style="font-weight:600; color:#6366f1;">${r.quotes.length}</div>
                            </div>
                        </div>

                        <table style="width:100%; font-size:10px; border-collapse:collapse;">
                            <thead>
                                <tr style="background:#f8fafc;">
                                    <th style="padding:6px 8px; text-align:left; font-weight:600; color:#475569;">Supplier</th>
                                    <th style="padding:6px 8px; text-align:left; font-weight:600; color:#475569;">Quote #</th>
                                    <th style="padding:6px 8px; text-align:center; font-weight:600; color:#475569;">Date</th>
                                    <th style="padding:6px 8px; text-align:center; font-weight:600; color:#475569;">Valid</th>
                                    <th style="padding:6px 8px; text-align:right; font-weight:600; color:#475569;">Price</th>
                                    <th style="padding:6px 8px; text-align:right; font-weight:600; color:#475569;">EUR</th>
                                    <th style="padding:6px 8px; text-align:center; font-weight:600; color:#475569;">Breaks</th>
                                    <th style="padding:6px 8px; text-align:center; font-weight:600; color:#475569;">Lead</th>
                                    <th style="padding:6px 8px; text-align:left; font-weight:600; color:#475569;">Project</th>
                                    <th style="padding:6px 8px; text-align:center; font-weight:600; color:#475569; width:80px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${r.quotes.map((q, qi) => {
                    const isBest = qi === 0;
                    const dateFmt = q.quoteDate ? new Date(q.quoteDate).toLocaleDateString('cs-CZ') : '‚Äî';
                    const validFmt = q.validUntil ? new Date(q.validUntil).toLocaleDateString('cs-CZ') : '‚Äî';
                    const expired = q.validUntil && new Date(q.validUntil) < new Date();
                    const priceBreaks = (q.allPrices || []).length || 1;
                    const alreadyExists = existingSuppliers.includes(q.supplier.toLowerCase());
                    const btnLabel = alreadyExists ? 'üîÑ Update' : (isBest ? '‚≠ê Use' : 'Use');
                    const btnClass = alreadyExists ? 'btn-warning' : (isBest && !r.hasCurrentQuote ? 'btn-primary' : 'btn-secondary');
                    return `
                                        <tr style="${isBest ? 'background:#ecfdf5;' : ''} border-top:1px solid #f1f5f9;" data-row-ri="${ri}" data-row-qi="${qi}">
                                            <td style="padding:6px 8px; font-weight:500;">${escapeHtml(q.supplier)}</td>
                                            <td style="padding:6px 8px; color:#64748b;">${escapeHtml(q.quoteNo || '‚Äî')}</td>
                                            <td style="padding:6px 8px; text-align:center; color:#64748b;">${dateFmt}</td>
                                            <td style="padding:6px 8px; text-align:center; ${expired ? 'color:#dc2626; font-weight:600;' : 'color:#64748b;'}">${validFmt}</td>
                                            <td style="padding:6px 8px; text-align:right; font-weight:600;">${formatNumber(q.price, 2)} <span style="font-size:9px; color:#94a3b8;">${q.currency}</span></td>
                                            <td style="padding:6px 8px; text-align:right; font-weight:700; color:#16a34a;">‚Ç¨${formatNumber(q.priceEur, 2)}</td>
                                            <td style="padding:6px 8px; text-align:center; color:#6366f1; font-weight:600;">${priceBreaks > 1 ? priceBreaks : '‚Äî'}</td>
                                            <td style="padding:6px 8px; text-align:center; color:#64748b;">${q.leadTime || '‚Äî'}</td>
                                            <td style="padding:6px 8px; color:#64748b; max-width:80px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${escapeHtml(q.projectName)}">${escapeHtml(q.projectName)}</td>
                                            <td style="padding:6px 8px; text-align:center;">
                                                <button data-action="use" data-ri="${ri}" data-qi="${qi}" data-is-update="${alreadyExists}"
                                                        class="${btnClass} btn-sm"
                                                        style="padding:2px 8px; font-size:9px;">
                                                    ${btnLabel}
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                }).join('')}
                            </tbody>
                        </table>
                    </div>`;
            }).join('')}
            </div>

            <!-- Transfer Log Card -->
            ${transferLog.length > 0 ? `
                <div style="margin-top:20px; border:2px solid #22c55e; border-radius:10px; overflow:hidden;">
                    <div style="background:linear-gradient(135deg,#22c55e,#16a34a); padding:12px 16px; color:white;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <div style="font-weight:700; font-size:14px;">üìã Transferred Prices Log</div>
                                <div style="font-size:11px; opacity:.9;">${transferLog.length} prices transferred this session</div>
                            </div>
                            <button id="pf-btn-clear-log" class="btn-secondary" style="font-size:10px; padding:4px 10px; background:rgba(255,255,255,.2); border:1px solid rgba(255,255,255,.4); color:white;">
                                Clear Log
                            </button>
                        </div>
                    </div>
                    <div style="max-height:200px; overflow:auto; background:white;">
                        <table style="width:100%; font-size:10px; border-collapse:collapse;">
                            <thead style="background:#f0fdf4; position:sticky; top:0;">
                                <tr>
                                    <th style="padding:6px 8px; text-align:left;">Time</th>
                                    <th style="padding:6px 8px; text-align:left;">Drawing No</th>
                                    <th style="padding:6px 8px; text-align:left;">Supplier</th>
                                    <th style="padding:6px 8px; text-align:right;">Price</th>
                                    <th style="padding:6px 8px; text-align:left;">From Project</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${transferLog.slice().reverse().map(t => `
                                    <tr style="border-top:1px solid #e5e7eb;">
                                        <td style="padding:6px 8px; color:#64748b;">${new Date(t.time).toLocaleTimeString('cs-CZ')}</td>
                                        <td style="padding:6px 8px; font-weight:600;">${escapeHtml(t.dn)}</td>
                                        <td style="padding:6px 8px;">${escapeHtml(t.supplier)}</td>
                                        <td style="padding:6px 8px; text-align:right; font-weight:600; color:#16a34a;">${formatNumber(t.price, 2)} ${t.currency}</td>
                                        <td style="padding:6px 8px; color:#64748b;">${escapeHtml(t.fromProject)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            ` : ''}
        `}
    `;

            // Handlers
            _setupPriceFinderHandlers(results, suppliers, transferLog);
        }

        // Helper: Update transfer log UI without full reload
        function _updateTransferLogUI() {
            const transferLog = (window.__priceTransferLog || []).filter(t => t.projectId === currentProject?.id);
            const container = document.getElementById('samepart-content');
            if (!container) return;

            // Find or create log card
            let logCard = container.querySelector('#pf-transfer-log-card');

            if (transferLog.length === 0) {
                if (logCard) logCard.remove();
                return;
            }

            const qtyWarnings = transferLog.filter(t => t.qtyDiffers).length;
            const logHtml = `
        <div id="pf-transfer-log-card" style="margin-top:20px; border:2px solid #22c55e; border-radius:10px; overflow:hidden;">
            <div style="background:linear-gradient(135deg,#22c55e,#16a34a); padding:12px 16px; color:white;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:700; font-size:14px;">üìã Transfer Log</div>
                        <div style="font-size:11px; opacity:.9;">
                            ${transferLog.length} transferred
                            ${qtyWarnings > 0 ? `<span style="background:rgba(251,191,36,.3); padding:1px 6px; border-radius:4px; margin-left:6px;">‚ö†Ô∏è ${qtyWarnings} QTY differs</span>` : ''}
                        </div>
                    </div>
                    <button id="pf-btn-clear-log" class="btn-secondary" style="font-size:10px; padding:4px 10px; background:rgba(255,255,255,.2); border:1px solid rgba(255,255,255,.4); color:white;">
                        Clear
                    </button>
                </div>
            </div>
            <div style="max-height:250px; overflow:auto; background:white;">
                <table style="width:100%; font-size:10px; border-collapse:collapse;">
                    <thead style="background:#f0fdf4; position:sticky; top:0;">
                        <tr>
                            <th style="padding:6px 8px; text-align:left;">Time</th>
                            <th style="padding:6px 8px; text-align:left;">Drawing No</th>
                            <th style="padding:6px 8px; text-align:left;">Supplier</th>
                            <th style="padding:6px 8px; text-align:center;">Source QTY</th>
                            <th style="padding:6px 8px; text-align:center;">Our QTY</th>
                            <th style="padding:6px 8px; text-align:right;">Price</th>
                            <th style="padding:6px 8px; text-align:left;">From</th>
                            <th style="padding:6px 8px; text-align:center;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${transferLog.slice().reverse().map(t => `
                            <tr style="border-top:1px solid #e5e7eb; ${t.qtyDiffers ? 'background:#fffbeb;' : ''}">
                                <td style="padding:6px 8px; color:#64748b;">${new Date(t.time).toLocaleTimeString('cs-CZ')}</td>
                                <td style="padding:6px 8px; font-weight:600;">${escapeHtml(t.dn)}</td>
                                <td style="padding:6px 8px;">${escapeHtml(t.supplier)}</td>
                                <td style="padding:6px 8px; text-align:center; color:#6366f1;">${t.sourceQty || '‚Äî'}</td>
                                <td style="padding:6px 8px; text-align:center; font-weight:600; ${t.qtyDiffers ? 'color:#d97706;' : 'color:#16a34a;'}">${t.ourQty || '‚Äî'}</td>
                                <td style="padding:6px 8px; text-align:right; font-weight:600; color:#16a34a;">${formatNumber(t.price, 2)} ${t.currency}</td>
                                <td style="padding:6px 8px; color:#64748b; max-width:80px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(t.fromProject)}</td>
                                <td style="padding:6px 8px; text-align:center;">
                                    ${t.qtyDiffers ? `<span style="font-size:9px; padding:2px 6px; border-radius:4px; background:#fef3c7; color:#92400e;">‚ö†Ô∏è QTY</span>` :
                    `<span style="font-size:9px; padding:2px 6px; border-radius:4px; background:#dcfce7; color:#166534;">‚úì OK</span>`}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;

            if (logCard) {
                logCard.outerHTML = logHtml;
            } else {
                container.insertAdjacentHTML('beforeend', logHtml);
            }

            // Re-attach clear handler
            document.getElementById('pf-btn-clear-log')?.addEventListener('click', async () => {
                const ok = await showConfirmDialog('Clear Transfer Log', 'Clear the transfer log for this session?');
                if (!ok) return;
                window.__priceTransferLog = window.__priceTransferLog.filter(t => t.projectId !== currentProject.id);
                _updateTransferLogUI();
                showToast('Transfer log cleared', 'success');
            });
        }

        function _setupPriceFinderHandlers(results, suppliers, transferLog) {
            const pfList = document.getElementById('pf-list');
            if (!pfList) return;

            // Navigate to item detail on header click
            pfList.addEventListener('click', (e) => {
                const header = e.target.closest('[data-action="open-item"]');
                if (header && !e.target.closest('button')) {
                    const itemIdx = parseInt(header.dataset.itemIdx);
                    if (!isNaN(itemIdx) && currentProject?.items?.[itemIdx]) {
                        if (typeof window.itemDetailReturnView !== 'undefined') {
                            window.itemDetailReturnView = 'samepart';
                        }
                        if (typeof openDetailWindow === 'function') {
                            openDetailWindow(itemIdx);
                        } else if (typeof switchView === 'function') {
                            window.currentDetailIndex = itemIdx;
                            switchView('item-detail');
                        }
                    }
                    return;
                }
            });

            // Use button handler via delegation - shows confirmation modal
            pfList.addEventListener('click', async (e) => {
                const btn = e.target.closest('[data-action="use"]');
                if (!btn) return;

                const ri = parseInt(btn.dataset.ri);
                const qi = parseInt(btn.dataset.qi);
                const r = results[ri];
                if (!r) return;
                const q = r.quotes[qi];
                if (!q) return;

                const item = currentProject.items[r.itemIdx];
                if (!item) { showToast('Item not found', 'error'); return; }

                const isUpdate = btn.dataset.isUpdate === 'true';
                const priceBreaks = q.allPrices || [];
                const sourceQty = q.sourceQty || 1;
                const ourQty = r.ourQty || 1;
                const qtyDiffers = sourceQty !== ourQty;

                const priceBreaksHtml = priceBreaks.length > 0 ? `
            <div style="margin-top:12px;">
                <div style="font-size:11px; font-weight:600; color:#334155; margin-bottom:6px;">üìä Price Breaks (${priceBreaks.length}):</div>
                <table style="width:100%; font-size:10px; border:1px solid #e2e8f0; border-radius:4px; overflow:hidden;">
                    <thead style="background:#f8fafc;">
                        <tr>
                            <th style="padding:4px 8px; text-align:left;">QTY</th>
                            <th style="padding:4px 8px; text-align:right;">Price/ea</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${priceBreaks.map((pb, i) => `
                            <tr style="background:${i % 2 === 0 ? '#fff' : '#f8fafc'};">
                                <td style="padding:4px 8px;">${pb.qty || '‚Äî'}</td>
                                <td style="padding:4px 8px; text-align:right; font-weight:600;">${formatNumber(parseFloat(pb.price) || 0, 2)} ${q.currency}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        ` : '';

                // Show confirmation modal
                const modalHtml = `
            <div id="pf-transfer-modal" style="position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:99999; display:flex; align-items:center; justify-content:center;">
                <div style="background:white; border-radius:12px; width:560px; max-width:90vw; max-height:90vh; box-shadow:0 20px 50px rgba(0,0,0,.3); overflow:hidden; display:flex; flex-direction:column;">
                    <div style="background:linear-gradient(135deg,${isUpdate ? '#f59e0b,#d97706' : '#3b82f6,#1d4ed8'}); padding:16px 20px; color:white;">
                        <div style="font-size:16px; font-weight:700;">${isUpdate ? 'üîÑ Update Price' : 'üì• Transfer Price'}</div>
                        <div style="font-size:12px; opacity:.9; margin-top:2px;">Review quantity and price before transfer</div>
                    </div>
                    <div style="padding:20px; overflow-y:auto; flex:1;">

                        <!-- QTY Comparison Box -->
                        <div style="display:grid; grid-template-columns:1fr auto 1fr; gap:12px; margin-bottom:16px; align-items:center;">
                            <div style="background:#e0e7ff; border-radius:8px; padding:12px; text-align:center;">
                                <div style="font-size:10px; color:#4338ca; margin-bottom:4px;">üì¶ Source Project</div>
                                <div style="font-size:10px; color:#64748b;">${escapeHtml(q.projectName)}</div>
                                <div style="font-size:24px; font-weight:800; color:#4338ca;">${sourceQty}</div>
                                <div style="font-size:11px; color:#64748b;">pcs @ ${formatNumber(q.price, 2)} ${q.currency}</div>
                            </div>
                            <div style="font-size:24px; color:#94a3b8;">‚Üí</div>
                            <div style="background:${qtyDiffers ? '#fef3c7' : '#dcfce7'}; border-radius:8px; padding:12px; text-align:center;">
                                <div style="font-size:10px; color:${qtyDiffers ? '#92400e' : '#166534'}; margin-bottom:4px;">üéØ This Project</div>
                                <div style="font-size:10px; color:#64748b;">${escapeHtml(currentProject.name)}</div>
                                <div style="font-size:24px; font-weight:800; color:${qtyDiffers ? '#d97706' : '#16a34a'};">${ourQty}</div>
                                <div style="font-size:11px; color:#64748b;">pcs needed</div>
                            </div>
                        </div>

                        ${qtyDiffers ? `
                            <div style="background:#fef3c7; border:1px solid #f59e0b; border-radius:8px; padding:12px; margin-bottom:16px;">
                                <div style="font-weight:600; color:#92400e; font-size:12px;">‚ö†Ô∏è Quantity Difference</div>
                                <div style="font-size:11px; color:#78350f; margin-top:4px;">
                                    The price was quoted for <strong>${sourceQty} pcs</strong> but you need <strong>${ourQty} pcs</strong>.
                                    ${ourQty > sourceQty ? 'You may need to request a new quote for the higher quantity.' : 'The price may be higher for lower quantities.'}
                                </div>
                            </div>
                        ` : `
                            <div style="background:#dcfce7; border:1px solid #22c55e; border-radius:8px; padding:12px; margin-bottom:16px;">
                                <div style="font-weight:600; color:#166534; font-size:12px;">‚úÖ Quantity Match</div>
                                <div style="font-size:11px; color:#14532d; margin-top:4px;">
                                    The quoted quantity matches your requirement.
                                </div>
                            </div>
                        `}

                        <div style="background:#f8fafc; border-radius:8px; padding:12px; margin-bottom:12px;">
                            <div style="font-size:11px; color:#64748b; margin-bottom:4px;">Item:</div>
                            <div style="font-size:14px; font-weight:700; color:#0f172a;">${escapeHtml(r.dn)}</div>
                            ${r.mpn ? `<div style="font-size:11px; color:#6366f1;">MPN: ${escapeHtml(r.mpn)}</div>` : ''}
                        </div>

                        <table style="width:100%; font-size:11px; border:1px solid #e2e8f0; border-radius:6px; overflow:hidden;">
                            <tr style="background:#f0fdf4;">
                                <td style="padding:8px; font-weight:500; width:35%;">Supplier</td>
                                <td style="padding:8px; font-weight:700;">${escapeHtml(q.supplier)}</td>
                            </tr>
                            <tr style="background:white;">
                                <td style="padding:8px;">Quote No</td>
                                <td style="padding:8px;">${escapeHtml(q.quoteNo || '‚Äî')}</td>
                            </tr>
                            <tr style="background:#f8fafc;">
                                <td style="padding:8px;">Unit Price</td>
                                <td style="padding:8px; font-weight:700; color:#16a34a; font-size:14px;">${formatNumber(q.price, 2)} ${q.currency} <span style="font-size:11px; color:#64748b;">(‚Ç¨${formatNumber(q.priceEur, 2)})</span></td>
                            </tr>
                            <tr style="background:white;">
                                <td style="padding:8px;">Lead Time</td>
                                <td style="padding:8px;">${q.leadTime || '‚Äî'}</td>
                            </tr>
                            <tr style="background:#f8fafc;">
                                <td style="padding:8px;">MOQ</td>
                                <td style="padding:8px;">${q.moq || '‚Äî'}</td>
                            </tr>
                            <tr style="background:#fef3c7;">
                                <td style="padding:8px;">Valid Until</td>
                                <td style="padding:8px; ${q.validUntil && new Date(q.validUntil) < new Date() ? 'color:#dc2626; font-weight:600;' : ''}">${q.validUntil ? new Date(q.validUntil).toLocaleDateString('cs-CZ') : '‚Äî'}</td>
                            </tr>
                        </table>

                        ${priceBreaksHtml}

                        <div style="margin-top:16px; padding:12px; background:#e0f2fe; border-radius:6px; font-size:11px; color:#0369a1;">
                            ‚ÑπÔ∏è This will add the supplier price to your item. Your item's quantity (${ourQty} pcs) will NOT be changed.
                        </div>
                    </div>
                    <div style="padding:16px 20px; background:#f8fafc; display:flex; justify-content:flex-end; gap:10px; border-top:1px solid #e2e8f0;">
                        <button id="pf-modal-cancel" class="btn-secondary" style="padding:8px 20px;">Cancel</button>
                        <button id="pf-modal-confirm" class="${qtyDiffers ? 'btn-warning' : 'btn-primary'}" style="padding:8px 20px;">
                            ${qtyDiffers ? '‚ö†Ô∏è Use Anyway' : '‚úì Confirm Transfer'}
                        </button>
                    </div>
                </div>
            </div>
        `;

                document.body.insertAdjacentHTML('beforeend', modalHtml);

                const modal = document.getElementById('pf-transfer-modal');
                const btnCancel = document.getElementById('pf-modal-cancel');
                const btnConfirm = document.getElementById('pf-modal-confirm');

                const closeModal = () => modal?.remove();

                btnCancel?.addEventListener('click', closeModal);
                modal?.addEventListener('click', (ev) => { if (ev.target === modal) closeModal(); });

                btnConfirm?.addEventListener('click', () => {
                    closeModal();

                    // Now do the actual transfer
                    if (!Array.isArray(item.suppliers)) item.suppliers = [];

                    let sup = item.suppliers.find(s => (s.name || '').toLowerCase() === q.supplier.toLowerCase());
                    const isNew = !sup;
                    if (isNew) {
                        sup = { id: Date.now().toString(36), name: q.supplier, prices: [] };
                        item.suppliers.push(sup);
                    }

                    // Get unit price (first/base price from source)
                    const unitPrice = String(q.price);

                    // Store with OUR project's QTY - NOT the source QTY!
                    // Use item.qty_1 as the quantity tier
                    const itemQty1 = parseFloat(item.qty_1) || ourQty || 1;

                    // Set price with OUR quantity
                    sup.prices = [{ qty: itemQty1, price: unitPrice }];
                    sup.price = unitPrice;
                    sup.price_1 = unitPrice;
                    // Clear any old price tiers that might have wrong quantities
                    sup.price_2 = '';
                    sup.price_3 = '';
                    sup.price_4 = '';
                    sup.price_5 = '';

                    sup.currency = q.currency;
                    sup.lead_time = q.leadTime || '';
                    sup.moq = q.moq || '';
                    sup.incoterms = q.incoterms || '';
                    sup.status = 'Quoted';
                    sup.quote_no = q.quoteNo || '';
                    sup.quoted_date = q.quoteDate || '';
                    sup.valid_until = q.validUntil || '';

                    // Mark as transferred - this will show in item detail
                    sup.source_project = q.projectName;
                    sup.transferred_from = q.projectName;
                    sup.transferred_at = new Date().toISOString();
                    sup.source_qty = sourceQty; // Original qty for reference
                    sup.notes = (sup.notes || '') + (sup.notes ? '\n' : '') + `Transferred from "${q.projectName}" (was ${sourceQty} pcs @ ${unitPrice} ${q.currency})`;

                    if (!sup.isMain && item.suppliers.length === 1) sup.isMain = true;

                    // Add to transfer log
                    window.__priceTransferLog.push({
                        time: new Date().toISOString(),
                        projectId: currentProject.id,
                        dn: r.dn,
                        mpn: r.mpn,
                        supplier: q.supplier,
                        price: q.price,
                        currency: q.currency,
                        priceEur: q.priceEur,
                        fromProject: q.projectName,
                        quoteNo: q.quoteNo,
                        priceBreaks: priceBreaks.length || 1,
                        sourceQty: sourceQty,
                        ourQty: ourQty,
                        qtyDiffers: qtyDiffers,
                        action: isNew ? 'add' : 'update'
                    });

                    // Save in background
                    if (window.RFQData?.updateProject) {
                        window.RFQData.updateProject(currentProject);
                    }

                    // Update DOM without full reload
                    const card = document.querySelector(`.pf-card[data-ri="${ri}"]`);
                    if (card) {
                        // Update card header status
                        const header = card.querySelector('.pf-card-header');
                        if (header) {
                            header.style.background = '#f0fdf4';
                            header.onmouseover = function () { this.style.background = '#dcfce7'; };
                            header.onmouseout = function () { this.style.background = '#f0fdf4'; };
                        }
                        const statusBadge = card.querySelector('div[style*="border-radius:50%"]');
                        if (statusBadge) {
                            statusBadge.style.background = '#22c55e';
                            statusBadge.innerHTML = '‚úì';
                        }
                        card.dataset.status = 'has';

                        // Update button to "Update" style
                        const rowBtn = card.querySelector(`[data-action="use"][data-ri="${ri}"][data-qi="${qi}"]`);
                        if (rowBtn) {
                            rowBtn.className = 'btn-success btn-sm';
                            rowBtn.style.padding = '2px 8px';
                            rowBtn.style.fontSize = '9px';
                            rowBtn.innerHTML = '‚úì Done';
                            rowBtn.disabled = true;
                        }
                    }

                    // Add log entry to DOM if log card exists
                    _updateTransferLogUI();

                    showToast(`${isUpdate ? 'Updated' : 'Added'}: ${q.supplier} (${priceBreaks.length || 1} price${priceBreaks.length > 1 ? 's' : ''})`, 'success');
                });
            });

            // Clear Log button
            document.getElementById('pf-btn-clear-log')?.addEventListener('click', async () => {
                const ok = await showConfirmDialog('Clear Transfer Log', 'Are you sure you want to clear the transfer log for this session?');
                if (!ok) return;
                window.__priceTransferLog = window.__priceTransferLog.filter(t => t.projectId !== currentProject.id);
                showToast('Transfer log cleared', 'success');
                renderSamePartView();
            });

            // Transfer All
            document.getElementById('pf-btn-transfer-all')?.addEventListener('click', async () => {
                const need = results.filter(r => !r.hasCurrentQuote);
                if (!need.length) return;

                const totalBreaks = need.reduce((sum, r) => sum + ((r.quotes[0]?.allPrices || []).length || 1), 0);
                const qtyDiffCount = need.filter(r => {
                    const srcQty = r.quotes[0]?.sourceQty || 1;
                    return srcQty !== r.ourQty;
                }).length;

                const confirmMsg = `Transfer best price to ${need.length} items?\n\n` +
                    `‚Ä¢ Price breaks: ${totalBreaks}\n` +
                    (qtyDiffCount > 0 ? `‚Ä¢ ‚ö†Ô∏è ${qtyDiffCount} items have different QTY` : '‚Ä¢ ‚úÖ All QTY match');

                const ok = await showConfirmDialog('Transfer All Best Prices', confirmMsg);
                if (!ok) return;

                let c = 0;
                need.forEach(r => {
                    const q = r.quotes[0];
                    const item = currentProject.items[r.itemIdx];
                    if (!item || !q) return;

                    const sourceQty = q.sourceQty || 1;
                    const ourQty = r.ourQty || 1;
                    const qtyDiffers = sourceQty !== ourQty;

                    if (!Array.isArray(item.suppliers)) item.suppliers = [];
                    let sup = item.suppliers.find(s => (s.name || '').toLowerCase() === q.supplier.toLowerCase());
                    const isNew = !sup;
                    if (isNew) {
                        sup = { id: Date.now().toString(36) + c, name: q.supplier, prices: [] };
                        item.suppliers.push(sup);
                    }

                    // Get unit price - NOT the source quantities!
                    const unitPrice = String(q.price);
                    const itemQty1 = parseFloat(item.qty_1) || ourQty || 1;

                    // Store with OUR quantity
                    sup.prices = [{ qty: itemQty1, price: unitPrice }];
                    sup.price = unitPrice;
                    sup.price_1 = unitPrice;
                    sup.price_2 = '';
                    sup.price_3 = '';
                    sup.price_4 = '';
                    sup.price_5 = '';

                    sup.currency = q.currency;
                    sup.lead_time = q.leadTime || '';
                    sup.moq = q.moq || '';
                    sup.status = 'Quoted';
                    sup.quote_no = q.quoteNo || '';
                    sup.quoted_date = q.quoteDate || '';
                    sup.valid_until = q.validUntil || '';

                    // Mark as transferred
                    sup.source_project = q.projectName;
                    sup.transferred_from = q.projectName;
                    sup.transferred_at = new Date().toISOString();
                    sup.source_qty = sourceQty;
                    sup.notes = `Transferred from "${q.projectName}" (was ${sourceQty} pcs @ ${unitPrice} ${q.currency})`;

                    if (!sup.isMain && item.suppliers.length === 1) sup.isMain = true;

                    // Add to transfer log
                    window.__priceTransferLog.push({
                        time: new Date().toISOString(),
                        projectId: currentProject.id,
                        dn: r.dn,
                        mpn: r.mpn,
                        supplier: q.supplier,
                        price: q.price,
                        currency: q.currency,
                        priceEur: q.priceEur,
                        fromProject: q.projectName,
                        quoteNo: q.quoteNo,
                        priceBreaks: priceBreaks.length || 1,
                        sourceQty: sourceQty,
                        ourQty: ourQty,
                        qtyDiffers: qtyDiffers,
                        action: isNew ? 'add' : 'update'
                    });

                    c++;
                });

                if (window.RFQData?.updateProject) window.RFQData.updateProject(currentProject);
                showToast(`Transferred ${c} prices`, 'success');
                renderSamePartView();
            });

            // RFQ Planner
            document.getElementById('pf-btn-rfq')?.addEventListener('click', () => switchView('quoting'));

            // Excel Export
            document.getElementById('pf-btn-excel')?.addEventListener('click', () => {
                if (!window.XLSX) { showToast('XLSX not loaded', 'error'); return; }
                const rows = [];
                results.forEach(r => {
                    r.quotes.forEach(q => {
                        rows.push({
                            'Drawing No': r.dn,
                            'MPN': r.mpn,
                            'Description': r.description,
                            'Our QTY': r.ourQty,
                            'Has Quote': r.hasCurrentQuote ? 'Yes' : 'No',
                            'Supplier': q.supplier,
                            'Email': q.email,
                            'Quote No': q.quoteNo,
                            'Quote Date': q.quoteDate,
                            'Valid Until': q.validUntil,
                            'Price': q.price,
                            'Currency': q.currency,
                            'Price EUR': q.priceEur,
                            'Lead Time': q.leadTime,
                            'MOQ': q.moq,
                            'From Project': q.projectName
                        });
                    });
                });
                const ws = XLSX.utils.json_to_sheet(rows);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Price Finder');
                XLSX.writeFile(wb, `PriceFinder_${currentProject.name.replace(/[^a-z0-9]/gi, '_')}.xlsx`);
                showToast('Exported to Excel', 'success');
            });

            // Supplier Export
            document.getElementById('pf-btn-supplier-export')?.addEventListener('click', async () => {
                const bySup = {};
                results.forEach(r => {
                    r.quotes.forEach(q => {
                        if (!bySup[q.supplier]) bySup[q.supplier] = [];
                        bySup[q.supplier].push({ dn: r.dn, mpn: r.mpn, desc: r.description, qty: r.ourQty, ...q });
                    });
                });
                const sups = Object.keys(bySup);
                if (!sups.length) { showToast('No suppliers', 'warning'); return; }

                const name = await showPromptDialog('Supplier Export',
                    'Enter supplier name:\n\n' + sups.map(s => `‚Ä¢ ${s} (${bySup[s].length})`).join('\n'));
                if (!name || !bySup[name]) { showToast('Not found', 'warning'); return; }

                if (!window.XLSX) { showToast('XLSX not loaded', 'error'); return; }
                const rows = bySup[name].map(it => ({
                    'Drawing No': it.dn,
                    'MPN': it.mpn,
                    'Description': it.desc,
                    'Our QTY': it.qty,
                    'Prev Quote No': it.quoteNo,
                    'Prev Price': it.price,
                    'Currency': it.currency,
                    'Quote Date': it.quoteDate,
                    'NEW PRICE': '',
                    'NEW LEAD TIME': '',
                    'VALID UNTIL': '',
                    'COMMENTS': ''
                }));
                const ws = XLSX.utils.json_to_sheet(rows);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Quote Request');
                XLSX.writeFile(wb, `QuoteRequest_${name.replace(/[^a-z0-9]/gi, '_')}.xlsx`);
                showToast(`Exported for ${name}`, 'success');
            });

            // Search & Filter
            const search = document.getElementById('pf-search');
            const filter = document.getElementById('pf-filter');
            const doFilter = () => {
                const s = (search?.value || '').toLowerCase();
                const f = filter?.value || 'all';
                document.querySelectorAll('.pf-card').forEach(card => {
                    const ok = (!s || card.dataset.search.includes(s)) && (f === 'all' || card.dataset.status === f);
                    card.style.display = ok ? '' : 'none';
                });
            };
            search?.addEventListener('input', doFilter);
            filter?.addEventListener('change', doFilter);
        }


        function renderSidebarProjects() {
            // legacy alias (kept): use the unified renderer
            renderSidebar();
        }

        function handleCreateProject() {
            const input = getEl('new-project-name');
            const selStatus = getEl('new-project-status');
            const dateRec = getEl('new-project-received');
            const dateBom = getEl('new-project-bom');
            const dateDeadline = getEl('new-project-deadline');
            const dateSent = getEl('new-project-sent');
            const inputSentTo = getEl('new-project-sent-to');

            if (!input || !input.value.trim()) {
                if (window.showToast) window.showToast('Please enter a project name', 'warning');
                return;
            }
            if (typeof createProject === 'function') {
                const extraData = {
                    received: dateRec ? dateRec.value : '',
                    bom_received: dateBom ? dateBom.value : '',
                    deadline: dateDeadline ? dateDeadline.value : '',
                    sent: dateSent ? dateSent.value : '',
                    sent_to: inputSentTo ? inputSentTo.value : ''
                };

                const newProj = createProject(input.value.trim(), extraData);
                if (newProj) {
                    // Project status
                    try {
                        const st = selStatus ? String(selStatus.value || '').trim() : '';
                        if (st) newProj.project_status = normStatusValue(st);
                    } catch (e) { }
                    try { updateProject(newProj); } catch (e) { }
                    if (typeof getProjects === 'function') projects = getProjects();
                    currentProject = newProj;
                    localStorage.setItem('rfq_active_project_id', newProj.id);
                    renderDashboardProjects();
                    renderSidebarProjects();
                    renderSidebarProjects();

                    setProjectNameUI(currentProject.name);

                    ensureProjectSuppliers(currentProject);
                    syncProjectBatchesIntoMemory(currentProject);
                    (currentProject.items || []).forEach(ensureItemShape);
                    syncAllBatchesToItems(currentProject);
                    updateProject(currentProject);

                    switchView('dashboard');
                    getEl('sheet-new-project').classList.add('hidden');

                    // Clear inputs
                    input.value = '';
                    try { if (selStatus) { fillProjectStatusSelect(selStatus, 'Created'); } } catch (e) { }
                    if (dateRec) dateRec.value = '';
                    if (dateBom) dateBom.value = '';
                    if (dateDeadline) dateDeadline.value = '';
                    if (dateSent) dateSent.value = '';
                    if (inputSentTo) inputSentTo.value = '';
                }
            }
        }

        function openEditProjectModal() {
            if (!currentProject) return;
            const d = currentProject.dates || {};

            getEl('edit-project-name').value = currentProject.name || '';
            getEl('edit-project-received').value = d.received || '';
            getEl('edit-project-bom').value = d.bom_received || '';
            getEl('edit-project-deadline').value = d.deadline || '';
            getEl('edit-project-sent').value = d.sent || '';
            getEl('edit-project-sent-to').value = d.sent_to || '';

            try { fillProjectStatusSelect(getEl('edit-project-status'), getCurrentProjectStatus()); } catch (e) { }

            getEl('sheet-edit-project').classList.remove('hidden');

            const btnUlo≈æit = getEl('btn-save-edit-project');
            const btnZru≈°it = getEl('btn-cancel-edit-project');

            // Remove old listeners to prevent duplicates (simple way: clone and replace, or just ensure one-time setup)
            // Ideally we setup listeners in setupEventListeners, but this is a specific modal handling
            btnUlo≈æit.onclick = handleEditProject;
            btnZru≈°it.onclick = () => getEl('sheet-edit-project').classList.add('hidden');
        }

        function handleEditProject() {
            if (!currentProject) return;

            currentProject.name = getEl('edit-project-name').value.trim();
            try {
                const sel = getEl('edit-project-status');
                const st = sel ? String(sel.value || '').trim() : '';
                if (st) currentProject.project_status = normStatusValue(st);
            } catch (e) { }
            if (!currentProject.dates) currentProject.dates = {};

            currentProject.dates.received = getEl('edit-project-received').value;
            currentProject.dates.bom_received = getEl('edit-project-bom').value;
            currentProject.dates.deadline = getEl('edit-project-deadline').value;
            currentProject.dates.sent = getEl('edit-project-sent').value;
            currentProject.dates.sent_to = getEl('edit-project-sent-to').value;

            if (typeof updateProject === 'function') updateProject(currentProject);

            // UI Updates
            setProjectNameUI(currentProject.name);
            renderSidebarProjects();
            renderDashboard(); // Re-render dashboard to show new dates

            getEl('sheet-edit-project').classList.add('hidden');
        }

        function renderDashboard() {
            // Always render project status / header even if project is empty
            try { renderDashboardProjectStatus(); } catch (e) { }

            // Bind layout editor button
            try { bindDashboardLayoutButton(); } catch (e) { }

            // Refresh custom boxes with current project data
            try { refreshCustomBoxes(); } catch (e) { }

            // Update Project Info Card
            const elProjName = getEl('dash-project-name');
            const elProjBadge = getEl('dash-project-status-badge');
            const elProjCreated = getEl('dash-info-created');
            const elProjReceived = getEl('dash-info-received');
            const elProjBom = getEl('dash-info-bom');
            const elProjDeadline = getEl('dash-info-deadline');
            const elProjSent = getEl('dash-info-sent');
            const elProjSentTo = getEl('dash-info-sentto');
            const elProjCoverImg = getEl('dash-project-cover-img');
            const elProjCoverIcon = getEl('dash-project-cover-icon');
            const btnDashEdit = getEl('btn-dash-edit-project');
            const btnDashViewDetail = getEl('btn-dash-view-detail');

            if (currentProject) {
                const d = currentProject.dates || {};
                const ps = currentProject.project_status || 'Created';

                if (elProjName) elProjName.textContent = currentProject.name || 'Untitled';
                if (elProjBadge) {
                    elProjBadge.textContent = ps;
                    const psL = String(ps).toLowerCase();
                    if (psL.includes('done') || psL.includes('completed')) {
                        elProjBadge.style.background = '#d4edda';
                        elProjBadge.style.color = '#155724';
                    } else if (psL.includes('process') || psL.includes('active')) {
                        elProjBadge.style.background = '#cce5ff';
                        elProjBadge.style.color = '#004085';
                    } else if (psL.includes('hold') || psL.includes('wait')) {
                        elProjBadge.style.background = '#fff3cd';
                        elProjBadge.style.color = '#856404';
                    } else {
                        elProjBadge.style.background = '#e9ecef';
                        elProjBadge.style.color = '#495057';
                    }
                }

                // Update Big Status Badge
                const elStatusBig = getEl('dash-status-big');
                const elStatusBigText = getEl('dash-status-big-text');
                if (elStatusBig && elStatusBigText) {
                    elStatusBigText.textContent = ps;
                    const psL = String(ps).toLowerCase();
                    let bgColor = '#64748b', icon = 'üìã';
                    if (psL.includes('done') || psL.includes('completed') || psL.includes('closed')) {
                        bgColor = '#10b981'; icon = '‚úì';
                    } else if (psL.includes('process') || psL.includes('active') || psL.includes('progress')) {
                        bgColor = '#3b82f6'; icon = '‚è≥';
                    } else if (psL.includes('hold') || psL.includes('wait')) {
                        bgColor = '#f59e0b'; icon = '‚è∏';
                    } else if (psL.includes('cancel') || psL.includes('reject')) {
                        bgColor = '#ef4444'; icon = '‚úï';
                    } else if (psL.includes('new') || psL.includes('created')) {
                        bgColor = '#8b5cf6'; icon = 'üÜï';
                    }
                    elStatusBig.style.background = bgColor;
                    elStatusBig.querySelector('span:first-child').textContent = icon;
                }

                // Update Last Comment Display (from ALL sources: project notes, item comments, supplier comments)
                const elLastComment = getEl('dash-last-comment');
                const elLastCommentDate = getEl('dash-last-comment-date');
                const elLastCommentText = getEl('dash-last-comment-text');
                const elLastCommentIcon = document.querySelector('#dash-last-comment > span:first-child');

                // Collect all comments from different sources
                const allComments = [];
                const items = Array.isArray(currentProject.items) ? currentProject.items : [];

                // 1. Project notes
                const projectNotes = Array.isArray(currentProject.project_notes) ? currentProject.project_notes : [];
                projectNotes.forEach(note => {
                    allComments.push({
                        source: 'project',
                        sourceLabel: 'üìã Note',
                        text: note.text || '',
                        timestamp: new Date(note.created_at || 0).getTime(),
                        dateStr: note.created_at,
                        itemIndex: -1
                    });
                });

                // 2. Item comments
                items.forEach((item, idx) => {
                    const itemComments = Array.isArray(item.comments) ? item.comments : [];
                    const itemName = item.item_drawing_no || item.drawing_no || item.part_no || `Item ${idx + 1}`;
                    itemComments.forEach(c => {
                        allComments.push({
                            source: 'item',
                            sourceLabel: `üì¶ ${itemName}`,
                            text: c.text || '',
                            timestamp: new Date(c.timestamp || 0).getTime(),
                            dateStr: c.timestamp,
                            itemIndex: idx,
                            itemName: itemName
                        });
                    });

                    // 3. Supplier comments within items
                    const suppliers = Array.isArray(item.suppliers) ? item.suppliers : [];
                    suppliers.forEach(sup => {
                        const supComments = Array.isArray(sup.comments) ? sup.comments : [];
                        const supName = sup.name || sup.supplier || 'Supplier';
                        supComments.forEach(c => {
                            allComments.push({
                                source: 'supplier',
                                sourceLabel: `üè≠ ${supName}`,
                                text: c.text || c.comment || '',
                                timestamp: new Date(c.timestamp || c.created_at || 0).getTime(),
                                dateStr: c.timestamp || c.created_at,
                                itemIndex: idx,
                                itemName: itemName,
                                supplierName: supName
                            });
                        });
                    });
                });

                // Sort by timestamp descending and get the most recent
                allComments.sort((a, b) => b.timestamp - a.timestamp);

                if (elLastCommentDate && elLastCommentText) {
                    if (allComments.length > 0 && allComments[0].text) {
                        const lastComment = allComments[0];
                        const dt = new Date(lastComment.timestamp);
                        const dateDisplay = isNaN(dt.getTime()) ? (lastComment.dateStr || '‚Äî') : dt.toLocaleDateString() + ' ' + dt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        elLastCommentDate.innerHTML = `<span style="color:#3b82f6; font-weight:600;">${lastComment.sourceLabel}</span> ¬∑ ${dateDisplay}`;
                        elLastCommentText.textContent = lastComment.text;
                        elLastCommentText.title = lastComment.text;
                        if (elLastCommentIcon) {
                            if (lastComment.source === 'project') elLastCommentIcon.textContent = 'üìã';
                            else if (lastComment.source === 'item') elLastCommentIcon.textContent = 'üì¶';
                            else if (lastComment.source === 'supplier') elLastCommentIcon.textContent = 'üè≠';
                        }
                        // Store navigation data
                        if (elLastComment) {
                            elLastComment.dataset.source = lastComment.source;
                            elLastComment.dataset.itemIndex = lastComment.itemIndex;
                        }
                    } else {
                        elLastCommentDate.textContent = '‚Äî';
                        elLastCommentText.textContent = 'No comments yet';
                        if (elLastCommentIcon) elLastCommentIcon.textContent = 'üí¨';
                        if (elLastComment) {
                            elLastComment.dataset.source = '';
                            elLastComment.dataset.itemIndex = '-1';
                        }
                    }
                }

                // Update Last Project Note Display
                const elLastNote = getEl('dash-last-note');
                const elLastNoteText = getEl('dash-last-note-text');
                if (elLastNoteText) {
                    if (projectNotes.length > 0) {
                        const lastNote = projectNotes[0];
                        elLastNoteText.textContent = lastNote.text || '‚Äî';
                        elLastNoteText.title = lastNote.text || '';
                    } else {
                        elLastNoteText.textContent = '‚Äî';
                    }
                }

                // Update Last Issue Item Display
                const elLastIssue = getEl('dash-last-issue');
                const elLastIssueText = getEl('dash-last-issue-text');
                if (elLastIssueText) {
                    // Find last item with Issue status
                    let lastIssueItem = null;
                    let lastIssueIndex = -1;
                    for (let i = items.length - 1; i >= 0; i--) {
                        const it = items[i];
                        const status = (it.status || it.item_status || '').toLowerCase();
                        if (status.includes('issue') || status === 'issue') {
                            lastIssueItem = it;
                            lastIssueIndex = i;
                            break;
                        }
                    }
                    if (lastIssueItem) {
                        const issueName = lastIssueItem.item_drawing_no || lastIssueItem.drawing_no || lastIssueItem.part_no || `Item ${lastIssueIndex + 1}`;
                        elLastIssueText.textContent = issueName;
                        elLastIssueText.title = `${issueName} - ${lastIssueItem.description || ''}`;
                        if (elLastIssue) elLastIssue.dataset.itemIndex = lastIssueIndex;
                    } else {
                        elLastIssueText.textContent = 'No issues';
                        if (elLastIssue) elLastIssue.dataset.itemIndex = '-1';
                    }
                }

                // Bind click handlers for navigation
                if (elLastComment && !elLastComment.dataset.bound) {
                    elLastComment.dataset.bound = '1';
                    elLastComment.onclick = () => {
                        const source = elLastComment.dataset.source;
                        const itemIdx = parseInt(elLastComment.dataset.itemIndex);
                        if (source === 'project') {
                            openDashboardNoteModal();
                        } else if ((source === 'item' || source === 'supplier') && itemIdx >= 0) {
                            if (window.openItemDetail) window.openItemDetail(itemIdx);
                            else if (window.showItemDetailPanel) window.showItemDetailPanel(itemIdx);
                        }
                    };
                }
                if (elLastNote && !elLastNote.dataset.bound) {
                    elLastNote.dataset.bound = '1';
                    elLastNote.onclick = () => openDashboardNoteModal();
                }
                if (elLastIssue && !elLastIssue.dataset.bound) {
                    elLastIssue.dataset.bound = '1';
                    elLastIssue.onclick = () => {
                        const itemIdx = parseInt(elLastIssue.dataset.itemIndex);
                        if (itemIdx >= 0) {
                            if (window.openItemDetail) window.openItemDetail(itemIdx);
                            else if (window.showItemDetailPanel) window.showItemDetailPanel(itemIdx);
                        }
                    };
                }

                const formatDate = (dateStr) => {
                    if (!dateStr) return '‚Äî';
                    try {
                        const dt = new Date(dateStr);
                        if (isNaN(dt.getTime())) return dateStr;
                        return dt.toLocaleDateString();
                    } catch (e) { return dateStr; }
                };

                // Update Control Bar dates
                const elBarReceived = getEl('dash-bar-received');
                const elBarDeadline = getEl('dash-bar-deadline');
                if (elBarReceived) elBarReceived.textContent = d.received || '‚Äî';
                if (elBarDeadline) {
                    const dl = d.deadline || '';
                    if (dl) {
                        const dlDate = new Date(dl);
                        const today = new Date();
                        const daysLeft = Math.ceil((dlDate - today) / (1000 * 60 * 60 * 24));
                        let color = '#334155';
                        if (daysLeft < 0) color = '#dc2626';
                        else if (daysLeft <= 7) color = '#ea580c';
                        else if (daysLeft <= 14) color = '#ca8a04';
                        elBarDeadline.style.color = color;
                        elBarDeadline.style.fontWeight = daysLeft <= 7 ? 'bold' : 'normal';
                        elBarDeadline.textContent = dl + (daysLeft <= 7 && daysLeft >= 0 ? ` (${daysLeft}d)` : daysLeft < 0 ? ' (!)' : '');
                    } else {
                        elBarDeadline.textContent = '‚Äî';
                        elBarDeadline.style.color = '#334155';
                    }
                }

                // Bind Control Bar Edit button
                const btnDashEditBar = getEl('btn-dash-edit-project-bar');
                if (btnDashEditBar) btnDashEditBar.onclick = openEditProjectModal;

                const createdAt = currentProject.created_at ? formatDate(currentProject.created_at) : '‚Äî';
                if (elProjCreated) elProjCreated.innerHTML = `<b>Created:</b> ${createdAt}`;
                if (elProjReceived) elProjReceived.innerHTML = `<b>Received:</b> ${d.received || '‚Äî'}`;
                if (elProjBom) elProjBom.innerHTML = `<b>BOM:</b> ${d.bom_received || d.bom || '‚Äî'}`;

                // Highlight deadline if approaching
                if (elProjDeadline) {
                    const dl = d.deadline || '';
                    if (dl) {
                        const dlDate = new Date(dl);
                        const today = new Date();
                        const daysLeft = Math.ceil((dlDate - today) / (1000 * 60 * 60 * 24));
                        let color = '#666';
                        if (daysLeft < 0) color = '#dc3545';
                        else if (daysLeft <= 7) color = '#fd7e14';
                        else if (daysLeft <= 14) color = '#ffc107';
                        elProjDeadline.innerHTML = `<b style="color:${color};">Deadline:</b> <span style="color:${color};">${dl}</span>`;
                        if (daysLeft <= 7 && daysLeft >= 0) elProjDeadline.innerHTML += ` <span style="color:${color}; font-size:11px;">(${daysLeft}d left)</span>`;
                        else if (daysLeft < 0) elProjDeadline.innerHTML += ` <span style="color:${color}; font-size:11px;">(overdue!)</span>`;
                    } else {
                        elProjDeadline.innerHTML = `<b>Deadline:</b> ‚Äî`;
                    }
                }

                if (elProjSent) elProjSent.innerHTML = `<b>Sent:</b> ${d.sent || '‚Äî'}`;
                if (elProjSentTo) elProjSentTo.innerHTML = `<b>Sent to:</b> ${escapeHtml(d.sent_to || d.sentTo || '‚Äî')}`;

                // Cover image
                if (elProjCoverImg && elProjCoverIcon) {
                    const cover = currentProject.cover_image || currentProject.coverImage;
                    if (cover) {
                        elProjCoverImg.src = cover;
                        elProjCoverImg.style.display = 'block';
                        elProjCoverIcon.style.display = 'none';
                    } else {
                        elProjCoverImg.style.display = 'none';
                        elProjCoverIcon.style.display = 'block';
                    }
                }

                // Edit button
                if (btnDashEdit) btnDashEdit.onclick = openEditProjectModal;
                // View Detail button
                if (btnDashViewDetail) btnDashViewDetail.onclick = () => switchView('project-detail');
            } else {
                if (elProjName) elProjName.textContent = 'No project selected';
                if (elProjBadge) elProjBadge.textContent = '‚Äî';
            }

            if (!currentProject || !currentProject.items) return;

            const itemsRaw = Array.isArray(currentProject.items) ? currentProject.items : [];

            // Normalize items to avoid duplicates
            const getItemKey = (it, idx) => {
                const k = String(it.item_drawing_no || it.drawing_no || it.part_no || it.mpn || it.id || '').trim();
                return k || ('row_' + idx);
            };

            const uniqueMap = new Map();
            itemsRaw.forEach((it, idx) => {
                if (!it || typeof it !== 'object' || it._deleted === true) return;
                const key = getItemKey(it, idx);
                if (!uniqueMap.has(key)) uniqueMap.set(key, it);
            });

            const items = Array.from(uniqueMap.values());
            const total = items.length;

            // Normalize status: use getItemStatusDisplay and strip count suffix for consistent categorization
            const normStatus = (it) => {
                const display = getItemStatusDisplay(it);
                // Strip count suffix like "(3)" for category matching
                return display.replace(/\s*\(\d+\)$/, '').trim();
            };
            const issues = items.filter(i => normStatus(i) === 'Issue');

            // Calculate Total Value = sum of (price_1 √ó qty_1) for all items in EUR
            // Calculate Target Total = sum of (target_price √ó qty_1) for all items in EUR
            // Both represent the cost for 1 machine
            let totalVal = 0;
            let targetTotal = 0;
            const supplierValues = {};
            const supplierCounts = {};

            items.forEach(it => {
                // Always use qty_1 for machine cost calculation
                const qty1 = parseFloat(it.qty_1) || 0;

                // Get price in EUR - prefer pre-calculated EUR value, otherwise convert
                let priceEur = parseFloat(it.price_1_euro) || 0;
                if (!priceEur) {
                    const price1 = parseFloat(it.price_1) || 0;
                    const currency = it.currency || 'EUR';
                    const rate = CURRENCY_RATES[currency] || 1;
                    priceEur = price1 * rate;
                }

                // Get target price in EUR
                let targetEur = 0;
                const targetPrice = parseFloat(it.target_price) || 0;
                if (targetPrice > 0) {
                    const targetCurrency = it.target_currency || 'EUR';
                    const targetRate = CURRENCY_RATES[targetCurrency] || 1;
                    targetEur = targetPrice * targetRate;
                }

                // Item value = unit price √ó quantity (0 if no price)
                const itemValue = priceEur * qty1;
                totalVal += itemValue;

                // Target value = target price √ó quantity (0 if no target)
                targetTotal += targetEur * qty1;

                const supplier = it.supplier || 'Unknown';
                supplierValues[supplier] = (supplierValues[supplier] || 0) + itemValue;
                supplierCounts[supplier] = (supplierCounts[supplier] || 0) + 1;
            });

            // Get RFQ batches
            const rfqBatches = Array.isArray(currentProject.rfqBatches || currentProject.rfq_batches)
                ? (currentProject.rfqBatches || currentProject.rfq_batches) : [];

            // Count items by quote status
            const itemsWithQuote = items.filter(it => {
                const s = normStatus(it);
                return s === 'Quote Received' || s === 'Won' || s === 'Lost' || s === 'Done';
            });
            const itemsAwaitingQuote = items.filter(it => normStatus(it) === 'RFQ Sent');
            const itemsNotSent = items.filter(it => normStatus(it) === 'New' || !normStatus(it));

            // Calculate metrics
            const uniqueSuppliers = Object.keys(supplierCounts).filter(s => s !== 'Unknown').length;
            const quoteRate = total > 0 ? Math.round((itemsWithQuote.length / total) * 100) : 0;
            const avgPrice = total > 0 ? totalVal / total : 0;

            // Update key metrics
            const elTotal = getEl('dash-total-items');
            const elValue = getEl('dash-total-value');
            const elTargetTotal = getEl('dash-target-total');
            const elSupplierCount = getEl('dash-supplier-count');
            const elQuoteRate = getEl('dash-quote-rate');
            const elAvgPrice = getEl('dash-avg-price');

            if (elTotal) elTotal.textContent = total;
            if (elValue) elValue.textContent = '‚Ç¨' + totalVal.toFixed(0);
            if (elTargetTotal) elTargetTotal.textContent = '‚Ç¨' + targetTotal.toFixed(0);
            if (elSupplierCount) elSupplierCount.textContent = uniqueSuppliers;
            if (elQuoteRate) elQuoteRate.textContent = quoteRate + '%';
            if (elAvgPrice) elAvgPrice.textContent = '‚Ç¨' + avgPrice.toFixed(0);

            // Quoting progress
            const elRfqBatches = getEl('dash-rfq-batches');
            const elQuotesReceived = getEl('dash-quotes-received');
            const elAwaitingQuote = getEl('dash-awaiting-quote');
            const elNotSent = getEl('dash-not-sent');

            if (elRfqBatches) elRfqBatches.textContent = rfqBatches.length;
            if (elQuotesReceived) elQuotesReceived.textContent = itemsWithQuote.length;
            if (elAwaitingQuote) elAwaitingQuote.textContent = itemsAwaitingQuote.length;
            if (elNotSent) elNotSent.textContent = itemsNotSent.length;

            // Item Status breakdown - Enhanced visual display
            const breakdownEl = getEl('dash-status-breakdown');
            if (breakdownEl) {
                const counts = {};
                items.forEach(it => {
                    const s = normStatus(it) || 'New';
                    counts[s] = (counts[s] || 0) + 1;
                });

                // DEBUG: Log status counts and categories
                console.log('[Dashboard] Status counts:', JSON.stringify(counts));
                console.log('[Dashboard] First 3 items status details:', items.slice(0, 3).map(it => ({
                    drawing: it.item_drawing_no,
                    status: it.status,
                    status_id: it.status_id,
                    display: getItemStatusDisplay(it),
                    normalized: normStatus(it),
                    category: getStatusCategory(normStatus(it))
                })));

                const totalCount = Math.max(1, total);

                // Calculate category totals - use dynamic status config categories
                let doneCount = 0, inProgressCount = 0, issueCount = 0, newCount = 0;
                Object.entries(counts).forEach(([status, count]) => {
                    const category = getStatusCategory(status);
                    if (category === 'done') doneCount += count;
                    else if (category === 'issue') issueCount += count;
                    else if (category === 'in_progress') inProgressCount += count;
                    else newCount += count; // 'new' or unknown
                });

                const donePct = Math.round((doneCount / totalCount) * 100);
                const inProgressPct = Math.round((inProgressCount / totalCount) * 100);
                const issuePct = Math.round((issueCount / totalCount) * 100);
                const newPct = Math.round((newCount / totalCount) * 100);

                // Create donut chart segments
                const segments = [];
                let currentAngle = 0;
                if (doneCount > 0) {
                    segments.push({ color: '#34C759', pct: donePct, start: currentAngle });
                    currentAngle += donePct * 3.6;
                }
                if (inProgressCount > 0) {
                    segments.push({ color: '#007AFF', pct: inProgressPct, start: currentAngle });
                    currentAngle += inProgressPct * 3.6;
                }
                if (issueCount > 0) {
                    segments.push({ color: '#FF3B30', pct: issuePct, start: currentAngle });
                    currentAngle += issuePct * 3.6;
                }
                if (newCount > 0) {
                    segments.push({ color: '#8e8e93', pct: newPct, start: currentAngle });
                }

                // Build conic gradient for donut
                let gradientParts = [];
                let angle = 0;
                if (doneCount > 0) { gradientParts.push(`#34C759 ${angle}deg ${angle + donePct * 3.6}deg`); angle += donePct * 3.6; }
                if (inProgressCount > 0) { gradientParts.push(`#007AFF ${angle}deg ${angle + inProgressPct * 3.6}deg`); angle += inProgressPct * 3.6; }
                if (issueCount > 0) { gradientParts.push(`#FF3B30 ${angle}deg ${angle + issuePct * 3.6}deg`); angle += issuePct * 3.6; }
                if (newCount > 0) { gradientParts.push(`#8e8e93 ${angle}deg 360deg`); }
                const gradient = gradientParts.length > 0 ? gradientParts.join(', ') : '#e0e0e0 0deg 360deg';

                // Get status details for each category - uses dynamic config
                const getStatusDetailsByCategory = (categoryName) => {
                    const config = getStatusConfig();
                    const statuses = config.itemStatuses.filter(s => s.category === categoryName).map(s => s.name);
                    return statuses.map(s => counts[s] ? `<span style="display:inline-flex; align-items:center; gap:4px; margin:2px 4px 2px 0; padding:2px 8px; background:${getStatusColorUnified(s)}22; color:${getStatusColorUnified(s)}; border-radius:12px; font-size:10px; font-weight:600;"><span style="width:6px; height:6px; background:${getStatusColorUnified(s)}; border-radius:50%;"></span>${s}: ${counts[s]}</span>` : '').filter(Boolean).join('');
                };

                breakdownEl.innerHTML = `
                    <div style="display:flex; gap:20px; align-items:flex-start;">
                        <!-- Donut Chart -->
                        <div style="position:relative; width:100px; height:100px; flex-shrink:0;">
                            <div style="width:100px; height:100px; border-radius:50%; background:conic-gradient(${gradient});"></div>
                            <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:60px; height:60px; background:white; border-radius:50%; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                                <div style="font-size:18px; font-weight:700; color:#333;">${donePct}%</div>
                                <div style="font-size:9px; color:#666; text-transform:uppercase;">Done</div>
                            </div>
                        </div>

                        <!-- Category Summary -->
                        <div style="flex:1; display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                            <div style="padding:10px 12px; background:#34C75915; border-radius:8px; border-left:3px solid #34C759;">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <span style="font-size:11px; color:#34C759; font-weight:600;">‚úì DONE</span>
                                    <span style="font-size:16px; font-weight:700; color:#34C759;">${doneCount}</span>
                                </div>
                                <div style="margin-top:4px; line-height:1.6;">${getStatusDetailsByCategory('done') || '<span style="color:#999; font-size:10px;">‚Äî</span>'}</div>
                            </div>
                            <div style="padding:10px 12px; background:#007AFF15; border-radius:8px; border-left:3px solid #007AFF;">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <span style="font-size:11px; color:#007AFF; font-weight:600;">‚è≥ IN PROGRESS</span>
                                    <span style="font-size:16px; font-weight:700; color:#007AFF;">${inProgressCount}</span>
                                </div>
                                <div style="margin-top:4px; line-height:1.6;">${getStatusDetailsByCategory('in_progress') || '<span style="color:#999; font-size:10px;">‚Äî</span>'}</div>
                            </div>
                            <div style="padding:10px 12px; background:#FF3B3015; border-radius:8px; border-left:3px solid #FF3B30;">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <span style="font-size:11px; color:#FF3B30; font-weight:600;">‚ö† ISSUES</span>
                                    <span style="font-size:16px; font-weight:700; color:#FF3B30;">${issueCount}</span>
                                </div>
                                <div style="margin-top:4px; line-height:1.6;">${getStatusDetailsByCategory('issue') || '<span style="color:#999; font-size:10px;">‚Äî</span>'}</div>
                            </div>
                            <div style="padding:10px 12px; background:#8e8e9315; border-radius:8px; border-left:3px solid #8e8e93;">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <span style="font-size:11px; color:#8e8e93; font-weight:600;">‚óè NEW</span>
                                    <span style="font-size:16px; font-weight:700; color:#8e8e93;">${newCount}</span>
                                </div>
                                <div style="margin-top:4px; line-height:1.6;">${getStatusDetailsByCategory('new') || '<span style="color:#999; font-size:10px;">‚Äî</span>'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Project dates (compact inline)
            const datesContainer = getEl('dashboard-dates-container');
            if (datesContainer) {
                const d = currentProject.dates || {};
                const hasDeadline = d.deadline;
                datesContainer.innerHTML = `
                    <div style="display: flex; gap: 20px; align-items: center; font-size: 12px;">
                        ${d.deadline ? `<span style="color: #FF3B30; font-weight: 600;">Deadline: ${d.deadline}</span>` : ''}
                        ${d.received ? `<span style="color: #666;">Received: ${d.received}</span>` : ''}
                        <button id="btn-edit-project-details" class="btn-secondary btn-sm">Edit Dates</button>
                    </div>
                `;
                setTimeout(() => {
                    const btnEdit = document.getElementById('btn-edit-project-details');
                    if (btnEdit) btnEdit.onclick = openEditProjectModal;
                }, 0);
            }

            // Issues Widget
            const issuesContainer = getEl('dashboard-issues-container');
            if (issues.length > 0) {
                issuesContainer.innerHTML = `
                    <div class="chart-card" style="margin-top: 20px; background: #fff5f5; border-color: #ffcccc;">
                        <h3 style="color: #c00; display: flex; align-items: center; gap: 8px;">
                            Attention Needed <span style="background: #c00; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">${issues.length}</span>
                        </h3>
                        <div class="table-wrapper" style="max-height: 150px; overflow: auto;">
                            <table class="rfq-table" style="background: white;">
                                <thead><tr><th>Item</th><th>Description</th><th>Note</th><th></th></tr></thead>
                                <tbody>
                                    ${issues.map(item => `
                                        <tr>
                                            <td><b>${escapeHtml(item.item_drawing_no || '?')}</b></td>
                                            <td>${escapeHtml(item.description || '-')}</td>
                                            <td style="color: #c00;">${escapeHtml(item.notes || 'Marked as Issue')}</td>
                                            <td><button class="btn-text" onclick="if(window.openItemInProject) window.openItemInProject('${currentProject.id}', '${item.item_drawing_no}');">View</button></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                issuesContainer.classList.remove('hidden');
            } else if (issuesContainer) {
                issuesContainer.innerHTML = '';
                issuesContainer.classList.add('hidden');
            }

            // Render Charts
            renderCharts(items, supplierValues);

            // Top 10 Table (by total value)
            const itemsWithValue = items.map(it => {
                const qtyKey = getDefaultQtyKey(it);
                const tierIdx = getTierIndex(qtyKey);
                const qty = parseFloat(it[qtyKey]) || parseFloat(it.qty_1) || 1;
                const unitPrice = parseFloat(it['price_' + tierIdx + '_euro']) || parseFloat(it.price_1_euro) || 0;
                return { ...it, _qty: qty, _unitPrice: unitPrice, _totalValue: unitPrice * qty };
            });

            const top10 = itemsWithValue.sort((a, b) => b._totalValue - a._totalValue).slice(0, 10);

            const tbody = getEl('table-top-10')?.querySelector('tbody');
            if (tbody) {
                tbody.innerHTML = top10.map((item, idx) => {
                    // Find the actual index in currentProject.items
                    const actualIndex = currentProject.items.findIndex(it =>
                        it.item_drawing_no === item.item_drawing_no && it.description === item.description
                    );
                    return `
                    <tr>
                        <td><a href="#" class="top10-part-link" data-index="${actualIndex}" style="color: #007AFF; text-decoration: none; font-weight: 600; cursor: pointer;">${escapeHtml(item.item_drawing_no || '?')}</a></td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(item.description || '-')}</td>
                        <td>${item._qty}</td>
                        <td>‚Ç¨${formatPrice(item._unitPrice)}</td>
                        <td style="font-weight: 600;">‚Ç¨${item._totalValue.toFixed(0)}</td>
                        <td>${escapeHtml(item.supplier || '-')}</td>
                        <td><span style="padding: 2px 8px; border-radius: 4px; font-size: 11px; background: ${getStatusColorUnified(getItemStatusDisplay(item))}; color: white;">${escapeHtml(getItemStatusDisplay(item))}</span></td>
                    </tr>
                `}).join('');

                // Add click handlers for part number links
                tbody.querySelectorAll('.top10-part-link').forEach(link => {
                    link.onclick = (e) => {
                        e.preventDefault();
                        const index = parseInt(link.dataset.index);
                        if (index >= 0 && currentProject && currentProject.items[index]) {
                            openItemDetail(index);
                        }
                    };
                });
            }

            updateStats();
        }

        function renderDashboardProjects() {
            const select = getEl('dashboard-project-select');
            if (!select) return;
            select.innerHTML = '';
            projects.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = p.name;
                if (currentProject && p.id === currentProject.id) opt.selected = true;
                select.appendChild(opt);
            });
        }

        function getISOWeekNumber(date) {
            const tmp = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = tmp.getUTCDay() || 7; // Mon=1..Sun=7
            tmp.setUTCDate(tmp.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(tmp.getUTCFullYear(), 0, 1));
            return Math.ceil((((tmp - yearStart) / 86400000) + 1) / 7);
        }

        function updateMenuTime() {
            const d = new Date();
            const week = getISOWeekNumber(d);
            const dateStr = d.toLocaleDateString(undefined, { weekday: 'short', year: 'numeric', month: '2-digit', day: '2-digit' });
            const timeStr = d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const txt = `${dateStr} ‚Ä¢ ${timeStr} ‚Ä¢ T√Ωden ${week}`;

            const el = document.getElementById('menu-time');
            if (el) el.textContent = txt;

            const top = document.getElementById('topbar-datetime');
            if (top) top.textContent = txt;
        }

        async function loadSessionInfo() {
            try {
                const res = await fetch('/api/session/me', { credentials: 'same-origin' });
                if (!res.ok) return;
                const data = await res.json();

                // Session safety: prevent cross-user local cache leak in shared browser
                try {
                    const sessionKey = `${data.user_id || ''}:${data.username || ''}:${data.company_id || ''}:${data.role || ''}`;
                    const prevKey = localStorage.getItem('rfq_last_session_key');
                    if (prevKey && prevKey !== sessionKey) {
                        localStorage.removeItem('rfq_projects_v1');
                        localStorage.removeItem('rfq_active_project_id');
                        localStorage.removeItem('rfq_current_view_state');
                        localStorage.removeItem('rfq_main_projects_page');
                        localStorage.setItem('rfq_last_session_key', sessionKey);
                        location.reload();
                        return;
                    }
                    localStorage.setItem('rfq_last_session_key', sessionKey);
                } catch (e) { }

                try {
                    if (window.RFQData && typeof window.RFQData.bootstrapFromServer === 'function') {
                        await window.RFQData.bootstrapFromServer();
                        projects = (window.RFQData.getProjects && window.RFQData.getProjects()) || projects;
                        try { renderSidebar(); } catch (_) { }
                        if (currentView === 'main') {
                            try { renderMainOverview(); } catch (_) { }
                        }
                    }
                } catch (e) { }

                const topUser = document.getElementById('topbar-user');
                if (topUser && data) {
                    const role = data.role ? ` (${data.role})` : '';
                    const scoped = data.scope_company_name ? ` ‚Ä¢ scoped: ${data.scope_company_name}` : (data.company_name ? ` ‚Ä¢ ${data.company_name}` : '');
                    topUser.textContent = `üë§ ${data.username || 'user'}${role}${scoped}`;
                }
                const mega = document.getElementById('topbar-mega-link');
                if (mega && (data.is_superadmin || data.is_management)) {
                    mega.style.display = 'inline';
                }

                const scopeSel = document.getElementById('topbar-company-scope');
                if (scopeSel && data.is_superadmin) {
                    const companies = Array.isArray(data.companies) ? data.companies : [];
                    scopeSel.innerHTML = `<option value='all'>All companies</option>` + companies.map(c => `<option value='${c.id}'>${String(c.name || '').replace(/[<>&"']/g, '')}</option>`).join('');
                    scopeSel.value = data.scope_company_id || 'all';
                    scopeSel.style.display = 'inline-block';
                    scopeSel.onchange = async () => {
                        try {
                            const v = scopeSel.value || 'all';
                            const r = await fetch('/api/session/switch_company', {
                                method: 'POST',
                                credentials: 'same-origin',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ company_id: v })
                            });
                            const jr = await r.json().catch(() => ({}));
                            if (!r.ok) throw new Error(jr.error || 'Switch failed');
                            try {
                                localStorage.removeItem('rfq_projects_v1');
                                localStorage.removeItem('rfq_active_project_id');
                                localStorage.removeItem('rfq_current_view_state');
                                localStorage.removeItem('rfq_main_projects_page');
                            } catch (e) { }
                            location.reload();
                        } catch (e) {
                            console.warn('Company switch failed', e);
                        }
                    };
                }
            } catch (e) { }
        }

        function renderSuppliers() {
            if (!currentProject || !currentProject.items) {
                getEl('bulk-pricing-empty').classList.remove('hidden');
                getEl('bulk-pricing-table-wrapper').classList.add('hidden');
                // Topbar Upload Quote should be disabled if no project
                try {
                    const topBtn = getEl('btn-topbar-upload-quote');
                    if (topBtn) { topBtn.disabled = true; topBtn.title = 'Select a project and supplier first.'; }
                } catch (e) { }
                return;
            }

            const syncTopbarUploadQuoteState = () => {
                const topBtn = getEl('btn-topbar-upload-quote');
                if (!topBtn) return;
                const sel = getEl('bulk-supplier-select');
                const name = sel ? String(sel.value || '').trim() : '';
                topBtn.disabled = false;
                topBtn.title = name ? `Upload quote file for: ${name}` : 'No supplier selected ‚Äî click to open Suppliers and choose one.';
            };

            // Get unique supplier names (robust: supplier master + legacy + item targeting)
            const supplierSet = new Set();

            // 1) Supplier master DB (if present)
            try {
                const sm = currentProject.supplierMaster || currentProject.supplier_master || null;
                if (Array.isArray(sm)) {
                    sm.forEach(s => {
                        const n = (s && (s.name || s.supplier_name)) ? String(s.name || s.supplier_name).trim() : '';
                        if (n) supplierSet.add(n);
                    });
                } else if (sm && typeof sm === 'object') {
                    Object.values(sm).forEach(s => {
                        const n = (s && (s.name || s.supplier_name)) ? String(s.name || s.supplier_name).trim() : '';
                        if (n) supplierSet.add(n);
                    });
                }
            } catch (e) { }

            // 2) Legacy supplierData
            try {
                const sd = currentProject.supplierData || currentProject.supplier_data || null;
                if (Array.isArray(sd)) {
                    sd.forEach(s => {
                        const n = (s && (s.name || s.supplier_name)) ? String(s.name || s.supplier_name).trim() : '';
                        if (n) supplierSet.add(n);
                    });
                } else if (sd && typeof sd === 'object') {
                    Object.values(sd).forEach(s => {
                        const n = (s && (s.name || s.supplier_name)) ? String(s.name || s.supplier_name).trim() : '';
                        if (n) supplierSet.add(n);
                    });
                }
            } catch (e) { }

            // 3) Item-level suppliers + legacy main supplier
            (currentProject.items || []).forEach(item => {
                try {
                    if (item && item.suppliers && Array.isArray(item.suppliers)) {
                        item.suppliers.forEach(sup => {
                            const n = sup && (sup.name || sup.supplier || sup.supplier_name);
                            if (n && String(n).trim()) supplierSet.add(String(n).trim());
                        });
                    }
                    if (item && item.supplier && String(item.supplier).trim()) {
                        supplierSet.add(String(item.supplier).trim());
                    }
                } catch (e) { }
            });
            // Ensure Upload Quote button exists (some builds re-render toolbar without it)
            (function ensureBulkUploadButton() {
                try {
                    const view = getEl('view-suppliers');
                    const toolbarRight = view ? view.querySelector('.toolbar > div:last-child') : null;
                    if (!toolbarRight) return;
                    let btn = getEl('btn-upload-bulk-quote');
                    if (!btn) {
                        btn = document.createElement('button');
                        btn.id = 'btn-upload-bulk-quote';
                        btn.className = 'btn-secondary';
                        btn.style.fontSize = '11px';
                        btn.textContent = 'üìÑ Upload Quote';
                        btn.disabled = true;
                        const saveBtn = getEl('btn-save-bulk-prices');
                        if (saveBtn && saveBtn.parentElement === toolbarRight) {
                            toolbarRight.insertBefore(btn, saveBtn);
                        } else {
                            toolbarRight.appendChild(btn);
                        }
                    }
                    btn.style.display = 'inline-flex';
                } catch (e) { console.error(e); }
            })();

            // Populate supplier dropdown
            const select = getEl('bulk-supplier-select');
            if (select) {
                const currentValue = select.value;
                select.innerHTML = '<option value="">-- Select Supplier --</option>';

                Array.from(supplierSet).sort().forEach(supplierName => {
                    const opt = document.createElement('option');
                    opt.value = supplierName;
                    opt.textContent = supplierName;
                    select.appendChild(opt);
                });

                // Restore selection if valid
                if (currentValue && supplierSet.has(currentValue)) {
                    select.value = currentValue;
                    try {
                        populateBulkPricingTable(currentValue, bulkCurrentPage || 1);
                        const uploadBtn = getEl('btn-upload-bulk-quote');
                        if (uploadBtn) { uploadBtn.style.display = 'inline-flex'; uploadBtn.disabled = false; }
                        try { syncTopbarUploadQuoteState(); } catch (e) { }
                    } catch (e) { console.error(e); }
                }
            }

            // Set up event listeners
            if (select && !select.dataset.listenerAdded) {
                select.addEventListener('change', () => {
                    if (select.value) {
                        populateBulkPricingTable(select.value);
                        // Show upload quote button
                        const uploadBtn = getEl('btn-upload-bulk-quote');
                        if (uploadBtn) { uploadBtn.style.display = 'inline-flex'; uploadBtn.disabled = false; }
                        try { syncTopbarUploadQuoteState(); } catch (e) { }
                    } else {
                        getEl('bulk-pricing-empty').classList.remove('hidden');
                        getEl('bulk-pricing-table-wrapper').classList.add('hidden');
                        getEl('btn-save-bulk-prices').disabled = true;
                        // Hide upload quote button
                        const uploadBtn = getEl('btn-upload-bulk-quote');
                        if (uploadBtn) { uploadBtn.style.display = 'inline-flex'; uploadBtn.disabled = true; uploadBtn.textContent = 'üìÑ Upload Quote'; uploadBtn.style.background = ''; uploadBtn.style.color = ''; }
                        try { window.bulkQuoteFile = null; } catch (e) { }
                        try { syncTopbarUploadQuoteState(); } catch (e) { }
                    }
                });
                select.dataset.listenerAdded = 'true';
            }

            const btnUlo≈æit = getEl('btn-save-bulk-prices');
            if (btnUlo≈æit && !btnUlo≈æit.dataset.listenerAdded) {
                btnUlo≈æit.addEventListener('click', saveBulkPrices);
                btnUlo≈æit.dataset.listenerAdded = 'true';
            }

            // Setup Upload Quote button (attachment + optional Excel/CSV import)
            const btnUploadQuote = getEl('btn-upload-bulk-quote');
            if (btnUploadQuote && !btnUploadQuote.dataset.listenerAdded) {
                btnUploadQuote.addEventListener('click', () => {
                    const supplierSel = getEl('bulk-supplier-select');
                    const supplierName = supplierSel ? String(supplierSel.value || '').trim() : '';
                    if (!supplierName) {
                        if (window.showToast) window.showToast('Select supplier first', 'warning');
                        return;
                    }
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.xlsx,.xls,.csv,.tsv,.pdf,.doc,.docx,.png,.jpg,.jpeg';
                    input.onchange = (e) => {
                        const file = e.target.files && e.target.files[0];
                        if (!file) return;

                        if (file.size > 10 * 1024 * 1024) {
                            if (window.showToast) window.showToast('File too large! Maximum size is 10MB.', 'error');
                            return;
                        }

                        const ext = String(file.name || '').split('.').pop().toLowerCase();

                        // Always keep attachment (base64) for traceability
                        const keepAttachment = () => new Promise((resolve) => {
                            const r = new FileReader();
                            r.onload = (ev) => {
                                try {
                                    window.bulkQuoteFile = { filename: file.name, data: ev.target.result };
                                } catch (e) { }
                                resolve(true);
                            };
                            r.readAsDataURL(file);
                        });

                        const importDoneUI = (msg) => {
                            btnUploadQuote.textContent = `‚úì ${file.name.substring(0, 18)}‚Ä¶`;
                            btnUploadQuote.style.background = '#34c759';
                            btnUploadQuote.style.color = 'white';
                            if (msg) showToast(msg, 'success');
                        };

                        // Import: Excel / CSV / TSV
                        const doImport = async () => {
                            if (ext === 'xlsx' || ext === 'xls') {
                                if (!window.XLSX) {
                                    await keepAttachment();
                                    showToast('Excel library not loaded. File stored as attachment only.', 'warning');
                                    return;
                                }
                                const r = new FileReader();
                                r.onload = async (ev) => {
                                    try {
                                        const data = new Uint8Array(ev.target.result);
                                        const wb = window.XLSX.read(data, { type: 'array' });
                                        const sheetName = wb.SheetNames[0];
                                        const ws = wb.Sheets[sheetName];
                                        const rows = window.XLSX.utils.sheet_to_json(ws, { defval: '' });
                                        const res = bulkApplyImportedRows(supplierName, rows);
                                        await keepAttachment();
                                        try { populateBulkPricingTable(supplierName, bulkCurrentPage || 1); } catch (e) { }
                                        importDoneUI(`Import OK. Updated: ${res.updated}, skipped: ${res.skipped}`);
                                    } catch (err) {
                                        console.error(err);
                                        await keepAttachment();
                                        showToast('Import failed: ' + (err && err.message ? err.message : String(err)), 'error');
                                    }
                                };
                                r.readAsArrayBuffer(file);
                                return;
                            }

                            if (ext === 'csv' || ext === 'tsv') {
                                const r = new FileReader();
                                r.onload = async (ev) => {
                                    try {
                                        const text = String(ev.target.result || '');
                                        const delim = ext === 'tsv' ? '\t' : (text.includes(';') && !text.includes(',') ? ';' : ',');
                                        const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
                                        if (lines.length < 2) throw new Error('Empty CSV');
                                        const headers = lines[0].split(delim).map(h => h.trim());
                                        const rows = lines.slice(1).map(line => {
                                            const cols = line.split(delim);
                                            const o = {};
                                            headers.forEach((h, i) => { o[h] = (cols[i] ?? '').trim(); });
                                            return o;
                                        });
                                        const res = bulkApplyImportedRows(supplierName, rows);
                                        await keepAttachment();
                                        try { populateBulkPricingTable(supplierName, bulkCurrentPage || 1); } catch (e) { }
                                        importDoneUI(`Import OK. Updated: ${res.updated}, skipped: ${res.skipped}`);
                                    } catch (err) {
                                        console.error(err);
                                        await keepAttachment();
                                        showToast('Import failed: ' + (err && err.message ? err.message : String(err)), 'error');
                                    }
                                };
                                r.readAsText(file);
                                return;
                            }

                            // Non-import types: just attachment
                            await keepAttachment();
                            importDoneUI('File attached to Bulk Pricing session.');
                        };

                        doImport();
                    };
                    input.click();
                });
                btnUploadQuote.dataset.listenerAdded = 'true';
            }

            // Multi-Supplier Upload Handler
            const btnMultiSupplier = getEl('btn-upload-multi-supplier');
            if (btnMultiSupplier && !btnMultiSupplier.dataset.listenerAdded) {
                btnMultiSupplier.addEventListener('click', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.xlsx,.xls,.csv';
                    input.onchange = async (e) => {
                        const file = e.target.files && e.target.files[0];
                        if (!file) return;

                        if (file.size > 10 * 1024 * 1024) {
                            if (window.showToast) window.showToast('File too large! Maximum size is 10MB.', 'error');
                            return;
                        }

                        const ext = String(file.name || '').split('.').pop().toLowerCase();

                        if (ext === 'xlsx' || ext === 'xls') {
                            // Excel import
                            if (!window.XLSX) {
                                showToast('Excel library not loaded. Please refresh the page and try again.', 'error');
                                return;
                            }
                            const r = new FileReader();
                            r.onload = (ev) => {
                                try {
                                    const data = new Uint8Array(ev.target.result);
                                    const wb = window.XLSX.read(data, { type: 'array' });
                                    const sheetName = wb.SheetNames[0];
                                    const ws = wb.Sheets[sheetName];
                                    const rows = window.XLSX.utils.sheet_to_json(ws, { defval: '' });
                                    const res = parseMultiSupplierRows(rows);
                                    showMultiSupplierImportResult(res);
                                    // Refresh the table if a supplier is selected
                                    const sel = getEl('bulk-supplier-select');
                                    if (sel && sel.value) {
                                        populateBulkPricingTable(sel.value, bulkCurrentPage || 1);
                                    }
                                } catch (err) {
                                    console.error(err);
                                    showToast('Import failed: ' + (err && err.message ? err.message : String(err)), 'error');
                                }
                            };
                            r.readAsArrayBuffer(file);
                        } else if (ext === 'csv') {
                            // CSV import
                            const r = new FileReader();
                            r.onload = (ev) => {
                                try {
                                    const text = String(ev.target.result || '');
                                    const delim = text.includes(';') && !text.includes(',') ? ';' : ',';
                                    const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
                                    if (lines.length < 2) throw new Error('Empty CSV');
                                    const headers = lines[0].split(delim).map(h => h.trim());
                                    const rows = lines.slice(1).map(line => {
                                        const cols = line.split(delim);
                                        const o = {};
                                        headers.forEach((h, i) => { o[h] = (cols[i] ?? '').trim(); });
                                        return o;
                                    });
                                    const res = parseMultiSupplierRows(rows);
                                    showMultiSupplierImportResult(res);
                                    const sel = getEl('bulk-supplier-select');
                                    if (sel && sel.value) {
                                        populateBulkPricingTable(sel.value, bulkCurrentPage || 1);
                                    }
                                } catch (err) {
                                    console.error(err);
                                    showToast('Import failed: ' + (err && err.message ? err.message : String(err)), 'error');
                                }
                            };
                            r.readAsText(file);
                        }
                    };
                    input.click();
                });
                btnMultiSupplier.dataset.listenerAdded = 'true';
            }

            // Show detailed import result modal
            function showMultiSupplierImportResult(res) {
                const modal = document.createElement('div');
                modal.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:10000;';

                const isSuccess = res.updated > 0;
                const hasErrors = res.skipped > 0;

                let skippedHtml = '';
                if (hasErrors && res.skippedItems && res.skippedItems.length > 0) {
                    const maxShow = 20;
                    const itemsToShow = res.skippedItems.slice(0, maxShow);
                    skippedHtml = `
            <div style="margin-top:16px;">
                <div style="font-weight:600; color:#FF3B30; margin-bottom:8px;">Skipped Items (${res.skipped}):</div>
                <div style="max-height:200px; overflow-y:auto; background:#fff5f5; border:1px solid #ffccc7; border-radius:8px; padding:8px;">
                    <table style="width:100%; font-size:11px; border-collapse:collapse;">
                        <tr style="background:#ffccc7;">
                            <th style="text-align:left; padding:4px 8px;">Row</th>
                            <th style="text-align:left; padding:4px 8px;">Part No</th>
                            <th style="text-align:left; padding:4px 8px;">Reason</th>
                        </tr>
                        ${itemsToShow.map(s => `
                            <tr style="border-bottom:1px solid #ffccc7;">
                                <td style="padding:4px 8px;">${s.row}</td>
                                <td style="padding:4px 8px;">${escapeHtml(String(s.partNo).substring(0, 30))}</td>
                                <td style="padding:4px 8px;">${escapeHtml(s.reason)}</td>
                            </tr>
                        `).join('')}
                    </table>
                    ${res.skippedItems.length > maxShow ? `<div style="padding:8px; color:#666; font-size:11px;">... and ${res.skippedItems.length - maxShow} more</div>` : ''}
                </div>
            </div>
        `;
                }

                modal.innerHTML = `
        <div style="background:white; border-radius:12px; width:500px; max-width:90vw; max-height:90vh; overflow:auto; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
            <div style="padding:20px; border-bottom:1px solid #e0e0e0; display:flex; align-items:center; gap:12px;">
                <span style="font-size:32px;">${isSuccess ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                <div>
                    <h3 style="margin:0; font-size:18px;">${isSuccess ? 'Import Complete' : 'Import Completed with Issues'}</h3>
                    <p style="margin:4px 0 0 0; color:#666; font-size:13px;">Multi-Supplier Upload Results</p>
                </div>
            </div>
            <div style="padding:20px;">
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-bottom:16px;">
                    <div style="background:#e8f5e9; padding:16px; border-radius:8px; text-align:center;">
                        <div style="font-size:28px; font-weight:700; color:#2e7d32;">${res.updated}</div>
                        <div style="font-size:12px; color:#666;">Items Updated</div>
                    </div>
                    <div style="background:${hasErrors ? '#ffebee' : '#f5f5f5'}; padding:16px; border-radius:8px; text-align:center;">
                        <div style="font-size:28px; font-weight:700; color:${hasErrors ? '#c62828' : '#666'};">${res.skipped}</div>
                        <div style="font-size:12px; color:#666;">Rows Skipped</div>
                    </div>
                    <div style="background:#e3f2fd; padding:16px; border-radius:8px; text-align:center;">
                        <div style="font-size:28px; font-weight:700; color:#1565c0;">${res.suppliers.size}</div>
                        <div style="font-size:12px; color:#666;">Suppliers</div>
                    </div>
                </div>
                ${skippedHtml}
            </div>
            <div style="padding:16px 20px; border-top:1px solid #e0e0e0; display:flex; justify-content:flex-end;">
                <button id="multi-import-close" class="btn-primary" style="padding:10px 24px;">OK</button>
            </div>
        </div>
    `;

                document.body.appendChild(modal);
                modal.querySelector('#multi-import-close').onclick = () => modal.remove();
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            }

            // Multi-supplier parsing function
            function parseMultiSupplierRows(rows) {
                const result = { updated: 0, skipped: 0, suppliers: new Set(), skippedItems: [] };

                if (!currentProject || !Array.isArray(currentProject.items)) {
                    return result;
                }

                (rows || []).forEach((row, rowIndex) => {
                    // Find part number
                    const partNo = row.PartNo || row['Part No'] || row.DrawingNo || row['Drawing No'] ||
                        row.drawing_no || row.part_no || row.MPN || row.mpn || row.item_drawing_no || '';
                    const supplierName = String(row.Supplier || row.supplier || row.SupplierName || '').trim();

                    if (!partNo || !supplierName) {
                        result.skipped++;
                        result.skippedItems.push({ row: rowIndex + 2, partNo: partNo || '(empty)', reason: !partNo ? 'Missing Part No' : 'Missing Supplier' });
                        return;
                    }

                    // Find item by part number
                    const item = currentProject.items.find(it => {
                        const dn = String(it.item_drawing_no || it.drawing_no || it.part_no || it.mpn || '').trim().toUpperCase();
                        return dn === String(partNo).trim().toUpperCase();
                    });

                    if (!item) {
                        result.skipped++;
                        result.skippedItems.push({ row: rowIndex + 2, partNo, reason: 'Item not found in project' });
                        return;
                    }

                    // Parse "Main" flag
                    const mainVal = String(row.Main || row.main || row.IsMain || row.isMain || '').toLowerCase();
                    const isMain = ['yes', 'true', '1', 'ano', 'x'].includes(mainVal);

                    // Collect qty/price pairs dynamically (supports up to 20 tiers)
                    const prices = [];
                    for (let i = 1; i <= 20; i++) {
                        const qtyVal = row['Qty_' + i] || row['qty_' + i] || row['Qty' + i] || row['qty' + i] || row['QTY_' + i];
                        const priceVal = row['Price_' + i] || row['price_' + i] || row['Price' + i] || row['price' + i] || row['PRICE_' + i];

                        const qty = parseFloat(String(qtyVal || '').replace(',', '.'));
                        const price = parseFloat(String(priceVal || '').replace(',', '.'));

                        if (qty > 0 && !isNaN(price) && price >= 0) {
                            prices.push({ qty, price });
                        }
                    }

                    // Also support Price@QTY1, Price@QTY2, etc. format
                    for (let i = 1; i <= 10; i++) {
                        const priceVal = row['Price @QTY' + i] || row['Price@QTY' + i] || row['Price_QTY' + i];
                        if (priceVal !== undefined && priceVal !== '') {
                            const price = parseFloat(String(priceVal).replace(',', '.'));
                            // Use item's qty tiers
                            const qtyKey = 'qty_' + i;
                            const qty = parseFloat(item[qtyKey]) || 0;
                            if (qty > 0 && !isNaN(price) && price >= 0) {
                                // Check if we already have this qty
                                if (!prices.find(p => p.qty === qty)) {
                                    prices.push({ qty, price });
                                }
                            }
                        }
                    }

                    // If no price pairs found, skip
                    if (prices.length === 0) {
                        result.skipped++;
                        result.skippedItems.push({ row: rowIndex + 2, partNo, reason: 'No valid Qty/Price pairs found' });
                        return;
                    }

                    // Ensure item has suppliers array
                    ensureItemShape(item);

                    // Find or create supplier entry
                    let entry = item.suppliers.find(s => s.name === supplierName);
                    if (!entry) {
                        entry = {
                            id: Date.now() + Math.random(),
                            name: supplierName,
                            prices: [],
                            currency: 'EUR',
                            isMain: false
                        };
                        item.suppliers.push(entry);
                    }

                    // Update supplier entry
                    entry.prices = prices;
                    entry.currency = String(row.Currency || row.currency || entry.currency || 'EUR').trim().toUpperCase() || 'EUR';
                    if (row.MOQ || row.moq) entry.moq = String(row.MOQ || row.moq).trim();
                    if (row.MOV || row.mov) entry.mov = String(row.MOV || row.mov).trim();
                    if (row.LeadTime || row['Lead Time'] || row.lead_time) {
                        entry.lead_time = String(row.LeadTime || row['Lead Time'] || row.lead_time).trim();
                    }
                    if (row.Shipping || row.shipping) entry.shipping = String(row.Shipping || row.shipping).trim();
                    if (row.QuoteNumber || row['Quote #'] || row.quote_number) {
                        entry.quote_number = String(row.QuoteNumber || row['Quote #'] || row.quote_number).trim();
                    }
                    if (row.Incoterms || row.incoterms) entry.incoterms = String(row.Incoterms || row.incoterms).trim();

                    // Handle Main supplier flag
                    if (isMain) {
                        // Clear isMain from other suppliers
                        item.suppliers.forEach(s => { s.isMain = false; });
                        entry.isMain = true;

                        // Set item's main supplier fields
                        item.supplier = supplierName;
                        if (prices[0]) {
                            item.price_1 = prices[0].price;
                        }
                        if (prices[1]) {
                            item.price_2 = prices[1].price;
                        }
                        item.currency = entry.currency;
                        if (entry.shipping) item.shipping_cost = entry.shipping;
                    }

                    // Update legacy price fields on supplier
                    if (prices[0]) entry.price = prices[0].price;
                    if (prices[1]) entry.price_2 = prices[1].price;

                    result.updated++;
                    result.suppliers.add(supplierName);
                });

                // Recalculate EUR values for all updated items and sync legacy fields
                currentProject.items.forEach(item => {
                    syncItemFromSuppliers(item);
                });

                // Persist changes
                try {
                    updateProject(currentProject);
                    // Refresh ALL UI views
                    try { renderCompactTable(); } catch (e) { }
                    try { updateStats(); } catch (e) { }
                    try { updateSupplierFilter(); } catch (e) { }
                    try { renderDashboard(); } catch (e) { }
                    try { renderMainOverview(); } catch (e) { }
                    try { renderSidebar(); } catch (e) { }
                } catch (e) {
                    console.error('Failed to save multi-supplier import:', e);
                }

                return result;
            }

            // Sync item legacy fields from suppliers array (used after bulk imports)
            function syncItemFromSuppliers(item) {
                if (!item || !Array.isArray(item.suppliers)) return;

                // Find main supplier
                const mainSup = item.suppliers.find(s => s.isMain);

                if (mainSup) {
                    const supName = mainSup.supplier_name || mainSup.name || mainSup.supplier || '';
                    item.supplier = supName;

                    // Get first price
                    let price1 = 0;
                    if (mainSup.prices && mainSup.prices[0]) {
                        price1 = parseFloat(mainSup.prices[0].price) || 0;
                    }
                    if (!price1) {
                        price1 = parseFloat(mainSup.price_1 || mainSup.price) || 0;
                    }

                    if (price1 > 0) {
                        item.price_1 = price1;
                    }

                    // Get second price
                    let price2 = 0;
                    if (mainSup.prices && mainSup.prices[1]) {
                        price2 = parseFloat(mainSup.prices[1].price) || 0;
                    }
                    if (!price2) {
                        price2 = parseFloat(mainSup.price_2) || 0;
                    }
                    if (price2 > 0) {
                        item.price_2 = price2;
                    }

                    if (mainSup.currency) item.currency = mainSup.currency;
                    if (mainSup.moq) item.moq = mainSup.moq;
                    if (mainSup.lead_time) item.lead_time = mainSup.lead_time;
                    if (mainSup.incoterms) item.incoterms = mainSup.incoterms;
                }

                // Note: Item status is NOT synced from suppliers - user sets it manually in Item Details
                // Suppliers have their own status (Planned, RFQ Sent, Quoted, Done) which is separate

                // Recalculate EUR values
                try {
                    calculateEuroValues(item);
                } catch (e) { }
            }

            const btnAddNewSupplier = getEl('btn-add-new-supplier');
            if (btnAddNewSupplier && !btnAddNewSupplier.dataset.listenerAdded) {
                btnAddNewSupplier.addEventListener('click', async () => {
                    const newName = await window.showPromptDialog({
                        title: 'Add New Supplier',
                        message: 'Enter new supplier name:',
                        placeholder: 'Supplier name'
                    });
                    if (newName && newName.trim()) {
                        select.innerHTML += `<option value="${newName.trim()}">${newName.trim()}</option>`;
                        select.value = newName.trim();
                        select.dispatchEvent(new Event('change'));
                    }
                });
                btnAddNewSupplier.dataset.listenerAdded = 'true';
            }

            // If supplier is selected, populate table
            if (select && select.value) {
                populateBulkPricingTable(select.value);
            }
            try { syncTopbarUploadQuoteState(); } catch (e) { }
        }

        function saveBulkPageToMemory() {
            const tbody = document.querySelector('#table-bulk-pricing tbody');
            if (!tbody) return;
            const supplierName = getEl('bulk-supplier-select')?.value;
            if (!supplierName) return;

            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                const firstInput = row.querySelector('.bulk-row-checkbox');
                if (!firstInput) return;
                const index = parseInt(firstInput.dataset.index);
                if (isNaN(index)) return;

                const item = currentProject.items[index];
            try { _acquireItemDetailLock(item, index); } catch (_) { }
                ensureItemShape(item);
                if (!item) return;

                const priceInputs = row.querySelectorAll('.price-qty-input');
                let hasAnyPrice = false;
                const prices = [];

                const itemQtys = [
                    parseFloat(item.qty_1) || 0,
                    parseFloat(item.qty_2) || 0,
                    parseFloat(item.qty_3) || 0,
                    parseFloat(item.qty_4) || 0,
                    parseFloat(item.qty_5) || 0
                ];

                priceInputs.forEach((input, qtyIdx) => {
                    const qtyValue = itemQtys[qtyIdx];
                    if (qtyValue === 0) return;
                    const val = input.value.trim();
                    if (val) {
                        prices.push({ qty: qtyValue, price: val });
                        hasAnyPrice = true;
                    }
                });

                const currency = row.querySelector('.currency-select')?.value || 'EUR';
                const moq = row.querySelector('.moq-input')?.value.trim() || '';
                const mov = row.querySelector('.mov-input')?.value.trim() || '';
                const quote = row.querySelector('.quote-input')?.value.trim() || '';
                const lead = row.querySelector('.leadtime-input')?.value.trim() || '';
                const shipping = row.querySelector('.shipping-input')?.value.trim() || '';
                const isMain = row.querySelector('.bulk-main-checkbox')?.checked || false;

                if (hasAnyPrice) {
                    if (!item.suppliers) item.suppliers = [];
                    const existingIndex = item.suppliers.findIndex(s => s.name === supplierName);

                    const supplierData = {
                        id: existingIndex >= 0 ? item.suppliers[existingIndex].id : Date.now() + index,
                        name: supplierName,
                        prices: prices,
                        currency: currency,
                        moq: moq,
                        mov: mov,
                        quote_number: quote,
                        lead_time: lead,
                        shipping: shipping,
                        isMain: isMain,
                        price: prices[0]?.price || '',
                        price_2: prices[1]?.price || ''
                    };

                    if (existingIndex >= 0) {
                        item.suppliers[existingIndex] = supplierData;
                    } else {
                        item.suppliers.push(supplierData);
                    }

                    if (isMain) {
                        item.suppliers.forEach(s => { if (s.name !== supplierName) s.isMain = false; });
                        item.supplier = supplierName;
                        item.price_1 = prices[0]?.price || '';
                        item.price_2 = prices[1]?.price || '';
                        item.currency = currency;
                        item.shipping_cost = shipping;
                    }
                    calculateEuroValues(item);
                }
            });

            // Persist bulk edits once (avoid per-row updates)
            try {
                syncProjectBatchesIntoMemory(currentProject);
                syncAllBatchesToItems(currentProject);
                updateProject(currentProject);
            } catch (e) {
                console.warn('Bulk pricing memory sync failed:', e);
            }
        }

        function populateBulkPricingTable(supplierName, page = 1) {
            if (!currentProject || !currentProject.items) return;

            getEl('bulk-pricing-empty').classList.add('hidden');
            getEl('bulk-pricing-table-wrapper').classList.remove('hidden');

            const table = document.querySelector('#table-bulk-pricing');
            const thead = table?.querySelector('thead');
            const tbody = table?.querySelector('tbody');
            if (!thead || !tbody) return;

            let filteredItems = currentProject.items;

            const tAny = (bulkPricingFilterText || '').trim().toLowerCase();
            const tPart = (bulkPricingFilterPart || '').trim().toLowerCase();
            const tMfr = (bulkPricingFilterMfr || '').trim().toLowerCase();
            const tDesc = (bulkPricingFilterDesc || '').trim().toLowerCase();

            if (tAny || tPart || tMfr || tDesc) {
                filteredItems = currentProject.items.filter(item => {
                    const partStr = [
                        item.item_drawing_no, item.line, item.drawing_no, item.part_no, item.part_number,
                        item.mpn, item.mfg_part_no, item.part, item.partno
                    ].filter(Boolean).join(' ').toLowerCase();

                    const mfrStr = [
                        item.manufacturer, item.mfr, item.maker, item.brand
                    ].filter(Boolean).join(' ').toLowerCase();

                    const descStr = [
                        item.description, item.desc
                    ].filter(Boolean).join(' ').toLowerCase();

                    const anyStr = (partStr + ' ' + mfrStr + ' ' + descStr).trim();

                    if (tPart && !partStr.includes(tPart)) return false;
                    if (tMfr && !mfrStr.includes(tMfr)) return false;
                    if (tDesc && !descStr.includes(tDesc)) return false;
                    if (tAny && !anyStr.includes(tAny)) return false;

                    return true;
                });
            }

            const totalPages = Math.ceil(filteredItems.length / bulkItemsPerPage) || 1;

            if (page < 1) page = 1;
            if (page > totalPages) page = totalPages;
            bulkCurrentPage = page;

            renderBulkToolbar(supplierName, filteredItems.length);

            const headerRow = `
                <tr>
                    <th style="width: 40px;"><input type="checkbox" id="bulk-select-all"></th>
                    <th style="width: 100px;">Part No.</th>
                    <th style="width: 200px;">Description</th>
                    <th style="width: 50px;">Unit</th>
                    <th style="width: 90px;">Price @QTY1</th>
                    <th style="width: 90px;">Price @QTY2</th>
                    <th style="width: 90px;">Price @QTY3</th>
                    <th style="width: 90px;">Price @QTY4</th>
                    <th style="width: 90px;">Price @QTY5</th>
                    <th style="width: 80px;">Currency</th>
                    <th style="width: 80px;">MOQ</th>
                    <th style="width: 80px;">MOV</th>
                    <th style="width: 120px;">Quote #</th>
                    <th style="width: 100px;">Lead Time</th>
                    <th style="width: 80px;">Shipping</th>
                    <th style="width: 70px;">Main</th>
                </tr>
            `;
            thead.innerHTML = headerRow;

            const startIndex = (bulkCurrentPage - 1) * bulkItemsPerPage;
            const endIndex = Math.min(startIndex + bulkItemsPerPage, filteredItems.length);
            const visibleItems = filteredItems.slice(startIndex, endIndex);

            let rowsHtml = '';
            visibleItems.forEach((item, sliceIndex) => {
                const globalIndex = currentProject.items.indexOf(item);
                const existingSupplier = item.suppliers?.find(s => s.name === supplierName);

                const itemQtys = [
                    parseFloat(item.qty_1) || 0,
                    parseFloat(item.qty_2) || 0,
                    parseFloat(item.qty_3) || 0,
                    parseFloat(item.qty_4) || 0,
                    parseFloat(item.qty_5) || 0
                ];

                const existingPrices = existingSupplier?.prices || [];
                const currentCurrency = existingSupplier?.currency || item.currency || 'EUR';
                const currentMOQ = existingSupplier?.moq || '';
                const currentMOV = existingSupplier?.mov || '';
                const currentQuoteNumber = existingSupplier?.quote_number || '';
                const currentLeadTime = existingSupplier?.lead_time || '';
                const currentShippingRaw = (existingSupplier && (existingSupplier.shipping ?? existingSupplier.shipping_cost)) ?? item.shipping_cost ?? '';
                const currentShipping = toNumberInputValue(currentShippingRaw);
                const isMain = existingSupplier?.isMain || false;

                const priceColumns = itemQtys.map((qty, qtyIdx) => {
                    if (qty === 0) return `<td style="background: #f5f5f5;"><span style="color: #999; font-size: 11px;">-</span></td>`;
                    const existingPrice = existingPrices.find(p => p.qty === qty);
                    const currentValue = existingPrice?.price || '';
                    return `
                        <td>
                            <input type="number" step="0.01" class="bulk-input price-qty-input" 
                                data-index="${globalIndex}" data-qty="${qty}" data-qty-index="${qtyIdx}"
                                placeholder="@${qty}" value="" style="width: 85px; font-size: 11px;" title="Price for ${qty}">
                            ${currentValue ? `<div style="font-size: 10px; color: #999; pointer-events:none;">Was: ${currentValue}</div>` : ''}
                        </td>`;
                }).join('');

                rowsHtml += `
                    <tr>
                        <td><input type="checkbox" class="bulk-row-checkbox" data-index="${globalIndex}"></td>
                        <td style="font-weight: 600;">${item.item_drawing_no || item.line || '-'}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 11px;" title="${item.description}">${item.description || '-'}</td>
                        <td style="font-size: 11px;">${item.unit || 'pcs'}</td>
                        ${priceColumns}
                        <td>
                            <select class="bulk-input currency-select" data-index="${globalIndex}" style="width: 75px; font-size: 11px;">
                                <option value="EUR" ${currentCurrency === 'EUR' ? 'selected' : ''}>EUR</option>
                                <option value="USD" ${currentCurrency === 'USD' ? 'selected' : ''}>USD</option>
                                <option value="CZK" ${currentCurrency === 'CZK' ? 'selected' : ''}>CZK</option>
                                <option value="GBP" ${currentCurrency === 'GBP' ? 'selected' : ''}>GBP</option>
                            </select>
                        </td>
                        <td><input type="text" class="bulk-input moq-input" data-index="${globalIndex}" value="${currentMOQ}" style="width: 75px; font-size: 11px;"></td>
                        <td><input type="text" class="bulk-input mov-input" data-index="${globalIndex}" value="${currentMOV}" style="width: 75px; font-size: 11px;"></td>
                        <td><input type="text" class="bulk-input quote-input" data-index="${globalIndex}" value="${currentQuoteNumber}" style="width: 115px; font-size: 11px;"></td>
                        <td><input type="text" class="bulk-input leadtime-input" data-index="${globalIndex}" value="${currentLeadTime}" style="width: 95px; font-size: 11px;"></td>
                        <td><input type="number" step="0.01" class="bulk-input shipping-input" data-index="${globalIndex}" value="${currentShipping}" style="width: 75px; font-size: 11px;"></td>
                        <td style="text-align: center;"><input type="checkbox" class="bulk-main-checkbox" data-index="${globalIndex}" ${isMain ? 'checked' : ''}></td>
                    </tr>
                `;
            });
            tbody.innerHTML = rowsHtml;

            if (!tbody.dataset.eventsAttached) {
                tbody.addEventListener('input', (e) => {
                    if (e.target.classList.contains('bulk-input') || e.target.classList.contains('bulk-main-checkbox')) {
                        getEl('btn-save-bulk-prices').disabled = false;
                    }
                });
                tbody.dataset.eventsAttached = 'true';
            }

            const selectAll = getEl('bulk-select-all');
            if (selectAll) {
                selectAll.onclick = () => {
                    const checkboxes = tbody.querySelectorAll('.bulk-row-checkbox');
                    checkboxes.forEach(cb => cb.checked = selectAll.checked);
                };
            }

            renderPaginationControls(filteredItems.length, supplierName);
        }

        function renderBulkToolbar(supplierName, totalItems) {
            let toolbar = getEl('bulk-toolbar');
            if (!toolbar) {
                toolbar = document.createElement('div');
                toolbar.id = 'bulk-toolbar';
                toolbar.style.cssText = 'padding: 10px 20px; background: #fafafa; border-bottom: 1px solid #eee; display: flex; gap: 10px; align-items: center; justify-content: space-between;';
                const wrapper = getEl('bulk-pricing-table-wrapper');
                wrapper.parentNode.insertBefore(toolbar, wrapper);
            }


            toolbar.innerHTML = `
                <div style="display: flex; gap: 10px; align-items: center; flex: 1; flex-wrap: wrap;">
                    <span style="font-weight: 600; color: #333;">Filter:</span>
                    <input type="text" id="bulk-filter-part" class="rfq-input" placeholder="Part No / Drawing No / MPN" value="${bulkPricingFilterPart}" style="width: 220px;">
                    <input type="text" id="bulk-filter-mfr" class="rfq-input" placeholder="Manufacturer" value="${bulkPricingFilterMfr}" style="width: 200px;">
                    <input type="text" id="bulk-filter-desc" class="rfq-input" placeholder="Description" value="${bulkPricingFilterDesc}" style="width: 240px;">
                    <input type="text" id="bulk-filter-any" class="rfq-input" placeholder="Any (optional)" value="${bulkPricingFilterText}" style="width: 180px;">
                    ${(bulkPricingFilterPart || bulkPricingFilterMfr || bulkPricingFilterDesc || bulkPricingFilterText) ? `<button id="btn-clear-bulk-filter" class="macos-btn" style="padding: 4px 8px; font-size: 11px;">Clear</button>` : ''}
                    <span style="font-size: 12px; color: #666; margin-left: 10px;">Found: <b>${totalItems}</b> items</span>
                </div>
            `;

            const partInput = getEl('bulk-filter-part');
            const mfrInput = getEl('bulk-filter-mfr');
            const descInput = getEl('bulk-filter-desc');
            const anyInput = getEl('bulk-filter-any');

            const applyFilters = () => {
                saveBulkPageToMemory();
                populateBulkPricingTable(supplierName, 1);
            };

            if (partInput) {
                partInput.oninput = (e) => {
                    bulkPricingFilterPart = e.target.value;
                    applyFilters();
                };
            }
            if (mfrInput) {
                mfrInput.oninput = (e) => {
                    bulkPricingFilterMfr = e.target.value;
                    applyFilters();
                };
            }
            if (descInput) {
                descInput.oninput = (e) => {
                    bulkPricingFilterDesc = e.target.value;
                    applyFilters();
                };
            }
            if (anyInput) {
                anyInput.oninput = (e) => {
                    bulkPricingFilterText = e.target.value;
                    applyFilters();
                };
            }

            const btnClear = getEl('btn-clear-bulk-filter');
            if (btnClear) {
                btnClear.onclick = () => {
                    saveBulkPageToMemory();
                    bulkPricingFilterText = '';
                    bulkPricingFilterPart = '';
                    bulkPricingFilterMfr = '';
                    bulkPricingFilterDesc = '';
                    populateBulkPricingTable(supplierName, 1);
                };
            }
        }

        function renderPaginationControls(totalItems, supplierName) {
            let controls = getEl('bulk-pagination');
            if (!controls) {
                controls = document.createElement('div');
                controls.id = 'bulk-pagination';
                controls.className = 'pagination-controls';
                const wrapper = getEl('bulk-pricing-table-wrapper');
                wrapper.parentNode.insertBefore(controls, wrapper.nextSibling);
            }

            const totalPages = Math.ceil(totalItems / bulkItemsPerPage) || 1;

            controls.innerHTML = `
                <div style="display: flex; align-items: center; gap: 5px;">
                    <button id="btn-first-page" class="page-btn" title="First Page" ${bulkCurrentPage === 1 ? 'disabled' : ''}>&lt;&lt;</button>
                    <button id="btn-prev-page" class="page-btn" title="Previous Page" ${bulkCurrentPage === 1 ? 'disabled' : ''}>&lt; Prev</button>
                </div>
                
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span class="page-info">Page ${bulkCurrentPage} of ${totalPages}</span>
                    <select id="bulk-page-select" class="macos-select" style="padding: 2px 6px; font-size: 11px;">
                         ${Array.from({ length: totalPages }, (_, i) => i + 1).map(p => `<option value="${p}" ${p === bulkCurrentPage ? 'selected' : ''}>${p}</option>`).join('')}
                    </select>
                </div>
                
                <div style="display: flex; align-items: center; gap: 5px;">
                    <button id="btn-next-page" class="page-btn" title="Next Page" ${bulkCurrentPage === totalPages ? 'disabled' : ''}>Next &gt;</button>
                    <button id="btn-last-page" class="page-btn" title="Last Page" ${bulkCurrentPage === totalPages ? 'disabled' : ''}>&gt;&gt;</button>
                </div>
             `;

            const handlePageChange = (newPage) => {
                if (newPage >= 1 && newPage <= totalPages) {
                    saveBulkPageToMemory();
                    populateBulkPricingTable(supplierName, newPage);
                }
            };

            getEl('btn-first-page').onclick = () => handlePageChange(1);
            getEl('btn-prev-page').onclick = () => handlePageChange(bulkCurrentPage - 1);
            getEl('btn-next-page').onclick = () => handlePageChange(bulkCurrentPage + 1);
            getEl('btn-last-page').onclick = () => handlePageChange(totalPages);

            getEl('bulk-page-select').onchange = (e) => handlePageChange(parseInt(e.target.value));
        }

        function saveBulkPrices() {
            saveBulkPageToMemory();
            // Note: updateProject() is already called inside saveBulkPageToMemory()

            // Explicit re-renders to ensure data propagates to all views
            try { renderCompactTable(); } catch (e) { }
            try { updateStats(); } catch (e) { }
            try { renderDashboard(); } catch (e) { }

            getEl('btn-save-bulk-prices').disabled = true;
            if (window.showToast) window.showToast('All changes saved successfully!', 'success');
        }


        // Bulk Supplier Pricing ‚Äì Import Quote (Excel/CSV)
        function bulkNormKey(v) {
            return String(v ?? '').trim().toUpperCase();
        }
        function bulkItemDrawingNo(item) {
            return String(item?.item_drawing_no || item?.drawing_no || item?.part_no || item?.part_number || item?.line || item?.mpn || '').trim();
        }
        function bulkFindItemByDrawingNo(dn) {
            const key = bulkNormKey(dn);
            if (!key) return null;
            const items = (currentProject && Array.isArray(currentProject.items)) ? currentProject.items : [];
            for (const it of items) {
                const cand = bulkNormKey(bulkItemDrawingNo(it));
                if (cand && cand === key) return it;
            }
            return null;
        }
        function bulkEnsureSupplierEntry(item, supplierName) {
            if (!item.suppliers || !Array.isArray(item.suppliers)) item.suppliers = [];
            let s = item.suppliers.find(x => String(x.name || '').trim() === String(supplierName || '').trim());
            if (!s) {
                s = { name: String(supplierName || '').trim(), prices: [], currency: 'EUR', quote_status: '', isMain: false };
                item.suppliers.push(s);
            }
            if (!Array.isArray(s.prices)) s.prices = [];
            return s;
        }
        function bulkUpsertPrice(entry, qty, price) {
            const q = Number(qty);
            const p = Number(price);
            if (!Number.isFinite(q) || q <= 0) return false;
            if (!Number.isFinite(p)) return false;
            const arr = entry.prices || (entry.prices = []);
            const idx = arr.findIndex(x => Number(x.qty) === q);
            if (idx >= 0) arr[idx] = { qty: q, price: p };
            else arr.push({ qty: q, price: p });
            return true;
        }
        function bulkApplyImportedRows(supplierName, rows) {
            if (!currentProject || !Array.isArray(currentProject.items)) return { updated: 0, skipped: 0 };
            const sup = String(supplierName || '').trim();
            if (!sup) return { updated: 0, skipped: 0 };

            let updated = 0;
            let skipped = 0;

            (rows || []).forEach(r => {
                const dn = r.DrawingNo || r['Drawing No'] || r.Drawing || r.PartNo || r['Part No'] || r.MPN || r.mpn || r.item_drawing_no || r.drawing_no || r.part_no || r.part_number;
                const item = bulkFindItemByDrawingNo(dn);
                if (!item) { skipped++; return; }

                const entry = bulkEnsureSupplierEntry(item, sup);

                const currency = r.Currency || r.currency || entry.currency || item.currency || 'EUR';
                entry.currency = String(currency || 'EUR').trim().toUpperCase() || 'EUR';

                if (r.Incoterms || r.incoterms) entry.incoterms = String(r.Incoterms || r.incoterms).trim();
                if (r.LeadTime || r['Lead Time'] || r.lead_time) entry.lead_time = String(r.LeadTime || r['Lead Time'] || r.lead_time).trim();
                if (r.MOQ || r.moq) entry.moq = String(r.MOQ || r.moq).trim();
                if (r.MOV || r.mov) entry.mov = String(r.MOV || r.mov).trim();
                if (r.ValidUntil || r['Valid Until'] || r.valid_until) entry.valid_until = String(r.ValidUntil || r['Valid Until'] || r.valid_until).trim();
                if (r.QuoteNumber || r['Quote #'] || r.quote_number) entry.quote_number = String(r.QuoteNumber || r['Quote #'] || r.quote_number).trim();
                if (r.Notes || r.notes) entry.notes = String(r.Notes || r.notes).trim();

                // gather qty tiers from item
                const tiers = [
                    Number(item.qty_1) || 0,
                    Number(item.qty_2) || 0,
                    Number(item.qty_3) || 0,
                    Number(item.qty_4) || 0,
                    Number(item.qty_5) || 0,
                ].filter(x => x > 0);

                // read up to 10 qty/price pairs from row
                let anyPrice = false;
                for (let i = 1; i <= 10; i++) {
                    const qv = r['Qty_' + i] ?? r['QTY_' + i] ?? r['qty_' + i] ?? r['Qty ' + i] ?? r['Q' + i] ?? r['qty' + i];
                    const pv = r['Price_' + i] ?? r['PRICE_' + i] ?? r['price_' + i] ?? r['Price ' + i] ?? r['P' + i] ?? r['price' + i];
                    const q = Number(String(qv ?? '').replace(',', '.'));
                    const p = Number(String(pv ?? '').replace(',', '.'));
                    if (!Number.isFinite(p) || String(pv ?? '').trim() === '') continue;

                    // if qty present, match by qty; else by item tier index
                    if (Number.isFinite(q) && q > 0) {
                        bulkUpsertPrice(entry, q, p);
                        anyPrice = true;
                    } else {
                        const tierQty = tiers[i - 1];
                        if (tierQty) {
                            bulkUpsertPrice(entry, tierQty, p);
                            anyPrice = true;
                        }
                    }
                }

                // Fallback: if template provides Price@QTY1..5 without Qty columns
                for (let i = 1; i <= 5; i++) {
                    const pv = r['Price @QTY' + i] ?? r['Price@QTY' + i] ?? r['Price_QTY' + i] ?? r['PriceQ' + i];
                    const p = Number(String(pv ?? '').replace(',', '.'));
                    if (!Number.isFinite(p) || String(pv ?? '').trim() === '') continue;
                    const tierQty = tiers[i - 1];
                    if (tierQty) { bulkUpsertPrice(entry, tierQty, p); anyPrice = true; }
                }

                // status
                const st = String(r.Status || r.status || '').trim();
                if (st) entry.quote_status = st;
                else if (anyPrice) entry.quote_status = 'Quoted';

                updated++;
            });

            // persist
            try { updateProject(currentProject); } catch (e) { console.error(e); }

            return { updated, skipped };
        }



        function renderGlobalSupplierList() {
            try {
                if (!Array.isArray(projects)) return;

                const table = getEl('table-supplier-list');
                const listContent = table ? table.querySelector('tbody') : null;
                if (!listContent) return;

                const searchEl = getEl('supplier-list-search');
                const term = String(searchEl ? searchEl.value : '').trim().toLowerCase();
                const mfrEl = getEl('supplier-list-mfr');
                const partEl = getEl('supplier-list-part');
                const termMfr = String(mfrEl ? mfrEl.value : '').trim().toLowerCase();
                const termPart = String(partEl ? partEl.value : '').trim().toLowerCase();

                const rates = (window.RFQData && window.RFQData.CURRENCY_RATES && typeof window.RFQData.CURRENCY_RATES === 'object')
                    ? window.RFQData.CURRENCY_RATES
                    : { EUR: 1 };

                const supplierMap = new Map(); // key: normalized name

                const norm = (v) => String(v ?? '').trim().toLowerCase();
                const safeCurrency = (v) => {
                    const c = String(v || '').trim().toUpperCase();
                    // protect against bad legacy data where incoterms was stored in currency field
                    if (!c) return 'EUR';
                    if (rates[c]) return c;
                    // common incoterms accidentally placed in currency
                    if (window.RFQData && Array.isArray(window.RFQData.INCOTERMS) && window.RFQData.INCOTERMS.includes(c)) return 'EUR';
                    return rates[c] ? c : 'EUR';
                };

                const ensureRec = (name) => {
                    const display = String(name ?? '').trim();
                    if (!display) return null;
                    const key = norm(display);
                    if (!key) return null;
                    if (!supplierMap.has(key)) {
                        supplierMap.set(key, {
                            name: display,
                            projectIds: new Set(),
                            itemCount: 0,
                            totalValue: 0,
                            rating: 0,
                            status: 'Active',
                            pipeline: '',
                            _itemKeys: new Set(),
                            _searchTokens: new Set(),
                            _itemSearch: '',
                        });
                    }
                    const rec = supplierMap.get(key);
                    if (!rec.name) rec.name = display;
                    return rec;
                };

                const addSupplierOnly = (proj, name, meta) => {
                    const rec = ensureRec(name);
                    if (!rec) return;
                    rec.projectIds.add(String(proj && proj.id || ''));
                    if (meta && typeof meta === 'object') {
                        if (meta.pipeline && !rec.pipeline) rec.pipeline = String(meta.pipeline);
                        const r = Number(meta.rating || 0) || 0;
                        if (r > rec.rating) rec.rating = r;
                        if (meta.status && !rec.status) rec.status = String(meta.status);
                    }
                };

                const addSupplierFromItem = (proj, item, name, supRec) => {
                    const rec = ensureRec(name);
                    if (!rec) return;
                    rec.projectIds.add(String(proj && proj.id || ''));

                    const dn = String(item?.item_drawing_no || item?.drawing_no || '').trim() || String(item?.line || '').trim();
                    const uniqKey = `${proj.id}|${dn || (item && item._id) || ''}`;
                    if (rec._itemKeys.has(uniqKey)) return;
                    rec._itemKeys.add(uniqKey);

                    rec.itemCount += 1;
                    // tokens for cross-filtering (manufacturer / part / drawing / description)
                    const mfrTok = String(item?.manufacturer || '').trim();
                    const mpnTok = String(item?.mpn || item?.MPN || item?.manufacturer_part_no || item?.mfr_part_no || item?.part_no || item?.item_mpn || item?.manufacturer_partnumber || '').trim();
                    const descTok = String(item?.description || '').trim();
                    [dn, mfrTok, mpnTok, descTok].forEach(tok => {
                        const t = String(tok || '').trim();
                        if (!t) return;
                        if (rec._searchTokens && typeof rec._searchTokens.add === 'function') {
                            rec._searchTokens.add(t.toLowerCase());
                        }
                    });


                    const qty1 = parseFloat(String(item?.qty_1 ?? '').replace(',', '.')) || 0;

                    // price preference: supplier-specific price_1, otherwise legacy item price_1
                    const pRaw = (supRec && (supRec.price_1 ?? supRec.price)) ?? item?.price_1 ?? item?.price ?? item?.price_1_euro ?? 0;
                    const p = parseFloat(String(pRaw ?? '').replace(',', '.'));
                    const price = Number.isFinite(p) ? p : 0;

                    const currency = safeCurrency((supRec && supRec.currency) ? supRec.currency : (item?.currency || 'EUR'));
                    const rate = Number(rates[currency] ?? 1) || 1;

                    const value = qty1 * price * rate;
                    if (Number.isFinite(value)) rec.totalValue += value;
                };

                const resolveSupplierNameFromItemSup = (proj, s) => {
                    if (!s || typeof s !== 'object') return '';
                    const direct = String(s.name || s.supplier_name || s.supplier || '').trim();
                    if (direct) return direct;
                    if (s.master_id) {
                        const m = getSupplierMasterById(proj, s.master_id);
                        if (m && m.name) return String(m.name).trim();
                    }
                    if (s.supplier_id) {
                        const m = getSupplierMasterById(proj, s.supplier_id);
                        if (m && m.name) return String(m.name).trim();
                    }
                    return '';
                };

                const hasSupplierInProject = (proj, supplierName) => {
                    const nn = norm(supplierName);
                    if (!nn) return false;

                    // supplierMaster
                    if (Array.isArray(proj.supplierMaster) && proj.supplierMaster.some(sm => norm(sm && sm.name) === nn)) return true;

                    // supplierData legacy
                    if (proj.supplierData && typeof proj.supplierData === 'object') {
                        const keys = Object.keys(proj.supplierData || {});
                        if (keys.some(k => norm(k) === nn)) return true;
                    }

                    // items
                    if (Array.isArray(proj.items)) {
                        for (const it of proj.items) {
                            if (norm(it && it.supplier) === nn) return true;
                            if (Array.isArray(it && it.suppliers)) {
                                for (const s of it.suppliers) {
                                    const nm = resolveSupplierNameFromItemSup(proj, s);
                                    if (norm(nm) === nn) return true;
                                }
                            }
                        }
                    }

                    // bundles
                    const batches = getProjectBatches(proj);
                    if (Array.isArray(batches) && batches.some(b => norm(b && (b.supplier_name || b.supplier)) === nn)) return true;

                    return false;
                };

                // Build map across all projects
                projects.forEach(p => {
                    if (!p || typeof p !== 'object') return;
                    try { ensureProjectSuppliers(p); } catch (e) { }

                    // Supplier Master DB
                    if (Array.isArray(p.supplierMaster)) {
                        p.supplierMaster.forEach(sm => {
                            const nm = String(sm?.name || '').trim();
                            if (!nm) return;
                            addSupplierOnly(p, nm, { rating: sm?.rating, pipeline: sm?.pipeline, status: 'Active' });
                        });
                    }

                    // Legacy supplierData bucket
                    if (p.supplierData && typeof p.supplierData === 'object') {
                        Object.keys(p.supplierData || {}).forEach(k => {
                            const nm = String(k || '').trim();
                            if (!nm) return;
                            addSupplierOnly(p, nm, { status: 'Active' });
                        });
                    }

                    // Bundles supplier names
                    getProjectBatches(p).forEach(b => {
                        const nm = String(b && (b.supplier_name || b.supplier) || '').trim();
                        if (!nm) return;
                        addSupplierOnly(p, nm, { status: 'Active' });
                    });

                    // From items
                    const items = Array.isArray(p.items) ? p.items : [];
                    items.forEach(it => {
                        if (!it) return;

                        // Main supplier legacy
                        const main = String(it.supplier || '').trim();
                        if (main) {
                            const supRec = Array.isArray(it.suppliers) ? it.suppliers.find(s => norm(resolveSupplierNameFromItemSup(p, s) || (s && s.name)) === norm(main)) : null;
                            addSupplierFromItem(p, it, main, supRec);
                        }

                        // Targeted suppliers list
                        if (Array.isArray(it.suppliers)) {
                            it.suppliers.forEach(s => {
                                const nm = resolveSupplierNameFromItemSup(p, s);
                                if (!nm) return;
                                addSupplierFromItem(p, it, nm, s);
                            });
                        }
                    });
                });

                let supplierArray = Array.from(supplierMap.values());

                // finalize search text (for manufacturer/part filters)
                supplierArray.forEach(s => {
                    try {
                        if (!s) return;
                        if (!s._itemSearch) {
                            const toks = (s._searchTokens && typeof s._searchTokens.forEach === 'function') ? Array.from(s._searchTokens) : [];
                            s._itemSearch = toks.join(' ');
                        }
                    } catch (e) { }
                });


                // search
                if (term) supplierArray = supplierArray.filter(s => String(s.name || '').toLowerCase().includes(term));

                if (termMfr) supplierArray = supplierArray.filter(s => String(s._itemSearch || '').toLowerCase().includes(termMfr));
                if (termPart) supplierArray = supplierArray.filter(s => String(s._itemSearch || '').toLowerCase().includes(termPart));

                // sorting
                const sort = window.currentSupplierSort;
                if (sort && sort.field) {
                    const field = sort.field;
                    const dir = sort.dir === 'desc' ? 'desc' : 'asc';
                    supplierArray.sort((a, b) => {
                        let A, B;
                        if (field === 'projects') { A = a.projectIds.size; B = b.projectIds.size; }
                        else if (field === 'items') { A = a.itemCount; B = b.itemCount; }
                        else if (field === 'value') { A = a.totalValue; B = b.totalValue; }
                        else if (field === 'status') { A = String(a.status || ''); B = String(b.status || ''); }
                        else { A = String(a.name || '').toLowerCase(); B = String(b.name || '').toLowerCase(); }
                        if (A < B) return dir === 'asc' ? -1 : 1;
                        if (A > B) return dir === 'asc' ? 1 : -1;
                        return 0;
                    });
                } else {
                    supplierArray.sort((a, b) => String(a.name || '').localeCompare(String(b.name || '')));
                }

                if (!supplierArray.length) {
                    listContent.innerHTML = `<tr><td colspan="6" style="padding:18px; color:#777;">No suppliers found.</td></tr>`;
                    return;
                }

                listContent.innerHTML = supplierArray.map(s => `
                    <tr>
                        <td>
                            <b class="sl-supplier-link" style="color:#007AFF; cursor:pointer; text-decoration:underline;">${escapeHtml(String(s.name || ''))}</b>
                            ${s.rating > 0 ? `<span style="margin-left:6px; color:#FFD700;">${'‚òÖ'.repeat(Math.min(5, Math.max(1, Math.ceil(s.rating))))}</span>` : ''}
                        </td>
                        <td>
                            <span style="padding:2px 8px; border-radius:10px; font-size:11px; background:#e6ffeb; color:#34C759;">
                                ${escapeHtml(String(s.status || 'Active'))}
                            </span>
                        </td>
                        <td>${s.projectIds.size}</td>
                        <td>${s.itemCount}</td>
                        <td>‚Ç¨${formatPrice(s.totalValue || 0)}</td>
                        <td><button class="btn-secondary btn-open-supplier-detail" data-supplier="${escapeAttr(String(s.name || ''))}">Open</button></td>
                    </tr>
                `).join('');

                // bind clicks once
                if (!listContent.dataset.boundDetail) {
                    listContent.dataset.boundDetail = '1';
                    listContent.addEventListener('click', (e) => {
                        const btn = e.target.closest('.btn-open-supplier-detail');
                        const link = e.target.closest('.sl-supplier-link');
                        if (!btn && !link) return;

                        const row = e.target.closest('tr');
                        if (!row) return;
                        const name = btn ? btn.dataset.supplier : (row.querySelector('.sl-supplier-link') ? row.querySelector('.sl-supplier-link').textContent : '');
                        const supName = String(name || '').trim();
                        if (!supName) return;

                        // If no currentProject selected, pick a project where the supplier exists
                        if (!currentProject) {
                            const proj = (projects || []).find(p => p && hasSupplierInProject(p, supName));
                            if (proj) openProject(proj);
                        }

                        if (typeof window.openSupplierDetail === 'function') window.openSupplierDetail(supName);
                        e.preventDefault();
                        e.stopPropagation();
                    });
                }

                // Initialize/refresh pagination for supplier list table
                setTimeout(() => {
                    initTablePagination('table-supplier-list', { storageKey: 'rfq_supplier_list_page' });
                }, 50);
            } catch (e) {
                console.error(e);
                const table = getEl('table-supplier-list');
                const listContent = table ? table.querySelector('tbody') : null;
                if (listContent) {
                    listContent.innerHTML = `<tr><td colspan="6" style="padding:18px; color:#b00;">Supplier list error: ${escapeHtml(e && e.message ? e.message : String(e))}</td></tr>`;
                }
            }
        }



        // =========================================================
        // Project Supplier List (Current project only)
        // =========================================================
        function renderProjectSupplierList() {
            const tbl = getEl('table-proj-suppliers');
            const tbody = tbl ? tbl.querySelector('tbody') : null;
            if (!tbody) return;

            if (!currentProject || !Array.isArray(currentProject.items)) {
                tbody.innerHTML = `<tr><td colspan="7" style="padding:18px; color:#777;">Select a project first.</td></tr>`;
                return;
            }

            const term = String((getEl('proj-sup-search') && getEl('proj-sup-search').value) || '').trim().toLowerCase();
            const termMfr = String((getEl('proj-sup-mfr') && getEl('proj-sup-mfr').value) || '').trim().toLowerCase();
            const termPart = String((getEl('proj-sup-part') && getEl('proj-sup-part').value) || '').trim().toLowerCase();

            const norm = (v) => String(v ?? '').trim().toLowerCase();

            const supplierMap = new Map();

            const ensure = (name) => {
                const display = String(name || '').trim();
                if (!display) return null;
                const key = norm(display);
                if (!key) return null;
                if (!supplierMap.has(key)) {
                    supplierMap.set(key, {
                        name: display,
                        items: new Set(),
                        mainItems: new Set(),
                        quotedItems: new Set(),
                        openRfqs: 0,
                        _tokens: new Set(),
                    });
                }
                const rec = supplierMap.get(key);
                if (!rec.name) rec.name = display;
                return rec;
            };

            const safeNum = (v) => {
                const n = parseFloat(String(v ?? '').replace(',', '.'));
                return Number.isFinite(n) ? n : 0;
            };

            const batches = getProjectBatches(currentProject) || [];
            const openBySupplier = new Map();
            (Array.isArray(batches) ? batches : []).forEach(b => {
                const st = String(b && b.status || '').trim();
                const closed = /closed|won|lost/i.test(st);
                if (closed) return;
                const sn = String((b && (b.supplier_name || b.supplier)) || '').trim();
                if (!sn) return;
                const k = norm(sn);
                openBySupplier.set(k, (openBySupplier.get(k) || 0) + 1);
            });

            currentProject.items.forEach(it => {
                if (!it) return;
                const dn = String(it.item_drawing_no || it.drawing_no || it.line || '').trim();
                const mfr = String(it.manufacturer || '').trim();
                const mpn = String(it.mpn || it.MPN || it.manufacturer_part_no || it.mfr_part_no || it.part_no || it.item_mpn || '').trim();
                const desc = String(it.description || '').trim();

                const suppliers = Array.isArray(it.suppliers) ? it.suppliers : [];
                suppliers.forEach(s => {
                    const nm = String(s && (s.name || s.supplier_name || s.supplier) || '').trim();
                    if (!nm) return;
                    const rec = ensure(nm);
                    if (!rec) return;
                    if (dn) rec.items.add(dn);

                    [dn, mfr, mpn, desc].forEach(t => { const x = String(t || '').trim().toLowerCase(); if (x) rec._tokens.add(x); });

                    const isMain = !!(s.isMain || (String(it.supplier || '').trim() && norm(it.supplier) === norm(nm)));
                    if (isMain && dn) rec.mainItems.add(dn);

                    const hasQuote = safeNum(s.price_1 ?? s.price) > 0 || safeNum(s.price_2) > 0 || safeNum(s.price_3) > 0;
                    if (hasQuote && dn) rec.quotedItems.add(dn);
                });
            });

            // Attach open RFQ counts
            supplierMap.forEach((rec, key) => {
                rec.openRfqs = openBySupplier.get(key) || 0;
            });

            let arr = Array.from(supplierMap.values());

            // Filters
            if (term) arr = arr.filter(r => norm(r.name).includes(term));
            if (termMfr) arr = arr.filter(r => Array.from(r._tokens).some(t => t.includes(termMfr)));
            if (termPart) arr = arr.filter(r => Array.from(r._tokens).some(t => t.includes(termPart)));

            // Sort: open RFQs desc, then items desc
            arr.sort((a, b) => (b.openRfqs - a.openRfqs) || (b.items.size - a.items.size) || String(a.name).localeCompare(String(b.name)));

            if (!arr.length) {
                tbody.innerHTML = `<tr><td colspan="7" style="padding:18px; color:#777;">No suppliers found in this project.</td></tr>`;
                return;
            }

            const suggestionFor = (name, rec) => {
                const out = [];
                try {
                    const sd = (typeof getSupplierData === 'function') ? getSupplierData(name) : null;
                    const email = sd && sd.contact ? String(sd.contact.email || '').trim() : '';
                    if (!email) out.push('Missing email');
                } catch (e) { }
                if ((rec.quotedItems.size || 0) === 0) out.push('No quote yet');
                if ((rec.openRfqs || 0) === 0) out.push('No active RFQ');
                if ((rec.mainItems.size || 0) === 0) out.push('Not set as main');
                return out.slice(0, 3).join(' ‚Ä¢ ');
            };

            tbody.innerHTML = arr.map(r => {
                const sugg = suggestionFor(r.name, r);
                return `
                    <tr>
                        <td><b class="proj-sup-link" style="color:#007AFF; cursor:pointer; text-decoration:underline;">${escapeHtml(String(r.name))}</b></td>
                        <td>${r.items.size}</td>
                        <td>${r.mainItems.size}</td>
                        <td>${r.quotedItems.size}</td>
                        <td>${r.openRfqs}</td>
                        <td style="font-size:12px; color:#666;">${escapeHtml(String(sugg || ''))}</td>
                        <td><button class="btn-secondary btn-open-proj-sup" data-supplier="${escapeAttr(String(r.name))}">Open</button></td>
                    </tr>
                `;
            }).join('');

            if (!tbody.dataset.bound) {
                tbody.dataset.bound = '1';
                tbody.addEventListener('click', (e) => {
                    const btn = e.target.closest('.btn-open-proj-sup');
                    const link = e.target.closest('.proj-sup-link');
                    if (!btn && !link) return;
                    const row = e.target.closest('tr');
                    if (!row) return;
                    const nameEl = row.querySelector('.proj-sup-link');
                    const supName = btn ? String(btn.dataset.supplier || '').trim() : (nameEl ? String(nameEl.textContent || '').trim() : '');
                    if (!supName) return;
                    if (typeof window.openSupplierDetail === 'function') window.openSupplierDetail(supName);
                    e.preventDefault();
                    e.stopPropagation();
                });
            }

            // Initialize/refresh pagination for project suppliers table
            setTimeout(() => {
                initTablePagination('table-proj-suppliers', { storageKey: 'rfq_proj_suppliers_page' });
            }, 50);
        }

        // Bind project supplier list filters
        (function bindProjectSupplierListUI() {
            const s1 = getEl('proj-sup-search');
            const s2 = getEl('proj-sup-mfr');
            const s3 = getEl('proj-sup-part');
            const br = getEl('btn-proj-sup-refresh');
            const bm = getEl('btn-merge-suppliers');
            if (s1 && !s1.dataset.bound) { s1.dataset.bound = '1'; s1.addEventListener('input', renderProjectSupplierList); }
            if (s2 && !s2.dataset.bound) { s2.dataset.bound = '1'; s2.addEventListener('input', renderProjectSupplierList); }
            if (s3 && !s3.dataset.bound) { s3.dataset.bound = '1'; s3.addEventListener('input', renderProjectSupplierList); }
            if (br && !br.dataset.bound) { br.dataset.bound = '1'; br.onclick = () => { try { renderProjectSupplierList(); } catch (e) { } }; }
            if (bm && !bm.dataset.bound) { bm.dataset.bound = '1'; bm.onclick = () => { if (typeof window.openMergeSuppliersDialog === 'function') window.openMergeSuppliersDialog(); }; }
        })();

        // =========================================================
        // Export Center (Server-generated XLSX/PDF/CSV)
        // =========================================================
        function renderExportCenter() {
            const scopeSel = getEl('export-scope');
            const pickerRow = getEl('export-projects-picker-row');
            const picker = getEl('export-projects-picker');
            const status = getEl('export-status');
            const btn = getEl('btn-export-generate');

            if (!scopeSel || !pickerRow || !picker || !btn) return;

            const all = Array.isArray(projects) ? projects : [];
            const makePicker = () => {
                picker.innerHTML = all.map(p => `
                    <label class="export-proj-chip">
                        <input type="checkbox" class="export-proj-check" value="${escapeAttr(String(p.id))}">
                        <span>${escapeHtml(String(p.name || 'Untitled'))}</span>
                    </label>
                `).join('');
            };

            if (!picker.dataset.built) {
                picker.dataset.built = '1';
                makePicker();
            }

            const updateScopeUI = () => {
                const v = String(scopeSel.value || 'current');
                pickerRow.style.display = (v === 'selected') ? '' : 'none';
            };

            if (!scopeSel.dataset.bound) {
                scopeSel.dataset.bound = '1';
                scopeSel.addEventListener('change', updateScopeUI);
            }
            updateScopeUI();

            const downloadBlob = (blob, filename) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                setTimeout(() => URL.revokeObjectURL(url), 1000);
            };

            const gatherOptions = () => {
                const scope = String(scopeSel.value || 'current');
                let project_ids = [];
                if (scope === 'current') {
                    if (currentProject && currentProject.id) project_ids = [String(currentProject.id)];
                } else if (scope === 'selected') {
                    project_ids = Array.from(picker.querySelectorAll('input.export-proj-check:checked')).map(x => String(x.value));
                } else {
                    project_ids = all.map(p => String(p.id));
                }

                const format = String((getEl('export-format') && getEl('export-format').value) || 'xlsx');
                return {
                    scope,
                    project_ids,
                    format,
                    include_items: !!(getEl('exp-items') && getEl('exp-items').checked),
                    include_item_suppliers: !!(getEl('exp-item-suppliers') && getEl('exp-item-suppliers').checked),
                    include_price_breaks: !!(getEl('exp-price-breaks') && getEl('exp-price-breaks').checked),
                    include_rfqs: !!(getEl('exp-rfqs') && getEl('exp-rfqs').checked),
                    include_attachments: !!(getEl('exp-attachments') && getEl('exp-attachments').checked),
                    suppliers_mode: String((getEl('export-suppliers-mode') && getEl('export-suppliers-mode').value) || 'all'),
                };
            };

            if (!btn.dataset.bound) {
                btn.dataset.bound = '1';
                btn.addEventListener('click', async () => {
                    const opts = gatherOptions();
                    if (!opts.project_ids || opts.project_ids.length === 0) {
                        if (status) status.textContent = 'Select at least one project.';
                        return;
                    }
                    if (status) status.textContent = 'Generating export‚Ä¶';
                    try {
                        const r = await fetch('/api/export', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(opts),
                            credentials: 'same-origin',
                        });
                        if (!r.ok) {
                            const t = await r.text();
                            throw new Error(t || ('HTTP ' + r.status));
                        }
                        const blob = await r.blob();
                        const today = new Date().toISOString().slice(0, 10);
                        const ext = opts.format === 'pdf' ? 'pdf' : (opts.format === 'csv' ? 'csv' : 'xlsx');
                        const filename = `RFQ_Export_${today}.${ext}`;
                        downloadBlob(blob, filename);
                        if (status) status.textContent = `Done: ${filename}`;
                    } catch (e) {
                        console.error(e);
                        if (status) status.textContent = 'Export failed: ' + (e && e.message ? e.message : String(e));
                    }
                });
            }

            // Multi-Supplier Import Template Download
            const btnTemplate = getEl('btn-export-multi-supplier-template');
            if (btnTemplate && !btnTemplate.dataset.bound) {
                btnTemplate.dataset.bound = '1';
                btnTemplate.addEventListener('click', () => {
                    if (!window.XLSX) {
                        if (window.showToast) window.showToast('Excel library not loaded. Please refresh the page.', 'error');
                        return;
                    }

                    // Create sample data with current project items if available
                    const sampleRows = [];
                    const items = (currentProject && Array.isArray(currentProject.items)) ? currentProject.items : [];

                    if (items.length > 0) {
                        // Use actual items from current project
                        items.slice(0, 20).forEach(item => {
                            sampleRows.push({
                                'PartNo': item.item_drawing_no || item.drawing_no || '',
                                'Supplier': '',
                                'Qty_1': item.qty_1 || 100,
                                'Price_1': '',
                                'Qty_2': item.qty_2 || 500,
                                'Price_2': '',
                                'Qty_3': item.qty_3 || 1000,
                                'Price_3': '',
                                'Qty_4': item.qty_4 || '',
                                'Price_4': '',
                                'Qty_5': item.qty_5 || '',
                                'Price_5': '',
                                'Currency': 'EUR',
                                'MOQ': '',
                                'MOV': '',
                                'LeadTime': '',
                                'Shipping': '',
                                'Incoterms': '',
                                'QuoteNumber': '',
                                'Main': ''
                            });
                        });
                    } else {
                        // Create empty template with sample structure
                        sampleRows.push({
                            'PartNo': 'SAMPLE-001',
                            'Supplier': 'Supplier A',
                            'Qty_1': 100,
                            'Price_1': 10.50,
                            'Qty_2': 500,
                            'Price_2': 9.00,
                            'Qty_3': 1000,
                            'Price_3': 8.50,
                            'Qty_4': '',
                            'Price_4': '',
                            'Qty_5': '',
                            'Price_5': '',
                            'Currency': 'EUR',
                            'MOQ': 50,
                            'MOV': 500,
                            'LeadTime': '4 weeks',
                            'Shipping': '10.00',
                            'Incoterms': 'DDP',
                            'QuoteNumber': 'Q-2024-001',
                            'Main': 'Yes'
                        });
                        sampleRows.push({
                            'PartNo': 'SAMPLE-001',
                            'Supplier': 'Supplier B',
                            'Qty_1': 100,
                            'Price_1': 11.00,
                            'Qty_2': 500,
                            'Price_2': 9.50,
                            'Qty_3': 1000,
                            'Price_3': 9.00,
                            'Qty_4': '',
                            'Price_4': '',
                            'Qty_5': '',
                            'Price_5': '',
                            'Currency': 'USD',
                            'MOQ': 100,
                            'MOV': 1000,
                            'LeadTime': '6 weeks',
                            'Shipping': '15.00',
                            'Incoterms': 'EXW',
                            'QuoteNumber': 'Q-2024-002',
                            'Main': 'No'
                        });
                    }

                    // Create workbook
                    const ws = window.XLSX.utils.json_to_sheet(sampleRows);
                    const wb = window.XLSX.utils.book_new();
                    window.XLSX.utils.book_append_sheet(wb, ws, 'Multi-Supplier Import');

                    // Add instructions sheet
                    const instructions = [
                        { 'Column': 'PartNo', 'Description': 'Part number / Drawing number to match with existing items' },
                        { 'Column': 'Supplier', 'Description': 'Supplier name (required)' },
                        { 'Column': 'Qty_1 to Qty_10', 'Description': 'Quantity tiers (can use any number of tiers)' },
                        { 'Column': 'Price_1 to Price_10', 'Description': 'Prices corresponding to quantity tiers' },
                        { 'Column': 'Currency', 'Description': 'Currency code (EUR, USD, CZK, etc.)' },
                        { 'Column': 'MOQ', 'Description': 'Minimum Order Quantity' },
                        { 'Column': 'MOV', 'Description': 'Minimum Order Value' },
                        { 'Column': 'LeadTime', 'Description': 'Lead time (e.g., "4 weeks")' },
                        { 'Column': 'Shipping', 'Description': 'Shipping cost' },
                        { 'Column': 'Incoterms', 'Description': 'Incoterms (EXW, DDP, etc.)' },
                        { 'Column': 'QuoteNumber', 'Description': 'Quote reference number' },
                        { 'Column': 'Main', 'Description': 'Set to "Yes" to mark as main supplier' }
                    ];
                    const wsInstr = window.XLSX.utils.json_to_sheet(instructions);
                    window.XLSX.utils.book_append_sheet(wb, wsInstr, 'Instructions');

                    // Download
                    const today = new Date().toISOString().slice(0, 10);
                    const filename = `Multi_Supplier_Import_Template_${today}.xlsx`;
                    window.XLSX.writeFile(wb, filename);
                });
            }
        }

        // =========================================================
        // Settings - Currency Rates and Display Settings
        // =========================================================
        async function _settingsFetchJson(url, options = {}) {
            const opts = {
                method: options.method || 'GET',
                headers: { 'Content-Type': 'application/json', ...(options.headers || {}) },
                credentials: 'same-origin'
            };
            if (options.body !== undefined) opts.body = JSON.stringify(options.body);
            const r = await fetch(url, opts);
            let data = {};
            try { data = await r.json(); } catch (_) { }
            if (!r.ok) throw new Error(data?.error || `HTTP ${r.status}`);
            return data;
        }

        async function renderAdminManagement() {
            const usersEl = getEl('settings-admin-users');
            const compEl = getEl('settings-admin-companies');
            const noteEl = getEl('settings-admin-note');
            const addBtn = getEl('btn-settings-admin-add-company');
            const addInput = getEl('settings-admin-company-name');
            if (!usersEl || !compEl) return;

            usersEl.innerHTML = '<div style="padding:10px; font-size:11px; color:#64748b;">Loading...</div>';
            compEl.innerHTML = '<div style="padding:10px; font-size:11px; color:#64748b;">Loading...</div>';
            if (noteEl) noteEl.textContent = '';

            let users = [];
            let companies = [];

            try {
                const ur = await _settingsFetchJson('/api/admin/users');
                users = Array.isArray(ur?.users) ? ur.users : [];
            } catch (e) {
                usersEl.innerHTML = '<div style="padding:10px; font-size:11px; color:#b91c1c;">Admin users unavailable.</div>';
                if (noteEl) noteEl.textContent = `Admin API: ${e.message}`;
                return;
            }

            try {
                const cr = await _settingsFetchJson('/api/admin/companies');
                companies = Array.isArray(cr?.companies) ? cr.companies : [];
            } catch (_) {
                companies = [];
            }

            usersEl.innerHTML = users.length ? users.map(u => {
                const roleColor = u.role === 'superadmin' ? '#7c3aed' : (u.role === 'admin' ? '#0f766e' : (u.role === 'editor' ? '#1d4ed8' : '#475569'));
                const companyOptions = companies.map(c => `<option value="${c.id}" ${String(u.company_id||'')===String(c.id)?'selected':''}>${escapeHtml(c.name||'')}</option>`).join('');
                return `<div style="padding:8px 10px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; gap:8px; align-items:flex-start;">
                    <div style="min-width:0; flex:1;">
                        <div style="font-size:12px; font-weight:600; color:#0f172a; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(u.username || ('#'+u.user_id))}</div>
                        <div style="font-size:10px; color:#64748b;">${escapeHtml(u.email || '')} ${u.company_name ? '‚Ä¢ '+escapeHtml(u.company_name) : ''}</div>
                    </div>
                    <div style="display:grid; grid-template-columns:auto auto auto auto; gap:6px; align-items:center;">
                        <select data-admin-user-role="${u.user_id}" class="rfq-input" style="font-size:11px; padding:2px 6px; color:${roleColor}; min-width:90px;">
                            ${['viewer','editor','admin','superadmin'].map(r => `<option value="${r}" ${u.role===r?'selected':''}>${r}</option>`).join('')}
                        </select>
                        <label style="font-size:10px; color:#475569; display:flex; align-items:center; gap:4px;"><input type="checkbox" data-admin-user-mgmt="${u.user_id}" ${u.is_management?'checked':''}/> mgmt</label>
                        <select data-admin-user-company="${u.user_id}" class="rfq-input" style="font-size:11px; padding:2px 6px; min-width:120px;">
                            <option value="">(none)</option>${companyOptions}
                        </select>
                        <button class="btn-secondary" data-admin-user-save="${u.user_id}" style="font-size:10px; padding:3px 8px;">Save</button>
                    </div>
                </div>`;
            }).join('') : '<div style="padding:10px; font-size:11px; color:#64748b;">No users.</div>';

            compEl.innerHTML = companies.length ? companies.map(c => `<div style="padding:8px 10px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
                <div style="font-size:12px; font-weight:600; color:#0f172a;">${escapeHtml(c.name || '')}</div>
                <div style="font-size:10px; color:${c.is_active ? '#16a34a' : '#dc2626'};">${c.is_active ? 'active' : 'inactive'}</div>
            </div>`).join('') : '<div style="padding:10px; font-size:11px; color:#64748b;">Companies visible only for superadmin.</div>';

            usersEl.querySelectorAll('[data-admin-user-save]').forEach(btn => {
                btn.onclick = async () => {
                    const uid = btn.getAttribute('data-admin-user-save');
                    const sel = usersEl.querySelector(`[data-admin-user-role="${uid}"]`);
                    const role = sel ? sel.value : 'viewer';
                    const mg = usersEl.querySelector(`[data-admin-user-mgmt="${uid}"]`);
                    const co = usersEl.querySelector(`[data-admin-user-company="${uid}"]`);
                    try {
                        await _settingsFetchJson('/api/admin/users', {
                            method: 'POST',
                            body: {
                                user_id: Number(uid),
                                role,
                                is_management: !!(mg && mg.checked),
                                company_id: co ? co.value : null,
                            }
                        });
                        showToast('User updated', 'success');
                        renderAdminManagement();
                    } catch (e) {
                        showToast(`Update failed: ${e.message}`, 'error');
                    }
                };
            });

            if (addBtn && !addBtn.dataset.bound) {
                addBtn.dataset.bound = '1';
                addBtn.onclick = async () => {
                    const name = String(addInput?.value || '').trim();
                    if (!name) { showToast('Enter company name', 'warning'); return; }
                    try {
                        await _settingsFetchJson('/api/admin/companies', { method: 'POST', body: { name } });
                        if (addInput) addInput.value = '';
                        showToast('Company created', 'success');
                        renderAdminManagement();
                    } catch (e) {
                        showToast(`Create failed: ${e.message}`, 'error');
                    }
                };
            }

            const auditWrap = getEl('settings-admin-audit');
            const auditAction = getEl('settings-admin-audit-action');
            const auditEntity = getEl('settings-admin-audit-entity');
            const auditBtn = getEl('btn-settings-admin-audit-refresh');

            const lockWrap = getEl('settings-admin-locks');
            const lockBtn = getEl('btn-settings-admin-locks-refresh');

            const loadLocks = async () => {
                if (!lockWrap) return;
                lockWrap.innerHTML = '<div style="padding:10px; font-size:11px; color:#64748b;">Loading...</div>';
                try {
                    const lr = await _settingsFetchJson('/api/admin/locks?limit=200');
                    const locks = Array.isArray(lr?.locks) ? lr.locks : [];
                    lockWrap.innerHTML = locks.length ? locks.map(l => `
                        <div style="padding:7px 10px; border-bottom:1px solid #f1f5f9; font-size:11px;">
                            <div style="display:flex; justify-content:space-between; gap:8px;">
                                <div style="font-weight:600; color:#0f172a;">${escapeHtml(l.context || 'lock')}</div>
                                <div style="color:#64748b;">${escapeHtml((l.expires_at || '').replace('T',' ').slice(0,19))}</div>
                            </div>
                            <div style="color:#475569;">${escapeHtml(l.project_name || l.project_id || '')} ‚Ä¢ ${escapeHtml(l.locked_by || '')}</div>
                            <div style="margin-top:4px;"><button class="btn-secondary" data-admin-force-unlock="${escapeAttr(l.resource_key || '')}" style="font-size:10px; padding:2px 6px;">Force unlock</button></div>
                        </div>
                    `).join('') : '<div style="padding:10px; font-size:11px; color:#64748b;">No active locks.</div>';

                    lockWrap.querySelectorAll('[data-admin-force-unlock]').forEach(b => {
                        b.onclick = async () => {
                            const key = b.getAttribute('data-admin-force-unlock');
                            if (!key) return;
                            try {
                                await _settingsFetchJson('/api/locks/force_unlock', { method: 'POST', body: { resource_key: key } });
                                showToast('Lock unlocked', 'success');
                                loadLocks();
                            } catch (e) {
                                showToast(`Unlock failed: ${e.message}`, 'error');
                            }
                        };
                    });
                } catch (e) {
                    lockWrap.innerHTML = '<div style="padding:10px; font-size:11px; color:#b91c1c;">Locks unavailable.</div>';
                }
            };

            if (lockBtn && !lockBtn.dataset.bound) {
                lockBtn.dataset.bound = '1';
                lockBtn.onclick = loadLocks;
            }

            const loadAudit = async () => {
                if (!auditWrap) return;
                auditWrap.innerHTML = '<div style="padding:10px; font-size:11px; color:#64748b;">Loading...</div>';
                try {
                    const q = new URLSearchParams({
                        limit: '120',
                        action: String(auditAction?.value || '').trim(),
                        entity_type: String(auditEntity?.value || '').trim(),
                    });
                    const ar = await _settingsFetchJson(`/api/admin/audit_logs?${q.toString()}`);
                    const logs = Array.isArray(ar?.logs) ? ar.logs : [];
                    auditWrap.innerHTML = logs.length ? logs.map(l => `
                        <div style="padding:7px 10px; border-bottom:1px solid #f1f5f9; font-size:11px;">
                            <div style="display:flex; justify-content:space-between; gap:8px;">
                                <div style="font-weight:600; color:#0f172a;">${escapeHtml(l.action || '')}</div>
                                <div style="color:#64748b;">${escapeHtml((l.time || '').replace('T',' ').slice(0,19))}</div>
                            </div>
                            <div style="color:#475569;">${escapeHtml(l.entity_type || '')} ‚Ä¢ ${escapeHtml(String(l.entity_id || ''))} ‚Ä¢ ${escapeHtml(l.actor || '')}</div>
                        </div>
                    `).join('') : '<div style="padding:10px; font-size:11px; color:#64748b;">No logs.</div>';
                } catch (e) {
                    auditWrap.innerHTML = '<div style="padding:10px; font-size:11px; color:#b91c1c;">Audit log unavailable.</div>';
                }
            };

            if (auditBtn && !auditBtn.dataset.bound) {
                auditBtn.dataset.bound = '1';
                auditBtn.onclick = loadAudit;
            }
            loadAudit();
            loadLocks();
        }

        function renderSettings() {
            const ratesContainer = getEl('settings-currency-rates');
            const decimalsSelect = getEl('settings-currency-decimals');
            const btnSave = getEl('btn-settings-save');
            const btnReset = getEl('btn-settings-reset');

            if (!ratesContainer) return;

            const settings = window.RFQData && typeof window.RFQData.getSettings === 'function'
                ? window.RFQData.getSettings()
                : { currencyRates: {}, currencyDecimals: 4 };

            const currencies = window.RFQData && Array.isArray(window.RFQData.CURRENCIES)
                ? window.RFQData.CURRENCIES
                : ['EUR', 'USD', 'CZK', 'GBP', 'CHF', 'PLN', 'HUF', 'CNY', 'JPY', 'SEK'];

            const defaultRates = window.RFQData && window.RFQData.DEFAULT_CURRENCY_RATES
                ? window.RFQData.DEFAULT_CURRENCY_RATES
                : { EUR: 1, USD: 0.92, CZK: 0.041, GBP: 1.17, CHF: 1.05, PLN: 0.23, HUF: 0.0026, CNY: 0.13, JPY: 0.0062, SEK: 0.09 };

            // Render currency rate inputs (compact)
            ratesContainer.innerHTML = currencies.map(curr => {
                const rate = settings.currencyRates[curr] !== undefined ? settings.currencyRates[curr] : (defaultRates[curr] || 1);
                const isBase = curr === 'EUR';
                return `
                    <div style="display: flex; align-items: center; gap: 6px; padding: 6px 8px; background: ${isBase ? '#e8f5e9' : '#f9f9f9'}; border-radius: 6px;">
                        <span style="font-weight: 600; font-size: 12px; min-width: 35px;">${curr}</span>
                        <input type="number" class="rfq-input settings-currency-rate" data-currency="${curr}" value="${rate}" step="0.0001" min="0" ${isBase ? 'readonly' : ''} style="font-family: monospace; font-size: 11px; padding: 4px 6px; width: 80px; ${isBase ? 'background: #f0f0f0;' : ''}">
                    </div>
                `;
            }).join('');

            // Set decimals select
            if (decimalsSelect) {
                decimalsSelect.value = String(settings.currencyDecimals || 4);
            }

            // Bind save button
            if (btnSave && !btnSave.dataset.bound) {
                btnSave.dataset.bound = '1';
                btnSave.addEventListener('click', () => {
                    const newRates = {};
                    ratesContainer.querySelectorAll('.settings-currency-rate').forEach(input => {
                        const curr = input.dataset.currency;
                        const val = parseFloat(input.value);
                        if (curr && !isNaN(val) && val >= 0) {
                            newRates[curr] = val;
                        }
                    });

                    const newDecimals = decimalsSelect ? parseInt(decimalsSelect.value, 10) : 4;

                    const newSettings = {
                        currencyRates: { ...defaultRates, ...newRates },
                        currencyDecimals: isNaN(newDecimals) ? 4 : newDecimals
                    };

                    if (window.RFQData && typeof window.RFQData.saveSettings === 'function') {
                        window.RFQData.saveSettings(newSettings);
                    }

                    // Refresh the live CURRENCY_RATES object
                    if (window.RFQData && typeof window.RFQData.refreshCurrencyRates === 'function') {
                        window.RFQData.refreshCurrencyRates();
                    }

                    showSuccessModal({
                        title: 'Settings Saved',
                        message: 'Your settings have been saved successfully.',
                        icon: '‚öôÔ∏è',
                        iconColor: '#667eea'
                    });
                });
            }

            // Bind reset button
            if (btnReset && !btnReset.dataset.bound) {
                btnReset.dataset.bound = '1';
                btnReset.addEventListener('click', async () => {
                    const confirmed = await window.showConfirmDialog({
                        title: 'Reset Settings',
                        message: 'Reset all settings to defaults?',
                        type: 'warning',
                        okText: 'Reset',
                        cancelText: 'Cancel'
                    });
                    if (!confirmed) return;

                    const defaultSettings = {
                        currencyRates: { ...defaultRates },
                        currencyDecimals: 4
                    };

                    if (window.RFQData && typeof window.RFQData.saveSettings === 'function') {
                        window.RFQData.saveSettings(defaultSettings);
                    }

                    if (window.RFQData && typeof window.RFQData.refreshCurrencyRates === 'function') {
                        window.RFQData.refreshCurrencyRates();
                    }

                    // Re-render to show default values
                    renderSettings();
                    showSuccessModal({
                        title: 'Settings Reset',
                        message: 'All settings have been reset to default values.',
                        icon: 'üîÑ',
                        iconColor: '#f59e0b'
                    });
                });
            }

            // Data Management buttons
            const btnExportJson = getEl('btn-settings-export-json');
            const btnImportJson = getEl('btn-settings-import-json');
            const btnResetData = getEl('btn-settings-reset-data');
            const fileInput = getEl('settings-file-import');
            const storageInfo = getEl('settings-storage-info');

            // Show storage info
            if (storageInfo) {
                try {
                    let totalSize = 0;
                    for (let key in localStorage) {
                        if (localStorage.hasOwnProperty(key)) {
                            totalSize += localStorage[key].length * 2; // UTF-16
                        }
                    }
                    const sizeKB = (totalSize / 1024).toFixed(1);
                    const projectCount = (projects || []).length;
                    storageInfo.innerHTML = `<strong>Storage:</strong> ${sizeKB} KB used | <strong>Projects:</strong> ${projectCount}`;
                } catch (e) {
                    storageInfo.textContent = 'Unable to calculate storage';
                }
            }

            // Export JSON
            if (btnExportJson && !btnExportJson.dataset.bound) {
                btnExportJson.dataset.bound = '1';
                btnExportJson.addEventListener('click', () => {
                    try {
                        const data = {
                            version: '2.0',
                            exported_at: new Date().toISOString(),
                            projects: projects || []
                        };
                        const json = JSON.stringify(data, null, 2);
                        const blob = new Blob([json], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `rfq_backup_${new Date().toISOString().slice(0, 10)}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    } catch (e) {
                        showToast('Export failed: ' + e.message, 'error');
                    }
                });
            }

            // Import JSON
            if (btnImportJson && !btnImportJson.dataset.bound) {
                btnImportJson.dataset.bound = '1';
                btnImportJson.addEventListener('click', () => {
                    if (fileInput) fileInput.click();
                });
            }

            if (fileInput && !fileInput.dataset.bound) {
                fileInput.dataset.bound = '1';
                fileInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    try {
                        const text = await file.text();
                        const data = JSON.parse(text);
                        const importedProjects = data.projects || [];
                        if (!Array.isArray(importedProjects)) {
                            throw new Error('Invalid format: projects must be an array');
                        }
                        // Merge projects
                        const existingIds = new Set((projects || []).map(p => p.id));
                        let added = 0, updated = 0;
                        importedProjects.forEach(p => {
                            if (existingIds.has(p.id)) {
                                const idx = projects.findIndex(x => x.id === p.id);
                                if (idx >= 0) { projects[idx] = p; updated++; }
                            } else {
                                projects.push(p);
                                added++;
                            }
                        });
                        if (typeof updateProject === 'function') {
                            projects.forEach(p => updateProject(p));
                        }
                        showToast(`Import complete: ${added} added, ${updated} updated`, 'success');
                        renderSettings();
                        if (typeof renderMainOverview === 'function') renderMainOverview();
                    } catch (err) {
                        showToast('Import failed: ' + err.message, 'error');
                    }
                    fileInput.value = '';
                });
            }

            // Reset all data
            if (btnResetData && !btnResetData.dataset.bound) {
                btnResetData.dataset.bound = '1';
                btnResetData.addEventListener('click', async () => {
                    const confirmed1 = await window.showConfirmDialog({
                        title: 'Delete All Data',
                        message: 'WARNING: This will delete ALL data. Are you sure?',
                        type: 'danger',
                        okText: 'Continue',
                        cancelText: 'Cancel'
                    });
                    if (!confirmed1) return;
                    const confirmed2 = await window.showConfirmDialog({
                        title: 'Final Confirmation',
                        message: 'This cannot be undone. All your projects, items, and settings will be permanently deleted.',
                        type: 'danger',
                        okText: 'Delete Everything',
                        cancelText: 'Cancel'
                    });
                    if (!confirmed2) return;
                    try {
                        if (window.RFQData && typeof window.RFQData.resetServer === 'function') {
                            await window.RFQData.resetServer();
                        }
                        localStorage.clear();
                        if (window.showToast) window.showToast('All data has been reset. Reloading‚Ä¶', 'success');
                        setTimeout(() => location.reload(), 500);
                    } catch (e) {
                        if (window.showToast) window.showToast('Reset failed: ' + e.message, 'error');
                    }
                });
            }

            // =========================================================
            // Status Management UI
            // =========================================================
            initStatusManagementUI();
            try { renderAdminManagement(); } catch (e) { console.warn('Admin settings render failed', e); }
        }

        // Current status type being edited
        let currentStatusType = 'item';

        function initStatusManagementUI() {
            const tabsContainer = document.getElementById('status-tabs');
            const listContainer = document.getElementById('status-list-container');
            const btnAddStatus = document.getElementById('btn-add-status');
            const btnResetStatuses = document.getElementById('btn-reset-statuses');

            if (!tabsContainer || !listContainer) return;

            // Tab click handlers
            if (!tabsContainer.dataset.bound) {
                tabsContainer.dataset.bound = '1';
                tabsContainer.addEventListener('click', (e) => {
                    const tab = e.target.closest('.status-tab');
                    if (!tab) return;

                    const type = tab.dataset.statusType;
                    if (!type) return;

                    // Update active tab styling
                    tabsContainer.querySelectorAll('.status-tab').forEach(t => {
                        t.style.background = '#f5f5f7';
                        t.style.color = '#333';
                        t.classList.remove('active');
                    });
                    tab.style.background = '#007AFF';
                    tab.style.color = 'white';
                    tab.classList.add('active');

                    currentStatusType = type;
                    renderStatusList();
                });
            }

            // Add status button
            if (btnAddStatus && !btnAddStatus.dataset.bound) {
                btnAddStatus.dataset.bound = '1';
                btnAddStatus.addEventListener('click', () => {
                    openAddStatusModal(currentStatusType);
                });
            }

            // Reset statuses button
            if (btnResetStatuses && !btnResetStatuses.dataset.bound) {
                btnResetStatuses.dataset.bound = '1';
                btnResetStatuses.addEventListener('click', async () => {
                    const confirmed = await window.showConfirmDialog({
                        title: 'Reset Statuses',
                        message: 'Reset all statuses to defaults? This cannot be undone.',
                        type: 'warning',
                        okText: 'Reset',
                        cancelText: 'Cancel'
                    });
                    if (!confirmed) return;
                    resetStatusesToDefaults();
                    renderStatusList();
                    showSuccessModal({
                        title: 'Statuses Reset',
                        message: 'All statuses have been reset to default values.',
                        icon: 'üîÑ',
                        iconColor: '#f59e0b'
                    });
                });
            }

            // Initial render
            renderStatusList();
        }

        function renderStatusList() {
            const listContainer = document.getElementById('status-list-container');
            if (!listContainer) return;

            const config = getStatusConfig();
            let statuses;
            switch (currentStatusType) {
                case 'item': statuses = config.itemStatuses; break;
                case 'batch': statuses = config.batchStatuses; break;
                case 'supplierQuote': statuses = config.supplierQuoteStatuses; break;
                case 'planner': statuses = config.plannerStatuses; break;
                case 'project': statuses = config.projectStatuses; break;
                default: statuses = config.itemStatuses;
            }

            // Sort by sortOrder
            statuses = statuses.slice().sort((a, b) => a.sortOrder - b.sortOrder);

            if (!statuses.length) {
                listContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No statuses defined. Click "Add Status" to create one.</div>';
                return;
            }

            listContainer.innerHTML = statuses.map((s, idx) => `
                <div class="status-item" data-status-id="${s.id}" draggable="true" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-bottom: 1px solid #e5e5e5; background: white; cursor: move;">
                    <span class="drag-handle" style="color: #999; cursor: grab;">‚ò∞</span>
                    <input type="color" class="status-color-picker" value="${s.color || '#999999'}" data-status-id="${s.id}" style="width: 32px; height: 24px; border: none; cursor: pointer; padding: 0;">
                    <input type="text" class="status-name-input rfq-input" value="${escapeHtml(s.name)}" data-status-id="${s.id}" style="flex: 1; padding: 4px 8px; font-size: 13px;">
                    ${currentStatusType === 'item' ? `
                        <select class="status-category-select rfq-input" data-status-id="${s.id}" style="width: 85px; padding: 3px 4px; font-size: 11px;" title="Dashboard category">
                            <option value="new" ${s.category === 'new' ? 'selected' : ''}>üìã New</option>
                            <option value="in_progress" ${s.category === 'in_progress' ? 'selected' : ''}>‚è≥ Progress</option>
                            <option value="done" ${s.category === 'done' ? 'selected' : ''}>‚úì Done</option>
                            <option value="issue" ${s.category === 'issue' ? 'selected' : ''}>‚ö† Issue</option>
                        </select>
                    ` : ''}
                    ${currentStatusType === 'project' ? `
                        <select class="status-category-select rfq-input" data-status-id="${s.id}" style="width: 120px; padding: 4px 8px; font-size: 12px;">
                            <option value="priority" ${s.category === 'priority' ? 'selected' : ''}>Priority (Top)</option>
                            <option value="new" ${s.category === 'new' ? 'selected' : ''}>New</option>
                            <option value="in_progress" ${s.category === 'in_progress' ? 'selected' : ''}>In Progress</option>
                            <option value="done" ${s.category === 'done' ? 'selected' : ''}>Done (Bottom)</option>
                        </select>
                    ` : ''}
                    ${currentStatusType === 'planner' ? `
                        <input type="text" class="status-icon-input rfq-input" value="${escapeHtml(s.icon || '')}" data-status-id="${s.id}" placeholder="Icon" style="width: 50px; padding: 4px 8px; font-size: 13px; text-align: center;">
                    ` : ''}
                    <button class="btn-delete-status" data-status-id="${s.id}" style="background: #ff3b30; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">Delete</button>
                </div>
            `).join('');

            // Bind events
            bindStatusListEvents();
        }

        function bindStatusListEvents() {
            const listContainer = document.getElementById('status-list-container');
            if (!listContainer) return;

            // Color picker change
            listContainer.querySelectorAll('.status-color-picker').forEach(picker => {
                picker.addEventListener('change', (e) => {
                    const id = parseInt(e.target.dataset.statusId, 10);
                    updateStatus(currentStatusType, id, { color: e.target.value });
                });
            });

            // Name input change
            listContainer.querySelectorAll('.status-name-input').forEach(input => {
                input.addEventListener('blur', (e) => {
                    const id = parseInt(e.target.dataset.statusId, 10);
                    const newName = e.target.value.trim();
                    if (newName) {
                        updateStatus(currentStatusType, id, { name: newName });
                    }
                });
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') e.target.blur();
                });
            });

            // Category select change (project statuses)
            listContainer.querySelectorAll('.status-category-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const id = parseInt(e.target.dataset.statusId, 10);
                    updateStatus(currentStatusType, id, { category: e.target.value });
                });
            });

            // Icon input change (planner statuses)
            listContainer.querySelectorAll('.status-icon-input').forEach(input => {
                input.addEventListener('blur', (e) => {
                    const id = parseInt(e.target.dataset.statusId, 10);
                    updateStatus(currentStatusType, id, { icon: e.target.value.trim() });
                });
            });

            // Delete button
            listContainer.querySelectorAll('.btn-delete-status').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = parseInt(e.target.dataset.statusId, 10);
                    const confirmed = await window.showConfirmDialog({
                        title: 'Delete Status',
                        message: 'Delete this status? Items with this status will keep their status name.',
                        type: 'danger',
                        okText: 'Delete',
                        cancelText: 'Cancel'
                    });
                    if (!confirmed) return;
                    deleteStatus(currentStatusType, id);
                    renderStatusList();
                });
            });

            // Drag and drop reordering
            let draggedItem = null;
            listContainer.querySelectorAll('.status-item').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedItem = item;
                    item.style.opacity = '0.5';
                });

                item.addEventListener('dragend', (e) => {
                    item.style.opacity = '1';
                    draggedItem = null;
                    // Save new order
                    const orderedIds = Array.from(listContainer.querySelectorAll('.status-item'))
                        .map(el => parseInt(el.dataset.statusId, 10));
                    reorderStatuses(currentStatusType, orderedIds);
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(listContainer, e.clientY);
                    if (draggedItem && afterElement) {
                        listContainer.insertBefore(draggedItem, afterElement);
                    } else if (draggedItem) {
                        listContainer.appendChild(draggedItem);
                    }
                });
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.status-item:not([style*="opacity: 0.5"])')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function openAddStatusModal(type) {
            const typeLabels = {
                'item': 'Item',
                'batch': 'Batch',
                'supplierQuote': 'Supplier Quote',
                'planner': 'Planner',
                'project': 'Project'
            };

            // Create modal
            const modalId = 'add-status-modal';
            let modal = document.getElementById(modalId);
            if (modal) modal.remove();

            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal-overlay';
            modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;';

            modal.innerHTML = `
                <div class="modal-content" style="background: white; border-radius: 12px; padding: 24px; width: 400px; max-width: 90%;">
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 16px;">Add ${typeLabels[type] || 'New'} Status</div>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div>
                            <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 4px;">Status Name</label>
                            <input type="text" id="new-status-name" class="rfq-input" style="width: 100%; padding: 8px;" placeholder="Enter status name">
                        </div>
                        <div>
                            <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 4px;">Color</label>
                            <input type="color" id="new-status-color" value="#007AFF" style="width: 60px; height: 32px;">
                        </div>
                        ${type === 'planner' ? `
                        <div>
                            <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 4px;">Icon (emoji)</label>
                            <input type="text" id="new-status-icon" class="rfq-input" style="width: 60px; padding: 8px; text-align: center;" placeholder="üìã">
                        </div>
                        ` : ''}
                        ${type === 'item' ? `
                        <div>
                            <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 4px;">Dashboard Category</label>
                            <select id="new-status-category" class="rfq-input" style="width: 100%; padding: 8px;">
                                <option value="new">üìã New</option>
                                <option value="in_progress" selected>‚è≥ In Progress</option>
                                <option value="done">‚úì Done</option>
                                <option value="issue">‚ö† Issue</option>
                            </select>
                            <div style="font-size: 11px; color: #888; margin-top: 4px;">Determines which box this status appears in on the Dashboard</div>
                        </div>
                        ` : ''}
                        ${type === 'project' ? `
                        <div>
                            <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 4px;">Category</label>
                            <select id="new-status-category" class="rfq-input" style="width: 100%; padding: 8px;">
                                <option value="priority">Priority (Top)</option>
                                <option value="new">New</option>
                                <option value="in_progress" selected>In Progress</option>
                                <option value="done">Done (Bottom)</option>
                            </select>
                        </div>
                        ` : ''}
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
                        <button id="btn-cancel-add-status" class="btn-secondary" style="padding: 8px 16px;">Cancel</button>
                        <button id="btn-confirm-add-status" class="btn-primary" style="padding: 8px 16px;">Add Status</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Focus on name input
            setTimeout(() => document.getElementById('new-status-name')?.focus(), 100);

            // Bind events
            document.getElementById('btn-cancel-add-status').addEventListener('click', () => modal.remove());
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });

            document.getElementById('btn-confirm-add-status').addEventListener('click', () => {
                const name = document.getElementById('new-status-name').value.trim();
                const color = document.getElementById('new-status-color').value;
                const icon = document.getElementById('new-status-icon')?.value.trim();
                const category = document.getElementById('new-status-category')?.value;

                if (!name) {
                    if (window.showToast) window.showToast('Please enter a status name', 'warning');
                    return;
                }

                const newStatus = addStatus(type, name, color, icon);
                if (newStatus && category) {
                    updateStatus(type, newStatus.id, { category });
                }

                modal.remove();
                renderStatusList();
            });

            // Enter key to confirm
            document.getElementById('new-status-name').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') document.getElementById('btn-confirm-add-status').click();
            });
        }


        window.sortSupplierList = (field) => {
            if (!window.currentSupplierSort || window.currentSupplierSort.field !== field) {
                window.currentSupplierSort = { field: field, dir: 'asc' };
            } else {
                window.currentSupplierSort.dir = window.currentSupplierSort.dir === 'asc' ? 'desc' : 'asc';
            }
            renderGlobalSupplierList();
        };

        const supplierListSearch = getEl('supplier-list-search');
        if (supplierListSearch) {
            supplierListSearch.addEventListener('input', renderGlobalSupplierList);
            const supplierListMfr = getEl('supplier-list-mfr');
            const supplierListPart = getEl('supplier-list-part');
            if (supplierListMfr) supplierListMfr.addEventListener('input', renderGlobalSupplierList);
            if (supplierListPart) supplierListPart.addEventListener('input', renderGlobalSupplierList);

            // Robust click handling: open Supplier Detail even if inline onclick breaks (quotes/special chars)
            const supTbl = getEl('table-supplier-list');
            if (supTbl) {
                const supTbody = supTbl.querySelector('tbody');
                if (supTbody && !supTbody.dataset.boundDetail) {
                    supTbody.dataset.boundDetail = '1';
                    supTbody.addEventListener('click', (e) => {
                        const row = e.target.closest('tr');
                        if (!row) return;
                        // Only react when clicking the supplier name link or action button
                        const isNameClick = !!e.target.closest('b');
                        const isBtnClick = !!e.target.closest('button');
                        if (!isNameClick && !isBtnClick) return;
                        const nameEl = row.querySelector('td b');
                        const supName = nameEl ? String(nameEl.textContent || '').trim() : '';
                        if (!supName) return;
                        if (typeof window.openSupplierDetail === 'function') window.openSupplierDetail(supName);
                        e.preventDefault();
                        e.stopPropagation();
                    });
                }
            }

        }

        function ensureDatabaseAdvancedFiltersUI() {
            try {
                const view = getEl('view-database');
                if (!view) return;
                const toolbar = view.querySelector('.toolbar');
                if (!toolbar) return;

                // already injected
                if (toolbar.querySelector('#db-supplier-filter')) return;

                const supSel = document.createElement('select');
                supSel.id = 'db-supplier-filter';
                supSel.className = 'filter-select';
                supSel.style.width = '220px';
                supSel.innerHTML = '<option value="">All Suppliers</option>';

                const minProj = document.createElement('input');
                minProj.id = 'db-min-projects';
                minProj.type = 'number';
                minProj.min = '0';
                minProj.placeholder = '#Projects ‚â•';
                minProj.className = 'filter-input';
                minProj.style.width = '110px';

                const maxProj = document.createElement('input');
                maxProj.id = 'db-max-projects';
                maxProj.type = 'number';
                maxProj.min = '0';
                maxProj.placeholder = '#Projects ‚â§';
                maxProj.className = 'filter-input';
                maxProj.style.width = '110px';

                const minSup = document.createElement('input');
                minSup.id = 'db-min-suppliers';
                minSup.type = 'number';
                minSup.min = '0';
                minSup.placeholder = '#Suppliers ‚â•';
                minSup.className = 'filter-input';
                minSup.style.width = '110px';

                const onlyQuotedWrap = document.createElement('label');
                onlyQuotedWrap.style.display = 'inline-flex';
                onlyQuotedWrap.style.alignItems = 'center';
                onlyQuotedWrap.style.gap = '6px';
                onlyQuotedWrap.style.fontSize = '12px';
                onlyQuotedWrap.style.color = '#333';
                onlyQuotedWrap.style.marginLeft = '4px';

                const onlyQuoted = document.createElement('input');
                onlyQuoted.id = 'db-only-quoted';
                onlyQuoted.type = 'checkbox';
                onlyQuoted.style.transform = 'scale(1.1)';
                onlyQuotedWrap.appendChild(onlyQuoted);
                onlyQuotedWrap.appendChild(document.createTextNode('Only quoted'));

                // Insert after the existing project filter if present, otherwise append
                const projFilterEl = getEl('database-project-filter');
                if (projFilterEl && projFilterEl.parentElement === toolbar) {
                    toolbar.insertBefore(supSel, projFilterEl.nextSibling);
                    toolbar.insertBefore(minProj, supSel.nextSibling);
                    toolbar.insertBefore(maxProj, minProj.nextSibling);
                    toolbar.insertBefore(minSup, maxProj.nextSibling);
                    toolbar.insertBefore(onlyQuotedWrap, minSup.nextSibling);
                } else {
                    toolbar.appendChild(supSel);
                    toolbar.appendChild(minProj);
                    toolbar.appendChild(maxProj);
                    toolbar.appendChild(minSup);
                    toolbar.appendChild(onlyQuotedWrap);
                }

                // Bind listeners once
                const bindOnce = (el, ev, fn) => {
                    if (!el) return;
                    const key = 'listener_' + ev;
                    if (el.dataset && el.dataset[key]) return;
                    el.addEventListener(ev, fn);
                    if (el.dataset) el.dataset[key] = '1';
                };

                bindOnce(supSel, 'change', renderDatabase);
                bindOnce(minProj, 'input', renderDatabase);
                bindOnce(maxProj, 'input', renderDatabase);
                bindOnce(minSup, 'input', renderDatabase);
                bindOnce(onlyQuoted, 'change', renderDatabase);
            } catch (e) {
                console.error(e);
            }
        }



        // =========================================================
        // Database Advanced Search Helpers (MPN-centric)
        // Supports token AND + key:value (mpn:, mfr:, manufacturer:, desc:, dn:/drawing:, sup:/supplier:, proj:/project:)
        // Returns { free:[], kv:{} } and { ok:boolean, score:number }
        // =========================================================
        function dbAdvParseQuery(q) {
            const raw = String(q || '').trim();
            if (!raw) return { free: [], kv: {} };
            const parts = raw.split(/\s+/).filter(Boolean);
            const kv = {};
            const free = [];
            parts.forEach(p => {
                const m = String(p || '').match(/^([a-zA-Z_]+):(.*)$/);
                if (m) {
                    const k = String(m[1] || '').toLowerCase();
                    const v = String(m[2] || '').toLowerCase();
                    if (k && v) kv[k] = v;
                } else {
                    free.push(String(p).toLowerCase());
                }
            });
            return { free, kv };
        }

        function dbAdvMatchAndScore(entry, parsed, searchLower) {
            const mpn = String(entry && entry.mpn || '').toLowerCase();
            const mfr = String(entry && entry.manufacturer || '').toLowerCase();
            const desc = String(entry && entry.description || '').toLowerCase();
            const drawings = entry && entry.drawings ? Array.from(entry.drawings).join(' ').toLowerCase() : '';
            const suppliers = entry && entry.suppliers ? Array.from(entry.suppliers).join(' ').toLowerCase() : '';
            const projNames = entry && entry.projects ? entry.projects.map(p => String(p && p.name ? p.name : '')).join(' ').toLowerCase() : '';

            const kv = (parsed && parsed.kv) ? parsed.kv : {};
            const free = (parsed && parsed.free) ? parsed.free : [];

            const hayAll = (mpn + ' ' + mfr + ' ' + desc + ' ' + drawings + ' ' + suppliers + ' ' + projNames).trim();

            const kvMap = {
                mpn,
                mfr,
                manufacturer: mfr,
                desc,
                dn: drawings,
                drawing: drawings,
                sup: suppliers,
                supplier: suppliers,
                proj: projNames,
                project: projNames
            };

            // key:value constraints (AND)
            for (const k in kv) {
                if (!Object.prototype.hasOwnProperty.call(kv, k)) continue;
                const want = String(kv[k] || '').trim();
                if (!want) continue;
                const hay = String(kvMap[k] || '');
                if (!hay.includes(want)) return { ok: false, score: 0 };
            }

            // free tokens (AND)
            for (const t of free) {
                if (t && !hayAll.includes(t)) return { ok: false, score: 0 };
            }

            // scoring: emphasize MPN
            let score = 1;
            const q = String(searchLower || '').trim();
            if (q) {
                if (mpn === q) score += 1000;
                else if (mpn.startsWith(q)) score += 500;
                else if (mpn.includes(q)) score += 250;
                if (suppliers.includes(q)) score += 90;
                if (mfr.includes(q)) score += 80;
                if (desc.includes(q)) score += 50;
                if (drawings.includes(q)) score += 30;
                if (projNames.includes(q)) score += 20;
            }

            // boosts for breadth
            try { score += Math.min(60, (entry && entry.projects ? entry.projects.length : 0) * 3); } catch (e) { }
            try { score += Math.min(60, (entry && entry.suppliers ? entry.suppliers.size : 0) * 3); } catch (e) { }
            try { score += Math.min(40, Number(entry && entry.items_count || 0) * 0.5); } catch (e) { }

            return { ok: true, score };
        }

        function openProjectAndFindMPN(projectId, mpn) {
            try { openProject(projectId); } catch (e) { console.error(e); return; }
            try { switchView('items'); } catch (e) { }
            try {
                const needle = String(mpn || '').trim().toLowerCase();
                if (!needle || !currentProject || !Array.isArray(currentProject.items)) return;
                const idx = currentProject.items.findIndex(it => {
                    const cand = String(it.mpn || it.MPN || it.part_no || it.part_number || it.item_drawing_no || it.drawing_no || '').trim().toLowerCase();
                    return cand && cand === needle;
                });
                if (idx >= 0) openDetailWindow(idx);
            } catch (e) { console.error(e); }
        }

        function renderDatabase() {
            ensureDatabaseAdvancedFiltersUI();

            const tbody = document.querySelector('#table-database tbody');
            if (!tbody) return;

            const rawQuery = databaseSearch ? String(databaseSearch.value || '').trim() : '';
            const searchLower = rawQuery.toLowerCase().trim();

            const projectFilter = databaseProjectFilter ? databaseProjectFilter.value : '';

            const dbSupplierFilterEl = getEl('db-supplier-filter');
            const dbMinProjectsEl = getEl('db-min-projects');
            const dbMaxProjectsEl = getEl('db-max-projects');
            const dbMinSuppliersEl = getEl('db-min-suppliers');
            const dbOnlyQuotedEl = getEl('db-only-quoted');

            const supplierFilter = dbSupplierFilterEl ? String(dbSupplierFilterEl.value || '').trim() : '';
            const minProjects = dbMinProjectsEl && dbMinProjectsEl.value !== '' ? parseInt(dbMinProjectsEl.value, 10) : null;
            const maxProjects = dbMaxProjectsEl && dbMaxProjectsEl.value !== '' ? parseInt(dbMaxProjectsEl.value, 10) : null;
            const minSuppliers = dbMinSuppliersEl && dbMinSuppliersEl.value !== '' ? parseInt(dbMinSuppliersEl.value, 10) : null;
            const onlyQuoted = !!(dbOnlyQuotedEl && dbOnlyQuotedEl.checked);

            if (databaseProjectFilter && databaseProjectFilter.options.length <= 1) {
                projects.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.textContent = p.name;
                    databaseProjectFilter.appendChild(opt);
                });
            }

            const all = {};
            const allSuppliers = new Set();

            // Normalize keys for grouping (MPN-centric)
            const _normKey = (v) => String(v || '').trim().toLowerCase().replace(/\s+/g, ' ');
            const _parseNum = (v) => {
                const s = String(v ?? '').trim();
                if (!s) return null;
                const cleaned = s.replace(/\s+/g, '').replace(',', '.').replace(/[^0-9.\-]/g, '');
                const n = Number(cleaned);
                return Number.isFinite(n) ? n : null;
            };


            const getMPN = (item) => {
                const keys = ['mpn', 'MPN', 'manufacturer_part_number', 'manufacturer_part_no', 'manufacturer_part_num', 'mfr_part_no', 'mfr_part_num', 'mfg_part_number', 'mfg_pn', 'part_no', 'part_number', 'pn', 'mpn_number'];
                for (const k of keys) {
                    const v = item ? item[k] : '';
                    const s = String(v ?? '').trim();
                    if (s) return s;
                }
                return '';
            };

            const addSupplierName = (entry, name) => {
                const n = String(name || '').trim();
                if (!n) return;
                entry.suppliers.add(n);
                allSuppliers.add(n);
            };

            projects.forEach(proj => {
                if (!proj || !proj.items) return;
                if (projectFilter && proj.id != projectFilter) return;

                (proj.items || []).forEach((it, itemIdx) => {
                    try { ensureItemShape(it); } catch (e) { }
                    try { syncItemHeaderFromMainSupplier(it, false); } catch (e) { }

                    const mpn = getMPN(it) || 'Unknown MPN';
                    const key = _normKey(mpn);

                    if (!all[key]) {
                        all[key] = {
                            _key: key,
                            mpn,
                            description: it.description || it.desc || it.item_description || '',
                            manufacturer: it.manufacturer || it.mfr || it.brand || '',
                            drawings: new Set(),
                            suppliers: new Set(),
                            prices: [],
                            projects: [],
                            items_count: 0,
                            project_price_map: {},
                            project_item_count: {},
                            project_details: [],
                            refs: []
                        };
                    }

                    const entry = all[key];
                    entry.items_count += 1;

                    const dn = String(it.item_drawing_no || it.drawing_no || it.drawing || it.dn || '').trim();
                    if (dn) {
                        entry.drawings.add(dn);
                    }
                    // Always keep a direct reference so clicking an MPN can open Item Detail even if drawing_no is blank
                    try { entry.refs.push({ projectId: proj.id, projectName: proj.name, index: itemIdx, drawingNo: dn }); } catch (e) { }

                    // Collect suppliers from both legacy and multi-quote structures
                    if (Array.isArray(it.suppliers)) {
                        it.suppliers.forEach(s => {
                            if (!s) return;
                            addSupplierName(entry, s.name || s.supplier || s.vendor || '');
                        });
                    }
                    addSupplierName(entry, it.supplier || it.vendor || '');

                    const p1 = _parseNum(it.price_1_euro);
                    if (p1 !== null) entry.prices.push(p1);

                    // Track prices by project for better cross-project visibility
                    try {
                        const pid = proj.id;
                        if (!entry.project_price_map) entry.project_price_map = {};
                        if (!entry.project_price_map[pid]) entry.project_price_map[pid] = [];
                        if (p1 !== null) entry.project_price_map[pid].push(p1);

                        if (!entry.project_item_count) entry.project_item_count = {};
                        entry.project_item_count[pid] = Number(entry.project_item_count[pid] || 0) + 1;

                        // Store project detail (limited later in UI)
                        if (Array.isArray(entry.project_details)) {
                            entry.project_details.push({
                                project_id: pid,
                                project_name: proj.name,
                                drawing_no: String(it.item_drawing_no || it.drawing_no || it.dn || it.item_no || it.line || '').trim(),
                                price_eur: p1
                            });
                        }
                    } catch (e) { }

                    if (!entry.projects.find(p => p.id === proj.id)) {
                        entry.projects.push({ name: proj.name, id: proj.id });
                    }
                });
            });

            // Populate supplier filter dropdown (preserve selection)
            if (dbSupplierFilterEl) {
                const cur = supplierFilter;
                const opts = Array.from(allSuppliers).sort((a, b) => String(a).localeCompare(String(b)));
                dbSupplierFilterEl.innerHTML = '<option value="">All Suppliers</option>' + opts.map(s => {
                    const esc = escapeHtml(String(s));
                    const sel = (String(s) === String(cur)) ? ' selected' : '';
                    return `<option value="${esc}"${sel}>${esc}</option>`;
                }).join('');
            }

            __dbIndex = all;

            const parsed = dbAdvParseQuery(rawQuery);

            const rows = Object.values(all)
                .map(entry => {
                    const match = dbAdvMatchAndScore(entry, parsed, searchLower);
                    return { entry, ok: match.ok, score: match.score };
                })
                .filter(x => x.ok)
                .filter(x => {
                    const entry = x.entry;
                    if (supplierFilter) {
                        if (!entry.suppliers || !entry.suppliers.has(supplierFilter)) return false;
                    }
                    const pc = entry.projects ? entry.projects.length : 0;
                    const sc = entry.suppliers ? entry.suppliers.size : 0;
                    if (minProjects !== null && Number.isFinite(minProjects) && pc < minProjects) return false;
                    if (maxProjects !== null && Number.isFinite(maxProjects) && pc > maxProjects) return false;
                    if (minSuppliers !== null && Number.isFinite(minSuppliers) && sc < minSuppliers) return false;
                    if (onlyQuoted) {
                        const hasPrice = Array.isArray(entry.prices) && entry.prices.some(v => Number.isFinite(v));
                        if (!hasPrice) return false;
                    }
                    return true;
                })
                .sort((a, b) => (b.score - a.score) || String(a.entry.mpn).localeCompare(String(b.entry.mpn)))
                .map(({ entry }) => {
                    const prices = entry.prices.filter(x => Number.isFinite(x));
                    let priceDisplay = '-';
                    if (prices.length) {
                        const min = Math.min(...prices);
                        const max = Math.max(...prices);
                        priceDisplay = (min === max) ? formatPrice(min) : `${formatPrice(min)} - ${formatPrice(max)}`;
                    }

                    const drawingsTxt = Array.from(entry.drawings).slice(0, 6).join(', ');
                    const drawingsMore = entry.drawings.size > 6 ? ` +${entry.drawings.size - 6}` : '';
                    const drawingsHtml = drawingsTxt ? `<div style="font-size:11px; color:#666; margin-top:3px;">Drawings: ${escapeHtml(drawingsTxt)}${drawingsMore}</div>` : '';

                    const supArr = Array.from(entry.suppliers || []).slice(0, 5);
                    const supMore = (entry.suppliers && entry.suppliers.size > 5) ? ` +${entry.suppliers.size - 5}` : '';
                    const supHtml = supArr.length ? `<div style="font-size:11px; color:#666; margin-top:3px;">Suppliers: ${escapeHtml(supArr.join(', '))}${supMore}</div>` : '';

                    const metaBadges = `
                        <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:6px;">
                            <span style="font-size:11px; padding:2px 8px; border:1px solid #e5e5ea; border-radius:999px; background:#fafafa; color:#444;">Projects: <b>${escapeHtml(String(entry.projects ? entry.projects.length : 0))}</b></span>
                            <span style="font-size:11px; padding:2px 8px; border:1px solid #e5e5ea; border-radius:999px; background:#fafafa; color:#444;">Suppliers: <b>${escapeHtml(String(entry.suppliers ? entry.suppliers.size : 0))}</b></span>
                            <span style="font-size:11px; padding:2px 8px; border:1px solid #e5e5ea; border-radius:999px; background:#fafafa; color:#444;">Items: <b>${escapeHtml(String(entry.items_count || 0))}</b></span>
                        </div>
                    `;

                    const projectLinks = entry.projects.map(p => {
                        const pid = p.id;
                        const list = (entry.project_price_map && entry.project_price_map[pid]) ? entry.project_price_map[pid].filter(x => Number.isFinite(x)) : [];
                        const minP = list.length ? Math.min(...list) : null;
                        const cnt = entry.project_item_count && entry.project_item_count[pid] ? Number(entry.project_item_count[pid]) : null;
                        const suffix = (minP !== null && Number.isFinite(minP)) ? ` (‚Ç¨${formatPrice(minP)}${cnt ? ` / ${cnt}` : ''})` : (cnt ? ` (${cnt})` : '');
                        const label = `${p.name}${suffix}`;
                        return `<button class="btn-text" onclick="window.openProjectAndFindMPN && window.openProjectAndFindMPN('${escapeHtml(String(pid))}', '${escapeHtml(String(entry.mpn))}')"
                                style="text-decoration: underline;">${escapeHtml(label)}</button>`;
                    }).join(', ');

                    return `
                        <tr data-db-key="${escapeAttr(entry._key || '')}">
                            <td style="width: 40px;">
                                <input type="checkbox" class="db-row-checkbox" data-db-key="${escapeAttr(entry._key || '')}" ${selectedDbParts.has(entry._key) ? 'checked' : ''}>
                            </td>
                            <td class="db-open-cell" data-db-key="${escapeAttr(entry._key || '')}" style="cursor:pointer;">
                                <span style="font-weight:800; color:#007AFF;">${escapeHtml(entry.mpn)}</span>${drawingsHtml}${supHtml}${metaBadges}
                            </td>
                            <td>${escapeHtml(entry.description || '-')}</td>
                            <td>${escapeHtml(entry.manufacturer || '-')}</td>
                            <td>${escapeHtml(priceDisplay)}</td>
                            <td>${projectLinks || '-'}</td>
                        </tr>
                    `;
                }).join('');

            tbody.innerHTML = rows || `<tr><td colspan="6" style="padding:14px; text-align:center; color:#888;">No results</td></tr>`;
            try { updateDbSelectionUI(); } catch (e) { }

            // Initialize/refresh pagination for database table
            setTimeout(() => {
                initTablePagination('table-database', { storageKey: 'rfq_database_page' });
            }, 50);
        }
        // =========================================================
        // Database (Global Parts) helpers
        // =========================================================
        function updateDbSelectionUI() {
            const countEl = getEl('db-selected-count');
            const expBtn = getEl('btn-db-export-selected');
            const clrBtn = getEl('btn-db-clear-selection');
            const n = selectedDbParts ? selectedDbParts.size : 0;

            if (countEl) countEl.textContent = `${n} selected`;
            if (expBtn) expBtn.disabled = n === 0;
            if (clrBtn) clrBtn.disabled = n === 0;

            const selAll = getEl('db-select-all');
            if (selAll) {
                const boxes = Array.from(document.querySelectorAll('#table-database tbody .db-row-checkbox'));
                const visible = boxes.filter(b => {
                    const tr = b.closest('tr');
                    return tr && tr.offsetParent !== null;
                });
                const checked = visible.filter(b => b.checked).length;
                selAll.checked = visible.length > 0 && checked === visible.length;
                selAll.indeterminate = checked > 0 && checked < visible.length;
            }
        }

        function openItemDetailByRef(ref) {
            if (!ref) return;
            const proj = projects.find(p => String(p.id) === String(ref.projectId));
            if (!proj) return;

            // Switch current project without changing current view (so Item Detail returns back correctly)
            currentProject = proj;
            try { updateProject(currentProject); } catch (e) { }
            try { setProjectNameUI(proj.name); } catch (e) { }

            let idx = Number.isFinite(ref.index) ? ref.index : -1;
            if (idx < 0) {
                idx = (proj.items || []).findIndex(it => String(it.item_drawing_no || '').trim() === String(ref.drawingNo || '').trim());
            }
            if (idx < 0) {
                showToast('Item not found in selected project.', 'warning');
                return;
            }
            try { openDetailWindow(idx); } catch (e) { try { openItemDetail(idx); } catch (e2) { } }
        }

        function showDatabaseItemPicker(entry, refs) {
            const id = 'db-item-picker';
            let overlay = getEl(id);
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = id;
                overlay.className = 'modal-overlay';
                overlay.style.zIndex = '3000';
                overlay.innerHTML = `
                    <div class="modal-content" style="max-width: 980px; width: 92vw;">
                        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                            <h3 style="margin:0;">Open Item Detail</h3>
                            <button class="btn-secondary" id="db-item-picker-close" type="button">Close</button>
                        </div>
                        <div class="muted" style="margin-top:6px;">
                            MPN: <b id="db-item-picker-mpn"></b> ‚Ä¢ Choose which project instance to open.
                        </div>
                        <div class="table-wrapper sd-table-wrap" style="margin-top:10px;">
                            <table class="rfq-table">
                                <thead>
                                    <tr>
                                        <th>Project</th>
                                        <th>Drawing No.</th>
                                        <th>Description</th>
                                        <th style="width:120px;">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="db-item-picker-body"></tbody>
                            </table>
                        </div>
                    </div>
                `;
                document.body.appendChild(overlay);
            }
            overlay.classList.remove('hidden');

            const mpnEl = getEl('db-item-picker-mpn');
            if (mpnEl) mpnEl.textContent = String(entry && entry.mpn || '');

            const body = getEl('db-item-picker-body');
            if (body) {
                body.innerHTML = (refs || []).map(r => {
                    const proj = projects.find(p => String(p.id) === String(r.projectId));
                    const it = (proj && proj.items && Number.isFinite(r.index)) ? proj.items[r.index] : null;
                    const dn = String(r.drawingNo || (it && it.item_drawing_no) || '').trim();
                    const desc = String((it && it.description) || (entry && entry.description) || '');
                    const enc = escapeAttr(encodeURIComponent(JSON.stringify({ projectId: r.projectId, index: r.index, drawingNo: dn })));
                    return `
                        <tr>
                            <td>${escapeHtml(String((proj && proj.name) || r.projectName || '-'))}</td>
                            <td>${escapeHtml(dn || '-')}</td>
                            <td>${escapeHtml(desc || '-')}</td>
                            <td><button class="btn-primary db-item-open" data-ref="${enc}" type="button">Open</button></td>
                        </tr>
                    `;
                }).join('') || `<tr><td colspan="4" style="padding:14px; text-align:center; color:#888;">No matching items</td></tr>`;
            }

            const closeBtn = getEl('db-item-picker-close');
            if (closeBtn && !closeBtn.dataset.bound) {
                closeBtn.dataset.bound = '1';
                closeBtn.onclick = () => overlay.classList.add('hidden');
            }

            overlay.onclick = (e) => {
                if (e.target === overlay) overlay.classList.add('hidden');
            };

            overlay.querySelectorAll('.db-item-open').forEach(btn => {
                btn.onclick = () => {
                    const refEnc = btn.getAttribute('data-ref') || '';
                    let refObj = null;
                    try { refObj = JSON.parse(decodeURIComponent(refEnc)); } catch (e) { }
                    overlay.classList.add('hidden');
                    if (refObj) openItemDetailByRef(refObj);
                };
            });
        }

        function openDatabaseKey(key) {
            const k = String(key || '').trim().toLowerCase();
            if (!k) return;
            const entry = __dbIndex ? __dbIndex[k] : null;
            if (!entry) return;

            let refs = Array.isArray(entry.refs) ? entry.refs.slice() : [];
            const pf = databaseProjectFilter ? String(databaseProjectFilter.value || '').trim() : '';
            if (pf) {
                const scoped = refs.filter(r => String(r.projectId) === pf);
                if (scoped.length) refs = scoped;
            }

            if (refs.length === 1) {
                openItemDetailByRef(refs[0]);
                return;
            }
            showDatabaseItemPicker(entry, refs);
        }

        function exportDatabaseSelection() {
            const keys = Array.from(selectedDbParts || []);
            if (keys.length === 0) return;

            const rows = keys.map(k => {
                const e = __dbIndex ? __dbIndex[String(k).toLowerCase()] : null;
                if (!e) return null;
                const suppliers = e.suppliers ? Array.from(e.suppliers).join('; ') : '';
                const projectsUsed = Array.isArray(e.projects) ? e.projects.map(p => p.name).join('; ') : '';
                const priceMin = Array.isArray(e.prices) && e.prices.length ? Math.min(...e.prices.filter(x => Number.isFinite(x))) : null;
                const priceMax = Array.isArray(e.prices) && e.prices.length ? Math.max(...e.prices.filter(x => Number.isFinite(x))) : null;
                return {
                    MPN: e.mpn || '',
                    Description: e.description || '',
                    Manufacturer: e.manufacturer || '',
                    ItemsCount: e.items_count || 0,
                    ProjectsCount: e.projects ? e.projects.length : 0,
                    SuppliersCount: e.suppliers ? e.suppliers.size : 0,
                    PriceMin_EUR: (priceMin === null || !isFinite(priceMin)) ? '' : Number(priceMin).toFixed(4),
                    PriceMax_EUR: (priceMax === null || !isFinite(priceMax)) ? '' : Number(priceMax).toFixed(4),
                    Suppliers: suppliers,
                    Projects: projectsUsed
                };
            }).filter(Boolean);

            const filename = `Database_Selected_${new Date().toISOString().slice(0, 10)}.xlsx`;

            if (typeof XLSX !== 'undefined' && XLSX && XLSX.utils) {
                const ws = XLSX.utils.json_to_sheet(rows);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Database');
                XLSX.writeFile(wb, filename);
                return;
            }

            // Fallback CSV
            const cols = Object.keys(rows[0] || {});
            const csv = [cols.join(',')].concat(rows.map(r => cols.map(c => {
                const v = String(r[c] ?? '');
                const safe = v.includes(',') || v.includes('\n') || v.includes('"') ? `"${v.replace(/"/g, '""')}"` : v;
                return safe;
            }).join(','))).join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename.replace('.xlsx', '.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function renderCharts(items, supplierValues) {
            if (typeof Chart === 'undefined') return;

            // Top Suppliers by Items Chart
            const supplierCounts = {};
            items.forEach(item => {
                const supplier = item.supplier || 'Unknown';
                if (supplier && supplier !== 'Unknown') {
                    supplierCounts[supplier] = (supplierCounts[supplier] || 0) + 1;
                }
            });

            const topSuppliers = Object.entries(supplierCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const suppliersCtx = getEl('chart-suppliers');
            if (suppliersCtx) {
                if (suppliersChart) suppliersChart.destroy();

                suppliersChart = new Chart(suppliersCtx, {
                    type: 'bar',
                    data: {
                        labels: topSuppliers.map(s => s[0]),
                        datasets: [{
                            label: 'Items',
                            data: topSuppliers.map(s => s[1]),
                            backgroundColor: '#007aff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1 } },
                            x: { ticks: { maxRotation: 45, minRotation: 0 } }
                        }
                    }
                });
            }

            // Value by Supplier Chart
            const supplierValueCtx = getEl('chart-supplier-value');
            if (supplierValueCtx && supplierValues) {
                if (supplierValueChart) supplierValueChart.destroy();

                const topByValue = Object.entries(supplierValues)
                    .filter(([name]) => name && name !== 'Unknown')
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                if (topByValue.length > 0) {
                    supplierValueChart = new Chart(supplierValueCtx, {
                        type: 'bar',
                        data: {
                            labels: topByValue.map(s => s[0]),
                            datasets: [{
                                label: 'Value',
                                data: topByValue.map(s => s[1]),
                                backgroundColor: '#34C759'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function (value) {
                                            if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
                                            if (value >= 1000) return (value / 1000).toFixed(0) + 'K';
                                            return value;
                                        }
                                    }
                                },
                                x: { ticks: { maxRotation: 45, minRotation: 0 } }
                            }
                        }
                    });
                }
            }
        }


        function applyFilters() {
            // Legacy filters (panel + global search) must stay.
            // With SuperTable we apply them via externalFilterFn (see Items table creation).
            filterText = (tableFilter && typeof tableFilter.value === 'string') ? tableFilter.value.trim().toLowerCase() : '';

            activeFilters = {
                status: (filterStatus && filterStatus.value) ? filterStatus.value : '',
                supplier: (filterSupplier && filterSupplier.value) ? filterSupplier.value : '',
                manufacturer: (filterManufacturer && filterManufacturer.value) ? filterManufacturer.value : '',
                priceMin: (filterPriceMin && typeof filterPriceMin.value === 'string') ? filterPriceMin.value.trim() : (filterPriceMin ? String(filterPriceMin.value || '').trim() : ''),
                priceMax: (filterPriceMax && typeof filterPriceMax.value === 'string') ? filterPriceMax.value.trim() : (filterPriceMax ? String(filterPriceMax.value || '').trim() : '')
            };

            if (itemsSuperTable) {
                itemsSuperTable.refresh();
                updateStats();
            } else {
                // Fallback (old table)
                updateStats();
            }

            // Also refresh Pricing View if it's currently visible
            const pricingView = document.getElementById('items-pricing-view');
            if (pricingView && !pricingView.classList.contains('hidden')) {
                if (typeof renderPricingView === 'function') {
                    renderPricingView();
                }
            }
        }



        function updateStats() {
            if (!currentProject || !currentProject.items) {
                if (statTotal) statTotal.textContent = '0';
                if (statDone) statDone.textContent = '0';
                if (statPending) statPending.textContent = '0';
                return;
            }

            // Prefer "visible" (filtered) set when SuperTable is active
            let items = currentProject.items;
            try {
                if (itemsSuperTable && Array.isArray(itemsSuperTable.sortedData)) {
                    items = itemsSuperTable.sortedData;
                }
            } catch (e) { }

            const total = items.length;
            let done = 0;
            let pending = 0;

            items.forEach(item => {
                const status = getItemStatusDisplay(item);
                if (status === 'Done') done++;
                else if (status === 'Pending' || status === 'New') pending++;
            });

            if (statTotal) statTotal.textContent = total;
            if (statDone) statDone.textContent = done;
            if (statPending) statPending.textContent = pending;
        }


        function updateSupplierFilter() {
            if (!currentProject || !currentProject.items) return;
            const suppliers = new Set();
            currentProject.items.forEach(item => { if (item.supplier) suppliers.add(item.supplier); });
            const currentValue = filterSupplier.value;
            filterSupplier.innerHTML = '<option value="">All Suppliers</option>';
            Array.from(suppliers).sort().forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier;
                option.textContent = supplier;
                filterSupplier.appendChild(option);
            });
            filterSupplier.value = currentValue;
        }

        function updateManufacturerFilter() {
            if (!currentProject || !currentProject.items) return;
            const manufacturers = new Set();
            currentProject.items.forEach(item => { if (item.manufacturer) manufacturers.add(item.manufacturer); });
            const currentValue = filterManufacturer.value;
            filterManufacturer.innerHTML = '<option value="">All Manufacturers</option>';
            Array.from(manufacturers).sort().forEach(manufacturer => {
                const option = document.createElement('option');
                option.value = manufacturer;
                option.textContent = manufacturer;
                filterManufacturer.appendChild(option);
            });
            filterManufacturer.value = currentValue;
        }

        function generateManualEntryForm() {
            manualEntryForm.innerHTML = '';
            const groups = [
                { title: 'Identification', fields: FIELDS.slice(0, 5) },
                { title: 'Specifications', fields: FIELDS.slice(5, 9) },
                { title: 'Quantities', fields: FIELDS.slice(9, 15) },
                { title: 'Supplier Information', fields: FIELDS.slice(15, 21) },
                { title: 'Pricing', fields: FIELDS.slice(21, 28) },
                { title: 'Additional', fields: FIELDS.slice(34) }
            ];

            groups.forEach(group => {
                const section = document.createElement('div');
                section.className = 'detail-section';
                const heading = document.createElement('h3');
                heading.textContent = group.title;
                section.appendChild(heading);
                const grid = document.createElement('div');
                grid.className = 'detail-grid';
                group.fields.forEach(field => {
                    if (field.readonly) return;
                    const formRow = document.createElement('div');
                    formRow.className = 'form-row';
                    const label = document.createElement('label');
                    label.textContent = field.label;
                    formRow.appendChild(label);
                    let input;
                    if (field.type === 'select') {
                        input = document.createElement('select');
                        field.options.forEach(opt => {
                            const option = document.createElement('option');
                            option.value = opt;
                            option.textContent = opt;
                            input.appendChild(option);
                        });
                    } else {
                        input = document.createElement('input');
                        input.type = field.type;
                        if (field.type === 'number') input.step = '0.01';
                    }
                    input.id = `form - ${field.key} `;
                    input.dataset.key = field.key;
                    formRow.appendChild(input);
                    grid.appendChild(formRow);
                });
                section.appendChild(grid);
                manualEntryForm.appendChild(section);
            });
        }

        function openManualEntryForm() {
            const inputs = manualEntryForm.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.value = input.type === 'select' ? (input.dataset.key === 'currency' ? 'EUR' : input.options[0].value) : '';
            });
            sheetManualEntry.classList.remove('hidden');
            const firstInput = manualEntryForm.querySelector('input');
            if (firstInput) firstInput.focus();
        }

        function saveManualEntry() {
            const item = {};
            const inputs = manualEntryForm.querySelectorAll('input, select');
            inputs.forEach(input => {
                if (input.dataset.key === 'status') {
                    setItemStatus(item, input.value);
                } else {
                    item[input.dataset.key] = input.value;
                }
            });
            calculateEuroValues(item);
            if (!currentProject.items) currentProject.items = [];
            currentProject.items.push(item);
            updateProject(currentProject);
            renderCompactTable();
            updateStats();
            renderSidebar();
            updateSupplierFilter();
            sheetManualEntry.classList.add('hidden');
        }

        function calculateEuroValues(item) {
            const currency = item.currency || 'EUR';
            const rate = CURRENCY_RATES[currency] || 1;
            if (item.price_1) item.price_1_euro = formatPrice(parseFloat(item.price_1) * rate);
            if (item.price_2) item.price_2_euro = formatPrice(parseFloat(item.price_2) * rate);
            if (item.price_3) item.price_3_euro = formatPrice(parseFloat(item.price_3) * rate);
            if (item.price_4) item.price_4_euro = formatPrice(parseFloat(item.price_4) * rate);
            if (item.shipping_cost) item.shipping_cost_euro = formatPrice(parseFloat(item.shipping_cost) * rate);
            if (item.additional_cost_orig) item.additional_cost = formatPrice(parseFloat(item.additional_cost_orig) * rate);
        }

        // Project picker filter state
        let projectPickerStatusFilter = 'all';
        let projectPickerSort = 'name';
        let projectPickerSearch = '';

        function renderSidebar() {
            sidebarProjects.innerHTML = '';
            projects = getProjects();

            // Get filter values from UI
            const statusFilterEl = document.getElementById('project-picker-status-filter');
            const sortEl = document.getElementById('project-picker-sort');
            const searchEl = document.getElementById('project-picker-search');

            if (statusFilterEl) projectPickerStatusFilter = statusFilterEl.value;
            if (sortEl) projectPickerSort = sortEl.value;
            if (searchEl) projectPickerSearch = searchEl.value.toLowerCase().trim();

            // Bind filter events (only once)
            if (statusFilterEl && !statusFilterEl.dataset.bound) {
                statusFilterEl.dataset.bound = '1';
                statusFilterEl.onchange = () => renderSidebar();
            }
            if (sortEl && !sortEl.dataset.bound) {
                sortEl.dataset.bound = '1';
                sortEl.onchange = () => renderSidebar();
            }
            if (searchEl && !searchEl.dataset.bound) {
                searchEl.dataset.bound = '1';
                searchEl.oninput = () => renderSidebar();
            }

            if (projects.length === 0) {
                sidebarProjects.innerHTML = '<div style="padding: 12px; font-size: 12px; color: #999; text-align: center;">No projects</div>';
                return;
            }

            // Define done statuses
            const DONE_PROJECT_STATUSES = new Set(['Done', 'Won', 'Lost', 'Closed']);

            // Filter projects
            let filteredProjects = projects.filter(project => {
                const status = project.project_status || 'Created';

                // Status filter
                if (projectPickerStatusFilter === 'open') {
                    if (DONE_PROJECT_STATUSES.has(status)) return false;
                } else if (projectPickerStatusFilter === 'done') {
                    if (!DONE_PROJECT_STATUSES.has(status)) return false;
                } else if (projectPickerStatusFilter !== 'all') {
                    if (status !== projectPickerStatusFilter) return false;
                }

                // Search filter
                if (projectPickerSearch) {
                    const name = (project.name || '').toLowerCase();
                    if (!name.includes(projectPickerSearch)) return false;
                }

                return true;
            });

            // Sort projects
            filteredProjects.sort((a, b) => {
                const statusA = a.project_status || 'Created';
                const statusB = b.project_status || 'Created';
                const isDoneA = DONE_PROJECT_STATUSES.has(statusA);
                const isDoneB = DONE_PROJECT_STATUSES.has(statusB);
                const itemsA = (a.items || []).length;
                const itemsB = (b.items || []).length;
                const sentA = (a.dates && a.dates.sent) ? new Date(a.dates.sent).getTime() : 0;
                const sentB = (b.dates && b.dates.sent) ? new Date(b.dates.sent).getTime() : 0;

                switch (projectPickerSort) {
                    case 'name':
                        return (a.name || '').localeCompare(b.name || '');
                    case 'name-desc':
                        return (b.name || '').localeCompare(a.name || '');
                    case 'status-open':
                        if (isDoneA !== isDoneB) return isDoneA ? 1 : -1;
                        return (a.name || '').localeCompare(b.name || '');
                    case 'status-done':
                        if (isDoneA !== isDoneB) return isDoneA ? -1 : 1;
                        return (a.name || '').localeCompare(b.name || '');
                    case 'items':
                        return itemsB - itemsA;
                    case 'recent':
                        return sentB - sentA;
                    default:
                        return 0;
                }
            });

            if (filteredProjects.length === 0) {
                sidebarProjects.innerHTML = '<div style="padding: 12px; font-size: 12px; color: #999; text-align: center;">No projects match filters</div>';
                return;
            }

            filteredProjects.forEach(project => {
                const item = document.createElement('div');
                item.className = 'sidebar-item';
                item.style.cssText = 'padding: 10px 12px;';
                const isActive = projectPickerIsOpen
                    ? (projectPickerPendingId && String(projectPickerPendingId) === String(project.id))
                    : (currentProject && String(currentProject.id) === String(project.id));
                if (isActive) item.classList.add('active');

                // Calculate project stats
                const items = project.items || [];
                const totalLines = items.length;
                const doneLines = items.filter(itm => {
                    const st = String(itm.status || 'New');
                    return st === 'Done' || st === 'Won' || st === 'Closed';
                }).length;

                // Project status
                const projectStatus = project.project_status || 'Created';
                const statusColor = getStatusColorUnified(projectStatus);

                // Sent date
                const dates = project.dates || {};
                const sentDate = dates.sent || '';
                const sentDateFormatted = sentDate ? new Date(sentDate).toLocaleDateString('cs-CZ') : '';

                // Project Name and extended info
                const info = document.createElement('div');
                info.style.cssText = 'flex: 1; cursor: pointer;';
                info.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <span style="font-weight: 600;">${escapeHtml(project.name)}</span>
                        <span style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px;">${escapeHtml(projectStatus)}</span>
                    </div>
                    <div style="display: flex; gap: 12px; font-size: 11px; color: #666;">
                        <span title="Total lines"><strong>${totalLines}</strong> items</span>
                        <span title="Done/Won lines" style="color: ${doneLines > 0 ? '#34C759' : '#999'};">
                            <strong>${doneLines}</strong> done
                        </span>
                        ${sentDateFormatted ? `<span title="Sent date" style="color: #5856D6;">Sent: ${sentDateFormatted}</span>` : ''}
                    </div>
                `;
                info.addEventListener('click', () => {
                    if (projectPickerIsOpen) {
                        projectPickerPendingId = project.id;
                        // Update active highlight without changing the project yet
                        renderSidebar();
                        return;
                    }
                    openProject(project);
                });

                // Actions
                const actions = document.createElement('div');
                actions.className = 'sidebar-actions';
                actions.style.cssText = 'display: none; gap: 4px; margin-left: 8px;';

                const btnRename = document.createElement('button');
                btnRename.textContent = '‚úèÔ∏è';
                btnRename.style.cssText = 'border: none; background: none; cursor: pointer; font-size: 12px; padding: 2px;';
                btnRename.title = 'Rename';
                btnRename.onclick = (e) => { e.stopPropagation(); handleRenameProject(project); };

                const btnDelete = document.createElement('button');
                btnDelete.textContent = 'üóëÔ∏è';
                btnDelete.style.cssText = 'border: none; background: none; cursor: pointer; font-size: 12px; padding: 2px;';
                btnDelete.title = 'Delete';
                btnDelete.onclick = (e) => { e.stopPropagation(); handleDeleteProject(project); };

                actions.appendChild(btnRename);
                actions.appendChild(btnDelete);

                item.appendChild(info);
                item.appendChild(actions);

                // Show actions on hover
                item.addEventListener('mouseenter', () => actions.style.display = 'flex');
                item.addEventListener('mouseleave', () => actions.style.display = 'none');

                sidebarProjects.appendChild(item);
            });
        }

        async function handleRenameProject(project) {
            const newName = await window.showPromptDialog({
                title: 'Rename Project',
                message: 'Enter new project name:',
                defaultValue: project.name,
                placeholder: 'Project name'
            });
            if (newName && newName.trim() !== '') {
                project.name = newName.trim();
                updateProject(project);
                renderSidebar();
                if (currentProject && currentProject.id === project.id) {
                    setProjectNameUI(project.name);
                    renderDashboardProjects(); // Update select in dashboard
                }
            }
        }

        async function handleDeleteProject(project) {
            const confirmed = await window.showConfirmDialog({
                title: 'Delete Project',
                message: `Are you sure you want to delete project "${project.name}"?`,
                type: 'danger',
                okText: 'Delete',
                cancelText: 'Cancel'
            });
            if (confirmed) {
                const { deleteProject } = window.RFQData; // Access delete function
                deleteProject(project.id);
                projects = getProjects(); // Refresh local list

                if (currentProject && currentProject.id === project.id) {
                    currentProject = null;
                    if (projects.length > 0) {
                        openProject(projects[0]);
                    } else {
                        showEmptyState();
                        renderSidebar();
                    }
                } else {
                    renderSidebar();
                }
                renderDashboardProjects();
            }
        }

        function handleCreateProject() {
            const name = (inputNewProjectName && inputNewProjectName.value ? inputNewProjectName.value.trim() : '');
            if (!name) {
                if (window.showToast) window.showToast('Please enter a project name', 'warning');
                return;
            }

            // Keep project dates/details (do not remove older behavior)
            const dateRec = getEl('new-project-received');
            const dateBom = getEl('new-project-bom');
            const dateDeadline = getEl('new-project-deadline');
            const dateSent = getEl('new-project-sent');
            const inputSentTo = getEl('new-project-sent-to');

            const extraData = {
                received: dateRec ? dateRec.value : '',
                bom_received: dateBom ? dateBom.value : '',
                deadline: dateDeadline ? dateDeadline.value : '',
                sent: dateSent ? dateSent.value : '',
                sent_to: inputSentTo ? inputSentTo.value : ''
            };

            const newProject = (typeof createProject === 'function') ? createProject(name, extraData) : null;
            if (!newProject) return;

            // close modal + clear inputs
            if (sheetNewProject) sheetNewProject.classList.add('hidden');
            if (inputNewProjectName) inputNewProjectName.value = '';
            if (dateRec) dateRec.value = '';
            if (dateBom) dateBom.value = '';
            if (dateDeadline) dateDeadline.value = '';
            if (dateSent) dateSent.value = '';
            if (inputSentTo) inputSentTo.value = '';

            projects = (typeof getProjects === 'function') ? getProjects() : (projects || []);
            renderSidebar();
            renderDashboardProjects();

            // Open the new project (and persist active selection)
            openProject(newProject);
        }

        function openProject(project) {
            const projectPicker = getEl('project-picker');
            if (projectPicker) {
                projectPicker.classList.add('hidden');
                projectPicker.setAttribute('aria-hidden', 'true');
            }
            currentProject = project;
            projectPickerIsOpen = false;
            projectPickerPendingId = null;
            localStorage.setItem('rfq_active_project_id', project.id);
            if (typeof updateProject === 'function') updateProject(currentProject);
            setProjectNameUI(project.name);
            renderSidebar();

            // Show project-specific tabs
            const ptg = document.querySelector('.project-tabs-group');
            if (ptg) ptg.classList.add('has-project');

            window.currentProject = currentProject; // Ensure global access

            // Reset selection on project switch
            selectedItems.clear();
            updateBulkActionBar();

            // Always switch to dashboard when project is selected
            switchView('dashboard');
        }


        // Helper: select/open project by id (used by cross-project navigation)
        window.selectProjectById = function (projectId) {
            const id = String(projectId || '').trim();
            if (!id) return null;
            const proj = (projects || []).find(p => p && String(p.id) === id) || null;
            if (!proj) return null;
            openProject(proj);
            return proj;
        };


        function showEmptyState() {
            if (emptyState) emptyState.classList.remove('hidden');
        }

        // Items SuperTable instance is declared in outer scope

        // Helper to get main supplier info
        function getMainSupplierInfo(item) {
            let mainSup = null;
            try {
                if (Array.isArray(item.suppliers)) {
                    mainSup = item.suppliers.find(s => s && (s.isMain || s.is_main)) || item.suppliers[0] || null;
                }
            } catch (e) { }
            const name = (mainSup && (mainSup.name || mainSup.supplier_name || mainSup.supplier)) ? (mainSup.name || mainSup.supplier_name || mainSup.supplier) : (item.supplier || '');
            const currency = (mainSup && (mainSup.currency || mainSup.cur)) ? (mainSup.currency || mainSup.cur) : (item.currency || 'EUR');
            return { mainSup, name, currency };
        }

        // Helper to get price from supplier
        function getItemPrice(item, priceIndex) {
            const { mainSup } = getMainSupplierInfo(item);
            try {
                let v = mainSup ? getSupplierPriceByIndex(mainSup, priceIndex) : '';
                if (!v) {
                    v = (priceIndex === 1) ? (item.price_1 || item.price || '') : (item[`price_${priceIndex}`] || '');
                }
                return v || '';
            } catch (e) {
                return '';
            }
        }

        // Helper to get sourcing strategy count
        function getSSCount(item) {
            let ssCount = 0;
            try {
                if (Array.isArray(item.sourcing_targets)) ssCount = item.sourcing_targets.length;
                else if (Array.isArray(item.sourcingTargets)) ssCount = item.sourcingTargets.length;
                else if (Array.isArray(item.sourcing_strategy)) ssCount = item.sourcing_strategy.length;
                else if (typeof item.sourcingStrategy === 'string') {
                    ssCount = item.sourcingStrategy.split(',').map(s => String(s || '').trim()).filter(Boolean).length;
                }
            } catch (e) { }
            if (!ssCount) ssCount = Array.isArray(item.suppliers) ? item.suppliers.length : 0;
            return ssCount;
        }

        // Helper to get extra quantities
        function getQtyNext(item) {
            try {
                const extra = [];
                const maxIdx = getMaxQtyIndex(item, 5);
                for (let i = 6; i <= maxIdx; i++) {
                    const v = String(item[`qty_${i}`] ?? '').trim();
                    if (v) extra.push(`Q${i}=${v}`);
                }
                return extra.join(' | ');
            } catch (e) {
                return '';
            }
        }

        // Define columns for Items SuperTable
        const itemsTableColumns = [
            { id: 'checkbox', type: 'checkbox', width: 40 },
            { id: 'line', title: 'Line #', width: 70, getValue: (item) => item.line || (currentProject.items.indexOf(item) + 1) },
            { id: 'item_drawing_no', title: 'Item/Drawing No.', width: 140 },
            { id: 'description', title: 'Description', width: 200 },
            { id: 'manufacturer', title: 'Manufacturer', width: 120 },
            { id: 'mpn', title: 'MPN', width: 100 },
            { id: 'unit', title: 'Unit', width: 60, getValue: (item) => item.unit || 'pcs' },
            {
                id: 'status',
                title: 'Status',
                width: 110,
                getValue: (item) => getItemStatusDisplay(item),
                render: (item, idx) => {
                    const statusSelect = document.createElement('select');
                    statusSelect.className = 'inline-status-select';
                    const currentStatus = getItemStatusDisplay(item);
                    // Get base status without count for matching dropdown options
                    const baseStatus = currentStatus.replace(/\s*\(\d+\)$/, '').trim();
                    statusSelect.style.cssText = 'padding: 4px 8px; border-radius: 4px; border: 1px solid #ddd; font-size: 11px; cursor: pointer; background: ' + getStatusColorUnified(currentStatus) + '; color: white; font-weight: 500;';
                    getItemStatuses().forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt;
                        option.textContent = opt;
                        if (opt === baseStatus) option.selected = true;
                        statusSelect.appendChild(option);
                    });
                    statusSelect.addEventListener('change', (e) => {
                        e.stopPropagation();
                        setItemStatus(item, e.target.value);
                        e.target.style.background = getStatusColorUnified(e.target.value);
                        updateProject(currentProject);
                        updateStats();
                        if (currentView === 'dashboard') renderDashboard();
                    });
                    statusSelect.addEventListener('click', (e) => e.stopPropagation());
                    return statusSelect;
                }
            },
            { id: 'qty_1', title: 'Qty 1', width: 70, type: 'number' },
            { id: 'qty_2', title: 'Qty 2', width: 70, type: 'number' },
            { id: 'qty_3', title: 'Qty 3', width: 70, type: 'number' },
            { id: 'qty_4', title: 'Qty 4', width: 70, type: 'number' },
            { id: 'qty_5', title: 'Qty 5', width: 70, type: 'number' },
            { id: 'qty_next', title: 'Qty next‚Ä¶', width: 100, getValue: getQtyNext },
            { id: 'supplier', title: 'Supplier', width: 140, getValue: (item) => getMainSupplierInfo(item).name },
            { id: 'currency', title: 'Currency', width: 80, getValue: (item) => getMainSupplierInfo(item).currency },
            { id: 'price_1', title: 'Price 1', width: 90, getValue: (item) => getItemPrice(item, 1), type: 'number' },
            { id: 'price_2', title: 'Price 2', width: 90, getValue: (item) => getItemPrice(item, 2), type: 'number' },
            { id: 'price_3', title: 'Price 3', width: 90, getValue: (item) => getItemPrice(item, 3), type: 'number' },
            { id: 'price_4', title: 'Price 4', width: 90, getValue: (item) => getItemPrice(item, 4), type: 'number' },
            { id: 'price_5', title: 'Price 5', width: 90, getValue: (item) => getItemPrice(item, 5), type: 'number' },
            { id: 'ss_count', title: 'SS #', width: 60, getValue: getSSCount, type: 'number' },
            { id: 'action', type: 'action', width: 50 }
        ];

        function renderCompactTable() {
            // Show/hide empty state based on whether we have items
            if (!currentProject || !currentProject.items || currentProject.items.length === 0) {
                if (emptyState) emptyState.classList.remove('hidden');
                const container = document.getElementById('items-super-table-container');
                if (container) container.innerHTML = '';
                return;
            }

            // Hide empty state when we have items to display
            if (emptyState) emptyState.classList.add('hidden');

            // Create or update SuperTable

            itemsSuperTable = createSuperTable('items-super-table-container', {
                columns: itemsTableColumns,
                storageKey: 'rfq_items_super_table',
                pageSize: 100,

                // Row coloring based on item status
                getRowStyle: (item, idx) => getItemRowStyle(item),

                // Keep legacy filters (panel + global search) working together with column filters
                externalFilterFn: (item) => {
                    try {
                        // Global search (legacy search input)
                        if (filterText) {
                            const hay = (
                                (item.item_drawing_no || '') + ' ' +
                                (item.description || '') + ' ' +
                                (item.manufacturer || '') + ' ' +
                                (item.mpn || '') + ' ' +
                                (getMainSupplierInfo(item).name || '') + ' ' +
                                getItemStatusDisplay(item)
                            ).toLowerCase();
                            if (!hay.includes(filterText)) return false;
                        }

                        // Status
                        const st = getItemStatusDisplay(item);
                        if (activeFilters.status && !statusMatchesFilter(st, activeFilters.status)) return false;

                        // Supplier (match the visible main supplier name)
                        const supName = String(getMainSupplierInfo(item).name || '').trim();
                        if (activeFilters.supplier && supName !== String(activeFilters.supplier)) return false;

                        // Manufacturer
                        const mfr = String(item.manufacturer || '').trim();
                        if (activeFilters.manufacturer && mfr !== String(activeFilters.manufacturer)) return false;

                        // Price range (prefer EUR if available)
                        const price = parseFloat(item.price_1_euro ?? item.price_eur ?? item.price_euro ?? item.price_1 ?? item.price) || 0;
                        if (activeFilters.priceMin && price < (parseFloat(activeFilters.priceMin) || 0)) return false;
                        if (activeFilters.priceMax && price > (parseFloat(activeFilters.priceMax) || 0)) return false;
                    } catch (e) {
                        // If something goes wrong in filtering, do not block the row
                        return true;
                    }
                    return true;
                },

                onRowClick: (item, idx) => {
                    if (typeof idx === 'number' && idx >= 0) openDetailWindow(idx);
                },
                onSelectionChange: (rows) => {
                    // Sync legacy selection set used elsewhere
                    try {
                        selectedItems = new Set(itemsSuperTable ? itemsSuperTable.getSelectedIndices() : []);
                    } catch (e) { }

                    // Update bulk action bar
                    const bulkBar = document.getElementById('bulk-action-bar');
                    const bulkCount = document.getElementById('bulk-count');
                    if (rows && rows.length > 0) {
                        if (bulkBar) bulkBar.classList.remove('hidden');
                        if (bulkCount) bulkCount.textContent = rows.length;
                    } else {
                        if (bulkBar) bulkBar.classList.add('hidden');
                        if (bulkCount) bulkCount.textContent = '0';
                    }
                }
            });


            // Set the data
            itemsSuperTable.setData(currentProject.items);

            // Update stats
            updateStats();
        }

        // Pricing View - displays all items with EUR conversion per QTY tier
        // Sorting and selection state for pricing view
        let pricingViewSortCol = null;
        let pricingViewSortDir = 'asc';
        const pricingSelectedItems = new Set(); // Selected item indices
        let pricingViewInitialized = false;

        function initPricingViewControls() {
            if (pricingViewInitialized) return;
            pricingViewInitialized = true;

            const selectAll = document.getElementById('pricing-select-all');
            const exportExcel = document.getElementById('pricing-export-excel');

            // Select All handler
            if (selectAll) selectAll.addEventListener('change', (e) => {
                const checked = e.target.checked;
                const checkboxes = document.querySelectorAll('#pricing-view-tbody .pricing-row-checkbox');
                checkboxes.forEach(cb => {
                    cb.checked = checked;
                    const idx = parseInt(cb.dataset.idx, 10);
                    if (checked) pricingSelectedItems.add(idx);
                    else pricingSelectedItems.delete(idx);
                });
                updatePricingSelectionInfo();
            });

            // Excel Export handler
            if (exportExcel) exportExcel.addEventListener('click', exportPricingViewExcel);
        }

        function updatePricingSelectionInfo() {
            const info = document.getElementById('pricing-selection-info');
            const selectAll = document.getElementById('pricing-select-all');
            const count = pricingSelectedItems.size;
            if (info) {
                info.textContent = count > 0 ? `${count} selected` : '';
            }
            // Update select all checkbox state
            const allCheckboxes = document.querySelectorAll('#pricing-view-tbody .pricing-row-checkbox');
            if (selectAll && allCheckboxes.length > 0) {
                const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
                const someChecked = Array.from(allCheckboxes).some(cb => cb.checked);
                selectAll.checked = allChecked;
                selectAll.indeterminate = someChecked && !allChecked;
            }
        }

        function renderPricingView() {
            initPricingViewControls();

            const summaryCards = document.getElementById('pricing-summary-cards');
            const thead = document.getElementById('pricing-view-thead');
            const tbody = document.getElementById('pricing-view-tbody');
            const totalsDiv = document.getElementById('pricing-totals');

            if (!summaryCards || !thead || !tbody || !totalsDiv) return;
            if (!currentProject || !currentProject.items || currentProject.items.length === 0) {
                summaryCards.innerHTML = '';
                thead.innerHTML = '';
                tbody.innerHTML = '<tr><td colspan="12" style="text-align:center; padding:40px; color:#999;">No items in this project</td></tr>';
                totalsDiv.innerHTML = '';
                return;
            }

            // Get currency rates from Settings
            const rates = window.RFQData && window.RFQData.CURRENCY_RATES ? window.RFQData.CURRENCY_RATES : { EUR: 1, USD: 0.92, CZK: 0.041, GBP: 1.17 };
            const decimals = window.RFQData && typeof window.RFQData.getCurrencyDecimals === 'function' ? window.RFQData.getCurrencyDecimals() : 4;

            // Use existing Items filters (shared with Table View)
            const statusFilter = document.getElementById('filter-status')?.value || '';
            const supplierFilter = document.getElementById('filter-supplier')?.value || '';
            const searchFilter = (document.getElementById('table-filter')?.value || '').toLowerCase().trim();

            // Determine max QTY tiers across all items
            let maxQtyTiers = 5;
            currentProject.items.forEach(item => {
                for (let i = 1; i <= 10; i++) {
                    const qtyVal = parseFloat(item['qty_' + i]);
                    if (qtyVal > 0 && i > maxQtyTiers) maxQtyTiers = i;
                }
            });

            // Process items and calculate totals per QTY tier
            let totalItems = 0;
            let itemsWithPrice = 0;
            let itemsDone = 0;
            const qtyTierTotals = {}; // { 1: totalEUR, 2: totalEUR, ... } - only for DONE items
            for (let i = 1; i <= maxQtyTiers; i++) {
                qtyTierTotals[i] = 0;
            }

            const rows = [];

            currentProject.items.forEach((item, idx) => {
                // Apply filters
                if (statusFilter && !statusMatchesFilter(getItemStatusDisplay(item), statusFilter)) return;

                const mainSupInfo = getMainSupplierInfo(item);
                if (supplierFilter && mainSupInfo.name !== supplierFilter) return;

                if (searchFilter) {
                    const searchStr = [item.item_drawing_no, item.description, item.manufacturer, item.mpn, mainSupInfo.name].join(' ').toLowerCase();
                    if (!searchStr.includes(searchFilter)) return;
                }

                totalItems++;

                // Get item info
                const dn = item.item_drawing_no || item.drawing_no || `Item #${idx + 1}`;
                const desc = item.description || '';
                const unit = item.unit || 'pcs';
                const supplier = mainSupInfo.name || '-';
                const currency = mainSupInfo.currency || item.currency || 'EUR';
                const rate = rates[currency] || 1;

                // Get main supplier data for prices
                let supData = null;
                if (item.suppliers && Array.isArray(item.suppliers)) {
                    supData = item.suppliers.find(s => s.isMain || s.name === supplier);
                }

                // Calculate EUR totals for each QTY tier
                const tierData = {};
                let hasAnyPrice = false;

                for (let i = 1; i <= maxQtyTiers; i++) {
                    const qty = parseFloat(item['qty_' + i]) || 0;
                    let price = 0;

                    // Get price from supplier
                    if (supData) {
                        // Try prices array first
                        if (supData.prices && Array.isArray(supData.prices)) {
                            const priceEntry = supData.prices.find(p => String(p.qty) === String(qty) || p.index === i);
                            if (priceEntry) price = parseFloat(priceEntry.price) || 0;
                        }
                        // Fallback to price_N
                        if (!price) price = parseFloat(supData['price_' + i]) || 0;
                    }
                    // Fallback to item price_N
                    if (!price) price = parseFloat(item['price_' + i]) || 0;

                    const eurPrice = price * rate;
                    const totalEur = eurPrice * qty;

                    tierData[i] = { qty, price, eurPrice, totalEur };

                    if (price > 0) {
                        hasAnyPrice = true;
                    }
                }

                if (hasAnyPrice) itemsWithPrice++;

                // Only add to tier totals if item status is "Done"
                const itemStatus = getItemStatusDisplay(item).toLowerCase();
                const isDone = itemStatus === 'done';
                if (isDone && hasAnyPrice) {
                    itemsDone++;
                    for (let i = 1; i <= maxQtyTiers; i++) {
                        if (tierData[i] && tierData[i].totalEur > 0) {
                            qtyTierTotals[i] += tierData[i].totalEur;
                        }
                    }
                }

                rows.push({
                    idx, dn, desc, unit, supplier, currency, tierData,
                    hasPrice: hasAnyPrice, isDone
                });
            });

            // Apply sorting if set
            if (pricingViewSortCol !== null) {
                rows.sort((a, b) => {
                    let valA, valB;
                    if (pricingViewSortCol === 'dn') {
                        valA = a.dn.toLowerCase(); valB = b.dn.toLowerCase();
                    } else if (pricingViewSortCol === 'desc') {
                        valA = a.desc.toLowerCase(); valB = b.desc.toLowerCase();
                    } else if (pricingViewSortCol === 'supplier') {
                        valA = a.supplier.toLowerCase(); valB = b.supplier.toLowerCase();
                    } else if (pricingViewSortCol === 'currency') {
                        valA = a.currency; valB = b.currency;
                    } else if (typeof pricingViewSortCol === 'number') {
                        // Sort by tier total EUR
                        valA = a.tierData[pricingViewSortCol]?.totalEur || 0;
                        valB = b.tierData[pricingViewSortCol]?.totalEur || 0;
                    } else {
                        return 0;
                    }
                    if (valA < valB) return pricingViewSortDir === 'asc' ? -1 : 1;
                    if (valA > valB) return pricingViewSortDir === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            // Calculate grand total (sum of all QTY tier totals - but typically you'd pick one)
            // For display, show total for QTY 1 as the "main" total
            const grandTotalQty1 = qtyTierTotals[1] || 0;

            // Render summary cards - Total Items + Total per QTY tier
            let cardsHTML = `
                <div class="pricing-summary-card">
                    <div class="label" style="font-size:11px; color:#666; text-transform:uppercase;">Total Items</div>
                    <div class="value" style="font-size:28px; font-weight:700;">${totalItems}</div>
                    <div class="sub" style="font-size:11px; color:#888;">${itemsDone} Done / ${itemsWithPrice} with prices</div>
                </div>
            `;

            // Add card for each QTY tier with totals (only DONE items)
            for (let i = 1; i <= maxQtyTiers; i++) {
                const tierTotal = qtyTierTotals[i] || 0;
                const isHighlight = i === 1;
                cardsHTML += `
                    <div class="pricing-summary-card${isHighlight ? ' highlight' : ''}" style="${isHighlight ? 'background:linear-gradient(135deg, #007AFF 0%, #5856D6 100%);' : ''}">
                        <div class="label" style="font-size:11px; ${isHighlight ? 'color:rgba(255,255,255,0.8);' : 'color:#666;'} text-transform:uppercase;">Total QTY ${i} (EUR)</div>
                        <div class="value" style="font-size:22px; font-weight:700; ${isHighlight ? 'color:white;' : ''}">${formatNumber(tierTotal, 2)}</div>
                        <div class="sub" style="font-size:11px; ${isHighlight ? 'color:rgba(255,255,255,0.7);' : 'color:#888;'}">QTY ${i} √ó Price ${i} (Done items)</div>
                    </div>
                `;
            }

            summaryCards.innerHTML = cardsHTML;

            // Render table header with sort icons
            const sortIcon = (col) => {
                if (pricingViewSortCol === col) {
                    return pricingViewSortDir === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
                }
                return ' ‚áÖ';
            };

            let headerHTML = `
                <tr style="background:#f8f9fa;">
                    <th style="width:36px; text-align:center;"></th>
                    <th style="width:40px;">#</th>
                    <th class="sortable-col" data-sort="dn" style="min-width:120px; cursor:pointer;">Drawing No${sortIcon('dn')}</th>
                    <th class="sortable-col" data-sort="desc" style="min-width:150px; cursor:pointer;">Description${sortIcon('desc')}</th>
                    <th style="width:50px;">Unit</th>
                    <th class="sortable-col" data-sort="supplier" style="min-width:100px; cursor:pointer;">Supplier${sortIcon('supplier')}</th>
                    <th class="sortable-col" data-sort="currency" style="width:60px; cursor:pointer;">Curr${sortIcon('currency')}</th>
            `;

            // Add QTY tier columns
            for (let i = 1; i <= maxQtyTiers; i++) {
                headerHTML += `<th class="sortable-col" data-sort="${i}" style="min-width:130px; text-align:right; cursor:pointer;">
                    QTY ${i} / EUR${sortIcon(i)}
                </th>`;
            }

            headerHTML += '</tr>';
            thead.innerHTML = headerHTML;

            // Add click handlers for sorting
            thead.querySelectorAll('.sortable-col').forEach(th => {
                th.onclick = () => {
                    let sortVal = th.dataset.sort;
                    // Check if it's a number (tier)
                    if (!isNaN(parseInt(sortVal))) sortVal = parseInt(sortVal);

                    if (pricingViewSortCol === sortVal) {
                        pricingViewSortDir = pricingViewSortDir === 'asc' ? 'desc' : 'asc';
                    } else {
                        pricingViewSortCol = sortVal;
                        pricingViewSortDir = 'asc';
                    }
                    renderPricingView();
                };
            });

            // Render table rows
            if (rows.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${7 + maxQtyTiers}" style="text-align:center; padding:40px; color:#999;">No items match filters</td></tr>`;
            } else {
                tbody.innerHTML = rows.map(r => {
                    const isSelected = pricingSelectedItems.has(r.idx);
                    let rowHTML = `
                        <tr class="${r.hasPrice ? 'has-price' : 'no-price'}${isSelected ? ' selected' : ''}" data-idx="${r.idx}" style="cursor:pointer;">
                            <td style="text-align:center;" onclick="event.stopPropagation();">
                                <input type="checkbox" class="pricing-row-checkbox" data-idx="${r.idx}" ${isSelected ? 'checked' : ''} style="width:15px; height:15px; cursor:pointer;">
                            </td>
                            <td>${r.idx + 1}</td>
                            <td style="font-weight:600; color:#007AFF;">${escapeHtml(r.dn)}</td>
                            <td title="${escapeHtml(r.desc)}">${escapeHtml(r.desc.length > 40 ? r.desc.substring(0, 40) + '...' : r.desc)}</td>
                            <td>${escapeHtml(r.unit)}</td>
                            <td>${escapeHtml(r.supplier)}</td>
                            <td><span style="background:#f0f0f0; padding:2px 6px; border-radius:4px; font-size:11px;">${r.currency}</span></td>
                    `;

                    // Add tier columns: show QTY √ó Price = Total EUR
                    for (let i = 1; i <= maxQtyTiers; i++) {
                        const tier = r.tierData[i];
                        if (tier && tier.qty > 0 && tier.price > 0) {
                            rowHTML += `<td class="price-cell" style="text-align:right; font-size:11px;">
                                <span style="color:#666;">${formatNumber(tier.qty, 0)} √ó ${formatNumber(tier.eurPrice, decimals)}</span><br>
                                <strong style="color:#007AFF;">${formatNumber(tier.totalEur, 2)}</strong>
                            </td>`;
                        } else if (tier && tier.qty > 0) {
                            rowHTML += `<td class="price-cell" style="text-align:right; color:#ccc;">${formatNumber(tier.qty, 0)} √ó -</td>`;
                        } else {
                            rowHTML += `<td class="price-cell" style="text-align:center; color:#ddd;">-</td>`;
                        }
                    }

                    rowHTML += '</tr>';
                    return rowHTML;
                }).join('');

                // Add click handler to open item detail
                tbody.querySelectorAll('tr[data-idx]').forEach(row => {
                    row.onclick = (e) => {
                        // Don't open detail if clicking on checkbox
                        if (e.target.type === 'checkbox') return;
                        const idx = parseInt(row.dataset.idx, 10);
                        if (!isNaN(idx)) openItemDetail(idx);
                    };
                });

                // Add checkbox change handlers
                tbody.querySelectorAll('.pricing-row-checkbox').forEach(cb => {
                    cb.addEventListener('change', (e) => {
                        const idx = parseInt(cb.dataset.idx, 10);
                        if (e.target.checked) {
                            pricingSelectedItems.add(idx);
                        } else {
                            pricingSelectedItems.delete(idx);
                        }
                        // Update row styling
                        const row = cb.closest('tr');
                        if (row) row.classList.toggle('selected', e.target.checked);
                        updatePricingSelectionInfo();
                    });
                });
            }

            // Update selection info
            updatePricingSelectionInfo();

            // Render totals footer - totals are only for DONE items
            totalsDiv.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                    <div>
                        <span style="color:#666;">Showing ${rows.length} items</span>
                        <span style="margin-left:12px; background:#34C759; color:white; padding:2px 8px; border-radius:4px; font-size:11px; font-weight:600;">${itemsDone} Done</span>
                        <span style="margin-left:12px; color:#888; font-size:11px;">Totals = only DONE items</span>
                    </div>
                    <div style="display:flex; gap:15px; flex-wrap:wrap;">
                        ${Object.entries(qtyTierTotals).map(([tier, total]) => `
                            <div style="text-align:right;">
                                <div style="font-size:11px; color:#666;">QTY ${tier} Total</div>
                                <div style="font-size:14px; font-weight:600; color:#34C759;">${formatNumber(total, 2)} ‚Ç¨</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Excel Export for Pricing View
        function exportPricingViewExcel() {
            if (!currentProject || !currentProject.items) {
                showToast('No project data to export', 'warning');
                return;
            }

            if (typeof XLSX === 'undefined') {
                showToast('XLSX library not loaded', 'error');
                return;
            }

            // Get currency rates
            const rates = window.RFQData && window.RFQData.CURRENCY_RATES ? window.RFQData.CURRENCY_RATES : { EUR: 1, USD: 0.92, CZK: 0.041, GBP: 1.17 };
            const decimals = window.RFQData && typeof window.RFQData.getCurrencyDecimals === 'function' ? window.RFQData.getCurrencyDecimals() : 4;

            // Get filters (use existing Items filters)
            const statusFilter = document.getElementById('filter-status')?.value || '';
            const supplierFilter = document.getElementById('filter-supplier')?.value || '';
            const searchFilter = (document.getElementById('table-filter')?.value || '').toLowerCase().trim();

            // Determine which items to export (selected or all visible)
            const hasSelection = pricingSelectedItems.size > 0;

            // Determine max QTY tiers
            let maxQtyTiers = 5;
            currentProject.items.forEach(item => {
                for (let i = 1; i <= 10; i++) {
                    if (parseFloat(item['qty_' + i]) > 0 && i > maxQtyTiers) maxQtyTiers = i;
                }
            });

            // Build header row
            const headers = ['#', 'Drawing No', 'Description', 'Unit', 'Supplier', 'Currency'];
            for (let i = 1; i <= maxQtyTiers; i++) {
                headers.push(`QTY ${i}`);
                headers.push(`Price ${i} (EUR)`);
                headers.push(`Total ${i} (EUR)`);
            }

            const rows = [headers];
            const qtyTierTotals = {};
            for (let i = 1; i <= maxQtyTiers; i++) qtyTierTotals[i] = 0;

            let rowNum = 0;
            currentProject.items.forEach((item, idx) => {
                // Apply filters
                if (statusFilter && !statusMatchesFilter(getItemStatusDisplay(item), statusFilter)) return;
                const mainSupInfo = getMainSupplierInfo(item);
                if (supplierFilter && mainSupInfo.name !== supplierFilter) return;
                if (searchFilter) {
                    const searchStr = [item.item_drawing_no, item.description, item.manufacturer, item.mpn, mainSupInfo.name].join(' ').toLowerCase();
                    if (!searchStr.includes(searchFilter)) return;
                }

                // If selection exists, only export selected
                if (hasSelection && !pricingSelectedItems.has(idx)) return;

                rowNum++;
                const dn = item.item_drawing_no || item.drawing_no || `Item #${idx + 1}`;
                const desc = item.description || '';
                const unit = item.unit || 'pcs';
                const supplier = mainSupInfo.name || '-';
                const currency = mainSupInfo.currency || item.currency || 'EUR';
                const rate = rates[currency] || 1;

                let supData = null;
                if (item.suppliers && Array.isArray(item.suppliers)) {
                    supData = item.suppliers.find(s => s.isMain || s.name === supplier);
                }

                const isDone = getItemStatusDisplay(item).toLowerCase() === 'done';
                const row = [rowNum, dn, desc, unit, supplier, currency];

                for (let i = 1; i <= maxQtyTiers; i++) {
                    const qty = parseFloat(item['qty_' + i]) || 0;
                    let price = 0;
                    if (supData) {
                        if (supData.prices && Array.isArray(supData.prices)) {
                            const pe = supData.prices.find(p => String(p.qty) === String(qty) || p.index === i);
                            if (pe) price = parseFloat(pe.price) || 0;
                        }
                        if (!price) price = parseFloat(supData['price_' + i]) || 0;
                    }
                    if (!price) price = parseFloat(item['price_' + i]) || 0;

                    const eurPrice = price * rate;
                    const totalEur = eurPrice * qty;

                    row.push(qty || '');
                    row.push(eurPrice > 0 ? Math.round(eurPrice * 10000) / 10000 : '');
                    row.push(totalEur > 0 ? Math.round(totalEur * 100) / 100 : '');

                    if (isDone && totalEur > 0) qtyTierTotals[i] += totalEur;
                }

                rows.push(row);
            });

            if (rows.length <= 1) {
                if (window.showToast) window.showToast('No items to export', 'warning');
                return;
            }

            // Add totals row
            const totalsRow = ['', '', '', '', 'TOTAL (Done)', ''];
            for (let i = 1; i <= maxQtyTiers; i++) {
                totalsRow.push('');
                totalsRow.push('');
                totalsRow.push(Math.round((qtyTierTotals[i] || 0) * 100) / 100);
            }
            rows.push(totalsRow);

            // Create workbook
            const ws = XLSX.utils.aoa_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Pricing View EUR');

            // Set column widths
            ws['!cols'] = [
                { wch: 5 }, { wch: 15 }, { wch: 30 }, { wch: 6 }, { wch: 15 }, { wch: 6 }
            ];
            for (let i = 1; i <= maxQtyTiers; i++) {
                ws['!cols'].push({ wch: 8 }, { wch: 12 }, { wch: 12 });
            }

            // Generate filename
            const projectName = (currentProject.name || 'RFQ').replace(/[^a-zA-Z0-9]/g, '_');
            const date = new Date().toISOString().split('T')[0];
            const filename = `${projectName}_PricingView_EUR_${date}.xlsx`;

            // Download
            XLSX.writeFile(wb, filename);
        }
        // Expose to window for Project Detail exports
        window.exportPricingViewExcel = exportPricingViewExcel;

        function getStatusColor(status) {
            return getStatusColorUnified(status);
        }

        function openItemDetail(index) { return openDetailWindow(index); }

        function openDetailWindow(index) {
            const prevView = currentView;
            currentDetailIndex = index;

            // remember where we came from (don't overwrite when we re-render inside item-detail)
            if (prevView && prevView !== 'item-detail') {
                itemDetailReturnView = prevView;
            }

            // switch to full page view (consistent with the rest of the app)
            if (typeof switchView === 'function') switchView('item-detail');
            if (detailWindow) detailWindow.classList.add('hidden');

            const item = currentProject.items[index];

            const pageTitleEl = getEl('item-detail-page-title');
            if (pageTitleEl) pageTitleEl.textContent = `Item Detail ‚Ä¢ #${item.line || (index + 1)} ‚Ä¢ ${item.item_drawing_no || ''}`.trim();

            const activeDetailRoot = getEl('item-detail-page-content') || detailContent;
            activeDetailRoot.innerHTML = '';

            // Initialize suppliers array if missing
            if (!item.suppliers) {
                item.suppliers = [];
                if (item.supplier || item.price_1) {
                    item.suppliers.push({
                        id: Date.now(),
                        name: item.supplier || 'Unknown',
                        price: item.price_1 || 0,
                        currency: item.currency || 'EUR',
                        isMain: true
                    });
                }
            }

            // --- LAYOUT SETUP ---
            const mainGrid = document.createElement('div');
            mainGrid.className = 'item-detail-layout';

            // Left Column (Navigation & Info)
            const leftCol = document.createElement('div');
            leftCol.className = 'item-detail-left';

            // Right Column (Content)
            const rightCol = document.createElement('div');
            rightCol.className = 'item-detail-right';

            // Tab Content Containers
            const tabBasic = document.createElement('div');
            tabBasic.id = 'tab-basic';
            tabBasic.className = 'item-detail-panel active';
            tabBasic.style.cssText = 'display: flex; flex-direction: column; gap: 16px;';

            const tabPricing = document.createElement('div');
            tabPricing.id = 'tab-pricing';
            tabPricing.className = 'item-detail-panel';
            tabPricing.style.cssText = 'display: none; flex-direction: column; gap: 16px;';

            const tabOthers = document.createElement('div');
            tabOthers.id = 'tab-others';
            tabOthers.className = 'item-detail-panel';
            tabOthers.style.cssText = 'display: none; flex-direction: column; gap: 16px;';

            rightCol.appendChild(tabBasic);
            rightCol.appendChild(tabPricing);
            rightCol.appendChild(tabOthers);

            mainGrid.appendChild(leftCol);
            mainGrid.appendChild(rightCol);
            activeDetailRoot.appendChild(mainGrid);

            // --- LEFT COLUMN CONTENT ---

            // 1. Navigation Card with mini tabs
            const navCard = document.createElement('div');
            navCard.className = 'item-detail-card';
            navCard.innerHTML = `
                <div class="item-detail-mini-tabs">
                    <button class="item-detail-mini-tab active" data-tab="basic">Basic</button>
                    <button class="item-detail-mini-tab" data-tab="pricing">Pricing</button>
                    <button class="item-detail-mini-tab" data-tab="others">Other</button>
                </div>
            `;

            // Tab Switching Logic
            navCard.querySelectorAll('.item-detail-mini-tab').forEach(btn => {
                btn.onclick = () => {
                    navCard.querySelectorAll('.item-detail-mini-tab').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    [tabBasic, tabPricing, tabOthers].forEach(c => {
                        c.classList.remove('active');
                        c.style.display = 'none';
                    });

                    const tabId = 'tab-' + btn.dataset.tab;
                    if (tabId === 'tab-basic') {
                        tabBasic.classList.add('active');
                        tabBasic.style.display = 'flex';
                    } else if (tabId === 'tab-pricing') {
                        tabPricing.classList.add('active');
                        tabPricing.style.display = 'flex';
                    } else if (tabId === 'tab-others') {
                        tabOthers.classList.add('active');
                        tabOthers.style.display = 'flex';
                    }
                };
            });

            leftCol.appendChild(navCard);

            // 2. Header Card with Image
            const headerCard = document.createElement('div');
            headerCard.className = 'item-detail-card item-header-card';

            const imageContainer = document.createElement('div');
            imageContainer.className = 'item-header-image';

            const renderImage = () => {
                if (item.image) {
                    imageContainer.innerHTML = `<img src="${item.image}" style="width: 100%; height: 100%; object-fit: cover;">`;
                } else {
                    imageContainer.innerHTML = `<div style="font-size: 36px; color: #ccc;">üì∑</div>`;
                }
            };
            renderImage();

            const headerTitle = document.createElement('div');
            headerTitle.className = 'item-header-title';
            headerTitle.textContent = item.item_drawing_no || `Item #${item.line || (index + 1)}`;

            const headerSubtitle = document.createElement('div');
            headerSubtitle.className = 'item-header-subtitle';
            headerSubtitle.textContent = item.description || 'No description';

            headerCard.appendChild(imageContainer);
            headerCard.appendChild(headerTitle);
            headerCard.appendChild(headerSubtitle);

            // 3. KPIs Card
            const kpiCard = document.createElement('div');
            kpiCard.className = 'item-detail-card';
            kpiCard.innerHTML = `<div class="item-detail-card-title">Statistics</div>`;

            const kpiGrid = document.createElement('div');
            kpiGrid.className = 'item-kpi-grid';

            // Calculate KPIs
            const suppliersCount = Array.isArray(item.suppliers) ? item.suppliers.length : (item.supplier ? 1 : 0);
            const mainSupplier = Array.isArray(item.suppliers) ? item.suppliers.find(s => s && (s.isMain || s.is_main)) : null;
            const bestPrice = mainSupplier ? (mainSupplier.price || mainSupplier.price_1 || 0) : (item.price_1 || item.price || 0);
            const priceCurrency = mainSupplier ? (mainSupplier.currency || item.currency || 'EUR') : (item.currency || 'EUR');
            const currencySymbols = { EUR: '‚Ç¨', USD: '$', GBP: '¬£', CZK: 'Kƒç', CHF: 'CHF', PLN: 'z≈Ç', HUF: 'Ft', CNY: '¬•', JPY: '¬•', SEK: 'kr' };
            const currSymbol = currencySymbols[priceCurrency] || priceCurrency;
            const qty1 = parseFloat(item.qty_1 || 1) || 1;
            const totalValue = parseFloat(bestPrice) * qty1;

            kpiGrid.innerHTML = `
                <div class="item-kpi">
                    <div class="item-kpi-label">Status</div>
                    <div class="item-kpi-value">${escapeHtml(getItemStatusDisplay(item))}</div>
                </div>
                <div class="item-kpi">
                    <div class="item-kpi-label">Suppliers</div>
                    <div class="item-kpi-value info">${suppliersCount}</div>
                </div>
                <div class="item-kpi">
                    <div class="item-kpi-label">Best Price</div>
                    <div class="item-kpi-value success" style="font-size: 12px;">${bestPrice ? formatPrice(parseFloat(bestPrice)) + ' ' + currSymbol : '‚Äî'}</div>
                </div>
                <div class="item-kpi">
                    <div class="item-kpi-label">Total Value</div>
                    <div class="item-kpi-value success" style="font-size: 12px;">${totalValue ? formatPrice(totalValue) + ' ' + currSymbol : '‚Äî'}</div>
                </div>
            `;
            kpiCard.appendChild(kpiGrid);

            // 3. Quick Actions Card
            const actionsCard = document.createElement('div');
            actionsCard.className = 'item-detail-card';
            actionsCard.innerHTML = `<div class="item-detail-card-title">Quick Actions</div>`;

            const actionsContainer = document.createElement('div');
            actionsContainer.className = 'item-quick-actions';

            // Image Upload Button
            const btnUploadImg = document.createElement('button');
            btnUploadImg.innerHTML = 'üì∑ Add Photo';
            btnUploadImg.className = 'btn';
            btnUploadImg.onclick = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            item.image = ev.target.result;
                            updateProject(currentProject);
                            renderImage();
                        };
                        reader.readAsDataURL(file);
                    }
                };
                input.click();
            };

            // ISSUE BUTTON
            const btnToggleIssue = document.createElement('button');
            const currentDisplayStatus = getItemStatusDisplay(item);
            const isIssue = currentDisplayStatus === 'Issue';
            btnToggleIssue.innerHTML = isIssue ? '‚úÖ Resolve Issue' : '‚ö†Ô∏è Mark as Issue';
            btnToggleIssue.className = isIssue ? 'btn btn-primary' : 'btn btn-danger';

            btnToggleIssue.onclick = () => {
                const now = new Date().toLocaleString();
                if (!item.issueHistory) item.issueHistory = [];

                if (getItemStatusDisplay(item) === 'Issue') {
                    setItemStatus(item, 'Pending');
                    item.issueHistory.push({ type: 'Resolved', date: now });
                } else {
                    setItemStatus(item, 'Issue');
                    item.issueHistory.push({ type: 'Marked as Issue', date: now });
                }
                updateProject(currentProject);
                renderCompactTable();
                if (currentView === 'dashboard') renderDashboard();
                openDetailWindow(index);
            };

            // COPY LINK BUTTON
            const btnCopyLink = document.createElement('button');
            btnCopyLink.innerHTML = 'üîó Copy Link';
            btnCopyLink.className = 'btn';
            btnCopyLink.onclick = () => {
                const linkText = `RFQ Item: ${item.item_drawing_no} (${currentProject.name})`;
                navigator.clipboard.writeText(linkText).then(() => {
                    btnCopyLink.innerHTML = '‚úÖ Copied!';
                    setTimeout(() => btnCopyLink.innerHTML = 'üîó Copy Link', 2000);
                });
            };

            // EXPORT BUTTON
            const btnExportItem = document.createElement('button');
            btnExportItem.innerHTML = 'üì§ Export Details';
            btnExportItem.className = 'btn';
            btnExportItem.onclick = () => exportSingleItem(item);

            actionsContainer.appendChild(btnUploadImg);
            actionsContainer.appendChild(btnToggleIssue);
            actionsContainer.appendChild(btnCopyLink);
            actionsContainer.appendChild(btnExportItem);
            actionsCard.appendChild(actionsContainer);

            // Append cards to left column
            leftCol.appendChild(headerCard);
            leftCol.appendChild(kpiCard);
            leftCol.appendChild(actionsCard);

            // History Section Card
            if (item.issueHistory && item.issueHistory.length > 0) {
                const historyCard = document.createElement('div');
                historyCard.className = 'item-detail-card';
                historyCard.innerHTML = `
                    <div class="item-detail-card-title">Issue History</div>
                    <ul style="padding-left: 20px; margin: 0; font-size: 12px; color: #666;">
                        ${item.issueHistory.map(h => `<li style="margin-bottom: 4px;">${h.date}: ${h.type}</li>`).join('')}
                    </ul>
                `;
                leftCol.appendChild(historyCard);
            }

            // --- COMMENTS SECTION (Moved to Left Col) - Card style ---
            const commentsSection = document.createElement('div');
            commentsSection.className = 'item-detail-card';
            commentsSection.innerHTML = `
                <div class="item-detail-card-title">Comments</div>
                <div class="item-comments-list" id="comments-list"></div>
                <div class="item-comment-input-row">
                    <textarea id="new-comment" rows="1" placeholder="Add comment..."></textarea>
                    <button id="btn-post-comment">Post</button>
                </div>
            `;
            leftCol.appendChild(commentsSection);

            const renderComments = () => {
                const list = commentsSection.querySelector('#comments-list');
                list.innerHTML = (item.comments || []).map(c => `<div class="item-comment"><span class="item-comment-time">${new Date(c.timestamp).toLocaleTimeString()}</span>${c.text}</div>`).join('');
            };
            renderComments();
            commentsSection.querySelector('#btn-post-comment').onclick = () => {
                const txt = commentsSection.querySelector('#new-comment');
                if (txt.value.trim()) {
                    if (!item.comments) item.comments = [];
                    item.comments.push({ text: txt.value, timestamp: new Date().toISOString() });
                    updateProject(currentProject);
                    txt.value = '';
                    renderComments();
                }
            };

            // Clone Comments to Pricing and Others tabs - using card style
            const commentsPricingClone = document.createElement('div');
            commentsPricingClone.className = 'item-detail-card';
            commentsPricingClone.innerHTML = `<div class="item-detail-card-title">Comments</div><div class="item-comments-list" id="comments-list-pricing"></div>`;
            tabPricing.appendChild(commentsPricingClone);

            const commentsOthersClone = document.createElement('div');
            commentsOthersClone.className = 'item-detail-card';
            commentsOthersClone.innerHTML = `<div class="item-detail-card-title">Comments</div><div class="item-comments-list" id="comments-list-others"></div><div class="item-comment-input-row"><textarea id="new-comment-others" rows="1" placeholder="Add comment..."></textarea><button id="btn-post-comment-others">Post</button></div>`;
            tabOthers.appendChild(commentsOthersClone);

            // Sync render for all Comments sections
            const renderAllComments = () => {
                const html = (item.comments || []).map(c => `<div class="item-comment"><span class="item-comment-time">${new Date(c.timestamp).toLocaleTimeString()}</span>${c.text}</div>`).join('');
                const list1 = commentsSection.querySelector('#comments-list');
                const list2 = commentsPricingClone.querySelector('#comments-list-pricing');
                const list3 = commentsOthersClone.querySelector('#comments-list-others');
                if (list1) list1.innerHTML = html;
                if (list2) list2.innerHTML = html;
                if (list3) list3.innerHTML = html;
            };
            renderAllComments();

            // Post comment handler for Others tab
            commentsOthersClone.querySelector('#btn-post-comment-others').onclick = () => {
                const txt = commentsOthersClone.querySelector('#new-comment-others');
                if (txt.value.trim()) {
                    if (!item.comments) item.comments = [];
                    item.comments.push({ text: txt.value, timestamp: new Date().toISOString() });
                    updateProject(currentProject);
                    txt.value = '';
                    renderAllComments();
                }
            };

            // --- ATTACHMENTS SECTION (Moved to Left Col) - Card style ---
            const attachSection = document.createElement('div');
            attachSection.className = 'item-detail-card';
            attachSection.innerHTML = `
                <div class="item-detail-card-title">Attachments</div>
                <div class="item-attachments-list" id="att-list"></div>
                <button id="btn-add-attachment" class="btn" style="width: 100%;">+ Add Files</button>
                <input type="file" id="att-upload" multiple style="display: none;">
            `;
            leftCol.appendChild(attachSection);

            const renderAtts = () => {
                const list = attachSection.querySelector('#att-list');
                list.innerHTML = (item.attachments || []).map((f, i) => `
                    <div class="item-attachment">
                        <span class="item-attachment-name">üìÑ ${f.name}</span>
                        <button class="btn-download btn-download-att" data-idx="${i}" title="Download">‚¨á</button>
                        <button class="btn-remove btn-remove-att" data-idx="${i}" title="Remove">√ó</button>
                    </div>
                `).join('');

                // Attach event listeners to buttons
                list.querySelectorAll('.btn-download-att').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const idx = parseInt(e.currentTarget.dataset.idx);
                        console.log('Download clicked, idx:', idx);
                        console.log('Total attachments:', item.attachments ? item.attachments.length : 0);
                        console.log('Attachment at idx:', item.attachments[idx]);

                        const f = item.attachments[idx];
                        if (f && f.data) {
                            console.log('Downloading file:', f.name);
                            const a = document.createElement('a');
                            a.href = f.data;
                            a.download = f.name || 'attachment';
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                        } else {
                            showToast('Cannot download (file data missing)', 'warning');
                        }
                    });
                });

                list.querySelectorAll('.btn-remove-att').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const idx = parseInt(e.currentTarget.dataset.idx);

                        const confirmed = await window.showConfirmDialog({
                            title: 'Delete Attachment',
                            message: 'Delete this attachment?',
                            type: 'danger',
                            okText: 'Delete',
                            cancelText: 'Cancel'
                        });
                        if (!confirmed) return;

                        item.attachments.splice(idx, 1);
                        updateProject(currentProject);
                        renderAtts();
                    });
                });
            };
            renderAtts();

            // Wire up the styled button to trigger file input
            attachSection.querySelector('#btn-add-attachment').onclick = () => {
                attachSection.querySelector('#att-upload').click();
            };

            attachSection.querySelector('#att-upload').onchange = (e) => {
                if (!item.attachments) item.attachments = [];
                Array.from(e.target.files).forEach(f => {
                    if (f.size > 5 * 1024 * 1024) {
                        showToast(`File ${f.name} is too large (>5MB). LocalStorage has limits.`, 'warning');
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        item.attachments.push({
                            name: f.name,
                            size: f.size,
                            type: f.type,
                            data: ev.target.result // Base64 string
                        });
                        updateProject(currentProject);
                        renderAtts();
                    };
                    reader.readAsDataURL(f);
                });
            };

            // Clone Attachments to Others tab - Card style
            const attachOthersClone = document.createElement('div');
            attachOthersClone.className = 'item-detail-card';
            attachOthersClone.innerHTML = `
                <div class="item-detail-card-title">Attachments</div>
                <div class="item-attachments-list" id="att-list-others"></div>
                <button id="btn-add-attachment-others" class="btn" style="width: 100%;">+ Add Files</button>
                <input type="file" id="att-upload-others" multiple style="display: none;">
            `;
            tabOthers.appendChild(attachOthersClone);

            // Sync render for all Attachments sections
            const renderAllAtts = () => {
                const html = (item.attachments || []).map((f, i) => `
                    <div class="item-attachment">
                        <span class="item-attachment-name">üìÑ ${f.name}</span>
                        <button class="btn-download btn-download-att-others" data-idx="${i}" title="Download">‚¨á</button>
                        <button class="btn-remove btn-remove-att-others" data-idx="${i}" title="Remove">√ó</button>
                    </div>
                `).join('');
                const list = attachOthersClone.querySelector('#att-list-others');
                if (list) list.innerHTML = html;

                // Attach event listeners
                list.querySelectorAll('.btn-download-att-others').forEach(btn => {
                    btn.onclick = () => {
                        const idx = parseInt(btn.dataset.idx);
                        const f = item.attachments[idx];
                        if (f && f.data) {
                            const a = document.createElement('a');
                            a.href = f.data;
                            a.download = f.name || 'attachment';
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                        }
                    };
                });

                list.querySelectorAll('.btn-remove-att-others').forEach(btn => {
                    btn.onclick = async () => {
                        const idx = parseInt(btn.dataset.idx);
                        const confirmed = await window.showConfirmDialog({
                            title: 'Delete Attachment',
                            message: 'Delete this attachment?',
                            type: 'danger',
                            okText: 'Delete',
                            cancelText: 'Cancel'
                        });
                        if (!confirmed) return;
                        item.attachments.splice(idx, 1);
                        updateProject(currentProject);
                        renderAtts();
                        renderAllAtts();
                    };
                });
            };
            renderAllAtts();

            // Wire up Others tab buttons
            attachOthersClone.querySelector('#btn-add-attachment-others').onclick = () => {
                attachOthersClone.querySelector('#att-upload-others').click();
            };

            attachOthersClone.querySelector('#att-upload-others').onchange = (e) => {
                if (!item.attachments) item.attachments = [];
                Array.from(e.target.files).forEach(f => {
                    if (f.size > 5 * 1024 * 1024) {
                        showToast(`File ${f.name} is too large (>5MB).`, 'warning');
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        item.attachments.push({
                            name: f.name,
                            size: f.size,
                            type: f.type,
                            data: ev.target.result
                        });
                        updateProject(currentProject);
                        renderAtts();
                        renderAllAtts();
                    };
                    reader.readAsDataURL(f);
                });
            };


            // --- RIGHT COLUMN CONTENT ---

            // Duplicate Detection Alert
            const findDuplicateParts = (window.RFQData && typeof window.RFQData.findDuplicateParts === 'function')
                ? window.RFQData.findDuplicateParts
                : (() => []);
            const duplicates = findDuplicateParts(item.item_drawing_no, item.mpn, currentProject && currentProject.id);

            if (duplicates.length > 0) {
                const duplicateAlert = document.createElement('div');
                duplicateAlert.style.cssText = `
                    background: linear-gradient(135deg, #FF9500 0%, #FF6B00 100%);
                    color: white;
                    padding: 16px 20px;
                    border-radius: 12px;
                    margin-bottom: 16px;
                    box-shadow: 0 4px 12px rgba(255, 149, 0, 0.3);
                `;

                const matchInfo = duplicates.map(d => {
                    const matchLabel = d.matchType === 'drawing_no' ? 'Drawing No' : 'MPN';
                    const price = d.item.price_1_euro ? `‚Ç¨${formatPrice(parseFloat(d.item.price_1_euro))}` : 'N/A';
                    const supplier = d.item.supplier || 'Unknown';

                    return `
                        <div style="margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.15); border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">üìÇ ${d.projectName}</div>
                                <div style="font-size: 11px; opacity: 0.9;">Matched by ${matchLabel} ‚Ä¢ Supplier: ${supplier} ‚Ä¢ Price: ${price}</div>
                            </div>
                            <button onclick="window.openItemInProject('${d.projectId}', '${d.item.item_drawing_no}')" 
                                    style="background: white; color: #FF9500; border: none; padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer;">
                                View ‚Üí
                            </button>
                        </div>
                    `;
                }).join('');

                duplicateAlert.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                        <div style="font-size: 24px;">‚ö†Ô∏è</div>
                        <div>
                            <div style="font-weight: 700; font-size: 15px;">Duplicate Part Found!</div>
                            <div style="font-size: 12px; opacity: 0.95;">This part was previously quoted in ${duplicates.length} other project${duplicates.length > 1 ? 's' : ''}:</div>
                        </div>
                    </div>
                    ${matchInfo}
                `;

                tabBasic.appendChild(duplicateAlert);
            }

            // 1. Info Banner - Gradient banner matching Main page style
            const banner = document.createElement('div');
            banner.className = 'item-detail-card';
            banner.style.cssText = `
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 16px 20px;
                display: flex;
                align-items: center;
                gap: 16px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            `;
            banner.innerHTML = `
                <div style="font-size: 24px; background: rgba(255,255,255,0.2); width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">üìù</div>
                <div>
                    <div style="font-weight: 700; font-size: 16px; margin-bottom: 4px;">
                        Item #${item.line || (index + 1)}: ${item.item_drawing_no || 'No Drawing No.'}
                    </div>
                    <div style="font-size: 13px; opacity: 0.9; line-height: 1.4;">
                        ${item.description || 'No description provided'}
                    </div>
                </div>
            `;
            tabBasic.appendChild(banner);

            // 2. Form Fields Groups - Using card style
            // Quantities are dynamic (qty_1..qty_N). Keep at least 5 tiers visible.
            const qtyMax = getMaxQtyIndex(item, 5);
            const qtyFields = [];
            for (let i = 1; i <= qtyMax; i++) {
                qtyFields.push({ key: `qty_${i}`, label: `QTY ${i}`, type: 'number' });
            }

            const groups = [
                {
                    title: 'Basic Information',
                    fields: FIELDS.filter(f => ['line', 'item_drawing_no', 'description', 'manufacturer', 'mpn', 'unit', 'status'].includes(f.key))
                },
                {
                    title: 'Target Pricing',
                    fields: [
                        { key: 'target_price', label: 'Target Price (EUR)', type: 'number' },
                        { key: 'target_currency', label: 'Target Currency', type: 'select', options: ['EUR', 'USD', 'CZK', 'GBP', 'CHF', 'PLN'] }
                    ]
                },
                {
                    title: 'Quantities',
                    fields: qtyFields
                }
            ];

            groups.forEach(group => {
                if (group.fields.length === 0) return;
                const section = document.createElement('div');
                section.className = 'item-detail-card';

                // Add header with button for Quantities section
                if (group.title === 'Quantities') {
                    const headerDiv = document.createElement('div');
                    headerDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;';
                    headerDiv.innerHTML = `
                        <div class="item-detail-card-title" style="margin: 0;">${group.title}</div>
                        <button id="btn-add-qty" class="btn btn-primary" style="font-size: 11px; padding: 4px 10px;">+ Add More QTY</button>
                    `;
                    section.appendChild(headerDiv);
                } else {
                    section.innerHTML = `<div class="item-detail-card-title">${group.title}</div>`;
                }

                const grid = document.createElement('div');
                grid.className = 'detail-grid';
                if (group.title === 'Quantities') grid.id = 'qty-fields-grid';

                group.fields.forEach(field => {
                    const formRow = document.createElement('div');
                    formRow.className = 'form-row';
                    formRow.innerHTML = `<label>${field.label}</label>`;

                    let input;
                    // Special handling for Status field - make it a dropdown
                    if (field.key === 'status') {
                        input = document.createElement('select');
                        const currentDisplayStatus = getItemStatusDisplay(item);
                        const baseStatus = currentDisplayStatus.replace(/\s*\(\d+\)$/, '').trim();
                        getItemStatuses().forEach(opt => {
                            const option = document.createElement('option');
                            option.value = opt;
                            option.textContent = opt;
                            if (opt === baseStatus) option.selected = true;
                            input.appendChild(option);
                        });
                        input.style.background = getStatusColorUnified(currentDisplayStatus);
                        input.style.color = 'white';
                        input.style.fontWeight = '500';
                        input.addEventListener('change', () => {
                            input.style.background = getStatusColorUnified(input.value);
                        });
                    } else if (field.key === 'unit') {
                        // Special handling for Unit field - make it a dropdown
                        input = document.createElement('select');
                        const UNITS = window.RFQData && window.RFQData.UNITS ? window.RFQData.UNITS : ['pcs', 'ea', 'set', 'kit', 'box', 'pack', 'roll', 'sheet', 'm', 'cm', 'mm', 'l', 'ml', 'kg', 'g'];
                        UNITS.forEach(opt => {
                            const option = document.createElement('option');
                            option.value = opt;
                            option.textContent = opt;
                            if (opt === (item.unit || 'pcs')) option.selected = true;
                            input.appendChild(option);
                        });
                    } else if (field.type === 'select') {
                        input = document.createElement('select');
                        field.options.forEach(opt => {
                            const option = document.createElement('option');
                            option.value = opt;
                            option.textContent = opt;
                            input.appendChild(option);
                        });
                        input.value = item[field.key] || (field.key === 'currency' ? 'EUR' : field.options[0]);
                    } else if (field.type === 'textarea') {
                        input = document.createElement('textarea');
                        input.value = item[field.key] || '';
                        input.rows = 3;
                    } else {
                        input = document.createElement('input');
                        input.type = field.type;
                        input.value = item[field.key] || '';
                        if (field.type === 'number') input.step = '0.01';
                        if (field.readonly) input.readOnly = true;
                    }
                    input.dataset.key = field.key;
                    input.className = 'rfq-input';

                    // Special handling for MPN field - add Google search button
                    if (field.key === 'mpn') {
                        const mpnContainer = document.createElement('div');
                        mpnContainer.style.cssText = 'display: flex; gap: 8px;';
                        input.style.flex = '1';

                        const googleBtn = document.createElement('button');
                        googleBtn.innerHTML = 'üîç Google';
                        googleBtn.style.cssText = `
                            padding: 8px 12px;
                            background: #4285F4;
                            color: white;
                            border: none;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 12px;
                            font-weight: 500;
                            white-space: nowrap;
                            transition: background 0.2s;
                        `;
                        googleBtn.onmouseover = () => googleBtn.style.background = '#3367D6';
                        googleBtn.onmouseout = () => googleBtn.style.background = '#4285F4';
                        googleBtn.onclick = (e) => {
                            e.preventDefault();
                            const mpnValue = input.value.trim();
                            if (mpnValue) {
                                window.open(`https://www.google.com/search?q=${encodeURIComponent(mpnValue)}`, '_blank');
                            } else {
                                showToast('Please enter an MPN value first.', 'warning');
                            }
                        };

                        mpnContainer.appendChild(input);
                        mpnContainer.appendChild(googleBtn);
                        formRow.appendChild(mpnContainer);
                    } else if (field.key === 'target_price') {
                        // Special handling for Target Price - show difference from main supplier
                        const targetContainer = document.createElement('div');
                        targetContainer.style.cssText = 'display: flex; gap: 8px; align-items: center; flex-wrap: wrap;';
                        input.style.flex = '1';
                        input.style.minWidth = '100px';

                        // Calculate price difference from main supplier
                        const rates = window.RFQData && window.RFQData.CURRENCY_RATES ? window.RFQData.CURRENCY_RATES : { EUR: 1, USD: 0.92, CZK: 0.041, GBP: 1.17 };
                        const targetPrice = parseFloat(item.target_price) || 0;
                        const targetCurrency = item.target_currency || 'EUR';
                        const targetRate = rates[targetCurrency] || 1;
                        const targetEur = targetPrice * targetRate;

                        const mainSup = (item.suppliers || []).find(s => s.isMain);
                        let priceDiffBadge = '';

                        if (mainSup && targetEur > 0) {
                            const mainCurrency = mainSup.currency || 'EUR';
                            const mainRate = rates[mainCurrency] || 1;
                            let mainPrice = 0;
                            if (mainSup.prices && mainSup.prices[0]) {
                                mainPrice = (parseFloat(mainSup.prices[0].price) || 0) * mainRate;
                            }
                            if (!mainPrice) {
                                mainPrice = (parseFloat(mainSup.price_1 || mainSup.price) || 0) * mainRate;
                            }

                            if (mainPrice > 0) {
                                const diff = mainPrice - targetEur;
                                const diffPercent = ((diff / targetEur) * 100).toFixed(1);
                                if (diff > 0) {
                                    priceDiffBadge = `<span style="background:#FF3B30; color:white; padding:4px 10px; border-radius:4px; font-size:11px; font-weight:600; white-space:nowrap;">
                                        ‚ö†Ô∏è Main: +${formatNumber(diff, 2)} ‚Ç¨ (+${diffPercent}%)
                                    </span>`;
                                } else if (diff < 0) {
                                    priceDiffBadge = `<span style="background:#34C759; color:white; padding:4px 10px; border-radius:4px; font-size:11px; font-weight:600; white-space:nowrap;">
                                        ‚úì Main: ${formatNumber(diff, 2)} ‚Ç¨ (${diffPercent}%)
                                    </span>`;
                                } else {
                                    priceDiffBadge = `<span style="background:#8e8e93; color:white; padding:4px 10px; border-radius:4px; font-size:11px; font-weight:600; white-space:nowrap;">
                                        = Target
                                    </span>`;
                                }
                            }
                        }

                        targetContainer.appendChild(input);
                        if (priceDiffBadge) {
                            const badgeSpan = document.createElement('span');
                            badgeSpan.innerHTML = priceDiffBadge;
                            targetContainer.appendChild(badgeSpan);
                        }
                        formRow.appendChild(targetContainer);
                    } else {
                        formRow.appendChild(input);
                    }

                    grid.appendChild(formRow);
                });
                section.appendChild(grid);
                tabBasic.appendChild(section);

                // Add event listener for Add More QTY button
                if (group.title === 'Quantities') {
                    const btnAddQty = section.querySelector('#btn-add-qty');
                    if (btnAddQty) {
                        btnAddQty.addEventListener('click', () => {
                            // Find highest existing qty field
                            let maxQtyNum = 5;
                            Object.keys(item).forEach(key => {
                                if (key.startsWith('qty_')) {
                                    const num = parseInt(key.split('_')[1]);
                                    if (num > maxQtyNum) maxQtyNum = num;
                                }
                            });

                            const nextQtyNum = maxQtyNum + 1;
                            const newFieldKey = `qty_${nextQtyNum}`;

                            // Create new field
                            const formRow = document.createElement('div');
                            formRow.className = 'form-row';
                            formRow.innerHTML = `<label>QTY ${nextQtyNum}</label>`;

                            const input = document.createElement('input');
                            input.type = 'number';
                            input.className = 'rfq-input';
                            input.dataset.key = newFieldKey;
                            input.value = '';
                            input.step = '0.01';
                            input.placeholder = `Quantity ${nextQtyNum}`;

                            formRow.appendChild(input);
                            grid.appendChild(formRow);

                            // Initialize value in item object if needed
                            if (item[newFieldKey] === undefined) item[newFieldKey] = '';
                        });
                    }
                }
            });

            // 3. Advanced Suppliers Section - Card style
            const supplierSection = document.createElement('div');
            supplierSection.className = 'item-detail-card';

            const renderSuppliers = () => {
                const container = supplierSection.querySelector('#suppliers-container');
                if (!container) return;

                const { getQuoteValidityStatus, getDaysUntilExpiry } = window.RFQData || {};
                const _getDaysUntilExpiry = (typeof getDaysUntilExpiry === 'function') ? getDaysUntilExpiry : () => null;
                const _getQuoteValidityStatus = (typeof getQuoteValidityStatus === 'function') ? getQuoteValidityStatus : () => '';

                const html = item.suppliers.map((sup, idx) => {
                    // Get item's QTY tiers for price display (dynamic)
                    const itemQtys = getItemQtyTiers(item, { includeBlanks: false });

                    // Build prices display
                    let pricesHTML = '';

                    // Decide if we already have any quote values (even if status is still Planned/RFQ Sent)
                    const hasAnyPrice =
                        (sup.prices && Array.isArray(sup.prices) && sup.prices.length > 0) ||
                        (itemQtys.length > 0 && itemQtys.some(t => String(getSupplierPriceByIndex(sup, t.index) ?? '').trim() !== '')) ||
                        String(sup.price ?? '').trim() !== '' ||
                        String(sup.price_1 ?? '').trim() !== '';

                    if ((sup.status === 'Planned' || sup.status === 'RFQ Sent') && !hasAnyPrice) {
                        pricesHTML = `<div style="color: #999; font-style: italic; font-size: 12px; padding: 4px 0;">Waiting for quote...</div>`;
                    } else if (sup.prices && Array.isArray(sup.prices) && sup.prices.length > 0) {
                        // Multi-tier pricing from prices array
                        pricesHTML = sup.prices.map(p =>
                            `<div><span style="color:#888;">@${p.qty}pc:</span> <b>${p.price} ${sup.currency}</b></div>`
                        ).join('');
                    } else if (itemQtys.length > 0) {
                        // Legacy: show tiered prices by index based on current item QTY tiers
                        const legacyPrices = itemQtys.map(t => ({
                            qty: t.value,
                            price: getSupplierPriceByIndex(sup, t.index)
                        })).filter(x => String(x.price ?? '').trim() !== '');

                        pricesHTML = legacyPrices.map((x) => {
                            const qty = x.qty ?? '?';
                            const p = x.price ?? '';
                            return `<div><span style="color:#888;">@${qty}pc:</span> <b>${p} ${sup.currency}</b></div>`;
                        }).join('');
                    } else {
                        pricesHTML = `<div><span style="color:#888;">Price:</span> <b>${sup.price || '-'} ${sup.currency}</b></div>`;
                    }

                    // Workflow Status Badge (Planned/RFQ Sent)
                    let workflowBadge = '';
                    if (sup.status === 'Planned') {
                        workflowBadge = `<span style="background:#8E8E93; color:white; padding:2px 8px; border-radius:10px; font-size:10px; font-weight:600; margin-left:8px;">PLANNED</span>`;
                    } else if (sup.status === 'RFQ Sent') {
                        workflowBadge = `<span style="background:#007AFF; color:white; padding:2px 8px; border-radius:10px; font-size:10px; font-weight:600; margin-left:8px;">RFQ SENT</span>`;
                    }

                    // If user already entered prices in Draft/Sent stage, show it explicitly (so it doesn't look "not updated")
                    if ((sup.status === 'Planned' || sup.status === 'RFQ Sent') && hasAnyPrice) {
                        workflowBadge += `<span style="background:#34C759; color:white; padding:2px 8px; border-radius:10px; font-size:10px; font-weight:600; margin-left:8px;">QUOTE ENTERED</span>`;
                    }

                    // Quote Validity Badge
                    let validityBadge = '';
                    if (sup.quote_valid_until) {
                        const validityStatus = _getQuoteValidityStatus(sup.quote_valid_until);
                        const daysLeft = _getDaysUntilExpiry(sup.quote_valid_until);
                        let badgeColor = '#34C759'; // Green
                        let badgeText = `Valid ${daysLeft}d`;

                        if (validityStatus === 'expired' || validityStatus === 'critical') {
                            badgeColor = '#FF3B30'; // Red
                            badgeText = daysLeft < 0 ? 'EXPIRED' : `${daysLeft}d left!`;
                        } else if (validityStatus === 'warning') {
                            badgeColor = '#FF9500'; // Orange
                            badgeText = `${daysLeft}d left`;
                        }

                        validityBadge = `<span style="background:${badgeColor}; color:white; padding:2px 8px; border-radius:10px; font-size:10px; font-weight:600; margin-left:8px;">${badgeText}</span>`;
                    }

                    // Additional info row
                    const additionalInfo = [
                        sup.moq ? `<div><span style="color:#888;">MOQ:</span> <b>${sup.moq}</b></div>` : '',
                        sup.mov ? `<div><span style="color:#888;">MOV:</span> <b>${sup.mov}</b></div>` : '',
                        sup.quote_number ? `<div><span style="color:#888;">Quote #:</span> <b>${sup.quote_number}</b></div>` : '',
                        sup.lead_time ? `<div><span style="color:#888;">Lead Time:</span> <b>${sup.lead_time}</b></div>` : '',
                        sup.shipping ? `<div><span style="color:#888;">Shipping:</span> <b>${sup.shipping}</b></div>` : '',
                        sup.incoterms ? `<div><span style="color:#888;">Incoterms:</span> <b>${sup.incoterms}</b></div>` : '',
                        sup.transferred_from ? `<div style="grid-column: 1/-1; margin-top:4px;"><span style="background:#e0e7ff; color:#4338ca; padding:3px 8px; border-radius:4px; font-size:10px;">üì• Transferred from: <b>${escapeHtml(String(sup.transferred_from))}</b>${sup.source_qty ? ` (orig. ${sup.source_qty} pcs)` : ''}</span></div>` : ''
                    ].filter(x => x).join('');

                    return `
                        <div style="background: ${sup.isMain ? '#f0f9ff' : 'white'}; border: 1px solid ${sup.isMain ? '#007AFF' : '#ddd'}; border-radius: 8px; margin-bottom: 10px; overflow: hidden;">
                            <div style="padding: 10px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee;">
                                <input type="radio" name="main-supplier" ${sup.isMain ? 'checked' : ''} data-idx="${idx}" style="cursor: pointer;">
                                <div style="font-weight: 600; font-size: 14px; flex: 1;">${sup.name}${sup.isMain ? ' <span style="background:#007AFF; color:white; padding:2px 6px; border-radius:4px; font-size:10px; margin-left:8px;">MAIN</span>' : ''}${workflowBadge}${validityBadge}</div>
                                <div style="font-size: 12px; color: #666;">${sup.currency}</div>
                                <button class="btn-edit-supplier" data-idx="${idx}" style="background: #e5e5ea; border: none; padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">Edit Details</button>
                                <button class="btn-remove-supplier" data-idx="${idx}" style="background: none; border: none; color: #ff3b30; cursor: pointer; font-size: 16px;">√ó</button>
                            </div>
                            <div style="padding: 10px; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; font-size: 12px;">
                                ${pricesHTML}
                                ${additionalInfo}
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = html || '<div style="text-align: center; color: #999; padding: 20px;">No suppliers added</div>';

                // Also update the Pricing tab clone
                const containerPricing = document.getElementById('suppliers-container-pricing');
                if (containerPricing) {
                    containerPricing.innerHTML = container.innerHTML;
                }

                // Helper to attach listeners to a container
                const attachSupplierListeners = (cont) => {
                    cont.querySelectorAll('input[name="main-supplier"]').forEach(radio => {
                        radio.addEventListener('change', (e) => {
                            const idx = parseInt(e.target.dataset.idx);
                            item.suppliers.forEach((s, i) => s.isMain = i === idx);
                            const main = item.suppliers[idx];
                            item.supplier = main.name;
                            item.price_1 = main.price;
                            item.currency = main.currency;
                            item.price_2 = main.price_2;
                            item.shipping_cost = main.shipping;
                            calculateEuroValues(item);
                            updateProject(currentProject);
                            renderSuppliers();
                            recalculateDetailEuro();
                        });
                    });

                    cont.querySelectorAll('.btn-remove-supplier').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const confirmed = await window.showConfirmDialog({
                                title: 'Remove Supplier',
                                message: 'Remove this supplier from the item?',
                                type: 'warning',
                                okText: 'Remove',
                                cancelText: 'Cancel'
                            });
                            if (!confirmed) return;
                            const idx = parseInt(e.target.dataset.idx);
                            item.suppliers.splice(idx, 1);
                            updateProject(currentProject);
                            renderSuppliers();
                        });
                    });

                    cont.querySelectorAll('.btn-edit-supplier').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const idx = parseInt(e.target.dataset.idx);
                            openSupplierModal(item.suppliers[idx], (updatedSup) => {
                                item.suppliers[idx] = updatedSup;
                                if (updatedSup.isMain) {
                                    item.supplier = updatedSup.name;
                                    item.price_1 = updatedSup.price;
                                    item.currency = updatedSup.currency;
                                    item.price_2 = updatedSup.price_2;
                                    item.shipping_cost = updatedSup.shipping;
                                    calculateEuroValues(item);
                                }
                                updateProject(currentProject);
                                renderSuppliers();
                                recalculateDetailEuro();
                            }, item);
                        });
                    });
                };

                // Attach listeners to both containers
                attachSupplierListeners(container);
                if (containerPricing) attachSupplierListeners(containerPricing);
            };


            // 2.5 Sourcing Strategy (NEW) - Card style
            const sourcingSection = document.createElement('div');
            sourcingSection.className = 'item-detail-card';
            sourcingSection.innerHTML = `
                <div class="item-detail-card-title">Sourcing Strategy</div>
                <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; border: 1px dashed #ccc;">
                    <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #555;">Add Target Supplier for RFQ</div>
                    <div style="display: flex; gap: 8px;">
                        <input id="quick-rfq-supplier" type="text" class="rfq-input" placeholder="e.g. Bosch, Siemens..." style="flex: 1;">
                        <button id="btn-add-target" class="macos-btn" style="background: #FF9500; color: white;">+ Add Target</button>
                    </div>
                    <div style="font-size: 11px; color: #888; margin-top: 6px;">
                        Adds supplier to list as "Planned". Use the "Quoting Process" tab to generate RFQs.
                    </div>
                </div>
                <div id="sourcing-targets-list" style="margin-top:10px;"></div>
            `;

            tabBasic.appendChild(sourcingSection);
            // Clone for Pricing tab
            const sourcingClone = sourcingSection.cloneNode(true);
            sourcingClone.id = 'sourcing-section-pricing';
            // Give cloned elements unique IDs
            const clonedList = sourcingClone.querySelector('#sourcing-targets-list');
            if (clonedList) clonedList.id = 'sourcing-targets-list-pricing';
            const clonedInput = sourcingClone.querySelector('#quick-rfq-supplier');
            if (clonedInput) clonedInput.id = 'quick-rfq-supplier-pricing';
            const clonedBtn = sourcingClone.querySelector('#btn-add-target');
            if (clonedBtn) clonedBtn.id = 'btn-add-target-pricing';
            tabPricing.appendChild(sourcingClone);

            // Render Target Suppliers (visible list + quick actions)
            const renderSourcingTargets = () => {
                const host = sourcingSection.querySelector('#sourcing-targets-list');
                const hostPricing = document.getElementById('sourcing-targets-list-pricing');
                if (!host) return;

                if (!Array.isArray(item.suppliers) || item.suppliers.length === 0) {
                    const emptyMsg = '<div style="font-size:12px; color:#777; padding:6px 2px;">No target suppliers yet.</div>';
                    host.innerHTML = emptyMsg;
                    if (hostPricing) hostPricing.innerHTML = emptyMsg;
                    return;
                }

                const targets = [...item.suppliers]
                    .filter(s => s && (s.name || '').trim())
                    .sort((a, b) => String(a.status || '').localeCompare(String(b.status || '')) || String(a.name || '').localeCompare(String(b.name || '')));

                const badge = (status) => {
                    const s = String(status || 'Planned');
                    const map = {
                        'Planned': 'background:#fff7ed; border:1px solid #fed7aa; color:#9a3412;',
                        'RFQ Sent': 'background:#eff6ff; border:1px solid #bfdbfe; color:#1d4ed8;',
                        'Quote Received': 'background:#ecfdf5; border:1px solid #a7f3d0; color:#065f46;',
                        'No Bid': 'background:#f3f4f6; border:1px solid #e5e7eb; color:#374151;',
                        'Expired': 'background:#fef2f2; border:1px solid #fecaca; color:#991b1b;'
                    };
                    const style = map[s] || 'background:#f3f4f6; border:1px solid #e5e7eb; color:#374151;';
                    return `<span style="font-size:11px; padding:2px 8px; border-radius:999px; ${style}">${escapeHtml(s)}</span>`;
                };

                const htmlContent = `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                        <div style="font-size:12px; font-weight:800; color:#444;">Targets</div>
                        <div style="font-size:11px; color:#777;">${targets.length} supplier(s)</div>
                    </div>
                    <div class="sourcing-targets-cards" style="display:flex; flex-direction:column; gap:6px;">
                        ${targets.map(s => `
                            <div class="target-card" data-sup-id="${escapeHtml(String(s.id ?? s.name))}"
                                 style="display:flex; justify-content:space-between; align-items:center; gap:10px; padding:8px; border:1px solid #e5e5e5; border-radius:10px; background:#fff;">
                                <div style="display:flex; flex-direction:column; gap:4px;">
                                    <div style="display:flex; align-items:center; gap:8px;">
                                        <div style="font-weight:800; font-size:12px;">${escapeHtml(s.name || '')}</div>
                                        ${badge(s.status)}
                                    </div>
                                    <div style="font-size:11px; color:#666;">
                                        ${(s.price_1 || s.price) ? `Last price: <b>${escapeHtml(String(s.price_1 || s.price))}</b> ${escapeHtml(String(s.currency || ''))}` : 'No quote yet'}
                                        ${s.valid_until ? ` ‚Ä¢ Valid: ${escapeHtml(String(s.valid_until))}` : ''}
                                    </div>
                                    ${s.transferred_from ? `
                                        <div style="font-size:10px; color:#6366f1; background:#e0e7ff; padding:2px 6px; border-radius:4px; display:inline-block; margin-top:2px;">
                                            üì• Transferred from: <b>${escapeHtml(String(s.transferred_from))}</b>
                                            ${s.source_qty ? ` (orig. ${s.source_qty} pcs)` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                                <div style="display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end;">
                                    <button class="btn-secondary btn-mini" data-action="open-quoting" data-sup-id="${escapeHtml(String(s.id ?? s.name))}">Quoting</button>
                                    <button class="btn-secondary btn-mini" data-action="mark-planned" data-sup-id="${escapeHtml(String(s.id ?? s.name))}">Planned</button>
                                    <button class="btn-danger btn-mini" data-action="remove-target" data-sup-id="${escapeHtml(String(s.id ?? s.name))}">Remove</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;

                host.innerHTML = htmlContent;
                if (hostPricing) hostPricing.innerHTML = htmlContent;

                // Helper to attach sourcing card handlers
                const attachSourcingHandlers = (container) => {
                    const cards = container.querySelector('.sourcing-targets-cards');
                    if (!cards) return;

                    cards.onclick = async (e) => {
                        const btn = e.target.closest('button[data-action]');
                        if (!btn) return;
                        const action = btn.dataset.action;
                        const supId = btn.dataset.supId;
                        const idx = (item.suppliers || []).findIndex(s => String(s.id ?? s.name) === String(supId));
                        if (idx < 0) return;

                        if (action === 'open-quoting') {
                            const supName = item.suppliers[idx].name;
                            switchView('quoting');
                            startRFQWizard(supName, [String(item.item_drawing_no || '').trim()].filter(Boolean));
                            return;
                        }

                        if (action === 'mark-planned') {
                            item.suppliers[idx].status = 'Planned';
                            updateProject(currentProject);
                            renderSuppliers();
                            renderSourcingTargets();
                            return;
                        }

                        if (action === 'remove-target') {
                            const confirmed = await window.showConfirmDialog({
                                title: 'Remove Target Supplier',
                                message: 'Remove target supplier from this item?',
                                type: 'warning',
                                okText: 'Remove',
                                cancelText: 'Cancel'
                            });
                            if (!confirmed) return;
                            item.suppliers.splice(idx, 1);
                            updateProject(currentProject);
                            renderSuppliers();
                            renderSourcingTargets();
                            return;
                        }
                    };
                };

                attachSourcingHandlers(host);
                if (hostPricing) attachSourcingHandlers(hostPricing);
            };

            renderSourcingTargets();

            // Quick Add Target Handler - shared logic
            const handleAddTarget = (inputId) => {
                const input = document.getElementById(inputId);
                if (!input) return;
                const supName = input.value.trim();
                if (!supName) return;

                // Check if already exists
                if (item.suppliers.some(s => s.name.toLowerCase() === supName.toLowerCase())) {
                    showToast('Supplier already exists in list!', 'warning');
                    return;
                }

                const newTarget = {
                    id: Date.now(),
                    name: supName,
                    currency: 'EUR',
                    isMain: false,
                    status: 'Planned',
                    price: 0,
                    price_1: 0
                };

                item.suppliers.push(newTarget);
                const mSup = getOrCreateSupplierMaster(currentProject, supName);
                if (mSup) linkItemSupplierToMaster(newTarget, mSup);
                updateProject(currentProject);
                renderSuppliers();

                input.value = '';
                // Clear both inputs
                const otherInput = document.getElementById(inputId === 'quick-rfq-supplier' ? 'quick-rfq-supplier-pricing' : 'quick-rfq-supplier');
                if (otherInput) otherInput.value = '';
                renderSourcingTargets();
            };

            sourcingSection.querySelector('#btn-add-target').onclick = () => handleAddTarget('quick-rfq-supplier');
            const pricingAddBtn = document.getElementById('btn-add-target-pricing');
            if (pricingAddBtn) pricingAddBtn.onclick = () => handleAddTarget('quick-rfq-supplier-pricing');

            supplierSection.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div class="item-detail-card-title" style="margin: 0;">Suppliers & Pricing</div>
                    <button id="btn-add-supplier" class="btn btn-primary" style="font-size: 11px; padding: 6px 12px;">+ Add Supplier</button>
                </div>
                <div id="suppliers-container"></div>
            `;
            tabBasic.appendChild(supplierSection);
            // Clone for Pricing tab
            const supplierClone = supplierSection.cloneNode(true);
            supplierClone.id = 'supplier-section-pricing';
            supplierClone.querySelector('#suppliers-container').id = 'suppliers-container-pricing';
            const clonedAddBtn = supplierClone.querySelector('#btn-add-supplier');
            if (clonedAddBtn) clonedAddBtn.id = 'btn-add-supplier-pricing';
            tabPricing.appendChild(supplierClone);
            renderSuppliers();

            // Add Supplier Handler - shared function
            const handleAddSupplier = () => {
                const newSup = { id: Date.now(), name: '', currency: 'EUR', isMain: item.suppliers.length === 0 };
                openSupplierModal(newSup, (savedSup) => {
                    item.suppliers.push(savedSup);
                    if (savedSup.isMain) {
                        item.supplier = savedSup.name;
                        item.price_1 = savedSup.price;
                        item.currency = savedSup.currency;
                        calculateEuroValues(item);
                    }
                    updateProject(currentProject);
                    renderSuppliers();
                    recalculateDetailEuro();
                }, item);
            };

            supplierSection.querySelector('#btn-add-supplier').addEventListener('click', handleAddSupplier);
            const pricingSupplierBtn = document.getElementById('btn-add-supplier-pricing');
            if (pricingSupplierBtn) pricingSupplierBtn.addEventListener('click', handleAddSupplier);


            // 3.5. Supplier Quotes & Documents Section

            // 3.4 RFQ Bundles (link Item quoting to Quoting Process) - Card style
            const bundlesSection = document.createElement('div');
            bundlesSection.className = 'item-detail-card';
            bundlesSection.innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <div class="item-detail-card-title" style="margin: 0;">RFQ Bundles for this Item</div>
        <button id="btn-create-bundle-from-item" class="btn btn-primary" style="font-size: 11px;">+ Create RFQ</button>
    </div>
    <div id="item-bundles-list"></div>
`;
            tabPricing.appendChild(bundlesSection);

            const renderItemBundles = () => {
                const host = bundlesSection.querySelector('#item-bundles-list');
                if (!host) return;
                const dn = String(item.item_drawing_no || '').trim();
                if (!dn || !currentProject) {
                    host.innerHTML = '<div style="font-size:12px; color:#777;">No RFQ bundles yet.</div>';
                    return;
                }
                const allBatches = (window.RFQData && typeof window.RFQData.getRFQBatches === 'function')
                    ? (window.RFQData.getRFQBatches(currentProject.id) || [])
                    : (currentProject.rfqBatches || currentProject.rfq_batches || []);
                const related = (Array.isArray(allBatches) ? allBatches : [])
                    .filter(b => Array.isArray(b.items) && b.items.some(x => String(x.drawing_no || '').trim() === dn))
                    .sort((a, b) => String(b.created_at || '').localeCompare(String(a.created_at || '')));
                if (related.length === 0) {
                    host.innerHTML = '<div style="font-size:12px; color:#777;">No RFQ bundles yet.</div>';
                    return;
                }
                host.innerHTML = related.map(b => {
                    const st = escapeHtml(String(b.status || 'Draft'));
                    const sup = escapeHtml(String(b.supplier_name || b.supplier || ''));
                    const due = b.due_date ? ` ‚Ä¢ Due: ${escapeHtml(String(b.due_date))}` : '';
                    return `
            <div class="bundle-row" data-bundle-id="${escapeHtml(String(b.id))}"
                 style="display:flex; justify-content:space-between; align-items:center; gap:10px; padding:10px; border:1px solid #e5e5e5; border-radius:12px; background:#fff; margin-bottom:8px; cursor:pointer;">
                <div style="display:flex; flex-direction:column; gap:2px;">
                    <div style="font-weight:800; font-size:12px;">${sup || '(Supplier)'} <span style="font-size:11px; color:#666; font-weight:700;">(${st})</span></div>
                    <div style="font-size:11px; color:#666;">${escapeHtml(String(b.created_at || '').split('T')[0] || '')}${due}</div>
                </div>
                <div style="display:flex; gap:6px;">
                    <button type="button" class="btn-secondary btn-mini" data-action="open">Open</button>
                </div>
            </div>
        `;
                }).join('');
                host.querySelectorAll('.bundle-row').forEach(row => {
                    row.addEventListener('click', () => {
                        const id = row.dataset.bundleId;
                        switchView('quoting');
                        if (typeof openRFQBatchDetail === 'function') openRFQBatchDetail(id);
                        else if (typeof openBatchDetail === 'function') openBatchDetail(id);
                    });
                });
            };
            renderItemBundles();

            bundlesSection.querySelector('#btn-create-bundle-from-item').onclick = () => {
                const dn = String(item.item_drawing_no || '').trim();
                if (!dn) return;
                const prefSup = (item.suppliers && item.suppliers[0] && item.suppliers[0].name) ? item.suppliers[0].name : '';
                switchView('quoting');
                startRFQWizard(prefSup || undefined, [dn]);
            };

            const quotesSection = document.createElement('div');
            quotesSection.className = 'item-detail-card';

            // Initialize supplier_quotes array if missing
            if (!item.supplier_quotes) {
                item.supplier_quotes = [];
            }

            const renderQuotes = () => {
                const container = quotesSection.querySelector('#quotes-container');
                if (!container) return;

                // Group quotes by supplier
                const quotesBySupplier = {};
                item.supplier_quotes.forEach(quote => {
                    const supplierName = quote.supplier_name || 'Unknown';
                    if (!quotesBySupplier[supplierName]) {
                        quotesBySupplier[supplierName] = [];
                    }
                    quotesBySupplier[supplierName].push(quote);
                });

                const html = Object.entries(quotesBySupplier).map(([supplierName, quotes]) => `
                    <div style="margin-bottom: 16px; padding: 12px; background: #f9f9f9; border-radius: 8px; border-left: 3px solid #007AFF;">
                        <div style="font-weight: 600; margin-bottom: 8px; color: #007AFF;">üìÑ ${supplierName}</div>
                        ${quotes.map((quote, idx) => {
                    const globalIdx = item.supplier_quotes.indexOf(quote);
                    const uploadDate = quote.upload_date ? new Date(quote.upload_date).toLocaleDateString() : 'Unknown';
                    return `
                                <div style="display: flex; align-items: center; gap: 10px; padding: 6px; background: white; border-radius: 4px; margin-bottom: 4px;">
                                    <div style="flex: 1; font-size: 12px;">
                                        <div style="font-weight: 500;">${quote.filename}</div>
                                        <div style="color: #888; font-size: 10px;">${uploadDate}${quote.notes ? ' ‚Ä¢ ' + quote.notes : ''}</div>
                                    </div>
                                    <button class="btn-download-quote" data-idx="${globalIdx}" style="background: #007AFF; color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">‚¨á Download</button>
                                    <button class="btn-delete-quote" data-idx="${globalIdx}" style="background: #ff3b30; color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">√ó Delete</button>
                                </div>
                            `;
                }).join('')}
                        <button class="btn-upload-quote" data-supplier="${supplierName}" style="background: #34c759; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 11px; cursor: pointer; margin-top: 8px;">+ Upload Quote for ${supplierName}</button>
                    </div>
                `).join('');

                container.innerHTML = html || '<div style="text-align: center; color: #999; padding: 20px;">No quotes uploaded yet</div>';

                // Attach download handlers
                container.querySelectorAll('.btn-download-quote').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const idx = parseInt(e.currentTarget.dataset.idx);
                        const quote = item.supplier_quotes[idx];
                        if (!quote) return;

                        const link = document.createElement('a');
                        link.href = quote.data;
                        link.download = quote.filename;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    });
                });

                // Attach delete handlers
                container.querySelectorAll('.btn-delete-quote').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const confirmed = await window.showConfirmDialog({
                            title: 'Delete Quote',
                            message: 'Delete this quote?',
                            type: 'danger',
                            okText: 'Delete',
                            cancelText: 'Cancel'
                        });
                        if (!confirmed) return;
                        const idx = parseInt(e.currentTarget.dataset.idx);
                        item.supplier_quotes.splice(idx, 1);
                        updateProject(currentProject);
                        renderQuotes();
                    });
                });

                // Attach upload handlers
                container.querySelectorAll('.btn-upload-quote').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const supplierName = e.currentTarget.dataset.supplier;
                        uploadQuoteForSupplier(supplierName);
                    });
                });
            };

            const uploadQuoteForSupplier = (supplierName) => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    // Check file size (max 10MB)
                    if (file.size > 10 * 1024 * 1024) {
                        if (window.showToast) window.showToast('File too large! Maximum size is 10MB.', 'error');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const supplier = item.suppliers?.find(s => s.name === supplierName);
                        const newQuote = {
                            id: Date.now(),
                            supplier_id: supplier?.id || Date.now(),
                            supplier_name: supplierName,
                            filename: file.name,
                            data: ev.target.result,
                            upload_date: new Date().toISOString(),
                            notes: ''
                        };
                        item.supplier_quotes.push(newQuote);
                        updateProject(currentProject);
                        renderQuotes();
                    };
                    reader.readAsDataURL(file);
                };
                input.click();
            };

            quotesSection.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div class="item-detail-card-title" style="margin: 0;">Supplier Quotes & Documents</div>
                    <button id="btn-upload-quote-general" class="btn btn-primary" style="font-size: 11px;">+ Upload Quote</button>
                </div>
                <div id="quotes-container"></div>
            `;
            tabPricing.appendChild(quotesSection);
            renderQuotes();

            // General upload button handler (with supplier selection)
            quotesSection.querySelector('#btn-upload-quote-general').addEventListener('click', () => {
                if (!item.suppliers || item.suppliers.length === 0) {
                    showToast('Please add at least one supplier first!', 'warning');
                    return;
                }

                // If only one supplier, upload directly
                if (item.suppliers.length === 1) {
                    uploadQuoteForSupplier(item.suppliers[0].name);
                    return;
                }

                // Create modal for supplier selection
                const modal = document.createElement('div');
                modal.className = 'rfq-modal-overlay';

                const content = document.createElement('div');
                content.className = 'rfq-modal-content';
                content.style.width = '400px';

                content.innerHTML = `
                    <h3 style="margin-top: 0; margin-bottom: 16px;">Select Supplier for Quote</h3>
                    <select id="supplier-select" class="rfq-input" style="width: 100%; margin-bottom: 20px;">
                        ${item.suppliers.map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
                    </select>
                    </div>

                <div id="sup-tab-nda" class="hidden">
                    <h4 style="margin: 0 0 12px 0; font-size: 13px; color: #666;">üîí NDA</h4>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom: 14px;">
                        <div class="form-row" style="grid-column:1/-1; display:flex; align-items:center; gap:10px;">
                            <input type="checkbox" id="sup-nda-signed" style="transform:scale(1.1);">
                            <label for="sup-nda-signed" style="margin:0; font-weight:600;">NDA signed</label>
                        </div>
                        <div class="form-row"><label>Signed date</label><input type="date" class="rfq-input" id="sup-nda-date"></div>
                        <div class="form-row"><label>Storage / Link</label><input class="rfq-input" id="sup-nda-storage" placeholder="e.g. SharePoint link, folder path"></div>
                    </div>
                    <div class="form-row"><label>Notes</label><textarea class="rfq-input" id="sup-master-notes" rows="3" placeholder="NDA notes, legal contact, etc."></textarea></div>
                </div>

                <div id="sup-tab-custom" class="hidden">
                    <h4 style="margin: 0 0 12px 0; font-size: 13px; color: #666;">üß© Custom Fields</h4>
                    <div style="display:flex; gap:8px; margin-bottom:12px;">
                        <input class="rfq-input" id="sup-custom-key" placeholder="Field name" style="flex:1;">
                        <input class="rfq-input" id="sup-custom-val" placeholder="Value" style="flex:2;">
                        <button type="button" class="macos-btn" id="sup-custom-add" style="background:#34c759;color:#fff;">+ Add</button>
                    </div>
                    <div id="sup-custom-list" style="display:flex; flex-direction:column; gap:8px;"></div>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                        <button id="btn-cancel-upload" class="macos-btn" style="background: #ccc;">Zru≈°it</button>
                        <button id="btn-upload-confirm" class="macos-btn" style="background: #34c759; color: white;">Upload Quote</button>
                    </div>
                `;

                modal.appendChild(content);
                document.body.appendChild(modal);

                content.querySelector('#btn-cancel-upload').onclick = () => document.body.removeChild(modal);
                content.querySelector('#btn-upload-confirm').onclick = () => {
                    const selectedSupplier = content.querySelector('#supplier-select').value;
                    document.body.removeChild(modal);
                    uploadQuoteForSupplier(selectedSupplier);
                };
            });


            // 4. Calculated Values
            const calcSection = document.createElement('div');
            calcSection.className = 'item-detail-card';
            calcSection.innerHTML = `<div class="item-detail-card-title">Calculated EUR Values</div><div id="calc-values-grid" class="detail-grid"></div>`;
            tabPricing.appendChild(calcSection);

            window.recalculateDetailEuro = () => {
                const grid = calcSection.querySelector('#calc-values-grid');
                if (!grid) return;
                calculateEuroValues(item);
                const fields = [
                    { label: 'Price 1 (EUR)', val: item.price_1_euro },
                    { label: 'Shipping (EUR)', val: item.shipping_cost_euro },
                    { label: 'Additional (EUR)', val: item.additional_cost }
                ];
                grid.innerHTML = fields.map(f => `
                    <div class="form-row">
                        <label>${f.label}</label>
                        <input type="text" value="${f.val || ''}" readonly class="rfq-input" style="background: #f5f5f7; color: #666;">
                    </div>
                `).join('');
            };
            recalculateDetailEuro();

            if (detailWindow && currentView !== 'item-detail') detailWindow.classList.remove('hidden');
        }

        function openSupplierModal(supplier, onUlo≈æit, item) {
            // Project-level supplier master (NDA + custom fields)
            let master = null;
            if (currentProject) {
                ensureProjectSuppliers(currentProject);
                master = supplier && supplier.master_id ? getSupplierMasterById(currentProject, supplier.master_id) : null;
                if (!master && supplier && supplier.name) master = getSupplierMasterByName(currentProject, supplier.name);
                if (!master && supplier && supplier.name) master = getOrCreateSupplierMaster(currentProject, supplier.name);
                if (master) linkItemSupplierToMaster(supplier, master);
            }

            const modal = document.createElement('div');
            modal.className = 'rfq-modal-overlay';

            const wrapper = document.createElement('div');
            wrapper.className = 'rfq-modal';
            wrapper.style.width = '720px';

            const content = document.createElement('div');
            content.className = 'rfq-modal-content';

            // Dynamic price inputs based on item QTY tiers (qty_1..qty_N)
            const itemQtys = getItemQtyTiers(item, { includeBlanks: false });

            const existingPrices = Array.isArray(supplier.prices) ? supplier.prices : [];
            const getPriceForQty = (qty) => {
                const found = existingPrices.find(p => Number(p.qty) === Number(qty));
                return found ? (found.price ?? '') : '';
            };

            const { INCOTERMS } = window.RFQData || { INCOTERMS: [] };
            const incotermOptions = (INCOTERMS || []).map(term =>
                `<option value="${escapeHtml(term)}" ${supplier.incoterms === term ? 'selected' : ''}>${escapeHtml(term)}</option>`
            ).join('');

            const masterNda = (master && master.nda) ? master.nda : { signed: false, signed_date: '', storage: '' };
            const masterCustom = (master && Array.isArray(master.custom)) ? master.custom : [];
            const masterNotes = (master && master.notes) ? master.notes : '';

            content.innerHTML = `
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px; margin-bottom:12px;">
            <div>
                <div style="font-weight:900; font-size:16px;">Supplier</div>
                <div style="font-size:12px; color:#666;">Item: <b>${escapeHtml(String(item.item_drawing_no || ''))}</b> ‚Ä¢ ${escapeHtml(String(item.description || '').slice(0, 60))}</div>
            </div>
            <button type="button" id="sup-close-x" class="macos-btn" style="background:#eee;">‚úï</button>
        </div>

        <div style="display:flex; gap:8px; margin-bottom:14px;">
            <button type="button" class="macos-btn sup-tab-btn" data-tab="quote" style="background:#007AFF;color:#fff;">Quote</button>
            <button type="button" class="macos-btn sup-tab-btn" data-tab="nda" style="background:#eee;">NDA</button>
            <button type="button" class="macos-btn sup-tab-btn" data-tab="custom" style="background:#eee;">Custom</button>
        </div>

        <div id="sup-tab-quote">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:14px;">
                <div class="form-row"><label>Name</label><input class="rfq-input" id="sup-name" value="${escapeHtml(String(supplier.name || ''))}"></div>
                <div class="form-row">
                    <label>Currency</label>
                    <select class="rfq-input" id="sup-curr">
                        <option value="EUR">EUR</option><option value="USD">USD</option><option value="CZK">CZK</option><option value="GBP">GBP</option>
                    </select>
                </div>
            </div>

            <h4 style="margin: 10px 0 10px 0; font-size: 13px; color: #666;">üìÖ RFQ Tracking</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:14px;">
                <div class="form-row"><label>RFQ Sent Date</label><input type="date" class="rfq-input" id="sup-rfq-sent" value="${escapeHtml(String(supplier.rfq_sent_date || ''))}"></div>
                <div class="form-row"><label>Quote Received Date</label><input type="date" class="rfq-input" id="sup-quote-received" value="${escapeHtml(String(supplier.quote_received_date || ''))}"></div>
                <div class="form-row"><label>Quote Valid Until</label><input type="date" class="rfq-input" id="sup-valid-until" value="${escapeHtml(String(supplier.quote_valid_until || ''))}"></div>
                <div class="form-row">
                    <label>Quote Status</label>
                    <select class="rfq-input" id="sup-quote-status">
                        ${getSupplierQuoteStatuses().map(st => `<option value="${escapeHtml(st)}" ${supplier.quote_status === st || (!supplier.quote_status && st === 'Active') ? 'selected' : ''}>${escapeHtml(st)}</option>`).join('')}
                    </select>
                </div>
            </div>

            <h4 style="margin: 10px 0 10px 0; font-size: 13px; color: #666;">üí∞ Pricing (based on item QTYs)</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:14px;">
                ${itemQtys.length ? itemQtys.map(q => `
                    <div class="form-row">
                        <label>Price @${escapeHtml(String(q.value))}pc</label>
                        <input type="number" step="0.01" class="rfq-input price-qty-input"
                               data-qty="${escapeHtml(String(q.value))}" data-qty-index="${q.index}"
                               value="${escapeHtml(String(getPriceForQty(q.value)))}"
                               placeholder="Price for ${escapeHtml(String(q.value))} pcs">
                    </div>
                `).join('') : `<div style="grid-column:1/-1; text-align:center; color:#888; padding:14px; border:1px dashed #ddd; border-radius:12px;">No QTY values defined on item.</div>`}
            </div>

            <h4 style="margin: 10px 0 10px 0; font-size: 13px; color: #666;">üìã Additional Info</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:14px;">
                <div class="form-row"><label>MOQ</label><input class="rfq-input" id="sup-moq" value="${escapeHtml(String(supplier.moq || ''))}"></div>
                <div class="form-row"><label>MOV</label><input class="rfq-input" id="sup-mov" value="${escapeHtml(String(supplier.mov || ''))}"></div>
                <div class="form-row"><label>Quote Number</label><input class="rfq-input" id="sup-quote" value="${escapeHtml(String(supplier.quote_number || ''))}"></div>
                <div class="form-row"><label>Lead Time</label><input class="rfq-input" id="sup-lead" value="${escapeHtml(String(supplier.lead_time || ''))}" placeholder="e.g. 6-8 weeks"></div>
                <div class="form-row"><label>Shipping Cost</label><input type="number" step="0.01" class="rfq-input" id="sup-ship" value="${escapeHtml(String(toNumberInputValue(supplier.shipping || '')))}"></div>
                <div class="form-row">
                    <label>Incoterms</label>
                    <select class="rfq-input" id="sup-incoterms">
                        <option value="">-- Select --</option>
                        ${incotermOptions}
                    </select>
                </div>
            </div>
        </div>

        <div id="sup-tab-nda" class="hidden">
            <h4 style="margin: 0 0 10px 0; font-size: 13px; color: #666;">üîí NDA</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:14px;">
                <div class="form-row" style="grid-column:1/-1; display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="sup-nda-signed" style="transform:scale(1.15);" ${masterNda.signed ? 'checked' : ''}>
                    <label for="sup-nda-signed" style="margin:0; font-weight:700;">NDA signed</label>
                </div>
                <div class="form-row"><label>Signed date</label><input type="date" class="rfq-input" id="sup-nda-date" value="${escapeHtml(String(masterNda.signed_date || ''))}"></div>
                <div class="form-row"><label>Stored (link/path)</label><input class="rfq-input" id="sup-nda-storage" placeholder="e.g. SharePoint URL / folder path" value="${escapeHtml(String(masterNda.storage || ''))}"></div>
            </div>
            <div class="form-row">
                <label>Supplier notes</label>
                <textarea class="rfq-input" id="sup-master-notes" rows="4" placeholder="Supplier master notes...">${escapeHtml(String(masterNotes || ''))}</textarea>
            </div>
        </div>

        <div id="sup-tab-custom" class="hidden">
            <h4 style="margin: 0 0 10px 0; font-size: 13px; color: #666;">‚ûï Custom fields (supplier master)</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr auto; gap:10px; margin-bottom:12px;">
                <input class="rfq-input" id="sup-custom-key" placeholder="Field name (e.g. Payment Terms)">
                <input class="rfq-input" id="sup-custom-val" placeholder="Value (e.g. Net 60)">
                <button type="button" id="sup-custom-add" class="macos-btn" style="background:#34c759; color:#fff;">Add</button>
            </div>
            <div id="sup-custom-list" style="display:flex; flex-direction:column; gap:8px;">
                ${masterCustom.length ? masterCustom.map((r, idx) => `
                    <div style="display:flex; gap:8px; align-items:center; padding:8px; border:1px solid #e5e5e5; border-radius:10px; background:#fff;">
                        <div style="flex:1; font-size:12px;">
                            <b>${escapeHtml(String(r.key || ''))}</b>
                            <div style="color:#666; font-size:11px;">${escapeHtml(String(r.value || ''))}</div>
                        </div>
                        <button type="button" class="btn-danger btn-mini sup-custom-del" data-idx="${idx}">Remove</button>
                    </div>
                `).join('') : `<div style="font-size:12px; color:#777;">No custom fields yet.</div>`}
            </div>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:16px;">
            <button type="button" id="btn-cancel" class="macos-btn" style="background:#ccc;">Zru≈°it</button>
            <button type="button" id="btn-save" class="macos-btn" style="background:#007AFF; color:#fff;">Ulo≈æit</button>
        </div>
    `;

            wrapper.appendChild(content);
            modal.appendChild(wrapper);
            document.body.appendChild(modal);

            const close = () => { if (modal.parentNode) document.body.removeChild(modal); };
            content.querySelector('#sup-close-x').onclick = close;
            content.querySelector('#btn-cancel').onclick = close;

            // Init currency select
            content.querySelector('#sup-curr').value = supplier.currency || 'EUR';

            // Custom rows state
            let customRows = (master && Array.isArray(master.custom)) ? [...master.custom] : [];
            const customListEl = content.querySelector('#sup-custom-list');
            const renderCustom = () => {
                if (!customListEl) return;
                if (!customRows.length) {
                    customListEl.innerHTML = '<div style="font-size:12px; color:#777;">No custom fields yet.</div>';
                    return;
                }
                customListEl.innerHTML = customRows.map((r, idx) => `
            <div style="display:flex; gap:8px; align-items:center; padding:8px; border:1px solid #e5e5e5; border-radius:10px; background:#fff;">
                <div style="flex:1; font-size:12px;">
                    <b>${escapeHtml(String(r.key || ''))}</b>
                    <div style="color:#666; font-size:11px;">${escapeHtml(String(r.value || ''))}</div>
                </div>
                <button type="button" class="btn-danger btn-mini sup-custom-del" data-idx="${idx}">Remove</button>
            </div>
        `).join('');
            };

            const addCustomBtn = content.querySelector('#sup-custom-add');
            if (addCustomBtn) {
                addCustomBtn.onclick = () => {
                    const k = (content.querySelector('#sup-custom-key').value || '').trim();
                    const v = (content.querySelector('#sup-custom-val').value || '').trim();
                    if (!k) return;
                    customRows.push({ key: k, value: v });
                    content.querySelector('#sup-custom-key').value = '';
                    content.querySelector('#sup-custom-val').value = '';
                    renderCustom();
                };
            }
            if (customListEl) {
                customListEl.addEventListener('click', (e) => {
                    const btn = e.target.closest('.sup-custom-del');
                    if (!btn) return;
                    const idx = parseInt(btn.dataset.idx);
                    if (Number.isNaN(idx)) return;
                    customRows.splice(idx, 1);
                    renderCustom();
                });
            }

            // Tabs
            const tabBtns = content.querySelectorAll('.sup-tab-btn');
            const tabQuote = content.querySelector('#sup-tab-quote');
            const tabNda = content.querySelector('#sup-tab-nda');
            const tabCustom = content.querySelector('#sup-tab-custom');
            const setTab = (name) => {
                const map = { quote: tabQuote, nda: tabNda, custom: tabCustom };
                Object.entries(map).forEach(([k, el]) => {
                    if (!el) return;
                    if (k === name) el.classList.remove('hidden');
                    else el.classList.add('hidden');
                });
                tabBtns.forEach(b => {
                    const active = b.dataset.tab === name;
                    b.style.background = active ? '#007AFF' : '#eee';
                    b.style.color = active ? '#fff' : '#000';
                });
            };
            tabBtns.forEach(b => b.onclick = () => setTab(b.dataset.tab));
            setTab('quote');

            // Ulo≈æit handler
            content.querySelector('#btn-save').onclick = () => {
                const ndaSigned = !!(content.querySelector('#sup-nda-signed') && content.querySelector('#sup-nda-signed').checked);
                const ndaDate = content.querySelector('#sup-nda-date') ? content.querySelector('#sup-nda-date').value : '';
                const ndaStorage = content.querySelector('#sup-nda-storage') ? content.querySelector('#sup-nda-storage').value : '';
                const masterNotes = content.querySelector('#sup-master-notes') ? content.querySelector('#sup-master-notes').value : '';

                // Prices array
                const priceInputs = content.querySelectorAll('.price-qty-input');
                const prices = [];
                priceInputs.forEach(input => {
                    const qty = parseFloat(input.dataset.qty);
                    const price = String(input.value || '').trim();
                    if (price !== '') prices.push({ qty: qty, price: price });
                });

                const updated = {
                    ...supplier,
                    master_id: supplier.master_id || (master ? master.id : undefined),
                    name: String(content.querySelector('#sup-name').value || '').trim(),
                    currency: content.querySelector('#sup-curr').value,
                    prices: prices,
                    rfq_sent_date: content.querySelector('#sup-rfq-sent').value,
                    quote_received_date: content.querySelector('#sup-quote-received').value,
                    quote_valid_until: content.querySelector('#sup-valid-until').value,
                    quote_status: content.querySelector('#sup-quote-status').value,
                    moq: content.querySelector('#sup-moq').value,
                    mov: content.querySelector('#sup-mov').value,
                    quote_number: content.querySelector('#sup-quote').value,
                    shipping: content.querySelector('#sup-ship').value,
                    lead_time: content.querySelector('#sup-lead').value,
                    incoterms: content.querySelector('#sup-incoterms').value
                };

                // Mirror prices into legacy/index fields (price_1..price_N + price alias)
                priceInputs.forEach(input => {
                    const idx = Number(input.dataset.qtyIndex);
                    if (!Number.isFinite(idx) || idx <= 0) return;
                    const price = String(input.value || '').trim();
                    setSupplierPriceByIndex(updated, idx, price);
                });
                // ensure aliases
                if (updated.price_1 !== undefined && updated.price === undefined) updated.price = updated.price_1;
                if (updated.price === undefined && updated.price_1 !== undefined) updated.price = updated.price_1;


                // Sync master supplier
                if (currentProject && updated.name) {
                    let mRec = updated.master_id ? getSupplierMasterById(currentProject, updated.master_id) : null;
                    if (!mRec) mRec = getSupplierMasterByName(currentProject, updated.name);
                    if (!mRec) mRec = getOrCreateSupplierMaster(currentProject, updated.name);
                    if (mRec) {
                        mRec.name = updated.name;
                        mRec.nda = { signed: ndaSigned, signed_date: ndaDate, storage: ndaStorage };
                        mRec.custom = Array.isArray(customRows) ? customRows : [];
                        mRec.notes = masterNotes;
                        upsertSupplierMaster(currentProject, mRec);
                        updated.master_id = mRec.id;
                        updateProject(currentProject);
                    }
                }

                onUlo≈æit(updated);
                close();
            };
        }

        function exportSingleItem(item) {
            if (typeof XLSX === 'undefined') { showToast('Excel lib missing', 'error'); return; }

            const data = [];
            data.push(['Item Details']);
            data.push(['Line', 'Drawing No', 'Description', 'Manufacturer', 'MPN']);
            data.push([item.line, item.item_drawing_no, item.description, item.manufacturer, item.mpn]);
            data.push([]);

            data.push(['Supplier Quotes']);
            data.push(['Supplier', 'Currency', 'Price 1', 'Price 2', 'Price 3', 'Price 4', 'Price 5', 'Shipping', 'Lead Time', 'MOQ', 'Incoterms', 'Is Main']);

            (item.suppliers || []).forEach(s => {
                data.push([
                    s.name, s.currency, s.price, s.price_2, s.price_3, s.price_4, s.price_5,
                    s.shipping, s.lead_time, s.moq, s.incoterms, s.isMain ? 'Yes' : 'No'
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Item Export");
            XLSX.writeFile(wb, `Item_${item.item_drawing_no || 'Unknown'}_Export.xlsx`);
        }

        function getActiveItemDetailRoot() {
            const page = getEl('item-detail-page-content');
            if (page && currentView === 'item-detail') return page;
            return detailContent;
        }

        function saveDetailChanges(shouldClose = true) {
            if (currentDetailIndex === null) return;
            const liveItem = currentProject && currentProject.items ? currentProject.items[currentDetailIndex] : null;
            if (!liveItem) return;

            console.log('[SaveDetail] Before save - item status:', liveItem.status);

            const item = { ...liveItem };
            const root = getActiveItemDetailRoot();

            const inputs = root.querySelectorAll('input[data-key], select[data-key], textarea[data-key]');
            inputs.forEach(input => {
                if (input.dataset.key) {
                    // Special handling for status field - use setItemStatus to maintain status_id
                    if (input.dataset.key === 'status') {
                        console.log('[SaveDetail] Status input value:', input.value);
                        setItemStatus(item, input.value);
                    } else {
                        item[input.dataset.key] = input.value;
                    }
                }
            });

            console.log('[SaveDetail] After setItemStatus - item.status:', item.status);

            // Preserve rich fields edited via dedicated UIs
            item.suppliers = liveItem.suppliers;
            item.comments = liveItem.comments;
            item.attachments = liveItem.attachments;
            item.image = liveItem.image;
            item.issueHistory = liveItem.issueHistory;

            // Keep logic consistent across app
            syncSupplierPricingToQtyTiers(item);
            syncBundlesQtyFromItem(currentProject, item);

            calculateEuroValues(item);
            currentProject.items[currentDetailIndex] = item;
            console.log('[SaveDetail] Saving to project - final item.status:', item.status);
            updateProject(currentProject);
            console.log('[SaveDetail] Project saved. Items[0] status:', currentProject.items[0]?.status);

            // Refresh tables / stats
            renderCompactTable();
            updateStats();
            updateSupplierFilter();
            updateManufacturerFilter();
            if (currentView === 'dashboard') renderDashboard();

            if (shouldClose) {
                closeDetailWindow();
            }
        }

        function closeDetailWindow() {
            // Hide legacy overlay if present
            if (detailWindow) detailWindow.classList.add('hidden');

            const isDetailVisible = (viewItemDetail && !viewItemDetail.classList.contains('hidden'));
            const wasDetailView = (currentView === 'item-detail') || isDetailVisible;

            currentDetailIndex = null;
            try { _releaseEditLock(); } catch (_) { }

            if (wasDetailView) {
                const ret = itemDetailReturnView || 'items';
                if (typeof switchView === 'function') switchView(ret);
                // Ensure tables refresh after returning
                try { if (ret === 'items' && typeof renderItemsTable === 'function') renderItemsTable(); } catch (e) { }
            }
        }

        async function deleteCurrentItem() {
            if (currentDetailIndex === null) return;
            const confirmed = await window.showConfirmDialog({
                title: 'Delete Item',
                message: 'Are you sure you want to delete this item?',
                type: 'danger',
                okText: 'Delete',
                cancelText: 'Cancel'
            });
            if (!confirmed) return;
            currentProject.items.splice(currentDetailIndex, 1);
            updateProject(currentProject);
            renderCompactTable();
            updateStats();
            renderSidebar();
            updateSupplierFilter();
            if (currentView === 'dashboard') renderDashboard();
            closeDetailWindow();
        }

        // Ensure XLSX library is available (Excel import/export)
        function ensureXLSXLoaded(callback) {
            try {
                if (typeof XLSX !== 'undefined') { callback(true); return; }
                // avoid double-loading
                const existing = document.querySelector('script[data-xlsx-lib="1"]');
                if (existing) {
                    existing.addEventListener('load', () => callback(typeof XLSX !== 'undefined'), { once: true });
                    existing.addEventListener('error', () => callback(false), { once: true });
                    return;
                }
                const s = document.createElement('script');
                s.dataset.xlsxLib = '1';
                s.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
                s.onload = () => callback(typeof XLSX !== 'undefined');
                s.onerror = () => callback(false);
                document.head.appendChild(s);
            } catch (e) {
                callback(false);
            }
        }

        function exportToExcel() {
            if (!currentProject || !currentProject.items || currentProject.items.length === 0) {
                if (window.showToast) window.showToast('No data to export!', 'warning');
                return;
            }
            if (typeof XLSX === 'undefined') {
                ensureXLSXLoaded((ok) => {
                    if (!ok) {
                        exportToCSVItems();
                        showToast('XLSX not available. Exported CSV instead (works offline).', 'info');
                        return;
                    }
                    exportToExcel();
                });
                return;
            }
            const data = currentProject.items.map(item => {
                const row = {};
                FIELDS.forEach(field => { row[field.label] = item[field.key] || ''; });
                return row;
            });
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "RFQ Data");
            const filename = `${currentProject.name.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().slice(0, 10)}.xlsx`;
            XLSX.writeFile(wb, filename);
        }
        // Expose to window for Project Detail exports
        window.exportToExcel = exportToExcel;

        function exportToCSVItems() {
            if (!currentProject || !Array.isArray(currentProject.items) || currentProject.items.length === 0) {
                if (window.showToast) window.showToast('No data to export!', 'warning');
                return;
            }
            const headers = FIELDS.map(f => f.label);
            const rows = currentProject.items.map(item => FIELDS.map(f => item[f.key] ?? ''));
            const esc = (v) => {
                const s = String(v ?? '');
                return /[",\n]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s;
            };
            const csv = [headers.map(esc).join(','), ...rows.map(r => r.map(esc).join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${(currentProject.name || 'Project').replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function handleImportExcel(e) {
            const file = e.target.files && e.target.files[0];
            if (!file) return;

            const name = String(file.name || '').toLowerCase();
            const ext = (name.split('.').pop() || '').trim();

            // CSV / TSV import works even without XLSX (offline-friendly)
            const importDelimited = (delimiter) => {
                const reader = new FileReader();
                reader.onload = function (ev) {
                    const text = String(ev.target.result || '');
                    const lines = text.split(/\r?\n/).filter(l => l && l.trim() !== '');
                    if (lines.length < 2) {
                        showToast('CSV/TSV file is empty or invalid.', 'error');
                        fileImportExcel.value = '';
                        return;
                    }

                    const splitLine = (line) => {
                        const out = [];
                        let cur = '';
                        let inQ = false;
                        for (let i = 0; i < line.length; i++) {
                            const ch = line[i];
                            if (ch === '"') {
                                if (inQ && line[i + 1] === '"') { cur += '"'; i++; continue; }
                                inQ = !inQ;
                                continue;
                            }
                            if (!inQ && ch === delimiter) { out.push(cur); cur = ''; continue; }
                            cur += ch;
                        }
                        out.push(cur);
                        return out;
                    };

                    const headers = splitLine(lines[0]).map(h => String(h || '').trim());
                    const rows = lines.slice(1).map(splitLine);

                    const headerMap = {};
                    headers.forEach((header, index) => {
                        if (!header) return;
                        const headerStr = String(header).toLowerCase().trim().replace(/[\s:\n]/g, '');
                        const field = FIELDS.find(f => {
                            const labelNorm = f.label.toLowerCase().replace(/[\s:\n]/g, '');
                            return labelNorm === headerStr;
                        });
                        if (field) headerMap[index] = field.key;
                    });

                    let importedCount = 0;
                    rows.forEach(row => {
                        if (!row || row.every(cell => !cell)) return;
                        const item = {};
                        row.forEach((cell, index) => {
                            const key = headerMap[index];
                            if (key) item[key] = cell || '';
                        });
                        if (Object.keys(item).length > 0) {
                            calculateEuroValues(item);
                            if (!currentProject.items) currentProject.items = [];
                            currentProject.items.push(item);
                            importedCount++;
                        }
                    });

                    fileImportExcel.value = '';
                    updateProject(currentProject);
                    renderCompactTable();
                    updateStats();
                    renderSidebar();
                    updateSupplierFilter();
                    showToast(`Imported ${importedCount} rows successfully!`, 'success');
                    if (currentView === 'dashboard') renderDashboard();
                };
                reader.readAsText(file, 'utf-8');
            };

            if (ext === 'csv') return importDelimited(',');
            if (ext === 'tsv' || ext === 'txt') return importDelimited('\t');

            // XLSX import (requires XLSX library)
            if (typeof XLSX === 'undefined') {
                ensureXLSXLoaded((ok) => {
                    if (!ok) {
                        showToast('Excel (XLSX) library not loaded. Tip: save your sheet as CSV and import it (CSV import works offline).', 'warning');
                        fileImportExcel.value = '';
                        return;
                    }
                    // retry import after library loads
                    handleImportExcel(e);
                });
                return;
            }

            const reader = new FileReader();
            reader.onload = function (ev) {
                const data = new Uint8Array(ev.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                if (!jsonData || jsonData.length < 2) {
                    showToast('Excel file is empty or invalid format.', 'error');
                    fileImportExcel.value = '';
                    return;
                }

                const headers = jsonData[0];
                const rows = jsonData.slice(1);
                const headerMap = {};
                headers.forEach((header, index) => {
                    if (!header) return;
                    const headerStr = String(header).toLowerCase().trim().replace(/[\s:\n]/g, '');
                    const field = FIELDS.find(f => {
                        const labelNorm = f.label.toLowerCase().replace(/[\s:\n]/g, '');
                        return labelNorm === headerStr;
                    });
                    if (field) headerMap[index] = field.key;
                });

                let importedCount = 0;
                rows.forEach(row => {
                    if (!row || row.every(cell => !cell)) return;
                    const item = {};
                    row.forEach((cell, index) => {
                        const key = headerMap[index];
                        if (key) item[key] = cell || '';
                    });
                    if (Object.keys(item).length > 0) {
                        calculateEuroValues(item);
                        if (!currentProject.items) currentProject.items = [];
                        currentProject.items.push(item);
                        importedCount++;
                    }
                });

                fileImportExcel.value = '';
                updateProject(currentProject);
                renderCompactTable();
                updateStats();
                renderSidebar();
                updateSupplierFilter();
                showToast(`Imported ${importedCount} rows successfully!`, 'success');
                if (currentView === 'dashboard') renderDashboard();
            };
            reader.readAsArrayBuffer(file);
        }

        // Import Target Prices from Excel
        // Expected columns: 1=Item (Drawing No), 2=Target Price, 3=Currency (optional, defaults to EUR)
        function handleImportTargetPrices(e) {
            const file = e.target.files && e.target.files[0];
            if (!file || !currentProject) return;

            const fileInput = getEl('file-import-targets');

            const processData = (rows) => {
                if (!rows || rows.length < 2) {
                    showToast('File is empty or invalid. Expected columns: Item, Target Price, Currency (optional)', 'error');
                    if (fileInput) fileInput.value = '';
                    return;
                }

                // First row is header, rest are data
                const headers = rows[0].map(h => String(h || '').toLowerCase().trim());
                const dataRows = rows.slice(1);

                // Find column indices
                let itemCol = headers.findIndex(h => h.includes('item') || h.includes('drawing') || h.includes('part'));
                let priceCol = headers.findIndex(h => h.includes('price') || h.includes('target') || h.includes('cena'));
                let currencyCol = headers.findIndex(h => h.includes('currency') || h.includes('curr') || h.includes('mƒõna'));

                // If no headers match, assume columns 0, 1, 2
                if (itemCol === -1) itemCol = 0;
                if (priceCol === -1) priceCol = 1;
                if (currencyCol === -1) currencyCol = 2;

                const items = currentProject.items || [];
                let updated = 0;
                let notFound = [];

                dataRows.forEach(row => {
                    if (!row || row.length < 2) return;

                    const itemNo = String(row[itemCol] || '').trim();
                    const priceVal = parseFloat(String(row[priceCol] || '').replace(',', '.')) || 0;
                    const currency = String(row[currencyCol] || 'EUR').trim().toUpperCase() || 'EUR';

                    if (!itemNo || priceVal <= 0) return;

                    // Find matching item by drawing_no (case insensitive)
                    const itemNoLower = itemNo.toLowerCase();
                    const item = items.find(i => {
                        const dn = String(i.item_drawing_no || i.drawing_no || '').toLowerCase().trim();
                        return dn === itemNoLower;
                    });

                    if (item) {
                        item.target_price = priceVal;
                        item.target_currency = currency;
                        updated++;
                    } else {
                        notFound.push(itemNo);
                    }
                });

                if (fileInput) fileInput.value = '';
                updateProject(currentProject);
                renderCompactTable();

                let msg = `Target prices updated for ${updated} items.`;
                if (notFound.length > 0) {
                    msg += ` Items not found: ${notFound.length}`;
                }
                showToast(msg, notFound.length > 0 ? 'warning' : 'success');

                if (currentView === 'dashboard') renderDashboard();
            };

            const name = String(file.name || '').toLowerCase();
            const ext = (name.split('.').pop() || '').trim();

            // CSV import
            if (ext === 'csv') {
                const reader = new FileReader();
                reader.onload = function (ev) {
                    const text = String(ev.target.result || '');
                    const lines = text.split(/\r?\n/).filter(l => l && l.trim() !== '');
                    const rows = lines.map(line => {
                        // Simple CSV parse
                        const out = [];
                        let cur = '';
                        let inQ = false;
                        for (let i = 0; i < line.length; i++) {
                            const ch = line[i];
                            if (ch === '"') { inQ = !inQ; continue; }
                            if (!inQ && (ch === ',' || ch === ';')) { out.push(cur); cur = ''; continue; }
                            cur += ch;
                        }
                        out.push(cur);
                        return out;
                    });
                    processData(rows);
                };
                reader.readAsText(file, 'utf-8');
                return;
            }

            // XLSX import
            if (typeof XLSX === 'undefined') {
                ensureXLSXLoaded((ok) => {
                    if (!ok) {
                        showToast('Excel (XLSX) library not loaded. Try CSV format instead.', 'warning');
                        if (fileInput) fileInput.value = '';
                        return;
                    }
                    handleImportTargetPrices(e);
                });
                return;
            }

            const reader = new FileReader();
            reader.onload = function (ev) {
                const data = new Uint8Array(ev.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                processData(rows);
            };
            reader.readAsArrayBuffer(file);
        }

        // --- NEW HELPER FUNCTIONS ---

        window.openItemInProject = (projectId, itemNo) => {
            switchView('items');
            if (currentProject.id !== projectId) {
                const proj = projects.find(p => p.id === projectId);
                if (proj) openProject(proj);
            }
            const index = currentProject.items.findIndex(i => i.item_drawing_no === itemNo);
            if (index !== -1) {
                openDetailWindow(index);
            } else {
                showToast('Item not found in this project', 'warning');
            }
        };

        window.openProjectById = (projectId) => {
            const proj = projects.find(p => String(p.id) === String(projectId));
            if (proj) {
                openProject(proj);
                switchView('dashboard');
            } else {
                showToast('Project not found', 'warning');
            }
        };

        window.bulkUpdateSupplier = async (supplierName, type, value) => {
            const confirmed = await window.showConfirmDialog({
                title: 'Bulk Update',
                message: `Are you sure you want to update all items for ${supplierName}?`,
                type: 'question',
                okText: 'Update All',
                cancelText: 'Cancel'
            });
            if (!confirmed) return;

            let count = 0;
            currentProject.items.forEach(item => {
                if (item.suppliers && Array.isArray(item.suppliers)) {
                    const s = item.suppliers.find(sup => sup.name === supplierName);
                    if (s) {
                        if (type === 'main') {
                            if (value === true) {
                                item.suppliers.forEach(sup => sup.isMain = false);
                                s.isMain = true;
                                item.supplier = s.name;
                                item.price_1 = s.price;
                                item.currency = s.currency;
                                calculateEuroValues(item);
                            }
                        } else if (type === 'feedback') {
                            s.feedback = value;
                        }
                        count++;
                    }
                } else if (item.supplier === supplierName) {
                    if (type === 'main') {
                        item.supplier_is_main = value;
                    } else if (type === 'feedback') {
                        item.supplier_feedback = value;
                    }
                    count++;
                }
            });

            updateProject(currentProject);
            if (typeof window.openSupplierDetail === 'function') window.openSupplierDetail(supplierName);
            if (typeof renderSuppliers === 'function') renderSuppliers();
            if (window.showToast) window.showToast(`Updated ${count} items.`, 'success');
        };

        // --- BULK ITEM ACTIONS ---

        function updateBulkActionBar() {
            const bar = getEl('bulk-action-bar');
            const countEl = getEl('bulk-count');
            if (!bar || !countEl) return;

            if (selectedItems.size > 0) {
                bar.classList.remove('hidden');
                countEl.textContent = selectedItems.size;
            } else {
                bar.classList.add('hidden');
            }
        }

        function updateMasterCheckboxState() {
            const selectAllCheck = getEl('select-all-items');
            if (!selectAllCheck || !dataTableBody) return;

            const rows = Array.from(dataTableBody.querySelectorAll('tr'));
            const visibleRows = rows.filter(row => row.style.display !== 'none');

            if (visibleRows.length === 0) {
                selectAllCheck.checked = false;
                selectAllCheck.indeterminate = false;
                return;
            }

            const selectedVisible = visibleRows.filter(row => {
                const index = parseInt(row.dataset.index);
                return selectedItems.has(index);
            });

            if (selectedVisible.length === visibleRows.length) {
                selectAllCheck.checked = true;
                selectAllCheck.indeterminate = false;
            } else if (selectedVisible.length > 0) {
                selectAllCheck.checked = false;
                selectAllCheck.indeterminate = true;
            } else {
                selectAllCheck.checked = false;
                selectAllCheck.indeterminate = false;
            }
        }

        function handleSelectionChange(index, checked) {
            index = parseInt(index);
            if (checked) {
                selectedItems.add(index);
            } else {
                selectedItems.delete(index);
            }
            updateBulkActionBar();
            updateMasterCheckboxState();
        }

        function toggleAllItems(checked) {
            if (!dataTableBody) return;
            const rows = dataTableBody.querySelectorAll('tr');

            rows.forEach(row => {
                if (row.style.display !== 'none') {
                    const checkbox = row.querySelector('.item-checkbox');
                    const index = parseInt(row.dataset.index);
                    if (checkbox) {
                        checkbox.checked = checked;
                    }
                    if (checked) selectedItems.add(index);
                    else selectedItems.delete(index);
                }
            });
            updateBulkActionBar();
            updateMasterCheckboxState();
        }

        async function handleBulkStatusChange(newStatus) {
            if (!newStatus) return;

            // Get selected indices from SuperTable or fallback to selectedItems
            let selectedIndices = [];
            if (itemsSuperTable) {
                selectedIndices = itemsSuperTable.getSelectedIndices();
            } else {
                selectedIndices = Array.from(selectedItems);
            }

            if (selectedIndices.length === 0) return;

            const confirmed = await window.showConfirmDialog({
                title: 'Change Status',
                message: `Change status to "${newStatus}" for ${selectedIndices.length} items?`,
                type: 'question',
                okText: 'Change',
                cancelText: 'Cancel'
            });
            if (!confirmed) {
                const sel = getEl('bulk-status-select');
                if (sel) sel.value = '';
                return;
            }

            let count = 0;
            selectedIndices.forEach(index => {
                if (currentProject.items[index]) {
                    currentProject.items[index].status = newStatus;
                    count++;
                }
            });

            updateProject(currentProject);

            // Refresh SuperTable
            if (itemsSuperTable) {
                itemsSuperTable.clearSelection();
                itemsSuperTable.setData(currentProject.items);
            }

            updateStats();

            const sel = getEl('bulk-status-select');
            if (sel) sel.value = '';

            // Hide bulk bar
            const bulkBar = document.getElementById('bulk-action-bar');
            if (bulkBar) bulkBar.classList.add('hidden');

            if (currentView === 'dashboard') renderDashboard();
        }

        function handleBulkExport() {
            // Get selected items from SuperTable or fallback to selectedItems
            let itemsToExport = [];
            if (itemsSuperTable) {
                itemsToExport = itemsSuperTable.getSelectedItems();
            } else {
                selectedItems.forEach(index => {
                    if (currentProject.items[index]) itemsToExport.push(currentProject.items[index]);
                });
            }

            if (itemsToExport.length === 0) return;

            if (typeof XLSX === 'undefined') {
                showToast('Excel library not loaded. Fix: include XLSX (xlsx.full.min.js) or open with internet (CDN).', 'error');
                return;
            }

            const data = itemsToExport.map(item => {
                const row = {};
                FIELDS.forEach(field => { row[field.label] = item[field.key] || ''; });
                row['Status'] = item.status || 'New';
                return row;
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Selected Items");
            const filename = `Export_${currentProject.name.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().slice(0, 10)}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        function getSupplierData(supplierName) {
            if (!currentProject.supplierData) {
                currentProject.supplierData = {};
            }
            if (!currentProject.supplierData[supplierName]) {
                currentProject.supplierData[supplierName] = {
                    contact: { name: '', email: '', phone: '', address: '', website: '' },
                    notes: [],
                    rating: 0,
                    status: 'Active'
                };
            }
            return currentProject.supplierData[supplierName];
        }

        function saveSupplierData(supplierName, data) {
            if (!currentProject.supplierData) currentProject.supplierData = {};
            currentProject.supplierData[supplierName] = data;
            updateProject(currentProject);
        }

        // --- ENHANCED SUPPLIER DETAIL ---

        window.openSupplierDetail = (supplierName) => {
            // Use full-page view with new design
            const prevView = currentView;
            if (prevView && prevView !== 'supplier-detail') {
                supplierDetailReturnView = prevView;
            }
            switchView('supplier-detail');
            renderSupplierDetail(supplierName);
        };

        // Legacy popup support (hidden, kept for compatibility)
        window.openSupplierDetailPopup = (supplierName) => {
            const supplierDetailWindow = getEl('supplier-detail-window');
            const content = getEl('supplier-detail-content');
            const btnClose = getEl('btn-close-supplier-detail');

            if (!supplierDetailWindow || !content) return;

            supplierDetailWindow.classList.remove('hidden');

            // 1. Prepare Data
            const sData = getSupplierData(supplierName);
            const supplierParts = [];
            let stats = { total: 0, won: 0, lost: 0, main: 0, totalValue: 0, wonValue: 0 };

            currentProject.items.forEach((item, idx) => {
                let s = null;
                if (item.suppliers && Array.isArray(item.suppliers)) {
                    s = item.suppliers.find(sup => sup.name === supplierName);
                } else if (item.supplier === supplierName) {
                    s = {
                        name: item.supplier,
                        price: item.price_1,
                        currency: item.currency,
                        isMain: item.supplier_is_main !== undefined ? item.supplier_is_main : true,
                        feedback: item.supplier_feedback || 'pending'
                    };
                }

                if (s) {
                    supplierParts.push({ item: item, index: idx, data: s });
                    stats.total++;
                    const price = parseFloat(s.price || 0);
                    stats.totalValue += price;

                    if (s.isMain) stats.main++;
                    if (s.feedback === 'won') {
                        stats.won++;
                        stats.wonValue += price;
                    }
                    if (s.feedback === 'lost') stats.lost++;
                }
            });

            // 2. Render Layout
            content.innerHTML = `
                <div style="display: flex; flex-direction: column; height: 100%;">
                    <!-- Header -->
                    <div style="padding: 20px 24px; background: white; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <h2 style="margin: 0; font-size: 24px; color: #333;">${supplierName}</h2>
                                <span id="sup-status-badge" style="padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; cursor: pointer; background: ${sData.status === 'Active' ? '#e6ffeb' : '#f5f5f7'}; color: ${sData.status === 'Active' ? '#34C759' : '#666'};">
                                    ${sData.status} ‚ñæ
                                </span>
                            </div>
                            <div style="margin-top: 8px; display: flex; align-items: center; gap: 16px; font-size: 13px; color: #666;">
                                <span style="cursor: pointer;" onclick="updateSupplierRating('${supplierName}', 1)">${sData.rating >= 1 ? '‚òÖ' : '‚òÜ'}</span>
                                <span style="cursor: pointer;" onclick="updateSupplierRating('${supplierName}', 2)">${sData.rating >= 2 ? '‚òÖ' : '‚òÜ'}</span>
                                <span style="cursor: pointer;" onclick="updateSupplierRating('${supplierName}', 3)">${sData.rating >= 3 ? '‚òÖ' : '‚òÜ'}</span>
                                <span style="cursor: pointer;" onclick="updateSupplierRating('${supplierName}', 4)">${sData.rating >= 4 ? '‚òÖ' : '‚òÜ'}</span>
                                <span style="cursor: pointer;" onclick="updateSupplierRating('${supplierName}', 5)">${sData.rating >= 5 ? '‚òÖ' : '‚òÜ'}</span>
                                <span style="margin-left: 8px;">${supplierParts.length} Items Linked</span>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 12px; color: #999; margin-bottom: 4px;">Total Potential Value</div>
                            <div style="font-size: 20px; font-weight: 600; color: #333;">‚Ç¨${formatPrice(stats.totalValue)}</div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div style="padding: 0 24px; background: white; border-bottom: 1px solid #eee; display: flex; gap: 24px;">
                        <div class="tab-item active" data-tab="overview" style="padding: 12px 0; font-size: 13px; font-weight: 500; color: #007AFF; border-bottom: 2px solid #007AFF; cursor: pointer;">Overview</div>
                        <div class="tab-item" data-tab="parts" style="padding: 12px 0; font-size: 13px; font-weight: 500; color: #666; cursor: pointer;">Parts (${stats.total})</div>
                        <div class="tab-item" data-tab="contact" style="padding: 12px 0; font-size: 13px; font-weight: 500; color: #666; cursor: pointer;">Contact Info</div>
                        <div class="tab-item" data-tab="notes" style="padding: 12px 0; font-size: 13px; font-weight: 500; color: #666; cursor: pointer;">Notes</div>
                    </div>

                    <!-- Content Area -->
                    <div id="sup-tab-content" style="flex: 1; overflow-y: auto; padding: 24px; background: #f5f5f7;">
                        <!-- Overview Tab -->
                        <div id="tab-overview" class="tab-pane">
                            <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr); padding: 0; margin-bottom: 24px;">
                                <div class="stat-card">
                                    <div class="stat-label">Win Rate</div>
                                    <div class="stat-value">${stats.total > 0 ? Math.round((stats.won / stats.total) * 100) : 0}%</div>
                                    <div style="height: 4px; background: #eee; margin-top: 8px; border-radius: 2px; overflow: hidden;">
                                        <div style="width: ${stats.total > 0 ? (stats.won / stats.total) * 100 : 0}%; height: 100%; background: #34C759;"></div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Won Value</div>
                                    <div class="stat-value color-green">‚Ç¨${formatPrice(stats.wonValue)}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-label">Main Supplier For</div>
                                    <div class="stat-value color-blue">${stats.main} <span style="font-size: 14px; color: #999; font-weight: 400;">items</span></div>
                                </div>
                            </div>

                            <div style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #eee;">
                                <h3 style="margin-top: 0; font-size: 15px;">Quick Actions</h3>
                                <div style="display: flex; gap: 10px; margin-top: 15px;">
                                     <button class="btn-secondary" onclick="window.bulkUpdateSupplier('${supplierName}', 'main', true)">Set All Main</button>
                                     <button class="btn-secondary" onclick="window.bulkUpdateSupplier('${supplierName}', 'feedback', 'won')">Mark All Won</button>
                                     <button class="btn-secondary" onclick="window.bulkUpdateSupplier('${supplierName}', 'feedback', 'lost')">Mark All Lost</button>
                                </div>
                            </div>
                        </div>

                        <!-- Parts Tab -->
                        <div id="tab-parts" class="tab-pane hidden">
                            <div style="background: white; border-radius: 12px; border: 1px solid #eee; overflow: hidden;">
                                <table class="rfq-table">
                                    <thead>
                                        <tr>
                                            <th>Item No.</th>
                                            <th>Description</th>
                                            <th>Price</th>
                                            <th>Status</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${supplierParts.map(p => `
                                            <tr>
                                                <td><b>${p.item.item_drawing_no}</b></td>
                                                <td>${p.item.description}</td>
                                                <td>${p.data.currency} ${formatPrice(parseFloat(p.data.price || 0))}</td>
                                                <td>
                                                    <span style="
                                                        padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 500;
                                                        background: ${p.data.feedback === 'won' ? '#e6ffeb' : p.data.feedback === 'lost' ? '#ffe6e6' : '#f5f5f7'};
                                                        color: ${p.data.feedback === 'won' ? '#34C759' : p.data.feedback === 'lost' ? '#FF3B30' : '#666'};
                                                    ">
                                                        ${p.data.feedback ? p.data.feedback.toUpperCase() : 'PENDING'}
                                                    </span>
                                                    ${p.data.isMain ? '<span style="margin-left:6px;">‚≠ê</span>' : ''}
                                                </td>
                                                <td>
                                                    <button class="btn-text" onclick="window.openItemInProject('${currentProject.id}', '${p.item.item_drawing_no}')">View Item</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Contact Tab -->
                        <div id="tab-contact" class="tab-pane hidden">
                            <div style="background: white; padding: 24px; border-radius: 12px; border: 1px solid #eee; max-width: 600px;">
                                <div class="form-row">
                                    <label>Contact Name</label>
                                    <input class="rfq-input" id="sup-contact-name" value="${sData.contact.name || ''}" placeholder="e.g. John Doe">
                                </div>
                                <div class="form-row">
                                    <label>Email</label>
                                    <input class="rfq-input" id="sup-contact-email" value="${sData.contact.email || ''}" placeholder="john@example.com">
                                </div>
                                <div class="form-row">
                                    <label>Phone</label>
                                    <input class="rfq-input" id="sup-contact-phone" value="${sData.contact.phone || ''}" placeholder="+1 234 567 890">
                                </div>
                                <div class="form-row">
                                    <label>Address</label>
                                    <textarea class="rfq-input" id="sup-contact-address" rows="3">${sData.contact.address || ''}</textarea>
                                </div>
                                <div class="form-row">
                                    <label>Website</label>
                                    <input class="rfq-input" id="sup-contact-website" value="${sData.contact.website || ''}" placeholder="https://...">
                                </div>
                                <div style="margin-top: 20px; text-align: right;">
                                    <button class="btn-primary" onclick="saveSupplierContact('${supplierName}')">Ulo≈æit Contact Info</button>
                                </div>
                            </div>
                        </div>

                        <!-- Notes Tab -->
                        <div id="tab-notes" class="tab-pane hidden">
                             <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                                 <textarea id="sup-new-note" class="rfq-input" rows="2" placeholder="Add a note..." style="flex: 1;"></textarea>
                                 <button class="btn-primary" onclick="addSupplierNote('${supplierName}')" style="height: fit-content;">Add Note</button>
                             </div>
                             <div id="sup-notes-list">
                                 ${(sData.notes || []).slice().reverse().map(note => `
                                     <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 12px;">
                                         <div style="font-size: 11px; color: #999; margin-bottom: 6px;">${new Date(note.date).toLocaleString()}</div>
                                         <div style="font-size: 13px; color: #333; white-space: pre-wrap;">${note.text}</div>
                                     </div>
                                 `).join('')}
                                 ${(!sData.notes || sData.notes.length === 0) ? '<div style="color:#999; text-align:center; padding:20px;">No notes yet</div>' : ''}
                             </div>
                        </div>
                    </div>
                    <div id="sourcing-targets-list" style="margin-top:10px;"></div>
                </div>
             `;

            // 3. Setup Event Listeners
            btnClose.onclick = () => supplierDetailWindow.classList.add('hidden');

            // Footer buttons
            const btnCloseFooter = getEl('btn-close-supplier-footer');
            const btnExportSupplier = getEl('btn-export-supplier');

            if (btnCloseFooter) {
                btnCloseFooter.onclick = () => supplierDetailWindow.classList.add('hidden');
            }

            if (btnExportSupplier) {
                btnExportSupplier.onclick = () => {
                    showToast('Export Supplier Data feature - Coming soon!', 'info');
                };
            }

            // Tab Switching Logic
            const tabs = content.querySelectorAll('.tab-item');
            const panes = content.querySelectorAll('.tab-pane');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Update Tabs
                    tabs.forEach(t => {
                        t.classList.remove('active');
                        t.style.color = '#666';
                        t.style.borderBottom = 'none';
                    });
                    tab.classList.add('active');
                    tab.style.color = '#007AFF';
                    tab.style.borderBottom = '2px solid #007AFF';

                    // Update Panes
                    const target = tab.dataset.tab;
                    panes.forEach(p => p.classList.add('hidden'));
                    content.querySelector(`#tab-${target}`).classList.remove('hidden');
                });
            });

            // Status Badge Logic
            const badge = content.querySelector('#sup-status-badge');
            badge.onclick = () => {
                const newStatus = sData.status === 'Active' ? 'On Hold' : sData.status === 'On Hold' ? 'Inactive' : 'Active';
                sData.status = newStatus;
                saveSupplierData(supplierName, sData);
                window.openSupplierDetail(supplierName); // Re-render
            };
        };

        // --- SUPPLIER ACTIONS ---

        window.updateSupplierRating = (name, rating) => {
            const data = getSupplierData(name);
            data.rating = rating;
            saveSupplierData(name, data);
            window.openSupplierDetail(name);
        };

        window.saveSupplierContact = (name) => {
            const data = getSupplierData(name);
            data.contact = {
                name: document.getElementById('sup-contact-name').value,
                email: document.getElementById('sup-contact-email').value,
                phone: document.getElementById('sup-contact-phone').value,
                address: document.getElementById('sup-contact-address').value,
                website: document.getElementById('sup-contact-website').value
            };
            saveSupplierData(name, data);
            showToast('Contact information saved!', 'success');
        };

        window.addSupplierNote = (name) => {
            const txt = document.getElementById('sup-new-note');
            if (!txt.value.trim()) return;

            const data = getSupplierData(name);
            if (!data.notes) data.notes = [];
            data.notes.push({
                text: txt.value.trim(),
                date: new Date().toISOString()
            });
            saveSupplierData(name, data);
            window.openSupplierDetail(name);
        };


        function openPriceList() {
            if (!currentProject || !currentProject.items) return;

            const sheet = document.getElementById('sheet-price-list');
            const body = document.getElementById('price-list-body');
            if (sheet) sheet.classList.remove('hidden');

            const date = new Date().toLocaleDateString();
            const _num = (v) => { const s = String(v ?? '').replace(',', '.').trim(); const n = parseFloat(s); return isFinite(n) ? n : 0; };
            const _getMainSupplier = (item) => {
                try {
                    if (Array.isArray(item.suppliers) && item.suppliers.length) {
                        return item.suppliers.find(s => s && (s.isMain || s.is_main)) || item.suppliers[0];
                    }
                } catch (e) { }
                return null;
            };
            const _getMainSupName = (item, sup) => {
                const s = sup || _getMainSupplier(item);
                return (s && (s.name || s.supplier_name || s.supplier)) ? (s.name || s.supplier_name || s.supplier) : (item.supplier || '');
            };
            const _getCur = (item, sup) => {
                const s = sup || _getMainSupplier(item);
                return (s && (s.currency || s.cur)) ? (s.currency || s.cur) : (item.currency || 'EUR');
            };
            const _rateToEur = (cur) => {
                try {
                    const c = String(cur || 'EUR').toUpperCase();
                    return (window.CURRENCY_RATES && window.CURRENCY_RATES[c]) ? window.CURRENCY_RATES[c] : 1;
                } catch (e) { return 1; }
            };
            const _getUnitOrig = (item, sup) => {
                const s = sup || _getMainSupplier(item);
                let v = '';
                try {
                    v = s ? getSupplierPriceByIndex(s, 1) : '';
                } catch (e) { }
                if (!v) v = item.price_1 || item.price || '';
                return _num(v);
            };
            const _getUnitEur = (item, sup) => {
                const cur = _getCur(item, sup);
                const unitOrig = _getUnitOrig(item, sup);
                return unitOrig * _rateToEur(cur);
            };
            const _getQty = (item) => {
                const q = _num(item.qty_1);
                return q || 0;
            };

            const totalValue = currentProject.items.reduce((sum, item) => {
                const sup = _getMainSupplier(item);
                const unitEur = _getUnitEur(item, sup);
                const qty = _getQty(item);
                return sum + (unitEur * qty);
            }, 0);

            let html = `
                <div style="font-family: 'Times New Roman', serif; color: black;">
                    <div style="border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: flex-end;">
                        <div>
                            <h1 style="margin: 0; font-size: 24px;">Price List / Cenov√° Nab√≠dka</h1>
                            <div style="font-size: 14px; margin-top: 5px;">Project: <b>${currentProject.name}</b></div>
                        </div>
                        <div style="text-align: right; font-size: 12px;">
                            <div>Date: ${date}</div>
                            <div>Total Value: <b>‚Ç¨${totalValue.toFixed(4)}</b></div>
                        </div>
                    </div>
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="border-bottom: 1px solid black;">
                                <th style="text-align: left; padding: 5px;">Item / Drawing</th>
                                <th style="text-align: left; padding: 5px;">Description</th>
                                <th style="text-align: center; padding: 5px;">Qty</th>
                                <th style="text-align: left; padding: 5px;">Supplier</th>
                                <th style="text-align: right; padding: 5px;">Unit (EUR)</th>
                                <th style="text-align: right; padding: 5px;">Total (EUR)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            const sortedItems = [...currentProject.items].sort((a, b) => {
                const sa = _getMainSupName(a);
                const sb = _getMainSupName(b);
                return String(sa || '').localeCompare(String(sb || ''));
            });

            sortedItems.forEach(item => {
                const sup = _getMainSupplier(item);
                const supName = _getMainSupName(item, sup) || '-';
                const cur = _getCur(item, sup) || 'EUR';
                const unitEur = _getUnitEur(item, sup);
                const qty = _getQty(item);
                const unitOrig = _getUnitOrig(item, sup);

                html += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 5px;"><b>${item.item_drawing_no || '-'}</b></td>
                        <td style="padding: 5px;">${item.description || '-'}</td>
                        <td style="text-align: center; padding: 5px;">${item.qty_1 || '-'}</td>
                        <td style="padding: 5px;">${escapeHtml(String(supName))}</td>
                        <td style="text-align: right; padding: 5px;">‚Ç¨${unitEur.toFixed(4)} <span style="color:#666;font-size:10px;">(${unitOrig.toFixed(4)} ${escapeHtml(String(cur))})</span></td>
                        <td style="text-align: right; padding: 5px;">‚Ç¨${(unitEur * qty).toFixed(4)}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                        <tfoot>
                            <tr style="border-top: 2px solid black;">
                                <td colspan="5" style="text-align: right; padding: 10px; font-weight: bold;">Grand Total:</td>
                                <td style="text-align: right; padding: 10px; font-weight: bold;">‚Ç¨${totalValue.toFixed(4)}</td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <div style="margin-top: 40px; display: flex; justify-content: space-between;">
                        <div style="width: 200px; border-top: 1px solid black; padding-top: 5px; text-align: center; font-size: 12px;">
                            Approved By
                        </div>
                        <div style="width: 200px; border-top: 1px solid black; padding-top: 5px; text-align: center; font-size: 12px;">
                            Date & Signature
                        </div>
                    </div>
                </div>`;

            if (body) body.innerHTML = html;
        }

        // --- Ulo≈æit Detail Logic (Custom Implementation) ---

        // --- Ulo≈æit Detail Logic (Unified, keeps legacy buttons too) ---
        function handleUlo≈æitDetail(shouldClose) {
            try {
                // Ulo≈æit without closing first, so we can guarantee navigation on "Ulo≈æit & Back"
                saveDetailChanges(false);

                // visual feedback for 'Ulo≈æit' (no close)
                if (!shouldClose) {
                    const btn = getEl('btn-save-detail-no-close') || getEl('btn-item-detail-save');
                    if (btn) {
                        const originalText = btn.textContent;
                        btn.textContent = 'Ulo≈æitd!';
                        btn.style.background = '#34c759';
                        btn.style.color = 'white';
                        setTimeout(() => {
                            btn.textContent = originalText;
                            btn.style.background = '';
                            btn.style.color = '';
                        }, 900);
                    }
                }
            } catch (e) {
                console.error('Ulo≈æit detail failed', e);
                showToast('Ulo≈æit failed: ' + (e && e.message ? e.message : String(e)), 'error');
            } finally {
                if (shouldClose) {
                    try { closeDetailWindow(); } catch (e) { }
                }
            }
        }

        try { initApp(); } catch (e) { console.error('[RFQ] initApp failed:', e); }


        // Override listeners for Detail Window save buttons
        const btnUlo≈æitDetailNoClose = getEl('btn-save-detail-no-close');
        const btnUlo≈æitDetail = getEl('btn-save-detail');

        if (btnUlo≈æitDetailNoClose) btnUlo≈æitDetailNoClose.onclick = () => handleUlo≈æitDetail(false);
        if (btnUlo≈æitDetail) btnUlo≈æitDetail.onclick = () => handleUlo≈æitDetail(true);

        // Item Detail (Page View) toolbar
        if (btnItemDetailBack) btnItemDetailBack.onclick = () => closeDetailWindow();
        if (btnItemDetailUlo≈æit) btnItemDetailUlo≈æit.onclick = () => handleUlo≈æitDetail(false);
        if (btnItemDetailUlo≈æitBack) btnItemDetailUlo≈æitBack.onclick = () => handleUlo≈æitDetail(true);
        if (btnItemDetailDelete) btnItemDetailDelete.onclick = () => deleteCurrentItem();

        // --- Post-Init Listeners for Price List ---
        // (Adding here to ensure elements exist after render)
        setTimeout(() => {
            const btnPriceList = getEl('btn-price-list');
            if (btnPriceList) {
                btnPriceList.removeEventListener('click', openPriceList); // Prevent duplicates
                btnPriceList.addEventListener('click', openPriceList);
            }

            const sheetPriceList = getEl('sheet-price-list');
            const btnCloseList = getEl('btn-close-list');
            const btnPrintList = getEl('btn-print-list');

            if (sheetPriceList && btnCloseList) {
                btnCloseList.onclick = () => sheetPriceList.classList.add('hidden');
            }
            if (btnPrintList) {
                btnPrintList.onclick = () => window.print();
            }
        }, 500);

        // --- Missing Functions Implementation ---

        function getSupplierDetails(name) {
            try {
                const store = localStorage.getItem('rfq_supplier_details');
                const data = store ? JSON.parse(store) : {};
                return data[name] || {
                    contact_person: '',
                    email: '',
                    phone: '',
                    address: '',
                    website: '',
                    payment_terms: '',
                    tax_id: ''
                };
            } catch (e) {
                console.error('Error loading supplier details', e);
                return {};
            }
        }

        function saveSupplierDetails(name, details) {
            try {
                const store = localStorage.getItem('rfq_supplier_details');
                const data = store ? JSON.parse(store) : {};
                data[name] = details;
                localStorage.setItem('rfq_supplier_details', JSON.stringify(data));
                return true;
            } catch (e) {
                console.error('Error saving supplier details', e);
                return false;
            }
        }

        window.toggleSupplierEdit = function (name, save = false) {
            const content = getEl('supplier-detail-content');
            if (!content) return;

            if (save) {
                // Ulo≈æit mode
                const inputs = content.querySelectorAll('.supplier-edit-input');
                const details = getSupplierDetails(name);

                inputs.forEach(inp => {
                    const field = inp.dataset.field;
                    if (field) details[field] = inp.value;
                });

                saveSupplierDetails(name, details);
                renderSupplierDetail(name); // Re-render to show read-only view
            } else {
                // Enter Edit Mode
                const displays = content.querySelectorAll('.supplier-val-display');
                displays.forEach(el => {
                    const field = el.dataset.field;
                    const val = el.textContent.trim() === '-' ? '' : el.textContent.trim();
                    if (field) {
                        el.innerHTML = `<input type="text" class="supplier-edit-input rfq-input" data-field="${field}" value="${val}" style="width: 100%;">`;
                    }
                });

                const btn = getEl('btn-edit-supplier');
                if (btn) {
                    btn.textContent = 'Ulo≈æit Changes';
                    btn.classList.remove('btn-secondary');
                    btn.classList.add('btn-primary');
                    btn.onclick = () => window.toggleSupplierEdit(name, true);
                }
            }
        };

        // Delete current supplier from project
        window.deleteCurrentSupplier = async function () {
            const supName = currentViewedSupplier;
            if (!supName || !currentProject) {
                if (window.showToast) window.showToast('No supplier selected', 'error');
                return;
            }

            const confirmed = await window.showConfirmDialog({
                title: 'Delete Supplier',
                message: `Are you sure you want to delete supplier "${supName}" from this project?\n\nThis will:\n- Remove from supplier master list\n- Remove from all items in this project`,
                type: 'danger',
                okText: 'Delete',
                cancelText: 'Cancel'
            });
            if (!confirmed) return;

            const norm = (v) => String(v ?? '').trim().toLowerCase();
            const targetKey = norm(supName);

            // Remove from supplierMaster
            if (Array.isArray(currentProject.supplierMaster)) {
                currentProject.supplierMaster = currentProject.supplierMaster.filter(s => {
                    const n = norm(s.name || s.supplier_name || '');
                    return n !== targetKey;
                });
            }

            // Remove from all items
            if (Array.isArray(currentProject.items)) {
                currentProject.items.forEach(item => {
                    if (Array.isArray(item.suppliers)) {
                        item.suppliers = item.suppliers.filter(s => {
                            const n = norm(s.name || s.supplier_name || s.supplier || '');
                            return n !== targetKey;
                        });
                    }
                    // Clear main supplier if it matches
                    if (norm(item.supplier) === targetKey) {
                        item.supplier = '';
                    }
                });
            }

            // Save and update UI
            updateProject(currentProject);
            if (window.showToast) window.showToast(`Supplier "${supName}" has been deleted from this project.`, 'success');

            // Go back to supplier list
            try { switchView('suppliers'); } catch (e) { }
            try { if (typeof renderSupplierList === 'function') renderSupplierList(); } catch (e) { }
        };

        // Merge suppliers (rename all occurrences of oldName to newName)
        window.mergeSuppliers = function (oldName, newName) {
            if (!currentProject) {
                if (window.showToast) window.showToast('No project selected', 'warning');
                return false;
            }

            const normOld = String(oldName || '').trim().toLowerCase();
            const normNew = String(newName || '').trim();
            if (!normOld || !normNew) {
                showToast('Invalid supplier names', 'error');
                return false;
            }

            let updatedCount = 0;

            // Update supplierMaster
            if (Array.isArray(currentProject.supplierMaster)) {
                const masterToMerge = currentProject.supplierMaster.filter(s => {
                    const n = String(s.name || s.supplier_name || '').trim().toLowerCase();
                    return n === normOld;
                });
                const targetMaster = currentProject.supplierMaster.find(s => {
                    const n = String(s.name || '').trim().toLowerCase();
                    return n === normNew.toLowerCase();
                });

                // Remove old entries
                currentProject.supplierMaster = currentProject.supplierMaster.filter(s => {
                    const n = String(s.name || s.supplier_name || '').trim().toLowerCase();
                    return n !== normOld;
                });

                // Ensure target exists
                if (!targetMaster) {
                    currentProject.supplierMaster.push({
                        id: `${Date.now()}_${Math.random().toString(16).slice(2)}`,
                        name: normNew
                    });
                }
            }

            // Update all items
            if (Array.isArray(currentProject.items)) {
                currentProject.items.forEach(item => {
                    if (Array.isArray(item.suppliers)) {
                        item.suppliers.forEach(s => {
                            const n = String(s.name || s.supplier_name || s.supplier || '').trim().toLowerCase();
                            if (n === normOld) {
                                s.name = normNew;
                                if (s.supplier_name) s.supplier_name = normNew;
                                if (s.supplier) s.supplier = normNew;
                                updatedCount++;
                            }
                        });
                    }
                    // Update main supplier
                    if (String(item.supplier || '').trim().toLowerCase() === normOld) {
                        item.supplier = normNew;
                        updatedCount++;
                    }
                });
            }

            // Save
            updateProject(currentProject);
            return updatedCount;
        };

        // Open merge dialog
        window.openMergeSuppliersDialog = async function () {
            if (!currentProject) {
                if (window.showToast) window.showToast('No project selected', 'warning');
                return;
            }

            // Get all unique supplier names
            const suppliers = new Set();
            if (Array.isArray(currentProject.supplierMaster)) {
                currentProject.supplierMaster.forEach(s => {
                    const n = String(s.name || s.supplier_name || '').trim();
                    if (n) suppliers.add(n);
                });
            }
            if (Array.isArray(currentProject.items)) {
                currentProject.items.forEach(item => {
                    if (Array.isArray(item.suppliers)) {
                        item.suppliers.forEach(s => {
                            const n = String(s.name || s.supplier_name || s.supplier || '').trim();
                            if (n) suppliers.add(n);
                        });
                    }
                });
            }

            const sortedSuppliers = Array.from(suppliers).sort();
            if (sortedSuppliers.length < 2) {
                showToast('Need at least 2 suppliers to merge', 'warning');
                return;
            }

            const fromName = await window.showPromptDialog({
                title: 'Merge Suppliers - Step 1',
                message: 'Enter supplier name to REMOVE (source):\n\nAvailable: ' + sortedSuppliers.join(', '),
                placeholder: 'Source supplier name'
            });
            if (!fromName) return;

            const toName = await window.showPromptDialog({
                title: 'Merge Suppliers - Step 2',
                message: 'Enter supplier name to KEEP (target):\n\nAll occurrences of "' + fromName + '" will be renamed to this.',
                placeholder: 'Target supplier name'
            });
            if (!toName) return;

            if (fromName.toLowerCase() === toName.toLowerCase()) {
                showToast('Source and target names are the same', 'error');
                return;
            }

            const count = window.mergeSuppliers(fromName, toName);
            showToast(`Merged "${fromName}" into "${toName}". Updated ${count} occurrences.`, 'success');

            // Refresh UI
            try { if (typeof renderSupplierList === 'function') renderSupplierList(); } catch (e) { }
            try { if (typeof renderProjectSupplierList === 'function') renderProjectSupplierList(); } catch (e) { }
        };

        function renderSupplierDetail(supplierName) {
            const view = getEl('view-supplier-detail');
            const content = getEl('supplier-detail-page-content');
            const titleEl = getEl('supplier-detail-page-title');
            if (!view || !content) return;
            const supName = String(supplierName || '').trim();
            if (!supName) return;

            // Store for delete/merge operations
            currentViewedSupplier = supName;

            // Ensure view is visible
            view.classList.remove('hidden');

            // Make sure project structures exist
            if (currentProject) ensureProjectSuppliers(currentProject);

            // Master record (project-scoped) + legacy contact details (global)
            const master = currentProject ? getOrCreateSupplierMaster(currentProject, supName) : null;
            const details = (typeof getSupplierDetails === 'function') ? getSupplierDetails(supName) : {};

            // --------- Aggregate across ALL projects (for overview KPIs) ----------
            let totalItems = 0;
            let totalValue = 0;
            let totalValueWon = 0;
            let projectsList = new Set();
            let suppliedItems = [];
            let bundlesAll = [];
            let quotesReceived = 0;
            let openBundles = 0;
            let mainSupplierCount = 0;
            let wonCount = 0;
            let leadTimes = [];
            let prices = [];
            let moqs = [];
            let responseCount = 0;
            let totalRfqItems = 0;

            const norm = (v) => String(v ?? '').trim().toLowerCase();
            const targetKey = (typeof normalizeSupplierKey === 'function') ? normalizeSupplierKey(supName) : norm(supName);
            const matchSupplier = (name) => {
                const nk = (typeof normalizeSupplierKey === 'function') ? normalizeSupplierKey(name) : norm(name);
                if (!nk || !targetKey) return false;
                if (nk === targetKey) return true;
                if (nk.includes(targetKey) || targetKey.includes(nk)) return true;
                const a = nk.split(' ').filter(Boolean);
                const b = targetKey.split(' ').filter(Boolean);
                const setB = new Set(b);
                let inter = 0;
                a.forEach(t => { if (setB.has(t)) inter++; });
                return inter >= Math.min(2, Math.min(a.length, b.length));
            };

            const getSupplierEntry = (it) => {
                if (Array.isArray(it.suppliers)) {
                    return it.suppliers.find(s => s && matchSupplier(s.name)) || null;
                }
                return null;
            };

            const itemHasSupplier = (it) => {
                if (!it || typeof it !== 'object') return false;
                if (matchSupplier(it.supplier)) return true;
                return !!getSupplierEntry(it);
            };

            if (Array.isArray(projects)) {
                projects.forEach(p => {
                    const pItems = Array.isArray(p.items) ? p.items : [];
                    pItems.forEach(it => {
                        if (!itemHasSupplier(it)) return;
                        totalItems++;
                        projectsList.add(p.name);

                        const supEntry = getSupplierEntry(it);
                        suppliedItems.push({ project: p, item: it, supEntry });

                        // Check if main supplier + won status
                        const isMain = matchSupplier(it.supplier) || (supEntry && supEntry.isMain);
                        if (isMain) {
                            mainSupplierCount++;
                            // Check if won
                            const supStatus = supEntry?.status || '';
                            if (String(supStatus).toLowerCase().includes('won')) wonCount++;
                        }

                        // Calculate value from supplier entry or item
                        let price = 0;
                        let qty = parseFloat(it.qty_1 ?? it.qty ?? 0) || 0;
                        if (supEntry && Array.isArray(supEntry.prices) && supEntry.prices[0]) {
                            price = parseFloat(supEntry.prices[0].price) || 0;
                            prices.push(price);
                        } else {
                            price = parseFloat(it.price_1_euro ?? it.price_euro ?? it.price_1 ?? it.price ?? 0) || 0;
                            if (price > 0) prices.push(price);
                        }
                        totalValue += price * qty;
                        if (isMain) totalValueWon += price * qty;

                        // Collect lead times and MOQs
                        const lt = supEntry?.lead_time || it.lead_time || '';
                        const ltNum = parseInt(String(lt).replace(/[^\d]/g, ''));
                        if (ltNum > 0) leadTimes.push(ltNum);

                        const moqVal = supEntry?.moq || it.moq || '';
                        const moqNum = parseInt(String(moqVal).replace(/[^\d]/g, ''));
                        if (moqNum > 0) moqs.push(moqNum);
                    });

                    // RFQ batches for this project
                    if (window.RFQData && typeof window.RFQData.getRFQBatches === 'function' && p.id) {
                        const bs = window.RFQData.getRFQBatches(p.id) || [];
                        bs.forEach(b => {
                            if (!b) return;
                            const bSup = b.supplier_name || b.supplier || b.supplierName || '';
                            if (!matchSupplier(bSup)) return;
                            bundlesAll.push({ project: p, batch: b });
                        });
                    }
                });
            }

            bundlesAll.forEach(({ batch }) => {
                const st = String(batch.status || '').trim();
                const stL = String(st || '').toLowerCase();
                if (stL && !['closed', 'cancelled', 'canceled', 'completed', 'done'].includes(stL)) openBundles++;
                const lines = Array.isArray(batch.items) ? batch.items : [];
                totalRfqItems += lines.length;
                const quotedLines = lines.filter(x => ['quoted', 'quote received'].includes(String(x.quote_status || '').toLowerCase()));
                const anyQuoted = quotedLines.length > 0;
                if (anyQuoted) quotesReceived++;
                responseCount += quotedLines.length;
            });

            // Calculate derived metrics
            const avgLeadTime = leadTimes.length > 0 ? Math.round(leadTimes.reduce((a, b) => a + b, 0) / leadTimes.length) : 0;
            const avgPrice = prices.length > 0 ? prices.reduce((a, b) => a + b, 0) / prices.length : 0;
            const minPrice = prices.length > 0 ? Math.min(...prices) : 0;
            const maxPrice = prices.length > 0 ? Math.max(...prices) : 0;
            const avgMoq = moqs.length > 0 ? Math.round(moqs.reduce((a, b) => a + b, 0) / moqs.length) : 0;
            const responseRate = totalRfqItems > 0 ? Math.round((responseCount / totalRfqItems) * 100) : 0;
            const winRate = mainSupplierCount > 0 ? Math.round((wonCount / mainSupplierCount) * 100) : 0;

            // --------- Project-scoped bundles (for actions) ----------
            const projectBundles = (currentProject && window.RFQData && typeof window.RFQData.getRFQBatches === 'function')
                ? (window.RFQData.getRFQBatches(currentProject.id) || []).filter(b => matchSupplier(b.supplier_name || b.supplier || b.supplierName || ''))
                : [];

            const pipelineVal = master?.pipeline || 'Prospect';
            const ndaSigned = !!(master && master.nda && master.nda.signed);
            const ndaStatus = master?.nda?.status || (ndaSigned ? 'Signed' : 'Missing');
            const ndaDate = master?.nda?.signed_date || '';
            const ndaStorage = master?.nda?.storage || '';

            const ratingVal = typeof master?.rating === 'number' ? master.rating : (parseFloat(master?.rating) || 0);
            const tagsArr = Array.isArray(master?.tags) ? master.tags : (master?.tags ? String(master.tags).split(',').map(t => t.trim()).filter(Boolean) : []);
            const tagsVal = tagsArr.join(', ');

            const defCurrency = master?.defaults?.currency || details?.currency_default || 'EUR';
            const defIncoterms = master?.defaults?.incoterms || details?.incoterms_default || 'EXW';
            const defPayTerms = master?.defaults?.payment_terms || details?.payment_terms || '';
            const defLeadTime = master?.defaults?.lead_time || '';
            const defShip = master?.defaults?.shipping_cost || '';
            const defMOQ = master?.defaults?.moq || '';
            const defMOV = master?.defaults?.mov || '';

            const fmtMoney = (n) => {
                const decimals = window.RFQData && typeof window.RFQData.getCurrencyDecimals === 'function'
                    ? window.RFQData.getCurrencyDecimals() : 4;
                const v = Number(n || 0);
                return isFinite(v) ? v.toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }) : '0.' + '0'.repeat(decimals);
            };

            const badge = (txt, bg, color) => `<span style="padding:4px 10px; border-radius: 999px; font-size: 11px; font-weight: 700; background:${bg}; color:${color};">${txt}</span>`;

            const pipelineBadge = (() => {
                const p = String(pipelineVal || '').toLowerCase();
                if (p.includes('blocked')) return badge('BLOCKED', '#ffe5e5', '#c00');
                if (p.includes('approved')) return badge('APPROVED', '#d4edda', '#155724');
                if (p.includes('qualified')) return badge('QUALIFIED', '#cce5ff', '#004085');
                if (p.includes('nda')) return badge('NDA', '#fff3cd', '#856404');
                return badge('PROSPECT', '#e9ecef', '#495057');
            })();

            const ndaBadge = (() => {
                const n = String(ndaStatus || '').toLowerCase();
                if (n.includes('signed')) return badge('NDA SIGNED', '#d4edda', '#155724');
                if (n.includes('sent')) return badge('NDA SENT', '#cce5ff', '#004085');
                if (n.includes('expired')) return badge('NDA EXPIRED', '#f8d7da', '#721c24');
                return badge('NDA MISSING', '#fff3cd', '#856404');
            })();

            // Star rating display
            const renderStars = (rating) => {
                const full = Math.floor(rating);
                const half = rating % 1 >= 0.5 ? 1 : 0;
                const empty = 5 - full - half;
                return '<span style="color:#ffc107; font-size:16px;">' +
                    '‚òÖ'.repeat(full) +
                    (half ? '‚òÜ' : '') +
                    '<span style="color:#ddd;">‚òÖ</span>'.repeat(empty) +
                    '</span>';
            };

            // Build items table with more supplier data
            const itemsRows = suppliedItems.slice(0, 200).map(({ project, item, supEntry }) => {
                const dn = item.item_drawing_no || '';
                const desc = item.description || '';
                const isMain = matchSupplier(item.supplier) || (supEntry && supEntry.isMain);

                // Get prices from supplier entry
                let prices = [];
                let currency = defCurrency;
                let moq = '', leadTime = '';

                if (supEntry) {
                    prices = Array.isArray(supEntry.prices) ? supEntry.prices : [];
                    currency = supEntry.currency || defCurrency;
                    moq = supEntry.moq || '';
                    leadTime = supEntry.lead_time || '';
                } else {
                    // Fallback to item prices
                    for (let i = 1; i <= 5; i++) {
                        const q = parseFloat(item['qty_' + i]) || 0;
                        const p = parseFloat(item['price_' + i]) || 0;
                        if (q > 0 && p > 0) prices.push({ qty: q, price: p });
                    }
                    currency = item.currency || 'EUR';
                    moq = item.moq || '';
                    leadTime = item.lead_time || '';
                }

                const priceStr = prices.slice(0, 3).map(p => `${p.qty}@${currency}${formatPrice(parseFloat(p.price) || 0)}`).join(', ') || '-';

                return `
                    <tr class="${isMain ? 'main-supplier-row' : ''}">
                        <td style="font-weight:600; color:#007AFF; cursor:pointer;" class="sd-open-item" data-proj="${project.id}" data-dn="${escapeAttr(dn)}">${escapeHtml(dn)}</td>
                        <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${escapeAttr(desc)}">${escapeHtml(desc || '-')}</td>
                        <td>${escapeHtml(item.unit || 'pcs')}</td>
                        <td style="white-space:nowrap;">${priceStr}</td>
                        <td>${escapeHtml(moq || '-')}</td>
                        <td>${escapeHtml(leadTime || '-')}</td>
                        <td>${isMain ? '<span style="color:#28a745; font-weight:700;">Main</span>' : '<span style="color:#999;">Alt</span>'}</td>
                        <td style="color:#666; font-size:11px;">${escapeHtml(project.name || '')}</td>
                    </tr>
                `;
            }).join('') || `<tr><td colspan="8" style="padding:20px; color:#999; text-align:center;">No items linked to this supplier yet.</td></tr>`;

            // Build bundles table
            const bundlesRows = bundlesAll.length ? bundlesAll.map(({ project, batch: b }) => {
                const lines = Array.isArray(b.items) ? b.items : [];
                const total = lines.length || 0;
                const quoted = lines.filter(x => ['quoted', 'quote received'].includes(String(x.quote_status || '').toLowerCase())).length;
                const nobid = lines.filter(x => String(x.quote_status || '').toLowerCase() === 'no bid').length;
                const pending = Math.max(0, total - quoted - nobid);
                const cov = total ? Math.round((quoted / total) * 100) : 0;
                const due = b.due_date || '';
                const st = String(b.status || 'Open').trim();
                const stClass = st.toLowerCase().includes('closed') ? 'status-closed' : (st.toLowerCase().includes('sent') ? 'status-sent' : 'status-open');
                const created = b.created_at ? new Date(b.created_at).toLocaleDateString() : '';

                return `
                    <tr>
                        <td style="font-weight:600;">${String(b.id || '').slice(0, 10)}</td>
                        <td><span class="bundle-status ${stClass}">${escapeHtml(st)}</span></td>
                        <td>${created}</td>
                        <td>${due || '-'}</td>
                        <td>${total}</td>
                        <td>
                            <div style="display:flex; gap:6px; align-items:center;">
                                <div style="flex:1; background:#e9ecef; border-radius:4px; height:8px; overflow:hidden;">
                                    <div style="width:${cov}%; background:#28a745; height:100%;"></div>
                                </div>
                                <span style="font-size:11px; color:#666;">${cov}%</span>
                            </div>
                        </td>
                        <td style="font-size:11px; color:#666;">${escapeHtml(project.name || '')}</td>
                        <td><button class="btn-secondary btn-sm btn-open-bundle" data-bid="${b.id}">Open</button></td>
                    </tr>
                `;
            }).join('') : `<tr><td colspan="8" style="padding:20px; color:#999; text-align:center;">No RFQ Bundles for this supplier.</td></tr>`;

            // Custom fields
            const customArr = (master && Array.isArray(master.custom)) ? master.custom : [];
            const customRows = customArr.map((c, idx) => `
                <tr>
                    <td><input class="rfq-input sd-custom-key" data-idx="${idx}" value="${escapeAttr(c.key || '')}" placeholder="Field name"/></td>
                    <td><input class="rfq-input sd-custom-val" data-idx="${idx}" value="${escapeAttr(c.value || '')}" placeholder="Value"/></td>
                    <td><button class="btn-danger btn-sm sd-custom-del" data-idx="${idx}">√ó</button></td>
                </tr>
            `).join('');

            // Notes
            const notesArr = (master && Array.isArray(master.notes_list)) ? master.notes_list
                : (master && Array.isArray(master.notes)) ? master.notes : [];
            const notesRows = notesArr.slice().reverse().map((n, idx) => `
                <div class="sd-note">
                    <div class="sd-note-meta">${escapeHtml(n.at || new Date().toLocaleString())}</div>
                    <div class="sd-note-text">${escapeHtml(n.text || '')}</div>
                </div>
            `).join('') || `<div style="padding:16px; color:#999; text-align:center;">No notes yet.</div>`;

            // ===== TWO COLUMN LAYOUT (like Item Detail) =====
            content.innerHTML = `
                <div style="display:grid; grid-template-columns: 300px 1fr; gap:24px; flex:1; min-height:0;">
                    <!-- LEFT COLUMN -->
                    <div style="display:flex; flex-direction:column; gap:16px; overflow-y:auto; min-height:0; padding-right:8px;">
                        <!-- Supplier Card -->
                        <div class="sd-card" style="text-align:center; padding:20px;">
                            <div style="width:80px; height:80px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:50%; margin:0 auto 12px; display:flex; align-items:center; justify-content:center; font-size:32px; color:white; font-weight:700;">
                                ${supName.charAt(0).toUpperCase()}
                            </div>
                            <div style="font-size:18px; font-weight:800; margin-bottom:8px;">${escapeHtml(supName)}</div>
                            <div style="display:flex; gap:6px; justify-content:center; flex-wrap:wrap; margin-bottom:12px;">
                                ${pipelineBadge}
                                ${ndaBadge}
                            </div>
                            <div style="margin-bottom:8px;">
                                ${renderStars(ratingVal)}
                                <span style="font-size:12px; color:#666; margin-left:4px;">(${ratingVal.toFixed(1)})</span>
                            </div>
                            ${tagsArr.length ? `<div style="display:flex; gap:4px; flex-wrap:wrap; justify-content:center;">${tagsArr.map(t => `<span style="background:#e9ecef; padding:2px 8px; border-radius:999px; font-size:11px;">${escapeHtml(t)}</span>`).join('')}</div>` : ''}
                        </div>

                        <!-- KPIs -->
                        <div class="sd-card">
                            <div class="sd-card-title">üìä Statistics</div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                                <div class="sd-kpi"><div class="sd-kpi-l">Total Items</div><div class="sd-kpi-v">${totalItems}</div></div>
                                <div class="sd-kpi"><div class="sd-kpi-l">As Main</div><div class="sd-kpi-v" style="color:#28a745;">${mainSupplierCount}</div></div>
                                <div class="sd-kpi"><div class="sd-kpi-l">Projects</div><div class="sd-kpi-v">${projectsList.size}</div></div>
                                <div class="sd-kpi"><div class="sd-kpi-l">RFQ Bundles</div><div class="sd-kpi-v">${bundlesAll.length}</div></div>
                            </div>
                            <div style="border-top:1px solid #e0e0e0; margin-top:10px; padding-top:10px;">
                                <div class="sd-kpi"><div class="sd-kpi-l">Total Quoted Value</div><div class="sd-kpi-v" style="color:#28a745; font-size:16px;">‚Ç¨${formatNumber(totalValue, 0)}</div></div>
                                <div class="sd-kpi"><div class="sd-kpi-l">Won Value</div><div class="sd-kpi-v" style="color:#667eea; font-size:16px;">‚Ç¨${formatNumber(totalValueWon, 0)}</div></div>
                            </div>
                        </div>

                        <!-- Performance Metrics -->
                        <div class="sd-card">
                            <div class="sd-card-title">üìà Performance</div>
                            <div style="display:flex; flex-direction:column; gap:8px;">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <span style="font-size:11px; color:#666;">Win Rate</span>
                                    <div style="display:flex; align-items:center; gap:6px;">
                                        <div style="width:60px; height:6px; background:#e9ecef; border-radius:3px; overflow:hidden;">
                                            <div style="width:${winRate}%; height:100%; background:${winRate >= 50 ? '#28a745' : '#fd7e14'}; border-radius:3px;"></div>
                                        </div>
                                        <span style="font-size:12px; font-weight:700; color:${winRate >= 50 ? '#28a745' : '#fd7e14'};">${winRate}%</span>
                                    </div>
                                </div>
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <span style="font-size:11px; color:#666;">Response Rate</span>
                                    <div style="display:flex; align-items:center; gap:6px;">
                                        <div style="width:60px; height:6px; background:#e9ecef; border-radius:3px; overflow:hidden;">
                                            <div style="width:${responseRate}%; height:100%; background:${responseRate >= 70 ? '#28a745' : '#fd7e14'}; border-radius:3px;"></div>
                                        </div>
                                        <span style="font-size:12px; font-weight:700; color:${responseRate >= 70 ? '#28a745' : '#fd7e14'};">${responseRate}%</span>
                                    </div>
                                </div>
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <span style="font-size:11px; color:#666;">Avg Lead Time</span>
                                    <span style="font-size:12px; font-weight:700;">${avgLeadTime > 0 ? avgLeadTime + ' days' : '‚Äî'}</span>
                                </div>
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <span style="font-size:11px; color:#666;">Avg MOQ</span>
                                    <span style="font-size:12px; font-weight:700;">${avgMoq > 0 ? avgMoq : '‚Äî'}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Price Range -->
                        <div class="sd-card">
                            <div class="sd-card-title">üí∞ Price Range</div>
                            <div style="display:flex; flex-direction:column; gap:6px;">
                                <div style="display:flex; justify-content:space-between;">
                                    <span style="font-size:11px; color:#666;">Avg Unit Price</span>
                                    <span style="font-size:12px; font-weight:700; color:#007AFF;">‚Ç¨${formatNumber(avgPrice, 2)}</span>
                                </div>
                                <div style="display:flex; justify-content:space-between;">
                                    <span style="font-size:11px; color:#666;">Min Price</span>
                                    <span style="font-size:12px; font-weight:700; color:#28a745;">‚Ç¨${formatNumber(minPrice, 2)}</span>
                                </div>
                                <div style="display:flex; justify-content:space-between;">
                                    <span style="font-size:11px; color:#666;">Max Price</span>
                                    <span style="font-size:12px; font-weight:700; color:#dc3545;">‚Ç¨${formatNumber(maxPrice, 2)}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="sd-card">
                            <div class="sd-card-title">Quick Actions</div>
                            <div style="display:flex; flex-direction:column; gap:8px;">
                                <button class="btn-primary" id="sd-open-quoting" style="width:100%;">Open Quoting</button>
                                <button class="btn-secondary" id="sd-open-bulk" style="width:100%;">Bulk Pricing</button>
                                <button class="btn-secondary" id="sd-new-bundle" style="width:100%;">+ New RFQ Bundle</button>
                                <button class="btn-secondary" id="sd-export" style="width:100%;">Export Data</button>
                            </div>
                        </div>

                        <!-- Contact Summary -->
                        <div class="sd-card">
                            <div class="sd-card-title">Contact</div>
                            <div style="font-size:13px; display:flex; flex-direction:column; gap:6px;">
                                ${details.contact_person ? `<div><strong>Contact:</strong> ${escapeHtml(details.contact_person)}</div>` : ''}
                                ${details.email ? `<div><strong>Email:</strong> <a href="mailto:${escapeAttr(details.email)}" style="color:#007AFF;">${escapeHtml(details.email)}</a></div>` : ''}
                                ${details.phone ? `<div><strong>Phone:</strong> ${escapeHtml(details.phone)}</div>` : ''}
                                ${details.website ? `<div><strong>Web:</strong> <a href="${escapeAttr(details.website)}" target="_blank" style="color:#007AFF;">${escapeHtml(details.website)}</a></div>` : ''}
                                ${!details.contact_person && !details.email && !details.phone ? '<div style="color:#999;">No contact info yet</div>' : ''}
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT COLUMN with Tabs -->
                    <div style="display:flex; flex-direction:column; min-height:0;">
                        <!-- Tab Header -->
                        <div class="sd-tabs" style="flex-shrink:0; border-bottom:2px solid #e0e0e0;">
                            <button class="sd-tab active" data-tab="overview">üìã Overview</button>
                            <button class="sd-tab" data-tab="performance">üìà Performance</button>
                            <button class="sd-tab" data-tab="items">üì¶ Items</button>
                            <button class="sd-tab" data-tab="rfq">üìß RFQ History</button>
                            <button class="sd-tab" data-tab="compliance">üìÑ NDA & Docs</button>
                            <button class="sd-tab" data-tab="notes">üìù Notes</button>
                        </div>

                        <!-- Tab Panels -->
                        <div class="sd-panels">
                            <!-- OVERVIEW TAB -->
                            <div class="sd-panel active" data-panel="overview">
                                <div class="sd-grid2">
                                    <div class="sd-card">
                                        <div class="sd-card-title">Master Status</div>
                                        <div class="detail-grid" style="grid-template-columns: 1fr 1fr; gap: 12px;">
                                            <div class="form-row">
                                                <label>Pipeline Stage</label>
                                                <select class="rfq-input" data-sm-field="pipeline">
                                                    ${['Prospect', 'NDA', 'Qualified', 'Approved', 'Blocked'].map(x => `<option ${x === pipelineVal ? 'selected' : ''}>${x}</option>`).join('')}
                                                </select>
                                            </div>
                                            <div class="form-row">
                                                <label>Rating (0-5)</label>
                                                <input class="rfq-input" type="number" min="0" max="5" step="0.5" data-sm-field="rating" value="${ratingVal || ''}" placeholder="0-5"/>
                                            </div>
                                            <div class="form-row" style="grid-column: 1 / -1;">
                                                <label>Tags (comma-separated)</label>
                                                <input class="rfq-input" data-sm-field="tags" value="${escapeAttr(tagsVal)}" placeholder="PCB, Assembly, EU, Fast delivery..."/>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="sd-card">
                                        <div class="sd-card-title">Contact Details</div>
                                        <div class="detail-grid" style="grid-template-columns: 1fr 1fr; gap: 12px;">
                                            <div class="form-row">
                                                <label>Contact Person</label>
                                                <input class="rfq-input" data-sd-field="contact_person" value="${escapeAttr(details.contact_person || '')}" placeholder="Name"/>
                                            </div>
                                            <div class="form-row">
                                                <label>Email</label>
                                                <input class="rfq-input" type="email" data-sd-field="email" value="${escapeAttr(details.email || '')}" placeholder="email@company.com"/>
                                            </div>
                                            <div class="form-row">
                                                <label>Phone</label>
                                                <input class="rfq-input" data-sd-field="phone" value="${escapeAttr(details.phone || '')}" placeholder="+420..."/>
                                            </div>
                                            <div class="form-row">
                                                <label>Website</label>
                                                <input class="rfq-input" data-sd-field="website" value="${escapeAttr(details.website || '')}" placeholder="https://..."/>
                                            </div>
                                            <div class="form-row" style="grid-column: 1 / -1;">
                                                <label>Address</label>
                                                <input class="rfq-input" data-sd-field="address" value="${escapeAttr(details.address || '')}" placeholder="Street, City, Country"/>
                                            </div>
                                            <div class="form-row">
                                                <label>Payment Terms</label>
                                                <input class="rfq-input" data-sd-field="payment_terms" value="${escapeAttr(details.payment_terms || '')}" placeholder="Net 30"/>
                                            </div>
                                            <div class="form-row">
                                                <label>Tax/VAT ID</label>
                                                <input class="rfq-input" data-sd-field="tax_id" value="${escapeAttr(details.tax_id || '')}" placeholder="CZ12345678"/>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="sd-card" style="margin-top:16px;">
                                    <div class="sd-card-title">Default Terms (for new quotes)</div>
                                    <div class="detail-grid" style="grid-template-columns: repeat(4, 1fr); gap: 12px;">
                                        <div class="form-row">
                                            <label>Currency</label>
                                            <select class="rfq-input" data-sm-field="defaults.currency">
                                                ${(window.RFQData?.CURRENCIES || ['EUR', 'USD', 'CZK', 'GBP', 'CNY']).map(x => `<option ${x === defCurrency ? 'selected' : ''}>${x}</option>`).join('')}
                                            </select>
                                        </div>
                                        <div class="form-row">
                                            <label>Incoterms</label>
                                            <select class="rfq-input" data-sm-field="defaults.incoterms">
                                                ${(window.RFQData?.INCOTERMS || ['EXW', 'FCA', 'FOB', 'CIF', 'DAP', 'DDP']).map(x => `<option ${x === defIncoterms ? 'selected' : ''}>${x}</option>`).join('')}
                                            </select>
                                        </div>
                                        <div class="form-row">
                                            <label>Lead Time</label>
                                            <input class="rfq-input" data-sm-field="defaults.lead_time" value="${escapeAttr(defLeadTime)}" placeholder="4 weeks"/>
                                        </div>
                                        <div class="form-row">
                                            <label>Shipping Cost</label>
                                            <input class="rfq-input" data-sm-field="defaults.shipping_cost" value="${escapeAttr(defShip)}" placeholder="25"/>
                                        </div>
                                        <div class="form-row">
                                            <label>MOQ</label>
                                            <input class="rfq-input" data-sm-field="defaults.moq" value="${escapeAttr(defMOQ)}" placeholder="Min order qty"/>
                                        </div>
                                        <div class="form-row">
                                            <label>MOV</label>
                                            <input class="rfq-input" data-sm-field="defaults.mov" value="${escapeAttr(defMOV)}" placeholder="Min order value"/>
                                        </div>
                                        <div class="form-row" style="grid-column: span 2;">
                                            <label>Payment Terms</label>
                                            <input class="rfq-input" data-sm-field="defaults.payment_terms" value="${escapeAttr(defPayTerms)}" placeholder="Net 30, prepaid..."/>
                                        </div>
                                    </div>
                                </div>

                                <!-- Custom Fields inline -->
                                <div class="sd-card" style="margin-top:16px;">
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                        <div class="sd-card-title" style="margin:0;">Custom Fields</div>
                                        <button class="btn-primary btn-sm" id="sd-custom-add">+ Add</button>
                                    </div>
                                    <table class="items-table" style="font-size:13px;">
                                        <thead><tr><th>Field</th><th>Value</th><th style="width:50px;"></th></tr></thead>
                                        <tbody id="sd-custom-tbody">${customRows || '<tr><td colspan="3" style="padding:12px; color:#999; text-align:center;">No custom fields</td></tr>'}</tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- PERFORMANCE TAB -->
                            <div class="sd-panel" data-panel="performance">
                                <!-- Key Metrics Row -->
                                <div style="display:grid; grid-template-columns:repeat(5, 1fr); gap:12px; margin-bottom:16px;">
                                    <div class="sd-card" style="padding:16px; text-align:center;">
                                        <div style="font-size:11px; color:#666;">Win Rate</div>
                                        <div style="font-size:28px; font-weight:800; color:${winRate >= 50 ? '#28a745' : '#fd7e14'};">${winRate}%</div>
                                        <div style="font-size:10px; color:#666;">${wonCount} of ${mainSupplierCount} won</div>
                                    </div>
                                    <div class="sd-card" style="padding:16px; text-align:center;">
                                        <div style="font-size:11px; color:#666;">Response Rate</div>
                                        <div style="font-size:28px; font-weight:800; color:${responseRate >= 70 ? '#28a745' : '#fd7e14'};">${responseRate}%</div>
                                        <div style="font-size:10px; color:#666;">${responseCount} of ${totalRfqItems} items</div>
                                    </div>
                                    <div class="sd-card" style="padding:16px; text-align:center;">
                                        <div style="font-size:11px; color:#666;">Avg Lead Time</div>
                                        <div style="font-size:28px; font-weight:800; color:#007AFF;">${avgLeadTime > 0 ? avgLeadTime : '‚Äî'}</div>
                                        <div style="font-size:10px; color:#666;">${avgLeadTime > 0 ? 'days' : 'No data'}</div>
                                    </div>
                                    <div class="sd-card" style="padding:16px; text-align:center;">
                                        <div style="font-size:11px; color:#666;">Avg Unit Price</div>
                                        <div style="font-size:28px; font-weight:800; color:#667eea;">‚Ç¨${formatNumber(avgPrice, 0)}</div>
                                        <div style="font-size:10px; color:#666;">per item</div>
                                    </div>
                                    <div class="sd-card" style="padding:16px; text-align:center;">
                                        <div style="font-size:11px; color:#666;">Avg MOQ</div>
                                        <div style="font-size:28px; font-weight:800; color:#17a2b8;">${avgMoq > 0 ? avgMoq : '‚Äî'}</div>
                                        <div style="font-size:10px; color:#666;">${avgMoq > 0 ? 'units' : 'No data'}</div>
                                    </div>
                                </div>

                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                                    <!-- Value Analysis -->
                                    <div class="sd-card" style="padding:16px;">
                                        <div class="sd-card-title">üí∞ Value Analysis</div>
                                        <div style="display:flex; flex-direction:column; gap:12px;">
                                            <div style="display:flex; justify-content:space-between; padding:10px; background:#f8f9fa; border-radius:8px;">
                                                <span>Total Quoted Value</span>
                                                <span style="font-weight:700; color:#28a745;">‚Ç¨${formatNumber(totalValue, 0)}</span>
                                            </div>
                                            <div style="display:flex; justify-content:space-between; padding:10px; background:#f8f9fa; border-radius:8px;">
                                                <span>Won Value</span>
                                                <span style="font-weight:700; color:#667eea;">‚Ç¨${formatNumber(totalValueWon, 0)}</span>
                                            </div>
                                            <div style="display:flex; justify-content:space-between; padding:10px; background:#f8f9fa; border-radius:8px;">
                                                <span>Value per Item (avg)</span>
                                                <span style="font-weight:700;">‚Ç¨${formatNumber(totalItems > 0 ? totalValue / totalItems : 0, 2)}</span>
                                            </div>
                                            <div style="display:flex; justify-content:space-between; padding:10px; background:${totalValueWon > 0 ? '#d4edda' : '#fff3cd'}; border-radius:8px;">
                                                <span>Win Value %</span>
                                                <span style="font-weight:700; color:${totalValueWon > 0 ? '#155724' : '#856404'};">${totalValue > 0 ? Math.round((totalValueWon / totalValue) * 100) : 0}%</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Price Distribution -->
                                    <div class="sd-card" style="padding:16px;">
                                        <div class="sd-card-title">üìä Price Statistics</div>
                                        <div style="display:flex; flex-direction:column; gap:12px;">
                                            <div style="display:flex; justify-content:space-between; padding:10px; background:#f8f9fa; border-radius:8px;">
                                                <span>Min Unit Price</span>
                                                <span style="font-weight:700; color:#28a745;">‚Ç¨${formatNumber(minPrice, 2)}</span>
                                            </div>
                                            <div style="display:flex; justify-content:space-between; padding:10px; background:#f8f9fa; border-radius:8px;">
                                                <span>Max Unit Price</span>
                                                <span style="font-weight:700; color:#dc3545;">‚Ç¨${formatNumber(maxPrice, 2)}</span>
                                            </div>
                                            <div style="display:flex; justify-content:space-between; padding:10px; background:#f8f9fa; border-radius:8px;">
                                                <span>Avg Unit Price</span>
                                                <span style="font-weight:700; color:#007AFF;">‚Ç¨${formatNumber(avgPrice, 2)}</span>
                                            </div>
                                            <div style="display:flex; justify-content:space-between; padding:10px; background:#f8f9fa; border-radius:8px;">
                                                <span>Price Range</span>
                                                <span style="font-weight:700;">‚Ç¨${formatNumber(maxPrice - minPrice, 2)}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Projects Breakdown -->
                                <div class="sd-card" style="padding:16px; margin-top:16px;">
                                    <div class="sd-card-title">üìÅ Projects Breakdown (${projectsList.size})</div>
                                    <div style="display:flex; flex-wrap:wrap; gap:8px;">
                                    ${Array.from(projectsList).map(pName => {
                const pItems = suppliedItems.filter(x => x.project.name === pName);
                const pMain = pItems.filter(x => x.supEntry?.isMain || matchSupplier(x.item.supplier)).length;
                return `
                                            <div style="padding:10px 14px; background:#f8f9fa; border-radius:8px; min-width:150px;">
                                                <div style="font-weight:600; font-size:12px; color:#333; margin-bottom:4px;">${escapeHtml(pName)}</div>
                                                <div style="font-size:11px; color:#666;">
                                                    <span style="color:#28a745; font-weight:600;">${pMain}</span> main /
                                                    <span>${pItems.length}</span> total
                                                </div>
                                            </div>
                                        `;
            }).join('')}
                                    </div>
                                </div>

                                <!-- Comparison with Target -->
                                <div class="sd-card" style="padding:16px; margin-top:16px;">
                                    <div class="sd-card-title">üéØ Supplier Score Summary</div>
                                    <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:16px; text-align:center;">
                                        <div style="padding:16px; background:${winRate >= 50 ? '#d4edda' : '#fff3cd'}; border-radius:8px;">
                                            <div style="font-size:12px; color:#666;">Win Rate Score</div>
                                            <div style="font-size:24px; font-weight:800; color:${winRate >= 50 ? '#155724' : '#856404'};">${winRate >= 70 ? 'A' : winRate >= 50 ? 'B' : winRate >= 30 ? 'C' : 'D'}</div>
                                        </div>
                                        <div style="padding:16px; background:${responseRate >= 70 ? '#d4edda' : '#fff3cd'}; border-radius:8px;">
                                            <div style="font-size:12px; color:#666;">Response Score</div>
                                            <div style="font-size:24px; font-weight:800; color:${responseRate >= 70 ? '#155724' : '#856404'};">${responseRate >= 80 ? 'A' : responseRate >= 60 ? 'B' : responseRate >= 40 ? 'C' : 'D'}</div>
                                        </div>
                                        <div style="padding:16px; background:${avgLeadTime > 0 && avgLeadTime <= 14 ? '#d4edda' : '#fff3cd'}; border-radius:8px;">
                                            <div style="font-size:12px; color:#666;">Lead Time Score</div>
                                            <div style="font-size:24px; font-weight:800; color:${avgLeadTime <= 14 ? '#155724' : '#856404'};">${avgLeadTime <= 7 ? 'A' : avgLeadTime <= 14 ? 'B' : avgLeadTime <= 28 ? 'C' : 'D'}</div>
                                        </div>
                                        <div style="padding:16px; background:#e3f2fd; border-radius:8px;">
                                            <div style="font-size:12px; color:#666;">Overall Rating</div>
                                            <div style="font-size:24px; font-weight:800; color:#1565c0;">${ratingVal.toFixed(1)} ‚òÖ</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ITEMS TAB -->
                            <div class="sd-panel" data-panel="items">
                                <div class="sd-card" style="height:100%; display:flex; flex-direction:column;">
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                        <div class="sd-card-title" style="margin:0;">Items supplied (${totalItems})</div>
                                        <div style="font-size:12px; color:#666;">Main: ${mainSupplierCount} | Alt: ${totalItems - mainSupplierCount}</div>
                                    </div>
                                    <div class="table-wrapper" style="flex:1; overflow:auto;">
                                        <table class="sd-items-table resizable-table draggable-table" id="sd-items-table">
                                            <thead>
                                                <tr>
                                                    <th data-col-id="drawing_no"><span class="col-drag-handle">‚ãÆ‚ãÆ</span>Drawing No</th>
                                                    <th data-col-id="description"><span class="col-drag-handle">‚ãÆ‚ãÆ</span>Description</th>
                                                    <th data-col-id="unit"><span class="col-drag-handle">‚ãÆ‚ãÆ</span>Unit</th>
                                                    <th data-col-id="prices"><span class="col-drag-handle">‚ãÆ‚ãÆ</span>Prices (Qty@Price)</th>
                                                    <th data-col-id="moq"><span class="col-drag-handle">‚ãÆ‚ãÆ</span>MOQ</th>
                                                    <th data-col-id="lead_time"><span class="col-drag-handle">‚ãÆ‚ãÆ</span>Lead Time</th>
                                                    <th data-col-id="type"><span class="col-drag-handle">‚ãÆ‚ãÆ</span>Type</th>
                                                    <th data-col-id="project"><span class="col-drag-handle">‚ãÆ‚ãÆ</span>Project</th>
                                                </tr>
                                            </thead>
                                            <tbody>${itemsRows}</tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- RFQ HISTORY TAB -->
                            <div class="sd-panel" data-panel="rfq">
                                <div class="sd-card" style="height:100%; display:flex; flex-direction:column;">
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                        <div class="sd-card-title" style="margin:0;">RFQ Bundles (${bundlesAll.length})</div>
                                        <div style="display:flex; gap:8px;">
                                            <span style="font-size:12px; color:#28a745;">Quoted: ${quotesReceived}</span>
                                            <span style="font-size:12px; color:#ffc107;">Open: ${openBundles}</span>
                                        </div>
                                    </div>
                                    <div class="table-wrapper" style="flex:1; overflow:auto;">
                                        <table class="sd-items-table resizable-table draggable-table" id="sd-rfq-history-table">
                                            <thead>
                                                <tr>
                                                    <th data-col-id="bundle_id"><span class="col-drag-handle">‚ãÆ‚ãÆ</span>Bundle ID</th>
                                                    <th data-col-id="status"><span class="col-drag-handle">‚ãÆ‚ãÆ</span>Status</th>
                                                    <th data-col-id="created"><span class="col-drag-handle">‚ãÆ‚ãÆ</span>Created</th>
                                                    <th data-col-id="due_date"><span class="col-drag-handle">‚ãÆ‚ãÆ</span>Due Date</th>
                                                    <th data-col-id="items"><span class="col-drag-handle">‚ãÆ‚ãÆ</span>Items</th>
                                                    <th data-col-id="coverage" style="width:120px;"><span class="col-drag-handle">‚ãÆ‚ãÆ</span>Coverage</th>
                                                    <th data-col-id="project"><span class="col-drag-handle">‚ãÆ‚ãÆ</span>Project</th>
                                                    <th data-col-id="actions"></th>
                                                </tr>
                                            </thead>
                                            <tbody>${bundlesRows}</tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- COMPLIANCE TAB -->
                            <div class="sd-panel" data-panel="compliance">
                                <div class="sd-grid2">
                                    <div class="sd-card">
                                        <div class="sd-card-title">NDA Status</div>
                                        <div class="detail-grid" style="grid-template-columns: 1fr 1fr; gap: 12px;">
                                            <div class="form-row">
                                                <label>NDA Status</label>
                                                <select class="rfq-input" data-sm-field="nda.status">
                                                    ${['Missing', 'Sent', 'Signed', 'Expired'].map(x => `<option ${x === ndaStatus ? 'selected' : ''}>${x}</option>`).join('')}
                                                </select>
                                            </div>
                                            <div class="form-row">
                                                <label>Signed Date</label>
                                                <input class="rfq-input" type="date" data-sm-field="nda.signed_date" value="${escapeAttr(ndaDate)}"/>
                                            </div>
                                            <div class="form-row" style="grid-column: 1 / -1;">
                                                <label>Document Link/Path</label>
                                                <input class="rfq-input" data-sm-field="nda.storage" value="${escapeAttr(ndaStorage)}" placeholder="URL or file path"/>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="sd-card">
                                        <div class="sd-card-title">Documents & Links</div>
                                        <div class="detail-grid" style="gap: 12px;">
                                            <div class="form-row">
                                                <label>Supplier Profile</label>
                                                <input class="rfq-input" data-sm-field="docs.profile" value="${escapeAttr(master?.docs?.profile || '')}" placeholder="URL"/>
                                            </div>
                                            <div class="form-row">
                                                <label>Certifications (ISO, etc.)</label>
                                                <input class="rfq-input" data-sm-field="docs.certifications" value="${escapeAttr(master?.docs?.certifications || '')}" placeholder="ISO9001, IATF16949..."/>
                                            </div>
                                            <div class="form-row">
                                                <label>Other Documents</label>
                                                <input class="rfq-input" data-sm-field="docs.other" value="${escapeAttr(master?.docs?.other || '')}" placeholder="Links or notes"/>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="sd-card" style="margin-top:16px;">
                                    <div class="sd-card-title">Compliance Notes</div>
                                    <textarea class="rfq-input" data-sm-field="compliance_notes" rows="5" style="width:100%;" placeholder="RoHS, REACH, audits, quality notes...">${escapeHtml(master?.compliance_notes || '')}</textarea>
                                </div>
                            </div>

                            <!-- NOTES TAB -->
                            <div class="sd-panel" data-panel="notes">
                                <div class="sd-grid2">
                                    <div class="sd-card">
                                        <div class="sd-card-title">Add New Note</div>
                                        <textarea id="sd-note-text" class="rfq-input" rows="6" style="width:100%;" placeholder="Write a note about this supplier..."></textarea>
                                        <div style="display:flex; gap:8px; margin-top:12px;">
                                            <button class="btn-primary" id="sd-note-add">Add Note</button>
                                            <button class="btn-secondary" id="sd-note-clear">Clear</button>
                                        </div>
                                    </div>
                                    <div class="sd-card" style="max-height:400px; overflow-y:auto;">
                                        <div class="sd-card-title">Notes History (${notesArr.length})</div>
                                        <div id="sd-notes-list">${notesRows}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Bar -->
                        <div style="display:flex; justify-content:flex-end; gap:10px; padding:12px 0; border-top:1px solid #e5e5ea; flex-shrink:0;">
                            <button class="btn-secondary" id="sd-close">Back</button>
                            <button class="btn-success" id="sd-save">Save</button>
                            <button class="btn-primary" id="sd-save-close">Save & Close</button>
                        </div>
                    </div>
                </div>
            `;

            // --------- Tabs ----------
            const tabs = content.querySelectorAll('.sd-tab');
            const panels = content.querySelectorAll('.sd-panel');
            tabs.forEach(btn => {
                btn.addEventListener('click', () => {
                    tabs.forEach(b => b.classList.remove('active'));
                    panels.forEach(p => p.classList.remove('active'));
                    btn.classList.add('active');
                    const t = btn.dataset.tab;
                    const panel = content.querySelector(`.sd-panel[data-panel="${t}"]`);
                    if (panel) panel.classList.add('active');
                });
            });

            // --------- Actions ----------
            const close = () => { try { switchView(supplierDetailReturnView || 'suppliers'); } catch (e) { view.classList.add('hidden'); } };

            const saveAll = () => {
                // Ulo≈æit legacy details
                const d = (typeof getSupplierDetails === 'function') ? getSupplierDetails(supName) : {};
                content.querySelectorAll('[data-sd-field]').forEach(inp => {
                    const k = inp.dataset.sdField;
                    d[k] = (inp.value ?? '').toString();
                });
                if (typeof saveSupplierDetails === 'function') saveSupplierDetails(supName, d);

                // Ulo≈æit master (project-scoped)
                if (currentProject && master) {
                    const setNested = (obj, path, value) => {
                        const parts = String(path || '').split('.');
                        let cur = obj;
                        for (let i = 0; i < parts.length - 1; i++) {
                            const p = parts[i];
                            if (!cur[p] || typeof cur[p] !== 'object') cur[p] = {};
                            cur = cur[p];
                        }
                        cur[parts[parts.length - 1]] = value;
                    };

                    content.querySelectorAll('[data-sm-field]').forEach(inp => {
                        const k = inp.dataset.smField;
                        let v = (inp.value ?? '').toString();
                        if (k === 'rating') v = parseFloat(v || '0') || 0;
                        if (k === 'tags') {
                            const arr = v.split(',').map(x => x.trim()).filter(Boolean);
                            setNested(master, 'tags', arr);
                            return;
                        }
                        setNested(master, k, v);
                    });

                    // Keep nda.signed boolean consistent with status
                    const st = String(master?.nda?.status || '').toLowerCase();
                    if (!master.nda) master.nda = {};
                    master.nda.signed = st.includes('signed');

                    // Custom fields
                    const newCustom = [];
                    const rows = content.querySelectorAll('#sd-custom-tbody tr');
                    rows.forEach((tr) => {
                        const keyInp = tr.querySelector('.sd-custom-key');
                        const valInp = tr.querySelector('.sd-custom-val');
                        if (!keyInp || !valInp) return;
                        const key = String(keyInp.value || '').trim();
                        const val = String(valInp.value || '').trim();
                        if (!key && !val) return;
                        newCustom.push({ key, value: val });
                    });
                    master.custom = newCustom;

                    // Persist
                    upsertSupplierMaster(currentProject, master);
                    updateProject(currentProject);
                }

                // Re-render supplier list / quoting if needed (best-effort)
                if (typeof renderSupplierList === 'function') {
                    try { renderSupplierList(); } catch (e) { }
                }
                if (typeof renderQuoting === 'function') {
                    try { renderQuoting(); } catch (e) { }
                }
            };

            const saveBtn = content.querySelector('#sd-save');
            const saveCloseBtn = content.querySelector('#sd-save-close');
            const closeBtn = content.querySelector('#sd-close');

            if (saveBtn) saveBtn.addEventListener('click', () => saveAll());
            if (saveCloseBtn) saveCloseBtn.addEventListener('click', () => { saveAll(); close(); });
            if (closeBtn) closeBtn.addEventListener('click', () => close());

            const exportBtn = content.querySelector('#sd-export');
            if (exportBtn) exportBtn.addEventListener('click', () => {
                const footerExport = getEl('btn-export-supplier');
                if (footerExport) footerExport.click();
            });

            const openQuotingBtn = content.querySelector('#sd-open-quoting');
            if (openQuotingBtn) openQuotingBtn.addEventListener('click', () => {
                try { switchView('quoting'); } catch (e) { }
                try {
                    const f = getEl('qt-supplier-filter');
                    if (f) { f.value = supName; f.dispatchEvent(new Event('input')); }
                } catch (e) { }
                try {
                    if (typeof setQuotingSupplier === 'function') {
                        setQuotingSupplier(supName);
                    } else {
                        const st = (typeof getQuotingState === 'function') ? getQuotingState() : null;
                        if (st) { st.supplier = supName; st.batchId = ''; st.mode = 'supplier'; }
                        if (typeof renderQuotingView === 'function') renderQuotingView();
                    }
                } catch (e) { }
            });

            const openBulkBtn = content.querySelector('#sd-open-bulk');
            if (openBulkBtn) openBulkBtn.addEventListener('click', () => {
                try { switchView('suppliers'); } catch (e) { }
                const sel = getEl('bulk-supplier-select');
                if (sel) {
                    sel.value = supName;
                    sel.dispatchEvent(new Event('change'));
                }
            });

            const newBundleBtn = content.querySelector('#sd-new-bundle');
            if (newBundleBtn) newBundleBtn.addEventListener('click', () => {
                try { switchView('quoting'); } catch (e) { }
                try {
                    const f = getEl('qt-supplier-filter');
                    if (f) { f.value = supName; f.dispatchEvent(new Event('input')); }
                } catch (e) { }
                try {
                    if (typeof setQuotingSupplier === 'function') setQuotingSupplier(supName);
                    const st = (typeof getQuotingState === 'function') ? getQuotingState() : null;
                    if (st) { st.mode = 'create'; st.wizOpen = true; st.batchId = ''; }
                    if (typeof renderQuotingView === 'function') renderQuotingView();
                } catch (e) { }
            });

            // Bundle open
            content.querySelectorAll('.btn-open-bundle').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const bid = btn.dataset.bid;
                    switchView('quoting');
                    if (typeof openRFQBatchDetail === 'function') openRFQBatchDetail(bid);
                    else if (typeof window.openRFQBatchDetail === 'function') window.openRFQBatchDetail(bid);
                    else if (typeof openBatchDetail === 'function') openBatchDetail(bid);
                });
            });

            // Item open
            content.querySelectorAll('.sd-open-item').forEach(td => {
                td.addEventListener('click', () => {
                    const projId = td.dataset.proj;
                    const dn = td.dataset.dn;
                    if (!projId || !dn) return;
                    // open item detail (by index) - keeps the return view correct
                    const proj = projects.find(p => String(p.id) === String(projId));
                    let idx = -1;
                    if (proj && Array.isArray(proj.items)) {
                        idx = proj.items.findIndex(it => String(it && it.item_drawing_no || '').trim() === String(dn || '').trim());
                    }
                    if (idx >= 0) {
                        try { openItemDetailByRef({ projectId: projId, index: idx, drawingNo: dn }); } catch (e) {
                            currentProject = proj;
                            try { updateProject(currentProject); } catch (e2) { }
                            try { setProjectNameUI(proj && proj.name); } catch (e3) { }
                            try { openDetailWindow(idx); } catch (e4) { }
                        }
                    } else {
                        try { if (typeof openItemInProject === 'function') openItemInProject(projId, dn); } catch (e) { }
                        showToast('Item not found in project.', 'warning');
                    }
                });
            });

            // Custom add/delete
            const customAdd = content.querySelector('#sd-custom-add');
            if (customAdd) customAdd.addEventListener('click', () => {
                const tb = content.querySelector('#sd-custom-tbody');
                if (!tb) return;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input class="rfq-input sd-custom-key" placeholder="Field"/></td>
                    <td><input class="rfq-input sd-custom-val" placeholder="Value"/></td>
                    <td style="white-space:nowrap;"><button class="btn-danger sd-custom-del">‚úï</button></td>
                `;
                tb.appendChild(tr);
                const delBtn = tr.querySelector('.sd-custom-del');
                if (delBtn) delBtn.addEventListener('click', () => tr.remove());
            });
            content.querySelectorAll('.sd-custom-del').forEach(btn => btn.addEventListener('click', () => {
                const tr = btn.closest('tr');
                if (tr) tr.remove();
            }));

            // Notes add
            const noteAdd = content.querySelector('#sd-note-add');
            const noteClear = content.querySelector('#sd-note-clear');
            const noteText = content.querySelector('#sd-note-text');
            const notesList = content.querySelector('#sd-notes-list');
            if (noteClear && noteText) noteClear.addEventListener('click', () => noteText.value = '');
            if (noteAdd && noteText) {
                noteAdd.addEventListener('click', () => {
                    const t = String(noteText.value || '').trim();
                    if (!t) return;
                    if (currentProject && master) {
                        if (!Array.isArray(master.notes_list)) master.notes_list = [];
                        master.notes_list.push({ at: new Date().toISOString().slice(0, 19).replace('T', ' '), text: t });
                        upsertSupplierMaster(currentProject, master);
                        updateProject(currentProject);
                    }
                    noteText.value = '';
                    // refresh notes list quickly
                    if (notesList) {
                        const div = document.createElement('div');
                        div.className = 'sd-note';
                        div.innerHTML = `<div class="sd-note-meta">${escapeHtml(new Date().toISOString().slice(0, 19).replace('T', ' '))}</div><div class="sd-note-text">${escapeHtml(t)}</div>`;
                        notesList.prepend(div);
                    }
                });
            }

            // Hook close buttons (overlay header/footer)
            const closeX = getEl('btn-close-supplier-detail');
            if (closeX) closeX.onclick = close;
            const closeFooter = getEl('btn-close-supplier-footer');
            if (closeFooter) closeFooter.onclick = close;

            // Initialize resizable and draggable columns for SD tables
            setTimeout(() => {
                ensureUnifiedTable('sd-items-table', 'rfq_supplier_detail_items');
                ensureUnifiedTable('sd-rfq-history-table', 'rfq_supplier_detail_rfq_history');

                initTablePagination('sd-items-table', { storageKey: 'rfq_sd_items_page' });
                initTablePagination('sd-rfq-history-table', { storageKey: 'rfq_sd_rfq_page' });
            }, 50);
        }

        window.openItemInProject = function (projectId, drawingNo) {
            const proj = projects.find(p => p.id == projectId);
            if (!proj) return;

            currentProject = proj;

            const select = getEl('dashboard-project-select');
            if (select) select.value = currentProject.id;

            // Switch to items first (ensure DOM is visible/ready)
            if (typeof switchView === 'function') {
                switchView('items');
            } else {
                const views = ['dashboard', 'items', 'suppliers', 'supplier-list', 'database'];
                views.forEach(v => {
                    const el = getEl('view-' + v);
                    if (el) el.classList.add('hidden');
                    const nav = getEl('nav-' + v);
                    if (nav) nav.classList.remove('active');
                });
                const itemsView = getEl('view-items');
                if (itemsView) itemsView.classList.remove('hidden');
                const itemsNav = getEl('nav-items');
                if (itemsNav) itemsNav.classList.add('active');
            }

            // Set header
            setProjectNameUI(proj.name);

            // Re-render after switching view
            updateProject(currentProject);

            // Apply filter after render tick
            requestAnimationFrame(() => {
                const filterInput = getEl('table-filter');
                if (filterInput) {
                    filterInput.value = drawingNo || '';
                    filterInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
            });
        };


        // --- NEW Quoting Process Logic (v2) ---

        // Planner state
        const plannerState = {
            selectedItems: new Set() // Set of { dn, supplier }
        };

        // Tab switching
        function initQuotingTabs() {
            if (window.__RFQ_TABS_BOUND__) return;
            window.__RFQ_TABS_BOUND__ = true;

            document.querySelectorAll('.rfq-tab').forEach(tab => {
                tab.onclick = () => {
                    const tabId = tab.dataset.tab;

                    // Update tab buttons
                    document.querySelectorAll('.rfq-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    // Update tab content
                    document.querySelectorAll('.rfq-tab-content').forEach(c => c.classList.add('hidden'));
                    const content = document.getElementById('tab-' + tabId);
                    if (content) content.classList.remove('hidden');

                    // Render tab content
                    if (tabId === 'price-comparison') {
                        renderItemComparison();
                    } else if (tabId === 'rfq-planner') {
                        renderRFQPlanner();
                    } else if (tabId === 'supplier-selection') {
                        renderSupplierSelection();
                    } else if (tabId === 'final-summary') {
                        renderFinalSummary();
                    } else if (tabId === 'old-quoting') {
                        renderOldQuotingView();
                    }
                };
            });
        }

        // RFQ Planner functions - NEW 2-column layout
        let plannerSelectedSupplier = null;

        // --- Planner helpers (safe + normalized) ---
        function _normSupKey(name) {
            return String(name || '').trim().toLowerCase();
        }

        function _supDisplayNameFromObj(s) {
            return String((s && (s.supplier_name || s.supplier || s.name)) || '').trim();
        }

        function _getItemSuppliers(item) {
            const arr = item && item.suppliers;
            return Array.isArray(arr) ? arr : [];
        }

        function _findSupplierOnItem(item, supplierName) {
            const key = _normSupKey(supplierName);
            const suppliers = _getItemSuppliers(item);
            return suppliers.find(s => _normSupKey(_supDisplayNameFromObj(s)) === key) || null;
        }

        function _getProjectSupplierNames(project) {
            const names = new Map(); // key -> display
            if (!project) return [];

            const add = (name) => {
                const disp = String(name || '').trim();
                if (!disp) return;
                const key = _normSupKey(disp);
                if (!names.has(key)) names.set(key, disp);
            };

            // From master lists
            (Array.isArray(project.supplierMaster) ? project.supplierMaster : []).forEach(s => add(s && (s.name || s.supplier_name || s.supplier)));
            (Array.isArray(project.suppliers) ? project.suppliers : []).forEach(s => add(s && (s.name || s.supplier_name || s.supplier)));

            // From supplierData dict
            const sd = project.supplierData || project.supplier_data;
            if (sd && typeof sd === 'object') {
                Object.keys(sd).forEach(k => add(k));
            }

            // From items suppliers
            (Array.isArray(project.items) ? project.items : []).forEach(item => {
                _getItemSuppliers(item).forEach(s => add(_supDisplayNameFromObj(s)));
            });

            return Array.from(names.values()).sort((a, b) => a.localeCompare(b));
        }

        function _getSupplierQuotePrice(supData) {
            const v = supData && (supData.price ?? supData.price_t1 ?? supData.price_1 ?? supData.unit_price ?? 0);
            const n = parseFloat(v);
            return isFinite(n) ? n : 0;
        }


        // Supplier workflow statuses (uses dynamic config)
        function getSupplierItemStatuses() {
            return typeof getPlannerStatuses === 'function' ? getPlannerStatuses() : ['Planned', 'RFQ Sent', 'Missing Info', 'Quoted', 'Done'];
        }
        // Keep legacy const for backward compatibility
        const SUPPLIER_ITEM_STATUSES = getSupplierItemStatuses();

        function bindPlannerEvents() {
            if (window.__RFQ_PLANNER_BOUND__) return;
            window.__RFQ_PLANNER_BOUND__ = true;

            // Supplier search
            const supSearch = document.getElementById('planner-supplier-search');
            if (supSearch) supSearch.oninput = () => renderPlannerSuppliersList();

            // Status filter radios
            document.querySelectorAll('input[name="planner-status-filter"]').forEach(radio => {
                radio.onchange = () => renderPlannerItemsForSupplier(plannerSelectedSupplier);
            });

            // Item search
            const itemSearch = document.getElementById('planner-items-search');
            if (itemSearch) itemSearch.oninput = () => renderPlannerItemsForSupplier(plannerSelectedSupplier);

            // Select All button
            const selectAllBtn = document.getElementById('btn-planner-select-all');
            if (selectAllBtn) {
                selectAllBtn.onclick = () => {
                    const checkboxes = document.querySelectorAll('#planner-items-tbody input[type="checkbox"].item-checkbox');
                    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                    checkboxes.forEach(cb => {
                        cb.checked = !allChecked;
                        const key = cb.dataset.idx + '|' + plannerSelectedSupplier;
                        if (cb.checked) {
                            plannerState.selectedItems.add(key);
                            cb.closest('tr')?.classList.add('selected');
                        } else {
                            plannerState.selectedItems.delete(key);
                            cb.closest('tr')?.classList.remove('selected');
                        }
                    });
                    updatePlannerFooter();
                };
            }

            // Enter Prices button
            const pricesBtn = document.getElementById('btn-planner-enter-prices');
            if (pricesBtn) pricesBtn.onclick = () => openRFQDetailModal(plannerSelectedSupplier);

            // Header bulk status change
            const headerBulkStatus = document.getElementById('planner-header-bulk-status');
            if (headerBulkStatus) {
                headerBulkStatus.onchange = () => {
                    const newStatus = headerBulkStatus.value;
                    if (!newStatus || plannerState.selectedItems.size === 0) return;
                    applyBulkStatusToSelected(newStatus);
                    headerBulkStatus.value = '';
                };
            }

            // Export Excel button (header)
            const exportExcelBtn = document.getElementById('btn-planner-export-excel');
            if (exportExcelBtn) exportExcelBtn.onclick = () => exportSelectedToExcel(true);

            // Export PDF button (header)
            const exportPdfBtn = document.getElementById('btn-planner-export-pdf');
            if (exportPdfBtn) exportPdfBtn.onclick = () => exportSelectedToPDF(true);

            // Add Supplier button
            const addSupplierBtn = document.getElementById('btn-add-supplier-to-project');
            if (addSupplierBtn) addSupplierBtn.onclick = () => openAddSupplierModal();

            // RFQ Detail Modal events
            const detailClose = document.getElementById('rfq-detail-close');
            const detailCancel = document.getElementById('rfq-detail-cancel');
            const detailSave = document.getElementById('rfq-detail-save');
            const detailSaveDraft = document.getElementById('rfq-detail-save-draft');
            const detailSaveQuote = document.getElementById('rfq-detail-save-quote');
            const detailSelectAll = document.getElementById('rfq-detail-select-all');

            if (detailClose) detailClose.onclick = () => closeRFQDetailModal();
            if (detailCancel) detailCancel.onclick = () => closeRFQDetailModal();
            if (detailSave) detailSave.onclick = () => saveRFQDetailPrices(false);
            if (detailSaveDraft) detailSaveDraft.onclick = () => saveRFQDetailPrices(true);
            if (detailSaveQuote) detailSaveQuote.onclick = () => saveRFQDetailPrices(false, true);
            if (detailSelectAll) {
                detailSelectAll.onchange = () => {
                    document.querySelectorAll('#rfq-detail-tbody input[type="checkbox"]').forEach(cb => {
                        cb.checked = detailSelectAll.checked;
                    });
                };
            }

            // Comment Modal events
            const commentClose = document.getElementById('planner-comment-close');
            const commentCancel = document.getElementById('planner-comment-cancel');
            const commentSave = document.getElementById('planner-comment-save');

            if (commentClose) commentClose.onclick = () => closePlannerCommentModal();
            if (commentCancel) commentCancel.onclick = () => closePlannerCommentModal();
            if (commentSave) commentSave.onclick = () => savePlannerComment();

            // Add Supplier Modal events
            const addSupClose = document.getElementById('add-supplier-close');
            const addSupCancel = document.getElementById('add-supplier-cancel');
            const addSupSave = document.getElementById('add-supplier-save');

            if (addSupClose) addSupClose.onclick = () => closeAddSupplierModal();
            if (addSupCancel) addSupCancel.onclick = () => closeAddSupplierModal();
            if (addSupSave) addSupSave.onclick = () => saveNewSupplier();
        }

        // Apply bulk status to selected items
        function applyBulkStatusToSelected(newStatus) {
            if (!currentProject || !plannerSelectedSupplier) return;

            const items = Array.isArray(currentProject.items) ? currentProject.items : [];
            const today = new Date().toISOString().split('T')[0];
            let updatedCount = 0;

            plannerState.selectedItems.forEach(key => {
                const [idxStr, supName] = key.split('|');
                if (_normSupKey(supName) !== _normSupKey(plannerSelectedSupplier)) return;

                const idx = parseInt(idxStr, 10);
                const item = items[idx];
                if (!item) return;

                let supData = _findSupplierOnItem(item, plannerSelectedSupplier);
                if (!supData) {
                    if (!item.suppliers) item.suppliers = [];
                    supData = { supplier_name: plannerSelectedSupplier, name: plannerSelectedSupplier };
                    item.suppliers.push(supData);
                }

                supData.status = newStatus;
                supData.status_updated = new Date().toISOString();

                // Set RFQ Sent Date when status changes to "RFQ Sent"
                if (newStatus === 'RFQ Sent') {
                    supData.rfq_sent_date = today;
                    supData.sent_date = today;
                    // Also update the item status to reflect RFQ Sent with count
                    updateItemRFQSentStatus(item);
                } else if (newStatus === 'Quoted' || newStatus === 'Quote Received') {
                    // Update item status when quote is received
                    updateItemQuoteStatus(item);
                } else if (newStatus === 'Done') {
                    // Set item status to Done
                    setItemStatus(item, 'Done');
                }

                updatedCount++;
            });

            if (updatedCount > 0) {
                if (window.RFQData && window.RFQData.updateProject) window.RFQData.updateProject(currentProject);
                else if (typeof updateProject === 'function') updateProject(currentProject);
                plannerState.selectedItems.clear();
                renderPlannerItemsForSupplier(plannerSelectedSupplier);
                // Also refresh items table if visible
                if (typeof renderCompactTable === 'function') {
                    try { renderCompactTable(); } catch (e) { }
                }
                showToast(`Updated ${updatedCount} items to "${newStatus}"`, 'success');
            }
        }

        // Comment Modal functions
        function openPlannerCommentModal() {
            if (plannerState.selectedItems.size === 0) {
                if (window.showToast) window.showToast('Please select at least one item', 'warning');
                return;
            }
            const modal = document.getElementById('planner-comment-modal');
            const subtitle = document.getElementById('planner-comment-subtitle');
            if (subtitle) subtitle.textContent = `For ${plannerState.selectedItems.size} selected items`;
            document.getElementById('planner-comment-text').value = '';
            document.getElementById('planner-comment-status').value = '';
            if (modal) modal.classList.remove('hidden');
        }

        function closePlannerCommentModal() {
            const modal = document.getElementById('planner-comment-modal');
            if (modal) modal.classList.add('hidden');
        }

        function savePlannerComment() {
            const commentText = document.getElementById('planner-comment-text')?.value?.trim() || '';
            const newStatus = document.getElementById('planner-comment-status')?.value || '';

            if (!commentText && !newStatus) {
                showToast('Please enter a comment or select a status', 'warning');
                return;
            }

            if (!currentProject || !plannerSelectedSupplier) return;

            let updatedCount = 0;
            const timestamp = new Date().toISOString();

            plannerState.selectedItems.forEach(key => {
                const [dn, supName] = key.split('|');
                if (_normSupKey(supName) !== _normSupKey(plannerSelectedSupplier)) return;

                const item = currentProject.items?.find(it => (it.item_drawing_no || it.drawing_no) === dn);
                if (!item) return;

                let supData = _findSupplierOnItem(item, plannerSelectedSupplier);
                if (!supData) {
                    if (!item.suppliers) item.suppliers = [];
                    supData = { supplier_name: plannerSelectedSupplier, name: plannerSelectedSupplier };
                    item.suppliers.push(supData);
                }

                // Add comment to history
                if (commentText) {
                    if (!supData.comments) supData.comments = [];
                    supData.comments.push({
                        text: commentText,
                        timestamp: timestamp,
                        author: 'User'
                    });
                    supData.last_comment = commentText;
                    supData.last_comment_date = timestamp;
                }

                // Update status
                if (newStatus) {
                    supData.status = newStatus;
                    supData.status_updated = timestamp;
                }

                updatedCount++;
            });

            if (updatedCount > 0) {
                if (window.RFQData && window.RFQData.updateProject) window.RFQData.updateProject(currentProject);
                plannerState.selectedItems.clear();
                closePlannerCommentModal();
                renderPlannerItemsForSupplier(plannerSelectedSupplier);
                showToast(`Added comment to ${updatedCount} items`, 'success');
            }
        }

        // Add Supplier Modal functions
        function openAddSupplierModal() {
            const modal = document.getElementById('add-supplier-modal');
            document.getElementById('add-supplier-name').value = '';
            document.getElementById('add-supplier-email').value = '';
            document.getElementById('add-supplier-contact').value = '';
            document.getElementById('add-supplier-assign').value = 'none';
            if (modal) modal.classList.remove('hidden');
        }

        function closeAddSupplierModal() {
            const modal = document.getElementById('add-supplier-modal');
            if (modal) modal.classList.add('hidden');
        }

        function saveNewSupplier() {
            const name = document.getElementById('add-supplier-name')?.value?.trim();
            const email = document.getElementById('add-supplier-email')?.value?.trim();
            const contact = document.getElementById('add-supplier-contact')?.value?.trim();
            const assignMode = document.getElementById('add-supplier-assign')?.value || 'none';

            if (!name) {
                showToast('Please enter a supplier name', 'warning');
                return;
            }

            if (!currentProject) return;

            // Add to supplier master
            if (!currentProject.supplierMaster) currentProject.supplierMaster = [];

            // Check if already exists
            const exists = currentProject.supplierMaster.some(s =>
                _normSupKey(s.name) === _normSupKey(name)
            );

            if (!exists) {
                currentProject.supplierMaster.push({
                    id: Date.now().toString(),
                    name: name,
                    email: email,
                    contact: contact,
                    status: 'Active',
                    created_at: new Date().toISOString()
                });
            }

            // Assign to items if requested
            if (assignMode !== 'none' && currentProject.items) {
                currentProject.items.forEach(item => {
                    const hasNoSupplier = !item.suppliers || item.suppliers.length === 0;

                    if (assignMode === 'all' || (assignMode === 'no-supplier' && hasNoSupplier)) {
                        if (!item.suppliers) item.suppliers = [];

                        // Check if this supplier is already on the item
                        const alreadyHas = item.suppliers.some(s =>
                            _normSupKey(_supDisplayNameFromObj(s)) === _normSupKey(name)
                        );

                        if (!alreadyHas) {
                            item.suppliers.push({
                                supplier_name: name,
                                name: name,
                                status: 'Planned',
                                email: email,
                                contact: contact,
                                created_at: new Date().toISOString()
                            });
                        }
                    }
                });
            }

            if (window.RFQData && window.RFQData.updateProject) window.RFQData.updateProject(currentProject);
            closeAddSupplierModal();
            renderPlannerSuppliersList();

            // Auto-select the new supplier
            plannerSelectedSupplier = name;
            const nameEl = document.getElementById('planner-supplier-name');
            if (nameEl) nameEl.textContent = name;
            renderPlannerItemsForSupplier(name);

            showToast(`Added supplier "${name}"`, 'success');
        }

        function renderRFQPlanner() {
            if (!currentProject) {
                const list = document.getElementById('planner-suppliers-list');
                if (list) list.innerHTML = '<div class="planner-empty-state"><div class="planner-empty-state-icon">üìÅ</div><div class="planner-empty-state-title">Select a Project</div></div>';
                return;
            }

            bindPlannerEvents();
            renderPlannerSuppliersList();

            // If no supplier selected, show empty state in tbody with default header
            if (!plannerSelectedSupplier) {
                const thead = document.getElementById('planner-items-thead');
                const tbody = document.getElementById('planner-items-tbody');

                if (thead) {
                    thead.innerHTML = `<tr>
                        <th style="width:36px;"><input type="checkbox" id="planner-select-all-items" disabled></th>
                        <th style="min-width:100px;">Drawing No</th>
                        <th style="min-width:120px;">Description</th>
                        <th style="min-width:90px;">Manufacturer</th>
                        <th style="min-width:90px;">MPN</th>
                        <th style="width:70px; text-align:center;">QTY 1</th>
                        <th style="width:80px; text-align:right;">Price 1</th>
                        <th style="width:80px; text-align:center;">Lead Time</th>
                        <th style="width:60px; text-align:center;">MOQ</th>
                        <th style="width:100px; text-align:center;">Status</th>
                        <th style="width:80px; text-align:center;">Actions</th>
                    </tr>`;
                }

                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="11" style="text-align: center; padding: 60px 20px;">
                                <div style="font-size: 48px; margin-bottom: 16px;">üëà</div>
                                <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px;">Select a Supplier</div>
                                <div style="color: #666; font-size: 13px;">Choose a supplier from the list on the left to see their assigned items</div>
                            </td>
                        </tr>
                    `;
                }
            } else {
                // Re-render items for the already-selected supplier (ensures fresh state)
                renderPlannerItemsForSupplier(plannerSelectedSupplier);
            }
        }


        function renderPlannerSuppliersList() {
            const container = document.getElementById('planner-suppliers-list');
            const countEl = document.getElementById('planner-suppliers-count');
            if (!container || !currentProject) return;

            const items = Array.isArray(currentProject.items) ? currentProject.items : [];
            const searchQ = (document.getElementById('planner-supplier-search')?.value || '').toLowerCase().trim();

            // Suppliers come from master lists, supplierData, and any suppliers already attached to items
            let supplierNames = _getProjectSupplierNames(currentProject);
            if (searchQ) supplierNames = supplierNames.filter(n => n.toLowerCase().includes(searchQ));

            if (countEl) countEl.textContent = String(supplierNames.length);

            if (supplierNames.length === 0) {
                container.innerHTML = `
                    <div class="planner-empty-state" style="padding: 30px 10px;">
                        <div class="planner-empty-state-title" style="font-size: 14px;">No suppliers found</div>
                        <p style="font-size: 12px;">Add suppliers in Project Suppliers / Supplier Master, or attach them to items</p>
                    </div>
                `;
                return;
            }

            // Build stats per supplier (count items assigned to this supplier and their status)
            const supplierStats = {}; // display -> { assigned, quoted, sent, missing, done }
            supplierNames.forEach(name => {
                supplierStats[name] = { assigned: 0, quoted: 0, sent: 0, missing: 0, done: 0, pending: 0 };
            });

            items.forEach(item => {
                supplierNames.forEach(name => {
                    const stats = supplierStats[name];
                    if (!stats) return;
                    const supData = _findSupplierOnItem(item, name);
                    if (supData) {
                        stats.assigned += 1;
                        const status = (supData.status || '').toLowerCase();
                        const price = _getSupplierQuotePrice(supData);

                        if (status.includes('done')) stats.done += 1;
                        else if (status.includes('quoted') || price > 0) stats.quoted += 1;
                        else if (status.includes('missing')) stats.missing += 1;
                        else if (status.includes('sent')) stats.sent += 1;
                        else stats.pending += 1;
                    }
                });
            });

            container.innerHTML = supplierNames.map(name => {
                const stats = supplierStats[name] || { assigned: 0, quoted: 0, sent: 0, missing: 0, done: 0, pending: 0 };
                const isActive = _normSupKey(plannerSelectedSupplier) === _normSupKey(name);
                const needsAction = stats.pending + stats.sent + stats.missing;
                return `
                    <div class="planner-supplier-card ${isActive ? 'active' : ''}" data-supplier="${escapeHtml(name)}">
                        <div class="planner-supplier-card-header">
                            <div class="planner-supplier-card-name">${escapeHtml(name)}</div>
                            <button class="planner-supplier-detail-btn" data-supplier="${escapeHtml(name)}" title="View Supplier Detail">i</button>
                        </div>
                        <div class="planner-supplier-card-stats">
                            <span>${stats.assigned} items</span>
                            ${stats.quoted > 0 ? `<span class="has-quote">${stats.quoted} quoted</span>` : ''}
                            ${stats.sent > 0 ? `<span style="color:#1565c0">${stats.sent} sent</span>` : ''}
                            ${stats.missing > 0 ? `<span class="needs-quote">${stats.missing} missing</span>` : ''}
                            ${stats.pending > 0 ? `<span style="color:#888">${stats.pending} pending</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            // Bind click on info button to open Supplier Detail
            container.querySelectorAll('.planner-supplier-detail-btn').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const supName = btn.dataset.supplier;
                    if (typeof window.openSupplierDetail === 'function') {
                        window.openSupplierDetail(supName);
                    }
                };
            });

            // Bind supplier selection
            container.querySelectorAll('.planner-supplier-card').forEach(card => {
                card.onclick = () => {
                    const supName = card.dataset.supplier;

                    // Clear selection when switching to a different supplier
                    if (_normSupKey(plannerSelectedSupplier) !== _normSupKey(supName)) {
                        plannerState.selectedItems.clear();
                    }

                    plannerSelectedSupplier = supName;

                    // Update active state
                    container.querySelectorAll('.planner-supplier-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');

                    // Update right panel header
                    const nameEl = document.getElementById('planner-supplier-name');
                    if (nameEl) nameEl.textContent = supName;

                    // Render items for this supplier
                    renderPlannerItemsForSupplier(supName);
                };
            });
        }



        // Helper to get status icon and class
        function _getStatusDisplay(status) {
            const statusMap = {
                'Planned': { icon: 'üìã', class: 'status-planned', label: 'Planned' },
                'RFQ Sent': { icon: 'üì§', class: 'status-sent', label: 'RFQ Sent' },
                'Missing Info': { icon: '‚ö†Ô∏è', class: 'status-missing', label: 'Missing Info' },
                'Quoted': { icon: 'üì•', class: 'status-quoted', label: 'Quoted' },
                'Done': { icon: '‚úÖ', class: 'status-done', label: 'Done' }
            };
            return statusMap[status] || { icon: 'üìã', class: 'status-planned', label: status || 'Planned' };
        }

        function renderPlannerItemsForSupplier(supplierName) {
            const container = document.getElementById('planner-items-list');
            const countEl = document.getElementById('planner-items-count');
            const footer = document.getElementById('planner-footer');
            const thead = document.getElementById('planner-items-thead');
            const tbody = document.getElementById('planner-items-tbody');

            if (!container || !currentProject || !supplierName || !thead || !tbody) return;

            const items = Array.isArray(currentProject.items) ? currentProject.items : [];

            // Get selected status filter
            const statusFilterEl = document.querySelector('input[name="planner-status-filter"]:checked');
            const statusFilter = statusFilterEl ? statusFilterEl.value : 'all';
            const searchQ = (document.getElementById('planner-items-search')?.value || '').toLowerCase().trim();

            // First pass: collect all items and find max QTY tiers
            let maxQtyTiers = 0;
            const supplierItems = [];

            items.forEach((item, itemIndex) => {
                const dn = item.item_drawing_no || item.drawing_no || '';
                const desc = item.description || '';

                // CRITICAL: Only show items where supplier is actually assigned
                const supData = _findSupplierOnItem(item, supplierName);
                if (!supData) return;

                // Search filter
                if (searchQ && !String(dn).toLowerCase().includes(searchQ) && !String(desc).toLowerCase().includes(searchQ)) {
                    return;
                }

                const status = (supData && supData.status) || 'Planned';

                // Status filter
                if (statusFilter !== 'all' && status !== statusFilter) return;

                // Get QTY tiers
                const qtyTiers = getItemQtyTiers(item, { includeBlanks: false });
                if (qtyTiers.length > maxQtyTiers) maxQtyTiers = qtyTiers.length;

                // Get prices for each tier
                const prices = [];
                const existingPrices = Array.isArray(supData.prices) ? supData.prices : [];

                qtyTiers.forEach((tier, i) => {
                    let price = '';
                    // Try to find price from prices array
                    const priceEntry = existingPrices.find(p => String(p.qty) === String(tier.value));
                    if (priceEntry) {
                        price = priceEntry.price;
                    } else {
                        // Try legacy price_1, price_2, etc.
                        price = supData['price_' + tier.index] || supData['price_' + (i + 1)] || '';
                    }
                    prices.push({ qty: tier.value, price: price, index: tier.index });
                });

                const hasQuote = prices.some(p => p.price && parseFloat(p.price) > 0);
                const comment = (supData && supData.last_comment) || '';
                const leadTime = (supData && (supData.lead_time || supData.leadTime)) || '';
                const moq = supData.moq || '';
                const currency = supData.currency || 'EUR';
                const manufacturer = item.manufacturer || '';
                const mpn = item.mpn || item.manufacturer_part_number || '';
                const unit = item.unit || 'pcs';

                supplierItems.push({
                    dn, desc, qtyTiers, prices, hasQuote, item, supData, status, comment, leadTime, moq, currency, manufacturer, mpn, unit, itemIndex
                });
            });

            // Ensure at least 1 QTY tier column
            if (maxQtyTiers === 0) maxQtyTiers = 1;

            if (countEl) countEl.textContent = supplierItems.length + ' items';

            // Enable/disable header action buttons
            const pricesBtn = document.getElementById('btn-planner-enter-prices');
            if (pricesBtn) pricesBtn.disabled = supplierItems.length === 0;

            // Update footer/header selection controls
            updatePlannerFooter();

            const currSettings = getCurrencySettings();
            const curr = currSettings?.baseCurrency || 'EUR';

            // Build dynamic header
            let headerHTML = `<tr>
                <th style="width:36px;"><input type="checkbox" id="planner-select-all-items"></th>
                <th style="min-width:100px;">Drawing No</th>
                <th style="min-width:100px;">Description</th>
                <th style="min-width:70px;">Manufacturer</th>
                <th style="min-width:70px;">MPN</th>
                <th style="width:45px;">Unit</th>
                <th style="width:70px; text-align:center;">Target</th>`;

            for (let i = 1; i <= maxQtyTiers; i++) {
                headerHTML += `<th style="width:60px; text-align:center;">QTY ${i}</th>`;
                headerHTML += `<th style="width:70px; text-align:right;">Price ${i}</th>`;
            }

            headerHTML += `
                <th style="width:70px; text-align:center;">Lead Time</th>
                <th style="width:55px; text-align:center;">MOQ</th>
                <th style="width:90px; text-align:center;">Status</th>
                <th style="width:60px; text-align:center;">Actions</th>
            </tr>`;

            thead.innerHTML = headerHTML;

            // Calculate total columns for empty state
            // checkbox, dn, desc, manufacturer, mpn, unit, target + qty/price pairs + leadtime, moq, status, actions
            const totalCols = 11 + (maxQtyTiers * 2);

            if (supplierItems.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${totalCols}" style="text-align: center; padding: 40px 20px;">
                            <div style="font-size: 32px; margin-bottom: 10px;">üìã</div>
                            <div style="font-weight: 600; margin-bottom: 8px;">No items found</div>
                            <div style="color: #666; font-size: 12px;">${statusFilter !== 'all' ? 'No items with status "' + statusFilter + '"' : 'This supplier has no assigned items'}</div>
                            <div style="color: #888; font-size: 11px; margin-top: 10px;">Tip: Assign this supplier to items in Item Detail</div>
                        </td>
                    </tr>
                `;
                updatePlannerFooter();
                return;
            }

            // Render rows
            tbody.innerHTML = supplierItems.map(it => {
                const key = it.itemIndex + '|' + supplierName;
                const isSelected = plannerState.selectedItems.has(key);
                const statusInfo = _getStatusDisplay(it.status);
                const displayDn = it.dn || `Item #${it.itemIndex + 1}`;

                // Target price info - always display in EUR
                const targetPrice = parseFloat(it.item.target_price) || 0;
                const targetCurrency = it.item.target_currency || 'EUR';
                const currRates = window.RFQData && window.RFQData.CURRENCY_RATES ? window.RFQData.CURRENCY_RATES : { EUR: 1, USD: 0.92, CZK: 0.041, GBP: 1.17 };
                const targetRate = currRates[targetCurrency] || 1;
                const targetEur = targetPrice * targetRate;
                let targetHtml = '-';
                if (targetPrice > 0) {
                    targetHtml = `<span style="font-size:11px; font-weight:500; color:#667eea;">${formatNumber(targetEur, 2)} ‚Ç¨</span>`;
                }

                const quoteNum = it.supData.quote_number || '';
                const quoteBadge = quoteNum
                    ? ` <span class="quote-badge" title="Quote: ${escapeHtml(quoteNum)}">Q#${escapeHtml(quoteNum.length > 12 ? quoteNum.substring(0, 12) + '‚Ä¶' : quoteNum)}</span>`
                    : '';

                let rowHTML = `<tr class="${isSelected ? 'selected' : ''}" data-idx="${it.itemIndex}" data-dn="${escapeHtml(it.dn)}">
                    <td><input type="checkbox" class="item-checkbox" data-idx="${it.itemIndex}" ${isSelected ? 'checked' : ''}></td>
                    <td>
                        <a href="#" class="planner-item-link" data-idx="${it.itemIndex}">${escapeHtml(displayDn)}</a>${quoteBadge}
                        ${it.comment ? ` <span title="${escapeHtml(it.comment)}" style="cursor:help;">üí¨</span>` : ''}
                    </td>
                    <td title="${escapeHtml(it.desc)}">${escapeHtml(it.desc.length > 25 ? it.desc.substring(0, 25) + '...' : it.desc)}</td>
                    <td>${escapeHtml(it.manufacturer || '-')}</td>
                    <td>${escapeHtml(it.mpn || '-')}</td>
                    <td>${escapeHtml(it.unit || 'pcs')}</td>
                    <td style="text-align:center;">${targetHtml}</td>`;

                // Add QTY and Price columns
                for (let i = 0; i < maxQtyTiers; i++) {
                    const tierData = it.prices[i] || { qty: '-', price: '' };
                    const priceVal = tierData.price ? (parseFloat(tierData.price) > 0 ? formatNumber(parseFloat(tierData.price), 2) : tierData.price) : '-';
                    const hasPrice = tierData.price && parseFloat(tierData.price) > 0;

                    rowHTML += `<td style="text-align: center; font-weight: 500;">${tierData.qty || '-'}</td>`;
                    rowHTML += `<td style="text-align: right; font-weight: ${hasPrice ? '600' : '400'}; color: ${hasPrice ? '#2e7d32' : '#999'};">${priceVal !== '-' ? priceVal + ' ' + it.currency : '-'}</td>`;
                }

                rowHTML += `
                    <td style="text-align: center;">${escapeHtml(it.leadTime || '-')}</td>
                    <td style="text-align: center;">${escapeHtml(it.moq || '-')}</td>
                    <td style="text-align: center;">
                        <span class="status-badge ${statusInfo.class}">${statusInfo.icon} ${statusInfo.label}</span>
                    </td>
                    <td style="text-align: center;">
                        <button class="btn-planner-edit" data-idx="${it.itemIndex}" style="background:#007AFF; color:white; border:none; padding:4px 10px; border-radius:4px; font-size:11px; cursor:pointer;">Edit</button>${quoteNum ? `<button class="btn-planner-view-quote" data-qn="${escapeHtml(quoteNum)}" title="View Quote ${escapeHtml(quoteNum)}">Q</button>` : ''}
                    </td>
                </tr>`;

                return rowHTML;
            }).join('');

            // Bind Q (view quote) buttons
            tbody.querySelectorAll('.btn-planner-view-quote').forEach(btn => {
                btn.onclick = () => {
                    const qn = btn.dataset.qn;
                    if (qn && typeof switchView === 'function') {
                        switchView('quotes');
                        // Set search filter to quote number after a brief delay for render
                        setTimeout(() => {
                            const searchInput = document.getElementById('quotes-search');
                            if (searchInput) {
                                searchInput.value = qn;
                                searchInput.dispatchEvent(new Event('input'));
                            }
                        }, 300);
                    }
                };
            });

            // Bind click on drawing number to open Item Detail
            tbody.querySelectorAll('.planner-item-link').forEach(link => {
                link.onclick = (e) => {
                    e.preventDefault();
                    const idx = parseInt(link.dataset.idx, 10);
                    if (idx >= 0 && typeof openItemDetail === 'function') {
                        openItemDetail(idx);
                    }
                };
            });

            // Bind Edit buttons
            tbody.querySelectorAll('.btn-planner-edit').forEach(btn => {
                btn.onclick = () => {
                    const idx = parseInt(btn.dataset.idx, 10);
                    openPlannerEditModalByIndex(idx, supplierName);
                };
            });

            // Bind checkboxes
            tbody.querySelectorAll('input[type="checkbox"].item-checkbox').forEach(cb => {
                cb.onchange = () => {
                    const idx = cb.dataset.idx;
                    const key = idx + '|' + supplierName;
                    if (cb.checked) {
                        plannerState.selectedItems.add(key);
                        cb.closest('tr')?.classList.add('selected');
                    } else {
                        plannerState.selectedItems.delete(key);
                        cb.closest('tr')?.classList.remove('selected');
                    }
                    updatePlannerFooter();
                };
            });

            // Bind select all checkbox
            const selectAllCb = document.getElementById('planner-select-all-items');
            if (selectAllCb) {
                selectAllCb.onchange = () => {
                    tbody.querySelectorAll('input[type="checkbox"].item-checkbox').forEach(cb => {
                        cb.checked = selectAllCb.checked;
                        const idx = cb.dataset.idx;
                        const key = idx + '|' + supplierName;
                        if (selectAllCb.checked) {
                            plannerState.selectedItems.add(key);
                            cb.closest('tr')?.classList.add('selected');
                        } else {
                            plannerState.selectedItems.delete(key);
                            cb.closest('tr')?.classList.remove('selected');
                        }
                    });
                    updatePlannerFooter();
                };
            }

            updatePlannerFooter();

            // Initialize resizable columns
            initResizableColumns(document.getElementById('planner-items-table'));
        }

        // Open edit modal for a specific item and supplier
        function openPlannerEditModal(dn, supplierName) {
            if (!currentProject) return;

            const items = Array.isArray(currentProject.items) ? currentProject.items : [];
            const item = items.find(it => (it.item_drawing_no || it.drawing_no) === dn);
            if (!item) {
                showToast('Item not found: ' + dn, 'warning');
                return;
            }

            const supData = _findSupplierOnItem(item, supplierName);
            if (!supData) {
                showToast('Supplier not found on this item', 'warning');
                return;
            }

            const qtyTiers = getItemQtyTiers(item, { includeBlanks: false });
            const existingPrices = Array.isArray(supData.prices) ? supData.prices : [];

            // Build price inputs for each QTY tier
            let priceInputsHTML = '';
            qtyTiers.forEach((tier, i) => {
                const priceEntry = existingPrices.find(p => String(p.qty) === String(tier.value));
                const price = priceEntry ? priceEntry.price : (supData['price_' + tier.index] || supData['price_' + (i + 1)] || '');

                priceInputsHTML += `
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <label style="width: 80px; font-weight: 600;">QTY ${tier.index}:</label>
                        <span style="width: 80px; color: #666;">${tier.value} pcs</span>
                        <input type="number" step="0.01" id="edit-price-${tier.index}" value="${price}" placeholder="Price" style="width: 120px; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                        <span>${supData.currency || 'EUR'}</span>
                    </div>
                `;
            });

            // Create modal HTML
            const modalHTML = `
                <div id="planner-edit-modal" class="rfq-modal-overlay" style="display: flex;">
                    <div class="rfq-modal-container" style="max-width: 600px; width: 90%;">
                        <div class="rfq-wizard-header">
                            <div>
                                <h3>Edit Supplier Data</h3>
                                <span class="muted">${escapeHtml(dn)} - ${escapeHtml(supplierName)}</span>
                            </div>
                            <button id="edit-modal-close" class="rfq-btn-close">&times;</button>
                        </div>
                        <div style="padding: 20px;">
                            <div style="margin-bottom: 20px;">
                                <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #333;">Pricing</h4>
                                ${priceInputsHTML || '<div style="color: #999;">No quantity tiers defined</div>'}
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 4px;">Lead Time</label>
                                    <input type="text" id="edit-lead-time" value="${escapeHtml(supData.lead_time || supData.leadTime || '')}" placeholder="e.g. 4-6 weeks" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 4px;">MOQ</label>
                                    <input type="text" id="edit-moq" value="${escapeHtml(supData.moq || '')}" placeholder="Min Order Qty" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 4px;">Currency</label>
                                    <select id="edit-currency" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="EUR" ${supData.currency === 'EUR' ? 'selected' : ''}>EUR</option>
                                        <option value="USD" ${supData.currency === 'USD' ? 'selected' : ''}>USD</option>
                                        <option value="CZK" ${supData.currency === 'CZK' ? 'selected' : ''}>CZK</option>
                                        <option value="GBP" ${supData.currency === 'GBP' ? 'selected' : ''}>GBP</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 4px;">Status</label>
                                    <select id="edit-status" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="Planned" ${supData.status === 'Planned' ? 'selected' : ''}>üìã Planned</option>
                                        <option value="RFQ Sent" ${supData.status === 'RFQ Sent' ? 'selected' : ''}>üì§ RFQ Sent</option>
                                        <option value="Missing Info" ${supData.status === 'Missing Info' ? 'selected' : ''}>‚ö†Ô∏è Missing Info</option>
                                        <option value="Quoted" ${supData.status === 'Quoted' ? 'selected' : ''}>üì• Quoted</option>
                                        <option value="Done" ${supData.status === 'Done' ? 'selected' : ''}>‚úÖ Done</option>
                                    </select>
                                </div>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-weight: 600; margin-bottom: 4px;">Comment</label>
                                <textarea id="edit-comment" rows="2" placeholder="Add a note..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;">${escapeHtml(supData.last_comment || '')}</textarea>
                            </div>
                        </div>
                        <div style="padding: 16px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px;">
                            <button id="edit-modal-cancel" class="rfq-btn-secondary">Cancel</button>
                            <button id="edit-modal-save" class="rfq-btn-primary">Save Changes</button>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('planner-edit-modal');
            if (existingModal) existingModal.remove();

            document.body.insertAdjacentHTML('beforeend', modalHTML);

            const modal = document.getElementById('planner-edit-modal');

            // Close handlers
            document.getElementById('edit-modal-close').onclick = () => modal.remove();
            document.getElementById('edit-modal-cancel').onclick = () => modal.remove();
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

            // Save handler
            document.getElementById('edit-modal-save').onclick = () => {
                // Update prices
                const newPrices = [];
                qtyTiers.forEach((tier, i) => {
                    const priceInput = document.getElementById('edit-price-' + tier.index);
                    if (priceInput && priceInput.value) {
                        newPrices.push({ qty: tier.value, price: priceInput.value });
                        supData['price_' + tier.index] = priceInput.value;
                    }
                });
                supData.prices = newPrices;

                // Update other fields
                supData.lead_time = document.getElementById('edit-lead-time').value;
                supData.leadTime = supData.lead_time;
                supData.moq = document.getElementById('edit-moq').value;
                supData.currency = document.getElementById('edit-currency').value;
                supData.status = document.getElementById('edit-status').value;
                supData.last_comment = document.getElementById('edit-comment').value;

                // Save and refresh
                if (window.RFQData && window.RFQData.updateProject) window.RFQData.updateProject(currentProject);

                // If item already linked to a quote, sync the update
                if (supData.quote_id) {
                    syncPlannerToQuotes(supplierName, supData.quote_number || '', supData.currency || 'EUR', '', '', '', '');
                }

                renderPlannerItemsForSupplier(supplierName);
                modal.remove();
            };
        }

        // Open edit modal by item index (more reliable than drawing number)
        function openPlannerEditModalByIndex(idx, supplierName) {
            if (!currentProject) return;

            const items = Array.isArray(currentProject.items) ? currentProject.items : [];
            const item = items[idx];
            if (!item) {
                showToast('Item not found at index: ' + idx, 'warning');
                return;
            }

            const dn = item.item_drawing_no || item.drawing_no || `Item #${idx + 1}`;
            const supData = _findSupplierOnItem(item, supplierName);
            if (!supData) {
                showToast('Supplier not found on this item', 'warning');
                return;
            }

            const qtyTiers = getItemQtyTiers(item, { includeBlanks: false });
            const existingPrices = Array.isArray(supData.prices) ? supData.prices : [];

            // Build price inputs for each QTY tier
            let priceInputsHTML = '';
            qtyTiers.forEach((tier, i) => {
                const priceEntry = existingPrices.find(p => String(p.qty) === String(tier.value));
                const price = priceEntry ? priceEntry.price : (supData['price_' + tier.index] || supData['price_' + (i + 1)] || '');

                priceInputsHTML += `
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <label style="width: 80px; font-weight: 600;">QTY ${tier.index}:</label>
                        <span style="width: 80px; color: #666;">${tier.value} pcs</span>
                        <input type="number" step="0.01" id="edit-price-${tier.index}" value="${price}" placeholder="Price" style="width: 120px; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                        <span>${supData.currency || 'EUR'}</span>
                    </div>
                `;
            });

            // Create modal HTML
            const modalHTML = `
                <div id="planner-edit-modal" class="rfq-modal-overlay" style="display: flex;">
                    <div class="rfq-modal-container" style="max-width: 600px; width: 90%;">
                        <div class="rfq-wizard-header">
                            <div>
                                <h3>Edit Supplier Data</h3>
                                <span class="muted">${escapeHtml(dn)} - ${escapeHtml(supplierName)}</span>
                            </div>
                            <button id="edit-modal-close" class="rfq-btn-close">&times;</button>
                        </div>
                        <div style="padding: 20px;">
                            <div style="margin-bottom: 20px;">
                                <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #333;">Pricing</h4>
                                ${priceInputsHTML || '<div style="color: #999;">No quantity tiers defined</div>'}
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 4px;">Lead Time</label>
                                    <input type="text" id="edit-lead-time" value="${escapeHtml(supData.lead_time || supData.leadTime || '')}" placeholder="e.g. 4-6 weeks" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 4px;">MOQ</label>
                                    <input type="text" id="edit-moq" value="${escapeHtml(supData.moq || '')}" placeholder="Min Order Qty" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 4px;">Currency</label>
                                    <select id="edit-currency" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="EUR" ${supData.currency === 'EUR' ? 'selected' : ''}>EUR</option>
                                        <option value="USD" ${supData.currency === 'USD' ? 'selected' : ''}>USD</option>
                                        <option value="CZK" ${supData.currency === 'CZK' ? 'selected' : ''}>CZK</option>
                                        <option value="GBP" ${supData.currency === 'GBP' ? 'selected' : ''}>GBP</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 4px;">Status</label>
                                    <select id="edit-status" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="Planned" ${supData.status === 'Planned' ? 'selected' : ''}>üìã Planned</option>
                                        <option value="RFQ Sent" ${supData.status === 'RFQ Sent' ? 'selected' : ''}>üì§ RFQ Sent</option>
                                        <option value="Missing Info" ${supData.status === 'Missing Info' ? 'selected' : ''}>‚ö†Ô∏è Missing Info</option>
                                        <option value="Quoted" ${supData.status === 'Quoted' ? 'selected' : ''}>üì• Quoted</option>
                                        <option value="Done" ${supData.status === 'Done' ? 'selected' : ''}>‚úÖ Done</option>
                                    </select>
                                </div>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-weight: 600; margin-bottom: 4px;">Comment</label>
                                <textarea id="edit-comment" rows="2" placeholder="Add a note..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;">${escapeHtml(supData.last_comment || '')}</textarea>
                            </div>
                        </div>
                        <div style="padding: 16px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px;">
                            <button id="edit-modal-cancel" class="rfq-btn-secondary">Cancel</button>
                            <button id="edit-modal-save" class="rfq-btn-primary">Save Changes</button>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('planner-edit-modal');
            if (existingModal) existingModal.remove();

            document.body.insertAdjacentHTML('beforeend', modalHTML);

            const modal = document.getElementById('planner-edit-modal');

            // Close handlers
            document.getElementById('edit-modal-close').onclick = () => modal.remove();
            document.getElementById('edit-modal-cancel').onclick = () => modal.remove();
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

            // Save handler
            document.getElementById('edit-modal-save').onclick = () => {
                // Update prices
                const newPrices = [];
                qtyTiers.forEach((tier, i) => {
                    const priceInput = document.getElementById('edit-price-' + tier.index);
                    if (priceInput && priceInput.value) {
                        newPrices.push({ qty: tier.value, price: priceInput.value });
                        supData['price_' + tier.index] = priceInput.value;
                    }
                });
                supData.prices = newPrices;

                // Update other fields
                supData.lead_time = document.getElementById('edit-lead-time').value;
                supData.leadTime = supData.lead_time;
                supData.moq = document.getElementById('edit-moq').value;
                supData.currency = document.getElementById('edit-currency').value;
                supData.status = document.getElementById('edit-status').value;
                supData.last_comment = document.getElementById('edit-comment').value;

                // Save and refresh
                if (window.RFQData && window.RFQData.updateProject) window.RFQData.updateProject(currentProject);

                // If item already linked to a quote, sync the update
                if (supData.quote_id) {
                    syncPlannerToQuotes(supplierName, supData.quote_number || '', supData.currency || 'EUR', '', '', '', '');
                }

                renderPlannerItemsForSupplier(supplierName);
                modal.remove();
            };
        }

        function updatePlannerFooter() {
            const selectedCount = document.getElementById('planner-selected-count');
            const bulkStatus = document.getElementById('planner-header-bulk-status');
            const exportExcelBtn = document.getElementById('btn-planner-export-excel');
            const exportPdfBtn = document.getElementById('btn-planner-export-pdf');
            const count = plannerState.selectedItems.size;

            if (selectedCount) {
                selectedCount.textContent = count > 0 ? count + ' selected' : '0 selected';
                selectedCount.style.color = count > 0 ? '#007AFF' : '#999';
            }
            if (bulkStatus) bulkStatus.disabled = count === 0;
            if (exportExcelBtn) exportExcelBtn.disabled = count === 0;
            if (exportPdfBtn) exportPdfBtn.disabled = count === 0;
        }

        // Initialize resizable columns
        function initResizableColumns(table) {
            if (!table) return;
            const headers = table.querySelectorAll('thead th');
            headers.forEach(th => {
                // Remove existing handle if any
                const existing = th.querySelector('.col-resize-handle');
                if (existing) existing.remove();

                const handle = document.createElement('div');
                handle.className = 'col-resize-handle';
                th.appendChild(handle);

                let startX, startWidth;

                handle.onmousedown = (e) => {
                    e.preventDefault();
                    startX = e.pageX;
                    startWidth = th.offsetWidth;
                    table.classList.add('resizing');
                    handle.classList.add('resizing');

                    const onMouseMove = (e) => {
                        const diff = e.pageX - startX;
                        th.style.width = (startWidth + diff) + 'px';
                        th.style.minWidth = (startWidth + diff) + 'px';
                    };

                    const onMouseUp = () => {
                        table.classList.remove('resizing');
                        handle.classList.remove('resizing');
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    };

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                };
            });
        }

        // Export RFQ to Excel (all items for supplier)
        function exportRFQExcel() {
            if (!plannerSelectedSupplier || !currentProject) {
                if (window.showToast) window.showToast('Please select a supplier first', 'warning');
                return;
            }

            const items = Array.isArray(currentProject.items) ? currentProject.items : [];
            const supplierItems = [];

            items.forEach(item => {
                const dn = item.item_drawing_no || item.drawing_no || '';
                const desc = item.description || '';
                const unit = item.unit || 'pcs';

                // Only export items where supplier is assigned
                const supData = _findSupplierOnItem(item, plannerSelectedSupplier);
                if (!supData) return;

                // Get all quantity tiers
                const qtyTiers = getItemQtyTiers(item, { includeBlanks: false });

                supplierItems.push({ dn, desc, unit, qtyTiers, item, supData });
            });

            if (supplierItems.length === 0) {
                if (window.showToast) window.showToast('No items to export', 'warning');
                return;
            }

            _exportItemsToExcel(supplierItems, plannerSelectedSupplier, 'RFQ');
        }

        // Export selected items to Excel
        function exportSelectedToExcel(changeStatusToSent = false) {
            if (!plannerSelectedSupplier || !currentProject) {
                if (window.showToast) window.showToast('Please select a supplier first', 'warning');
                return;
            }

            // Check for stale selections: if Set has entries but none match current supplier, clear them
            if (plannerState.selectedItems.size > 0) {
                const supSuffix = '|' + plannerSelectedSupplier;
                const hasCurrentSupplier = Array.from(plannerState.selectedItems).some(k => k.endsWith(supSuffix));
                if (!hasCurrentSupplier) {
                    plannerState.selectedItems.clear();
                    updatePlannerFooter();
                }
            }

            if (plannerState.selectedItems.size === 0) {
                if (window.showToast) window.showToast('No items selected', 'warning');
                return;
            }

            const items = Array.isArray(currentProject.items) ? currentProject.items : [];
            const supplierItems = [];

            items.forEach((item, idx) => {
                const key = idx + '|' + plannerSelectedSupplier;

                // Only export selected items
                if (!plannerState.selectedItems.has(key)) return;

                const dn = item.item_drawing_no || item.drawing_no || `Item #${idx + 1}`;
                const desc = item.description || '';
                const unit = item.unit || 'pcs';
                const manufacturer = item.manufacturer || '';
                const mpn = item.mpn || item.manufacturer_part_number || '';
                const supData = _findSupplierOnItem(item, plannerSelectedSupplier);
                if (!supData) return;

                const qtyTiers = getItemQtyTiers(item, { includeBlanks: false });
                supplierItems.push({ dn, desc, unit, manufacturer, mpn, qtyTiers, item, supData });
            });

            if (supplierItems.length === 0) {
                if (window.showToast) window.showToast('No items to export', 'warning');
                return;
            }

            _exportItemsToExcel(supplierItems, plannerSelectedSupplier, 'RFQ');

            // Change status to RFQ Sent after export
            if (changeStatusToSent) {
                applyBulkStatusToSelected('RFQ Sent');
            }
        }

        // Export selected items to PDF
        function exportSelectedToPDF(changeStatusToSent = false) {
            if (!plannerSelectedSupplier || !currentProject) {
                if (window.showToast) window.showToast('Please select a supplier first', 'warning');
                return;
            }

            // Check for stale selections: if Set has entries but none match current supplier, clear them
            if (plannerState.selectedItems.size > 0) {
                const supSuffix = '|' + plannerSelectedSupplier;
                const hasCurrentSupplier = Array.from(plannerState.selectedItems).some(k => k.endsWith(supSuffix));
                if (!hasCurrentSupplier) {
                    plannerState.selectedItems.clear();
                    updatePlannerFooter();
                }
            }

            if (plannerState.selectedItems.size === 0) {
                if (window.showToast) window.showToast('No items selected', 'warning');
                return;
            }

            const items = Array.isArray(currentProject.items) ? currentProject.items : [];
            const supplierItems = [];

            items.forEach((item, idx) => {
                const key = idx + '|' + plannerSelectedSupplier;

                // Only export selected items
                if (!plannerState.selectedItems.has(key)) return;

                const dn = item.item_drawing_no || item.drawing_no || `Item #${idx + 1}`;
                const desc = item.description || '';
                const unit = item.unit || 'pcs';
                const manufacturer = item.manufacturer || '';
                const mpn = item.mpn || item.manufacturer_part_number || '';
                const supData = _findSupplierOnItem(item, plannerSelectedSupplier);
                if (!supData) return;

                const qtyTiers = getItemQtyTiers(item, { includeBlanks: false });
                supplierItems.push({ dn, desc, unit, manufacturer, mpn, qtyTiers, item, supData });
            });

            if (supplierItems.length === 0) {
                if (window.showToast) window.showToast('No items to export', 'warning');
                return;
            }

            _exportItemsToPDF(supplierItems, plannerSelectedSupplier);

            // Change status to RFQ Sent after export
            if (changeStatusToSent) {
                applyBulkStatusToSelected('RFQ Sent');
            }
        }

        // Internal function to create and download Excel file
        function _exportItemsToExcel(supplierItems, supplierName, prefix) {
            if (typeof XLSX === 'undefined') {
                if (window.showToast) window.showToast('Excel library not loaded. Please refresh the page.', 'error');
                return;
            }

            const projectName = currentProject.name || 'Project';
            const date = new Date().toISOString().split('T')[0];

            // Find max qty tiers
            let maxQtyTiers = 0;
            supplierItems.forEach(item => {
                if (item.qtyTiers.length > maxQtyTiers) maxQtyTiers = item.qtyTiers.length;
            });
            if (maxQtyTiers === 0) maxQtyTiers = 1;

            // Build header row
            const headerRow = ['No.', 'Drawing No', 'Description', 'Manufacturer', 'MPN', 'Unit'];
            for (let i = 1; i <= maxQtyTiers; i++) {
                headerRow.push('QTY ' + i);
                headerRow.push('Unit Price ' + i);
            }
            headerRow.push('Lead Time', 'MOQ', 'Notes');

            // Build data rows
            const dataRows = [
                ['Request for Quotation'],
                ['Supplier:', supplierName],
                ['Project:', projectName],
                ['Date:', date],
                [''],
                headerRow
            ];

            supplierItems.forEach((item, idx) => {
                const row = [
                    idx + 1,
                    item.dn || '',
                    item.desc || '',
                    item.manufacturer || '',
                    item.mpn || '',
                    item.unit || 'pcs'
                ];

                // Add QTY and Price columns
                for (let i = 0; i < maxQtyTiers; i++) {
                    const tier = item.qtyTiers[i];
                    row.push(tier ? tier.value : '');
                    row.push(''); // Empty price cell for supplier to fill
                }

                row.push('', '', ''); // Lead Time, MOQ, Notes
                dataRows.push(row);
            });

            // Create workbook
            const ws = XLSX.utils.aoa_to_sheet(dataRows);

            // Set column widths
            const colWidths = [
                { wch: 5 },  // No.
                { wch: 18 }, // Drawing No
                { wch: 35 }, // Description
                { wch: 15 }, // Manufacturer
                { wch: 15 }, // MPN
                { wch: 6 }   // Unit
            ];
            for (let i = 0; i < maxQtyTiers; i++) {
                colWidths.push({ wch: 10 }); // QTY
                colWidths.push({ wch: 12 }); // Price
            }
            colWidths.push({ wch: 12 }, { wch: 8 }, { wch: 20 }); // Lead Time, MOQ, Notes
            ws['!cols'] = colWidths;

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'RFQ');

            // Download
            const filename = prefix + '_' + supplierName.replace(/[^a-zA-Z0-9]/g, '_') + '_' + date + '.xlsx';
            XLSX.writeFile(wb, filename);

            showToast('Excel file exported: ' + filename, 'success');
        }

        // Internal function to create and download PDF file
        function _exportItemsToPDF(supplierItems, supplierName) {
            const projectName = currentProject.name || 'Project';
            const date = new Date().toLocaleDateString('cs-CZ');

            // Find max qty tiers
            let maxQtyTiers = 0;
            supplierItems.forEach(item => {
                if (item.qtyTiers.length > maxQtyTiers) maxQtyTiers = item.qtyTiers.length;
            });
            if (maxQtyTiers === 0) maxQtyTiers = 1;

            // Build QTY headers
            let qtyHeaders = '';
            for (let i = 1; i <= maxQtyTiers; i++) {
                qtyHeaders += `<th style="padding: 8px; border: 1px solid #ddd; text-align: center; background: #f5f5f5;">QTY ${i}</th>
                              <th style="padding: 8px; border: 1px solid #ddd; text-align: right; background: #f5f5f5;">Price ${i}</th>`;
            }

            // Build table rows
            let tableRows = '';
            supplierItems.forEach((item, idx) => {
                let qtyCells = '';
                for (let i = 0; i < maxQtyTiers; i++) {
                    const tier = item.qtyTiers[i];
                    qtyCells += `<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${tier ? tier.value : ''}</td>
                                <td style="padding: 8px; border: 1px solid #ddd; text-align: right;"></td>`;
                }
                tableRows += `
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${idx + 1}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(item.dn)}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(item.desc)}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(item.manufacturer || '-')}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(item.mpn || '-')}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${escapeHtml(item.unit)}</td>
                        ${qtyCells}
                        <td style="padding: 8px; border: 1px solid #ddd;"></td>
                        <td style="padding: 8px; border: 1px solid #ddd;"></td>
                        <td style="padding: 8px; border: 1px solid #ddd;"></td>
                    </tr>
                `;
            });

            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>RFQ - ${escapeHtml(supplierName)}</title>
                    <style>
                        @page { size: A4 landscape; margin: 15mm; }
                        body { font-family: Arial, sans-serif; font-size: 11px; line-height: 1.4; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .header h1 { font-size: 24px; margin: 0 0 5px 0; color: #333; }
                        .header h2 { font-size: 16px; margin: 0; color: #666; font-weight: normal; }
                        .info-box { display: flex; justify-content: space-between; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
                        .info-item { }
                        .info-label { font-weight: bold; color: #666; font-size: 10px; text-transform: uppercase; }
                        .info-value { font-size: 14px; color: #333; margin-top: 2px; }
                        table { width: 100%; border-collapse: collapse; font-size: 10px; }
                        th { background: #007AFF; color: white; padding: 10px 8px; text-align: left; border: 1px solid #0066cc; }
                        td { padding: 8px; border: 1px solid #ddd; }
                        tr:nth-child(even) { background: #fafafa; }
                        .footer { margin-top: 30px; padding-top: 15px; border-top: 1px solid #ddd; font-size: 10px; color: #666; }
                        .signature { margin-top: 40px; display: flex; justify-content: space-between; }
                        .signature-box { width: 200px; text-align: center; }
                        .signature-line { border-top: 1px solid #333; margin-top: 40px; padding-top: 5px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>REQUEST FOR QUOTATION</h1>
                        <h2>${escapeHtml(projectName)}</h2>
                    </div>

                    <div class="info-box">
                        <div class="info-item">
                            <div class="info-label">Supplier</div>
                            <div class="info-value">${escapeHtml(supplierName)}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Date</div>
                            <div class="info-value">${date}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Items</div>
                            <div class="info-value">${supplierItems.length}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Valid Until</div>
                            <div class="info-value">_____________</div>
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th style="width: 30px; text-align: center;">#</th>
                                <th style="width: 100px;">Drawing No</th>
                                <th>Description</th>
                                <th style="width: 80px;">Manufacturer</th>
                                <th style="width: 80px;">MPN</th>
                                <th style="width: 40px; text-align: center;">Unit</th>
                                ${qtyHeaders.replace(/background: #f5f5f5/g, 'background: #007AFF; color: white')}
                                <th style="width: 60px;">Lead Time</th>
                                <th style="width: 50px;">MOQ</th>
                                <th style="width: 80px;">Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>

                    <div class="footer">
                        <p><strong>Terms & Conditions:</strong> Please provide unit prices for the quantities specified. Quote validity should be minimum 30 days.</p>
                        <p><strong>Delivery:</strong> Please specify lead time and delivery terms (Incoterms).</p>
                    </div>

                    <div class="signature">
                        <div class="signature-box">
                            <div class="signature-line">Supplier Signature</div>
                        </div>
                        <div class="signature-box">
                            <div class="signature-line">Date</div>
                        </div>
                    </div>
                </body>
                </html>
            `;

            // Open print dialog
            const printWindow = window.open('', '_blank');
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
            }, 500);

            showToast('PDF ready for printing/saving', 'success');
        }



        // RFQ Detail Modal for entering prices
        function openRFQDetailModal(supplierName) {
            if (!supplierName || !currentProject) {
                if (window.showToast) window.showToast('Please select a supplier first', 'warning');
                return;
            }

            const modal = document.getElementById('rfq-detail-modal');
            const subtitle = document.getElementById('rfq-detail-subtitle');
            const table = document.getElementById('rfq-detail-table');

            if (!modal || !table) return;

            if (subtitle) subtitle.textContent = 'Supplier: ' + supplierName;

            // Initialize all form fields
            const today = new Date().toISOString().split('T')[0];
            const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ''; };

            // RFQ Tracking fields
            setVal('rfq-detail-sent-date', '');
            setVal('rfq-detail-received-date', '');
            setVal('rfq-detail-date', today);
            setVal('rfq-detail-valid', '');
            setVal('rfq-detail-quote-status', 'Active');
            setVal('rfq-detail-quote-number', '');

            // Pricing & Terms fields
            setVal('rfq-detail-currency', 'EUR');
            setVal('rfq-detail-incoterms', '');
            setVal('rfq-detail-lead-time', '');
            setVal('rfq-detail-shipping', '');
            setVal('rfq-detail-moq', '');
            setVal('rfq-detail-mov', '');

            // Bulk actions
            setVal('rfq-detail-bulk-status', '');
            setVal('rfq-detail-global-comment', '');

            // Setup section toggle handlers
            modal.querySelectorAll('.rfq-detail-section-header').forEach(header => {
                header.onclick = () => {
                    const section = header.closest('.rfq-detail-section');
                    if (section) section.classList.toggle('collapsed');
                };
            });

            const items = Array.isArray(currentProject.items) ? currentProject.items : [];
            const supplierItems = [];

            // First pass: collect items assigned to this supplier
            items.forEach((item, itemIndex) => {
                const dn = item.item_drawing_no || item.drawing_no || '';
                const desc = item.description || '';

                // Only show items where supplier is assigned
                const supData = _findSupplierOnItem(item, supplierName);
                if (!supData) return;

                // If items are selected, filter to those (use idx|supplier key format)
                if (plannerState.selectedItems.size > 0) {
                    const key = itemIndex + '|' + supplierName;
                    if (!plannerState.selectedItems.has(key)) return;
                }

                // Get quantity tiers for this item
                const qtyTiers = getItemQtyTiers(item, { includeBlanks: false });

                // Get existing prices from supplier data
                const existingPrices = Array.isArray(supData.prices) ? supData.prices : [];
                const getPriceForQty = (qty, tierIdx) => {
                    // Try by qty value first
                    const found = existingPrices.find(p => Number(p.qty) === Number(qty));
                    if (found && found.price) return found.price;
                    // Fallback to price_1, price_2, etc.
                    return getSupplierPriceByIndex(supData, tierIdx) || '';
                };

                const leadTime = (supData.lead_time || supData.leadTime) || '';
                const moq = (supData.moq || supData.MOQ) || '';
                const status = supData.status || 'Planned';
                const comment = supData.last_comment || '';

                supplierItems.push({
                    dn, desc, qtyTiers, getPriceForQty, leadTime, moq, status, comment, item, supData
                });
            });

            if (supplierItems.length === 0) {
                showToast('No items assigned to this supplier. Assign items first in Item Detail ‚Üí Sourcing Strategy.', 'warning');
                return;
            }

            // Collect all unique qty tier indices across all items
            const allTierIndices = new Set();
            supplierItems.forEach(it => {
                it.qtyTiers.forEach(t => allTierIndices.add(t.index));
            });
            const sortedTierIndices = Array.from(allTierIndices).sort((a, b) => a - b);

            // Store tier info for save function
            modal.dataset.tierIndices = JSON.stringify(sortedTierIndices);

            // Build dynamic table header
            const thead = table.querySelector('thead');
            if (thead) {
                let headerHtml = `
                    <tr>
                        <th style="width: 36px;"><input type="checkbox" id="rfq-detail-select-all" checked></th>
                        <th style="width: 120px;">Drawing No</th>
                        <th>Description</th>`;

                // Add qty/price columns for each tier
                sortedTierIndices.forEach(tierIdx => {
                    headerHtml += `
                        <th style="width: 65px;">Qty ${tierIdx}</th>
                        <th style="width: 85px;">Price ${tierIdx}</th>`;
                });

                headerHtml += `
                        <th style="width: 70px;">Lead Time</th>
                        <th style="width: 60px;">MOQ</th>
                        <th style="width: 100px;">Status</th>
                        <th style="width: 140px;">Comment</th>
                    </tr>`;
                thead.innerHTML = headerHtml;
            }

            // Update tfoot colspan
            const tfoot = table.querySelector('tfoot');
            if (tfoot) {
                const colSpan = 3 + (sortedTierIndices.length * 2);
                tfoot.innerHTML = `
                    <tr>
                        <td colspan="${colSpan}" style="text-align: right; font-weight: 700;">Grand Total:</td>
                        <td id="rfq-detail-total" style="font-weight: 700;" colspan="4">0.00</td>
                    </tr>`;
            }

            // Build tbody
            const tbody = table.querySelector('tbody') || document.getElementById('rfq-detail-tbody');
            if (!tbody) return;

            tbody.innerHTML = supplierItems.map((it, idx) => {
                let rowHtml = `
                    <tr data-dn="${escapeHtml(it.dn)}" data-idx="${idx}">
                        <td><input type="checkbox" checked></td>
                        <td class="cell-dn">${escapeHtml(it.dn)}</td>
                        <td class="cell-desc" title="${escapeHtml(it.desc)}">${escapeHtml(it.desc.substring(0, 35))}${it.desc.length > 35 ? '...' : ''}</td>`;

                // Add qty/price cells for each tier
                sortedTierIndices.forEach(tierIdx => {
                    const tierData = it.qtyTiers.find(t => t.index === tierIdx);
                    const qtyVal = tierData ? tierData.value : '';
                    const priceVal = tierData ? it.getPriceForQty(tierData.value, tierIdx) : '';

                    rowHtml += `
                        <td class="cell-qty" style="text-align: center; background: #f8f9fa;">${qtyVal || '-'}</td>
                        <td>
                            <input type="number" class="price-input rfq-input-sm"
                                   value="${priceVal}" step="0.0001" min="0"
                                   data-qty="${qtyVal}" data-tier="${tierIdx}"
                                   placeholder="0.00" ${!qtyVal ? 'disabled style="background:#eee;"' : ''}>
                        </td>`;
                });

                rowHtml += `
                        <td><input type="text" class="leadtime-input rfq-input-sm" value="${escapeHtml(it.leadTime)}" placeholder="4w"></td>
                        <td><input type="number" class="moq-input rfq-input-sm" value="${it.moq || ''}" min="0" placeholder="0"></td>
                        <td>
                            <select class="status-input rfq-input-sm">
                                <option value="Planned" ${it.status === 'Planned' ? 'selected' : ''}>üìã Planned</option>
                                <option value="RFQ Sent" ${it.status === 'RFQ Sent' ? 'selected' : ''}>üì§ Sent</option>
                                <option value="Missing Info" ${it.status === 'Missing Info' ? 'selected' : ''}>‚ö†Ô∏è Missing</option>
                                <option value="Quoted" ${it.status === 'Quoted' ? 'selected' : ''}>üì• Quoted</option>
                                <option value="Done" ${it.status === 'Done' ? 'selected' : ''}>‚úÖ Done</option>
                            </select>
                        </td>
                        <td><input type="text" class="comment-input rfq-input-sm" value="${escapeHtml(it.comment)}" placeholder="Comment..."></td>
                    </tr>`;

                return rowHtml;
            }).join('');

            // Bind select all checkbox
            const selectAllCb = table.querySelector('#rfq-detail-select-all');
            if (selectAllCb) {
                selectAllCb.onchange = () => {
                    tbody.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                        cb.checked = selectAllCb.checked;
                    });
                    updateRFQDetailTotal();
                };
            }

            // Bind price input events
            tbody.querySelectorAll('.price-input').forEach(input => {
                input.oninput = () => {
                    const price = parseFloat(input.value) || 0;
                    // Auto-set status to Quoted if price entered
                    if (price > 0) {
                        const row = input.closest('tr');
                        const statusSel = row.querySelector('.status-input');
                        if (statusSel && (statusSel.value === 'Planned' || statusSel.value === 'RFQ Sent')) {
                            statusSel.value = 'Quoted';
                        }
                    }
                    updateRFQDetailTotal();
                };
            });

            updateRFQDetailTotal();
            modal.dataset.supplier = supplierName;
            modal.classList.remove('hidden');
        }


        function updateRFQDetailTotal() {
            const table = document.getElementById('rfq-detail-table');
            const tbody = table ? table.querySelector('tbody') : document.getElementById('rfq-detail-tbody');
            const totalEl = document.getElementById('rfq-detail-total');
            if (!tbody || !totalEl) return;

            let grandTotal = 0;
            tbody.querySelectorAll('tr').forEach(row => {
                const checkbox = row.querySelector('input[type="checkbox"]');
                if (!checkbox?.checked) return;

                // Sum all price inputs in this row (one per qty tier)
                row.querySelectorAll('.price-input').forEach(priceInput => {
                    const qty = parseFloat(priceInput.dataset.qty) || 0;
                    const price = parseFloat(priceInput.value) || 0;
                    grandTotal += price * qty;
                });
            });

            const currSettings = getCurrencySettings();
            totalEl.textContent = formatNumber(grandTotal, currSettings?.decimals || 2) + ' ' + (currSettings?.baseCurrency || 'EUR');
        }

        function closeRFQDetailModal() {
            const modal = document.getElementById('rfq-detail-modal');
            if (modal) modal.classList.add('hidden');
        }

        function saveRFQDetailPrices(isDraft = false, alsoSyncQuote = false) {
            const modal = document.getElementById('rfq-detail-modal');
            const table = document.getElementById('rfq-detail-table');
            const tbody = table ? table.querySelector('tbody') : document.getElementById('rfq-detail-tbody');
            if (!modal || !tbody || !currentProject) return;

            const supplierName = modal.dataset.supplier;
            if (!supplierName) return;

            // Get values from modal inputs - helper function
            const getVal = (id) => document.getElementById(id)?.value || '';

            // RFQ Tracking
            const rfqSentDate = getVal('rfq-detail-sent-date');
            const quoteReceivedDate = getVal('rfq-detail-received-date');
            const quoteDate = getVal('rfq-detail-date');
            const validUntil = getVal('rfq-detail-valid');
            const quoteStatus = getVal('rfq-detail-quote-status');
            const quoteNumber = getVal('rfq-detail-quote-number');

            // Pricing & Terms
            const currency = getVal('rfq-detail-currency') || 'EUR';
            const incoterms = getVal('rfq-detail-incoterms');
            const globalLeadTime = getVal('rfq-detail-lead-time');
            const shippingCost = getVal('rfq-detail-shipping');
            const globalMoq = getVal('rfq-detail-moq');
            const mov = getVal('rfq-detail-mov');

            // Bulk actions
            const bulkStatus = getVal('rfq-detail-bulk-status');
            const globalComment = (document.getElementById('rfq-detail-global-comment')?.value || '').trim();

            const timestamp = new Date().toISOString();
            let savedCount = 0;

            // Update each item
            tbody.querySelectorAll('tr').forEach(row => {
                const checkbox = row.querySelector('input[type="checkbox"]');
                if (!checkbox?.checked) return;

                const dn = row.dataset.dn;
                const leadTimeInput = row.querySelector('.leadtime-input');
                const moqInput = row.querySelector('.moq-input');
                const statusInput = row.querySelector('.status-input');
                const commentInput = row.querySelector('.comment-input');

                const leadTime = leadTimeInput?.value || '';
                const moq = moqInput?.value || '';
                const rowStatus = statusInput?.value || '';
                const rowComment = commentInput?.value?.trim() || '';

                // Find item and update supplier data
                const item = currentProject.items?.find(it =>
                    (it.item_drawing_no || it.drawing_no) === dn
                );
                if (!item) return;

                if (!item.suppliers) item.suppliers = [];

                let supData = item.suppliers.find(s => _normSupKey(_supDisplayNameFromObj(s)) === _normSupKey(supplierName));

                if (!supData) {
                    supData = { supplier_name: supplierName, name: supplierName };
                    item.suppliers.push(supData);
                }

                // Collect all prices from all tier inputs
                const pricesArray = [];
                let firstPrice = 0;
                row.querySelectorAll('.price-input').forEach(priceInput => {
                    const qty = parseFloat(priceInput.dataset.qty) || 0;
                    const tierIdx = parseInt(priceInput.dataset.tier) || 1;
                    const price = parseFloat(priceInput.value) || 0;

                    if (qty > 0 && price > 0) {
                        pricesArray.push({ qty: qty, price: price });
                        // Also set price_1, price_2, etc. for legacy compatibility
                        setSupplierPriceByIndex(supData, tierIdx, price);
                        if (firstPrice === 0) firstPrice = price;
                    }
                });

                // Update supplier data - Prices
                supData.prices = pricesArray;
                supData.price = firstPrice; // Legacy: first price

                // RFQ Tracking fields
                if (rfqSentDate) supData.rfq_sent_date = rfqSentDate;
                if (quoteReceivedDate) supData.quote_received_date = quoteReceivedDate;
                supData.quote_date = quoteDate;
                supData.valid_until = validUntil;
                supData.quote_valid_until = validUntil; // Alias
                if (quoteStatus) supData.quote_status = quoteStatus;
                if (quoteNumber) supData.quote_number = quoteNumber;

                // Pricing & Terms
                supData.currency = currency;
                supData.incoterms = incoterms;
                supData.lead_time = leadTime || globalLeadTime; // Row value overrides global
                supData.moq = moq || globalMoq;
                if (shippingCost) supData.shipping = shippingCost;
                if (mov) supData.mov = mov;

                supData.updated_at = timestamp;

                // Set status: bulk status overrides row status if set
                if (bulkStatus) {
                    supData.status = bulkStatus;
                } else if (rowStatus) {
                    supData.status = rowStatus;
                } else if (firstPrice > 0 && !isDraft) {
                    supData.status = 'Quoted';
                }
                supData.status_updated = timestamp;

                // Handle comments
                const finalComment = rowComment || globalComment;
                if (finalComment) {
                    if (!supData.comments) supData.comments = [];
                    supData.comments.push({
                        text: finalComment,
                        timestamp: timestamp,
                        author: 'User'
                    });
                    supData.last_comment = finalComment;
                    supData.last_comment_date = timestamp;
                }

                // Also update item main prices if this is the main supplier or only supplier
                if (item.suppliers.length === 1 || supData.isMain) {
                    item.main_supplier = supplierName;
                    item.lead_time = leadTime;
                    // Sync tier prices to item level
                    pricesArray.forEach(p => {
                        // Find which tier this qty belongs to
                        const tiers = getItemQtyTiers(item, { includeBlanks: false });
                        const tierMatch = tiers.find(t => Number(t.value) === Number(p.qty));
                        if (tierMatch) {
                            item[`price_${tierMatch.index}`] = p.price;
                            if (tierMatch.index === 1) {
                                item.price = p.price;
                                item.price_1 = p.price;
                            }
                        }
                    });
                }

                savedCount++;
            });

            // Save project
            if (window.RFQData && window.RFQData.updateProject) window.RFQData.updateProject(currentProject);

            // Sync to Quotes DB if requested
            if (alsoSyncQuote && !isDraft && savedCount > 0) {
                syncPlannerToQuotes(supplierName, quoteNumber, currency, validUntil, incoterms, shippingCost, mov);
            }

            // Clear selection
            plannerState.selectedItems.clear();

            // Close modal
            closeRFQDetailModal();

            // Refresh planner view
            renderPlannerItemsForSupplier(supplierName);
            renderPlannerSuppliersList();

            showToast(`${isDraft ? 'Draft saved' : 'Saved prices'} for ${savedCount} items`, 'success');
        }

        /**
         * Sync RFQ Planner data to Quotes DB via upsert endpoint.
         * Collects all items for the supplier, maps qty/price tiers, and POSTs.
         * On success, stores quote_id/quote_number back into each supData.
         */
        function syncPlannerToQuotes(supplierName, quoteNumber, currency, expireDate, incoterms, shippingCost, mov) {
            if (!currentProject || !supplierName) return;

            const items = currentProject.items || [];
            const linesToSend = [];

            items.forEach((item, idx) => {
                const supData = _findSupplierOnItem(item, supplierName);
                if (!supData) return;

                const prices = Array.isArray(supData.prices) ? supData.prices : [];
                const hasAnyPrice = prices.some(p => p.price && parseFloat(p.price) > 0) ||
                    (supData.price_1 && parseFloat(supData.price_1) > 0);
                if (!hasAnyPrice) return;

                const linePayload = {
                    item_id: item.id || String(idx),
                    drawing_number: item.item_drawing_no || item.drawing_no || '',
                    manufacturer: item.manufacturer || '',
                    mpn: item.mpn || item.manufacturer_part_number || '',
                    description: item.description || '',
                    uom: item.unit || 'pcs',
                    moq: String(supData.moq || '1'),
                    lead_time: supData.lead_time || supData.leadTime || '',
                };

                // Map qty/price tiers
                const qtyTiers = getItemQtyTiers(item, { includeBlanks: false });
                qtyTiers.forEach((tier, i) => {
                    const tierIdx = i + 1;
                    const priceEntry = prices.find(p => String(p.qty) === String(tier.value));
                    linePayload['qty_' + tierIdx] = String(tier.value);
                    linePayload['price_' + tierIdx] = priceEntry
                        ? parseFloat(priceEntry.price) || null
                        : (parseFloat(supData['price_' + tierIdx]) || null);
                });

                linesToSend.push(linePayload);
            });

            if (linesToSend.length === 0) {
                showToast('No items with prices to sync', 'warning');
                return;
            }

            const payload = {
                project_id: currentProject.id,
                supplier_name: supplierName,
                quote_number: quoteNumber || '',
                currency: currency || 'EUR',
                expire_date: expireDate || '',
                incoterms: incoterms || '',
                shipping_cost: shippingCost || '',
                mov: mov || '',
                items: linesToSend,
            };

            fetch('/api/quotes/upsert_from_planner/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            })
            .then(r => r.json())
            .then(res => {
                if (res.ok) {
                    // Store quote references back into each supData
                    (currentProject.items || []).forEach(item => {
                        const supData = _findSupplierOnItem(item, supplierName);
                        if (supData) {
                            supData.quote_id = res.quote_id;
                            supData.quote_number = res.quote_number;
                        }
                    });
                    // Persist quote references
                    if (window.RFQData && window.RFQData.updateProject) {
                        window.RFQData.updateProject(currentProject);
                    }
                    // Refresh table to show quote badges
                    renderPlannerItemsForSupplier(supplierName);
                    showToast(`Quote ${res.quote_number} ${res.is_update ? 'updated' : 'created'} (${res.lines_count} items)`, 'success');
                } else {
                    showToast('Quote sync failed: ' + (res.error || 'Unknown error'), 'error');
                }
            })
            .catch(err => {
                console.error('Quote sync error:', err);
                showToast('Quote sync error: ' + err.message, 'error');
            });
        }

        function openQuoteWizardWithItems(supplier, itemDNs) {
            openQuoteWizard();

            // Set supplier
            const supplierSelect = document.getElementById('wiz-supplier');
            if (supplierSelect) {
                supplierSelect.value = supplier;
                if (!supplierSelect.value) {
                    document.getElementById('wiz-supplier-new').value = supplier;
                }
            }

            // Pre-select items
            itemDNs.forEach(dn => {
                quoteWizardState.selectedItems.add(dn);
            });
        }

        // ====== SUPPLIER SELECTION TAB FUNCTIONS ======

        // Supplier Selection state
        const ssState = {
            selectedSuppliers: new Set(), // Multiple suppliers can be selected
            selectedItems: new Set(),
            importData: null,
            sortColumn: null,
            sortDirection: 'asc' // 'asc' or 'desc'
        };

        // Render Supplier Selection tab
        function renderSupplierSelection() {
            if (!currentProject) return;

            renderSSSuppliersList();
            renderSSItemsTable();
            renderSSPreview();

            // Initialize table features (resize, drag, sort) - only once
            initSSItemsTable();
            bindSSEvents();
        }

        // Get all suppliers from all projects (global list)
        function _getAllProjectsSupplierNames() {
            const names = new Map(); // key -> { name, projects: Set }
            const allProjects = typeof projects !== 'undefined' ? projects : [];

            allProjects.forEach(proj => {
                const projName = proj.name || proj.id;

                const addSup = (supName) => {
                    const disp = String(supName || '').trim();
                    if (!disp) return;
                    const key = disp.toLowerCase();
                    if (!names.has(key)) {
                        names.set(key, { name: disp, projects: new Set() });
                    }
                    names.get(key).projects.add(projName);
                };

                // From supplierMaster
                (Array.isArray(proj.supplierMaster) ? proj.supplierMaster : []).forEach(s =>
                    addSup(s && (s.name || s.supplier_name || s.supplier))
                );

                // From suppliers array
                (Array.isArray(proj.suppliers) ? proj.suppliers : []).forEach(s =>
                    addSup(s && (s.name || s.supplier_name || s.supplier))
                );

                // From supplierData dict
                const sd = proj.supplierData || proj.supplier_data;
                if (sd && typeof sd === 'object') {
                    Object.keys(sd).forEach(k => addSup(k));
                }

                // From items suppliers
                (Array.isArray(proj.items) ? proj.items : []).forEach(item => {
                    (Array.isArray(item.suppliers) ? item.suppliers : []).forEach(s =>
                        addSup(s && (s.name || s.supplier_name || s.supplier))
                    );
                });
            });

            return Array.from(names.values()).sort((a, b) => a.name.localeCompare(b.name));
        }

        // Render selected suppliers chips at top
        function renderSSSelectedSuppliers() {
            const container = document.getElementById('ss-selected-suppliers');
            if (!container) return;

            if (ssState.selectedSuppliers.size === 0) {
                container.innerHTML = `<div style="padding:8px; color:#888; font-size:11px; text-align:center;">No suppliers selected. Click on a supplier below or use "+ Pick" to add.</div>`;
                return;
            }

            container.innerHTML = Array.from(ssState.selectedSuppliers).map(name => `
                <div class="ss-selected-chip" data-supplier="${escapeHtml(name)}">
                    <span>${escapeHtml(name)}</span>
                    <span class="ss-chip-remove" data-supplier="${escapeHtml(name)}">&times;</span>
                </div>
            `).join('');

            // Bind remove events
            container.querySelectorAll('.ss-chip-remove').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const name = btn.dataset.supplier;
                    ssState.selectedSuppliers.delete(name);
                    renderSSSelectedSuppliers();
                    renderSSSuppliersList();
                    renderSSPreview();
                    updateSSButtons();
                };
            });
        }

        // Render suppliers list in left panel
        function renderSSSuppliersList() {
            const container = document.getElementById('ss-suppliers-list');
            if (!container) return;

            // First render selected suppliers chips
            renderSSSelectedSuppliers();

            const searchInput = document.getElementById('ss-supplier-search');
            const searchTerm = (searchInput?.value || '').trim().toLowerCase();

            // Get suppliers from current project (not selected)
            if (!currentProject) {
                container.innerHTML = `<div style="text-align:center; padding:20px; color:#888;">Select a project first</div>`;
                return;
            }

            const projectSuppliers = _getProjectSupplierNames(currentProject);
            let supplierList = projectSuppliers
                .filter(name => !ssState.selectedSuppliers.has(name)) // Exclude already selected
                .map(name => ({
                    name,
                    itemCount: (currentProject.items || []).filter(item =>
                        _findSupplierOnItem(item, name)
                    ).length
                }));

            // Apply search filter
            const filtered = supplierList.filter(s =>
                !searchTerm || s.name.toLowerCase().includes(searchTerm)
            );

            if (filtered.length === 0 && ssState.selectedSuppliers.size === 0) {
                container.innerHTML = `
                    <div style="text-align:center; padding:20px; color:#888;">
                        <div style="font-size:24px; margin-bottom:8px;">&#128269;</div>
                        ${supplierList.length === 0 ? 'No suppliers in project. Use "+ Pick" or "+ New".' : 'No suppliers match search'}
                    </div>
                `;
                return;
            }

            if (filtered.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding:12px; color:#888; font-size:11px;">All project suppliers are selected or no match found.</div>`;
                return;
            }

            container.innerHTML = filtered.map(s => {
                const isSelected = ssState.selectedSuppliers.has(s.name);
                return `
                    <div class="ss-supplier-card ${isSelected ? 'selected' : ''}" data-supplier="${escapeHtml(s.name)}">
                        <div class="ss-supplier-name">${escapeHtml(s.name)}</div>
                        <div class="ss-supplier-info">${s.itemCount} items assigned</div>
                    </div>
                `;
            }).join('');

            // Bind click events - toggle selection
            container.querySelectorAll('.ss-supplier-card').forEach(card => {
                card.onclick = () => {
                    const name = card.dataset.supplier;
                    if (ssState.selectedSuppliers.has(name)) {
                        ssState.selectedSuppliers.delete(name);
                    } else {
                        ssState.selectedSuppliers.add(name);
                    }
                    renderSSSelectedSuppliers();
                    renderSSSuppliersList();
                    renderSSPreview();
                    updateSSButtons();
                };
            });
        }

        // Render items table in center panel
        function renderSSItemsTable() {
            const tbody = document.getElementById('ss-items-tbody');
            if (!tbody || !currentProject) return;

            const searchInput = document.getElementById('ss-items-search');
            const mpnFilter = document.getElementById('ss-items-mpn-filter');
            const mfrFilter = document.getElementById('ss-items-mfr-filter');
            const filterSelect = document.getElementById('ss-items-filter');

            const searchTerm = (searchInput?.value || '').trim().toLowerCase();
            const mpnTerm = (mpnFilter?.value || '').trim().toLowerCase();
            const mfrTerm = (mfrFilter?.value || '').trim().toLowerCase();
            const filter = filterSelect?.value || 'all';

            let items = (currentProject.items || []).slice();

            // Apply status filter
            if (filter === 'no-supplier') {
                items = items.filter(item => !_getItemSuppliers(item).length);
            } else if (filter === 'with-supplier') {
                items = items.filter(item => _getItemSuppliers(item).length > 0);
            } else if (filter === 'needs-rfq') {
                items = items.filter(item => {
                    const sups = _getItemSuppliers(item);
                    return sups.some(s => s.status === 'Planned' || !s.status);
                });
            }

            // Apply search (Drawing No, Description)
            if (searchTerm) {
                items = items.filter(item => {
                    const dn = String(item.item_drawing_no || '').toLowerCase();
                    const desc = String(item.description || '').toLowerCase();
                    return dn.includes(searchTerm) || desc.includes(searchTerm);
                });
            }

            // Apply MPN filter
            if (mpnTerm) {
                items = items.filter(item => {
                    const mpn = String(item.mpn || item.MPN || '').toLowerCase();
                    return mpn.includes(mpnTerm);
                });
            }

            // Apply Manufacturer filter
            if (mfrTerm) {
                items = items.filter(item => {
                    const mfr = String(item.manufacturer || item.Manufacturer || '').toLowerCase();
                    return mfr.includes(mfrTerm);
                });
            }

            // Apply sorting
            if (ssState.sortColumn) {
                const col = ssState.sortColumn;
                const dir = ssState.sortDirection === 'desc' ? -1 : 1;

                items.sort((a, b) => {
                    let valA, valB;

                    switch (col) {
                        case 'drawing_no':
                            valA = String(a.item_drawing_no || '').toLowerCase();
                            valB = String(b.item_drawing_no || '').toLowerCase();
                            break;
                        case 'mpn':
                            valA = String(a.mpn || a.MPN || '').toLowerCase();
                            valB = String(b.mpn || b.MPN || '').toLowerCase();
                            break;
                        case 'manufacturer':
                            valA = String(a.manufacturer || a.Manufacturer || '').toLowerCase();
                            valB = String(b.manufacturer || b.Manufacturer || '').toLowerCase();
                            break;
                        case 'description':
                            valA = String(a.description || '').toLowerCase();
                            valB = String(b.description || '').toLowerCase();
                            break;
                        case 'qty':
                            valA = parseFloat(a.qty_1 || a.quantity || 0) || 0;
                            valB = parseFloat(b.qty_1 || b.quantity || 0) || 0;
                            return (valA - valB) * dir;
                        case 'suppliers':
                            valA = _getItemSuppliers(a).length;
                            valB = _getItemSuppliers(b).length;
                            return (valA - valB) * dir;
                        default:
                            valA = '';
                            valB = '';
                    }

                    return valA.localeCompare(valB) * dir;
                });
            }

            if (items.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align:center; padding:40px; color:#888;">
                            No items found
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = items.map(item => {
                const dn = String(item.item_drawing_no || '').trim();
                const isSelected = ssState.selectedItems.has(dn);
                const suppliers = _getItemSuppliers(item);
                const qty = item.qty_1 || item.quantity || '-';
                const mpn = String(item.mpn || item.MPN || '').trim();
                const manufacturer = String(item.manufacturer || item.Manufacturer || '').trim();

                const supplierBadges = suppliers.slice(0, 2).map(s =>
                    `<span class="ss-supplier-badge">${escapeHtml(s.name || s.supplier_name || '')}</span>`
                ).join('');
                const moreCount = suppliers.length > 2 ? `<span class="ss-supplier-badge">+${suppliers.length - 2}</span>` : '';

                const statusBadge = suppliers.length > 0
                    ? `<span style="color:#10b981; font-size:11px;">&#10003;</span>`
                    : `<span style="color:#f59e0b; font-size:11px;">&#9888;</span>`;

                return `
                    <tr class="${isSelected ? 'selected' : ''}" data-dn="${escapeHtml(dn)}">
                        <td><input type="checkbox" class="ss-item-check" data-dn="${escapeHtml(dn)}" ${isSelected ? 'checked' : ''}></td>
                        <td>
                            <a href="#" class="ss-item-link" data-dn="${escapeHtml(dn)}" style="font-weight:600; color:#3b82f6; text-decoration:none;">
                                ${escapeHtml(dn)}
                            </a>
                        </td>
                        <td style="font-size:11px; color:#666;">${escapeHtml(mpn.substring(0, 20))}</td>
                        <td style="font-size:11px; color:#666;">${escapeHtml(manufacturer.substring(0, 20))}</td>
                        <td style="font-size:11px;">${escapeHtml(String(item.description || '').substring(0, 40))}</td>
                        <td>${qty}</td>
                        <td>${supplierBadges}${moreCount}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            }).join('');

            // Bind checkbox events
            tbody.querySelectorAll('.ss-item-check').forEach(cb => {
                cb.onchange = () => {
                    const dn = cb.dataset.dn;
                    if (cb.checked) {
                        ssState.selectedItems.add(dn);
                    } else {
                        ssState.selectedItems.delete(dn);
                    }
                    updateSSButtons();
                    renderSSPreview();
                    const row = cb.closest('tr');
                    if (row) row.classList.toggle('selected', cb.checked);
                };
            });

            // Bind item link clicks to open Item Details
            tbody.querySelectorAll('.ss-item-link').forEach(link => {
                link.onclick = (e) => {
                    e.preventDefault();
                    const dn = link.dataset.dn;
                    const idx = (currentProject.items || []).findIndex(it =>
                        String(it.item_drawing_no || '').trim() === dn
                    );
                    if (idx >= 0 && typeof openItemDetail === 'function') {
                        openItemDetail(idx);
                    }
                };
            });

            // Update selected count
            const countEl = document.getElementById('ss-items-selected-count');
            if (countEl) countEl.textContent = `${ssState.selectedItems.size} items selected`;
        }

        // Initialize SS Items table with resize, drag, and sort
        function initSSItemsTable() {
            if (window.__SS_TABLE_INIT__) return;
            window.__SS_TABLE_INIT__ = true;

            const table = document.getElementById('ss-items-table');
            if (!table) return;

            // Add unified table features (resize + drag)
            if (typeof ensureUnifiedTable === 'function') {
                ensureUnifiedTable('ss-items-table', 'rfq_ss_items', { enableHeaderFilters: false });
            }

            // Add sort click handlers to headers
            const thead = table.querySelector('thead');
            if (thead) {
                const headerRow = thead.querySelector('tr');
                if (headerRow) {
                    const headers = headerRow.querySelectorAll('th');
                    const columnMap = ['checkbox', 'drawing_no', 'mpn', 'manufacturer', 'description', 'qty', 'suppliers', 'status'];

                    headers.forEach((th, idx) => {
                        const colId = columnMap[idx];
                        if (colId === 'checkbox' || colId === 'status') return; // Non-sortable

                        th.style.cursor = 'pointer';
                        th.dataset.sortCol = colId;

                        // Add sort indicator span if not exists
                        if (!th.querySelector('.ss-sort-indicator')) {
                            const indicator = document.createElement('span');
                            indicator.className = 'ss-sort-indicator';
                            indicator.style.cssText = 'margin-left:4px; font-size:10px; opacity:0.5;';
                            th.appendChild(indicator);
                        }

                        th.onclick = (e) => {
                            // Don't trigger sort if clicking on resize handle
                            if (e.target.classList.contains('col-resize-handle')) return;

                            const sortCol = th.dataset.sortCol;
                            if (ssState.sortColumn === sortCol) {
                                // Toggle direction
                                ssState.sortDirection = ssState.sortDirection === 'asc' ? 'desc' : 'asc';
                            } else {
                                ssState.sortColumn = sortCol;
                                ssState.sortDirection = 'asc';
                            }

                            // Update sort indicators
                            headers.forEach(h => {
                                const ind = h.querySelector('.ss-sort-indicator');
                                if (ind) {
                                    if (h.dataset.sortCol === ssState.sortColumn) {
                                        ind.textContent = ssState.sortDirection === 'asc' ? '‚ñ≤' : '‚ñº';
                                        ind.style.opacity = '1';
                                    } else {
                                        ind.textContent = '';
                                        ind.style.opacity = '0.5';
                                    }
                                }
                            });

                            renderSSItemsTable();
                        };
                    });
                }
            }
        }

        // Render preview panel
        function renderSSPreview() {
            const content = document.getElementById('ss-preview-content');
            const actions = document.getElementById('ss-preview-actions');
            if (!content) return;

            if (ssState.selectedSuppliers.size === 0 || ssState.selectedItems.size === 0) {
                content.innerHTML = `
                    <div class="ss-preview-empty">
                        <div style="font-size:48px; margin-bottom:12px; opacity:0.3;">&#128269;</div>
                        <div style="color:#888;">Select items and supplier(s) to preview assignment</div>
                    </div>
                `;
                if (actions) actions.style.display = 'none';
                return;
            }

            const items = Array.from(ssState.selectedItems).map(dn =>
                (currentProject.items || []).find(it => String(it.item_drawing_no || '').trim() === dn)
            ).filter(Boolean);

            const suppliers = Array.from(ssState.selectedSuppliers);

            content.innerHTML = `
                <div style="margin-bottom:12px;">
                    <div style="font-size:11px; color:#888; margin-bottom:6px;">ASSIGNING TO (${suppliers.length} supplier${suppliers.length > 1 ? 's' : ''})</div>
                    <div style="display:flex; flex-direction:column; gap:4px; max-height:120px; overflow-y:auto;">
                        ${suppliers.map(name => `
                            <div class="ss-preview-supplier" style="display:flex; justify-content:space-between; align-items:center; padding:6px 10px; background:#d1fae5; border-radius:6px;">
                                <span style="font-weight:600; font-size:12px; color:#065f46;">${escapeHtml(name)}</span>
                                <button class="ss-preview-remove-sup" data-supplier="${escapeHtml(name)}" style="background:none; border:none; color:#065f46; cursor:pointer; font-size:14px;">&times;</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div style="margin-bottom:8px; font-size:12px; color:#666;">${items.length} item(s) will be assigned:</div>
                <div style="flex:1; overflow-y:auto; border:1px solid #e5e7eb; border-radius:8px;">
                    ${items.map(item => `
                        <div class="ss-preview-item" style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <div class="drawing-no">${escapeHtml(String(item.item_drawing_no || ''))}</div>
                                <div class="desc">${escapeHtml(String(item.description || '').substring(0, 40))}</div>
                            </div>
                            <button class="ss-preview-remove-item" data-dn="${escapeHtml(String(item.item_drawing_no || ''))}" style="background:none; border:none; color:#888; cursor:pointer; font-size:14px;">&times;</button>
                        </div>
                    `).join('')}
                </div>
                <div style="margin-top:12px; padding-top:12px; border-top:1px solid #e5e7eb;">
                    <div style="font-size:11px; color:#888; margin-bottom:6px;">ADD ITEM MANUALLY</div>
                    <div style="display:flex; gap:6px;">
                        <input type="text" id="ss-preview-add-item" class="rfq-input" placeholder="Drawing No..." style="flex:1; font-size:11px;">
                        <button id="btn-ss-preview-add-item" class="rfq-btn-mini">Add</button>
                    </div>
                </div>
            `;

            // Bind remove supplier events
            content.querySelectorAll('.ss-preview-remove-sup').forEach(btn => {
                btn.onclick = () => {
                    const name = btn.dataset.supplier;
                    ssState.selectedSuppliers.delete(name);
                    renderSSSelectedSuppliers();
                    renderSSSuppliersList();
                    renderSSPreview();
                    updateSSButtons();
                };
            });

            // Bind remove item events
            content.querySelectorAll('.ss-preview-remove-item').forEach(btn => {
                btn.onclick = () => {
                    const dn = btn.dataset.dn;
                    ssState.selectedItems.delete(dn);
                    renderSSItemsTable();
                    renderSSPreview();
                    updateSSButtons();
                };
            });

            // Bind add item manually
            const addItemBtn = document.getElementById('btn-ss-preview-add-item');
            const addItemInput = document.getElementById('ss-preview-add-item');
            if (addItemBtn && addItemInput) {
                addItemBtn.onclick = () => {
                    const dn = addItemInput.value.trim();
                    if (!dn) return;
                    // Find item
                    const item = (currentProject.items || []).find(it =>
                        String(it.item_drawing_no || '').trim().toLowerCase() === dn.toLowerCase()
                    );
                    if (item) {
                        ssState.selectedItems.add(String(item.item_drawing_no || '').trim());
                        addItemInput.value = '';
                        renderSSItemsTable();
                        renderSSPreview();
                        updateSSButtons();
                    } else {
                        addItemInput.style.borderColor = '#ef4444';
                        setTimeout(() => addItemInput.style.borderColor = '', 1500);
                    }
                };
                addItemInput.onkeydown = (e) => {
                    if (e.key === 'Enter') addItemBtn.click();
                };
            }

            if (actions) actions.style.display = 'block';
        }

        // Update button states
        function updateSSButtons() {
            const assignBtn = document.getElementById('btn-ss-assign-to-selected');
            const createRfqBtn = document.getElementById('btn-ss-create-rfq');

            const hasSelection = ssState.selectedItems.size > 0 && ssState.selectedSuppliers.size > 0;

            if (assignBtn) assignBtn.disabled = !hasSelection;
            if (createRfqBtn) createRfqBtn.disabled = !hasSelection;

            // Update selected count
            const countEl = document.getElementById('ss-items-selected-count');
            if (countEl) countEl.textContent = `${ssState.selectedItems.size} items selected`;
        }

        // Bind all Supplier Selection events
        function bindSSEvents() {
            if (window.__SS_EVENTS_BOUND__) return;
            window.__SS_EVENTS_BOUND__ = true;

            // Supplier search
            const supplierSearch = document.getElementById('ss-supplier-search');
            if (supplierSearch) {
                supplierSearch.oninput = debounce(() => renderSSSuppliersList(), 200);
            }

            // Show from all projects checkbox
            const showAllProjectsCheckbox = document.getElementById('ss-show-all-projects');
            if (showAllProjectsCheckbox) {
                showAllProjectsCheckbox.onchange = () => renderSSSuppliersList();
            }

            // Items search and filters
            const itemsSearch = document.getElementById('ss-items-search');
            const itemsFilter = document.getElementById('ss-items-filter');
            const mpnFilter = document.getElementById('ss-items-mpn-filter');
            const mfrFilter = document.getElementById('ss-items-mfr-filter');

            if (itemsSearch) {
                itemsSearch.oninput = debounce(() => renderSSItemsTable(), 200);
            }
            if (itemsFilter) {
                itemsFilter.onchange = () => renderSSItemsTable();
            }
            if (mpnFilter) {
                mpnFilter.oninput = debounce(() => renderSSItemsTable(), 200);
            }
            if (mfrFilter) {
                mfrFilter.oninput = debounce(() => renderSSItemsTable(), 200);
            }

            // Select all / Clear
            const selectAllBtn = document.getElementById('btn-ss-select-all-items');
            const clearBtn = document.getElementById('btn-ss-clear-selection');
            const checkAllBox = document.getElementById('ss-items-check-all');

            if (selectAllBtn) {
                selectAllBtn.onclick = () => {
                    // Get all visible item rows from the table
                    const rows = document.querySelectorAll('#ss-items-tbody tr[data-dn]');
                    rows.forEach(row => {
                        const dn = row.dataset.dn;
                        if (dn) {
                            ssState.selectedItems.add(dn);
                        }
                    });
                    renderSSItemsTable();
                    updateSSButtons();
                    renderSSPreview();
                };
            }

            if (clearBtn) {
                clearBtn.onclick = () => {
                    ssState.selectedItems.clear();
                    renderSSItemsTable();
                    updateSSButtons();
                    renderSSPreview();
                };
            }

            if (checkAllBox) {
                checkAllBox.onchange = () => {
                    const rows = document.querySelectorAll('#ss-items-tbody tr[data-dn]');
                    rows.forEach(row => {
                        const dn = row.dataset.dn;
                        if (dn) {
                            if (checkAllBox.checked) {
                                ssState.selectedItems.add(dn);
                            } else {
                                ssState.selectedItems.delete(dn);
                            }
                        }
                    });
                    renderSSItemsTable();
                    updateSSButtons();
                    renderSSPreview();
                };
            }

            // Add new supplier button
            const addSupBtn = document.getElementById('btn-ss-add-supplier');
            if (addSupBtn) {
                addSupBtn.onclick = () => {
                    const modal = document.getElementById('ss-new-supplier-modal');
                    if (modal) modal.classList.remove('hidden');
                };
            }

            // New supplier modal
            const ssNewSupModal = document.getElementById('ss-new-supplier-modal');
            const ssNewSupClose = document.getElementById('ss-new-supplier-close');
            const ssNewSupCancel = document.getElementById('ss-new-supplier-cancel');
            const ssNewSupSave = document.getElementById('ss-new-supplier-save');

            if (ssNewSupClose) ssNewSupClose.onclick = () => ssNewSupModal?.classList.add('hidden');
            if (ssNewSupCancel) ssNewSupCancel.onclick = () => ssNewSupModal?.classList.add('hidden');
            if (ssNewSupSave) {
                ssNewSupSave.onclick = () => {
                    const nameInput = document.getElementById('ss-new-supplier-name');
                    const emailInput = document.getElementById('ss-new-supplier-email');
                    const contactInput = document.getElementById('ss-new-supplier-contact');

                    const name = (nameInput?.value || '').trim();
                    if (!name) {
                        showToast('Please enter supplier name', 'warning');
                        return;
                    }

                    // Create supplier in project
                    if (!currentProject.supplierMaster) currentProject.supplierMaster = [];
                    const exists = currentProject.supplierMaster.some(s =>
                        String(s.name || '').toLowerCase() === name.toLowerCase()
                    );

                    if (!exists) {
                        currentProject.supplierMaster.push({
                            id: Date.now(),
                            name: name,
                            email: emailInput?.value || '',
                            contact: contactInput?.value || ''
                        });
                        updateProject(currentProject);
                    }

                    // Select the new supplier
                    ssState.selectedSuppliers.add(name);

                    // Clear form and close modal
                    if (nameInput) nameInput.value = '';
                    if (emailInput) emailInput.value = '';
                    if (contactInput) contactInput.value = '';
                    ssNewSupModal?.classList.add('hidden');

                    renderSSSelectedSuppliers();
                    renderSSSuppliersList();
                    updateSSButtons();
                    renderSSPreview();
                };
            }

            // Pick existing supplier button
            const pickSupBtn = document.getElementById('btn-ss-pick-existing');
            if (pickSupBtn) {
                pickSupBtn.onclick = () => {
                    const modal = document.getElementById('ss-pick-supplier-modal');
                    if (modal) {
                        modal.classList.remove('hidden');
                        renderPickSupplierList();
                    }
                };
            }

            // Pick supplier modal events
            bindPickSupplierModalEvents();

            // Assign button
            const assignBtn = document.getElementById('btn-ss-assign-to-selected');
            if (assignBtn) {
                assignBtn.onclick = () => {
                    if (ssState.selectedSuppliers.size === 0 || ssState.selectedItems.size === 0) return;
                    executeMultiSupplierAssignment();
                };
            }

            // Confirm assignment button (in preview panel)
            const confirmBtn = document.getElementById('btn-ss-confirm-assignment');
            if (confirmBtn) {
                confirmBtn.onclick = () => {
                    if (ssState.selectedSuppliers.size === 0 || ssState.selectedItems.size === 0) return;
                    executeMultiSupplierAssignment();
                };
            }

            // Create RFQ button
            const createRfqBtn = document.getElementById('btn-ss-create-rfq');
            if (createRfqBtn) {
                createRfqBtn.onclick = () => {
                    if (ssState.selectedSuppliers.size === 0 || ssState.selectedItems.size === 0) return;

                    const suppliers = Array.from(ssState.selectedSuppliers);
                    const itemDNs = Array.from(ssState.selectedItems);

                    // First assign all
                    executeMultiSupplierAssignment(false);

                    // Switch to RFQ Planner and start wizard with first supplier
                    const rfqPlannerTab = document.querySelector('.rfq-tab[data-tab="rfq-planner"]');
                    if (rfqPlannerTab) rfqPlannerTab.click();

                    setTimeout(() => {
                        startRFQWizard(suppliers[0], itemDNs);
                    }, 100);
                };
            }

            // Result modal close
            const resultOk = document.getElementById('ss-result-ok');
            const resultClose = document.getElementById('ss-result-close');
            const resultModal = document.getElementById('ss-result-modal');
            if (resultOk) resultOk.onclick = () => resultModal?.classList.add('hidden');
            if (resultClose) resultClose.onclick = () => resultModal?.classList.add('hidden');

            // Import Excel button
            const importBtn = document.getElementById('btn-ss-import-excel');
            if (importBtn) {
                importBtn.onclick = () => {
                    const modal = document.getElementById('ss-import-modal');
                    if (modal) modal.classList.remove('hidden');
                    resetSSImportModal();
                };
            }

            // Export template button
            const exportBtn = document.getElementById('btn-ss-export-template');
            if (exportBtn) {
                exportBtn.onclick = () => exportSSTemplate();
            }

            // Import modal events
            bindSSImportModalEvents();
        }

        // Pick supplier modal - render list
        function renderPickSupplierList() {
            const container = document.getElementById('ss-pick-list');
            const searchInput = document.getElementById('ss-pick-search');
            if (!container) return;

            const searchTerm = (searchInput?.value || '').trim().toLowerCase();
            const allSuppliers = _getAllProjectsSupplierNames();

            const filtered = allSuppliers.filter(s =>
                !searchTerm || s.name.toLowerCase().includes(searchTerm)
            );

            if (filtered.length === 0) {
                container.innerHTML = `<div style="padding:20px; text-align:center; color:#888;">No suppliers found</div>`;
                return;
            }

            container.innerHTML = filtered.map(s => {
                const isSelected = ssState.selectedSuppliers.has(s.name);
                return `
                    <div class="ss-pick-item ${isSelected ? 'selected' : ''}" data-supplier="${escapeHtml(s.name)}">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} data-supplier="${escapeHtml(s.name)}">
                        <div style="flex:1;">
                            <div style="font-weight:600; font-size:12px;">${escapeHtml(s.name)}</div>
                            <div style="font-size:10px; color:#888;">${s.projects.size} project${s.projects.size !== 1 ? 's' : ''}</div>
                        </div>
                    </div>
                `;
            }).join('');

            // Bind checkbox events
            container.querySelectorAll('.ss-pick-item').forEach(item => {
                const cb = item.querySelector('input[type="checkbox"]');
                item.onclick = (e) => {
                    if (e.target === cb) return;
                    cb.checked = !cb.checked;
                    cb.dispatchEvent(new Event('change'));
                };
                if (cb) {
                    cb.onchange = () => {
                        const name = cb.dataset.supplier;
                        if (cb.checked) {
                            ssState.selectedSuppliers.add(name);
                            item.classList.add('selected');
                        } else {
                            ssState.selectedSuppliers.delete(name);
                            item.classList.remove('selected');
                        }
                        updatePickSupplierCount();
                    };
                }
            });

            updatePickSupplierCount();
        }

        function updatePickSupplierCount() {
            const countEl = document.getElementById('ss-pick-selected-count');
            if (countEl) countEl.textContent = ssState.selectedSuppliers.size;
        }

        function bindPickSupplierModalEvents() {
            const modal = document.getElementById('ss-pick-supplier-modal');
            const closeBtn = document.getElementById('ss-pick-supplier-close');
            const cancelBtn = document.getElementById('ss-pick-supplier-cancel');
            const addBtn = document.getElementById('ss-pick-supplier-add');
            const searchInput = document.getElementById('ss-pick-search');

            if (closeBtn) closeBtn.onclick = () => modal?.classList.add('hidden');
            if (cancelBtn) cancelBtn.onclick = () => modal?.classList.add('hidden');

            if (searchInput) {
                searchInput.oninput = debounce(() => renderPickSupplierList(), 200);
            }

            if (addBtn) {
                addBtn.onclick = () => {
                    modal?.classList.add('hidden');
                    renderSSSelectedSuppliers();
                    renderSSSuppliersList();
                    renderSSPreview();
                    updateSSButtons();
                };
            }
        }

        // Execute multi-supplier assignment
        function executeMultiSupplierAssignment(showResult = true) {
            if (!currentProject || ssState.selectedSuppliers.size === 0 || ssState.selectedItems.size === 0) return;

            const suppliers = Array.from(ssState.selectedSuppliers);
            const itemDNs = Array.from(ssState.selectedItems);

            const results = {
                totalAssigned: 0,
                totalSkipped: 0,
                supplierDetails: []
            };

            suppliers.forEach(supplierName => {
                let assigned = 0;
                let skipped = 0;

                itemDNs.forEach(dn => {
                    const item = (currentProject.items || []).find(it =>
                        String(it.item_drawing_no || '').trim() === dn
                    );
                    if (!item) {
                        skipped++;
                        return;
                    }

                    ensureItemShape(item);

                    const exists = item.suppliers.some(s =>
                        String(s.name || s.supplier_name || '').toLowerCase() === supplierName.toLowerCase()
                    );

                    if (!exists) {
                        const newTarget = {
                            id: Date.now() + Math.random(),
                            name: supplierName,
                            currency: 'EUR',
                            isMain: false,
                            status: 'Planned',
                            price: 0,
                            price_1: 0
                        };
                        item.suppliers.push(newTarget);

                        const mSup = getOrCreateSupplierMaster(currentProject, supplierName);
                        if (mSup) linkItemSupplierToMaster(newTarget, mSup);

                        assigned++;
                    } else {
                        skipped++;
                    }
                });

                results.totalAssigned += assigned;
                results.totalSkipped += skipped;
                results.supplierDetails.push({ name: supplierName, assigned, skipped });
            });

            updateProject(currentProject);

            // Clear selections
            ssState.selectedItems.clear();
            ssState.selectedSuppliers.clear();

            // Refresh UI
            renderSSSelectedSuppliers();
            renderSSItemsTable();
            renderSSSuppliersList();
            renderSSPreview();
            updateSSButtons();

            if (showResult) {
                showAssignmentResultModal(results, suppliers.length, itemDNs.length);
            }
        }

        // Show beautiful result modal
        function showAssignmentResultModal(results, supplierCount, itemCount) {
            const modal = document.getElementById('ss-result-modal');
            const statsEl = document.getElementById('ss-result-stats');
            const detailsEl = document.getElementById('ss-result-details');
            const iconEl = document.getElementById('ss-result-icon');
            const titleEl = document.getElementById('ss-result-title');
            const subtitleEl = document.getElementById('ss-result-subtitle');

            if (!modal) return;

            // Update icon and title based on results
            const isSuccess = results.totalAssigned > 0;
            if (iconEl) {
                iconEl.textContent = isSuccess ? '‚úì' : '‚ö†';
                iconEl.style.color = isSuccess ? '#10b981' : '#f59e0b';
            }
            if (titleEl) titleEl.textContent = isSuccess ? 'Assignment Complete' : 'Assignment Complete (with skips)';
            if (subtitleEl) subtitleEl.textContent = `${supplierCount} supplier(s) √ó ${itemCount} item(s)`;

            // Stats
            if (statsEl) {
                statsEl.innerHTML = `
                    <div class="ss-result-stat">
                        <div class="ss-result-stat-value">${results.totalAssigned}</div>
                        <div class="ss-result-stat-label">Assigned</div>
                    </div>
                    <div class="ss-result-stat ${results.totalSkipped > 0 ? 'warning' : ''}">
                        <div class="ss-result-stat-value">${results.totalSkipped}</div>
                        <div class="ss-result-stat-label">Already Existed</div>
                    </div>
                    <div class="ss-result-stat">
                        <div class="ss-result-stat-value">${supplierCount}</div>
                        <div class="ss-result-stat-label">Suppliers</div>
                    </div>
                `;
            }

            // Details
            if (detailsEl) {
                detailsEl.innerHTML = `
                    <div style="font-size:11px; color:#888; padding:8px 12px; background:#f9fafb; border-bottom:1px solid #e5e7eb;">
                        BREAKDOWN BY SUPPLIER
                    </div>
                    ${results.supplierDetails.map(d => `
                        <div class="ss-result-detail-item">
                            <span style="font-weight:600;">${escapeHtml(d.name)}</span>
                            <span>
                                <span style="color:#10b981;">${d.assigned} added</span>
                                ${d.skipped > 0 ? `<span style="color:#888; margin-left:8px;">${d.skipped} skipped</span>` : ''}
                            </span>
                        </div>
                    `).join('')}
                `;
            }

            modal.classList.remove('hidden');
        }

        // Legacy function - kept for compatibility
        function assignSupplierToItems(supplierName, itemDNs, showAlert = true) {
            ssState.selectedSuppliers.clear();
            ssState.selectedSuppliers.add(supplierName);
            ssState.selectedItems.clear();
            itemDNs.forEach(dn => ssState.selectedItems.add(dn));
            executeMultiSupplierAssignment(showAlert);
        }

        // Export template Excel for supplier assignment
        function exportSSTemplate() {
            if (!currentProject || !window.XLSX) {
                showToast('Excel library not loaded or no project selected.', 'error');
                return;
            }

            const items = currentProject.items || [];
            const data = items.map(item => {
                const suppliers = _getItemSuppliers(item);
                const row = {
                    'Drawing No': item.item_drawing_no || '',
                    'Description': item.description || '',
                    'Supplier 1': suppliers[0]?.name || '',
                    'Supplier 2': suppliers[1]?.name || '',
                    'Supplier 3': suppliers[2]?.name || '',
                    'Supplier 4': '',
                    'Supplier 5': ''
                };
                return row;
            });

            const ws = window.XLSX.utils.json_to_sheet(data);
            const wb = window.XLSX.utils.book_new();
            window.XLSX.utils.book_append_sheet(wb, ws, 'Supplier Assignment');

            const filename = `Supplier_Assignment_Template_${currentProject.name || 'Project'}.xlsx`;
            window.XLSX.writeFile(wb, filename);
        }

        // Reset import modal
        function resetSSImportModal() {
            ssState.importData = null;
            const preview = document.getElementById('ss-import-preview');
            const dropzone = document.getElementById('ss-import-dropzone');
            const confirmBtn = document.getElementById('ss-import-confirm');

            if (preview) preview.classList.add('hidden');
            if (dropzone) dropzone.style.display = 'block';
            if (confirmBtn) confirmBtn.disabled = true;
        }

        // Bind import modal events
        function bindSSImportModalEvents() {
            const modal = document.getElementById('ss-import-modal');
            const closeBtn = document.getElementById('ss-import-close');
            const cancelBtn = document.getElementById('ss-import-cancel');
            const confirmBtn = document.getElementById('ss-import-confirm');
            const clearBtn = document.getElementById('ss-import-clear');
            const dropzone = document.getElementById('ss-import-dropzone');
            const fileInput = document.getElementById('ss-import-file');

            if (closeBtn) closeBtn.onclick = () => modal?.classList.add('hidden');
            if (cancelBtn) cancelBtn.onclick = () => modal?.classList.add('hidden');

            if (clearBtn) {
                clearBtn.onclick = () => resetSSImportModal();
            }

            if (dropzone && fileInput) {
                dropzone.onclick = () => fileInput.click();

                dropzone.ondragover = (e) => {
                    e.preventDefault();
                    dropzone.classList.add('dragover');
                };
                dropzone.ondragleave = () => dropzone.classList.remove('dragover');
                dropzone.ondrop = (e) => {
                    e.preventDefault();
                    dropzone.classList.remove('dragover');
                    const file = e.dataTransfer?.files?.[0];
                    if (file) processSSImportFile(file);
                };

                fileInput.onchange = () => {
                    const file = fileInput.files?.[0];
                    if (file) processSSImportFile(file);
                };
            }

            if (confirmBtn) {
                confirmBtn.onclick = () => {
                    if (!ssState.importData) return;
                    executeSSImport();
                    modal?.classList.add('hidden');
                };
            }
        }

        // Process imported file
        function processSSImportFile(file) {
            if (!window.XLSX) {
                if (window.showToast) window.showToast('Excel library not loaded. Please refresh the page.', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = window.XLSX.read(data, { type: 'array' });
                    const sheetName = wb.SheetNames[0];
                    const ws = wb.Sheets[sheetName];
                    const rows = window.XLSX.utils.sheet_to_json(ws, { defval: '' });

                    // Parse and validate
                    const parsed = parseSSImportRows(rows);
                    ssState.importData = parsed;

                    // Show preview
                    showSSImportPreview(file.name, parsed);
                } catch (err) {
                    console.error('Import error:', err);
                    showToast('Failed to parse file: ' + err.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Parse import rows - format: Drawing No, Supplier 1, Supplier 2, Supplier 3...
        function parseSSImportRows(rows) {
            const result = {
                rows: [],
                matchedItems: 0,
                unmatchedItems: 0,
                suppliers: new Set()
            };

            if (!currentProject) return result;

            rows.forEach((row, idx) => {
                // Find drawing number column
                const drawingNo = String(
                    row['Drawing No'] || row['DrawingNo'] || row['drawing_no'] ||
                    row['Part No'] || row['PartNo'] || row['part_no'] ||
                    row['Item'] || row['item'] || ''
                ).trim();

                if (!drawingNo) return;

                // Find matching item
                const item = (currentProject.items || []).find(it => {
                    const dn = String(it.item_drawing_no || it.drawing_no || '').trim();
                    return dn.toLowerCase() === drawingNo.toLowerCase();
                });

                // Collect suppliers from columns
                const suppliers = [];
                for (let i = 1; i <= 20; i++) {
                    const supName = String(
                        row['Supplier ' + i] || row['Supplier' + i] ||
                        row['supplier_' + i] || row['Supplier_' + i] || ''
                    ).trim();
                    if (supName) {
                        suppliers.push(supName);
                        result.suppliers.add(supName);
                    }
                }

                if (item) {
                    result.matchedItems++;
                } else {
                    result.unmatchedItems++;
                }

                result.rows.push({
                    rowNum: idx + 2,
                    drawingNo,
                    suppliers,
                    matched: !!item
                });
            });

            return result;
        }

        // Show import preview
        function showSSImportPreview(filename, parsed) {
            const dropzone = document.getElementById('ss-import-dropzone');
            const preview = document.getElementById('ss-import-preview');
            const confirmBtn = document.getElementById('ss-import-confirm');

            if (dropzone) dropzone.style.display = 'none';
            if (preview) preview.classList.remove('hidden');
            if (confirmBtn) confirmBtn.disabled = parsed.matchedItems === 0;

            // Update stats
            document.getElementById('ss-import-filename').textContent = filename;
            document.getElementById('ss-import-rows').textContent = parsed.rows.length;
            document.getElementById('ss-import-matched').textContent = parsed.matchedItems;
            document.getElementById('ss-import-suppliers').textContent = parsed.suppliers.size;

            // Render preview table
            const thead = document.getElementById('ss-import-preview-thead');
            const tbody = document.getElementById('ss-import-preview-tbody');

            if (thead) {
                thead.innerHTML = `
                    <tr>
                        <th>Status</th>
                        <th>Drawing No</th>
                        <th>Suppliers</th>
                    </tr>
                `;
            }

            if (tbody) {
                tbody.innerHTML = parsed.rows.slice(0, 50).map(row => `
                    <tr class="${row.matched ? 'matched' : 'unmatched'}">
                        <td>${row.matched ? '&#10003;' : '&#10007;'}</td>
                        <td>${escapeHtml(row.drawingNo)}</td>
                        <td>${row.suppliers.map(s => `<span class="ss-supplier-badge new">${escapeHtml(s)}</span>`).join('')}</td>
                    </tr>
                `).join('');

                if (parsed.rows.length > 50) {
                    tbody.innerHTML += `<tr><td colspan="3" style="text-align:center; color:#888;">... and ${parsed.rows.length - 50} more rows</td></tr>`;
                }
            }
        }

        // Execute the import
        function executeSSImport() {
            if (!ssState.importData || !currentProject) return;

            let assigned = 0;
            let skipped = 0;

            ssState.importData.rows.forEach(row => {
                if (!row.matched || row.suppliers.length === 0) return;

                const item = (currentProject.items || []).find(it => {
                    const dn = String(it.item_drawing_no || it.drawing_no || '').trim();
                    return dn.toLowerCase() === row.drawingNo.toLowerCase();
                });

                if (!item) return;

                ensureItemShape(item);

                row.suppliers.forEach(supplierName => {
                    const exists = item.suppliers.some(s =>
                        String(s.name || s.supplier_name || '').toLowerCase() === supplierName.toLowerCase()
                    );

                    if (!exists) {
                        const newTarget = {
                            id: Date.now() + Math.random(),
                            name: supplierName,
                            currency: 'EUR',
                            isMain: false,
                            status: 'Planned',
                            price: 0,
                            price_1: 0
                        };
                        item.suppliers.push(newTarget);

                        const mSup = getOrCreateSupplierMaster(currentProject, supplierName);
                        if (mSup) linkItemSupplierToMaster(newTarget, mSup);

                        assigned++;
                    } else {
                        skipped++;
                    }
                });
            });

            updateProject(currentProject);

            // Refresh UI
            renderSupplierSelection();

            showToast(`Import complete! Assigned ${assigned} supplier-item combinations.${skipped > 0 ? ` ${skipped} already existed.` : ''} Unmatched: ${ssState.importData.unmatchedItems}`, 'success');
        }

        // Old quoting view rendering (for Classic tab)
        function renderOldQuotingView() {
            if (!currentProject) return;

            try {
                renderOldQuotingSuppliersPanel();
                renderOldQuotingBundlesPanel();
            } catch (e) {
                console.error('Error rendering old quoting view:', e);
            }
        }

        function renderOldQuotingSuppliersPanel() {
            const tbody = document.querySelector('#qt-suppliers-table tbody');
            const countEl = document.getElementById('qt-suppliers-count');
            if (!tbody || !currentProject) return;

            const suppliers = (currentProject.suppliers || []).slice();
            const batches = (window.RFQData?.getRFQBatches?.(currentProject.id) || []);

            const statsBySup = {};
            batches.forEach(b => {
                const sup = String(b.supplier_name || b.supplier || '').trim().toLowerCase();
                if (!sup) return;
                if (!statsBySup[sup]) statsBySup[sup] = { total: 0 };
                statsBySup[sup].total++;
            });

            // Count targets from items
            const targetsBySup = {};
            (currentProject.items || []).forEach(item => {
                (item.suppliers || []).forEach(s => {
                    const name = (s.supplier_name || s.supplier || s.name || '').toLowerCase();
                    if (name) {
                        targetsBySup[name] = (targetsBySup[name] || 0) + 1;
                    }
                });
            });

            const rows = suppliers.map(supObj => {
                const name = supObj.name || supObj.supplier_name || '';
                const key = name.toLowerCase();
                const stats = statsBySup[key] || { total: 0 };
                const targets = targetsBySup[key] || 0;

                return `
                    <tr class="qc-row" data-action="qt-select-supplier" data-supplier-name="${escapeHtml(name)}">
                        <td>${escapeHtml(name)}</td>
                        <td class="cell-num">${targets}</td>
                        <td class="cell-num">${stats.total}</td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = rows || '<tr><td colspan="3" style="text-align:center; color:#888;">No suppliers</td></tr>';
            if (countEl) countEl.textContent = String(suppliers.length);
        }

        function renderOldQuotingBundlesPanel() {
            const tbody = document.querySelector('#qt-bundles-table tbody');
            const countEl = document.getElementById('qt-bundles-count');
            if (!tbody || !currentProject) return;

            const batches = (window.RFQData?.getRFQBatches?.(currentProject.id) || []).slice();
            batches.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));

            const rows = batches.map(batch => {
                const id = batch.id || '';
                const date = batch.created_at ? new Date(batch.created_at).toLocaleDateString() : '';
                const supplier = batch.supplier_name || batch.supplier || '';
                const status = batch.status || 'Draft';
                const itemCount = Array.isArray(batch.items) ? batch.items.length : 0;

                return `
                    <tr class="qc-row" data-action="qt-open-bundle" data-batch-id="${escapeHtml(String(id))}">
                        <td>${date}</td>
                        <td>${escapeHtml(supplier)}</td>
                        <td>${escapeHtml(status)}</td>
                        <td class="cell-num">${itemCount}</td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = rows || '<tr><td colspan="4" style="text-align:center; color:#888;">No bundles</td></tr>';
            if (countEl) countEl.textContent = String(batches.length);
        }

        // Wizard state
        const quoteWizardState = {
            step: 1,
            supplier: '',
            dueDate: '',
            currency: 'EUR',
            incoterms: '',
            status: 'Draft',
            contact: '',
            email: '',
            notes: '',
            selectedItems: new Set(),
            prices: {} // { dn: { qty1, price1, qty2, price2, leadTime, moq } }
        };

        function renderQuotingView() {
            // Initialize tabs
            initQuotingTabs();

            // Determine which tab is active
            const activeTab = document.querySelector('.rfq-tab.active');
            const tabId = activeTab ? activeTab.dataset.tab : 'price-comparison';

            if (!currentProject) {
                // Show empty state in all tabs
                const container = document.getElementById('rfq-items-comparison');
                if (container) {
                    container.innerHTML = `
                        <div class="rfq-empty-state">
                            <div class="rfq-empty-icon">üìÅ</div>
                            <div class="rfq-empty-title">Select a Project</div>
                            <p>Choose a project from the dropdown to view price comparisons</p>
                        </div>
                    `;
                }
                return;
            }

            // Bind events once
            bindNewQuotingEvents();

            // Render based on active tab
            if (tabId === 'supplier-selection') {
                renderSupplierSelection();
            } else if (tabId === 'rfq-planner') {
                renderRFQPlanner();
            } else if (tabId === 'price-comparison') {
                renderItemComparison();
            } else if (tabId === 'final-summary') {
                renderFinalSummary();
            }
        }

        // =========================================================
        // FINAL SUMMARY - Premium Feature v2
        // =========================================================

        // Global state for Final Summary
        window.fsState = {
            expandedSuppliers: new Set(),
            challenges: [], // Active challenges
            currentChallenge: null,
            selectedSupplier: null, // Currently selected supplier in left sidebar
            supplierGroups: new Map(),
            allItems: [],
            nonAwardedSuppliers: []
        };

        function renderFinalSummary() {
            if (!currentProject) return;

            const items = Array.isArray(currentProject.items) ? currentProject.items : [];

            // Load challenges from project
            window.fsState.challenges = currentProject.challenges || [];

            // Analyze awarded items - items with supplier and price set
            const awardedItems = items.filter(it => {
                const supplier = it.supplier || it.awarded_supplier || '';
                const price = parseFloat(it.price_1) || parseFloat(it.awarded_price) || 0;
                return supplier && price > 0;
            });

            // Group by supplier
            const supplierGroups = new Map();
            awardedItems.forEach(it => {
                const supplier = it.supplier || it.awarded_supplier || '';
                if (!supplierGroups.has(supplier)) {
                    supplierGroups.set(supplier, { items: [], totalValue: 0 });
                }
                const group = supplierGroups.get(supplier);
                const qty = parseFloat(it.qty_1) || 1;
                const price = parseFloat(it.price_1) || parseFloat(it.awarded_price) || 0;
                const value = qty * price;
                group.items.push({ ...it, lineValue: value });
                group.totalValue += value;
            });

            // Store for global access
            window.fsState.supplierGroups = supplierGroups;
            window.fsState.allItems = items;

            // Calculate stats
            const totalItems = items.length;
            const awardedCount = awardedItems.length;
            const activeChallenges = window.fsState.challenges.filter(c => c.status === 'open' || c.status === 'pending');
            const totalValue = Array.from(supplierGroups.values()).reduce((sum, g) => sum + g.totalValue, 0);

            // Update stats in header and right sidebar
            const statTotal = document.getElementById('fs-stat-total-items');
            const statAwarded = document.getElementById('fs-stat-awarded');
            const statChallenged = document.getElementById('fs-stat-challenged');
            const statValue = document.getElementById('fs-stat-total-value');
            const awardedBadge = document.getElementById('fs-awarded-count');

            if (statTotal) statTotal.textContent = totalItems;
            if (statAwarded) statAwarded.textContent = awardedCount;
            if (statChallenged) statChallenged.textContent = activeChallenges.length;
            if (statValue) statValue.textContent = '‚Ç¨' + totalValue.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            if (awardedBadge) awardedBadge.textContent = supplierGroups.size;

            // Render LEFT SIDEBAR: Awarded suppliers as clickable cards
            renderFSAwardedSuppliersCards(supplierGroups);

            // Render MIDDLE: Items for selected supplier (or all if none selected)
            renderFSSupplierItems();

            // Render challenge center in right sidebar
            renderChallengeCenter();

            // Render non-awarded suppliers in left sidebar bottom
            renderFSNonAwardedSuppliers(items);

            // Render document tracking in right sidebar
            renderDocumentTrackingBySupplier(supplierGroups);

            // Bind events for the new layout
            bindFinalSummaryEvents();
        }

        // Render awarded suppliers as compact clickable cards in left sidebar
        function renderFSAwardedSuppliersCards(supplierGroups) {
            const container = document.getElementById('fs-awarded-suppliers');
            if (!container) return;

            if (supplierGroups.size === 0) {
                container.innerHTML = `
                    <div style="text-align:center; padding:20px; color:#64748b;">
                        <div style="font-size:32px; margin-bottom:8px;">üèÜ</div>
                        <div style="font-weight:600; font-size:11px;">No Awards Yet</div>
                        <p style="font-size:10px; margin-top:4px;">Award suppliers in Price Comparison</p>
                    </div>
                `;
                return;
            }

            const selectedSupplier = window.fsState.selectedSupplier;

            container.innerHTML = Array.from(supplierGroups.entries())
                .sort((a, b) => b[1].totalValue - a[1].totalValue)
                .map(([supplier, data]) => {
                    const isActive = selectedSupplier === supplier;
                    return `
                        <div class="fs-supplier-card-new ${isActive ? 'active' : ''}" data-supplier="${escapeHtml(supplier)}">
                            <div class="name">üè≠ ${escapeHtml(supplier)}</div>
                            <div class="stats">
                                <span>${data.items.length} items</span>
                                <span class="value">‚Ç¨${data.totalValue.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</span>
                            </div>
                        </div>
                    `;
                }).join('');

            // Bind click events to select supplier
            container.querySelectorAll('.fs-supplier-card-new').forEach(card => {
                card.onclick = () => {
                    const supName = card.dataset.supplier;

                    // Update selected state
                    window.fsState.selectedSupplier = supName;

                    // Update active class
                    container.querySelectorAll('.fs-supplier-card-new').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');

                    // Update middle panel
                    renderFSSupplierItems();
                };
            });

            // Auto-select first supplier if none selected
            if (!selectedSupplier && supplierGroups.size > 0) {
                const firstSupplier = Array.from(supplierGroups.keys())[0];
                window.fsState.selectedSupplier = firstSupplier;
                const firstCard = container.querySelector('.fs-supplier-card-new');
                if (firstCard) firstCard.classList.add('active');
                renderFSSupplierItems();
            }
        }

        // Render items for selected supplier in middle panel
        function renderFSSupplierItems() {
            const selectedSupplier = window.fsState.selectedSupplier;
            const supplierGroups = window.fsState.supplierGroups;
            const tbody = document.getElementById('fs-items-tbody');
            const nameEl = document.getElementById('fs-selected-supplier-name');
            const countEl = document.getElementById('fs-items-count');
            const summaryItems = document.getElementById('fs-summary-items');
            const summaryValue = document.getElementById('fs-summary-value');

            if (!selectedSupplier || !supplierGroups.has(selectedSupplier)) {
                // Show all items if no supplier selected
                if (nameEl) nameEl.textContent = 'All Awarded Items';
                const allItems = [];
                supplierGroups.forEach((data, sup) => {
                    data.items.forEach(it => allItems.push({ ...it, supplier: sup }));
                });
                if (countEl) countEl.textContent = allItems.length + ' items';
                renderFSItemsTable(allItems);
                return;
            }

            const data = supplierGroups.get(selectedSupplier);
            if (nameEl) nameEl.textContent = selectedSupplier;
            if (countEl) countEl.textContent = data.items.length + ' items';
            if (summaryItems) summaryItems.textContent = data.items.length;
            if (summaryValue) summaryValue.textContent = '‚Ç¨' + data.totalValue.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

            renderFSItemsTable(data.items);
        }

        // Render items table in middle panel
        function renderFSItemsTable(items) {
            const tbody = document.getElementById('fs-items-tbody');
            if (!tbody) return;

            const filter = document.getElementById('fs-items-filter')?.value || 'all';
            const search = (document.getElementById('fs-items-search')?.value || '').toLowerCase();

            let filteredItems = items.filter(it => {
                if (filter === 'all' && !search) return true; // Show all by default

                const dn = (it.item_drawing_no || it.drawing_no || it.dn || it.part_no || '').toLowerCase();
                const desc = (it.description || '').toLowerCase();
                const mpn = (it.mpn || it.MPN || '').toLowerCase();
                if (search && !dn.includes(search) && !desc.includes(search) && !mpn.includes(search)) return false;

                const isChallenged = it.challenge_id || it.challenge_status === 'challenged';
                if (filter === 'challenged' && !isChallenged) return false;
                if (filter === 'awarded' && isChallenged) return false;

                return true;
            });

            if (filteredItems.length === 0) {
                tbody.innerHTML = `<tr><td colspan="15" style="text-align:center; padding:40px; color:#64748b;">No items match the filter</td></tr>`;
                return;
            }

            tbody.innerHTML = filteredItems.map(it => {
                const dn = it.item_drawing_no || it.drawing_no || it.dn || it.part_no || '‚Äî';
                const supplier = it.supplier || it.awarded_supplier || '';
                const qty1 = it.qty_1 || it.quantity || '';
                const qty2 = it.qty_2 || '';
                const qty3 = it.qty_3 || '';
                const price1 = parseFloat(it.price_1) || 0;
                const price2 = parseFloat(it.price_2) || 0;
                const price3 = parseFloat(it.price_3) || 0;
                const total = (parseFloat(qty1) || 1) * price1;
                const isChallenged = it.challenge_id || it.challenge_status === 'challenged';

                let statusClass = 'fs-status-awarded';
                let statusText = '‚úÖ Awarded';
                if (isChallenged) {
                    statusClass = 'fs-status-challenged';
                    statusText = '‚ö° Challenge';
                }

                const rowClass = isChallenged ? 'challenged' : 'awarded';

                return `
                    <tr class="${rowClass}">
                        <td><input type="checkbox" class="fs-item-check" data-dn="${escapeHtml(dn)}" data-supplier="${escapeHtml(supplier)}"></td>
                        <td><a href="#" onclick="event.preventDefault(); window.navigateToItem('${escapeHtml(dn)}')" style="color:#3b82f6; text-decoration:underline; cursor:pointer; font-weight:600;">${escapeHtml(dn)}</a></td>
                        <td style="font-size:10px;">${escapeHtml(it.mpn || it.MPN || '‚Äî')}</td>
                        <td style="font-size:10px;">${escapeHtml(it.manufacturer || '‚Äî')}</td>
                        <td style="max-width:100px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-size:10px;" title="${escapeAttr(it.description || '')}">${escapeHtml(it.description || '‚Äî')}</td>
                        <td style="text-align:center; font-size:10px;">${qty1 || '‚Äî'}</td>
                        <td style="text-align:right; font-size:10px;">‚Ç¨${price1.toFixed(2)}</td>
                        <td style="text-align:center; font-size:10px;">${qty2 || '‚Äî'}</td>
                        <td style="text-align:right; font-size:10px;">${price2 > 0 ? '‚Ç¨' + price2.toFixed(2) : '‚Äî'}</td>
                        <td style="text-align:center; font-size:10px;">${qty3 || '‚Äî'}</td>
                        <td style="text-align:right; font-size:10px;">${price3 > 0 ? '‚Ç¨' + price3.toFixed(2) : '‚Äî'}</td>
                        <td style="font-size:10px;">${escapeHtml(it.lead_time || it.lt || '‚Äî')}</td>
                        <td style="text-align:right; font-weight:600; font-size:10px; color:#16a34a;">‚Ç¨${total.toFixed(2)}</td>
                        <td><span class="fs-status-badge ${statusClass}">${statusText}</span></td>
                        <td style="white-space:nowrap;">
                            ${!isChallenged ? `<button class="fs-challenge-btn" onclick="window.openItemChallenge('${escapeHtml(dn)}')" title="Challenge">‚ö°</button>` : ''}
                            <button class="fs-doc-btn" onclick="window.navigateToItem('${escapeHtml(dn)}')" style="padding:2px 6px; font-size:9px;" title="View">üëÅ</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Helper to switch tabs in Quoting view
        window.switchQuotingTab = function (tabId) {
            const tabBtn = document.querySelector(`.rfq-tab[data-tab="${tabId}"]`);
            if (tabBtn) {
                tabBtn.click();
            } else {
                console.warn('[switchQuotingTab] Tab not found:', tabId);
            }
        };

        // Helper to navigate to item detail - uses Price Comparison search box
        window.navigateToItem = function (dn) {
            // Close the non-awarded modal if it exists
            const modal = document.getElementById('non-awarded-detail-modal');
            if (modal) modal.remove();

            // First, switch to Quoting view (parent of Price Comparison)
            if (window.switchView) {
                window.switchView('quoting');
            }

            // Then switch to Price Comparison tab
            setTimeout(() => {
                if (window.switchQuotingTab) {
                    window.switchQuotingTab('price-comparison');
                } else {
                    // Fallback if helper not ready
                    const tabBtn = document.querySelector('.rfq-tab[data-tab="price-comparison"]');
                    if (tabBtn) tabBtn.click();
                }

                // Finally set the search box to filter for this drawing number
                setTimeout(() => {
                    const searchInput = document.getElementById('pc-filter-search'); // The CORRECT input (green circle)

                    if (searchInput) {
                        searchInput.value = dn;
                        // Directly call renderItemComparison to apply the filter
                        if (typeof renderItemComparison === 'function') {
                            renderItemComparison();
                        } else {
                            // Fallback: trigger input event
                            searchInput.dispatchEvent(new Event('input', { bubbles: true }));
                        }
                    } else {
                        console.error('[navigateToItem] Search input (pc-filter-search) not found - waiting longer...');
                        // Try again with longer delay
                        setTimeout(() => {
                            const searchInput2 = document.getElementById('pc-filter-search');
                            if (searchInput2) {
                                searchInput2.value = dn;
                                if (typeof renderItemComparison === 'function') {
                                    renderItemComparison();
                                }
                            }
                        }, 300);
                    }
                }, 100); // Wait for tab switch
            }, 100); // Wait for view switch
        };

        // Render non-awarded suppliers in left sidebar
        // These are suppliers who are NOT marked as main in sourcing strategy
        function renderFSNonAwardedSuppliers(items) {
            const container = document.getElementById('fs-non-awarded-list');
            const countBadge = document.getElementById('fs-non-awarded-count');
            if (!container) return;

            // Track non-main suppliers with their item counts and total quoted value
            const nonMainSuppliersData = new Map();

            items.forEach(it => {
                const mainSupplier = it.supplier || it.awarded_supplier;
                const itemDn = it.item_drawing_no || it.drawing_no || it.dn || it.part_no || '';

                // Collect all suppliers for this item from multiple sources
                const allSuppliersForItem = new Map(); // Map<supplierName, {price, source}>

                // Source 1: supplier_quotes array (Sourcing Strategy data)
                if (it.supplier_quotes && Array.isArray(it.supplier_quotes)) {
                    it.supplier_quotes.forEach(sq => {
                        const supName = sq.supplier_name || sq.supplier || '';
                        if (supName) {
                            const price = parseFloat(sq.price_1) || parseFloat(sq.price) || parseFloat(sq.unit_price) || 0;
                            const quoteNum = sq.quote_number || sq.rfq_number || sq.quotation_number || sq.ref_number || '';

                            // DEBUG: Log quote number data
                            if (supName === '1265') {
                            }

                            allSuppliersForItem.set(supName, {
                                price,
                                source: 'supplier_quotes',
                                quote_number: quoteNum
                            });
                        }
                    });
                }

                // Source 2: item.suppliers array (Sourcing Strategy Targets)
                if (it.suppliers && Array.isArray(it.suppliers)) {
                    it.suppliers.forEach(sup => {
                        const supName = sup.name || sup.supplier_name || sup.supplier || '';
                        if (supName && !allSuppliersForItem.has(supName)) {
                            // If not already added from supplier_quotes, add with price 0
                            const price = parseFloat(sup.price_1) || parseFloat(sup.price) || parseFloat(sup.unit_price) || 0;
                            allSuppliersForItem.set(supName, { price, source: 'suppliers', quote_number: '' });
                        }
                    });
                }

                // Source 3: quotes array (legacy format)
                if (it.quotes && Array.isArray(it.quotes)) {
                    it.quotes.forEach(q => {
                        const supName = q.supplier || q.supplier_name || '';
                        if (supName && !allSuppliersForItem.has(supName)) {
                            const price = parseFloat(q.price) || parseFloat(q.unit_price) || 0;
                            const quoteNum = q.quote_number || q.rfq_number || '';
                            allSuppliersForItem.set(supName, {
                                price,
                                source: 'quotes',
                                quote_number: quoteNum
                            });
                        }
                    });
                }

                // Now filter to only non-main suppliers
                allSuppliersForItem.forEach((data, supName) => {
                    // Only include if supplier is NOT the main supplier for this item
                    if (supName !== mainSupplier) {
                        if (!nonMainSuppliersData.has(supName)) {
                            nonMainSuppliersData.set(supName, {
                                items: [],
                                totalQuoted: 0,
                                quoteNumbers: new Set(),  // Initialize here
                                // Tracking fields for notification status
                                notificationStatus: 'pending',  // 'pending' | 'challenged' | 'notified'
                                notifiedDate: null,
                                notifiedBy: null,
                                challengeData: null,
                                comments: ''
                            });
                        }
                        const supplierData = nonMainSuppliersData.get(supName);
                        const qty = parseFloat(it.qty_1) || parseFloat(it.quantity) || 1;

                        // Avoid duplicates for the same item
                        if (!supplierData.items.find(i => i.drawing_no === itemDn)) {
                            supplierData.items.push({
                                item_id: it.id || it.item_id || '',
                                drawing_no: itemDn,
                                description: it.description || '',
                                manufacturer: it.manufacturer || '',
                                mpn: it.mpn || it.manufacturer_part_number || '',
                                price: data.price,
                                qty: qty,
                                awarded_to: mainSupplier || '‚Äî',
                                awarded_price: parseFloat(it.price_1) || 0,
                                quote_number: data.quote_number || ''
                            });
                            supplierData.totalQuoted += data.price * qty;

                            // Track unique quote numbers for this supplier
                            if (data.quote_number) {
                                supplierData.quoteNumbers.add(data.quote_number);
                            }

                            // Track unique quote numbers for this supplier
                            if (data.quote_number) {
                                supplierData.quoteNumbers.add(data.quote_number);
                            }
                        }
                    }
                });
            });

            window.fsState.nonAwardedSuppliers = Array.from(nonMainSuppliersData.keys());
            window.fsState.nonAwardedData = nonMainSuppliersData;

            // Load saved tracking data from localStorage
            window.loadNonAwardedTracking();

            if (countBadge) countBadge.textContent = nonMainSuppliersData.size;

            if (nonMainSuppliersData.size === 0) {
                container.innerHTML = '<div style="text-align:center; padding:12px; color:#94a3b8; font-size:10px;">No non-main suppliers found.<br><span style="font-size:9px;">Suppliers who are not marked as main in Sourcing Strategy will appear here.</span></div>';
                return;
            }

            container.innerHTML = Array.from(nonMainSuppliersData.entries())
                .sort((a, b) => b[1].items.length - a[1].items.length)
                .map(([supName, data]) => {
                    // Determine styles based on status
                    // Determine styles based on status - UPDATED COLORS (Stronger)
                    const status = data.notificationStatus || 'pending';
                    let styles = {
                        bg: '#fee2e2', // pending (Darker Red)
                        border: '#b91c1c', // Dark Red
                        text: '#7f1d1d',   // Dark Red Status Text
                        icon: ''
                    };

                    if (status === 'challenged') {
                        styles = { bg: '#ffedd5', border: '#c2410c', text: '#9a3412', icon: 'üü†' }; // Orange (Darker)
                    } else if (status === 'notified') {
                        styles = { bg: '#dcfce7', border: '#15803d', text: '#14532d', icon: '‚úÖ' }; // Green (Darker)
                    }

                    return `
                    <div class="fs-non-awarded-card" data-supplier="${escapeHtml(supName)}" onclick="window.showNonAwardedDetail('${escapeHtml(supName)}')" 
                        style="cursor:pointer; background:${styles.bg}; border-left:4px solid ${styles.border}; margin-bottom:8px;">
                        <div style="flex:1;">
                            <div class="name" style="font-weight:600; display:flex; align-items:center; gap:6px;">
                                ${escapeHtml(supName)}
                                ${styles.icon ? `<span style="font-size:12px;">${styles.icon}</span>` : ''}
                            </div>
                            <div style="font-size:9px; color:#64748b;">
                                ${data.items.length} items not awarded ‚Ä¢ ‚Ç¨${data.totalQuoted.toFixed(0)}
                                ${status === 'notified' ? '<span style="color:#15803d; font-weight:700;">‚Ä¢ NOITIFIED</span>' : ''}
                            </div>
                        </div>
                        <button class="action-btn" onclick="event.stopPropagation(); window.sendLoserNotification('${escapeHtml(supName)}')" title="Send notification">üìß</button>
                    </div>
                `;
                }).join('');
        }

        // Expose refresh function globally that uses the stored items
        window.refreshNonAwardedSuppliers = function () {
            if (window.fsState && window.fsState.allItems) {
                renderFSNonAwardedSuppliers(window.fsState.allItems);
            }
        };

        // ========== Non-Awarded Supplier Tracking - LocalStorage Persistence ==========

        // Save tracking data to localStorage
        // Save tracking data to localStorage AND Backend (via Project JSON)
        window.saveNonAwardedTracking = function () {
            if (!currentProject || !window.fsState.nonAwardedData) return;

            const projectId = currentProject.id;
            const trackingData = {};
            const trackingArray = []; // For backend storage

            // Convert Map to plain object for storage
            window.fsState.nonAwardedData.forEach((data, supplierName) => {
                const entry = {
                    notificationStatus: data.notificationStatus || 'pending',
                    notifiedDate: data.notifiedDate,
                    notifiedBy: data.notifiedBy,
                    challengeData: data.challengeData,
                    comments: data.comments || ''
                };

                // For localStorage (legacy/backup)
                trackingData[supplierName] = entry;

                // For Backend (Array required for JSON)
                trackingArray.push({
                    supplier: supplierName,
                    ...entry
                });
            });

            // 1. Save to LocalStorage (Backup)
            try {
                localStorage.setItem(`nonAwardedTracking_${projectId}`, JSON.stringify(trackingData));
                console.log('[Tracking] Saved tracking data to localStorage', projectId);
            } catch (e) {
                console.error('[Tracking] Failed to save to localStorage:', e);
            }

            // 2. Save to Backend (Primary)
            try {
                // Update project object
                currentProject.non_awarded_tracking = trackingArray;

                // Trigger backend sync
                if (typeof window.updateProject === 'function') {
                    console.log('[Tracking] Syncing tracking data to backend...');
                    window.updateProject(currentProject);
                } else {
                    console.warn('[Tracking] window.updateProject not found, data saved locally only.');
                }
            } catch (e) {
                console.error('[Tracking] Failed to sync to backend:', e);
            }
        };

        // Load tracking data from Backend (primary) or localStorage (migration)
        window.loadNonAwardedTracking = function () {
            if (!currentProject || !window.fsState.nonAwardedData) return;

            const projectId = currentProject.id;
            let loadedFromBackend = false;

            try {
                // 1. Try Backend Source
                if (currentProject.non_awarded_tracking && Array.isArray(currentProject.non_awarded_tracking)) {
                    console.log('[Tracking] Loading from Backend (Project JSON)...');
                    currentProject.non_awarded_tracking.forEach(item => {
                        const data = window.fsState.nonAwardedData.get(item.supplier);
                        if (data) {
                            data.notificationStatus = item.notificationStatus || 'pending';
                            data.notifiedDate = item.notifiedDate;
                            data.notifiedBy = item.notifiedBy;
                            data.challengeData = item.challengeData;
                            data.comments = item.comments || '';
                        }
                    });
                    loadedFromBackend = true;
                }

                // 2. Migration / Fallback check (LocalStorage)
                // If backend had no data, or explicitly to checking for backup
                const storedV1 = localStorage.getItem(`nonAwardedTracking_${projectId}`);

                if (storedV1 && !loadedFromBackend) {
                    console.log('[Tracking] No backend data found. Migrating from LocalStorage...');
                    const trackingData = JSON.parse(storedV1);
                    let hasDataToMigrate = false;

                    // Merge stored tracking data with current data
                    window.fsState.nonAwardedData.forEach((data, supplierName) => {
                        if (trackingData[supplierName]) {
                            data.notificationStatus = trackingData[supplierName].notificationStatus || 'pending';
                            data.notifiedDate = trackingData[supplierName].notifiedDate;
                            data.notifiedBy = trackingData[supplierName].notifiedBy;
                            data.challengeData = trackingData[supplierName].challengeData;
                            data.comments = trackingData[supplierName].comments || '';
                            hasDataToMigrate = true;
                        }
                    });

                    // Trigger immediate save to push migrated data to backend
                    if (hasDataToMigrate) {
                        setTimeout(() => window.saveNonAwardedTracking(), 2000); // Delay slightly to ensure load completes
                    }
                }

                console.log('[Tracking] Tracking data loaded.');

            } catch (e) {
                console.error('[Tracking] Failed to load tracking data:', e);
            }
        };

        // ========== Status Management Functions ==========

        // Render status badge with appropriate color and icon
        window.renderStatusBadge = function (status) {
            const configs = {
                pending: {
                    icon: 'üî¥',
                    text: 'Not Notified',
                    bg: '#fecaca',
                    color: '#991b1b'
                },
                challenged: {
                    icon: 'üü†',
                    text: 'Challenge Process',
                    bg: '#fed7aa',
                    color: '#9a3412'
                },
                notified: {
                    icon: 'üü¢',
                    text: 'Notified',
                    bg: '#bbf7d0',
                    color: '#14532d'
                }
            };

            const config = configs[status] || configs.pending;
            return `
                <span style="
                    background: ${config.bg}; 
                    color: ${config.color}; 
                    padding: 4px 12px; 
                    border-radius: 12px; 
                    font-size: 11px; 
                    font-weight: 600;
                    display: inline-block;
                ">
                    ${config.icon} ${config.text}
                </span>
            `;
        };

        // Mark supplier as notified
        window.markSupplierNotified = function (supplierName) {
            const data = window.fsState.nonAwardedData?.get(supplierName);
            if (!data) return;

            // Update status
            data.notificationStatus = 'notified';
            data.notifiedDate = new Date().toISOString();
            data.notifiedBy = 'Current User'; // TODO: Get actual user name

            // Save to localStorage
            window.saveNonAwardedTracking();

            // Close and reopen modal to refresh
            document.getElementById('non-awarded-detail-modal')?.remove();
            window.showNonAwardedDetail(supplierName);

            // Show success message
            if (window.showToast) {
                window.showToast(`${supplierName} marked as notified`, 'success');
            }

            // Refresh the non-awarded section to update visual indicators
            if (window.refreshNonAwardedSuppliers) {
                window.refreshNonAwardedSuppliers();
            }
        };

        // Reset notification status
        // Reset notification status
        window.resetNotificationStatus = function (supplierName) {
            window.showConfirmDialog({
                title: 'Reset Status',
                message: `Are you sure you want to reset notification status for ${supplierName}?`,
                type: 'warning',
                okText: 'Reset',
                cancelText: 'Cancel'
            }).then((confirmed) => {
                if (!confirmed) return;

                const data = window.fsState.nonAwardedData?.get(supplierName);
                if (!data) return;

                // Reset status
                data.notificationStatus = 'pending';
                data.notifiedDate = null;
                data.notifiedBy = null;

                // Save to localStorage
                window.saveNonAwardedTracking();

                // Close and reopen modal to refresh
                document.getElementById('non-awarded-detail-modal')?.remove();
                window.showNonAwardedDetail(supplierName);

                // Show success message
                if (window.showToast) {
                    window.showToast(`Notification status reset for ${supplierName}`, 'success');
                }

                // Refresh the non-awarded section
                if (window.refreshNonAwardedSuppliers) {
                    window.refreshNonAwardedSuppliers();
                }
            });
        };



        // Add supplier comment (appends to history)
        window.addSupplierComment = function (supplierName) {
            const data = window.fsState.nonAwardedData?.get(supplierName);
            if (!data) return;

            const textarea = document.getElementById('new-comment-text');
            if (!textarea || !textarea.value.trim()) {
                if (window.showToast) window.showToast('Please enter a note', 'warning');
                return;
            }

            const newNote = textarea.value.trim();
            const timestamp = new Date().toLocaleString();
            // Format: [Date] Note \n---\n
            const entry = `[${timestamp}] ${newNote}\n---\n`;

            data.comments = entry + (data.comments || '');

            // Save to localStorage
            window.saveNonAwardedTracking();

            // Refresh modal to show new note
            document.getElementById('non-awarded-detail-modal')?.remove();
            window.showNonAwardedDetail(supplierName);

            if (window.showToast) window.showToast('Note added', 'success');
        };

        // Clear comment history
        window.clearSupplierComments = function (supplierName) {
            window.showConfirmDialog({
                title: 'Clear History',
                message: 'Are you sure you want to delete all history logs?',
                type: 'warning'
            }).then(confirmed => {
                if (!confirmed) return;

                const data = window.fsState.nonAwardedData?.get(supplierName);
                if (!data) return;

                data.comments = '';

                window.saveNonAwardedTracking();
                document.getElementById('non-awarded-detail-modal')?.remove();
                window.showNonAwardedDetail(supplierName);

                if (window.showToast) window.showToast('History cleared', 'success');
            });
        };

        // Start supplier challenge process
        window.startSupplierChallenge = function (supplierName) {
            const data = window.fsState.nonAwardedData?.get(supplierName);
            if (!data) return;

            // Remove existing modal if any
            document.getElementById('supplier-challenge-modal')?.remove();

            const modal = document.createElement('div');
            modal.id = 'supplier-challenge-modal';
            modal.className = 'rfq-modal-overlay';
            modal.innerHTML = `
                <div class="rfq-modal-container" style="max-width:500px;">
                    <div class="rfq-wizard-header" style="background:#f97316;">
                        <h3 style="color:white; margin:0;">‚ö†Ô∏è Start Supplier Challenge</h3>
                        <button onclick="document.getElementById('supplier-challenge-modal').remove()" class="rfq-btn-close" style="color:white;">&times;</button>
                    </div>
                    <div style="padding:20px;">
                        <p style="margin-top:0; color:#475569; font-size:13px; margin-bottom:16px;">
                            You are about to challenge <strong>${escapeHtml(supplierName)}</strong> regarding their quote.
                            Please provide details for this challenge.
                        </p>

                        <div style="margin-bottom:12px;">
                            <label style="display:block; font-size:12px; font-weight:600; color:#1e293b; margin-bottom:4px;">Challenge Reason <span style="color:red">*</span></label>
                            <select id="challenge-reason" style="width:100%; padding:8px; border:1px solid #cbd5e1; border-radius:4px; font-size:13px;">
                                <option value="Price too high">Price too high</option>
                                <option value="Lead time issues">Lead time issues</option>
                                <option value="Technical Specification">Technical Specification</option>
                                <option value="Wrong MPN/Manufacturer">Wrong MPN/Manufacturer</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div style="margin-bottom:12px;">
                            <label style="display:block; font-size:12px; font-weight:600; color:#1e293b; margin-bottom:4px;">Deadline for Response</label>
                            <input type="date" id="challenge-deadline" style="width:100%; padding:8px; border:1px solid #cbd5e1; border-radius:4px; font-size:13px;">
                        </div>

                        <div style="margin-bottom:20px;">
                            <label style="display:block; font-size:12px; font-weight:600; color:#1e293b; margin-bottom:4px;">Additional Notes</label>
                            <textarea id="challenge-notes" style="width:100%; min-height:80px; padding:8px; border:1px solid #cbd5e1; border-radius:4px; font-size:13px; font-family:inherit; resize:vertical;"></textarea>
                        </div>

                        <div style="display:flex; justify-content:flex-end; gap:8px;">
                            <button onclick="document.getElementById('supplier-challenge-modal').remove()" class="rfq-btn-secondary">Cancel</button>
                            <button onclick="window.submitSupplierChallenge('${escapeHtml(supplierName)}')" class="rfq-btn-primary" style="background:#f97316;">Start Challenge</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Set default deadline to today + 3 days
            const today = new Date();
            today.setDate(today.getDate() + 3);
            document.getElementById('challenge-deadline').valueAsDate = today;
        };

        // Submit challenge
        window.submitSupplierChallenge = function (supplierName) {
            const data = window.fsState.nonAwardedData?.get(supplierName);
            if (!data) return;

            const reason = document.getElementById('challenge-reason').value;
            const deadline = document.getElementById('challenge-deadline').value;
            const notes = document.getElementById('challenge-notes').value;

            if (!reason) {
                if (window.showToast) window.showToast('Please select a reason', 'error');
                return;
            }

            // Update status
            data.notificationStatus = 'challenged';
            data.challengeData = {
                reason: reason,
                deadline: deadline,
                notes: notes,
                startDate: new Date().toISOString(),
                startedBy: 'Current User' // TODO: user
            };

            // Auto-add to comments log
            const challengeComment = `[${new Date().toLocaleDateString()}] Challenge Started: ${reason}\nDeadline: ${deadline}\nNotes: ${notes}\n---\n`;
            data.comments = challengeComment + (data.comments || '');

            // Save
            window.saveNonAwardedTracking();

            // Refresh UI
            document.getElementById('supplier-challenge-modal').remove();

            // Refresh detailed modal if open
            if (document.getElementById('non-awarded-detail-modal')) {
                document.getElementById('non-awarded-detail-modal').remove();
                window.showNonAwardedDetail(supplierName);
            }

            // Refresh list
            if (window.refreshNonAwardedSuppliers) window.refreshNonAwardedSuppliers();

            if (window.showToast) window.showToast(`Challenge started for ${supplierName}`, 'success');
        };

        // Resolve challenge
        window.resolveSupplierChallenge = function (supplierName) {
            const data = window.fsState.nonAwardedData?.get(supplierName);
            if (!data) return;

            window.showConfirmDialog({
                title: 'Resolve Challenge',
                message: `Resolve challenge for ${supplierName}?\nThis will reset status to pending.`,
                type: 'question',
                okText: 'Resolve',
                cancelText: 'Cancel'
            }).then((confirmed) => {
                if (!confirmed) return;

                // Auto-add resolution to comments
                const resolutionComment = `[${new Date().toLocaleDateString()}] Challenge Resolved\n---\n`;
                data.comments = resolutionComment + (data.comments || '');

                // Reset status
                data.notificationStatus = 'pending';
                data.challengeData = null; // Clear active challenge data

                // Save
                window.saveNonAwardedTracking();

                // Refresh UI
                document.getElementById('non-awarded-detail-modal')?.remove();
                window.showNonAwardedDetail(supplierName);

                // Refresh list
                if (window.refreshNonAwardedSuppliers) window.refreshNonAwardedSuppliers();

                if (window.showToast) window.showToast('Challenge resolved', 'success');
            }
            );
        };

        // Show detail for non-awarded supplier
        window.showNonAwardedDetail = function (supplierName) {
            const data = window.fsState.nonAwardedData?.get(supplierName);
            if (!data) return;

            // Get quote numbers as array
            const quoteNumbers = data.quoteNumbers ? Array.from(data.quoteNumbers) : [];
            const quoteNumbersText = quoteNumbers.length > 0
                ? quoteNumbers.map(qn => `<span style="background:#fbbf24; color:#1e293b; padding:2px 8px; border-radius:12px; font-size:10px; font-weight:600; margin-left:6px;">${escapeHtml(qn)}</span>`).join('')
                : '';

            const modal = document.createElement('div');
            modal.id = 'non-awarded-detail-modal';
            modal.className = 'rfq-modal-overlay';
            modal.innerHTML = `
                <div class="rfq-modal-container" style="max-width:1000px; max-height:85vh; display:flex; flex-direction:column;">
                    <div class="rfq-wizard-header" style="background:linear-gradient(135deg,#991b1b,#dc2626);">
                        <div>
                            <h3 style="color:white; margin:0;">üìß Non-Main Supplier</h3>
                            <div style="margin-top:6px; display:flex; align-items:center; gap:8px;">
                                <span style="color:white; font-size:16px; font-weight:800;">${escapeHtml(supplierName)}</span>
                                ${quoteNumbersText}
                                <div style="margin-left:8px;">${window.renderStatusBadge(data.notificationStatus || 'pending')}</div>
                            </div>
                            <span style="color:rgba(255,255,255,0.8); font-size:11px;">${data.items.length} items not awarded as main</span>
                        </div>
                        <button onclick="document.getElementById('non-awarded-detail-modal').remove()" class="rfq-btn-close" style="color:white;">&times;</button>
                    </div>
                    <div style="padding:20px; flex:1; overflow-y:auto;">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px;">
                            <div style="background:#fef2f2; padding:14px; border-radius:10px; text-align:center; border:2px solid #fecaca;">
                                <div style="font-size:24px; font-weight:700; color:#991b1b;">${data.items.length}</div>
                                <div style="font-size:10px; color:#991b1b; text-transform:uppercase;">Items Not Main</div>
                            </div>
                            <div style="background:#f8fafc; padding:14px; border-radius:10px; text-align:center;">
                                <div style="font-size:20px; font-weight:700;">‚Ç¨${data.totalQuoted.toFixed(0)}</div>
                                <div style="font-size:10px; color:#64748b; text-transform:uppercase;">Total Quote Value</div>
                            </div>
                        </div>

                        <div style="font-weight:600; font-size:12px; margin-bottom:10px; color:#475569;">Items where this supplier was not selected as main:</div>
                        <div style="max-height:350px; overflow:auto; border:1px solid #e5e7eb; border-radius:10px;">
                            <table style="width:100%; font-size:10px; border-collapse:collapse;">
                                <thead style="background:#1e293b; color:white; position:sticky; top:0;">
                                    <tr>
                                        <th style="padding:10px 6px; text-align:left;">Drawing No</th>
                                        <th style="padding:10px 6px; text-align:left;">Description</th>
                                        <th style="padding:10px 6px; text-align:left;">Manufacturer</th>
                                        <th style="padding:10px 6px; text-align:left;">MPN</th>
                                        <th style="padding:10px 6px; text-align:right;">Their Quote</th>
                                        <th style="padding:10px 6px; text-align:left;">Main Supplier</th>
                                        <th style="padding:10px 6px; text-align:right;">Main Price</th>
                                        <th style="padding:10px 6px; text-align:right;">Difference</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.items.map((item, i) => {
                const diff = item.price - item.awarded_price;
                const diffPercent = item.awarded_price > 0 ? ((diff / item.awarded_price) * 100).toFixed(1) : 0;
                const diffColor = diff > 0 ? '#dc2626' : '#16a34a';
                return `
                                            <tr style="background:${i % 2 === 0 ? '#fff' : '#f8fafc'};">
                                                <td style="padding:8px 6px;">
                                                    <a href="#" onclick="event.preventDefault(); document.getElementById('non-awarded-detail-modal')?.remove(); window.navigateToItem('${escapeHtml(item.drawing_no)}'); return false;" 
                                                       style="font-weight:600; color:#3b82f6; text-decoration:none; cursor:pointer;">
                                                        ${escapeHtml(item.drawing_no)}
                                                    </a>
                                                </td>
                                                <td style="padding:8px 6px; max-width:120px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${escapeHtml(item.description || '')}">${escapeHtml(item.description || '‚Äî')}</td>
                                                <td style="padding:8px 6px; color:#64748b;">${escapeHtml(item.manufacturer || '‚Äî')}</td>
                                                <td style="padding:8px 6px; color:#64748b;">${escapeHtml(item.mpn || '‚Äî')}</td>
                                                <td style="padding:8px 6px; text-align:right; color:#991b1b; font-weight:600;">‚Ç¨${item.price.toFixed(2)}</td>
                                                <td style="padding:8px 6px; color:#16a34a;">${escapeHtml(item.awarded_to)}</td>
                                                <td style="padding:8px 6px; text-align:right; color:#16a34a; font-weight:600;">‚Ç¨${item.awarded_price.toFixed(2)}</td>
                                                <td style="padding:8px 6px; text-align:right; color:${diffColor}; font-weight:600;">${diff > 0 ? '+' : ''}‚Ç¨${diff.toFixed(2)} (${diffPercent}%)</td>
                                            </tr>
                                        `;
            }).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Notification Tracking Section -->
                        <div style="margin-top:24px; background:#f8fafc; border-radius:12px; padding:20px; border:2px solid #e2e8f0;">
                            <h4 style="margin:0 0 16px 0; font-size:14px; font-weight:700; color:#1e293b; display:flex; align-items:center; gap:8px;">
                                üìã Notification Tracking
                                ${window.renderStatusBadge(data.notificationStatus || 'pending')}
                            </h4>
                            
                            ${data.notificationStatus === 'notified' && data.notifiedDate ? `
                                <div style="background:white; padding:12px; border-radius:8px; margin-bottom:12px; border-left:4px solid #16a34a;">
                                    <div style="font-size:12px; color:#64748b; margin-bottom:4px;">Notified On</div>
                                    <div style="font-size:13px; font-weight:600; color:#1e293b;">
                                        ${new Date(data.notifiedDate).toLocaleString('en-GB', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })}
                                        ${data.notifiedBy ? ` ‚Ä¢ by ${escapeHtml(data.notifiedBy)}` : ''}
                                    </div>
                                </div>
                            ` : ''}

                            ${data.notificationStatus === 'challenged' && data.challengeData ? `
                                <div style="background:#fff7ed; padding:12px; border-radius:8px; margin-bottom:12px; border-left:4px solid #f97316; border:1px solid #ffedd5; border-left-width:4px;">
                                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                                        <div style="font-weight:700; color:#9a3412; font-size:13px;">‚ö†Ô∏è Active Challenge</div>
                                        <div style="font-size:11px; color:#c2410c;">Since ${new Date(data.challengeData.startDate).toLocaleDateString()}</div>
                                    </div>
                                    <div style="font-size:12px; margin-bottom:4px;"><strong style="color:#7c2d12;">Reason:</strong> ${escapeHtml(data.challengeData.reason)}</div>
                                    <div style="font-size:12px; margin-bottom:4px;"><strong style="color:#7c2d12;">Deadline:</strong> ${data.challengeData.deadline || 'No deadline'}</div>
                                    ${data.challengeData.notes ? `<div style="font-size:12px; background:rgba(255,255,255,0.5); padding:6px; margin-top:6px; border-radius:4px;">${escapeHtml(data.challengeData.notes)}</div>` : ''}
                                    
                                    <button onclick="window.resolveSupplierChallenge('${escapeHtml(supplierName)}')" 
                                        style="margin-top:8px; font-size:11px; padding:4px 10px; background:#fff; border:1px solid #fb923c; color:#ea580c; border-radius:4px; cursor:pointer; font-weight:600;">
                                        Resolve Challenge
                                    </button>
                                </div>
                            ` : ''}
                            
                            
                            <div style="margin-bottom:12px;">
                                <label style="display:block; font-size:12px; font-weight:600; color:#64748b; margin-bottom:6px;">History Log</label>
                                <div id="comments-history" style="max-height:150px; overflow-y:auto; background:#f1f5f9; border:1px solid #e2e8f0; border-radius:6px; padding:8px; margin-bottom:8px;">
                                    ${(data.comments || '').split('\n---\n').filter(c => c.trim()).map(c => `
                                        <div style="background:white; padding:8px; border-radius:4px; margin-bottom:6px; font-size:12px; border-left:3px solid #64748b;">
                                            ${escapeHtml(c).replace(/\n/g, '<br>')}
                                        </div>
                                    `).join('') || '<div style="color:#94a3b8; font-size:11px; text-align:center; padding:10px;">No history yet</div>'}
                                </div>

                                <div style="display:flex; gap:6px;">
                                    <textarea 
                                        id="new-comment-text" 
                                        style="flex:1; height:36px; padding:6px; border:1px solid #cbd5e1; border-radius:4px; font-size:12px; font-family:inherit; resize:none;"
                                        placeholder="Type a new note..."
                                    ></textarea>
                                    <button 
                                        onclick="window.addSupplierComment('${escapeHtml(supplierName)}')" 
                                        class="rfq-btn-secondary" 
                                        style="padding:0 12px; font-size:12px;"
                                        title="Add Note"
                                    >‚ûï</button>
                                </div>
                                <div style="text-align:right; margin-top:4px;">
                                     <button onclick="window.clearSupplierComments('${escapeHtml(supplierName)}')" style="background:none; border:none; color:#ef4444; font-size:10px; cursor:pointer; text-decoration:underline;">Clear History</button>
                                </div>
                            </div>
                            
                            <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                ${data.notificationStatus !== 'notified' ? `
                                    <button 
                                        onclick="window.markSupplierNotified('${escapeHtml(supplierName)}')" 
                                        class="rfq-btn-primary" 
                                        style="background:#16a34a; font-size:12px; padding:8px 14px;"
                                    >
                                        ‚úÖ Mark as Notified
                                    </button>
                                ` : `
                                    <button 
                                        onclick="window.resetNotificationStatus('${escapeHtml(supplierName)}')" 
                                        class="rfq-btn-secondary" 
                                        style="font-size:12px; padding:8px 14px;"
                                    >
                                        üîÑ Reset Status
                                    </button>
                                `}
                                <button 
                                    onclick="window.startSupplierChallenge('${escapeHtml(supplierName)}')" 
                                    class="rfq-btn-secondary" 
                                    style="font-size:12px; padding:8px 14px;"
                                >
                                    ‚ö†Ô∏è Start Challenge
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="rfq-wizard-footer">
                        <button onclick="window.showExportOptionsDialog('${escapeHtml(supplierName)}')" class="rfq-btn-secondary">üìä Export</button>
                        <button onclick="window.showExportOptionsDialog('${escapeHtml(supplierName)}', true)" class="rfq-btn-danger" style="background:#dc2626;">üìß Generate Notification</button>
                        <button onclick="document.getElementById('non-awarded-detail-modal').remove()" class="rfq-btn-secondary">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        };

        // Show export options dialog - choose what to include in export
        window.showExportOptionsDialog = function (supplierName, isNotification = false) {
            const data = window.fsState.nonAwardedData?.get(supplierName);
            if (!data || data.items.length === 0) {
                if (window.showToast) window.showToast('No items found for this supplier', 'warning');
                return;
            }

            const modal = document.createElement('div');
            modal.id = 'export-options-modal';
            modal.className = 'rfq-modal-overlay';
            modal.innerHTML = `
                <div class="rfq-modal-container" style="max-width:550px;">
                    <div class="rfq-wizard-header" style="background:linear-gradient(135deg,${isNotification ? '#dc2626,#ef4444' : '#3b82f6,#60a5fa'});">
                        <div>
                            <h3 style="color:white; margin:0;">${isNotification ? 'üìß Notification' : 'üìä Export'} Options</h3>
                            <span style="color:rgba(255,255,255,0.8); font-size:11px;">Choose what information to include</span>
                        </div>
                        <button onclick="document.getElementById('export-options-modal').remove()" class="rfq-btn-close" style="color:white;">&times;</button>
                    </div>
                    <div style="padding:24px;">
                        <div style="margin-bottom:20px;">
                            <div style="font-weight:600; font-size:13px; margin-bottom:12px; color:#1e293b;">Export Type:</div>
                            <div style="display:flex; gap:12px;">
                                <label style="flex:1; cursor:pointer;">
                                    <input type="radio" name="export-type" value="internal" checked style="margin-right:6px;">
                                    <span style="font-size:12px; font-weight:600; color:#3b82f6;">üìÅ Internal Use</span>
                                    <div style="font-size:10px; color:#64748b; margin-left:22px; margin-top:4px;">Include all details (Main Supplier, prices, etc.)</div>
                                </label>
                                <label style="flex:1; cursor:pointer;">
                                    <input type="radio" name="export-type" value="supplier" style="margin-right:6px;">
                                    <span style="font-size:12px; font-weight:600; color:#dc2626;">üì§ For Supplier</span>
                                    <div style="font-size:10px; color:#64748b; margin-left:22px; margin-top:4px;">Limited info (no competitor details)</div>
                                </label>
                            </div>
                        </div>

                        <div style="background:#f8fafc; padding:16px; border-radius:10px; border:1px solid #e2e8f0;">
                            <div style="font-weight:600; font-size:12px; margin-bottom:10px; color:#475569;">Fields to Include:</div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:11px;">
                                <label style="display:flex; align-items:center; cursor:pointer;">
                                    <input type="checkbox" class="export-field" value="drawing_no" checked disabled style="margin-right:6px;">
                                    <span>Drawing No</span>
                                </label>
                                <label style="display:flex; align-items:center; cursor:pointer;">
                                    <input type="checkbox" class="export-field" value="description" checked style="margin-right:6px;">
                                    <span>Description</span>
                                </label>
                                <label style="display:flex; align-items:center; cursor:pointer;">
                                    <input type="checkbox" class="export-field" value="manufacturer" checked style="margin-right:6px;">
                                    <span>Manufacturer</span>
                                </label>
                                <label style="display:flex; align-items:center; cursor:pointer;">
                                    <input type="checkbox" class="export-field" value="mpn" checked style="margin-right:6px;">
                                    <span>MPN</span>
                                </label>
                                <label style="display:flex; align-items:center; cursor:pointer;">
                                    <input type="checkbox" class="export-field" value="their_quote" checked style="margin-right:6px;">
                                    <span>Their Quote</span>
                                </label>
                                <label style="display:flex; align-items:center; cursor:pointer;" id="main-supplier-option">
                                    <input type="checkbox" class="export-field" value="main_supplier" checked style="margin-right:6px;">
                                    <span>Main Supplier</span>
                                </label>
                                <label style="display:flex; align-items:center; cursor:pointer;" id="main-price-option">
                                    <input type="checkbox" class="export-field" value="main_price" checked style="margin-right:6px;">
                                    <span>Main Price</span>
                                </label>
                                <label style="display:flex; align-items:center; cursor:pointer;" id="difference-option">
                                    <input type="checkbox" class="export-field" value="difference" checked style="margin-right:6px;">
                                    <span>Difference</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="rfq-wizard-footer">
                        <button onclick="document.getElementById('export-options-modal').remove()" class="rfq-btn-secondary">Cancel</button>
                        <button onclick="window.executeExport('${escapeHtml(supplierName)}', ${isNotification})" class="rfq-btn-primary" style="background:${isNotification ? '#dc2626' : '#3b82f6'};">
                            ${isNotification ? 'üìß Continue to Notification' : 'üìä Export to Excel'}
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Handle export type change
            const radios = modal.querySelectorAll('input[name="export-type"]');
            radios.forEach(radio => {
                radio.addEventListener('change', function () {
                    const isSupplier = this.value === 'supplier';
                    const mainSupplierOpt = modal.querySelector('#main-supplier-option input');
                    const mainPriceOpt = modal.querySelector('#main-price-option input');
                    const differenceOpt = modal.querySelector('#difference-option input');

                    if (isSupplier) {
                        // For supplier export, uncheck and disable competitor info
                        mainSupplierOpt.checked = false;
                        mainPriceOpt.checked = false;
                        differenceOpt.checked = false;
                        mainSupplierOpt.disabled = true;
                        mainPriceOpt.disabled = true;
                        differenceOpt.disabled = true;
                        modal.querySelector('#main-supplier-option').style.opacity = '0.5';
                        modal.querySelector('#main-price-option').style.opacity = '0.5';
                        modal.querySelector('#difference-option').style.opacity = '0.5';
                    } else {
                        // For internal export, enable all fields
                        mainSupplierOpt.disabled = false;
                        mainPriceOpt.disabled = false;
                        differenceOpt.disabled = false;
                        mainSupplierOpt.checked = true;
                        mainPriceOpt.checked = true;
                        differenceOpt.checked = true;
                        modal.querySelector('#main-supplier-option').style.opacity = '1';
                        modal.querySelector('#main-price-option').style.opacity = '1';
                        modal.querySelector('#difference-option').style.opacity = '1';
                    }
                });
            });
        };

        // Execute export based on selected options
        window.executeExport = function (supplierName, isNotification) {
            const modal = document.getElementById('export-options-modal');
            if (!modal) return;

            // Get selected fields
            const selectedFields = {};
            modal.querySelectorAll('.export-field:checked').forEach(cb => {
                selectedFields[cb.value] = true;
            });

            // Store selected fields for use in export/notification
            window.fsState.exportOptions = selectedFields;

            modal.remove();

            if (isNotification) {
                // Continue to notification with selected fields
                window.sendLoserNotification(supplierName);
                document.getElementById('non-awarded-detail-modal')?.remove();
            } else {
                // Export to Excel with selected fields
                window.exportNonAwardedDetail(supplierName);
            }
        };

        // Export non-awarded supplier detail
        window.exportNonAwardedDetail = function (supplierName) {
            const data = window.fsState.nonAwardedData?.get(supplierName);
            if (!data) return;

            const options = window.fsState.exportOptions || {};

            const exportData = data.items.map(item => {
                const row = {};

                // Always include Drawing No (it's disabled in the dialog)
                row['Drawing No'] = item.drawing_no;

                if (options.description) row['Description'] = item.description || '';
                if (options.manufacturer) row['Manufacturer'] = item.manufacturer || '';
                if (options.mpn) row['MPN'] = item.mpn || '';
                if (options.their_quote) row['Their Quote'] = '‚Ç¨' + item.price.toFixed(2);
                if (options.main_supplier) row['Main Supplier'] = item.awarded_to;
                if (options.main_price) row['Main Price'] = '‚Ç¨' + item.awarded_price.toFixed(2);
                if (options.difference) row['Difference'] = '‚Ç¨' + (item.price - item.awarded_price).toFixed(2);

                return row;
            });

            exportDocToExcel(`NonAwarded_${supplierName.replace(/[^a-zA-Z0-9]/g, '_')}`, exportData, data.totalQuoted);
            if (window.showToast) showToast('Exported non-awarded detail', 'success');

            // Clear export options after use
            window.fsState.exportOptions = null;
        };

        // Send loser notification - open modal with custom text and ODF generation
        window.sendLoserNotification = function (supplierName) {

            if (window.fsState && window.fsState.nonAwardedData) {
            }

            let data = window.fsState.nonAwardedData?.get(supplierName);

            // Robust lookup: Try case-insensitive and trimmed match
            if (!data && window.fsState.nonAwardedData) {
                const target = String(supplierName).trim().toLowerCase();
                for (const [key, val] of window.fsState.nonAwardedData.entries()) {
                    const keyNorm = String(key).trim().toLowerCase();
                    if (keyNorm === target) {
                        data = val;
                        break;
                    }
                }
            }

            if (!data || data.items.length === 0) {
                // Dump all keys for debugging
                if (window.fsState && window.fsState.nonAwardedData) {
                    window.fsState.nonAwardedData.forEach((v, k) => {
                        console.log(`Key: "${k}", Items: ${v?.items?.length}`);
                    });
                }

                if (window.showToast) window.showToast(`No items found for ${supplierName}`, 'warning');
                return;
            }


            const modal = document.createElement('div');
            modal.id = 'loser-notification-modal';
            modal.className = 'rfq-modal-overlay';

            // Default notification text
            const projectName = (data.items[0]?.project_name) || currentProject?.name || 'Project';
            const defaultText = `Dear ${supplierName},

Thank you for your quotation for project "${projectName}". Unfortunately, we have decided to proceed with other suppliers for these parts.

We appreciate your time and effort in preparing the quotation (Quote Ref: ${data.items[0]?.quote_ref || 'N/A'}) and hope to work with you on future opportunities.

Best regards`;

            modal.innerHTML = `
                <div class="rfq-modal-container" style="max-width:850px; max-height:90vh; display:flex; flex-direction:column;">
                    <div class="rfq-wizard-header" style="background:linear-gradient(135deg,#dc2626,#ef4444);">
                        <div style="flex:1;">
                            <h3 style="color:white; margin:0; display:flex; align-items:center; gap:8px;">
                                üìß Generate Notification 
                                <span style="font-size:12px; font-weight:400; background:rgba(255,255,255,0.2); padding:2px 8px; border-radius:12px;">
                                    ${escapeHtml(projectName)}
                                </span>
                            </h3>
                            <span style="color:rgba(255,255,255,0.8); font-size:12px;">${escapeHtml(supplierName)} - ${data.items.length} items not awarded</span>
                        </div>
                        <button onclick="document.getElementById('loser-notification-modal').remove()" class="rfq-btn-close" style="color:white;">&times;</button>
                    </div>
                    <div style="padding:20px; flex:1; overflow-y:auto;" id="notification-print-area">
                        <div style="margin-bottom:16px;">
                            <label style="display:block; font-weight:600; font-size:12px; margin-bottom:6px; color:#475569;">Notification Message:</label>
                            <textarea id="notification-text" style="width:100%; min-height:150px; padding:12px; border:1px solid #d1d5db; border-radius:8px; font-size:12px; font-family:inherit; resize:vertical;">${defaultText}</textarea>
                        </div>
                        
                        <div style="background:#f8fafc; padding:0; border-radius:10px; border:1px solid #e2e8f0; margin-bottom:16px; overflow:hidden;">
                            <div style="padding:10px 14px; background:#f1f5f9; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
                                <div style="font-weight:600; font-size:11px; color:#475569;">Items Not Awarded (${data.items.length})</div>
                            </div>
                            <div style="max-height:250px; overflow-y:auto; overflow-x:auto;">
                                <table style="width:100%; border-collapse:collapse; font-size:10px;">
                                    <thead style="background:#fff; position:sticky; top:0;">
                                        <tr>
                                            ${(() => {
                    const opts = window.fsState?.exportOptions || {};
                    const hasOptions = Object.keys(opts).length > 0;
                    let headers = '';
                    // Drawing No is always shown
                    headers += '<th style="text-align:left; padding:6px 10px; color:#64748b; font-weight:600; border-bottom:1px solid #e2e8f0; white-space:nowrap;">Drawing No</th>';
                    // When hasOptions, show only if explicitly true; otherwise show all
                    if (!hasOptions || opts.description === true) headers += '<th style="text-align:left; padding:6px 10px; color:#64748b; font-weight:600; border-bottom:1px solid #e2e8f0;">Description</th>';
                    if (!hasOptions || opts.manufacturer === true) headers += '<th style="text-align:left; padding:6px 10px; color:#64748b; font-weight:600; border-bottom:1px solid #e2e8f0;">Manufacturer</th>';
                    if (!hasOptions || opts.mpn === true) headers += '<th style="text-align:left; padding:6px 10px; color:#64748b; font-weight:600; border-bottom:1px solid #e2e8f0;">MPN</th>';
                    if (!hasOptions || opts.their_quote === true) headers += '<th style="text-align:right; padding:6px 10px; color:#64748b; font-weight:600; border-bottom:1px solid #e2e8f0; white-space:nowrap;">Your Quote</th>';
                    if (!hasOptions || opts.main_supplier === true) headers += '<th style="text-align:left; padding:6px 10px; color:#64748b; font-weight:600; border-bottom:1px solid #e2e8f0; white-space:nowrap;">Awarded To</th>';
                    if (!hasOptions || opts.difference === true) headers += '<th style="text-align:right; padding:6px 10px; color:#64748b; font-weight:600; border-bottom:1px solid #e2e8f0; white-space:nowrap;">Difference</th>';
                    console.log('[Table] Building headers with options:', opts, 'hasOptions:', hasOptions);
                    return headers;
                })()}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.items.map(item => {
                    const opts = window.fsState?.exportOptions || {};
                    const hasOptions = Object.keys(opts).length > 0;
                    let cells = '';
                    cells += `<td style="padding:6px 10px; font-weight:600; color:#3b82f6;">${escapeHtml(item.drawing_no)}</td>`;
                    if (!hasOptions || opts.description === true) cells += `<td style="padding:6px 10px; color:#334155;">${escapeHtml(item.description || '‚Äî')}</td>`;
                    if (!hasOptions || opts.manufacturer === true) cells += `<td style="padding:6px 10px; color:#334155;">${escapeHtml(item.manufacturer || '‚Äî')}</td>`;
                    if (!hasOptions || opts.mpn === true) cells += `<td style="padding:6px 10px; color:#334155;">${escapeHtml(item.mpn || '‚Äî')}</td>`;
                    if (!hasOptions || opts.their_quote === true) cells += `<td style="padding:6px 10px; text-align:right; color:#ef4444;">${escapeHtml(item.your_quote)}</td>`;
                    if (!hasOptions || opts.main_supplier === true) cells += `<td style="padding:6px 10px; color:#64748b;">${escapeHtml(item.awarded_to)}</td>`;
                    if (!hasOptions || opts.difference === true) cells += `<td style="padding:6px 10px; text-align:right; color:${parseFloat(item.price_difference) > 0 ? '#ef4444' : '#10b981'};">${item.price_difference !== '‚Äî' ? '‚Ç¨' + item.price_difference : '‚Äî'}</td>`;
                    return `<tr style="border-bottom:1px solid #f1f5f9;">${cells}</tr>`;
                }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div style="display:flex; gap:8px; margin-top:20px; border-top:1px solid #e5e7eb; padding-top:20px; flex-wrap:wrap;">
                            <button onclick="document.getElementById('loser-notification-modal').remove(); window.showNonAwardedDetail('${escapeHtml(supplierName)}');" class="rfq-btn-secondary" style="flex:1; min-width:120px; display:flex; align-items:center; justify-content:center; gap:6px;">
                                ‚¨ÖÔ∏è Back to Supplier
                            </button>
                            <button onclick="document.getElementById('loser-notification-modal').remove(); window.markSupplierNotified('${escapeHtml(supplierName)}');" class="rfq-btn-primary" style="flex:1; min-width:140px; display:flex; align-items:center; justify-content:center; gap:6px; background:#16a34a;">
                                ‚úÖ Back & Mark Notified
                            </button>
                            <div style="width:100%; height:1px; background:#e5e7eb; margin:8px 0;"></div>
                            <button id="btn-export-excel" onclick="console.log('[Inline] Excel clicked'); window.exportNotificationExcel('${escapeHtml(supplierName)}', window.fsState.nonAwardedData?.get('${escapeHtml(supplierName)}'));" class="rfq-btn-secondary" style="flex:1; min-width:120px; display:flex; align-items:center; justify-content:center; gap:6px;">
                                üìä Excel
                            </button>
                            <button id="btn-export-pdf" class="rfq-btn-secondary" style="flex:1; min-width:120px; display:flex; align-items:center; justify-content:center; gap:6px;">
                                üìÑ PDF
                            </button>
                            <button id="btn-export-word" class="rfq-btn-secondary" style="flex:1; min-width:120px; display:flex; align-items:center; justify-content:center; gap:6px;">
                                üìù Word
                            </button>
                            <button id="btn-export-outlook" class="rfq-btn-secondary" style="flex:1; min-width:120px; display:flex; align-items:center; justify-content:center; gap:6px;">
                                üìß Outlook
                            </button>
                             <button id="btn-print" class="rfq-btn-secondary" style="flex:1; min-width:120px; display:flex; align-items:center; justify-content:center; gap:6px;">
                                üñ®Ô∏è Print
                            </button>
                            <button id="btn-exit-modal" class="rfq-btn-secondary" style="flex:1; min-width:120px; display:flex; align-items:center; justify-content:center; gap:6px; background:#dc2626; color:white; border-color:#dc2626;">
                                ‚ùå EXIT
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Bind Events with debug logging
            console.log('[Modal] Setting up event listeners...');
            const excelBtn = document.getElementById('btn-export-excel');
            console.log('[Modal] Excel button found:', !!excelBtn);
            if (excelBtn) {
                console.log('[Modal] Excel button element:', excelBtn);
                console.log('[Modal] Button disabled?', excelBtn.disabled);
                console.log('[Modal] Button style:', window.getComputedStyle(excelBtn).pointerEvents);

                // Use addEventListener instead of onclick
                excelBtn.addEventListener('click', function (e) {
                    console.log('[Modal] Excel button clicked! Event:', e);
                    console.log('[Modal] Calling exportNotificationExcel with:', supplierName, data);
                    console.log('[Modal] exportNotificationExcel exists:', typeof window.exportNotificationExcel);
                    e.preventDefault();
                    e.stopPropagation();
                    try {
                        window.exportNotificationExcel(supplierName, data);
                    } catch (error) {
                        console.error('[Modal] Error calling exportNotificationExcel:', error);
                        if (window.showToast) showToast('Error: ' + error.message, 'error');
                    }
                }, { capture: true });
            }
            document.getElementById('btn-export-pdf').onclick = () => window.exportNotificationPDF(supplierName, data);
            document.getElementById('btn-export-word').onclick = () => window.exportToWord(supplierName, data);
            document.getElementById('btn-export-outlook').onclick = () => window.sendOutlookEmail(supplierName, data, defaultText);
            document.getElementById('btn-print').onclick = () => window.printNotification(supplierName, data);
            document.getElementById('btn-exit-modal').onclick = () => {
                const modal = document.getElementById('loser-notification-modal');
                if (modal) modal.remove();
            };
            console.log('[Modal] Event listeners set up complete');

        };

        // NEW: Send via Outlook (mailto)
        window.sendOutlookEmail = function (supplier, data, bodyText) {
            const projectName = (data.items[0]?.project_name) || 'RFQ';
            const subject = `Notification for Project: ${projectName} - ${supplier}`;
            const body = encodeURIComponent(bodyText);

            // Mailto link
            window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${body}`;

            if (window.showToast) showToast('Opened default mail client', 'info');

            // Notification tracking integration with Custom Dialog
            if (window.showConfirmDialog) {
                setTimeout(() => {
                    window.showConfirmDialog(
                        'Confirm Notification',
                        `Did you send the notification to ${supplier}?\nMark as 'Notified' now?`,
                        () => {
                            window.markSupplierNotified(supplier);
                            // Refresh list immediately
                            if (window.refreshNonAwardedSuppliers) window.refreshNonAwardedSuppliers();
                        }
                    );
                }, 1000);
            }
        };



        // NEW: Export to Word (HTML)
        window.exportToWord = function (supplier, data) {
            const projectName = (data.items[0]?.project_name) || currentProject?.name || 'Project';
            const quoteNumber = (data.items[0]?.quote_ref) || 'N/A';
            const notificationText = document.getElementById('notification-text')?.value || '';
            const opts = window.fsState?.exportOptions || {};
            const hasOptions = Object.keys(opts).length > 0;

            // Build column configuration
            const columnConfig = [];
            columnConfig.push({ header: 'Drawing No', key: 'drawing_no' });
            if (!hasOptions || opts.description === true) columnConfig.push({ header: 'Description', key: 'description' });
            if (!hasOptions || opts.manufacturer === true) columnConfig.push({ header: 'Manufacturer', key: 'manufacturer' });
            if (!hasOptions || opts.mpn === true) columnConfig.push({ header: 'MPN', key: 'mpn' });
            if (!hasOptions || opts.their_quote === true) columnConfig.push({ header: 'Your Quote', key: 'your_quote' });
            if (!hasOptions || opts.main_supplier === true) columnConfig.push({ header: 'Awarded To', key: 'awarded_to' });
            if (!hasOptions || opts.difference === true) columnConfig.push({ header: 'Price Difference', key: 'price_difference' });

            const tableHeaders = columnConfig.map(col => `<th>${col.header}</th>`).join('');
            const tableRows = data.items.map(item => {
                const cells = columnConfig.map(col => {
                    let value = item[col.key] || '‚Äî';
                    if (col.key === 'price_difference' && value !== '‚Äî') {
                        value = '‚Ç¨' + value;
                    }
                    return `<td>${value}</td>`;
                }).join('');
                return `<tr>${cells}</tr>`;
            }).join('');

            const content = `
                <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                <head><meta charset='utf-8'><title>Notification</title></head>
                <body style="font-family:Arial, sans-serif;">
                    <h2>Notification for ${supplier}</h2>
                    <p><strong>Project:</strong> ${projectName}</p>
                    <p><strong>Quote Number:</strong> ${quoteNumber}</p>
                    <p><strong>Supplier:</strong> ${supplier}</p>
                    <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                    <hr/>
                    <h3>Message:</h3>
                    <p style="white-space:pre-wrap;">${notificationText || 'No message provided.'}</p>
                    <hr/>
                    <table border="1" cellpadding="5" cellspacing="0" style="border-collapse:collapse; width:100%;">
                        <thead style="background:#f0f0f0;">
                            <tr>${tableHeaders}</tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </body>
                </html>
             `;

            const blob = new Blob(['\ufeff', content], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Notification_${supplier}_${projectName}.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            if (window.showToast) showToast('Word document downloaded', 'success');
        };

        // NEW: Print Notification
        window.printNotification = function (supplier, data) {
            const projectName = (data.items[0]?.project_name) || currentProject?.name || 'Project';
            const quoteNumber = (data.items[0]?.quote_ref) || 'N/A';
            const notificationText = document.getElementById('notification-text')?.value || '';

            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                if (window.showToast) showToast('Please allow popups for printing', 'error');
                return;
            }

            const opts = window.fsState?.exportOptions || {};
            const hasOptions = Object.keys(opts).length > 0;

            // Build column configuration
            const columnConfig = [];
            columnConfig.push({ header: 'Drawing No', key: 'drawing_no' });
            if (!hasOptions || opts.description === true) columnConfig.push({ header: 'Description', key: 'description' });
            if (!hasOptions || opts.manufacturer === true) columnConfig.push({ header: 'Manufacturer', key: 'manufacturer' });
            if (!hasOptions || opts.mpn === true) columnConfig.push({ header: 'MPN', key: 'mpn' });
            if (!hasOptions || opts.their_quote === true) columnConfig.push({ header: 'Your Quote', key: 'your_quote' });
            if (!hasOptions || opts.main_supplier === true) columnConfig.push({ header: 'Awarded To', key: 'awarded_to' });
            if (!hasOptions || opts.difference === true) columnConfig.push({ header: 'Difference', key: 'price_difference' });

            const tableHeaders = columnConfig.map(col => `<th>${col.header}</th>`).join('');
            const tableRows = data.items.map(item => {
                const cells = columnConfig.map(col => {
                    let value = item[col.key] || '‚Äî';
                    if (col.key === 'price_difference' && value !== '‚Äî') {
                        value = '‚Ç¨' + value;
                    }
                    return `<td>${value}</td>`;
                }).join('');
                return `<tr>${cells}</tr>`;
            }).join('');

            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Notification - ${supplier}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h2 { color: #dc2626; margin-bottom: 15px; }
                        .meta { margin-bottom: 20px; font-size: 14px; }
                        .meta p { margin: 5px 0; }
                        .message { background: #fffbeb; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b; }
                        .message h3 { font-size: 14px; margin-bottom: 10px; color: #92400e; }
                        .message p { font-size: 12px; white-space: pre-wrap; color: #78350f; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 10px; }
                        th { background: #1e293b; color: white; padding: 8px 6px; text-align: left; }
                        td { padding: 6px; border-bottom: 1px solid #e2e8f0; }
                        tr:nth-child(even) { background: #f8fafc; }
                        @media print {
                            body { padding: 10px; }
                        }
                    </style>
                </head>
                <body>
                    <h2>Notification for ${supplier}</h2>
                    <div class="meta">
                        <p><strong>Project:</strong> ${projectName}</p>
                        <p><strong>Quote Number:</strong> ${quoteNumber}</p>
                        <p><strong>Supplier:</strong> ${supplier}</p>
                        <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                    </div>
                    <div class="message">
                        <h3>Notification Message</h3>
                        <p>${notificationText || 'No message provided.'}</p>
                    </div>
                    <table>
                        <thead>
                            <tr>${tableHeaders}</tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                    <script>window.onload = function() { window.print(); window.onafterprint = function() { window.close(); }; };</script>
                </body>
                </html>
            `);
            printWindow.document.close();
        };

        // NEW: Export Notification to Excel
        window.exportNotificationExcel = function (supplier, data) {
            console.log('[Excel Export] Starting...', { supplier, data });

            if (typeof XLSX === 'undefined') {
                console.error('[Excel Export] XLSX library not loaded!');
                if (window.showToast) showToast('Excel library not loaded. Please refresh the page.', 'error');
                return;
            }

            try {
                const projectName = (data.items[0]?.project_name) || currentProject?.name || 'Project';
                const quoteNumber = (data.items[0]?.quote_ref) || 'N/A';
                const notificationText = document.getElementById('notification-text')?.value || '';
                const opts = window.fsState?.exportOptions || {};
                const hasOptions = Object.keys(opts).length > 0;

                console.log('[Excel Export] Project name:', projectName);
                console.log('[Excel Export] Selected columns:', opts, 'hasOptions:', hasOptions);

                // Build headers and data based on selected columns
                const columnConfig = [];

                columnConfig.push({ header: 'Drawing No', key: 'drawing_no' });
                if (!hasOptions || opts.description === true) columnConfig.push({ header: 'Description', key: 'description' });
                if (!hasOptions || opts.manufacturer === true) columnConfig.push({ header: 'Manufacturer', key: 'manufacturer' });
                if (!hasOptions || opts.mpn === true) columnConfig.push({ header: 'MPN', key: 'mpn' });
                if (!hasOptions || opts.their_quote === true) columnConfig.push({ header: 'Your Quote', key: 'your_quote' });
                if (!hasOptions || opts.main_supplier === true) columnConfig.push({ header: 'Awarded To', key: 'awarded_to' });
                if (!hasOptions || opts.main_price === true) columnConfig.push({ header: 'Awarded Price', key: 'awarded_price' });
                if (!hasOptions || opts.difference === true) columnConfig.push({ header: 'Price Difference', key: 'price_difference' });

                const exportData = data.items.map(item => {
                    const row = {};
                    columnConfig.forEach(col => {
                        let value = item[col.key] || '‚Äî';
                        if (col.key === 'price_difference' && value !== '‚Äî') {
                            value = '‚Ç¨' + value;
                        }
                        row[col.header] = value;
                    });
                    return row;
                });

                // Use the existing exportDocToExcel function pattern
                const wb = XLSX.utils.book_new();
                const headerRows = [
                    [`NOTIFICATION - ${supplier}`],
                    [''],
                    ['Project:', projectName],
                    ['Quote Number:', quoteNumber],
                    ['Date:', new Date().toLocaleDateString()],
                    ['Supplier:', supplier],
                    [''],
                    ['Message:'],
                    [notificationText],
                    ['']
                ];

                const headers = Object.keys(exportData[0] || {});
                const dataRows = exportData.map(row => headers.map(h => row[h]));
                const allRows = [...headerRows, headers, ...dataRows];

                const ws = XLSX.utils.aoa_to_sheet(allRows);
                ws['!cols'] = headers.map(() => ({ wch: 14 }));
                XLSX.utils.book_append_sheet(wb, ws, 'Notification');
                XLSX.writeFile(wb, `Notification_${supplier}_${projectName}.xlsx`);

                console.log('[Excel Export] Complete!');
                if (window.showToast) showToast('Excel file downloaded', 'success');
            } catch (error) {
                console.error('[Excel Export] Error:', error);
                if (window.showToast) showToast('Excel export failed: ' + error.message, 'error');
            }
        };

        // NEW: Export Notification to PDF
        window.exportNotificationPDF = function (supplier, data) {
            const projectName = (data.items[0]?.project_name) || currentProject?.name || 'Project';
            const quoteNumber = (data.items[0]?.quote_ref) || 'N/A';
            const notificationText = document.getElementById('notification-text')?.value || '';

            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                if (window.showToast) showToast('Please allow popups for PDF export', 'error');
                return;
            }


            const opts = window.fsState?.exportOptions || {};
            const hasOptions = Object.keys(opts).length > 0;

            // Build column configuration based on selected options
            const columnConfig = [];
            columnConfig.push({ header: 'Drawing No', key: 'drawing_no' });
            if (!hasOptions || opts.description === true) columnConfig.push({ header: 'Description', key: 'description' });
            if (!hasOptions || opts.manufacturer === true) columnConfig.push({ header: 'Manufacturer', key: 'manufacturer' });
            if (!hasOptions || opts.mpn === true) columnConfig.push({ header: 'MPN', key: 'mpn' });
            if (!hasOptions || opts.their_quote === true) columnConfig.push({ header: 'Your Quote', key: 'your_quote' });
            if (!hasOptions || opts.main_supplier === true) columnConfig.push({ header: 'Awarded To', key: 'awarded_to' });
            if (!hasOptions || opts.difference === true) columnConfig.push({ header: 'Price Difference', key: 'price_difference' });

            const exportData = data.items.map(item => {
                const row = {};
                columnConfig.forEach(col => {
                    let value = item[col.key] || '‚Äî';
                    if (col.key === 'price_difference' && value !== '‚Äî') {
                        value = '‚Ç¨' + value;
                    }
                    row[col.header] = value;
                });
                return row;
            });


            const headers = Object.keys(exportData[0] || {});
            const rows = exportData.map(row =>
                `<tr>${headers.map(h => `<td>${row[h] || ''}</td>`).join('')}</tr>`
            ).join('');

            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Notification - ${supplier}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'Segoe UI', Arial, sans-serif; padding: 40px; color: #1e293b; }
                        .header { background: linear-gradient(135deg, #dc2626, #ef4444); color: white; padding: 15px 20px; border-radius: 8px; margin-bottom: 16px; }
                        .header h1 { font-size: 20px; margin-bottom: 4px; }
                        .header .subtitle { font-size: 12px; opacity: 0.9; }
                        .meta-section { background: #f8fafc; padding: 12px 16px; border-radius: 6px; margin-bottom: 16px; border-left: 3px solid #3b82f6; }
                        .meta-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px; }
                        .meta-item { }
                        .meta-label { font-size: 9px; color: #64748b; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 2px; }
                        .meta-value { font-size: 12px; font-weight: 600; color: #1e293b; }
                        .message-section { background: #fffbeb; padding: 12px 16px; border-radius: 6px; margin-bottom: 16px; border-left: 3px solid #f59e0b; }
                        .message-section h3 { font-size: 12px; color: #92400e; margin-bottom: 6px; }
                        .message-section p { font-size: 11px; color: #78350f; line-height: 1.5; white-space: pre-wrap; }
                        table { width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 10px; }
                        th { background: #1e293b; color: white; padding: 8px 6px; text-align: left; font-weight: 600; }
                        td { padding: 8px; border-bottom: 1px solid #e2e8f0; }
                        tr:nth-child(even) { background: #f8fafc; }
                        .footer { margin-top: 30px; padding-top: 20px; border-top: 2px solid #e2e8f0; font-size: 10px; color: #64748b; text-align: center; }
                        @media print {
                            body { padding: 20px; }
                            .header { break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üìß Notification for ${supplier}</h1>
                        <div class="subtitle">Non-Awarded Items Report</div>
                    </div>

                    <div class="meta-section">
                        <div class="meta-row">
                            <div class="meta-item">
                                <div class="meta-label">Project</div>
                                <div class="meta-value">${projectName}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Quote Number</div>
                                <div class="meta-value">${quoteNumber}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Supplier</div>
                                <div class="meta-value">${supplier}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Date</div>
                                <div class="meta-value">${new Date().toLocaleDateString()}</div>
                            </div>
                            <div class="meta-item">
                                <div class="meta-label">Items</div>
                                <div class="meta-value">${data.items.length}</div>
                            </div>
                        </div>
                    </div>

                    <div class="message-section">
                        <h3>üìù Notification Message</h3>
                        <p>${notificationText || 'No message provided.'}</p>
                    </div>

                    <table>
                        <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                        <tbody>${rows}</tbody>
                    </table>

                    <div class="footer">
                        Generated by RFQ System on ${new Date().toLocaleString()} | Project: ${projectName}
                    </div>

                    <script>window.onload = function() { window.print(); };</script>
                </body>
                </html>
            `);

            printWindow.document.close();

            if (window.showToast) showToast('PDF print dialog opened', 'info');
        };



        // Generate notification as ODF document
        window.generateNotificationODF = function (supplierName) {
            const data = window.fsState.nonAwardedData?.get(supplierName);
            if (!data) return;

            const textArea = document.getElementById('notification-text');
            const notificationText = textArea ? textArea.value : '';

            if (!notificationText.trim()) {
                if (window.showToast) window.showToast('Please enter notification text', 'warning');
                return;
            }

            const options = window.fsState.exportOptions || {};

            // Build item details based on selected fields
            const itemDetails = data.items.map(item => {
                let details = `‚Ä¢ ${escapeHtml(item.drawing_no)}`;

                if (options.description !== false && item.description) {
                    details += ` - ${escapeHtml(item.description)}`;
                }
                if (options.manufacturer !== false && item.manufacturer) {
                    details += ` (Mfr: ${escapeHtml(item.manufacturer)}`;
                    if (options.mpn !== false && item.mpn) {
                        details += `, MPN: ${escapeHtml(item.mpn)}`;
                    }
                    details += `)`;
                } else if (options.mpn !== false && item.mpn) {
                    details += ` (MPN: ${escapeHtml(item.mpn)})`;
                }

                if (options.their_quote !== false) {
                    details += ` - Your quote: ‚Ç¨${item.price.toFixed(2)}`;
                }
                if (options.main_supplier && item.awarded_to) {
                    details += `, Awarded to: ${escapeHtml(item.awarded_to)}`;
                }
                if (options.main_price) {
                    details += ` at ‚Ç¨${item.awarded_price.toFixed(2)}`;
                }

                return `<text:p>${details}</text:p>`;
            }).join('\n      ');

            // Create ODF content (simplified XML format)
            const odfContent = `<?xml version="1.0" encoding="UTF-8"?>
<office:document xmlns:office="urn:oasis:names:tc:opendocument:xmlns:office:1.0" 
                 xmlns:text="urn:oasis:names:tc:opendocument:xmlns:text:1.0"
                 xmlns:style="urn:oasis:names:tc:opendocument:xmlns:style:1.0"
                 office:mimetype="application/vnd.oasis.opendocument.text">
  <office:body>
    <office:text>
      <text:p text:style-name="Title">Non-Award Notification</text:p>
      <text:p text:style-name="Subtitle">Supplier: ${escapeHtml(supplierName)}</text:p>
      <text:p text:style-name="Subtitle">Date: ${new Date().toLocaleDateString()}</text:p>
      <text:p></text:p>
      ${notificationText.split('\n').map(line => `<text:p>${escapeHtml(line)}</text:p>`).join('\n      ')}
      <text:p></text:p>
      <text:p text:style-name="Heading">Items Not Awarded (${data.items.length}):</text:p>
      <text:p></text:p>
      ${itemDetails}
    </office:text>
  </office:body>
</office:document>`;

            // Create and download ODF file
            const blob = new Blob([odfContent], { type: 'application/vnd.oasis.opendocument.text' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `NonAward_Notification_${supplierName.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.odt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            if (window.showToast) window.showToast('ODF document generated successfully', 'success');
            document.getElementById('loser-notification-modal')?.remove();

            // Clear export options after use
            window.fsState.exportOptions = null;
        };


        // Export current supplier items
        window.exportCurrentSupplierItems = function (format) {
            const supplier = window.fsState.selectedSupplier;
            if (!supplier) {
                if (window.showToast) window.showToast('Please select a supplier first', 'warning');
                return;
            }
            window.exportSupplierItems(supplier, format);
        };

        // Open LOI generator for selected supplier
        window.openLOIGeneratorForSelected = function () {
            const supplier = window.fsState.selectedSupplier;
            if (!supplier) {
                if (window.showToast) window.showToast('Please select a supplier first', 'warning');
                return;
            }
            window.openLOIGenerator(supplier);
        };

        // Export all summary
        window.exportAllSummary = function (format) {
            const supplierGroups = window.fsState.supplierGroups;
            if (!supplierGroups || supplierGroups.size === 0) {
                if (window.showToast) window.showToast('No data to export', 'warning');
                return;
            }

            const allItems = [];
            let totalValue = 0;
            supplierGroups.forEach((data, supplier) => {
                data.items.forEach(it => {
                    allItems.push({ ...it, supplier });
                });
                totalValue += data.totalValue;
            });

            if (format === 'excel') {
                exportToExcelFull(allItems, 'Final_Summary_All', totalValue);
            } else {
                exportToPDF(allItems, 'Final Summary - All Suppliers', totalValue, 'summary');
            }
        };

        function renderAwardedSuppliers(supplierGroups) {
            const container = document.getElementById('fs-awarded-suppliers');
            if (!container) return;

            if (supplierGroups.size === 0) {
                container.innerHTML = `
                    <div style="text-align:center; padding:40px; color:#64748b;">
                        <div style="font-size:48px; margin-bottom:12px;">üèÜ</div>
                        <div style="font-weight:600;">No Awards Yet</div>
                        <p style="font-size:12px; margin-top:8px;">Award suppliers in Price Comparison to see them here</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = Array.from(supplierGroups.entries())
                .sort((a, b) => b[1].totalValue - a[1].totalValue)
                .map(([supplier, data], idx) => {
                    const isExpanded = window.fsState.expandedSuppliers.has(supplier);
                    const supplierId = 'sup_' + idx;

                    return `
                        <div class="fs-supplier-card" data-supplier="${escapeHtml(supplier)}">
                            <div class="fs-supplier-card-header" style="cursor:pointer;">
                                <div style="display:flex; align-items:center; gap:10px;" onclick="window.toggleSupplierExpand('${escapeHtml(supplier)}')">
                                    <span class="fs-expand-icon">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                                    <div>
                                        <div class="fs-supplier-name" onclick="event.stopPropagation(); window.navigateToSupplier('${escapeHtml(supplier)}')" style="color:#3b82f6; text-decoration:underline; cursor:pointer;">üè≠ ${escapeHtml(supplier)}</div>
                                        <div style="font-size:11px; color:#64748b;">${data.items.length} items ‚Ä¢ ‚Ç¨${data.totalValue.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} total</div>
                                    </div>
                                </div>
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <div class="fs-supplier-value">‚Ç¨${data.totalValue.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                                    <span onclick="window.toggleSupplierExpand('${escapeHtml(supplier)}')" style="font-size:18px; color:#64748b;">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                                </div>
                            </div>
                            <div class="fs-supplier-items-full" style="display:${isExpanded ? 'block' : 'none'};">
                                <div style="max-height:350px; overflow:auto; margin:10px 0;">
                                    <table style="width:100%; font-size:11px; border-collapse:collapse;">
                                        <thead style="background:#f1f5f9; position:sticky; top:0; z-index:1;">
                                            <tr>
                                                <th style="padding:6px 8px; text-align:left;">Drawing No</th>
                                                <th style="padding:6px 8px; text-align:left;">MPN</th>
                                                <th style="padding:6px 8px; text-align:left;">Manufacturer</th>
                                                <th style="padding:6px 8px; text-align:left;">Description</th>
                                                <th style="padding:6px 8px; text-align:center;">Qty1</th>
                                                <th style="padding:6px 8px; text-align:right;">Price1</th>
                                                <th style="padding:6px 8px; text-align:center;">Qty2</th>
                                                <th style="padding:6px 8px; text-align:right;">Price2</th>
                                                <th style="padding:6px 8px; text-align:center;">Qty3</th>
                                                <th style="padding:6px 8px; text-align:right;">Price3</th>
                                                <th style="padding:6px 8px; text-align:left;">LT</th>
                                                <th style="padding:6px 8px; text-align:left;">MOQ</th>
                                                <th style="padding:6px 8px; text-align:left;">Currency</th>
                                                <th style="padding:6px 8px; text-align:left;">Incoterms</th>
                                                <th style="padding:6px 8px; text-align:right;">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data.items.map(it => {
                        const itemDn = it.item_drawing_no || it.drawing_no || it.dn || it.part_no || '‚Äî';
                        return `
                                                <tr style="border-bottom:1px solid #e5e7eb; cursor:pointer;" onclick="window.navigateToItem('${escapeHtml(itemDn)}')">
                                                    <td style="padding:6px 8px; font-weight:600; color:#3b82f6; text-decoration:underline;">${escapeHtml(itemDn)}</td>
                                                    <td style="padding:6px 8px;">${escapeHtml(it.mpn || it.MPN || '‚Äî')}</td>
                                                    <td style="padding:6px 8px;">${escapeHtml(it.manufacturer || '‚Äî')}</td>
                                                    <td style="padding:6px 8px; max-width:120px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${escapeAttr(it.description || '')}">${escapeHtml(it.description || '‚Äî')}</td>
                                                    <td style="padding:6px 8px; text-align:center;">${it.qty_1 || it.quantity || '‚Äî'}</td>
                                                    <td style="padding:6px 8px; text-align:right;">‚Ç¨${(parseFloat(it.price_1) || 0).toFixed(2)}</td>
                                                    <td style="padding:6px 8px; text-align:center;">${it.qty_2 || '‚Äî'}</td>
                                                    <td style="padding:6px 8px; text-align:right;">${it.price_2 ? '‚Ç¨' + parseFloat(it.price_2).toFixed(2) : '‚Äî'}</td>
                                                    <td style="padding:6px 8px; text-align:center;">${it.qty_3 || '‚Äî'}</td>
                                                    <td style="padding:6px 8px; text-align:right;">${it.price_3 ? '‚Ç¨' + parseFloat(it.price_3).toFixed(2) : '‚Äî'}</td>
                                                    <td style="padding:6px 8px;">${escapeHtml(it.lead_time || it.lt || '‚Äî')}</td>
                                                    <td style="padding:6px 8px;">${escapeHtml(it.moq || '‚Äî')}</td>
                                                    <td style="padding:6px 8px;">${escapeHtml(it.currency || 'EUR')}</td>
                                                    <td style="padding:6px 8px;">${escapeHtml(it.incoterms || 'DAP')}</td>
                                                    <td style="padding:6px 8px; text-align:right; font-weight:600; color:#16a34a;">‚Ç¨${(it.lineValue || 0).toFixed(2)}</td>
                                                </tr>
                                            `}).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div style="padding:10px 16px; display:flex; gap:8px; flex-wrap:wrap; border-top:1px solid #e5e7eb;">
                                <button class="fs-doc-btn" onclick="window.openLOIGenerator('${escapeHtml(supplier)}')">üìú Generate LOI</button>
                                <button class="fs-challenge-btn" onclick="window.openSupplierChallenge('${escapeHtml(supplier)}')">‚ö° Challenge</button>
                                <button class="fs-doc-btn" onclick="window.exportSupplierItems('${escapeHtml(supplier)}', 'excel')">üìä Excel</button>
                                <button class="fs-doc-btn" onclick="window.exportSupplierItems('${escapeHtml(supplier)}', 'pdf')">üìÑ PDF</button>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        window.toggleSupplierExpand = function (supplier) {
            if (window.fsState.expandedSuppliers.has(supplier)) {
                window.fsState.expandedSuppliers.delete(supplier);
            } else {
                window.fsState.expandedSuppliers.add(supplier);
            }
            renderAwardedSuppliers(window.fsState.supplierGroups);
        };

        function renderChallengeCenter() {
            const container = document.getElementById('fs-challenge-history');
            if (!container) return;

            const challenges = window.fsState.challenges || [];

            if (challenges.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#94a3b8; font-size:11px;">No challenges yet.<br>Click Challenge on a supplier to start.</div>';
                return;
            }

            container.innerHTML = challenges.map((ch, idx) => {
                const statusColors = {
                    'open': '#f59e0b',
                    'pending': '#3b82f6',
                    'accepted': '#22c55e',
                    'rejected': '#ef4444',
                    'closed': '#64748b'
                };
                const statusColor = statusColors[ch.status] || '#64748b';

                return `
                    <div class="fs-challenge-card" style="background:#fffbeb; border:1px solid #fde68a; border-radius:8px; padding:10px; margin-bottom:8px; cursor:pointer;" onclick="window.openChallengeDetail(${idx})">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <div style="font-weight:600; font-size:12px;">üè≠ ${escapeHtml(ch.supplier)}</div>
                                <div style="font-size:10px; color:#64748b;">${ch.items?.length || 0} items ‚Ä¢ ${ch.created ? new Date(ch.created).toLocaleDateString() : ''}</div>
                            </div>
                            <span style="background:${statusColor}; color:white; padding:2px 8px; border-radius:10px; font-size:10px; font-weight:600;">${ch.status}</span>
                        </div>
                        ${ch.comments?.length ? `<div style="font-size:10px; color:#64748b; margin-top:4px;">üí¨ ${ch.comments.length} comments</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderFinalSummaryItemsTable(items, supplierGroups) {
            const tbody = document.getElementById('fs-items-tbody');
            if (!tbody) return;

            const filter = document.getElementById('fs-items-filter')?.value || 'all';
            const search = (document.getElementById('fs-items-search')?.value || '').toLowerCase();

            let filteredItems = items.filter(it => {
                const dn = (it.item_drawing_no || it.drawing_no || it.dn || it.part_no || '').toLowerCase();
                const desc = (it.description || '').toLowerCase();
                const mpn = (it.mpn || it.MPN || '').toLowerCase();
                if (search && !dn.includes(search) && !desc.includes(search) && !mpn.includes(search)) return false;

                const hasAward = (it.supplier || it.awarded_supplier) && (parseFloat(it.price_1) || parseFloat(it.awarded_price));
                const isChallenged = it.challenge_id || it.challenge_status === 'challenged';

                if (filter === 'awarded' && !hasAward) return false;
                if (filter === 'challenged' && !isChallenged) return false;
                if (filter === 'pending' && hasAward) return false;

                return true;
            });

            if (filteredItems.length === 0) {
                tbody.innerHTML = `<tr><td colspan="15" style="text-align:center; padding:40px; color:#64748b;">No items match the filter</td></tr>`;
                return;
            }

            tbody.innerHTML = filteredItems.map(it => {
                const dn = it.item_drawing_no || it.drawing_no || it.dn || it.part_no || '‚Äî';
                const supplier = it.supplier || it.awarded_supplier || '';
                const qty1 = it.qty_1 || it.quantity || '';
                const qty2 = it.qty_2 || '';
                const qty3 = it.qty_3 || '';
                const price1 = parseFloat(it.price_1) || 0;
                const price2 = parseFloat(it.price_2) || 0;
                const price3 = parseFloat(it.price_3) || 0;
                const total = (parseFloat(qty1) || 1) * price1;
                const hasAward = supplier && price1 > 0;
                const isChallenged = it.challenge_id || it.challenge_status === 'challenged';

                let statusClass = 'fs-status-pending';
                let statusText = 'Pending';
                if (hasAward && !isChallenged) {
                    statusClass = 'fs-status-awarded';
                    statusText = '‚úÖ Awarded';
                } else if (isChallenged) {
                    statusClass = 'fs-status-challenged';
                    statusText = '‚ö° Challenge';
                }

                const rowClass = isChallenged ? 'challenged' : (hasAward ? 'awarded' : '');

                return `
                    <tr class="${rowClass}">
                        <td><input type="checkbox" class="fs-item-check" data-dn="${escapeHtml(dn)}" data-supplier="${escapeHtml(supplier)}"></td>
                        <td><a href="#" onclick="event.preventDefault(); window.navigateToItem('${escapeHtml(dn)}')" style="color:#3b82f6; text-decoration:underline; cursor:pointer; font-weight:600;">${escapeHtml(dn)}</a></td>
                        <td style="font-size:10px;">${escapeHtml(it.mpn || it.MPN || '‚Äî')}</td>
                        <td style="font-size:10px;">${escapeHtml(it.manufacturer || '‚Äî')}</td>
                        <td style="max-width:120px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-size:10px;" title="${escapeAttr(it.description || '')}">${escapeHtml(it.description || '‚Äî')}</td>
                        <td style="text-align:center; font-size:10px;">${qty1 || '‚Äî'}</td>
                        <td style="text-align:right; font-size:10px;">‚Ç¨${price1.toFixed(2)}</td>
                        <td style="text-align:center; font-size:10px;">${qty2 || '‚Äî'}</td>
                        <td style="text-align:right; font-size:10px;">${price2 > 0 ? '‚Ç¨' + price2.toFixed(2) : '‚Äî'}</td>
                        <td style="text-align:center; font-size:10px;">${qty3 || '‚Äî'}</td>
                        <td style="text-align:right; font-size:10px;">${price3 > 0 ? '‚Ç¨' + price3.toFixed(2) : '‚Äî'}</td>
                        <td>${supplier ? `<a href="#" onclick="event.preventDefault(); window.navigateToSupplier('${escapeHtml(supplier)}')" style="color:#3b82f6; text-decoration:underline; cursor:pointer; font-size:10px;">${escapeHtml(supplier)}</a>` : '<span style="color:#94a3b8;">‚Äî</span>'}</td>
                        <td style="text-align:right; font-weight:600; font-size:10px; color:#16a34a;">‚Ç¨${total.toFixed(2)}</td>
                        <td><span class="fs-status-badge ${statusClass}">${statusText}</span></td>
                        <td style="white-space:nowrap;">
                            ${hasAward && !isChallenged ? `<button class="fs-challenge-btn" onclick="window.openItemChallenge('${escapeHtml(dn)}')" title="Challenge">‚ö°</button>` : ''}
                            <button class="fs-doc-btn" onclick="window.navigateToItem('${escapeHtml(dn)}')" style="padding:2px 6px; font-size:9px;" title="View">üëÅ</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Document tracking by supplier
        function renderDocumentTrackingBySupplier(supplierGroups) {
            const container = document.getElementById('fs-doc-tracking-list');
            if (!container || !currentProject) return;

            const docs = currentProject.final_documents || [];
            const suppliers = Array.from(supplierGroups.keys());

            if (docs.length === 0 && suppliers.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#94a3b8; font-size:11px;">No documents tracked yet</div>';
                return;
            }

            // Group docs by supplier
            let html = '';
            suppliers.forEach(supplier => {
                const supplierDocs = docs.filter(d => d.supplier === supplier);
                html += `
                    <div style="margin-bottom:12px;">
                        <div style="font-weight:600; font-size:11px; color:#475569; padding:4px 0; border-bottom:1px solid #e5e7eb;">üè≠ ${escapeHtml(supplier)}</div>
                        ${supplierDocs.length === 0 ? `
                            <div style="font-size:10px; color:#94a3b8; padding:8px;">No documents</div>
                        ` : supplierDocs.map(doc => {
                    const dueDate = doc.due_date ? new Date(doc.due_date) : null;
                    const today = new Date();
                    const isOverdue = dueDate && dueDate < today && doc.status !== 'signed';
                    const isCompleted = doc.status === 'signed' || doc.status === 'received';
                    return `
                                <div class="fs-doc-tracking-item ${isOverdue ? 'overdue' : ''} ${isCompleted ? 'completed' : ''}" style="margin:4px 0;">
                                    <div style="font-size:12px;">${doc.status === 'signed' ? '‚úÖ' : doc.status === 'sent' ? 'üì§' : '‚è≥'}</div>
                                    <div style="flex:1;">
                                        <div style="font-weight:500; font-size:11px;">${escapeHtml(doc.name || doc.type)}</div>
                                        <div style="font-size:9px; color:#64748b;">${dueDate ? 'Due: ' + dueDate.toLocaleDateString() : ''}</div>
                                    </div>
                                </div>
                            `;
                }).join('')}
                    </div>
                `;
            });

            // Docs without supplier
            const unassignedDocs = docs.filter(d => !d.supplier);
            if (unassignedDocs.length > 0) {
                html += `
                    <div style="margin-bottom:12px;">
                        <div style="font-weight:600; font-size:11px; color:#475569; padding:4px 0; border-bottom:1px solid #e5e7eb;">üìã General</div>
                        ${unassignedDocs.map(doc => `
                            <div class="fs-doc-tracking-item" style="margin:4px 0;">
                                <div style="flex:1; font-size:11px;">${escapeHtml(doc.name || doc.type)}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            container.innerHTML = html || '<div style="text-align:center; padding:20px; color:#94a3b8; font-size:11px;">No documents</div>';
        }

        // =========================================================
        // LOI GENERATOR MODAL
        // =========================================================
        window.openLOIGenerator = function (supplier) {
            const supplierData = window.fsState.supplierGroups?.get(supplier);
            if (!supplierData) return;

            const modal = document.createElement('div');
            modal.id = 'loi-generator-modal';
            modal.className = 'rfq-modal-overlay';
            modal.innerHTML = `
                <div class="rfq-modal-container" style="max-width:800px; max-height:90vh; display:flex; flex-direction:column;">
                    <div class="rfq-wizard-header" style="background:linear-gradient(135deg,#1e40af,#3b82f6);">
                        <div>
                            <h3 style="color:white;">üìú LOI Generator</h3>
                            <span style="color:rgba(255,255,255,0.8);">Letter of Intent for ${escapeHtml(supplier)}</span>
                        </div>
                        <button onclick="document.getElementById('loi-generator-modal').remove()" class="rfq-btn-close" style="color:white;">&times;</button>
                    </div>
                    <div style="padding:20px; flex:1; overflow-y:auto;">
                        <div style="margin-bottom:16px;">
                            <label style="font-weight:600; font-size:13px;">Select fields to include:</label>
                            <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; margin-top:10px;">
                                <label style="display:flex; align-items:center; gap:6px; font-size:12px;"><input type="checkbox" class="loi-field" value="drawing_no" checked> Drawing No</label>
                                <label style="display:flex; align-items:center; gap:6px; font-size:12px;"><input type="checkbox" class="loi-field" value="mpn" checked> MPN</label>
                                <label style="display:flex; align-items:center; gap:6px; font-size:12px;"><input type="checkbox" class="loi-field" value="manufacturer" checked> Manufacturer</label>
                                <label style="display:flex; align-items:center; gap:6px; font-size:12px;"><input type="checkbox" class="loi-field" value="description" checked> Description</label>
                                <label style="display:flex; align-items:center; gap:6px; font-size:12px;"><input type="checkbox" class="loi-field" value="qty_1" checked> Qty 1</label>
                                <label style="display:flex; align-items:center; gap:6px; font-size:12px;"><input type="checkbox" class="loi-field" value="price_1" checked> Price 1</label>
                                <label style="display:flex; align-items:center; gap:6px; font-size:12px;"><input type="checkbox" class="loi-field" value="qty_2"> Qty 2</label>
                                <label style="display:flex; align-items:center; gap:6px; font-size:12px;"><input type="checkbox" class="loi-field" value="price_2"> Price 2</label>
                                <label style="display:flex; align-items:center; gap:6px; font-size:12px;"><input type="checkbox" class="loi-field" value="qty_3"> Qty 3</label>
                                <label style="display:flex; align-items:center; gap:6px; font-size:12px;"><input type="checkbox" class="loi-field" value="price_3"> Price 3</label>
                                <label style="display:flex; align-items:center; gap:6px; font-size:12px;"><input type="checkbox" class="loi-field" value="lead_time" checked> Lead Time</label>
                                <label style="display:flex; align-items:center; gap:6px; font-size:12px;"><input type="checkbox" class="loi-field" value="moq"> MOQ</label>
                                <label style="display:flex; align-items:center; gap:6px; font-size:12px;"><input type="checkbox" class="loi-field" value="total" checked> Line Total</label>
                                <label style="display:flex; align-items:center; gap:6px; font-size:12px;"><input type="checkbox" class="loi-field" value="currency" checked> Currency</label>
                                <label style="display:flex; align-items:center; gap:6px; font-size:12px;"><input type="checkbox" class="loi-field" value="incoterms"> Incoterms</label>
                            </div>
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="font-weight:600; font-size:13px;">LOI Terms (editable):</label>
                            <textarea id="loi-terms" class="rfq-input" style="width:100%; min-height:120px; margin-top:8px; font-size:12px;">This Letter of Intent confirms our intention to place a purchase order with ${escapeHtml(supplier)} for the items listed below.

Terms:
- Prices are valid for 90 days from date of this LOI
- Delivery terms: DAP destination
- Payment terms: Net 60 days
- Quality requirements per our specifications

This LOI is non-binding until a formal Purchase Order is issued.</textarea>
                        </div>
                        <div style="background:#f8fafc; padding:12px; border-radius:8px; margin-bottom:16px;">
                            <div style="font-weight:600; font-size:12px; margin-bottom:8px;">Preview (${supplierData.items.length} items)</div>
                            <div style="font-size:24px; font-weight:800; color:#16a34a;">Total: ‚Ç¨${supplierData.totalValue.toLocaleString('en-US', { minimumFractionDigits: 2 })}</div>
                        </div>
                    </div>
                    <div class="rfq-wizard-footer">
                        <button onclick="document.getElementById('loi-generator-modal').remove()" class="rfq-btn-secondary">Cancel</button>
                        <button onclick="window.generateLOI('${escapeHtml(supplier)}', 'excel')" class="rfq-btn-secondary">üìä Export Excel</button>
                        <button onclick="window.generateLOI('${escapeHtml(supplier)}', 'pdf')" class="rfq-btn-primary">üìÑ Generate PDF</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        };

        window.generateLOI = function (supplier, format) {
            const supplierData = window.fsState.supplierGroups?.get(supplier);
            if (!supplierData) return;

            const selectedFields = Array.from(document.querySelectorAll('.loi-field:checked')).map(cb => cb.value);
            const terms = document.getElementById('loi-terms')?.value || 'Standard Terms & Conditions Apply.';

            const fieldMap = {
                'drawing_no': { header: 'Drawing No', key: it => it.drawing_no || it.dn },
                'mpn': { header: 'MPN', key: it => it.mpn || it.MPN },
                'manufacturer': { header: 'Manufacturer', key: it => it.manufacturer || it.mfr },
                'description': { header: 'Description', key: it => it.description },
                'qty_1': { header: 'Qty 1', key: it => it.qty_1 },
                'price_1': { header: 'Price 1', key: it => '‚Ç¨' + (parseFloat(it.price_1) || 0).toFixed(2) },
                'qty_2': { header: 'Qty 2', key: it => it.qty_2 },
                'price_2': { header: 'Price 2', key: it => it.price_2 ? '‚Ç¨' + parseFloat(it.price_2).toFixed(2) : '' },
                'qty_3': { header: 'Qty 3', key: it => it.qty_3 },
                'price_3': { header: 'Price 3', key: it => it.price_3 ? '‚Ç¨' + parseFloat(it.price_3).toFixed(2) : '' },
                'lead_time': { header: 'Lead Time', key: it => it.lead_time || it.lt },
                'moq': { header: 'MOQ', key: it => it.moq },
                'total': { header: 'Total', key: it => '‚Ç¨' + (it.lineValue?.toFixed(2) || '0.00') },
                'currency': { header: 'Currency', key: it => it.currency || 'EUR' },
                'incoterms': { header: 'Incoterms', key: it => it.incoterms || 'DAP' }
            };

            const data = supplierData.items.map(it => {
                const row = {};
                selectedFields.forEach(f => {
                    if (fieldMap[f]) row[fieldMap[f].header] = fieldMap[f].key(it) || '';
                });
                return row;
            });

            if (format === 'pdf') {
                exportLOIToPDF(supplier, supplierData, data, selectedFields.map(f => fieldMap[f]?.header).filter(Boolean), terms);
            } else {
                exportLOIToExcel(supplier, supplierData, data, terms);
            }

            document.getElementById('loi-generator-modal')?.remove();
            if (window.showToast) showToast('LOI generated!', 'success');
        };

        function exportLOIToExcel(supplier, supplierData, data, terms) {
            if (!window.XLSX) {
                if (window.showToast) showToast('Excel library not loaded', 'error');
                return;
            }

            const wb = XLSX.utils.book_new();
            const headerRows = [
                ['LETTER OF INTENT'],
                [''],
                ['Date:', new Date().toLocaleDateString()],
                ['Supplier:', supplier],
                ['Project:', currentProject?.name || 'N/A'],
                ['Total Items:', supplierData.items.length],
                ['Total Value:', '‚Ç¨' + supplierData.totalValue.toFixed(2)],
                [''],
                ['Terms & Conditions:'],
                [terms],
                ['']
            ];

            const headers = Object.keys(data[0] || {});
            const dataRows = data.map(row => headers.map(h => row[h]));
            const allRows = [...headerRows, headers, ...dataRows];
            allRows.push([]);
            allRows.push(['', '', '', '', '', '', 'TOTAL VALUE:', '‚Ç¨' + supplierData.totalValue.toFixed(2)]);

            const ws = XLSX.utils.aoa_to_sheet(allRows);
            ws['!cols'] = headers.map(() => ({ wch: 14 }));
            XLSX.utils.book_append_sheet(wb, ws, 'LOI');
            XLSX.writeFile(wb, `LOI_${supplier}_${currentProject?.name || 'Project'}.xlsx`);
        }

        function exportLOIToPDF(supplier, supplierData, data, headers, terms) {
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                if (window.showToast) showToast('Please allow popups for PDF export', 'error');
                return;
            }

            const rows = data.map(row =>
                `<tr>${headers.map(h => `<td>${row[h] || ''}</td>`).join('')}</tr>`
            ).join('');

            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Letter of Intent - ${supplier}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'Segoe UI', Arial, sans-serif; padding: 50px; color: #1e293b; }
                        .letterhead { text-align: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 3px solid #1e293b; }
                        .letterhead h1 { font-size: 32px; color: #1e293b; margin-bottom: 8px; }
                        .letterhead .subtitle { color: #64748b; font-size: 14px; }
                        .meta-section { display: flex; justify-content: space-between; margin-bottom: 30px; padding: 20px; background: #f8fafc; border-radius: 12px; }
                        .meta-left, .meta-right { }
                        .meta-label { font-size: 11px; color: #64748b; text-transform: uppercase; }
                        .meta-value { font-size: 16px; font-weight: 600; margin-bottom: 12px; }
                        .meta-value.large { font-size: 24px; color: #16a34a; }
                        .intro { margin-bottom: 30px; line-height: 1.6; }
                        .intro p { margin-bottom: 12px; }
                        table { width: 100%; border-collapse: collapse; margin: 30px 0; font-size: 11px; }
                        th { background: linear-gradient(135deg, #1e293b, #334155); color: white; padding: 12px 8px; text-align: left; font-size: 10px; text-transform: uppercase; }
                        td { padding: 10px 8px; border-bottom: 1px solid #e2e8f0; }
                        tr:nth-child(even) { background: #f8fafc; }
                        .total-row { background: linear-gradient(135deg, #dcfce7, #bbf7d0) !important; }
                        .total-row td { font-weight: 700; border-top: 2px solid #16a34a; }
                        .terms-section { margin-top: 40px; padding: 20px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #3b82f6; }
                        .terms-title { font-weight: 700; margin-bottom: 12px; }
                        .terms-content { font-size: 12px; line-height: 1.6; color: #475569; }
                        .signature-section { margin-top: 60px; display: flex; justify-content: space-between; }
                        .signature-box { width: 45%; }
                        .signature-line { border-top: 1px solid #1e293b; margin-top: 60px; padding-top: 8px; }
                        .signature-label { font-size: 12px; color: #64748b; }
                        .footer { margin-top: 60px; text-align: center; color: #94a3b8; font-size: 10px; padding-top: 20px; border-top: 1px solid #e2e8f0; }
                        @media print { th { print-color-adjust: exact; -webkit-print-color-adjust: exact; } }
                    </style>
                </head>
                <body>
                    <div class="letterhead">
                        <h1>üìú LETTER OF INTENT</h1>
                        <div class="subtitle">RFQ System ‚Ä¢ ${currentProject?.name || 'Project'}</div>
                    </div>

                    <div class="meta-section">
                        <div class="meta-left">
                            <div class="meta-label">Date</div>
                            <div class="meta-value">${new Date().toLocaleDateString()}</div>
                            <div class="meta-label">To (Supplier)</div>
                            <div class="meta-value">${supplier}</div>
                        </div>
                        <div class="meta-right" style="text-align:right;">
                            <div class="meta-label">Total Items</div>
                            <div class="meta-value">${supplierData.items.length}</div>
                            <div class="meta-label">Total Award Value</div>
                            <div class="meta-value large">‚Ç¨${supplierData.totalValue.toLocaleString('en-US', { minimumFractionDigits: 2 })}</div>
                        </div>
                    </div>

                    <div class="intro">
                        <p>Dear ${supplier},</p>
                        <p>We are pleased to inform you that based on our evaluation process, your company has been selected as the preferred supplier for the items listed below. This Letter of Intent confirms our intention to proceed with the purchase of these components subject to the terms and conditions outlined herein.</p>
                    </div>

                    <table>
                        <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                        <tbody>
                            ${rows}
                            <tr class="total-row">
                                <td colspan="${headers.length - 1}" style="text-align:right;">TOTAL AWARD VALUE:</td>
                                <td>‚Ç¨${supplierData.totalValue.toFixed(2)}</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="terms-section">
                        <div class="terms-title">üìã Terms & Conditions</div>
                        <div class="terms-content">${terms.replace(/\n/g, '<br>')}</div>
                    </div>

                    <div class="signature-section">
                        <div class="signature-box">
                            <div class="signature-line"></div>
                            <div class="signature-label">Buyer Signature & Date</div>
                        </div>
                        <div class="signature-box">
                            <div class="signature-line"></div>
                            <div class="signature-label">Supplier Acknowledgment & Date</div>
                        </div>
                    </div>

                    <div class="footer">
                        <p>This Letter of Intent was generated by RFQ System on ${new Date().toLocaleString()}</p>
                        <p>Project: ${currentProject?.name || 'N/A'} | Reference: LOI-${supplier.replace(/\s/g, '')}-${Date.now()}</p>
                    </div>

                    <script>window.onload = function() { window.print(); };</script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // =========================================================
        // CHALLENGE SYSTEM
        // =========================================================
        window.openSupplierChallenge = function (supplier) {
            const supplierData = window.fsState.supplierGroups?.get(supplier);
            if (!supplierData) {
                if (window.showToast) window.showToast('Please select a supplier first', 'warning');
                return;
            }

            // Get competitor quotes for these items
            const competitorQuotes = {};
            supplierData.items.forEach(it => {
                const dn = it.item_drawing_no || it.drawing_no || it.dn || it.part_no || '';
                const quotes = it.quotes || [];
                const supplierQuotesObj = it.supplier_quotes || {};

                // Collect competitor quotes from quotes array
                const others = quotes.filter(q => (q.supplier || q.supplier_name) !== supplier);

                // Also check supplier_quotes object
                Object.entries(supplierQuotesObj).forEach(([supName, quoteData]) => {
                    if (supName !== supplier && quoteData) {
                        others.push({
                            supplier: supName,
                            price: quoteData.price_1 || quoteData.price || quoteData.unit_price || 0
                        });
                    }
                });

                if (others.length) competitorQuotes[dn] = others;
            });

            // Calculate totals
            const totalCurrentValue = supplierData.items.reduce((sum, it) => {
                const qty = parseFloat(it.qty_1) || 1;
                const price = parseFloat(it.price_1) || 0;
                return sum + (qty * price);
            }, 0);

            // Remove existing modal if present
            document.getElementById('challenge-modal')?.remove();

            const modal = document.createElement('div');
            modal.id = 'challenge-modal';
            modal.className = 'rfq-modal-overlay';
            modal.innerHTML = `
                <div class="rfq-modal-container" style="max-width:950px; max-height:90vh; display:flex; flex-direction:column;">
                    <div class="rfq-wizard-header" style="background:linear-gradient(135deg,#d97706,#f59e0b);">
                        <div>
                            <h3 style="color:white; margin:0;">‚ö° Challenge Supplier Pricing</h3>
                            <span style="color:rgba(255,255,255,0.8); font-size:12px;">${escapeHtml(supplier)} ‚Ä¢ ${supplierData.items.length} items ‚Ä¢ Total: ‚Ç¨${totalCurrentValue.toLocaleString('en-US', { minimumFractionDigits: 2 })}</span>
                        </div>
                        <button onclick="document.getElementById('challenge-modal').remove()" class="rfq-btn-close" style="color:white; font-size:24px;">&times;</button>
                    </div>
                    <div style="padding:20px; flex:1; overflow-y:auto;">
                        <!-- Challenge Type & Value -->
                        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; margin-bottom:16px;">
                            <div>
                                <label style="font-weight:600; font-size:12px; display:block; margin-bottom:6px;">Challenge Type</label>
                                <select id="challenge-type" class="rfq-input" style="width:100%;">
                                    <option value="percentage">Reduce by Percentage (%)</option>
                                    <option value="target">Set Target Price (‚Ç¨)</option>
                                    <option value="competitor">Match Best Competitor</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-weight:600; font-size:12px; display:block; margin-bottom:6px;">Value</label>
                                <input type="number" id="challenge-value" class="rfq-input" style="width:100%;" placeholder="e.g. 10 for 10%">
                            </div>
                            <div>
                                <label style="font-weight:600; font-size:12px; display:block; margin-bottom:6px;">Potential Savings</label>
                                <div id="challenge-savings" style="background:#dcfce7; color:#166534; padding:10px; border-radius:6px; font-weight:700; text-align:center;">‚Ç¨0.00</div>
                            </div>
                        </div>

                        <!-- Items Table -->
                        <div style="margin-bottom:16px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                <label style="font-weight:600; font-size:12px;">Items to Challenge</label>
                                <span style="font-size:11px; color:#64748b;"><span id="challenge-selected-count">${supplierData.items.length}</span> items selected</span>
                            </div>
                            <div style="max-height:280px; overflow:auto; border:1px solid #e5e7eb; border-radius:8px;">
                                <table style="width:100%; font-size:11px; border-collapse:collapse;">
                                    <thead style="background:#1e293b; color:white; position:sticky; top:0; z-index:1;">
                                        <tr>
                                            <th style="padding:10px 8px; width:30px;"><input type="checkbox" id="challenge-select-all" checked style="accent-color:#f59e0b;"></th>
                                            <th style="padding:10px 8px; text-align:left;">Drawing No</th>
                                            <th style="padding:10px 8px; text-align:left;">Description</th>
                                            <th style="padding:10px 8px; text-align:center;">Qty</th>
                                            <th style="padding:10px 8px; text-align:right;">Current ‚Ç¨</th>
                                            <th style="padding:10px 8px; text-align:left;">Competitors</th>
                                            <th style="padding:10px 8px; text-align:right;">Target ‚Ç¨</th>
                                            <th style="padding:10px 8px; text-align:right;">Savings</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${supplierData.items.map((it, idx) => {
                const dn = it.item_drawing_no || it.drawing_no || it.dn || it.part_no || '‚Äî';
                const desc = it.description || '';
                const qty = parseFloat(it.qty_1) || parseFloat(it.quantity) || 1;
                const price = parseFloat(it.price_1) || 0;
                const lineTotal = qty * price;
                const competitors = competitorQuotes[dn] || [];
                const bestCompetitor = competitors.length > 0
                    ? competitors.reduce((best, c) => {
                        const p = parseFloat(c.price || c.unit_price || 0);
                        return p > 0 && (best === null || p < best.price) ? { supplier: c.supplier || c.supplier_name, price: p } : best;
                    }, null)
                    : null;
                const competitorHtml = bestCompetitor
                    ? `<span style="background:#fee2e2; padding:2px 6px; border-radius:4px; font-size:10px;">${escapeHtml(bestCompetitor.supplier)}: ‚Ç¨${bestCompetitor.price.toFixed(2)}</span>`
                    : '<span style="color:#94a3b8; font-size:10px;">‚Äî</span>';
                const rowBg = idx % 2 === 0 ? '#ffffff' : '#f8fafc';
                return `
                                                <tr style="background:${rowBg};">
                                                    <td style="padding:8px;"><input type="checkbox" class="challenge-item" data-dn="${escapeHtml(dn)}" data-price="${price}" data-qty="${qty}" data-best="${bestCompetitor?.price || 0}" checked style="accent-color:#f59e0b;"></td>
                                                    <td style="padding:8px; font-weight:600; color:#3b82f6;">${escapeHtml(dn)}</td>
                                                    <td style="padding:8px; max-width:150px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${escapeAttr(desc)}">${escapeHtml(desc.substring(0, 30))}${desc.length > 30 ? '...' : ''}</td>
                                                    <td style="padding:8px; text-align:center;">${qty}</td>
                                                    <td style="padding:8px; text-align:right; font-weight:600;">‚Ç¨${price.toFixed(2)}</td>
                                                    <td style="padding:8px;">${competitorHtml}</td>
                                                    <td style="padding:8px; text-align:right;"><input type="number" class="challenge-target-input rfq-input" data-dn="${escapeHtml(dn)}" data-qty="${qty}" style="width:75px; padding:4px; font-size:11px;" step="0.01" value="${price.toFixed(2)}"></td>
                                                    <td style="padding:8px; text-align:right; color:#16a34a; font-weight:600;" class="item-savings" data-dn="${escapeHtml(dn)}">‚Ç¨0.00</td>
                                                </tr>
                                            `;
            }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Message -->
                        <div style="margin-bottom:16px;">
                            <label style="font-weight:600; font-size:12px; display:block; margin-bottom:6px;">Message to Supplier</label>
                            <textarea id="challenge-message" class="rfq-input" style="width:100%; min-height:70px; font-size:12px;" placeholder="We are requesting a price review for the following items. Please provide your best offer by the deadline..."></textarea>
                        </div>

                        <!-- Deadline & Contact -->
                        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px;">
                            <div>
                                <label style="font-weight:600; font-size:12px; display:block; margin-bottom:6px;">Response Deadline</label>
                                <input type="date" id="challenge-deadline" class="rfq-input" style="width:100%;">
                            </div>
                            <div>
                                <label style="font-weight:600; font-size:12px; display:block; margin-bottom:6px;">Contact Person</label>
                                <input type="text" id="challenge-contact" class="rfq-input" style="width:100%;" placeholder="Your name...">
                            </div>
                            <div>
                                <label style="font-weight:600; font-size:12px; display:block; margin-bottom:6px;">Contact Email</label>
                                <input type="email" id="challenge-email" class="rfq-input" style="width:100%;" placeholder="your@email.com">
                            </div>
                        </div>
                    </div>
                    <div class="rfq-wizard-footer" style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="font-size:12px; color:#64748b;">
                            Total Potential Savings: <strong style="color:#16a34a; font-size:14px;" id="challenge-total-savings">‚Ç¨0.00</strong>
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button onclick="document.getElementById('challenge-modal').remove()" class="rfq-btn-secondary">Cancel</button>
                            <button onclick="window.exportChallengePreview('${escapeHtml(supplier)}')" class="rfq-btn-secondary">üìÑ Preview PDF</button>
                            <button onclick="window.createChallenge('${escapeHtml(supplier)}')" class="rfq-btn-warning" style="padding:10px 24px;">
                                ‚ö° Create Challenge & Export
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Set default deadline 7 days out
            const deadline = document.getElementById('challenge-deadline');
            if (deadline) {
                const d = new Date();
                d.setDate(d.getDate() + 7);
                deadline.value = d.toISOString().split('T')[0];
            }

            // Bind events
            document.getElementById('challenge-type').onchange = updateChallengeTargets;
            document.getElementById('challenge-value').oninput = updateChallengeTargets;
            document.getElementById('challenge-select-all').onchange = (e) => {
                document.querySelectorAll('.challenge-item').forEach(cb => cb.checked = e.target.checked);
                updateChallengeSelectedCount();
                updateChallengeSavings();
            };

            // Individual checkbox changes
            document.querySelectorAll('.challenge-item').forEach(cb => {
                cb.onchange = () => {
                    updateChallengeSelectedCount();
                    updateChallengeSavings();
                };
            });

            // Target input changes
            document.querySelectorAll('.challenge-target-input').forEach(inp => {
                inp.oninput = () => updateChallengeSavings();
            });
        };

        function updateChallengeSelectedCount() {
            const count = document.querySelectorAll('.challenge-item:checked').length;
            const countEl = document.getElementById('challenge-selected-count');
            if (countEl) countEl.textContent = count;
        }

        function updateChallengeSavings() {
            let totalSavings = 0;

            document.querySelectorAll('.challenge-item').forEach(cb => {
                const dn = cb.dataset.dn;
                const currentPrice = parseFloat(cb.dataset.price) || 0;
                const qty = parseFloat(cb.dataset.qty) || 1;
                const targetInput = document.querySelector(`.challenge-target-input[data-dn="${dn}"]`);
                const savingsCell = document.querySelector(`.item-savings[data-dn="${dn}"]`);
                const targetPrice = parseFloat(targetInput?.value) || currentPrice;

                const lineSavings = cb.checked ? (currentPrice - targetPrice) * qty : 0;

                if (savingsCell) {
                    savingsCell.textContent = lineSavings > 0 ? '‚Ç¨' + lineSavings.toFixed(2) : '‚Ç¨0.00';
                    savingsCell.style.color = lineSavings > 0 ? '#16a34a' : '#94a3b8';
                }

                totalSavings += lineSavings;
            });

            const savingsEl = document.getElementById('challenge-savings');
            const totalSavingsEl = document.getElementById('challenge-total-savings');
            if (savingsEl) savingsEl.textContent = '‚Ç¨' + totalSavings.toFixed(2);
            if (totalSavingsEl) totalSavingsEl.textContent = '‚Ç¨' + totalSavings.toFixed(2);
        }

        function updateChallengeTargets() {
            const type = document.getElementById('challenge-type')?.value;
            const value = parseFloat(document.getElementById('challenge-value')?.value) || 0;

            document.querySelectorAll('.challenge-item').forEach(cb => {
                const dn = cb.dataset.dn;
                const currentPrice = parseFloat(cb.dataset.price) || 0;
                const bestCompetitor = parseFloat(cb.dataset.best) || 0;
                const targetInput = document.querySelector(`.challenge-target-input[data-dn="${dn}"]`);

                if (targetInput) {
                    if (type === 'percentage' && value > 0) {
                        targetInput.value = (currentPrice * (1 - value / 100)).toFixed(2);
                    } else if (type === 'target' && value > 0) {
                        targetInput.value = value.toFixed(2);
                    } else if (type === 'competitor' && bestCompetitor > 0) {
                        targetInput.value = bestCompetitor.toFixed(2);
                    }
                }
            });

            updateChallengeSavings();
        }

        window.createChallenge = function (supplier) {
            if (!currentProject) return;

            const type = document.getElementById('challenge-type')?.value;
            const value = document.getElementById('challenge-value')?.value;
            const message = document.getElementById('challenge-message')?.value;
            const deadline = document.getElementById('challenge-deadline')?.value;
            const contact = document.getElementById('challenge-contact')?.value;
            const challengeId = 'ch_' + Date.now();

            // Get selected items with targets
            const challengeItems = [];
            document.querySelectorAll('.challenge-item:checked').forEach(cb => {
                const dn = cb.dataset.dn;
                const currentPrice = parseFloat(cb.dataset.price) || 0;
                const qty = parseFloat(cb.dataset.qty) || 1;
                const targetInput = document.querySelector(`.challenge-target-input[data-dn="${dn}"]`);
                const targetPrice = parseFloat(targetInput?.value) || currentPrice;

                // Find item description
                const item = currentProject.items.find(it => {
                    const itemDn = it.item_drawing_no || it.drawing_no || it.dn || it.part_no || '';
                    return itemDn === dn;
                });
                const description = item?.description || '';

                challengeItems.push({
                    drawing_no: dn,
                    description: description,
                    qty: qty,
                    current_price: currentPrice,
                    target_price: targetPrice,
                    reduction: currentPrice > 0 ? ((currentPrice - targetPrice) / currentPrice * 100).toFixed(1) + '%' : '0%'
                });

                // Mark item as challenged
                if (item) {
                    item.challenge_id = challengeId;
                    item.challenge_status = 'challenged';
                }
            });

            // Create challenge record
            const challenge = {
                id: challengeId,
                supplier,
                type,
                value,
                items: challengeItems,
                message,
                deadline,
                contact,
                email: document.getElementById('challenge-email')?.value || '',
                status: 'open',
                created: new Date().toISOString(),
                total_current: challengeItems.reduce((sum, ci) => sum + (ci.current_price * ci.qty), 0),
                total_target: challengeItems.reduce((sum, ci) => sum + (ci.target_price * ci.qty), 0),
                comments: []
            };

            if (!currentProject.challenges) currentProject.challenges = [];
            currentProject.challenges.push(challenge);

            // Save
            if (typeof updateProject === 'function') updateProject(currentProject);

            // Export challenge document with more details
            const exportData = challengeItems.map(ci => ({
                'Drawing No': ci.drawing_no,
                'Description': ci.description || '',
                'Quantity': ci.qty,
                'Current Price': '‚Ç¨' + ci.current_price.toFixed(2),
                'Target Price': '‚Ç¨' + ci.target_price.toFixed(2),
                'Reduction': ci.reduction,
                'Line Savings': '‚Ç¨' + ((ci.current_price - ci.target_price) * ci.qty).toFixed(2)
            }));

            // Add summary row
            exportData.push({});
            exportData.push({
                'Drawing No': 'TOTAL',
                'Description': '',
                'Quantity': '',
                'Current Price': '‚Ç¨' + challenge.total_current.toFixed(2),
                'Target Price': '‚Ç¨' + challenge.total_target.toFixed(2),
                'Reduction': '',
                'Line Savings': '‚Ç¨' + (challenge.total_current - challenge.total_target).toFixed(2)
            });

            exportToExcelFull(exportData, `Challenge_${supplier.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}`,
                `Challenge to: ${supplier}\nDeadline: ${deadline}\nContact: ${contact}\n\nMessage:\n${message}`);

            document.getElementById('challenge-modal')?.remove();
            renderFinalSummary();
            if (window.showToast) showToast('Challenge created & exported!', 'success');
        };

        // Preview challenge as PDF
        window.exportChallengePreview = function (supplier) {
            const challengeItems = [];
            document.querySelectorAll('.challenge-item:checked').forEach(cb => {
                const dn = cb.dataset.dn;
                const currentPrice = parseFloat(cb.dataset.price) || 0;
                const qty = parseFloat(cb.dataset.qty) || 1;
                const targetInput = document.querySelector(`.challenge-target-input[data-dn="${dn}"]`);
                const targetPrice = parseFloat(targetInput?.value) || currentPrice;

                challengeItems.push({
                    drawing_no: dn,
                    qty: qty,
                    current_price: currentPrice,
                    target_price: targetPrice,
                    reduction: currentPrice > 0 ? ((currentPrice - targetPrice) / currentPrice * 100).toFixed(1) + '%' : '0%'
                });
            });

            if (challengeItems.length === 0) {
                if (window.showToast) showToast('Please select at least one item', 'warning');
                return;
            }

            const message = document.getElementById('challenge-message')?.value || '';
            const deadline = document.getElementById('challenge-deadline')?.value || '';
            const contact = document.getElementById('challenge-contact')?.value || '';
            const email = document.getElementById('challenge-email')?.value || '';

            const totalCurrent = challengeItems.reduce((sum, ci) => sum + (ci.current_price * ci.qty), 0);
            const totalTarget = challengeItems.reduce((sum, ci) => sum + (ci.target_price * ci.qty), 0);
            const totalSavings = totalCurrent - totalTarget;

            // Create a preview challenge object for PDF export
            const previewChallenge = {
                id: 'PREVIEW',
                supplier: supplier,
                message: message,
                deadline: deadline,
                contact: contact,
                email: email,
                status: 'preview',
                created: new Date().toISOString(),
                comments: []
            };

            // Create data for PDF
            const data = challengeItems.map(ci => ({
                'Drawing No': ci.drawing_no,
                'Qty': ci.qty,
                'Current Price': '‚Ç¨' + ci.current_price.toFixed(2),
                'Target Price': '‚Ç¨' + ci.target_price.toFixed(2),
                'Reduction': ci.reduction,
                'Line Savings': '‚Ç¨' + ((ci.current_price - ci.target_price) * ci.qty).toFixed(2)
            }));

            exportChallengeToPDF(previewChallenge, data, totalCurrent, totalTarget, totalSavings);
        };

        // Challenge detail view - Enhanced version
        window.openChallengeDetail = function (idx) {
            const challenge = window.fsState.challenges[idx];
            if (!challenge) return;

            // Calculate totals
            const totalCurrent = (challenge.items || []).reduce((s, ci) => s + ((parseFloat(ci.current_price) || 0) * (parseFloat(ci.qty) || 1)), 0);
            const totalTarget = (challenge.items || []).reduce((s, ci) => s + ((parseFloat(ci.target_price) || 0) * (parseFloat(ci.qty) || 1)), 0);
            const totalSavings = totalCurrent - totalTarget;
            const savingsPercent = totalCurrent > 0 ? ((totalSavings / totalCurrent) * 100).toFixed(1) : 0;

            // Status colors
            const statusColors = {
                'open': { bg: '#fef3c7', color: '#92400e', icon: '‚è≥' },
                'pending': { bg: '#dbeafe', color: '#1d4ed8', icon: 'üì§' },
                'accepted': { bg: '#dcfce7', color: '#166534', icon: '‚úÖ' },
                'rejected': { bg: '#fee2e2', color: '#991b1b', icon: '‚ùå' },
                'new_quote': { bg: '#e0e7ff', color: '#4338ca', icon: 'üìã' }
            };
            const statusStyle = statusColors[challenge.status] || statusColors['open'];

            // Check if has new quote linked
            const hasNewQuote = challenge.new_quote_id;

            // Remove existing modal
            document.getElementById('challenge-detail-modal')?.remove();

            const modal = document.createElement('div');
            modal.id = 'challenge-detail-modal';
            modal.className = 'rfq-modal-overlay';
            modal.innerHTML = `
                <div class="rfq-modal-container" style="max-width:900px; max-height:90vh; display:flex; flex-direction:column;">
                    <div class="rfq-wizard-header" style="background:linear-gradient(135deg,#d97706,#f59e0b);">
                        <div>
                            <h3 style="color:white; margin:0;">‚ö° Challenge Details</h3>
                            <span style="color:rgba(255,255,255,0.8); font-size:12px;">${escapeHtml(challenge.supplier)} ‚Ä¢ ID: ${challenge.id} ‚Ä¢ Created: ${challenge.created ? new Date(challenge.created).toLocaleDateString() : '‚Äî'}</span>
                        </div>
                        <button onclick="document.getElementById('challenge-detail-modal').remove()" class="rfq-btn-close" style="color:white; font-size:24px;">&times;</button>
                    </div>
                    <div style="padding:20px; flex:1; overflow-y:auto;">
                        <!-- Status & Stats Row -->
                        <div style="display:grid; grid-template-columns:repeat(5, 1fr); gap:12px; margin-bottom:20px;">
                            <div style="background:${statusStyle.bg}; padding:14px; border-radius:10px; text-align:center; border:2px solid ${statusStyle.color};">
                                <div style="font-size:24px;">${statusStyle.icon}</div>
                                <div style="font-size:14px; font-weight:700; color:${statusStyle.color}; text-transform:uppercase;">${challenge.status}</div>
                            </div>
                            <div style="background:#f8fafc; padding:14px; border-radius:10px; text-align:center;">
                                <div style="font-size:22px; font-weight:700;">${challenge.items?.length || 0}</div>
                                <div style="font-size:10px; color:#64748b; text-transform:uppercase;">Items</div>
                            </div>
                            <div style="background:#f8fafc; padding:14px; border-radius:10px; text-align:center;">
                                <div style="font-size:16px; font-weight:700;">‚Ç¨${totalCurrent.toFixed(0)}</div>
                                <div style="font-size:10px; color:#64748b; text-transform:uppercase;">Current</div>
                            </div>
                            <div style="background:#f8fafc; padding:14px; border-radius:10px; text-align:center;">
                                <div style="font-size:16px; font-weight:700; color:#d97706;">‚Ç¨${totalTarget.toFixed(0)}</div>
                                <div style="font-size:10px; color:#64748b; text-transform:uppercase;">Target</div>
                            </div>
                            <div style="background:linear-gradient(135deg,#dcfce7,#bbf7d0); padding:14px; border-radius:10px; text-align:center; border:2px solid #16a34a;">
                                <div style="font-size:18px; font-weight:800; color:#16a34a;">‚Ç¨${totalSavings.toFixed(0)}</div>
                                <div style="font-size:10px; color:#166534; text-transform:uppercase;">${savingsPercent}% Savings</div>
                            </div>
                        </div>

                        <!-- Info Row -->
                        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-bottom:20px; background:#f8fafc; padding:14px; border-radius:10px;">
                            <div><span style="color:#64748b; font-size:11px;">Deadline:</span> <strong style="font-size:13px;">${challenge.deadline || '‚Äî'}</strong></div>
                            <div><span style="color:#64748b; font-size:11px;">Contact:</span> <strong style="font-size:13px;">${escapeHtml(challenge.contact || '‚Äî')}</strong></div>
                            <div><span style="color:#64748b; font-size:11px;">Email:</span> <strong style="font-size:13px;">${escapeHtml(challenge.email || '‚Äî')}</strong></div>
                        </div>

                        ${hasNewQuote ? `
                        <div style="background:#e0e7ff; border:2px solid #4338ca; border-radius:10px; padding:14px; margin-bottom:20px;">
                            <div style="display:flex; align-items:center; justify-content:space-between;">
                                <div>
                                    <div style="font-weight:700; color:#4338ca;">üìã New Quote Received</div>
                                    <div style="font-size:12px; color:#6366f1;">Quote ID: ${challenge.new_quote_id}</div>
                                </div>
                                <button onclick="window.viewNewQuote('${challenge.new_quote_id}')" class="rfq-btn-primary" style="background:#4338ca;">View New Quote ‚Üí</button>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Message -->
                        ${challenge.message ? `
                        <div style="margin-bottom:20px;">
                            <div style="font-weight:600; font-size:12px; margin-bottom:8px; color:#475569;">üìù Challenge Message</div>
                            <div style="background:#fffbeb; border-left:4px solid #f59e0b; padding:14px; border-radius:0 10px 10px 0; font-size:13px; color:#78350f;">${escapeHtml(challenge.message)}</div>
                        </div>
                        ` : ''}

                        <!-- Items Table -->
                        <div style="margin-bottom:20px;">
                            <div style="font-weight:600; font-size:12px; margin-bottom:8px; color:#475569;">üìã Challenged Items</div>
                            <div style="max-height:200px; overflow:auto; border:1px solid #e5e7eb; border-radius:10px;">
                                <table style="width:100%; font-size:11px; border-collapse:collapse;">
                                    <thead style="background:#1e293b; color:white; position:sticky; top:0;">
                                        <tr>
                                            <th style="padding:10px 8px; text-align:left;">Drawing No</th>
                                            <th style="padding:10px 8px; text-align:left;">Description</th>
                                            <th style="padding:10px 8px; text-align:center;">Qty</th>
                                            <th style="padding:10px 8px; text-align:right;">Current ‚Ç¨</th>
                                            <th style="padding:10px 8px; text-align:right;">Target ‚Ç¨</th>
                                            <th style="padding:10px 8px; text-align:right;">Line Savings</th>
                                            ${hasNewQuote ? '<th style="padding:10px 8px; text-align:right;">New Price</th>' : ''}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${(challenge.items || []).map((ci, i) => {
                const qty = parseFloat(ci.qty) || 1;
                const lineSavings = (parseFloat(ci.current_price) - parseFloat(ci.target_price)) * qty;
                const newPrice = ci.new_price ? parseFloat(ci.new_price) : null;
                const rowBg = i % 2 === 0 ? '#ffffff' : '#f8fafc';
                return `
                                                <tr style="background:${rowBg};">
                                                    <td style="padding:8px; font-weight:600; color:#3b82f6;">${escapeHtml(ci.drawing_no)}</td>
                                                    <td style="padding:8px; max-width:150px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(ci.description || '‚Äî')}</td>
                                                    <td style="padding:8px; text-align:center;">${qty}</td>
                                                    <td style="padding:8px; text-align:right;">‚Ç¨${(parseFloat(ci.current_price) || 0).toFixed(2)}</td>
                                                    <td style="padding:8px; text-align:right; color:#d97706; font-weight:600;">‚Ç¨${(parseFloat(ci.target_price) || 0).toFixed(2)}</td>
                                                    <td style="padding:8px; text-align:right; color:#16a34a; font-weight:600;">‚Ç¨${lineSavings.toFixed(2)}</td>
                                                    ${hasNewQuote ? `<td style="padding:8px; text-align:right; color:#4338ca; font-weight:700;">${newPrice !== null ? '‚Ç¨' + newPrice.toFixed(2) : '‚Äî'}</td>` : ''}
                                                </tr>
                                            `;
            }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Comments Section -->
                        <div style="margin-bottom:16px;">
                            <div style="font-weight:600; font-size:12px; margin-bottom:8px; color:#475569;">üí¨ Comments & History</div>
                            <div id="challenge-comments" style="max-height:120px; overflow-y:auto; background:#f8fafc; border-radius:10px; padding:12px; margin-bottom:10px;">
                                ${(challenge.comments || []).map(c => `
                                    <div style="padding:10px; background:white; border-radius:8px; margin-bottom:8px; border-left:3px solid ${c.type === 'system' ? '#64748b' : '#3b82f6'};">
                                        <div style="display:flex; justify-content:space-between; align-items:center;">
                                            <span style="font-size:10px; color:#64748b;">${new Date(c.date).toLocaleString()}</span>
                                            ${c.type ? `<span style="font-size:9px; background:#e2e8f0; padding:2px 6px; border-radius:4px;">${c.type}</span>` : ''}
                                        </div>
                                        <div style="font-size:12px; margin-top:4px;">${escapeHtml(c.text)}</div>
                                    </div>
                                `).join('') || '<div style="color:#94a3b8; font-size:11px; text-align:center; padding:20px;">No comments yet</div>'}
                            </div>
                            <div style="display:flex; gap:8px;">
                                <input type="text" id="challenge-new-comment" class="rfq-input" style="flex:1;" placeholder="Add comment...">
                                <button onclick="window.addChallengeComment(${idx})" class="rfq-btn-secondary">Add</button>
                            </div>
                        </div>
                    </div>

                    <!-- Footer with Actions -->
                    <div class="rfq-wizard-footer" style="display:flex; flex-wrap:wrap; gap:8px; justify-content:space-between; align-items:center; padding:16px 20px; background:#f8fafc; border-top:1px solid #e2e8f0;">
                        <div style="display:flex; gap:8px;">
                            <button onclick="document.getElementById('challenge-detail-modal').remove()" class="rfq-btn-secondary">Close</button>
                            <button onclick="window.exportChallenge(${idx}, 'excel')" class="rfq-btn-secondary">üìä Excel</button>
                            <button onclick="window.exportChallenge(${idx}, 'pdf')" class="rfq-btn-secondary">üìÑ PDF</button>
                        </div>
                        ${challenge.status === 'open' || challenge.status === 'pending' ? `
                        <div style="display:flex; gap:8px;">
                            <button onclick="window.recordNewQuote(${idx})" class="rfq-btn-primary" style="background:#4338ca;">üìã Record New Quote</button>
                            <button onclick="window.approveChallenge(${idx})" class="rfq-btn-success">‚úÖ Approve</button>
                            <button onclick="window.declineChallenge(${idx})" class="rfq-btn-danger" style="background:#ef4444;">‚ùå Decline</button>
                        </div>
                        ` : `
                        <div style="font-size:12px; color:#64748b;">
                            Closed: ${challenge.closed ? new Date(challenge.closed).toLocaleDateString() : '‚Äî'}
                        </div>
                        `}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        };

        // Record new quote from supplier response to challenge
        window.recordNewQuote = function (challengeIdx) {
            const challenge = window.fsState.challenges?.[challengeIdx];
            if (!challenge || !currentProject) return;

            document.getElementById('challenge-detail-modal')?.remove();

            const modal = document.createElement('div');
            modal.id = 'new-quote-modal';
            modal.className = 'rfq-modal-overlay';
            modal.innerHTML = `
                <div class="rfq-modal-container" style="max-width:700px;">
                    <div class="rfq-wizard-header" style="background:linear-gradient(135deg,#4338ca,#6366f1);">
                        <div>
                            <h3 style="color:white; margin:0;">üìã Record New Quote</h3>
                            <span style="color:rgba(255,255,255,0.8); font-size:12px;">Response from ${escapeHtml(challenge.supplier)} to Challenge ${challenge.id}</span>
                        </div>
                        <button onclick="document.getElementById('new-quote-modal').remove(); window.openChallengeDetail(${challengeIdx})" class="rfq-btn-close" style="color:white;">&times;</button>
                    </div>
                    <div style="padding:20px;">
                        <p style="font-size:12px; color:#64748b; margin-bottom:16px;">Enter the new prices from supplier's response. This will create a new quote in Sourcing Strategy and link it to this challenge.</p>

                        <div style="max-height:300px; overflow:auto; border:1px solid #e5e7eb; border-radius:8px; margin-bottom:16px;">
                            <table style="width:100%; font-size:11px; border-collapse:collapse;">
                                <thead style="background:#1e293b; color:white; position:sticky; top:0;">
                                    <tr>
                                        <th style="padding:10px 8px; text-align:left;">Drawing No</th>
                                        <th style="padding:10px 8px; text-align:right;">Original ‚Ç¨</th>
                                        <th style="padding:10px 8px; text-align:right;">Target ‚Ç¨</th>
                                        <th style="padding:10px 8px; text-align:right;">New Price ‚Ç¨</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${(challenge.items || []).map((ci, i) => `
                                        <tr style="background:${i % 2 === 0 ? '#fff' : '#f8fafc'};">
                                            <td style="padding:8px; font-weight:600;">${escapeHtml(ci.drawing_no)}</td>
                                            <td style="padding:8px; text-align:right;">‚Ç¨${(parseFloat(ci.current_price) || 0).toFixed(2)}</td>
                                            <td style="padding:8px; text-align:right; color:#d97706;">‚Ç¨${(parseFloat(ci.target_price) || 0).toFixed(2)}</td>
                                            <td style="padding:8px; text-align:right;">
                                                <input type="number" class="new-quote-price rfq-input" data-dn="${escapeHtml(ci.drawing_no)}"
                                                    style="width:90px; padding:6px; text-align:right;" step="0.01"
                                                    value="${(parseFloat(ci.target_price) || 0).toFixed(2)}" placeholder="New price">
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>

                        <div class="rfq-form-group" style="margin-bottom:12px;">
                            <label style="font-size:12px; font-weight:600; display:block; margin-bottom:6px;">Quote Reference / Notes</label>
                            <input type="text" id="new-quote-reference" class="rfq-input" style="width:100%;" placeholder="e.g. Quote #12345, Email from 2024-01-15...">
                        </div>

                        <div class="rfq-form-group">
                            <label style="font-size:12px; font-weight:600; display:block; margin-bottom:6px;">Quote Date</label>
                            <input type="date" id="new-quote-date" class="rfq-input" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                    </div>
                    <div class="rfq-wizard-footer">
                        <button onclick="document.getElementById('new-quote-modal').remove(); window.openChallengeDetail(${challengeIdx})" class="rfq-btn-secondary">Cancel</button>
                        <button onclick="window.saveNewQuoteFromChallenge(${challengeIdx})" class="rfq-btn-primary" style="background:#4338ca;">üíæ Save New Quote</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        };

        // Save the new quote from challenge response
        window.saveNewQuoteFromChallenge = function (challengeIdx) {
            const challenge = currentProject?.challenges?.[challengeIdx];
            if (!challenge) return;

            const newQuoteId = 'quote_' + Date.now();
            const reference = document.getElementById('new-quote-reference')?.value || '';
            const quoteDate = document.getElementById('new-quote-date')?.value || new Date().toISOString().split('T')[0];

            // Collect new prices
            const newPrices = {};
            document.querySelectorAll('.new-quote-price').forEach(input => {
                const dn = input.dataset.dn;
                const price = parseFloat(input.value);
                if (dn && !isNaN(price)) {
                    newPrices[dn] = price;
                }
            });

            // Update challenge items with new prices
            (challenge.items || []).forEach(ci => {
                if (newPrices[ci.drawing_no] !== undefined) {
                    ci.new_price = newPrices[ci.drawing_no];
                }
            });

            // Link new quote to challenge
            challenge.new_quote_id = newQuoteId;
            challenge.new_quote_date = quoteDate;
            challenge.new_quote_reference = reference;
            challenge.status = 'new_quote';

            // Add to challenge comments
            if (!challenge.comments) challenge.comments = [];
            challenge.comments.push({
                date: new Date().toISOString(),
                type: 'system',
                text: `New quote recorded (${newQuoteId}). Reference: ${reference || 'N/A'}`
            });

            // Add new quote to Sourcing Strategy for each item
            (challenge.items || []).forEach(ci => {
                const item = currentProject.items.find(it => {
                    const itemDn = it.item_drawing_no || it.drawing_no || it.dn || it.part_no || '';
                    return itemDn === ci.drawing_no;
                });

                if (item) {
                    // Mark old quote as challenged
                    if (!item.supplier_quotes) item.supplier_quotes = [];

                    // Find and mark existing quote from this supplier
                    item.supplier_quotes.forEach(sq => {
                        if (sq.supplier_name === challenge.supplier && !sq.challenged) {
                            sq.challenged = true;
                            sq.challenged_date = new Date().toISOString();
                            sq.see_new_quote = newQuoteId;
                            sq.notes = (sq.notes || '') + ` [Challenged - see ${newQuoteId}]`;
                        }
                    });

                    // Add new quote
                    item.supplier_quotes.push({
                        id: newQuoteId,
                        supplier_name: challenge.supplier,
                        price_1: newPrices[ci.drawing_no] || ci.target_price,
                        upload_date: quoteDate,
                        notes: `Challenge response. Original: ‚Ç¨${ci.current_price}, Target: ‚Ç¨${ci.target_price}. Ref: ${reference}`,
                        from_challenge: challenge.id,
                        is_challenge_response: true
                    });

                    // Update item challenge status
                    item.challenge_status = 'new_quote';
                    item.latest_quote_id = newQuoteId;
                }
            });

            // Save
            if (typeof updateProject === 'function') updateProject(currentProject);

            document.getElementById('new-quote-modal')?.remove();
            renderFinalSummary();
            window.openChallengeDetail(challengeIdx);

            if (window.showToast) showToast('New quote recorded and linked to Sourcing Strategy!', 'success');
        };

        // Approve challenge - accept new prices
        window.approveChallenge = function (idx) {
            if (!currentProject) return;

            const challenge = currentProject.challenges[idx];
            if (!challenge) return;

            // Use new prices if available, otherwise target prices
            (challenge.items || []).forEach(ci => {
                const item = currentProject.items.find(it => {
                    const itemDn = it.item_drawing_no || it.drawing_no || it.dn || it.part_no || '';
                    return itemDn === ci.drawing_no;
                });
                if (item) {
                    // Update to new price or target price
                    const newPrice = ci.new_price !== undefined ? ci.new_price : ci.target_price;
                    item.price_1 = newPrice;
                    item.challenge_status = 'accepted';
                    item.price_updated_from_challenge = challenge.id;
                }
            });

            challenge.status = 'accepted';
            challenge.closed = new Date().toISOString();

            if (!challenge.comments) challenge.comments = [];
            challenge.comments.push({
                date: new Date().toISOString(),
                type: 'system',
                text: 'Challenge APPROVED. Prices updated.'
            });

            if (typeof updateProject === 'function') updateProject(currentProject);
            document.getElementById('challenge-detail-modal')?.remove();
            renderFinalSummary();
            if (window.showToast) showToast('Challenge approved! Prices updated.', 'success');
        };

        // Decline challenge
        window.declineChallenge = function (idx) {
            if (!currentProject) return;

            const challenge = currentProject.challenges[idx];
            if (!challenge) return;

            (challenge.items || []).forEach(ci => {
                const item = currentProject.items.find(it => {
                    const itemDn = it.item_drawing_no || it.drawing_no || it.dn || it.part_no || '';
                    return itemDn === ci.drawing_no;
                });
                if (item) {
                    item.challenge_status = 'rejected';
                }
            });

            challenge.status = 'rejected';
            challenge.closed = new Date().toISOString();

            if (!challenge.comments) challenge.comments = [];
            challenge.comments.push({
                date: new Date().toISOString(),
                type: 'system',
                text: 'Challenge DECLINED. Original prices retained.'
            });

            if (typeof updateProject === 'function') updateProject(currentProject);
            document.getElementById('challenge-detail-modal')?.remove();
            renderFinalSummary();
            if (window.showToast) showToast('Challenge declined.', 'info');
        };

        window.addChallengeComment = function (idx) {
            const input = document.getElementById('challenge-new-comment');
            const text = input?.value?.trim();
            if (!text || !currentProject) return;

            if (!currentProject.challenges[idx].comments) currentProject.challenges[idx].comments = [];
            currentProject.challenges[idx].comments.push({
                date: new Date().toISOString(),
                text
            });

            if (typeof updateProject === 'function') updateProject(currentProject);
            input.value = '';

            // Refresh modal
            document.getElementById('challenge-detail-modal')?.remove();
            window.openChallengeDetail(idx);
        };

        window.closeChallenge = function (idx, result) {
            if (!currentProject) return;

            const challenge = currentProject.challenges[idx];
            challenge.status = result;
            challenge.closed = new Date().toISOString();

            // If accepted, update item prices
            if (result === 'accepted') {
                (challenge.items || []).forEach(ci => {
                    const item = currentProject.items.find(it => (it.drawing_no || it.dn) === ci.drawing_no);
                    if (item) {
                        item.price_1 = ci.target_price;
                        item.challenge_status = 'accepted';
                    }
                });
            } else {
                (challenge.items || []).forEach(ci => {
                    const item = currentProject.items.find(it => (it.drawing_no || it.dn) === ci.drawing_no);
                    if (item) item.challenge_status = 'rejected';
                });
            }

            if (typeof updateProject === 'function') updateProject(currentProject);
            document.getElementById('challenge-detail-modal')?.remove();
            renderFinalSummary();
            if (window.showToast) showToast(`Challenge ${result}!`, result === 'accepted' ? 'success' : 'info');
        };

        window.exportChallenge = function (idx, format) {
            const challenge = window.fsState.challenges[idx];
            if (!challenge) return;

            const data = (challenge.items || []).map(ci => ({
                'Drawing No': ci.drawing_no,
                'MPN': ci.mpn || '',
                'Manufacturer': ci.manufacturer || '',
                'Description': ci.description || '',
                'Qty 1': ci.qty_1 || '',
                'Current Price': '‚Ç¨' + (ci.current_price || 0).toFixed(2),
                'Target Price': '‚Ç¨' + (ci.target_price || 0).toFixed(2),
                'Reduction': ci.reduction || '',
                'Status': challenge.status || ''
            }));

            const totalCurrentValue = (challenge.items || []).reduce((s, ci) => s + (parseFloat(ci.current_price) || 0), 0);
            const totalTargetValue = (challenge.items || []).reduce((s, ci) => s + (parseFloat(ci.target_price) || 0), 0);
            const totalSavings = totalCurrentValue - totalTargetValue;

            if (format === 'pdf') {
                exportChallengeToPDF(challenge, data, totalCurrentValue, totalTargetValue, totalSavings);
            } else {
                exportChallengeToExcel(challenge, data, totalCurrentValue, totalTargetValue, totalSavings);
            }
            if (window.showToast) showToast(`Challenge ${format.toUpperCase()} exported!`, 'success');
        };

        function exportChallengeToExcel(challenge, data, totalCurrent, totalTarget, savings) {
            if (!window.XLSX) {
                if (window.showToast) showToast('Excel library not loaded', 'error');
                return;
            }

            const wb = XLSX.utils.book_new();
            const headerRows = [
                ['PRICE CHALLENGE REQUEST'],
                [''],
                ['Supplier:', challenge.supplier],
                ['Challenge ID:', challenge.id],
                ['Status:', challenge.status?.toUpperCase()],
                ['Created:', new Date(challenge.created).toLocaleDateString()],
                ['Deadline:', challenge.deadline || 'N/A'],
                [''],
                ['Message:', challenge.message || 'Please review and provide best pricing.'],
                ['']
            ];

            const headers = Object.keys(data[0] || {});
            const dataRows = data.map(row => headers.map(h => row[h]));
            const allRows = [...headerRows, headers, ...dataRows];
            allRows.push([]);
            allRows.push(['', '', '', '', '', 'Current Total:', '‚Ç¨' + totalCurrent.toFixed(2), 'Target Total:', '‚Ç¨' + totalTarget.toFixed(2)]);
            allRows.push(['', '', '', '', '', '', '', 'Potential Savings:', '‚Ç¨' + savings.toFixed(2)]);

            if (challenge.comments?.length > 0) {
                allRows.push([]);
                allRows.push(['COMMENTS:']);
                challenge.comments.forEach(c => {
                    allRows.push([new Date(c.date).toLocaleString(), c.text]);
                });
            }

            const ws = XLSX.utils.aoa_to_sheet(allRows);
            ws['!cols'] = [{ wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 25 }, { wch: 10 }, { wch: 14 }, { wch: 14 }, { wch: 12 }, { wch: 14 }];
            XLSX.utils.book_append_sheet(wb, ws, 'Challenge');
            XLSX.writeFile(wb, `Challenge_${challenge.supplier}_${challenge.id}.xlsx`);
        }

        function exportChallengeToPDF(challenge, data, totalCurrent, totalTarget, savings) {
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                if (window.showToast) showToast('Please allow popups for PDF export', 'error');
                return;
            }

            const headers = Object.keys(data[0] || {});
            const rows = data.map(row =>
                `<tr>${headers.map(h => `<td>${row[h] || ''}</td>`).join('')}</tr>`
            ).join('');

            const comments = (challenge.comments || []).map(c =>
                `<div class="comment"><span class="date">${new Date(c.date).toLocaleString()}</span><p>${c.text}</p></div>`
            ).join('') || '<p class="no-comments">No comments</p>';

            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Challenge - ${challenge.supplier}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'Segoe UI', Arial, sans-serif; padding: 40px; color: #1e293b; }
                        .header { background: linear-gradient(135deg, #d97706, #f59e0b); color: white; padding: 30px; border-radius: 12px; margin-bottom: 24px; }
                        .header h1 { font-size: 24px; margin-bottom: 4px; }
                        .header .id { opacity: 0.8; font-size: 12px; }
                        .meta-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px; }
                        .meta-card { background: #f8fafc; padding: 16px; border-radius: 10px; text-align: center; border: 1px solid #e2e8f0; }
                        .meta-card.savings { background: linear-gradient(135deg, #dcfce7, #bbf7d0); border-color: #16a34a; }
                        .meta-label { font-size: 10px; color: #64748b; text-transform: uppercase; margin-bottom: 4px; }
                        .meta-value { font-size: 18px; font-weight: 700; }
                        .meta-value.green { color: #16a34a; }
                        .section { margin-bottom: 24px; }
                        .section-title { font-size: 14px; font-weight: 700; color: #1e293b; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0; }
                        .message-box { background: #fffbeb; border-left: 4px solid #f59e0b; padding: 16px; border-radius: 0 8px 8px 0; font-style: italic; }
                        table { width: 100%; border-collapse: collapse; font-size: 11px; }
                        th { background: linear-gradient(135deg, #d97706, #f59e0b); color: white; padding: 10px 8px; text-align: left; font-size: 10px; text-transform: uppercase; }
                        td { padding: 10px 8px; border-bottom: 1px solid #e2e8f0; }
                        tr:nth-child(even) { background: #f8fafc; }
                        .total-row { background: linear-gradient(135deg, #fef3c7, #fde68a) !important; font-weight: 700; }
                        .comments { background: #f8fafc; border-radius: 8px; padding: 16px; }
                        .comment { background: white; padding: 12px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #e2e8f0; }
                        .comment .date { font-size: 10px; color: #64748b; }
                        .comment p { margin-top: 4px; font-size: 12px; }
                        .no-comments { color: #94a3b8; font-size: 12px; }
                        .footer { margin-top: 30px; text-align: center; color: #64748b; font-size: 10px; padding-top: 20px; border-top: 1px solid #e2e8f0; }
                        @media print { .header, th { print-color-adjust: exact; -webkit-print-color-adjust: exact; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>‚ö° Price Challenge Request</h1>
                        <div class="id">ID: ${challenge.id} | Supplier: ${challenge.supplier}</div>
                    </div>

                    <div class="meta-grid">
                        <div class="meta-card">
                            <div class="meta-label">Status</div>
                            <div class="meta-value">${challenge.status?.toUpperCase()}</div>
                        </div>
                        <div class="meta-card">
                            <div class="meta-label">Current Total</div>
                            <div class="meta-value">‚Ç¨${totalCurrent.toFixed(2)}</div>
                        </div>
                        <div class="meta-card">
                            <div class="meta-label">Target Total</div>
                            <div class="meta-value">‚Ç¨${totalTarget.toFixed(2)}</div>
                        </div>
                        <div class="meta-card savings">
                            <div class="meta-label">Potential Savings</div>
                            <div class="meta-value green">‚Ç¨${savings.toFixed(2)}</div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">üìù Message to Supplier</div>
                        <div class="message-box">${challenge.message || 'Please review and provide your best pricing for the items listed below.'}</div>
                    </div>

                    <div class="section">
                        <div class="section-title">üìã Items for Review</div>
                        <table>
                            <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>

                    <div class="section">
                        <div class="section-title">üí¨ Comments & History</div>
                        <div class="comments">${comments}</div>
                    </div>

                    <div class="footer">
                        Generated by RFQ System on ${new Date().toLocaleString()} | Project: ${currentProject?.name || 'N/A'}
                    </div>

                    <script>window.onload = function() { window.print(); };</script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // Single item challenge
        window.openItemChallenge = function (dn) {
            if (!currentProject) return;
            const item = currentProject.items.find(it => {
                const itemDn = it.item_drawing_no || it.drawing_no || it.dn || it.part_no || '';
                return itemDn === dn;
            });
            if (!item) {
                if (window.showToast) showToast('Item not found', 'error');
                return;
            }
            const supplier = item.supplier || item.awarded_supplier;
            if (!supplier) {
                if (window.showToast) showToast('Item has no awarded supplier', 'warning');
                return;
            }
            // Open challenge with this specific item pre-selected
            window.openSupplierChallengeWithItems(supplier, [dn]);
        };

        // Challenge selected items from the middle panel
        window.challengeSelectedItems = function () {
            const selectedChecks = document.querySelectorAll('.fs-item-check:checked');
            if (selectedChecks.length === 0) {
                // No items selected, challenge all items for selected supplier
                const supplier = window.fsState.selectedSupplier;
                if (!supplier) {
                    if (window.showToast) showToast('Please select a supplier first', 'warning');
                    return;
                }
                window.openSupplierChallenge(supplier);
                return;
            }

            // Get unique suppliers from selected items
            const supplierItems = new Map();
            selectedChecks.forEach(cb => {
                const dn = cb.dataset.dn;
                const supplier = cb.dataset.supplier;
                if (supplier) {
                    if (!supplierItems.has(supplier)) {
                        supplierItems.set(supplier, []);
                    }
                    supplierItems.get(supplier).push(dn);
                }
            });

            if (supplierItems.size === 0) {
                if (window.showToast) showToast('Selected items have no supplier', 'warning');
                return;
            }

            if (supplierItems.size > 1) {
                if (window.showToast) showToast('Please select items from only one supplier', 'warning');
                return;
            }

            // Open challenge for the single supplier with selected items
            const [supplier, items] = Array.from(supplierItems.entries())[0];
            window.openSupplierChallengeWithItems(supplier, items);
        };

        // Open supplier challenge with specific items pre-selected
        window.openSupplierChallengeWithItems = function (supplier, selectedDns) {
            const supplierData = window.fsState.supplierGroups?.get(supplier);
            if (!supplierData) {
                if (window.showToast) showToast('Supplier data not found', 'error');
                return;
            }

            // Store selected items for the modal
            window.fsState.challengeSelectedDns = new Set(selectedDns);

            // Open the regular challenge modal
            window.openSupplierChallenge(supplier);

            // After modal opens, uncheck items not in selection
            setTimeout(() => {
                if (selectedDns && selectedDns.length > 0) {
                    document.querySelectorAll('.challenge-item').forEach(cb => {
                        const dn = cb.dataset.dn;
                        cb.checked = window.fsState.challengeSelectedDns.has(dn);
                    });
                    // Update select all checkbox state
                    const selectAll = document.getElementById('challenge-select-all');
                    const allChecks = document.querySelectorAll('.challenge-item');
                    const checkedCount = document.querySelectorAll('.challenge-item:checked').length;
                    if (selectAll) {
                        selectAll.checked = checkedCount === allChecks.length;
                        selectAll.indeterminate = checkedCount > 0 && checkedCount < allChecks.length;
                    }
                    updateChallengeSelectedCount();
                    updateChallengeSavings();
                }
            }, 100);
        };

        // Navigation functions
        // Duplicate navigateToItem removed - see definition around line 30165
        /*
        window.navigateToItem = function (drawingNo) {
            // Switch to Price Comparison tab and highlight the item
            const tabBtn = document.querySelector('.rfq-tab[data-tab="price-comparison"]');
            if (tabBtn) tabBtn.click();
         
            setTimeout(() => {
                const searchInput = document.getElementById('rfq-item-search');
                if (searchInput) {
                    searchInput.value = drawingNo;
                    searchInput.dispatchEvent(new Event('input'));
                }
            }, 100);
         
            if (window.showToast) showToast(`Navigated to item: ${drawingNo}`, 'info');
        };
        */

        window.navigateToSupplier = function (supplierName) {
            // Switch to Supplier Selection tab and show supplier detail
            const tabBtn = document.querySelector('.rfq-tab[data-tab="supplier-selection"]');
            if (tabBtn) tabBtn.click();

            setTimeout(() => {
                // Try to find and click the supplier card
                const supplierCards = document.querySelectorAll('.supplier-card, [data-supplier]');
                supplierCards.forEach(card => {
                    if (card.textContent.includes(supplierName)) {
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        card.style.boxShadow = '0 0 0 3px #3b82f6';
                        setTimeout(() => card.style.boxShadow = '', 2000);
                    }
                });
            }, 100);

            if (window.showToast) showToast(`Navigated to supplier: ${supplierName}`, 'info');
        };

        // Export supplier items
        window.exportSupplierItems = function (supplier, format) {
            const supplierData = window.fsState.supplierGroups?.get(supplier);
            if (!supplierData) return;

            const data = supplierData.items.map(it => ({
                'Drawing No': it.item_drawing_no || it.drawing_no || it.dn || it.part_no || '',
                'MPN': it.mpn || it.MPN || '',
                'Manufacturer': it.manufacturer || '',
                'Description': it.description || '',
                'Qty 1': it.qty_1 || it.quantity || '',
                'Price 1': it.price_1 ? '‚Ç¨' + parseFloat(it.price_1).toFixed(2) : '',
                'Qty 2': it.qty_2 || '',
                'Price 2': it.price_2 ? '‚Ç¨' + parseFloat(it.price_2).toFixed(2) : '',
                'Qty 3': it.qty_3 || '',
                'Price 3': it.price_3 ? '‚Ç¨' + parseFloat(it.price_3).toFixed(2) : '',
                'Lead Time': it.lead_time || it.lt || '',
                'MOQ': it.moq || '',
                'Currency': it.currency || 'EUR',
                'Incoterms': it.incoterms || 'DAP',
                'Total': it.lineValue ? '‚Ç¨' + it.lineValue.toFixed(2) : ''
            }));

            if (format === 'pdf') {
                exportToPDF(data, supplier, supplierData.totalValue, 'Supplier Items');
            } else {
                exportToStyledExcel(data, `${supplier}_Items_${currentProject?.name || 'Export'}`, supplier, supplierData.totalValue);
            }
            if (window.showToast) showToast(`${format.toUpperCase()} exported!`, 'success');
        };

        // Styled Excel export
        function exportToStyledExcel(data, filename, title, totalValue) {
            if (!window.XLSX) {
                if (window.showToast) showToast('Excel library not loaded', 'error');
                return;
            }

            const wb = XLSX.utils.book_new();

            // Create header rows
            const headerRows = [
                ['RFQ SYSTEM - ' + (title || 'Export')],
                ['Project: ' + (currentProject?.name || 'N/A'), '', 'Date: ' + new Date().toLocaleDateString()],
                ['Total Value: ‚Ç¨' + (totalValue?.toLocaleString() || '0')],
                []
            ];

            // Convert data to array format
            const headers = Object.keys(data[0] || {});
            const dataRows = data.map(row => headers.map(h => row[h]));

            // Combine all rows
            const allRows = [...headerRows, headers, ...dataRows];

            // Add total row
            allRows.push([]);
            allRows.push(['', '', '', '', '', '', '', '', '', '', '', '', '', '', 'TOTAL: ‚Ç¨' + (totalValue?.toFixed(2) || '0')]);

            const ws = XLSX.utils.aoa_to_sheet(allRows);

            // Set column widths
            ws['!cols'] = [
                { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 30 },
                { wch: 10 }, { wch: 12 }, { wch: 10 }, { wch: 12 },
                { wch: 10 }, { wch: 12 }, { wch: 10 }, { wch: 8 },
                { wch: 8 }, { wch: 10 }, { wch: 12 }
            ];

            XLSX.utils.book_append_sheet(wb, ws, 'Data');
            XLSX.writeFile(wb, filename + '.xlsx');
        }

        // PDF Export with nice styling
        function exportToPDF(data, title, totalValue, docType) {
            // Create a printable HTML document
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                if (window.showToast) showToast('Please allow popups for PDF export', 'error');
                return;
            }

            const headers = Object.keys(data[0] || {});
            const rows = data.map(row =>
                `<tr>${headers.map(h => `<td>${row[h] || ''}</td>`).join('')}</tr>`
            ).join('');

            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${docType} - ${title}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body {
                            font-family: 'Segoe UI', Arial, sans-serif;
                            padding: 40px;
                            color: #1e293b;
                            background: white;
                        }
                        .header {
                            background: linear-gradient(135deg, #1e293b, #334155);
                            color: white;
                            padding: 30px;
                            border-radius: 12px;
                            margin-bottom: 30px;
                        }
                        .header h1 {
                            font-size: 28px;
                            margin-bottom: 8px;
                        }
                        .header .subtitle {
                            opacity: 0.8;
                            font-size: 14px;
                        }
                        .meta-row {
                            display: flex;
                            justify-content: space-between;
                            margin: 20px 0;
                            padding: 15px 20px;
                            background: #f8fafc;
                            border-radius: 8px;
                            border-left: 4px solid #3b82f6;
                        }
                        .meta-item { text-align: center; }
                        .meta-label { font-size: 11px; color: #64748b; text-transform: uppercase; }
                        .meta-value { font-size: 18px; font-weight: 700; color: #1e293b; }
                        .meta-value.total { color: #16a34a; font-size: 24px; }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 20px;
                            font-size: 11px;
                        }
                        th {
                            background: linear-gradient(135deg, #3b82f6, #2563eb);
                            color: white;
                            padding: 12px 8px;
                            text-align: left;
                            font-weight: 600;
                            text-transform: uppercase;
                            font-size: 10px;
                        }
                        td {
                            padding: 10px 8px;
                            border-bottom: 1px solid #e2e8f0;
                        }
                        tr:nth-child(even) { background: #f8fafc; }
                        tr:hover { background: #e0f2fe; }
                        .footer {
                            margin-top: 40px;
                            padding-top: 20px;
                            border-top: 2px solid #e2e8f0;
                            text-align: center;
                            color: #64748b;
                            font-size: 11px;
                        }
                        .total-row {
                            background: linear-gradient(135deg, #dcfce7, #bbf7d0) !important;
                            font-weight: 700;
                        }
                        .total-row td { border-top: 2px solid #16a34a; }
                        @media print {
                            body { padding: 20px; }
                            .header { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
                            th { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üìÑ ${docType}</h1>
                        <div class="subtitle">${title} - ${currentProject?.name || 'Project'}</div>
                    </div>

                    <div class="meta-row">
                        <div class="meta-item">
                            <div class="meta-label">Supplier</div>
                            <div class="meta-value">${title}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Items</div>
                            <div class="meta-value">${data.length}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Date</div>
                            <div class="meta-value">${new Date().toLocaleDateString()}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Total Value</div>
                            <div class="meta-value total">‚Ç¨${totalValue?.toLocaleString() || '0'}</div>
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                        </thead>
                        <tbody>
                            ${rows}
                            <tr class="total-row">
                                <td colspan="${headers.length - 1}" style="text-align:right;">TOTAL:</td>
                                <td style="font-size:14px;">‚Ç¨${totalValue?.toFixed(2) || '0'}</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="footer">
                        <p>Generated by RFQ System on ${new Date().toLocaleString()}</p>
                        <p>Project: ${currentProject?.name || 'N/A'} | Document: ${docType}</p>
                    </div>

                    <script>
                        window.onload = function() {
                            window.print();
                        };
                    </script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // Full export function with all qty/price columns
        function exportToExcelFull(data, filename, notes) {
            if (!window.XLSX) {
                if (window.showToast) showToast('Excel library not loaded', 'error');
                return;
            }

            const wb = XLSX.utils.book_new();

            // Main data sheet
            const ws = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Data');

            // Notes sheet if provided
            if (notes) {
                const notesWs = XLSX.utils.aoa_to_sheet([['Notes'], [notes]]);
                XLSX.utils.book_append_sheet(wb, notesWs, 'Notes');
            }

            XLSX.writeFile(wb, filename + '.xlsx');
        }

        function renderNonAwardedSuppliers(items) {
            const container = document.getElementById('fs-non-awarded-list');
            if (!container) return;

            // Get all suppliers who quoted but didn't win
            const awardedSuppliers = new Set();
            const loserData = new Map(); // supplier -> [items they lost]

            items.forEach(it => {
                const awardedSupplier = it.supplier || it.awarded_supplier;
                if (awardedSupplier) awardedSuppliers.add(awardedSupplier);

                // Check quotes from other suppliers
                const quotes = it.quotes || [];
                quotes.forEach(q => {
                    const qSupplier = q.supplier || q.supplier_name;
                    if (qSupplier && qSupplier !== awardedSupplier) {
                        if (!loserData.has(qSupplier)) loserData.set(qSupplier, []);
                        loserData.get(qSupplier).push(it.drawing_no || it.dn);
                    }
                });
            });

            if (loserData.size === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#94a3b8; font-size:11px;">No non-awarded suppliers to notify</div>';
                return;
            }

            container.innerHTML = Array.from(loserData.entries()).map(([supplier, lostItems]) => `
                <div class="fs-non-awarded-item" style="display:flex; justify-content:space-between; align-items:center; padding:8px 10px; background:#fef2f2; border-radius:6px; margin-bottom:6px; border:1px solid #fee2e2;">
                    <div>
                        <div style="font-weight:600; font-size:12px; color:#991b1b;">${escapeHtml(supplier)}</div>
                        <div style="font-size:10px; color:#dc2626;">${lostItems.length} items lost</div>
                    </div>
                    <button class="fs-doc-btn" onclick="window.generateLoserNotification('${escapeHtml(supplier)}')" style="padding:4px 8px; font-size:10px;">üìß Export</button>
                </div>
            `).join('');
        }

        function renderDocumentTracking() {
            const container = document.getElementById('fs-doc-tracking-list');
            if (!container || !currentProject) return;

            const docs = currentProject.final_documents || [];

            if (docs.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#94a3b8; font-size:11px;">No documents tracked yet</div>';
                return;
            }

            const today = new Date();
            container.innerHTML = docs.map(doc => {
                const dueDate = doc.due_date ? new Date(doc.due_date) : null;
                const isOverdue = dueDate && dueDate < today && doc.status !== 'signed' && doc.status !== 'received';
                const isCompleted = doc.status === 'signed' || doc.status === 'received';
                const itemClass = isOverdue ? 'overdue' : (isCompleted ? 'completed' : '');

                const statusIcons = {
                    'pending': '‚è≥',
                    'sent': 'üì§',
                    'received': 'üì•',
                    'signed': '‚úÖ',
                    'expired': '‚ùå'
                };

                return `
                    <div class="fs-doc-tracking-item ${itemClass}">
                        <div style="font-size:18px;">${statusIcons[doc.status] || 'üìÑ'}</div>
                        <div style="flex:1;">
                            <div style="font-weight:600; font-size:12px;">${escapeHtml(doc.name || doc.type)}</div>
                            <div style="font-size:10px; color:#64748b;">
                                ${doc.supplier ? escapeHtml(doc.supplier) + ' ‚Ä¢ ' : ''}
                                ${dueDate ? 'Due: ' + dueDate.toLocaleDateString() : ''}
                            </div>
                        </div>
                        <button class="rfq-btn-mini" onclick="editTrackedDocument('${doc.id}')">Edit</button>
                    </div>
                `;
            }).join('');
        }

        function bindFinalSummaryEvents() {
            if (window.__FS_EVENTS_BOUND__) return;
            window.__FS_EVENTS_BOUND__ = true;

            // Refresh button
            const btnRefresh = document.getElementById('btn-fs-refresh');
            if (btnRefresh) btnRefresh.onclick = () => renderFinalSummary();

            // Export summary (removed as button no longer exists in new layout)

            // Search items in middle panel
            const searchInput = document.getElementById('fs-items-search');
            const filterSelect = document.getElementById('fs-items-filter');
            if (searchInput) searchInput.oninput = () => renderFSSupplierItems();
            if (filterSelect) filterSelect.onchange = () => renderFSSupplierItems();

            // Supplier search in left sidebar
            const supplierSearch = document.getElementById('fs-supplier-search');
            if (supplierSearch) {
                supplierSearch.oninput = () => {
                    const query = supplierSearch.value.toLowerCase();
                    const cards = document.querySelectorAll('.fs-supplier-card-new');
                    cards.forEach(card => {
                        const name = (card.dataset.supplier || '').toLowerCase();
                        card.style.display = name.includes(query) ? '' : 'none';
                    });
                };
            }

            // Filter chips in middle panel
            document.querySelectorAll('.fs-filter-chip').forEach(chip => {
                chip.onclick = () => {
                    document.querySelectorAll('.fs-filter-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    const filter = chip.dataset.filter;
                    const select = document.getElementById('fs-items-filter');
                    if (select) select.value = filter;
                    renderFSSupplierItems();
                };
            });

            // Select all checkbox
            const selectAll = document.getElementById('fs-select-all');
            if (selectAll) {
                selectAll.onchange = () => {
                    const checks = document.querySelectorAll('.fs-item-check');
                    checks.forEach(cb => cb.checked = selectAll.checked);
                    updateBulkChallengeButton();
                };
            }

            // Bulk challenge button
            const btnBulkChallenge = document.getElementById('btn-fs-bulk-challenge');
            if (btnBulkChallenge) {
                btnBulkChallenge.onclick = () => {
                    const selected = Array.from(document.querySelectorAll('.fs-item-check:checked')).map(cb => cb.dataset.dn);
                    if (selected.length > 0) openBulkChallengeModal(selected);
                };
            }

            // Item checkboxes change
            document.getElementById('fs-items-tbody')?.addEventListener('change', (e) => {
                if (e.target.classList.contains('fs-item-check')) {
                    updateBulkChallengeButton();
                }
            });

            // Add document button
            const btnAddDoc = document.getElementById('btn-fs-add-document');
            if (btnAddDoc) btnAddDoc.onclick = () => openAddDocumentModal();

            // Document generation buttons
            document.querySelectorAll('.fs-doc-btn[data-action="generate"]').forEach(btn => {
                btn.onclick = () => generateDocument(btn.dataset.doc);
            });

            // Challenge modal
            const challengeClose = document.getElementById('fs-challenge-close');
            const challengeCancel = document.getElementById('fs-challenge-cancel');
            const challengeSend = document.getElementById('fs-challenge-send');
            if (challengeClose) challengeClose.onclick = () => closeChallengeModal();
            if (challengeCancel) challengeCancel.onclick = () => closeChallengeModal();
            if (challengeSend) challengeSend.onclick = () => sendChallenge();

            // Response modal
            const responseClose = document.getElementById('fs-response-close');
            const responseCancel = document.getElementById('fs-response-cancel');
            const responseSave = document.getElementById('fs-response-save');
            if (responseClose) responseClose.onclick = () => closeResponseModal();
            if (responseCancel) responseCancel.onclick = () => closeResponseModal();
            if (responseSave) responseSave.onclick = () => saveResponse();

            // Response type change
            const responseType = document.getElementById('fs-response-type');
            if (responseType) {
                responseType.onchange = () => {
                    const priceGroup = document.getElementById('fs-response-price-group');
                    if (priceGroup) {
                        priceGroup.style.display = responseType.value === 'rejected' ? 'none' : 'block';
                    }
                };
            }

            // Add document modal
            const addDocClose = document.getElementById('fs-add-doc-close');
            const addDocCancel = document.getElementById('fs-add-doc-cancel');
            const addDocSave = document.getElementById('fs-add-doc-save');
            if (addDocClose) addDocClose.onclick = () => closeAddDocModal();
            if (addDocCancel) addDocCancel.onclick = () => closeAddDocModal();
            if (addDocSave) addDocSave.onclick = () => saveTrackedDocument();

            // File upload zone
            const uploadZone = document.getElementById('fs-doc-upload-zone');
            const fileInput = document.getElementById('fs-doc-file');
            if (uploadZone && fileInput) {
                uploadZone.onclick = () => fileInput.click();
                fileInput.onchange = () => {
                    if (fileInput.files.length > 0) {
                        const fileName = fileInput.files[0].name;
                        document.getElementById('fs-doc-file-name').textContent = fileName;
                        document.getElementById('fs-doc-file-info').style.display = 'block';
                    }
                };
            }

            // Notify losers button
            const btnNotify = document.getElementById('btn-fs-notify-losers');
            if (btnNotify) btnNotify.onclick = () => generateAllLoserNotifications();
        }

        function updateBulkChallengeButton() {
            const btn = document.getElementById('btn-fs-bulk-challenge');
            const challengeBtn = document.getElementById('btn-challenge-selected');
            const selectedChecks = document.querySelectorAll('.fs-item-check:checked');
            const count = selectedChecks.length;

            // Update old bulk challenge button if exists
            if (btn) {
                btn.disabled = count === 0;
                btn.textContent = count > 0 ? `‚ö° Challenge ${count} Selected` : '‚ö° Challenge Selected';
            }

            // Update Challenge Center button
            if (challengeBtn) {
                if (count > 0) {
                    challengeBtn.textContent = `‚ö° Challenge ${count} Selected Items`;
                    challengeBtn.style.background = '#f59e0b';
                    challengeBtn.style.color = 'white';
                    challengeBtn.style.borderColor = '#f59e0b';
                } else {
                    challengeBtn.textContent = '‚ö° Challenge All Supplier Items';
                    challengeBtn.style.background = '';
                    challengeBtn.style.color = '';
                    challengeBtn.style.borderColor = '';
                }
            }

            // Update selection indicator
            const indicator = document.getElementById('fs-selection-indicator');
            const countEl = document.getElementById('fs-selection-count');
            const supplierEl = document.getElementById('fs-selection-supplier');

            if (indicator && countEl && supplierEl) {
                if (count > 0) {
                    // Get supplier from first selected item
                    const suppliers = new Set();
                    selectedChecks.forEach(cb => {
                        if (cb.dataset.supplier) suppliers.add(cb.dataset.supplier);
                    });
                    const supplierText = suppliers.size === 1 ? Array.from(suppliers)[0] : `${suppliers.size} suppliers`;

                    indicator.style.display = 'block';
                    countEl.textContent = count;
                    supplierEl.textContent = supplierText;

                    // Warn if multiple suppliers selected
                    if (suppliers.size > 1) {
                        indicator.style.background = '#fef3c7';
                        indicator.style.borderColor = '#f59e0b';
                        indicator.style.color = '#92400e';
                    } else {
                        indicator.style.background = '#eff6ff';
                        indicator.style.borderColor = '#3b82f6';
                        indicator.style.color = '#1d4ed8';
                    }
                } else {
                    indicator.style.display = 'none';
                }
            }
        }

        // Challenge Modal Functions
        let currentChallengeItem = null;

        window.openChallengeModal = function (dn) {
            if (!currentProject) return;
            const item = currentProject.items.find(it => (it.drawing_no || it.dn) === dn);
            if (!item) return;

            currentChallengeItem = item;
            const modal = document.getElementById('fs-challenge-modal');
            const subtitle = document.getElementById('fs-challenge-subtitle');
            const info = document.getElementById('fs-challenge-info');

            if (subtitle) subtitle.textContent = `${item.drawing_no || item.dn} - ${item.supplier || 'No supplier'}`;
            if (info) {
                const price = parseFloat(item.price_1) || 0;
                info.innerHTML = `
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                        <div><span style="color:#64748b;">Part:</span> <strong>${escapeHtml(item.drawing_no || item.dn)}</strong></div>
                        <div><span style="color:#64748b;">Supplier:</span> <strong>${escapeHtml(item.supplier || '‚Äî')}</strong></div>
                        <div><span style="color:#64748b;">Current Price:</span> <strong style="color:#16a34a;">‚Ç¨${price.toFixed(2)}</strong></div>
                        <div><span style="color:#64748b;">Qty:</span> <strong>${item.qty_1 || 1}</strong></div>
                    </div>
                `;
            }

            // Set default deadline to 7 days from now
            const deadline = document.getElementById('fs-challenge-deadline');
            if (deadline) {
                const d = new Date();
                d.setDate(d.getDate() + 7);
                deadline.value = d.toISOString().split('T')[0];
            }

            if (modal) modal.classList.remove('hidden');
        };

        function closeChallengeModal() {
            const modal = document.getElementById('fs-challenge-modal');
            if (modal) modal.classList.add('hidden');
            currentChallengeItem = null;
        }

        function sendChallenge() {
            if (!currentChallengeItem || !currentProject) return;

            const type = document.getElementById('fs-challenge-type')?.value;
            const targetPrice = document.getElementById('fs-challenge-target-price')?.value;
            const message = document.getElementById('fs-challenge-message')?.value;
            const deadline = document.getElementById('fs-challenge-deadline')?.value;

            // Update item with challenge info
            currentChallengeItem.challenge_status = 'challenged';
            currentChallengeItem.challenge_sent = new Date().toISOString();
            currentChallengeItem.challenge_type = type;
            currentChallengeItem.challenge_target = targetPrice;
            currentChallengeItem.challenge_message = message;
            currentChallengeItem.challenge_deadline = deadline;

            // Save project
            if (typeof updateProject === 'function') {
                updateProject(currentProject);
            }

            closeChallengeModal();
            renderFinalSummary();
            if (window.showToast) showToast('Challenge sent!', 'success');
        }

        // Response Modal Functions
        let currentResponseItem = null;

        window.openResponseModal = function (dn) {
            if (!currentProject) return;
            const item = currentProject.items.find(it => (it.drawing_no || it.dn) === dn);
            if (!item) return;

            currentResponseItem = item;
            const modal = document.getElementById('fs-response-modal');
            const subtitle = document.getElementById('fs-response-subtitle');
            const info = document.getElementById('fs-response-info');

            if (subtitle) subtitle.textContent = `${item.drawing_no || item.dn}`;
            if (info) {
                const price = parseFloat(item.price_1) || 0;
                info.innerHTML = `
                    <div style="font-size:12px;">
                        <div><strong>Challenge sent:</strong> ${item.challenge_sent ? new Date(item.challenge_sent).toLocaleDateString() : '‚Äî'}</div>
                        <div><strong>Target price:</strong> ‚Ç¨${item.challenge_target || '‚Äî'}</div>
                        <div><strong>Current price:</strong> ‚Ç¨${price.toFixed(2)}</div>
                    </div>
                `;
            }

            if (modal) modal.classList.remove('hidden');
        };

        function closeResponseModal() {
            const modal = document.getElementById('fs-response-modal');
            if (modal) modal.classList.add('hidden');
            currentResponseItem = null;
        }

        function saveResponse() {
            if (!currentResponseItem || !currentProject) return;

            const type = document.getElementById('fs-response-type')?.value;
            const newPrice = parseFloat(document.getElementById('fs-response-new-price')?.value) || null;
            const notes = document.getElementById('fs-response-notes')?.value;

            // Update item
            currentResponseItem.challenge_response = type;
            currentResponseItem.challenge_response_date = new Date().toISOString();
            currentResponseItem.challenge_notes = notes;

            if (type !== 'rejected' && newPrice) {
                currentResponseItem.challenge_new_price = newPrice;
                // Update the actual price
                currentResponseItem.price_1 = newPrice;
            }

            // Save project
            if (typeof updateProject === 'function') {
                updateProject(currentProject);
            }

            closeResponseModal();
            renderFinalSummary();
            if (window.showToast) showToast('Response recorded & price updated!', 'success');
        }

        // Document Modal Functions
        window.openAddDocumentModal = function () {
            if (!currentProject) return;

            // Get suppliers
            const suppliers = new Set();
            (currentProject.items || []).forEach(it => {
                if (it.supplier) suppliers.add(it.supplier);
            });

            const supplierOptions = Array.from(suppliers).map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');

            const modal = document.createElement('div');
            modal.id = 'add-doc-modal';
            modal.className = 'rfq-modal-overlay';
            modal.innerHTML = `
                <div class="rfq-modal-container" style="max-width:500px;">
                    <div class="rfq-wizard-header" style="background:linear-gradient(135deg,#3b82f6,#2563eb);">
                        <div>
                            <h3 style="color:white;">üìé Add Signed Document</h3>
                            <span style="color:rgba(255,255,255,0.8);">Track received documents</span>
                        </div>
                        <button onclick="document.getElementById('add-doc-modal').remove()" class="rfq-btn-close" style="color:white;">&times;</button>
                    </div>
                    <div style="padding:20px;">
                        <div class="rfq-form-group" style="margin-bottom:16px;">
                            <label style="display:block; font-weight:600; margin-bottom:6px;">Document Type</label>
                            <select id="add-doc-type" class="rfq-input" style="width:100%;">
                                <option value="loi">Letter of Intent (LOI)</option>
                                <option value="contract">Contract</option>
                                <option value="po">Purchase Order</option>
                                <option value="nda">NDA</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="rfq-form-group" style="margin-bottom:16px;">
                            <label style="display:block; font-weight:600; margin-bottom:6px;">Supplier</label>
                            <select id="add-doc-supplier" class="rfq-input" style="width:100%;">
                                <option value="">‚Äî Select Supplier ‚Äî</option>
                                ${supplierOptions}
                            </select>
                        </div>
                        <div class="rfq-form-group" style="margin-bottom:16px;">
                            <label style="display:block; font-weight:600; margin-bottom:6px;">Due Date</label>
                            <input type="date" id="add-doc-due" class="rfq-input" style="width:100%;">
                        </div>
                        <div class="rfq-form-group" style="margin-bottom:16px;">
                            <label style="display:block; font-weight:600; margin-bottom:6px;">Notes</label>
                            <textarea id="add-doc-notes" class="rfq-input" style="width:100%; min-height:60px;" placeholder="Optional notes..."></textarea>
                        </div>
                    </div>
                    <div class="rfq-wizard-footer">
                        <button onclick="document.getElementById('add-doc-modal').remove()" class="rfq-btn-secondary">Cancel</button>
                        <button onclick="window.saveTrackedDocument()" class="rfq-btn-primary">Save Document</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        };

        function closeAddDocModal() {
            const modal = document.getElementById('fs-add-doc-modal');
            if (modal) modal.classList.add('hidden');
        }

        window.saveTrackedDocument = function () {
            if (!currentProject) return;

            const type = document.getElementById('add-doc-type')?.value;
            const supplier = document.getElementById('add-doc-supplier')?.value;
            const dueDate = document.getElementById('add-doc-due')?.value;
            const notes = document.getElementById('add-doc-notes')?.value;

            if (!currentProject.final_documents) currentProject.final_documents = [];

            currentProject.final_documents.push({
                id: 'doc_' + Date.now(),
                type,
                supplier,
                name: type?.toUpperCase() || 'Document',
                due_date: dueDate,
                status: 'pending',
                notes,
                created: new Date().toISOString()
            });

            if (typeof updateProject === 'function') {
                updateProject(currentProject);
            }

            document.getElementById('add-doc-modal')?.remove();
            renderFinalSummary();
            if (window.showToast) showToast('Document added!', 'success');
        };

        // Document Generation Functions
        window.generateDocument = function (docType) {
            if (!currentProject) return;

            // Show format selection modal
            const modal = document.createElement('div');
            modal.id = 'doc-format-modal';
            modal.className = 'rfq-modal-overlay';
            modal.innerHTML = `
                <div class="rfq-modal-container" style="max-width:400px;">
                    <div class="rfq-wizard-header" style="background:linear-gradient(135deg,#3b82f6,#2563eb);">
                        <div>
                            <h3 style="color:white;">üìÑ Export Document</h3>
                            <span style="color:rgba(255,255,255,0.8);">${docType.replace(/-/g, ' ').toUpperCase()}</span>
                        </div>
                        <button onclick="document.getElementById('doc-format-modal').remove()" class="rfq-btn-close" style="color:white;">&times;</button>
                    </div>
                    <div style="padding:24px; text-align:center;">
                        <p style="color:#64748b; margin-bottom:20px;">Choose export format:</p>
                        <div style="display:flex; gap:16px; justify-content:center;">
                            <button onclick="window.exportDocument('${docType}', 'excel'); document.getElementById('doc-format-modal').remove();" class="rfq-btn-secondary" style="padding:16px 32px; flex:1;">
                                <div style="font-size:24px; margin-bottom:4px;">üìä</div>
                                <div>Excel</div>
                            </button>
                            <button onclick="window.exportDocument('${docType}', 'pdf'); document.getElementById('doc-format-modal').remove();" class="rfq-btn-primary" style="padding:16px 32px; flex:1;">
                                <div style="font-size:24px; margin-bottom:4px;">üìÑ</div>
                                <div>PDF</div>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        window.exportDocument = function (docType, format) {
            if (!currentProject) return;

            const items = currentProject.items || [];
            const awardedItems = items.filter(it => it.supplier && parseFloat(it.price_1));
            const totalValue = awardedItems.reduce((s, it) => s + (parseFloat(it.qty_1 || it.quantity) || 1) * (parseFloat(it.price_1) || 0), 0);

            if (docType === 'parts-setup') {
                const data = awardedItems.map(it => ({
                    'Drawing No': it.item_drawing_no || it.drawing_no || it.dn || it.part_no || '',
                    'MPN': it.mpn || it.MPN || '',
                    'Manufacturer': it.manufacturer || '',
                    'Description': it.description || '',
                    'Supplier': it.supplier,
                    'Qty 1': it.qty_1 || it.quantity || 1,
                    'Price 1': '‚Ç¨' + (parseFloat(it.price_1) || 0).toFixed(2),
                    'Qty 2': it.qty_2 || '',
                    'Price 2': it.price_2 ? '‚Ç¨' + parseFloat(it.price_2).toFixed(2) : '',
                    'Qty 3': it.qty_3 || '',
                    'Price 3': it.price_3 ? '‚Ç¨' + parseFloat(it.price_3).toFixed(2) : '',
                    'Lead Time': it.lead_time || it.lt || '',
                    'MOQ': it.moq || '',
                    'Currency': it.currency || 'EUR',
                    'Incoterms': it.incoterms || 'DAP',
                    'Total': '‚Ç¨' + ((parseFloat(it.qty_1 || it.quantity) || 1) * (parseFloat(it.price_1) || 0)).toFixed(2)
                }));

                if (format === 'pdf') {
                    exportDocToPDF('Parts Setup', data, totalValue);
                } else {
                    exportDocToExcel('Parts_Setup', data, totalValue);
                }
            } else if (docType === 'change-doc') {
                const challengedItems = items.filter(it => it.challenge_status);
                const data = challengedItems.map(it => ({
                    'Drawing No': it.item_drawing_no || it.drawing_no || it.dn || it.part_no || '',
                    'MPN': it.mpn || it.MPN || '',
                    'Supplier': it.supplier,
                    'Original Price': '‚Ç¨' + (parseFloat(it.price_1) || 0).toFixed(2),
                    'Target Price': it.challenge_target_price ? '‚Ç¨' + parseFloat(it.challenge_target_price).toFixed(2) : '',
                    'New Price': it.challenge_new_price ? '‚Ç¨' + parseFloat(it.challenge_new_price).toFixed(2) : '',
                    'Status': it.challenge_status || '',
                    'Date': it.challenge_response_date ? new Date(it.challenge_response_date).toLocaleDateString() : ''
                }));

                if (format === 'pdf') {
                    exportDocToPDF('Price Changes', data, 0);
                } else {
                    exportDocToExcel('Price_Changes', data, 0);
                }
            } else if (docType === 'loi') {
                // Generate LOI summary by supplier
                const supplierGroups = new Map();
                awardedItems.forEach(it => {
                    const s = it.supplier;
                    if (!supplierGroups.has(s)) supplierGroups.set(s, { items: [], total: 0 });
                    const group = supplierGroups.get(s);
                    group.items.push(it);
                    group.total += (parseFloat(it.qty_1) || 1) * (parseFloat(it.price_1) || 0);
                });

                const data = [];
                supplierGroups.forEach((group, supplier) => {
                    data.push({
                        'Supplier': supplier,
                        'Items': group.items.length,
                        'Total Value': '‚Ç¨' + group.total.toFixed(2),
                        'Parts': group.items.map(it => it.drawing_no || it.dn).slice(0, 5).join(', ') + (group.items.length > 5 ? '...' : '')
                    });
                });

                if (format === 'pdf') {
                    exportDocToPDF('LOI Summary', data, totalValue);
                } else {
                    exportDocToExcel('LOI_Summary', data, totalValue);
                }
            }

            if (window.showToast) showToast(`${docType} ${format.toUpperCase()} exported!`, 'success');
        };

        function exportDocToExcel(docType, data, totalValue) {
            if (!window.XLSX) {
                if (window.showToast) showToast('Excel library not loaded', 'error');
                return;
            }

            const wb = XLSX.utils.book_new();
            const headerRows = [
                [`RFQ SYSTEM - ${docType.replace(/_/g, ' ').toUpperCase()}`],
                [''],
                ['Project:', currentProject?.name || 'N/A'],
                ['Date:', new Date().toLocaleDateString()],
                ['Total Value:', '‚Ç¨' + (totalValue || 0).toFixed(2)],
                ['']
            ];

            const headers = Object.keys(data[0] || {});
            const dataRows = data.map(row => headers.map(h => row[h]));
            const allRows = [...headerRows, headers, ...dataRows];

            const ws = XLSX.utils.aoa_to_sheet(allRows);
            ws['!cols'] = headers.map(() => ({ wch: 14 }));
            XLSX.utils.book_append_sheet(wb, ws, 'Data');
            XLSX.writeFile(wb, `${docType}_${currentProject?.name || 'Project'}.xlsx`);
        }

        function exportDocToPDF(docType, data, totalValue) {
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                if (window.showToast) showToast('Please allow popups for PDF export', 'error');
                return;
            }

            const headers = Object.keys(data[0] || {});
            const rows = data.map(row =>
                `<tr>${headers.map(h => `<td>${row[h] || ''}</td>`).join('')}</tr>`
            ).join('');

            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${docType} - ${currentProject?.name || 'Project'}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'Segoe UI', Arial, sans-serif; padding: 40px; color: #1e293b; }
                        .header { background: linear-gradient(135deg, #1e293b, #334155); color: white; padding: 30px; border-radius: 12px; margin-bottom: 24px; }
                        .header h1 { font-size: 24px; margin-bottom: 4px; }
                        .header .subtitle { opacity: 0.8; font-size: 12px; }
                        .meta-row { display: flex; justify-content: space-between; margin-bottom: 24px; padding: 16px 20px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #3b82f6; }
                        .meta-item { text-align: center; }
                        .meta-label { font-size: 10px; color: #64748b; text-transform: uppercase; }
                        .meta-value { font-size: 16px; font-weight: 600; }
                        .meta-value.total { color: #16a34a; font-size: 20px; }
                        table { width: 100%; border-collapse: collapse; font-size: 10px; }
                        th { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 10px 6px; text-align: left; font-size: 9px; text-transform: uppercase; }
                        td { padding: 8px 6px; border-bottom: 1px solid #e2e8f0; }
                        tr:nth-child(even) { background: #f8fafc; }
                        .footer { margin-top: 40px; text-align: center; color: #94a3b8; font-size: 10px; padding-top: 20px; border-top: 1px solid #e2e8f0; }
                        @media print { .header, th { print-color-adjust: exact; -webkit-print-color-adjust: exact; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üìÑ ${docType}</h1>
                        <div class="subtitle">${currentProject?.name || 'Project'}</div>
                    </div>

                    <div class="meta-row">
                        <div class="meta-item">
                            <div class="meta-label">Date</div>
                            <div class="meta-value">${new Date().toLocaleDateString()}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Items</div>
                            <div class="meta-value">${data.length}</div>
                        </div>
                        ${totalValue > 0 ? `
                        <div class="meta-item">
                            <div class="meta-label">Total Value</div>
                            <div class="meta-value total">‚Ç¨${totalValue.toLocaleString('en-US', { minimumFractionDigits: 2 })}</div>
                        </div>
                        ` : ''}
                    </div>

                    <table>
                        <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                        <tbody>${rows}</tbody>
                    </table>

                    <div class="footer">
                        Generated by RFQ System on ${new Date().toLocaleString()} | Project: ${currentProject?.name || 'N/A'}
                    </div>

                    <script>window.onload = function() { window.print(); };</script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        window.generateSupplierLOI = function (supplier) {
            if (!currentProject) return;

            const items = (currentProject.items || []).filter(it => it.supplier === supplier);
            const data = items.map(it => ({
                'Drawing No': it.drawing_no || it.dn,
                'Description': it.description || '',
                'Qty': it.qty_1 || 1,
                'Unit Price': it.price_1,
                'Total': (parseFloat(it.qty_1) || 1) * (parseFloat(it.price_1) || 0)
            }));

            const total = items.reduce((sum, it) => sum + (parseFloat(it.qty_1) || 1) * (parseFloat(it.price_1) || 0), 0);
            data.push({ 'Drawing No': 'TOTAL', 'Description': '', 'Qty': '', 'Unit Price': '', 'Total': total });

            exportToExcel(data, `LOI_${supplier}_${currentProject.name || 'Project'}`);
            if (window.showToast) showToast(`LOI for ${supplier} generated!`, 'success');
        };

        window.generateLoserNotification = function (supplier) {
            if (!currentProject) return;

            const items = (currentProject.items || []).filter(it => {
                const quotes = it.quotes || [];
                return quotes.some(q => (q.supplier || q.supplier_name) === supplier) && it.supplier !== supplier;
            });

            const data = items.map(it => ({
                'Drawing No': it.drawing_no || it.dn,
                'Description': it.description || '',
                'Your Quote': (it.quotes || []).find(q => (q.supplier || q.supplier_name) === supplier)?.price || '‚Äî',
                'Awarded To': it.supplier || '‚Äî',
                'Awarded Price': it.price_1 || '‚Äî'
            }));

            exportToExcel(data, `Non_Award_${supplier}_${currentProject.name || 'Project'}`);
            if (window.showToast) showToast(`Notification list for ${supplier} generated!`, 'success');
        };

        window.generateAllLoserNotifications = function () {
            if (!currentProject) return;

            const items = currentProject.items || [];
            const awardedSuppliers = new Set();
            const loserData = new Map();

            // Get awarded suppliers
            items.forEach(it => {
                if (it.supplier) awardedSuppliers.add(it.supplier);
            });

            // Find losing suppliers and their lost items
            items.forEach(it => {
                const quotes = it.quotes || [];
                quotes.forEach(q => {
                    const supplierName = q.supplier || q.supplier_name;
                    if (supplierName && supplierName !== it.supplier) {
                        if (!loserData.has(supplierName)) loserData.set(supplierName, []);
                        loserData.get(supplierName).push({
                            drawing_no: it.item_drawing_no || it.drawing_no || it.dn || it.part_no || '',
                            description: it.description,
                            manufacturer: it.manufacturer || '',
                            mpn: it.mpn || it.MPN || '',
                            quote_ref: q.quoteNo || q.reference || q.quote_no || '',
                            project_name: currentProject.name || currentProject.projectName || 'Unknown Project',
                            your_quote: q.price || q.unit_price || '',
                            awarded_to: it.supplier || '‚Äî',
                            awarded_price: it.price_1 || '‚Äî',
                            price_difference: (q.price && it.price_1) ? (parseFloat(q.price) - parseFloat(it.price_1)).toFixed(2) : '‚Äî'
                        });
                    }
                });
            });

            if (loserData.size === 0) {
                if (window.showToast) showToast('No non-awarded suppliers found', 'info');
                return;
            }

            // Generate single Excel with all losers
            const data = [];
            loserData.forEach((lostItems, supplier) => {
                lostItems.forEach((it, idx) => {
                    data.push({
                        'Supplier': idx === 0 ? supplier : '',
                        'Drawing No': it.drawing_no,
                        'Description': it.description || '',
                        'Your Quote': it.your_quote,
                        'Awarded To': it.awarded_to,
                        'Awarded Price': it.awarded_price
                    });
                });
                data.push({}); // Empty row separator
            });

            exportDocToExcel('Non_Award_Notifications', data, 0);
            if (window.showToast) showToast(`Generated notification list for ${loserData.size} suppliers`, 'success');
        };

        // Send notification to single non-awarded supplier
        // Duplicate sendLoserNotification removed - see main definition around line 30630
        /*
        window.sendLoserNotification = function (supplier) {
            if (!currentProject) return;
         
            const items = currentProject.items || [];
            const lostItems = [];
         
            // Find items this supplier quoted on but didn't win
            items.forEach(it => {
                const awardedTo = it.supplier || it.awarded_supplier;
                if (awardedTo === supplier) return; // They won this one
         
                // Check if they quoted
                const quotes = it.quotes || [];
                const supplierQuotes = it.supplier_quotes || {};
                const quoted = quotes.find(q => (q.supplier || q.supplier_name) === supplier) || supplierQuotes[supplier];
         
                if (quoted) {
                    lostItems.push({
                        drawing_no: it.item_drawing_no || it.drawing_no || it.dn || it.part_no || '',
                        description: it.description || '',
                        your_quote: quoted.price || quoted.unit_price || quoted.price_1 || '',
                        awarded_to: awardedTo || '‚Äî',
                        awarded_price: it.price_1 || '‚Äî'
                    });
                }
            });
         
            if (lostItems.length === 0) {
                if (window.showToast) showToast(`No lost items found for ${supplier}`, 'info');
                return;
            }
         
            // Generate notification for this supplier
            const data = lostItems.map(it => ({
                'Drawing No': it.drawing_no,
                'Description': it.description,
                'Your Quote': it.your_quote,
                'Awarded To': it.awarded_to,
                'Awarded Price': it.awarded_price
            }));
         
            exportDocToExcel(`Notification_${supplier.replace(/[^a-zA-Z0-9]/g, '_')}`, data, 0);
            if (window.showToast) showToast(`Notification generated for ${supplier}`, 'success');
        };
        */

        function exportFinalSummary() {
            if (!currentProject) return;

            const items = currentProject.items || [];
            const data = items.map(it => ({
                'Drawing No': it.item_drawing_no || it.drawing_no || it.dn || it.part_no || '',
                'MPN': it.mpn || it.MPN || '',
                'Manufacturer': it.manufacturer || '',
                'Description': it.description || '',
                'Qty 1': it.qty_1 || it.quantity || '',
                'Price 1': it.price_1 || '',
                'Qty 2': it.qty_2 || '',
                'Price 2': it.price_2 || '',
                'Qty 3': it.qty_3 || '',
                'Price 3': it.price_3 || '',
                'Awarded Supplier': it.supplier || it.awarded_supplier || '',
                'Lead Time': it.lead_time || it.lt || '',
                'MOQ': it.moq || '',
                'Currency': it.currency || 'EUR',
                'Incoterms': it.incoterms || 'DAP',
                'Total Value': (parseFloat(it.qty_1 || it.quantity) || 1) * (parseFloat(it.price_1) || 0),
                'Challenge Status': it.challenge_status || '',
                'New Price': it.challenge_new_price || ''
            }));

            exportToExcelFull(data, `Final_Summary_${currentProject.name || 'Project'}`);
            if (window.showToast) showToast('Summary exported!', 'success');
        }

        function exportToExcel(data, filename) {
            if (!window.XLSX) {
                if (window.showToast) showToast('Excel library not loaded', 'error');
                return;
            }

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Data');
            XLSX.writeFile(wb, filename + '.xlsx');
        }

        function bindNewQuotingEvents() {
            if (window.__RFQ_NEW_QUOTING_BOUND__) return;
            window.__RFQ_NEW_QUOTING_BOUND__ = true;

            // Add Quote button
            const btnAdd = document.getElementById('btn-add-quote');
            if (btnAdd) {
                btnAdd.onclick = () => openQuoteWizard();
            }

            // Item search
            const searchInput = document.getElementById('rfq-item-search');
            if (searchInput) {
                searchInput.oninput = () => renderItemComparison();
            }

            // Wizard buttons
            const wizClose = document.getElementById('wizard-close');
            const wizCancel = document.getElementById('wizard-cancel');
            const wizPrev = document.getElementById('wizard-prev');
            const wizNext = document.getElementById('wizard-next');
            const wizSave = document.getElementById('wizard-save');

            if (wizClose) wizClose.onclick = closeQuoteWizard;
            if (wizCancel) wizCancel.onclick = closeQuoteWizard;
            if (wizPrev) wizPrev.onclick = prevWizardStep;
            if (wizNext) wizNext.onclick = nextWizardStep;
            if (wizSave) wizSave.onclick = saveQuote;

            // Select All button
            const selectAll = document.getElementById('wiz-select-all');
            if (selectAll) {
                selectAll.onclick = () => {
                    const checkboxes = document.querySelectorAll('#wiz-items-list input[type="checkbox"]');
                    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                    checkboxes.forEach(cb => {
                        cb.checked = !allChecked;
                        const dn = cb.dataset.dn;
                        if (cb.checked) {
                            quoteWizardState.selectedItems.add(dn);
                        } else {
                            quoteWizardState.selectedItems.delete(dn);
                        }
                    });
                    updateSelectedCount();
                };
            }

            // Items search in wizard
            const wizItemsSearch = document.getElementById('wiz-items-search');
            if (wizItemsSearch) {
                wizItemsSearch.oninput = () => renderWizardItemsList();
            }
        }

        // Track expanded items in Price Comparison
        const priceComparisonExpandedItems = new Set();

        // Track selected items in Price Comparison
        const pcSelectedItems = new Set();

        // Price Comparison filter state
        let pcFilterStatus = 'all'; // all, selected, pending, no-quotes
        let pcFilterSupplier = '';
        let pcFilterOffersMin = 0;
        let pcFilterOffersMax = 999;

        function renderItemComparison() {
            const container = document.getElementById('rfq-items-comparison');
            if (!container || !currentProject) return;

            // Save scroll position
            const scrollContainer = container.querySelector('.pc-scroll-container');
            const savedScrollTop = scrollContainer ? scrollContainer.scrollTop : 0;

            const items = currentProject.items || [];
            const searchQ = (document.getElementById('pc-filter-search')?.value || '').toLowerCase().trim();

            // Get currency rates for EUR conversion
            const rates = window.RFQData && window.RFQData.CURRENCY_RATES ? window.RFQData.CURRENCY_RATES : { EUR: 1, USD: 0.92, CZK: 0.041, GBP: 1.17 };

            // Collect all unique suppliers for filter dropdown
            const allSuppliers = new Set();
            items.forEach(item => {
                (item.suppliers || []).forEach(s => {
                    const n = s.supplier_name || s.supplier || s.name || '';
                    if (n) allSuppliers.add(n);
                });
            });

            const filteredItems = items.map((item, idx) => ({ ...item, _idx: idx })).filter(item => {
                // Search filter
                if (searchQ) {
                    const dn = String(item.item_drawing_no || item.drawing_no || '').toLowerCase();
                    const desc = String(item.description || '').toLowerCase();
                    const mpn = String(item.mpn || '').toLowerCase();
                    if (!dn.includes(searchQ) && !desc.includes(searchQ) && !mpn.includes(searchQ)) return false;
                }

                const itemSuppliers = item.suppliers || [];

                // Status filter
                const hasMain = itemSuppliers.some(s => s.isMain);
                const hasQuotes = itemSuppliers.some(s => {
                    if (s.prices && Array.isArray(s.prices) && s.prices.some(p => parseFloat(p.price) > 0)) return true;
                    if (parseFloat(s.price_1 || s.price) > 0) return true;
                    return false;
                });

                if (pcFilterStatus === 'selected' && !hasMain) return false;
                if (pcFilterStatus === 'pending' && (hasMain || !hasQuotes)) return false;
                if (pcFilterStatus === 'no-quotes' && hasQuotes) return false;
                // Item status filter (if not a special category, filter by actual item.status)
                if (pcFilterStatus && pcFilterStatus !== 'all' && pcFilterStatus !== 'selected' && pcFilterStatus !== 'pending' && pcFilterStatus !== 'no-quotes') {
                    const itemStatus = getItemStatusDisplay(item);
                    if (!statusMatchesFilter(itemStatus, pcFilterStatus)) return false;
                }

                // Supplier filter
                if (pcFilterSupplier) {
                    const hasSupplier = itemSuppliers.some(s => {
                        const n = s.supplier_name || s.supplier || s.name || '';
                        return n.toLowerCase().includes(pcFilterSupplier.toLowerCase());
                    });
                    if (!hasSupplier) return false;
                }

                // Offers count filter
                let offersCount = 0;
                itemSuppliers.forEach(s => {
                    const hasPrice = (s.prices && Array.isArray(s.prices) && s.prices.some(p => parseFloat(p.price) > 0)) || parseFloat(s.price_1 || s.price) > 0;
                    if (hasPrice) offersCount++;
                });
                if (offersCount < pcFilterOffersMin || offersCount > pcFilterOffersMax) return false;

                return true;
            });

            if (filteredItems.length === 0) {
                // Build supplier options so filters remain functional
                const supplierOptions = Array.from(allSuppliers).sort().map(s =>
                    `<option value="${escapeHtml(s)}" ${pcFilterSupplier === s ? 'selected' : ''}>${escapeHtml(s)}</option>`
                ).join('');

                const hasActiveFilters = pcFilterStatus !== 'all' || pcFilterSupplier || searchQ || pcFilterOffersMin > 0 || pcFilterOffersMax < 999;

                container.innerHTML = `
                    <div class="rfq-comparison-controls" style="padding:12px 0; border-bottom:1px solid #e0e0e0; margin-bottom:12px;">
                        <div class="pc-filters" style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
                            <input type="text" id="pc-filter-search" placeholder="Search item..."
                                value="${escapeHtml(searchQ)}"
                                style="padding:6px 12px; border:1px solid #ddd; border-radius:4px; width:180px; font-size:12px;">
                            <select id="pc-filter-status" style="padding:6px 12px; border:1px solid #ddd; border-radius:4px; font-size:12px;">
                                <option value="all" ${pcFilterStatus === 'all' ? 'selected' : ''}>All Status</option>
                                <option value="selected" ${pcFilterStatus === 'selected' ? 'selected' : ''}>Selected (MAIN)</option>
                                <option value="pending" ${pcFilterStatus === 'pending' ? 'selected' : ''}>Needs Selection</option>
                                <option value="no-quotes" ${pcFilterStatus === 'no-quotes' ? 'selected' : ''}>No Quotes</option>
                                <optgroup label="‚îÄ‚îÄ Item Status ‚îÄ‚îÄ">
                                    ${getItemStatuses().map(st => `<option value="${st}" ${pcFilterStatus === st ? 'selected' : ''}>${st}</option>`).join('')}
                                </optgroup>
                            </select>
                            <select id="pc-filter-supplier" style="padding:6px 12px; border:1px solid #ddd; border-radius:4px; font-size:12px; max-width:200px;">
                                <option value="">All Suppliers</option>
                                ${supplierOptions}
                            </select>
                            <div style="display:flex; align-items:center; gap:4px;">
                                <span style="font-size:11px; color:#666;">Offers:</span>
                                <input type="number" id="pc-filter-offers-min" min="0" value="${pcFilterOffersMin}"
                                    style="width:50px; padding:4px 6px; border:1px solid #ddd; border-radius:4px; font-size:12px;" placeholder="Min">
                                <span style="color:#999;">-</span>
                                <input type="number" id="pc-filter-offers-max" min="0" value="${pcFilterOffersMax === 999 ? '' : pcFilterOffersMax}"
                                    style="width:50px; padding:4px 6px; border:1px solid #ddd; border-radius:4px; font-size:12px;" placeholder="Max">
                            </div>
                            <button id="pc-filter-reset" class="rfq-btn-secondary" style="padding:4px 10px; font-size:11px;">Reset Filters</button>
                        </div>
                    </div>
                    <div class="rfq-empty-state">
                        <div class="rfq-empty-icon">üì¶</div>
                        <div class="rfq-empty-title">No Items Found</div>
                        <p>${hasActiveFilters ? 'No items match your current filters. Click "Reset Filters" to show all items.' : 'Add items to your project to view price comparisons.'}</p>
                    </div>
                `;

                // Bind filter controls so user can reset
                const searchInput = container.querySelector('#pc-filter-search');
                const statusSelect = container.querySelector('#pc-filter-status');
                const supplierSelect = container.querySelector('#pc-filter-supplier');
                const offersMinInput = container.querySelector('#pc-filter-offers-min');
                const offersMaxInput = container.querySelector('#pc-filter-offers-max');
                const resetBtn = container.querySelector('#pc-filter-reset');

                let filterTimeout = null;
                const applyFiltersDebounced = () => {
                    clearTimeout(filterTimeout);
                    filterTimeout = setTimeout(() => renderItemComparison(), 300);
                };

                if (searchInput) searchInput.oninput = applyFiltersDebounced;
                if (statusSelect) statusSelect.onchange = () => { pcFilterStatus = statusSelect.value; renderItemComparison(); };
                if (supplierSelect) supplierSelect.onchange = () => { pcFilterSupplier = supplierSelect.value; renderItemComparison(); };
                if (offersMinInput) offersMinInput.onchange = () => { pcFilterOffersMin = parseInt(offersMinInput.value) || 0; renderItemComparison(); };
                if (offersMaxInput) offersMaxInput.onchange = () => { pcFilterOffersMax = parseInt(offersMaxInput.value) || 999; renderItemComparison(); };
                if (resetBtn) resetBtn.onclick = () => { pcFilterStatus = 'all'; pcFilterSupplier = ''; pcFilterOffersMin = 0; pcFilterOffersMax = 999; if (searchInput) searchInput.value = ''; renderItemComparison(); };

                return;
            }

            // Statistics
            let totalItems = filteredItems.length;
            let itemsWithMain = 0;
            let itemsWithQuotes = 0;
            let totalSuppliers = new Set();

            filteredItems.forEach(item => {
                const sups = item.suppliers || [];
                sups.forEach(s => {
                    const n = s.supplier_name || s.supplier || s.name || '';
                    if (n) totalSuppliers.add(n);
                });
                if (sups.some(s => s.isMain)) itemsWithMain++;
                if (sups.some(s => {
                    const prices = s.prices || [];
                    return prices.some(p => parseFloat(p.price) > 0) || parseFloat(s.price_1 || s.price) > 0;
                })) itemsWithQuotes++;
            });

            // Build rows
            let rowsHtml = '';
            filteredItems.forEach(item => {
                const itemIdx = item._idx;
                const dn = item.item_drawing_no || item.drawing_no || `#${itemIdx + 1}`;
                const desc = item.description || '';
                const unit = item.unit || 'pcs';
                const qtyTiers = getItemQtyTiers(item, { includeBlanks: false });
                const itemSuppliers = item.suppliers || [];
                const isExpanded = priceComparisonExpandedItems.has(itemIdx);

                // Find main supplier and winner info
                const mainSup = itemSuppliers.find(s => s.isMain);
                const mainSupName = mainSup ? (mainSup.supplier_name || mainSup.supplier || mainSup.name || '') : '';

                // Count offers and find best price (in EUR)
                let offersCount = 0;
                let bestEurPrice = Infinity;
                let bestSupplier = null;

                itemSuppliers.forEach(s => {
                    const currency = s.currency || 'EUR';
                    const rate = rates[currency] || 1;
                    let hasPrice = false;

                    // Check prices array
                    if (s.prices && Array.isArray(s.prices)) {
                        s.prices.forEach(p => {
                            const price = parseFloat(p.price) || 0;
                            if (price > 0) {
                                hasPrice = true;
                                const eurPrice = price * rate;
                                if (eurPrice < bestEurPrice) {
                                    bestEurPrice = eurPrice;
                                    bestSupplier = s;
                                }
                            }
                        });
                    }

                    // Check legacy price_1
                    const legacyPrice = parseFloat(s.price_1 || s.price) || 0;
                    if (legacyPrice > 0) {
                        hasPrice = true;
                        const eurPrice = legacyPrice * rate;
                        if (eurPrice < bestEurPrice) {
                            bestEurPrice = eurPrice;
                            bestSupplier = s;
                        }
                    }

                    if (hasPrice) offersCount++;
                });

                // Status based on main selection
                let statusHtml = '';
                if (mainSup) {
                    statusHtml = `<span style="background:#4caf50; color:white; padding:3px 10px; border-radius:4px; font-size:11px;">‚úì Selected</span>`;
                } else if (offersCount > 0) {
                    statusHtml = `<span style="background:#ff9800; color:white; padding:3px 10px; border-radius:4px; font-size:11px;">‚è≥ Pending</span>`;
                } else {
                    statusHtml = `<span style="background:#9e9e9e; color:white; padding:3px 10px; border-radius:4px; font-size:11px;">No quotes</span>`;
                }

                // Winner info + MOQ + Lead Time
                let winnerHtml = '-';
                let winnerMoq = '-';
                let winnerLeadTime = '-';
                if (mainSup) {
                    const winnerName = mainSupName;
                    const winnerCurrency = mainSup.currency || 'EUR';
                    const winnerRate = rates[winnerCurrency] || 1;
                    let winnerPrice = 0;
                    if (mainSup.prices && mainSup.prices[0]) winnerPrice = parseFloat(mainSup.prices[0].price) || 0;
                    if (!winnerPrice) winnerPrice = parseFloat(mainSup.price_1 || mainSup.price) || 0;
                    const winnerEur = winnerPrice * winnerRate;

                    winnerHtml = `
                        <div style="font-weight:600; color:#2e7d32;">${formatNumber(winnerEur, 2)} EUR</div>
                        <div style="font-size:11px; color:#666;">${escapeHtml(winnerName)}</div>
                    `;
                    winnerMoq = mainSup.moq || mainSup.MOQ || '-';
                    winnerLeadTime = mainSup.lead_time || mainSup.leadTime || '-';
                } else if (bestSupplier) {
                    const bestName = bestSupplier.supplier_name || bestSupplier.supplier || bestSupplier.name || '';
                    winnerHtml = `
                        <div style="font-weight:500; color:#666;">${formatNumber(bestEurPrice, 2)} EUR</div>
                        <div style="font-size:10px; color:#999;">Best: ${escapeHtml(bestName)}</div>
                    `;
                    winnerMoq = bestSupplier.moq || bestSupplier.MOQ || '-';
                    winnerLeadTime = bestSupplier.lead_time || bestSupplier.leadTime || '-';
                }

                // Number of suppliers assigned to this item
                const suppliersCount = itemSuppliers.length;

                // Item Status badge (actual workflow status)
                const itemStatus = item.status || 'New';
                const itemStatusColor = getStatusColorUnified(itemStatus);
                const itemStatusHtml = `<span style="background:${itemStatusColor}; color:white; padding:2px 8px; border-radius:4px; font-size:10px; font-weight:500;">${escapeHtml(itemStatus)}</span>`;

                // Target price info - always display in EUR
                const targetPrice = parseFloat(item.target_price) || 0;
                const targetCurrency = item.target_currency || 'EUR';
                const targetRate = rates[targetCurrency] || 1;
                const targetEur = targetPrice * targetRate;

                // Get main supplier price for comparison
                let mainSupPrice = 0;
                if (mainSup) {
                    const mainCurrency = mainSup.currency || 'EUR';
                    const mainRate = rates[mainCurrency] || 1;
                    if (mainSup.prices && mainSup.prices[0]) {
                        mainSupPrice = (parseFloat(mainSup.prices[0].price) || 0) * mainRate;
                    }
                    if (!mainSupPrice) {
                        mainSupPrice = (parseFloat(mainSup.price_1 || mainSup.price) || 0) * mainRate;
                    }
                }

                // Calculate price difference and row styling
                let priceDiff = 0;
                let priceDiffHtml = '';
                let rowBgColor = 'transparent';
                let rowBorderColor = 'transparent';

                if (targetEur > 0 && mainSupPrice > 0) {
                    priceDiff = mainSupPrice - targetEur;
                    const priceDiffPercent = ((priceDiff / targetEur) * 100).toFixed(1);
                    if (priceDiff > 0) {
                        // Main supplier is MORE expensive than target (BAD - red)
                        rowBgColor = 'rgba(255, 59, 48, 0.15)';
                        rowBorderColor = '#FF3B30';
                        priceDiffHtml = `<span style="color:#FF3B30; font-size:10px; font-weight:600;">+${formatNumber(priceDiff, 2)} ‚Ç¨ (+${priceDiffPercent}%)</span>`;
                    } else if (priceDiff < 0) {
                        // Main supplier is LESS expensive than target (GOOD - green)
                        rowBgColor = 'rgba(52, 199, 89, 0.15)';
                        rowBorderColor = '#34C759';
                        priceDiffHtml = `<span style="color:#34C759; font-size:10px; font-weight:600;">${formatNumber(priceDiff, 2)} ‚Ç¨ (${priceDiffPercent}%)</span>`;
                    } else {
                        priceDiffHtml = `<span style="color:#666; font-size:10px;">= 0</span>`;
                    }
                }

                let targetHtml = '-';
                if (targetPrice > 0) {
                    targetHtml = `
                        <div style="font-size:11px; font-weight:500; color:#667eea;">${formatNumber(targetEur, 2)} ‚Ç¨</div>
                        ${priceDiffHtml ? `<div style="margin-top:2px;">${priceDiffHtml}</div>` : ''}
                    `;
                }

                // Checkbox state
                const isChecked = pcSelectedItems.has(itemIdx);

                // Main row with price-based coloring
                rowsHtml += `
                    <tr class="pc-item-row ${isExpanded ? 'expanded' : ''}" data-item-idx="${itemIdx}"
                        style="cursor:pointer; border-bottom:1px solid #e8e8e8; background:${rowBgColor}; border-left:4px solid ${rowBorderColor};">
                        <td style="padding:12px; width:30px;" onclick="event.stopPropagation();">
                            <input type="checkbox" class="pc-item-checkbox" data-item-idx="${itemIdx}" ${isChecked ? 'checked' : ''}
                                style="width:16px; height:16px; cursor:pointer;">
                        </td>
                        <td style="padding:12px; width:30px;">
                            <span class="pc-expand-icon" style="font-size:12px; color:#666;">${isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                        </td>
                        <td style="padding:12px;">
                            <div style="font-weight:600; color:#007AFF;">${escapeHtml(dn)}</div>
                            <div style="font-size:11px; color:#666;" title="${escapeHtml(desc)}">${escapeHtml(desc.length > 50 ? desc.substring(0, 50) + '...' : desc)}</div>
                            <div style="font-size:10px; color:#888; margin-top:4px;">
                                ${qtyTiers.map(t => `<span style="background:#f0f0f0; padding:1px 6px; border-radius:3px; margin-right:4px;">${t.value} ${unit}</span>`).join('')}
                            </div>
                        </td>
                        <td style="padding:12px; text-align:center;">${itemStatusHtml}</td>
                        <td style="padding:12px; text-align:center;">${statusHtml}</td>
                        <td style="padding:12px; text-align:center;">
                            <span style="font-size:14px; font-weight:600;">${suppliersCount}</span>
                        </td>
                        <td style="padding:12px; text-align:center;">
                            <span style="font-size:14px; font-weight:600; color:${offersCount > 0 ? '#4caf50' : '#999'};">${offersCount}</span>
                        </td>
                        <td style="padding:12px; text-align:center;">${targetHtml}</td>
                        <td style="padding:12px;">${winnerHtml}</td>
                        <td style="padding:12px; text-align:center; font-size:12px;">${escapeHtml(String(winnerMoq))}</td>
                        <td style="padding:12px; text-align:center; font-size:12px;">${escapeHtml(String(winnerLeadTime))}</td>
                        <td style="padding:8px; text-align:center; width:40px;">
                            <button class="pc-detail-btn" data-item-idx="${itemIdx}" title="Open Item Detail"
                                style="background:none; border:1px solid #ddd; border-radius:4px; padding:4px 8px; cursor:pointer; font-size:14px;">
                                üîç
                            </button>
                        </td>
                    </tr>
                `;

                // Expanded detail row
                if (isExpanded) {
                    rowsHtml += `<tr class="pc-detail-row" data-item-idx="${itemIdx}"><td colspan="12" style="padding:0; background:#f9f9f9;">`;
                    rowsHtml += renderSupplierComparisonDetail(item, itemIdx, qtyTiers, rates);
                    rowsHtml += `</td></tr>`;
                }
            });

            // Build supplier options for filter
            const supplierOptions = Array.from(allSuppliers).sort().map(s =>
                `<option value="${escapeHtml(s)}" ${pcFilterSupplier === s ? 'selected' : ''}>${escapeHtml(s)}</option>`
            ).join('');

            // Build final HTML
            container.innerHTML = `
                <div class="rfq-comparison-controls" style="padding:12px 0; border-bottom:1px solid #e0e0e0; margin-bottom:12px;">
                    <!-- Stats Row -->
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <div class="rfq-comparison-stats" style="display:flex; gap:16px; font-size:13px;">
                            <span><strong>${totalItems}</strong> items</span>
                            <span><strong>${itemsWithQuotes}</strong> quoted</span>
                            <span style="color:#4caf50;"><strong>${itemsWithMain}</strong> selected</span>
                            <span><strong>${totalSuppliers.size}</strong> suppliers</span>
                        </div>
                    </div>
                    <!-- Filters + Actions Row -->
                    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; background:#f8f9fa; padding:10px; border-radius:8px;">
                        <input type="text" id="pc-filter-search" placeholder="üîç Search..."
                            value="${escapeHtml(searchQ)}"
                            style="padding:6px 10px; border:1px solid #ddd; border-radius:4px; width:140px; font-size:12px;">
                        <select id="pc-filter-status" style="padding:6px 8px; border:1px solid #ddd; border-radius:4px; font-size:12px; max-width:140px;">
                            <option value="all" ${pcFilterStatus === 'all' ? 'selected' : ''}>All Status</option>
                            <option value="selected" ${pcFilterStatus === 'selected' ? 'selected' : ''}>‚úì Selected</option>
                            <option value="pending" ${pcFilterStatus === 'pending' ? 'selected' : ''}>‚è≥ Needs Sel.</option>
                            <option value="no-quotes" ${pcFilterStatus === 'no-quotes' ? 'selected' : ''}>‚ùå No Quotes</option>
                            <optgroup label="‚îÄ‚îÄ Item Status ‚îÄ‚îÄ">
                                ${getItemStatuses().map(st => `<option value="${st}" ${pcFilterStatus === st ? 'selected' : ''}>${st}</option>`).join('')}
                            </optgroup>
                        </select>
                        <select id="pc-filter-supplier" style="padding:6px 8px; border:1px solid #ddd; border-radius:4px; font-size:12px; max-width:140px;">
                            <option value="">All Suppliers</option>
                            ${supplierOptions}
                        </select>
                        <div style="display:flex; align-items:center; gap:3px;">
                            <span style="font-size:10px; color:#666;">Offers:</span>
                            <input type="number" id="pc-filter-offers-min" min="0" value="${pcFilterOffersMin}"
                                style="width:40px; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:11px;" placeholder="Min">
                            <span style="color:#999; font-size:10px;">-</span>
                            <input type="number" id="pc-filter-offers-max" min="0" value="${pcFilterOffersMax === 999 ? '' : pcFilterOffersMax}"
                                style="width:40px; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:11px;" placeholder="Max">
                        </div>
                        <button id="pc-filter-reset" class="rfq-btn-secondary" style="padding:4px 8px; font-size:10px;">Reset</button>
                        <div style="width:1px; height:24px; background:#ddd; margin:0 4px;"></div>
                        <button id="pc-expand-with-prices" class="rfq-btn-secondary" style="padding:4px 8px; font-size:11px;" title="Expand items with prices">üìä With Prices</button>
                        <button id="pc-expand-all" class="rfq-btn-secondary" style="padding:4px 8px; font-size:11px;">‚¨áÔ∏è Expand</button>
                        <button id="pc-collapse-all" class="rfq-btn-secondary" style="padding:4px 8px; font-size:11px;">‚¨ÜÔ∏è Collapse</button>
                        <div style="width:1px; height:24px; background:#ddd; margin:0 4px;"></div>
                        <button id="pc-export-excel" class="btn-success" style="padding:4px 10px; font-size:11px;">üì§ Export</button>
                    </div>
                </div>
                <!-- Bulk Action Bar for Price Comparison -->
                <div id="pc-bulk-action-bar" class="${pcSelectedItems.size > 0 ? '' : 'hidden'}"
                    style="position: sticky; top: 0; z-index: 10; background: #333; color: white; padding: 12px 24px; border-radius: 8px; display: flex; align-items: center; gap: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); margin-bottom: 12px;">
                    <div style="font-weight: 600; font-size: 13px;"><span id="pc-bulk-count">${pcSelectedItems.size}</span> Selected</div>
                    <div style="height: 20px; width: 1px; background: rgba(255,255,255,0.2);"></div>
                    <select id="pc-bulk-status-select" style="background: rgba(255,255,255,0.1); border: none; color: white; width: 150px; padding: 6px 10px; border-radius: 4px;">
                        <option value="">Change Status</option>
                        ${getItemStatuses().map(st => `<option value="${escapeHtml(st)}">${escapeHtml(st)}</option>`).join('')}
                    </select>
                    <button id="pc-bulk-link-supplier" style="background: #4CAF50; border: none; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                        üîó Link Supplier
                    </button>
                    <button id="pc-bulk-set-main" style="background: #2196F3; border: none; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                        ‚≠ê Set as Main
                    </button>
                    <button id="pc-bulk-unselect" style="background: #9E9E9E; border: none; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                        ‚úñÔ∏è Unselect Supplier
                    </button>
                    <button id="pc-bulk-export" style="background: #FF9800; border: none; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                        üì§ Export
                    </button>
                    <div style="margin-left: auto; display: flex; gap: 8px;">
                        <button id="pc-bulk-cancel" style="background: #666; border: none; color: white; padding: 6px 16px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 500;">
                            Cancel
                        </button>
                        <button id="pc-bulk-done" style="background: #10b981; border: none; color: white; padding: 6px 16px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 500;">
                            ‚úì Done
                        </button>
                    </div>
                </div>
                <div class="pc-scroll-container" style="overflow-y:auto; max-height:calc(100vh - 340px);">
                    <table class="pc-comparison-table resizable-table" id="pc-comparison-table" style="width:100%; border-collapse:collapse;">
                        <thead style="position:sticky; top:0; z-index:2; background:#f8f9fa;">
                            <tr style="border-bottom:2px solid #e0e0e0;">
                                <th style="width:30px; padding:12px;">
                                    <input type="checkbox" id="pc-select-all" title="Select All"
                                        style="width:16px; height:16px; cursor:pointer;">
                                </th>
                                <th style="width:30px;"></th>
                                <th style="text-align:left; padding:12px; font-weight:600;">Item</th>
                                <th style="text-align:center; padding:12px; font-weight:600; width:80px;">Item Status</th>
                                <th style="text-align:center; padding:12px; font-weight:600; width:90px;">Selection</th>
                                <th style="text-align:center; padding:12px; font-weight:600; width:60px;">Suppl.</th>
                                <th style="text-align:center; padding:12px; font-weight:600; width:60px;">Offers</th>
                                <th style="text-align:center; padding:12px; font-weight:600; width:100px;">Target / Diff</th>
                                <th style="text-align:left; padding:12px; font-weight:600; width:140px;">Winner</th>
                                <th style="text-align:center; padding:12px; font-weight:600; width:60px;">MOQ</th>
                                <th style="text-align:center; padding:12px; font-weight:600; width:60px;">Lead</th>
                                <th style="width:40px;"></th>
                            </tr>
                        </thead>
                        <tbody>${rowsHtml}</tbody>
                    </table>
                </div>
            `;

            // Bind row click to expand/collapse
            container.querySelectorAll('.pc-item-row').forEach(row => {
                row.onclick = (e) => {
                    if (e.target.closest('button') || e.target.closest('input')) return; // Don't toggle on button/checkbox click
                    const idx = parseInt(row.dataset.itemIdx, 10);
                    if (priceComparisonExpandedItems.has(idx)) {
                        priceComparisonExpandedItems.delete(idx);
                    } else {
                        priceComparisonExpandedItems.add(idx);
                    }
                    renderItemComparison();
                };
            });

            // Bind expand/collapse all buttons
            const expandAllBtn = container.querySelector('#pc-expand-all');
            const collapseAllBtn = container.querySelector('#pc-collapse-all');
            const expandWithPricesBtn = container.querySelector('#pc-expand-with-prices');
            if (expandAllBtn) {
                expandAllBtn.onclick = () => {
                    filteredItems.forEach(item => priceComparisonExpandedItems.add(item._idx));
                    renderItemComparison();
                };
            }
            if (collapseAllBtn) {
                collapseAllBtn.onclick = () => {
                    priceComparisonExpandedItems.clear();
                    renderItemComparison();
                };
            }
            if (expandWithPricesBtn) {
                expandWithPricesBtn.onclick = () => {
                    // Only expand items that have at least one price
                    filteredItems.forEach(item => {
                        const itemSuppliers = item.suppliers || [];
                        const hasPrice = itemSuppliers.some(s => {
                            if (s.prices && Array.isArray(s.prices)) {
                                if (s.prices.some(p => parseFloat(p.price) > 0)) return true;
                            }
                            if (parseFloat(s.price_1 || s.price) > 0) return true;
                            return false;
                        });
                        if (hasPrice) {
                            priceComparisonExpandedItems.add(item._idx);
                        }
                    });
                    renderItemComparison();
                };
            }

            // Bind Export Excel button
            const exportBtn = container.querySelector('#pc-export-excel');
            if (exportBtn) {
                exportBtn.onclick = () => openPriceComparisonExportDialog(filteredItems, rates);
            }

            // Bind Set Main/2nd/3rd buttons in detail rows
            container.querySelectorAll('.pc-rank-btn').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const itemIdx = parseInt(btn.dataset.itemIdx, 10);
                    const supplierName = btn.dataset.supplier;
                    const rank = parseInt(btn.dataset.rank, 10);
                    setSupplierRankForItem(itemIdx, supplierName, rank);
                };
            });

            // Bind Unselect buttons
            container.querySelectorAll('.pc-unselect-btn').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const itemIdx = parseInt(btn.dataset.itemIdx, 10);
                    const supplierName = btn.dataset.supplier;
                    unselectSupplierForItem(itemIdx, supplierName);
                };
            });

            // Bind magnifying glass buttons to open item detail
            container.querySelectorAll('.pc-detail-btn').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const itemIdx = parseInt(btn.dataset.itemIdx, 10);
                    if (!isNaN(itemIdx)) {
                        openItemDetail(itemIdx);
                    }
                };
            });

            // Bind filter controls
            const searchInput = container.querySelector('#pc-filter-search');
            const statusSelect = container.querySelector('#pc-filter-status');
            const supplierSelect = container.querySelector('#pc-filter-supplier');
            const offersMinInput = container.querySelector('#pc-filter-offers-min');
            const offersMaxInput = container.querySelector('#pc-filter-offers-max');
            const resetBtn = container.querySelector('#pc-filter-reset');

            let filterTimeout = null;
            const applyFiltersDebounced = () => {
                clearTimeout(filterTimeout);
                filterTimeout = setTimeout(() => renderItemComparison(), 300);
            };

            if (searchInput) {
                searchInput.oninput = applyFiltersDebounced;
            }
            if (statusSelect) {
                statusSelect.onchange = () => {
                    pcFilterStatus = statusSelect.value;
                    renderItemComparison();
                };
            }
            if (supplierSelect) {
                supplierSelect.onchange = () => {
                    pcFilterSupplier = supplierSelect.value;
                    renderItemComparison();
                };
            }
            if (offersMinInput) {
                offersMinInput.onchange = () => {
                    pcFilterOffersMin = parseInt(offersMinInput.value) || 0;
                    renderItemComparison();
                };
            }
            if (offersMaxInput) {
                offersMaxInput.onchange = () => {
                    pcFilterOffersMax = parseInt(offersMaxInput.value) || 999;
                    renderItemComparison();
                };
            }
            if (resetBtn) {
                resetBtn.onclick = () => {
                    pcFilterStatus = 'all';
                    pcFilterSupplier = '';
                    pcFilterOffersMin = 0;
                    pcFilterOffersMax = 999;
                    if (searchInput) searchInput.value = '';
                    renderItemComparison();
                };
            }

            // Bind checkbox selection handlers
            const selectAllCheckbox = container.querySelector('#pc-select-all');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = filteredItems.length > 0 && filteredItems.every(item => pcSelectedItems.has(item._idx));
                selectAllCheckbox.indeterminate = pcSelectedItems.size > 0 && pcSelectedItems.size < filteredItems.length;
                selectAllCheckbox.onchange = () => {
                    if (selectAllCheckbox.checked) {
                        filteredItems.forEach(item => pcSelectedItems.add(item._idx));
                    } else {
                        pcSelectedItems.clear();
                    }
                    renderItemComparison();
                };
            }

            container.querySelectorAll('.pc-item-checkbox').forEach(cb => {
                cb.onchange = (e) => {
                    const idx = parseInt(cb.dataset.itemIdx, 10);
                    if (cb.checked) {
                        pcSelectedItems.add(idx);
                    } else {
                        pcSelectedItems.delete(idx);
                    }
                    // Update bulk bar visibility and count
                    const bulkBar = container.querySelector('#pc-bulk-action-bar');
                    const bulkCount = container.querySelector('#pc-bulk-count');
                    if (pcSelectedItems.size > 0) {
                        if (bulkBar) bulkBar.classList.remove('hidden');
                        if (bulkCount) bulkCount.textContent = pcSelectedItems.size;
                    } else {
                        if (bulkBar) bulkBar.classList.add('hidden');
                    }
                    // Update select all checkbox state
                    if (selectAllCheckbox) {
                        selectAllCheckbox.checked = filteredItems.length > 0 && filteredItems.every(item => pcSelectedItems.has(item._idx));
                        selectAllCheckbox.indeterminate = pcSelectedItems.size > 0 && !selectAllCheckbox.checked;
                    }
                };
            });

            // Bind bulk action buttons
            const bulkStatusSelect = container.querySelector('#pc-bulk-status-select');
            if (bulkStatusSelect) {
                bulkStatusSelect.onchange = () => {
                    const newStatus = bulkStatusSelect.value;
                    if (!newStatus || pcSelectedItems.size === 0) return;
                    const count = pcSelectedItems.size;
                    pcSelectedItems.forEach(idx => {
                        const item = currentProject.items[idx];
                        if (item) {
                            setItemStatus(item, newStatus);
                        }
                    });
                    // Save project
                    if (currentProject) {
                        if (window.RFQData && typeof window.RFQData.updateProject === 'function') {
                            window.RFQData.updateProject(currentProject);
                        } else if (typeof updateProject === 'function') {
                            updateProject(currentProject);
                        }
                    }
                    bulkStatusSelect.value = '';
                    // Keep selection but re-render to show updated status
                    renderItemComparison();
                    // Show feedback
                    showToast(`‚úÖ Updated ${count} items to "${newStatus}"`);
                };
            }

            // Unselect Supplier bulk action
            const bulkUnselectBtn = container.querySelector('#pc-bulk-unselect');
            if (bulkUnselectBtn) {
                bulkUnselectBtn.onclick = () => {
                    if (pcSelectedItems.size === 0) return;
                    const count = pcSelectedItems.size;
                    pcSelectedItems.forEach(idx => {
                        const item = currentProject.items[idx];
                        if (item && Array.isArray(item.suppliers)) {
                            // Unset isMain for all suppliers
                            item.suppliers.forEach(s => {
                                s.isMain = false;
                            });
                            // Clear top-level supplier reference
                            item.supplier = '';
                        }
                    });
                    // Save project
                    if (currentProject) {
                        if (window.RFQData && typeof window.RFQData.updateProject === 'function') {
                            window.RFQData.updateProject(currentProject);
                        } else if (typeof updateProject === 'function') {
                            updateProject(currentProject);
                        }
                    }
                    renderItemComparison();
                    showToast(`‚úÖ Unselected main supplier for ${count} items`);
                };
            }

            const bulkLinkSupplierBtn = container.querySelector('#pc-bulk-link-supplier');
            if (bulkLinkSupplierBtn) {
                bulkLinkSupplierBtn.onclick = () => {
                    if (pcSelectedItems.size === 0) return;
                    openBulkLinkSupplierDialog(Array.from(pcSelectedItems));
                };
            }

            const bulkSetMainBtn = container.querySelector('#pc-bulk-set-main');
            if (bulkSetMainBtn) {
                bulkSetMainBtn.onclick = () => {
                    if (pcSelectedItems.size === 0) return;
                    openBulkSetMainSupplierDialog(Array.from(pcSelectedItems));
                };
            }

            const bulkExportBtn = container.querySelector('#pc-bulk-export');
            if (bulkExportBtn) {
                bulkExportBtn.onclick = () => {
                    if (pcSelectedItems.size === 0) return;
                    const selectedItemsData = Array.from(pcSelectedItems).map(idx => currentProject.items[idx]).filter(Boolean);
                    openPriceComparisonExportDialog(selectedItemsData.map((item, i) => ({ ...item, _idx: Array.from(pcSelectedItems)[i] })), rates);
                };
            }

            // Cancel button - just clears selection without saving
            const bulkCancelBtn = container.querySelector('#pc-bulk-cancel');
            if (bulkCancelBtn) {
                bulkCancelBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    pcSelectedItems.clear();
                    renderItemComparison();
                });
            }

            // Done button - saves and clears selection
            const bulkDoneBtn = container.querySelector('#pc-bulk-done');
            if (bulkDoneBtn) {
                bulkDoneBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    // Save project using correct function
                    if (currentProject) {
                        if (window.RFQData && typeof window.RFQData.updateProject === 'function') {
                            window.RFQData.updateProject(currentProject);
                        } else if (typeof updateProject === 'function') {
                            updateProject(currentProject);
                        }
                    }
                    showToast('‚úÖ Changes saved');
                    pcSelectedItems.clear();
                    renderItemComparison();
                });
            }

            // Initialize resizable columns with localStorage persistence
            initResizableColumnsWithStorage(document.getElementById('pc-comparison-table'), 'pc-comparison');

            // Initialize resizable columns for each expanded detail table
            priceComparisonExpandedItems.forEach(idx => {
                const detailTable = document.getElementById(`pc-detail-table-${idx}`);
                if (detailTable) initResizableColumnsWithStorage(detailTable, `pc-detail-${idx}`);
            });

            // Restore scroll position
            const newScrollContainer = container.querySelector('.pc-scroll-container');
            if (newScrollContainer && savedScrollTop > 0) {
                newScrollContainer.scrollTop = savedScrollTop;
            }

            // Store reference for item detail opening
            window.__rfqOpenItemDetail = (idx) => {
                if (typeof idx === 'number' && idx >= 0) {
                    openItemDetail(idx);
                }
            };
        }

        // Resizable columns with localStorage persistence
        function initResizableColumnsWithStorage(table, storageKey) {
            if (!table) return;

            // Restore saved column widths
            const savedWidths = localStorage.getItem(`rfq-col-widths-${storageKey}`);
            if (savedWidths) {
                try {
                    const widths = JSON.parse(savedWidths);
                    const headers = table.querySelectorAll('thead th');
                    headers.forEach((th, i) => {
                        if (widths[i]) {
                            th.style.width = widths[i];
                            th.style.minWidth = widths[i];
                        }
                    });
                } catch (e) { /* ignore */ }
            }

            const headers = table.querySelectorAll('thead th');
            headers.forEach((th, colIdx) => {
                // Remove existing handle if any
                const existing = th.querySelector('.col-resize-handle');
                if (existing) existing.remove();

                const handle = document.createElement('div');
                handle.className = 'col-resize-handle';
                handle.style.cssText = 'position:absolute; right:0; top:0; bottom:0; width:5px; cursor:col-resize; background:transparent;';
                th.style.position = 'relative';
                th.appendChild(handle);

                let startX, startWidth;

                handle.onmousedown = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    startX = e.pageX;
                    startWidth = th.offsetWidth;
                    table.classList.add('resizing');
                    handle.classList.add('resizing');

                    const onMouseMove = (e) => {
                        const diff = e.pageX - startX;
                        const newWidth = Math.max(30, startWidth + diff);
                        th.style.width = newWidth + 'px';
                        th.style.minWidth = newWidth + 'px';
                    };

                    const onMouseUp = () => {
                        table.classList.remove('resizing');
                        handle.classList.remove('resizing');
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);

                        // Save column widths to localStorage
                        const allHeaders = table.querySelectorAll('thead th');
                        const widths = {};
                        allHeaders.forEach((h, i) => {
                            widths[i] = h.style.width || '';
                        });
                        localStorage.setItem(`rfq-col-widths-${storageKey}`, JSON.stringify(widths));
                    };

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                };
            });
        }

        // Render supplier comparison detail for an item
        function renderSupplierComparisonDetail(item, itemIdx, qtyTiers, rates) {
            const suppliers = item.suppliers || [];
            if (suppliers.length === 0) {
                return `<div style="padding:20px; text-align:center; color:#666;">No suppliers assigned to this item</div>`;
            }

            // Get target price for comparison
            const targetPrice = parseFloat(item.target_price) || 0;
            const targetCurrency = item.target_currency || 'EUR';
            const targetRate = rates[targetCurrency] || 1;
            const targetEur = targetPrice * targetRate;

            // Find main supplier and calculate price difference
            const mainSup = suppliers.find(s => s.isMain);
            let mainSupPriceEur = 0;
            let priceDiffHtml = '';
            if (mainSup) {
                const mainCurrency = mainSup.currency || 'EUR';
                const mainRate = rates[mainCurrency] || 1;
                if (mainSup.prices && mainSup.prices[0]) {
                    mainSupPriceEur = (parseFloat(mainSup.prices[0].price) || 0) * mainRate;
                }
                if (!mainSupPriceEur) {
                    mainSupPriceEur = (parseFloat(mainSup.price_1 || mainSup.price) || 0) * mainRate;
                }

                if (targetEur > 0 && mainSupPriceEur > 0) {
                    const priceDiff = mainSupPriceEur - targetEur;
                    const priceDiffPercent = ((priceDiff / targetEur) * 100).toFixed(1);
                    if (priceDiff > 0) {
                        // Main supplier is MORE expensive (red)
                        priceDiffHtml = `<span style="background:rgba(255,59,48,0.3); padding:4px 10px; border-radius:4px; margin-left:12px; font-weight:600;">
                            ‚ö†Ô∏è Main: +${formatNumber(priceDiff, 2)} EUR (+${priceDiffPercent}%)
                        </span>`;
                    } else if (priceDiff < 0) {
                        // Main supplier is LESS expensive (green)
                        priceDiffHtml = `<span style="background:rgba(52,199,89,0.3); padding:4px 10px; border-radius:4px; margin-left:12px; font-weight:600;">
                            ‚úì Main: ${formatNumber(priceDiff, 2)} EUR (${priceDiffPercent}%)
                        </span>`;
                    } else {
                        priceDiffHtml = `<span style="opacity:0.8; margin-left:12px;">= Target</span>`;
                    }
                }
            }

            // Build header for QTY tiers
            let tierHeaders = qtyTiers.map((t, i) => `
                <th style="text-align:right; padding:8px; font-size:11px; min-width:90px;">
                    QTY ${i + 1}<br><span style="font-weight:400; color:#666;">${t.value} ${item.unit || 'pcs'}</span>
                </th>
                <th style="text-align:right; padding:8px; font-size:11px; min-width:80px; color:#007AFF;">EUR</th>
            `).join('');

            // Target price info banner - always show in EUR with price difference
            let targetBanner = '';
            if (targetPrice > 0) {
                targetBanner = `
                    <div style="margin-bottom:12px; padding:10px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:8px; color:white; display:flex; align-items:center; flex-wrap:wrap; gap:8px;">
                        <span>
                            <span style="font-weight:600;">Target Price:</span> ${formatNumber(targetEur, 2)} EUR
                            ${targetCurrency !== 'EUR' ? ` <span style="opacity:0.8; font-size:11px;">(${formatNumber(targetPrice, 2)} ${targetCurrency})</span>` : ''}
                        </span>
                        ${priceDiffHtml}
                    </div>
                `;
            }

            let html = `
                <div style="padding:16px;">
                    ${targetBanner}
                    <table class="pc-detail-table resizable-table" id="pc-detail-table-${itemIdx}" style="width:100%; border-collapse:collapse; font-size:12px;">
                        <thead>
                            <tr style="background:#f0f0f0;">
                                <th style="text-align:left; padding:8px; min-width:150px;">Supplier</th>
                                <th style="text-align:center; padding:8px; width:80px;">Quote #</th>
                                <th style="text-align:center; padding:8px; width:60px;">Curr</th>
                                ${tierHeaders}
                                <th style="text-align:center; padding:8px; width:70px;">MOQ</th>
                                <th style="text-align:center; padding:8px; width:70px;">Lead</th>
                                <th style="text-align:left; padding:8px; min-width:120px;">Comment</th>
                                <th style="text-align:center; padding:8px; width:170px;">Action</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Find best EUR price for each tier
            const bestEurPrices = {};
            qtyTiers.forEach((t, i) => {
                let best = Infinity;
                suppliers.forEach(s => {
                    const currency = s.currency || 'EUR';
                    const rate = rates[currency] || 1;
                    let price = 0;
                    if (s.prices && s.prices[i]) price = parseFloat(s.prices[i].price) || 0;
                    if (!price) price = parseFloat(s['price_' + (i + 1)]) || 0;
                    if (price > 0) {
                        const eurPrice = price * rate;
                        if (eurPrice < best) best = eurPrice;
                    }
                });
                bestEurPrices[i] = best < Infinity ? best : 0;
            });

            suppliers.forEach(s => {
                const supName = s.supplier_name || s.supplier || s.name || 'Unknown';
                const currency = s.currency || 'EUR';
                const rate = rates[currency] || 1;
                const moq = s.moq || s.MOQ || '-';
                const leadTime = s.lead_time || s.leadTime || '-';
                const comment = s.last_comment || s.comment || '';
                const quoteNumber = s.quote_number || s.quoteNumber || '-';

                const isMain = s.isMain;
                const isSecond = s.isSecond;
                const isThird = s.isThird;
                const hasAnyRank = isMain || isSecond || isThird;

                const rowBg = isMain ? 'background:#e8f5e9;' : (isSecond ? 'background:#e3f2fd;' : (isThird ? 'background:#fff3e0;' : ''));

                let pricesHtml = '';
                qtyTiers.forEach((t, i) => {
                    let price = 0;
                    if (s.prices && s.prices[i]) price = parseFloat(s.prices[i].price) || 0;
                    if (!price) price = parseFloat(s['price_' + (i + 1)]) || 0;

                    const eurPrice = price * rate;
                    const isBest = eurPrice > 0 && Math.abs(eurPrice - bestEurPrices[i]) < 0.01;

                    // Check if price exceeds target
                    const exceedsTarget = targetEur > 0 && eurPrice > 0 && eurPrice > targetEur;
                    const priceStyle = price > 0 ? (exceedsTarget ? 'font-weight:600; color:#FF3B30;' : 'font-weight:600;') : 'color:#ccc;';
                    const eurStyle = isBest ? 'color:#2e7d32; font-weight:700;' : (exceedsTarget ? 'color:#FF3B30;' : 'color:#007AFF;');

                    pricesHtml += `
                        <td style="text-align:right; padding:8px; ${priceStyle}">${price > 0 ? formatNumber(price, 2) + ' ' + currency : '-'}${exceedsTarget ? ' ‚ö†' : ''}</td>
                        <td style="text-align:right; padding:8px; ${eurStyle}">${eurPrice > 0 ? formatNumber(eurPrice, 2) : '-'}</td>
                    `;
                });

                // Rank badge
                let rankBadge = '';
                if (isMain) rankBadge = `<span style="background:#4caf50; color:white; padding:2px 8px; border-radius:4px; font-size:10px; margin-right:8px;">MAIN</span>`;
                else if (isSecond) rankBadge = `<span style="background:#2196f3; color:white; padding:2px 8px; border-radius:4px; font-size:10px; margin-right:8px;">2nd</span>`;
                else if (isThird) rankBadge = `<span style="background:#ff9800; color:white; padding:2px 8px; border-radius:4px; font-size:10px; margin-right:8px;">3rd</span>`;

                // Action buttons - including Unselect
                const actionBtns = `
                    <button class="pc-rank-btn" data-item-idx="${itemIdx}" data-supplier="${escapeHtml(supName)}" data-rank="1"
                        style="background:${isMain ? '#4caf50' : '#e0e0e0'}; color:${isMain ? 'white' : '#333'}; border:none; padding:4px 8px; border-radius:4px; font-size:10px; cursor:pointer; margin:1px;">
                        Main
                    </button>
                    <button class="pc-rank-btn" data-item-idx="${itemIdx}" data-supplier="${escapeHtml(supName)}" data-rank="2"
                        style="background:${isSecond ? '#2196f3' : '#e0e0e0'}; color:${isSecond ? 'white' : '#333'}; border:none; padding:4px 8px; border-radius:4px; font-size:10px; cursor:pointer; margin:1px;">
                        2nd
                    </button>
                    <button class="pc-rank-btn" data-item-idx="${itemIdx}" data-supplier="${escapeHtml(supName)}" data-rank="3"
                        style="background:${isThird ? '#ff9800' : '#e0e0e0'}; color:${isThird ? 'white' : '#333'}; border:none; padding:4px 8px; border-radius:4px; font-size:10px; cursor:pointer; margin:1px;">
                        3rd
                    </button>
                    ${hasAnyRank ? `
                    <button class="pc-unselect-btn" data-item-idx="${itemIdx}" data-supplier="${escapeHtml(supName)}"
                        style="background:#ff5722; color:white; border:none; padding:4px 6px; border-radius:4px; font-size:10px; cursor:pointer; margin:1px;" title="Remove rank">
                        ‚úï
                    </button>
                    ` : ''}
                `;

                html += `
                    <tr style="${rowBg} border-bottom:1px solid #eee;">
                        <td style="padding:8px;">
                            ${rankBadge}
                            <span style="font-weight:500;">${escapeHtml(supName)}</span>
                        </td>
                        <td style="text-align:center; padding:8px; font-size:11px; color:#666;">${escapeHtml(String(quoteNumber))}</td>
                        <td style="text-align:center; padding:8px;">
                            <span style="background:#f0f0f0; padding:2px 6px; border-radius:4px; font-size:11px;">${currency}</span>
                        </td>
                        ${pricesHtml}
                        <td style="text-align:center; padding:8px; font-size:11px;">${escapeHtml(String(moq))}</td>
                        <td style="text-align:center; padding:8px; font-size:11px;">${escapeHtml(String(leadTime))}</td>
                        <td style="padding:8px; font-size:11px; color:#666; max-width:120px; overflow:hidden; text-overflow:ellipsis;" title="${escapeHtml(comment)}">${escapeHtml(comment.length > 25 ? comment.substring(0, 25) + '...' : comment)}</td>
                        <td style="text-align:center; padding:8px;">${actionBtns}</td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            return html;
        }

        // Bulk Link Supplier Dialog for Price Comparison
        function openBulkLinkSupplierDialog(itemIndices) {
            if (!currentProject || itemIndices.length === 0) return;

            // Get all available suppliers from database
            const allSuppliers = window.RFQData && window.RFQData.GLOBAL_SUPPLIERS ? window.RFQData.GLOBAL_SUPPLIERS : [];
            const supplierOptions = allSuppliers.map(s => {
                const name = s.supplier_name || s.name || '';
                return `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`;
            }).join('');

            const modal = document.createElement('div');
            modal.id = 'pc-bulk-link-modal';
            modal.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:10000;';

            modal.innerHTML = `
                <div style="background:white; border-radius:12px; width:500px; max-width:90vw; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                    <div style="padding:20px; border-bottom:1px solid #e0e0e0;">
                        <h3 style="margin:0; font-size:18px;">Link Supplier to ${itemIndices.length} Items</h3>
                    </div>
                    <div style="padding:20px;">
                        <div style="margin-bottom:16px;">
                            <label style="font-weight:600; font-size:13px; display:block; margin-bottom:8px;">Select Supplier</label>
                            <select id="bulk-link-supplier-select" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; font-size:14px;">
                                <option value="">-- Select Supplier --</option>
                                ${supplierOptions}
                            </select>
                        </div>
                        <div style="margin-bottom:16px;">
                            <label style="font-weight:600; font-size:13px; display:block; margin-bottom:8px;">Or Enter New Supplier Name</label>
                            <input type="text" id="bulk-link-supplier-new" placeholder="Enter new supplier name..."
                                style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; font-size:14px; box-sizing:border-box;">
                        </div>
                        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:20px;">
                            <button id="bulk-link-cancel" style="padding:10px 20px; border:1px solid #ddd; background:#f5f5f5; border-radius:6px; cursor:pointer;">Cancel</button>
                            <button id="bulk-link-confirm" style="padding:10px 20px; border:none; background:#4CAF50; color:white; border-radius:6px; cursor:pointer; font-weight:600;">Link Supplier</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            const closeModal = () => modal.remove();
            modal.querySelector('#bulk-link-cancel').onclick = closeModal;
            modal.onclick = (e) => { if (e.target === modal) closeModal(); };

            modal.querySelector('#bulk-link-confirm').onclick = () => {
                const selectValue = modal.querySelector('#bulk-link-supplier-select').value;
                const newValue = modal.querySelector('#bulk-link-supplier-new').value.trim();
                const supplierName = newValue || selectValue;

                if (!supplierName) {
                    showToast('Please select or enter a supplier name', 'warning');
                    return;
                }

                itemIndices.forEach(idx => {
                    const item = currentProject.items[idx];
                    if (!item) return;
                    if (!item.suppliers) item.suppliers = [];

                    // Check if supplier already linked
                    const existing = item.suppliers.find(s => (s.supplier_name || s.name || '') === supplierName);
                    if (!existing) {
                        item.suppliers.push({
                            supplier_name: supplierName,
                            name: supplierName,
                            status: 'Pending',
                            prices: [],
                            currency: 'EUR'
                        });
                    }
                });

                // Save project
                if (currentProject) {
                    if (window.RFQData && typeof window.RFQData.updateProject === 'function') {
                        window.RFQData.updateProject(currentProject);
                    } else if (typeof updateProject === 'function') {
                        updateProject(currentProject);
                    }
                }
                closeModal();
                renderItemComparison();
            };
        }

        // Bulk Set Main Supplier Dialog for Price Comparison
        function openBulkSetMainSupplierDialog(itemIndices) {
            if (!currentProject || itemIndices.length === 0) return;

            // Collect all unique suppliers from selected items
            const suppliersSet = new Set();
            itemIndices.forEach(idx => {
                const item = currentProject.items[idx];
                if (item && item.suppliers) {
                    item.suppliers.forEach(s => {
                        const name = s.supplier_name || s.name || '';
                        if (name) suppliersSet.add(name);
                    });
                }
            });

            if (suppliersSet.size === 0) {
                showToast('No suppliers linked to selected items. Link suppliers first.', 'warning');
                return;
            }

            const supplierOptions = Array.from(suppliersSet).sort().map(name =>
                `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`
            ).join('');

            const modal = document.createElement('div');
            modal.id = 'pc-bulk-main-modal';
            modal.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:10000;';

            modal.innerHTML = `
                <div style="background:white; border-radius:12px; width:500px; max-width:90vw; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                    <div style="padding:20px; border-bottom:1px solid #e0e0e0;">
                        <h3 style="margin:0; font-size:18px;">Set Main Supplier for ${itemIndices.length} Items</h3>
                        <p style="margin:8px 0 0; color:#666; font-size:12px;">Only items that have this supplier linked will be updated</p>
                    </div>
                    <div style="padding:20px;">
                        <div style="margin-bottom:16px;">
                            <label style="font-weight:600; font-size:13px; display:block; margin-bottom:8px;">Select Supplier to Set as Main</label>
                            <select id="bulk-main-supplier-select" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; font-size:14px;">
                                <option value="">-- Select Supplier --</option>
                                ${supplierOptions}
                            </select>
                        </div>
                        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:20px;">
                            <button id="bulk-main-cancel" style="padding:10px 20px; border:1px solid #ddd; background:#f5f5f5; border-radius:6px; cursor:pointer;">Cancel</button>
                            <button id="bulk-main-confirm" style="padding:10px 20px; border:none; background:#2196F3; color:white; border-radius:6px; cursor:pointer; font-weight:600;">Set as Main</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            const closeModal = () => modal.remove();
            modal.querySelector('#bulk-main-cancel').onclick = closeModal;
            modal.onclick = (e) => { if (e.target === modal) closeModal(); };

            modal.querySelector('#bulk-main-confirm').onclick = () => {
                const supplierName = modal.querySelector('#bulk-main-supplier-select').value;

                if (!supplierName) {
                    showToast('Please select a supplier', 'warning');
                    return;
                }

                let updatedCount = 0;
                itemIndices.forEach(idx => {
                    const item = currentProject.items[idx];
                    if (!item || !item.suppliers) return;

                    // Find the supplier in this item
                    const supplierData = item.suppliers.find(s => (s.supplier_name || s.name || '') === supplierName);
                    if (supplierData) {
                        // Clear all isMain flags
                        item.suppliers.forEach(s => s.isMain = false);
                        // Set this supplier as main
                        supplierData.isMain = true;
                        updatedCount++;
                    }
                });

                // Save project
                if (currentProject) {
                    if (window.RFQData && typeof window.RFQData.updateProject === 'function') {
                        window.RFQData.updateProject(currentProject);
                    } else if (typeof updateProject === 'function') {
                        updateProject(currentProject);
                    }
                }
                closeModal();
                renderItemComparison();
                if (updatedCount > 0) {
                    showToast(`‚úÖ Set ${supplierName} as main for ${updatedCount} items`);
                }
            };
        }

        // Price Comparison Export Dialog
        function openPriceComparisonExportDialog(filteredItems, rates) {
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'pc-export-modal';
            modal.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:10000;';

            modal.innerHTML = `
                <div style="background:white; border-radius:12px; width:600px; max-width:90vw; max-height:90vh; overflow:auto; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                    <div style="padding:20px; border-bottom:1px solid #e0e0e0;">
                        <h3 style="margin:0; font-size:18px;">Export Price Comparison</h3>
                        <p style="margin:8px 0 0 0; color:#666; font-size:13px;">Choose what data to export</p>
                    </div>
                    <div style="padding:20px;">
                        <div style="margin-bottom:20px;">
                            <label style="font-weight:600; font-size:13px; display:block; margin-bottom:8px;">Export Format</label>
                            <div style="display:flex; gap:12px;">
                                <label style="display:flex; align-items:center; gap:6px; cursor:pointer; padding:12px; border:2px solid #007AFF; border-radius:8px; flex:1; background:#f0f7ff;">
                                    <input type="radio" name="pc-export-format" value="summary" checked>
                                    <div>
                                        <div style="font-weight:600; font-size:13px;">Summary</div>
                                        <div style="font-size:11px; color:#666;">One row per item with main supplier</div>
                                    </div>
                                </label>
                                <label style="display:flex; align-items:center; gap:6px; cursor:pointer; padding:12px; border:2px solid #ddd; border-radius:8px; flex:1;">
                                    <input type="radio" name="pc-export-format" value="detailed">
                                    <div>
                                        <div style="font-weight:600; font-size:13px;">Detailed</div>
                                        <div style="font-size:11px; color:#666;">All suppliers per item (multiple rows)</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div style="margin-bottom:20px;">
                            <label style="font-weight:600; font-size:13px; display:block; margin-bottom:8px;">Columns to Include</label>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                                <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:12px;">
                                    <input type="checkbox" name="pc-export-col" value="drawing_no" checked> Drawing No
                                </label>
                                <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:12px;">
                                    <input type="checkbox" name="pc-export-col" value="description" checked> Description
                                </label>
                                <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:12px;">
                                    <input type="checkbox" name="pc-export-col" value="manufacturer"> Manufacturer
                                </label>
                                <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:12px;">
                                    <input type="checkbox" name="pc-export-col" value="mpn"> MPN
                                </label>
                                <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:12px;">
                                    <input type="checkbox" name="pc-export-col" value="status" checked> Item Status
                                </label>
                                <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:12px;">
                                    <input type="checkbox" name="pc-export-col" value="qty" checked> Quantities
                                </label>
                                <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:12px;">
                                    <input type="checkbox" name="pc-export-col" value="target_price" checked> Target Price (EUR)
                                </label>
                                <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:12px;">
                                    <input type="checkbox" name="pc-export-col" value="supplier" checked> Supplier
                                </label>
                                <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:12px;">
                                    <input type="checkbox" name="pc-export-col" value="price_eur" checked> Price (EUR)
                                </label>
                                <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:12px;">
                                    <input type="checkbox" name="pc-export-col" value="price_orig"> Price (Original Currency)
                                </label>
                                <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:12px;">
                                    <input type="checkbox" name="pc-export-col" value="moq" checked> MOQ
                                </label>
                                <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:12px;">
                                    <input type="checkbox" name="pc-export-col" value="lead_time" checked> Lead Time
                                </label>
                                <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:12px;">
                                    <input type="checkbox" name="pc-export-col" value="quote_number"> Quote Number
                                </label>
                                <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:12px;">
                                    <input type="checkbox" name="pc-export-col" value="rank"> Rank (Main/2nd/3rd)
                                </label>
                                <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:12px;">
                                    <input type="checkbox" name="pc-export-col" value="total_eur"> Total Value (EUR)
                                </label>
                                <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:12px;">
                                    <input type="checkbox" name="pc-export-col" value="vs_target"> vs Target (%)
                                </label>
                            </div>
                        </div>

                        <div style="margin-bottom:20px;">
                            <label style="font-weight:600; font-size:13px; display:block; margin-bottom:8px;">Filter Data</label>
                            <div style="display:flex; gap:12px; flex-wrap:wrap;">
                                <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:12px;">
                                    <input type="checkbox" id="pc-export-only-with-main"> Only items with MAIN supplier
                                </label>
                                <label style="display:flex; align-items:center; gap:6px; cursor:pointer; font-size:12px;">
                                    <input type="checkbox" id="pc-export-only-with-quotes"> Only items with quotes
                                </label>
                            </div>
                        </div>

                        <div style="background:#f5f5f7; padding:12px; border-radius:8px; font-size:12px; color:#666;">
                            <strong>${filteredItems.length}</strong> items will be exported (based on current filters)
                        </div>
                    </div>
                    <div style="padding:16px 20px; border-top:1px solid #e0e0e0; display:flex; justify-content:flex-end; gap:12px;">
                        <button id="pc-export-cancel" class="btn-secondary" style="padding:10px 20px;">Cancel</button>
                        <button id="pc-export-confirm" class="btn-success" style="padding:10px 24px;">Export Excel</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Style radio buttons to highlight selected
            modal.querySelectorAll('input[name="pc-export-format"]').forEach(radio => {
                radio.onchange = () => {
                    modal.querySelectorAll('input[name="pc-export-format"]').forEach(r => {
                        r.closest('label').style.borderColor = r.checked ? '#007AFF' : '#ddd';
                        r.closest('label').style.background = r.checked ? '#f0f7ff' : 'white';
                    });
                };
            });

            // Cancel button
            modal.querySelector('#pc-export-cancel').onclick = () => modal.remove();
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

            // Export button
            modal.querySelector('#pc-export-confirm').onclick = () => {
                const format = modal.querySelector('input[name="pc-export-format"]:checked').value;
                const columns = Array.from(modal.querySelectorAll('input[name="pc-export-col"]:checked')).map(cb => cb.value);
                const onlyWithMain = modal.querySelector('#pc-export-only-with-main').checked;
                const onlyWithQuotes = modal.querySelector('#pc-export-only-with-quotes').checked;

                executePriceComparisonExport(filteredItems, rates, format, columns, onlyWithMain, onlyWithQuotes);
                modal.remove();
            };
        }

        // Execute the Price Comparison Export
        function executePriceComparisonExport(items, rates, format, columns, onlyWithMain, onlyWithQuotes) {
            if (typeof XLSX === 'undefined') {
                showToast('Excel library not loaded. Please wait and try again.', 'error');
                return;
            }

            // Filter items
            let exportItems = [...items];
            if (onlyWithMain) {
                exportItems = exportItems.filter(item => {
                    const suppliers = item.suppliers || [];
                    return suppliers.some(s => s.isMain);
                });
            }
            if (onlyWithQuotes) {
                exportItems = exportItems.filter(item => {
                    const suppliers = item.suppliers || [];
                    return suppliers.some(s => {
                        if (s.prices && s.prices.some(p => parseFloat(p.price) > 0)) return true;
                        if (parseFloat(s.price_1 || s.price) > 0) return true;
                        return false;
                    });
                });
            }

            const data = [];
            const colMap = {
                drawing_no: 'Drawing No',
                description: 'Description',
                manufacturer: 'Manufacturer',
                mpn: 'MPN',
                status: 'Item Status',
                qty: 'QTY 1',
                target_price: 'Target (EUR)',
                supplier: 'Supplier',
                price_eur: 'Price (EUR)',
                price_orig: 'Price (Orig)',
                currency: 'Currency',
                moq: 'MOQ',
                lead_time: 'Lead Time',
                quote_number: 'Quote #',
                rank: 'Rank',
                total_eur: 'Total (EUR)',
                vs_target: 'vs Target %'
            };

            // Build header
            const header = columns.map(c => colMap[c] || c);
            data.push(header);

            exportItems.forEach(item => {
                const suppliers = item.suppliers || [];
                const dn = item.item_drawing_no || item.drawing_no || '';
                const desc = item.description || '';
                const manufacturer = item.manufacturer || '';
                const mpn = item.mpn || '';
                const itemStatus = item.status || 'New';
                const qty1 = parseFloat(item.qty_1) || 0;
                const targetPrice = parseFloat(item.target_price) || 0;
                const targetCurrency = item.target_currency || 'EUR';
                const targetRate = rates[targetCurrency] || 1;
                const targetEur = targetPrice * targetRate;

                if (format === 'summary') {
                    // One row per item - use main supplier or best price
                    const mainSup = suppliers.find(s => s.isMain);
                    const supData = mainSup || suppliers[0];

                    if (supData || !onlyWithQuotes) {
                        const row = [];
                        const supName = supData ? (supData.supplier_name || supData.supplier || supData.name || '') : '';
                        const currency = supData ? (supData.currency || 'EUR') : 'EUR';
                        const rate = rates[currency] || 1;
                        let price = 0;
                        if (supData) {
                            if (supData.prices && supData.prices[0]) price = parseFloat(supData.prices[0].price) || 0;
                            if (!price) price = parseFloat(supData.price_1 || supData.price) || 0;
                        }
                        const eurPrice = price * rate;
                        const totalEur = eurPrice * qty1;
                        const vsTarget = targetEur > 0 ? ((eurPrice - targetEur) / targetEur * 100).toFixed(1) + '%' : '-';
                        const rank = mainSup ? 'MAIN' : (supData?.isSecond ? '2nd' : (supData?.isThird ? '3rd' : '-'));

                        columns.forEach(col => {
                            if (col === 'drawing_no') row.push(dn);
                            else if (col === 'description') row.push(desc);
                            else if (col === 'manufacturer') row.push(manufacturer);
                            else if (col === 'mpn') row.push(mpn);
                            else if (col === 'status') row.push(itemStatus);
                            else if (col === 'qty') row.push(qty1);
                            else if (col === 'target_price') row.push(targetEur > 0 ? targetEur : '');
                            else if (col === 'supplier') row.push(supName);
                            else if (col === 'price_eur') row.push(eurPrice > 0 ? eurPrice : '');
                            else if (col === 'price_orig') row.push(price > 0 ? price : '');
                            else if (col === 'moq') row.push(supData ? (supData.moq || supData.MOQ || '') : '');
                            else if (col === 'lead_time') row.push(supData ? (supData.lead_time || supData.leadTime || '') : '');
                            else if (col === 'quote_number') row.push(supData ? (supData.quote_number || supData.quoteNumber || '') : '');
                            else if (col === 'rank') row.push(rank);
                            else if (col === 'total_eur') row.push(totalEur > 0 ? totalEur : '');
                            else if (col === 'vs_target') row.push(vsTarget);
                        });
                        data.push(row);
                    }
                } else {
                    // Detailed - one row per supplier
                    const suppliersToExport = suppliers.length > 0 ? suppliers : [null];
                    suppliersToExport.forEach(supData => {
                        const row = [];
                        const supName = supData ? (supData.supplier_name || supData.supplier || supData.name || '') : '';
                        const currency = supData ? (supData.currency || 'EUR') : 'EUR';
                        const rate = rates[currency] || 1;
                        let price = 0;
                        if (supData) {
                            if (supData.prices && supData.prices[0]) price = parseFloat(supData.prices[0].price) || 0;
                            if (!price) price = parseFloat(supData.price_1 || supData.price) || 0;
                        }
                        const eurPrice = price * rate;
                        const totalEur = eurPrice * qty1;
                        const vsTarget = targetEur > 0 && eurPrice > 0 ? ((eurPrice - targetEur) / targetEur * 100).toFixed(1) + '%' : '-';
                        const rank = supData?.isMain ? 'MAIN' : (supData?.isSecond ? '2nd' : (supData?.isThird ? '3rd' : '-'));

                        columns.forEach(col => {
                            if (col === 'drawing_no') row.push(dn);
                            else if (col === 'description') row.push(desc);
                            else if (col === 'manufacturer') row.push(manufacturer);
                            else if (col === 'mpn') row.push(mpn);
                            else if (col === 'status') row.push(itemStatus);
                            else if (col === 'qty') row.push(qty1);
                            else if (col === 'target_price') row.push(targetEur > 0 ? targetEur : '');
                            else if (col === 'supplier') row.push(supName);
                            else if (col === 'price_eur') row.push(eurPrice > 0 ? eurPrice : '');
                            else if (col === 'price_orig') row.push(price > 0 ? price : '');
                            else if (col === 'moq') row.push(supData ? (supData.moq || supData.MOQ || '') : '');
                            else if (col === 'lead_time') row.push(supData ? (supData.lead_time || supData.leadTime || '') : '');
                            else if (col === 'quote_number') row.push(supData ? (supData.quote_number || supData.quoteNumber || '') : '');
                            else if (col === 'rank') row.push(rank);
                            else if (col === 'total_eur') row.push(totalEur > 0 ? totalEur : '');
                            else if (col === 'vs_target') row.push(vsTarget);
                        });
                        data.push(row);
                    });
                }
            });

            // Create workbook and download
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Price Comparison');

            const projName = currentProject ? (currentProject.name || currentProject.project_name || 'Project') : 'Project';
            const filename = `${projName}_PriceComparison_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        // Set main supplier for an item (rank: 1=Main, 2=Second, 3=Third)
        function setSupplierRankForItem(itemIdx, supplierName, rank) {
            if (!currentProject || !currentProject.items || !currentProject.items[itemIdx]) {
                showToast('Item not found', 'warning');
                return;
            }

            const item = currentProject.items[itemIdx];
            const suppliers = item.suppliers || [];

            // Clear existing rank for this position
            suppliers.forEach(s => {
                if (rank === 1) s.isMain = false;
                if (rank === 2) s.isSecond = false;
                if (rank === 3) s.isThird = false;
            });

            // Set new rank
            const targetSup = suppliers.find(s => {
                const n = s.supplier_name || s.supplier || s.name || '';
                return _normSupKey(n) === _normSupKey(supplierName);
            });

            if (targetSup) {
                if (rank === 1) targetSup.isMain = true;
                if (rank === 2) targetSup.isSecond = true;
                if (rank === 3) targetSup.isThird = true;

                // Also update legacy supplier field when setting main
                if (rank === 1) {
                    item.supplier = supplierName;
                    // Copy price data from main supplier to item for backwards compatibility
                    if (targetSup.price_1) item.price_1 = targetSup.price_1;
                    if (targetSup.currency) item.currency = targetSup.currency;
                    if (targetSup.moq) item.moq = targetSup.moq;
                    if (targetSup.lead_time) item.lead_time = targetSup.lead_time;
                }

                // Save to localStorage
                if (window.RFQData && typeof window.RFQData.updateProject === 'function') {
                    window.RFQData.updateProject(currentProject);
                }

                // Immediate UI update
                renderItemComparison();

                // Also refresh other views if needed
                if (typeof renderCompactTable === 'function') {
                    try { renderCompactTable(); } catch (e) { }
                }
                if (typeof renderDashboard === 'function') {
                    try { renderDashboard(); } catch (e) { }
                }
                if (typeof renderMainOverview === 'function') {
                    try { renderMainOverview(); } catch (e) { }
                }
            } else {
                showToast('Supplier not found on this item', 'warning');
            }
        }

        // Legacy wrapper
        function setMainSupplierForItem(itemIdx, supplierName) {
            setSupplierRankForItem(itemIdx, supplierName, 1);
        }

        // Unselect all ranks for a supplier
        function unselectSupplierForItem(itemIdx, supplierName) {
            if (!currentProject || !currentProject.items || !currentProject.items[itemIdx]) {
                showToast('Item not found', 'warning');
                return;
            }

            const item = currentProject.items[itemIdx];
            const suppliers = item.suppliers || [];

            const targetSup = suppliers.find(s => {
                const n = s.supplier_name || s.supplier || s.name || '';
                return _normSupKey(n) === _normSupKey(supplierName);
            });

            if (targetSup) {
                targetSup.isMain = false;
                targetSup.isSecond = false;
                targetSup.isThird = false;

                // Save to localStorage
                if (window.RFQData && typeof window.RFQData.updateProject === 'function') {
                    window.RFQData.updateProject(currentProject);
                }

                // Immediate UI update
                renderItemComparison();

                // Also refresh other views if needed
                if (typeof renderCompactTable === 'function') {
                    try { renderCompactTable(); } catch (e) { }
                }
                if (typeof renderDashboard === 'function') {
                    try { renderDashboard(); } catch (e) { }
                }
            }
        }

        function buildQuotesForItem(suppliers, item) {
            // Legacy function kept for compatibility
            if (!suppliers || suppliers.length === 0) {
                return '<div class="rfq-no-quotes">No quotes yet. Click "+ Add New Quote" to add.</div>';
            }
            const quotesWithPrices = suppliers.filter(s => parseFloat(s.price || s.unit_price || 0) > 0);
            if (quotesWithPrices.length === 0) {
                return '<div class="rfq-no-quotes">No prices entered yet.</div>';
            }
            let bestPrice = Infinity;
            quotesWithPrices.forEach(s => {
                const price = parseFloat(s.price || s.unit_price || 0);
                if (price > 0 && price < bestPrice) bestPrice = price;
            });
            const quotesHtml = quotesWithPrices.map(s => {
                const name = s.supplier_name || s.supplier || s.name || 'Unknown';
                const price = parseFloat(s.price || s.unit_price || 0);
                const currency = s.currency || item.currency || 'EUR';
                const leadTime = s.lead_time || s.leadTime || '-';
                const isBest = price === bestPrice && quotesWithPrices.length > 1;
                return `
                    <div class="rfq-quote-card ${isBest ? 'best' : ''}">
                        <div class="rfq-quote-supplier">${escapeHtml(name)}</div>
                        <div class="rfq-quote-price ${isBest ? 'best' : ''}">${formatPrice(price)} ${escapeHtml(currency)}</div>
                        <div class="rfq-quote-meta">Lead: ${escapeHtml(String(leadTime))}</div>
                    </div>
                `;
            }).join('');

            return `<div class="rfq-quotes-grid">${quotesHtml}</div>`;
        }

        function openQuoteWizard() {
            if (!currentProject) {
                if (window.showToast) window.showToast('Select a project first', 'warning');
                return;
            }

            // Reset wizard state
            quoteWizardState.step = 1;
            quoteWizardState.supplier = '';
            quoteWizardState.dueDate = new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
            quoteWizardState.currency = 'EUR';
            quoteWizardState.incoterms = '';
            quoteWizardState.status = 'Draft';
            quoteWizardState.contact = '';
            quoteWizardState.email = '';
            quoteWizardState.notes = '';
            quoteWizardState.selectedItems.clear();
            quoteWizardState.prices = {};

            // Populate supplier dropdown
            populateSupplierDropdown();

            // Set default values
            document.getElementById('wiz-due-date').value = quoteWizardState.dueDate;
            document.getElementById('wiz-currency').value = quoteWizardState.currency;
            document.getElementById('wiz-status').value = quoteWizardState.status;
            document.getElementById('wiz-supplier').value = '';
            document.getElementById('wiz-supplier-new').value = '';
            document.getElementById('wiz-incoterms').value = '';
            document.getElementById('wiz-contact').value = '';
            document.getElementById('wiz-email').value = '';
            document.getElementById('wiz-notes').value = '';

            // Show step 1
            showWizardStep(1);

            // Show modal
            document.getElementById('quote-wizard-modal').classList.remove('hidden');
        }

        function closeQuoteWizard() {
            document.getElementById('quote-wizard-modal').classList.add('hidden');
        }

        function populateSupplierDropdown() {
            const select = document.getElementById('wiz-supplier');
            if (!select || !currentProject) return;

            const supplierSet = new Set();

            // From items suppliers
            (currentProject.items || []).forEach(item => {
                (item.suppliers || []).forEach(s => {
                    const name = s.supplier_name || s.supplier || s.name || '';
                    if (name) supplierSet.add(name);
                });
            });

            // From project suppliers
            (currentProject.suppliers || []).forEach(s => {
                const name = s.name || s.supplier_name || s.supplier || '';
                if (name) supplierSet.add(name);
            });

            const sorted = Array.from(supplierSet).sort();
            select.innerHTML = '<option value="">-- Select existing supplier --</option>' +
                sorted.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');
        }

        function showWizardStep(step) {
            quoteWizardState.step = step;

            // Update step indicators
            document.querySelectorAll('.rfq-step').forEach(el => {
                const s = parseInt(el.dataset.step);
                el.classList.remove('active', 'completed');
                if (s < step) el.classList.add('completed');
                if (s === step) el.classList.add('active');
            });

            // Show/hide step content
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`wizard-step-${i}`);
                if (stepEl) {
                    stepEl.classList.toggle('hidden', i !== step);
                }
            }

            // Update buttons
            const prevBtn = document.getElementById('wizard-prev');
            const nextBtn = document.getElementById('wizard-next');
            const saveBtn = document.getElementById('wizard-save');

            prevBtn.disabled = step === 1;
            nextBtn.classList.toggle('hidden', step === 4);
            saveBtn.classList.toggle('hidden', step !== 4);

            // Render step-specific content
            if (step === 2) renderWizardItemsList();
            if (step === 3) renderWizardPricesTable();
            if (step === 4) renderWizardReview();
        }

        function prevWizardStep() {
            if (quoteWizardState.step > 1) {
                showWizardStep(quoteWizardState.step - 1);
            }
        }

        function nextWizardStep() {
            const step = quoteWizardState.step;

            // Validate current step
            if (step === 1) {
                const supplierSelect = document.getElementById('wiz-supplier').value;
                const supplierNew = document.getElementById('wiz-supplier-new').value.trim();
                quoteWizardState.supplier = supplierNew || supplierSelect;

                if (!quoteWizardState.supplier) {
                    showToast('Please select or enter a supplier name', 'warning');
                    return;
                }

                quoteWizardState.dueDate = document.getElementById('wiz-due-date').value;
                quoteWizardState.currency = document.getElementById('wiz-currency').value;
                quoteWizardState.incoterms = document.getElementById('wiz-incoterms').value;
                quoteWizardState.status = document.getElementById('wiz-status').value;
                quoteWizardState.contact = document.getElementById('wiz-contact').value;
                quoteWizardState.email = document.getElementById('wiz-email').value;
                quoteWizardState.notes = document.getElementById('wiz-notes').value;
            }

            if (step === 2) {
                if (quoteWizardState.selectedItems.size === 0) {
                    if (window.showToast) window.showToast('Please select at least one item', 'warning');
                    return;
                }
            }

            if (step === 3) {
                // Collect prices from table
                collectPricesFromTable();
            }

            if (step < 4) {
                showWizardStep(step + 1);
            }
        }

        function renderWizardItemsList() {
            const container = document.getElementById('wiz-items-list');
            if (!container || !currentProject) return;

            const items = currentProject.items || [];
            const searchQ = (document.getElementById('wiz-items-search')?.value || '').toLowerCase().trim();

            const filtered = items.filter(item => {
                if (!searchQ) return true;
                const dn = String(item.item_drawing_no || item.drawing_no || '').toLowerCase();
                const desc = String(item.description || '').toLowerCase();
                return dn.includes(searchQ) || desc.includes(searchQ);
            });

            const html = filtered.map(item => {
                const dn = item.item_drawing_no || item.drawing_no || '';
                const desc = item.description || '-';
                const isSelected = quoteWizardState.selectedItems.has(dn);

                return `
                    <div class="rfq-item-row ${isSelected ? 'selected' : ''}" data-dn="${escapeHtml(dn)}">
                        <input type="checkbox" data-dn="${escapeHtml(dn)}" ${isSelected ? 'checked' : ''}>
                        <div class="rfq-item-info">
                            <div class="rfq-item-info-title">${escapeHtml(dn)}</div>
                            <div class="rfq-item-info-desc">${escapeHtml(desc)}</div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html || '<div style="padding:20px; text-align:center; color:#888;">No items found</div>';

            // Bind checkbox events
            container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.onchange = () => {
                    const dn = cb.dataset.dn;
                    if (cb.checked) {
                        quoteWizardState.selectedItems.add(dn);
                        cb.closest('.rfq-item-row').classList.add('selected');
                    } else {
                        quoteWizardState.selectedItems.delete(dn);
                        cb.closest('.rfq-item-row').classList.remove('selected');
                    }
                    updateSelectedCount();
                };
            });

            // Click on row toggles checkbox
            container.querySelectorAll('.rfq-item-row').forEach(row => {
                row.onclick = (e) => {
                    if (e.target.type === 'checkbox') return;
                    const cb = row.querySelector('input[type="checkbox"]');
                    cb.checked = !cb.checked;
                    cb.onchange();
                };
            });

            updateSelectedCount();
        }

        function updateSelectedCount() {
            const countEl = document.getElementById('wiz-selected-count');
            if (countEl) {
                countEl.textContent = `${quoteWizardState.selectedItems.size} selected`;
            }
        }

        function renderWizardPricesTable() {
            const tbody = document.getElementById('wiz-prices-tbody');
            if (!tbody || !currentProject) return;

            const items = currentProject.items || [];
            const selectedDNs = Array.from(quoteWizardState.selectedItems);

            const html = selectedDNs.map(dn => {
                const item = items.find(it => (it.item_drawing_no || it.drawing_no) === dn);
                const desc = item ? (item.description || '-') : '-';
                const qty = item ? (item.qty || item.quantity || '') : '';

                const existing = quoteWizardState.prices[dn] || {};

                return `
                    <tr data-dn="${escapeHtml(dn)}">
                        <td><strong>${escapeHtml(dn)}</strong></td>
                        <td>${escapeHtml(desc)}</td>
                        <td><input type="number" class="wiz-qty1" value="${escapeHtml(String(existing.qty1 || qty || ''))}" placeholder="${qty}"></td>
                        <td><input type="number" step="0.0001" class="wiz-price1" value="${existing.price1 || ''}" placeholder="0.00"></td>
                        <td><input type="number" class="wiz-qty2" value="${existing.qty2 || ''}" placeholder=""></td>
                        <td><input type="number" step="0.0001" class="wiz-price2" value="${existing.price2 || ''}" placeholder="0.00"></td>
                        <td><input type="text" class="wiz-leadtime" value="${escapeHtml(existing.leadTime || '')}" placeholder="e.g. 4 weeks"></td>
                        <td><input type="number" class="wiz-moq" value="${existing.moq || ''}" placeholder=""></td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = html || '<tr><td colspan="8" style="text-align:center; color:#888;">No items selected</td></tr>';
        }

        function collectPricesFromTable() {
            const tbody = document.getElementById('wiz-prices-tbody');
            if (!tbody) return;

            tbody.querySelectorAll('tr[data-dn]').forEach(tr => {
                const dn = tr.dataset.dn;
                quoteWizardState.prices[dn] = {
                    qty1: tr.querySelector('.wiz-qty1')?.value || '',
                    price1: tr.querySelector('.wiz-price1')?.value || '',
                    qty2: tr.querySelector('.wiz-qty2')?.value || '',
                    price2: tr.querySelector('.wiz-price2')?.value || '',
                    leadTime: tr.querySelector('.wiz-leadtime')?.value || '',
                    moq: tr.querySelector('.wiz-moq')?.value || ''
                };
            });
        }

        function renderWizardReview() {
            const summaryEl = document.getElementById('wiz-review-summary');
            const itemsEl = document.getElementById('wiz-review-items');
            if (!summaryEl || !itemsEl) return;

            // Summary
            summaryEl.innerHTML = `
                <div class="rfq-review-item">
                    <div class="rfq-review-label">Supplier</div>
                    <div class="rfq-review-value">${escapeHtml(quoteWizardState.supplier)}</div>
                </div>
                <div class="rfq-review-item">
                    <div class="rfq-review-label">Currency</div>
                    <div class="rfq-review-value">${escapeHtml(quoteWizardState.currency)}</div>
                </div>
                <div class="rfq-review-item">
                    <div class="rfq-review-label">Status</div>
                    <div class="rfq-review-value">${escapeHtml(quoteWizardState.status)}</div>
                </div>
                <div class="rfq-review-item">
                    <div class="rfq-review-label">Due Date</div>
                    <div class="rfq-review-value">${escapeHtml(quoteWizardState.dueDate || '-')}</div>
                </div>
                <div class="rfq-review-item">
                    <div class="rfq-review-label">Incoterms</div>
                    <div class="rfq-review-value">${escapeHtml(quoteWizardState.incoterms || '-')}</div>
                </div>
                <div class="rfq-review-item">
                    <div class="rfq-review-label">Items</div>
                    <div class="rfq-review-value">${quoteWizardState.selectedItems.size}</div>
                </div>
            `;

            // Items with prices
            const rows = Array.from(quoteWizardState.selectedItems).map(dn => {
                const p = quoteWizardState.prices[dn] || {};
                const price1 = p.price1 ? formatPrice(parseFloat(p.price1)) : '-';
                return `
                    <div class="rfq-item-row">
                        <div class="rfq-item-info">
                            <div class="rfq-item-info-title">${escapeHtml(dn)}</div>
                            <div class="rfq-item-info-desc">Price: ${price1} ${escapeHtml(quoteWizardState.currency)} | Lead: ${escapeHtml(p.leadTime || '-')}</div>
                        </div>
                    </div>
                `;
            }).join('');

            itemsEl.innerHTML = rows || '<div style="padding:20px; text-align:center; color:#888;">No items</div>';
        }

        function saveQuote() {
            if (!currentProject) return;

            const supplier = quoteWizardState.supplier;
            const items = currentProject.items || [];

            // Update each selected item with the new quote
            quoteWizardState.selectedItems.forEach(dn => {
                const item = items.find(it => (it.item_drawing_no || it.drawing_no) === dn);
                if (!item) return;

                if (!item.suppliers) item.suppliers = [];

                const priceData = quoteWizardState.prices[dn] || {};

                // Check if supplier already exists for this item
                let supEntry = item.suppliers.find(s =>
                    (s.supplier_name || s.supplier || s.name || '').toLowerCase() === supplier.toLowerCase()
                );

                if (!supEntry) {
                    supEntry = { supplier_name: supplier };
                    item.suppliers.push(supEntry);
                }

                // Update supplier entry with quote data
                supEntry.supplier_name = supplier;
                supEntry.price = priceData.price1 || '';
                supEntry.price_t1 = priceData.price1 || '';
                supEntry.qty_t1 = priceData.qty1 || '';
                supEntry.price_t2 = priceData.price2 || '';
                supEntry.qty_t2 = priceData.qty2 || '';
                supEntry.lead_time = priceData.leadTime || '';
                supEntry.moq = priceData.moq || '';
                supEntry.currency = quoteWizardState.currency;
                supEntry.incoterms = quoteWizardState.incoterms;
                supEntry.status = quoteWizardState.status;
                supEntry.contact = quoteWizardState.contact;
                supEntry.email = quoteWizardState.email;
                supEntry.due_date = quoteWizardState.dueDate;
                supEntry.notes = quoteWizardState.notes;
                supEntry.quote_date = new Date().toISOString();
            });

            // Save project
            try {
                updateProject(currentProject);
            } catch (e) {
                console.error('Failed to save project:', e);
            }

            // Close wizard
            closeQuoteWizard();

            // Refresh view
            renderItemComparison();

            // Show success message
            showToast(`Quote saved successfully! Supplier: ${supplier}, Items: ${quoteWizardState.selectedItems.size}`, 'success');
        }

        // Keep old function signature for compatibility
        function renderQuotingViewOld() {

            if (st.batchId) {
                try { openRFQBatchDetail(st.batchId); } catch (e) { }
                return;
            }
        }

        // =========================================================
        // Quoting Cockpit helpers (v47)
        // =========================================================
        function getQuotingState() {
            window.__RFQ_QUOTING_STATE__ = window.__RFQ_QUOTING_STATE__ || { supplier: '', batchId: '', mode: 'home', wizOpen: false, compareDn: '', compareTier: 1 };
            const s = window.__RFQ_QUOTING_STATE__;
            s.supplier = String(s.supplier || '').trim();
            s.batchId = String(s.batchId || '').trim();
            s.mode = String(s.mode || 'home').trim();
            s.compareDn = String(s.compareDn || '').trim();
            s.compareTier = parseInt(s.compareTier || 1, 10);
            if (!Number.isFinite(s.compareTier) || s.compareTier < 1) s.compareTier = 1;
            s.wizOpen = !!s.wizOpen;
            return s;
        }

        function renderQuotingWorkspaceHome() {
            const st = getQuotingState();
            const panel = getEl('quoting-wizard-panel');
            if (!panel) return;
            const supTxt = st.supplier ? `Supplier: <b>${escapeHtml(st.supplier)}</b>` : 'Pick a supplier on the left';
            panel.innerHTML = `
                <div class="qt-workspace-empty">
                    <div class="qt-big-icon">üß©</div>
                    <div class="qt-workspace-title">Quoting Cockpit</div>
                    <div class="qt-workspace-sub">${supTxt}</div>
                    <div style="margin-top:10px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
                        <button class="btn-primary" id="qt-cta-new-bundle" type="button">+ New RFQ Bundle</button>
                        <button class="btn-secondary" id="qt-cta-sync" type="button">Sync</button>
                        <button class="btn-secondary" id="qt-cta-compare" type="button">Compare Quotes</button>
                    </div>
                    <div class="qt-workspace-sub" style="margin-top:10px;">
                        Workflow: <b>Supplier</b> ‚Üí create <b>Bundle</b> ‚Üí enter <b>Quote</b> ‚Üí prices sync into <b>Item Detail ‚Üí Suppliers & Pricing</b>.
                    </div>
                </div>
            `;
            const ctaNew = panel.querySelector('#qt-cta-new-bundle');
            if (ctaNew) ctaNew.onclick = () => {
                const st2 = getQuotingState();
                st2.mode = 'create';
                st2.wizOpen = true;
                renderQuotingView();
            };
            const ctaCompare = panel.querySelector('#qt-cta-compare');
            if (ctaCompare) ctaCompare.onclick = () => { switchView('quote-compare'); };

            const ctaSync = panel.querySelector('#qt-cta-sync');
            if (ctaSync) ctaSync.onclick = () => {
                if (!currentProject) return;
                try { syncAllBatchesToItems(currentProject); } catch (e) { }
                try { updateProject(currentProject); } catch (e) { }
                showToast('Synced bundles ‚Üí items (Suppliers & Pricing).', 'success');
            };
        }


        function listQtyTiersFromItem(item) {
            const tiers = [];
            if (!item) return tiers;
            const keys = Object.keys(item).filter(k => /^qty_\d+$/.test(k));
            keys.sort((a, b) => parseInt(a.split('_')[1], 10) - parseInt(b.split('_')[1], 10));
            keys.forEach(k => {
                const idx = parseInt(k.split('_')[1], 10);
                const v = item[k];
                const num = (v === '' || v === null || typeof v === 'undefined') ? NaN : Number(v);
                if (Number.isFinite(num) && num > 0) tiers.push({ idx, qty: num });
            });
            const maxIdx = tiers.length ? Math.max(...tiers.map(t => t.idx)) : 0;
            const ensure = Math.max(5, maxIdx);
            for (let i = 1; i <= ensure; i++) {
                if (!tiers.find(t => t.idx === i)) tiers.push({ idx: i, qty: '' });
            }
            tiers.sort((a, b) => a.idx - b.idx);
            return tiers;
        }

        function getItemByDrawingNo(project, dn) {
            const key = String(dn || '').trim();
            const arr = project && Array.isArray(project.items) ? project.items : [];
            return arr.find(it => String(it.item_drawing_no || '').trim() === key) || null;
        }

        function getSupplierRecordForItem(item, supplierName) {
            const norm = (v) => String(v || '').trim().toLowerCase();
            const name = String(supplierName || '').trim();
            const list = item && Array.isArray(item.suppliers) ? item.suppliers : [];
            return list.find(s => norm(s && s.name) === norm(name)) || null;
        }

        function getQtyTierKeys(item) {
            if (!item) return ['qty_1', 'qty_2', 'qty_3', 'qty_4', 'qty_5'];
            const keys = Object.keys(item).filter(k => /^qty_\d+$/.test(k));
            keys.sort((a, b) => parseInt(a.split('_')[1], 10) - parseInt(b.split('_')[1], 10));
            const filtered = [];
            keys.forEach(k => {
                const v = item[k];
                const num = (v === '' || v === null || typeof v === 'undefined') ? NaN : Number(v);
                if (Number.isFinite(num) && num > 0) filtered.push(k);
            });
            if (filtered.length === 0) return ['qty_1', 'qty_2', 'qty_3', 'qty_4', 'qty_5'];
            return filtered;
        }

        function ensureItemAwardShape(item) {
            if (!item) return null;
            if (!item.award || typeof item.award !== 'object') {
                item.award = { mode: 'per_tier', default_tier_key: 'qty_1', tiers: {} };
            }
            if (!item.award.mode) item.award.mode = 'per_tier';
            if (!item.award.tiers || typeof item.award.tiers !== 'object') item.award.tiers = {};
            if (!item.award.default_tier_key) {
                const keys = getQtyTierKeys(item);
                item.award.default_tier_key = keys[0] || 'qty_1';
            }
            return item;
        }

        function getAwardWinnerForTier(item, tierKey) {
            if (!item || !item.award || !item.award.tiers) return '';
            const rec = item.award.tiers[tierKey];
            return rec && rec.supplier_id ? String(rec.supplier_id) : '';
        }

        function setAwardDefaultTier(item, tierKey) {
            ensureItemAwardShape(item);
            item.award.default_tier_key = String(tierKey || 'qty_1');
            projectAwardToSuppliers(item);
        }

        function setAwardWinnerForTier(item, tierKey, supplierName, meta) {
            ensureItemAwardShape(item);
            const tk = String(tierKey || 'qty_1');
            const sup = String(supplierName || '').trim();
            if (!sup) return;
            const now = new Date().toISOString();
            item.award.tiers[tk] = {
                supplier_id: sup,
                decided_at: (meta && meta.decided_at) ? meta.decided_at : now,
                decided_by: (meta && meta.decided_by) ? meta.decided_by : 'user'
            };
            projectAwardToSuppliers(item);
        }

        function setAwardWinnerForAllTiers(item, supplierName, meta) {
            ensureItemAwardShape(item);
            const keys = getQtyTierKeys(item);
            keys.forEach(k => setAwardWinnerForTier(item, k, supplierName, meta));
        }

        function projectAwardToSuppliers(item) {
            if (!item) return;
            ensureItemAwardShape(item);
            if (!Array.isArray(item.suppliers)) item.suppliers = [];

            const defaultTier = String(item.award.default_tier_key || 'qty_1');
            const winner = getAwardWinnerForTier(item, defaultTier);

            // reset main flags; keep feedback if user already set something and we have no winner
            item.suppliers.forEach(s => { s.isMain = false; });

            if (winner) {
                const norm = (v) => String(v || '').trim().toLowerCase();
                item.suppliers.forEach(s => {
                    const isW = norm(s && s.name) === norm(winner);
                    s.isMain = !!isW;
                    if (isW) {
                        s.feedback = 'won';
                        if (!s.status || s.status === 'Quote Received' || s.status === 'RFQ Sent' || s.status === 'Planned') s.status = 'Won';
                    } else {
                        const hasPrice = Object.keys(s || {}).some(k => /^price_\d+$/.test(k) && String(s[k] || '').trim() !== '');
                        if (hasPrice) {
                            s.feedback = 'lost';
                            if (s.status === 'Won') s.status = 'Lost';
                            if (!s.status) s.status = 'Lost';
                        }
                    }
                });

                // legacy
                item.supplier = winner;
                // When a supplier wins, item status becomes 'Done'
                const currentDisplayStatus = getItemStatusDisplay(item);
                if (!currentDisplayStatus || !['Done', 'Closed'].includes(currentDisplayStatus)) {
                    setItemStatus(item, 'Done');
                }
            }
        }

        // Helper functions for automatic status transitions with count
        function updateItemRFQSentStatus(item) {
            if (!item) return;
            // Count how many suppliers have RFQ Sent status
            const suppliers = Array.isArray(item.suppliers) ? item.suppliers : [];
            const sentCount = suppliers.filter(s => {
                const st = String(s.status || '');
                return st === 'RFQ Sent' || st.startsWith('RFQ Sent');
            }).length;

            if (sentCount > 0) {
                // Only update if not already in a "done" state
                const currentDisplayStatus = getItemStatusDisplay(item);
                if (!['Done', 'Won', 'Closed', 'OBSOLETE'].includes(currentDisplayStatus)) {
                    // Use status ID 4 (RFQ Sent) to be resilient to name changes
                    setItemStatusById(item, 4, sentCount);
                }
            }
        }

        // Set item status by ID (more reliable when status names are customized)
        function setItemStatusById(item, statusId, count = null) {
            if (!item) return;
            const statusObj = getStatusById('item', statusId);
            if (statusObj) {
                item.status_id = statusObj.id;
                item.status_count = count || null;
                item.status = count && count > 1 ? `${statusObj.name} (${count})` : statusObj.name;
            }
        }

        function updateItemQuoteStatus(item) {
            if (!item) return;
            // Count how many suppliers have quoted
            const suppliers = Array.isArray(item.suppliers) ? item.suppliers : [];
            const quotedCount = suppliers.filter(s => {
                const st = String(s.status || '');
                return st === 'Quoted' || st === 'Quote Received' || st === 'Won';
            }).length;

            if (quotedCount > 0) {
                // Only update if not already in a "done" state
                const currentDisplayStatus = getItemStatusDisplay(item);
                if (!['Done', 'Won', 'Closed', 'OBSOLETE'].includes(currentDisplayStatus)) {
                    // Use status ID 5 (Quote Received) to be resilient to name changes
                    setItemStatusById(item, 5, quotedCount);
                }
            }
        }

        function getSupplierWinsCountForItem(item, supplierName) {
            ensureItemAwardShape(item);
            const sup = String(supplierName || '').trim();
            if (!sup) return { wins: 0, total: 0 };
            const keys = getQtyTierKeys(item);
            let wins = 0;
            keys.forEach(k => { if (getAwardWinnerForTier(item, k) === sup) wins += 1; });
            return { wins, total: keys.length };
        }

        function setItemWinner(project, drawingNo, winnerSupplierName, options) {
            if (!project) return;
            const dn = String(drawingNo || '').trim();
            const winner = String(winnerSupplierName || '').trim();
            const item = getItemByDrawingNo(project, dn);
            if (!item || !winner) return;

            ensureItemAwardShape(item);

            if (!Array.isArray(item.suppliers)) item.suppliers = [];
            const norm = (v) => String(v || '').trim().toLowerCase();
            let wRec = item.suppliers.find(s => norm(s && s.name) === norm(winner));
            if (!wRec) {
                wRec = { name: winner, status: 'Quote Received' };
                item.suppliers.push(wRec);
            }

            const opt = options && typeof options === 'object' ? options : {};
            const tierIdx = opt.tierIdx ? (parseInt(opt.tierIdx, 10) || 0) : 0;
            const tierKey = tierIdx ? `qty_${tierIdx}` : String(item.award.default_tier_key || 'qty_1');

            if (opt.allTiers) {
                setAwardWinnerForAllTiers(item, winner, { decided_by: opt.decided_by || 'user' });
                // if there is no default tier selected, keep current as default
                if (!item.award.default_tier_key) item.award.default_tier_key = tierKey;
            } else {
                setAwardWinnerForTier(item, tierKey, winner, { decided_by: opt.decided_by || 'user' });
                // default tier can be explicitly set or inferred the first time
                if (opt.setDefaultTier || !item.award.default_tier_key) {
                    setAwardDefaultTier(item, tierKey);
                }
            }

            // keep legacy projections consistent
            try {
                const main = getSupplierRecordForItem(item, winner);
                if (main) {
                    if (main.currency) item.currency = main.currency;
                    if (main.incoterms) item.incoterms = main.incoterms;
                    if (main.price_1 !== undefined) item.price_1 = main.price_1;
                    if (main.price_2 !== undefined) item.price_2 = main.price_2;
                }
            } catch (e) { }
        }

        function renderQuotingCompare() {
            const st = getQuotingState();
            const panel = getEl('quoting-wizard-panel');
            if (!panel) return;

            if (!currentProject) {
                panel.innerHTML = '<div class="qt-workspace-empty"><div class="qt-big-icon">üìÅ</div><div class="qt-workspace-title">Select a project first</div></div>';
                return;
            }

            const items = Array.isArray(currentProject.items) ? currentProject.items : [];
            const dns = items.map(it => String(it.item_drawing_no || '').trim()).filter(Boolean).sort((a, b) => a.localeCompare(b));

            if (!st.compareDn && dns.length) st.compareDn = dns[0];
            const item = getItemByDrawingNo(currentProject, st.compareDn);

            // tiers are always driven by Item Quantities (qty_1..qty_N)
            const tiers = listQtyTiersFromItem(item);
            ensureItemAwardShape(item || {});

            // default tier (for reporting / main winner)
            const defaultTierKey = item && item.award ? String(item.award.default_tier_key || 'qty_1') : 'qty_1';
            const defaultTierIdx = parseInt(defaultTierKey.split('_')[1], 10) || 1;

            // selected tier for evaluation
            if (!st.compareTier) st.compareTier = defaultTierIdx;
            const tierIdx = parseInt(st.compareTier || 1, 10) || 1;
            const tierKey = `qty_${tierIdx}`;

            const suppliers = item && Array.isArray(item.suppliers) ? item.suppliers.slice() : [];
            suppliers.sort((a, b) => String(a.name || '').localeCompare(String(b.name || '')));

            const defaultTierLabel = (() => {
                const t = tiers.find(x => x.idx === defaultTierIdx);
                const q = t && t.qty ? String(t.qty) : '';
                return q ? `Q${defaultTierIdx}: ${q}` : `Q${defaultTierIdx}`;
            })();

            panel.innerHTML = `
                <div class="qt-compare-wrap">
                    <div class="qt-compare-header">
                        <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                            <div style="font-weight:800;">üìä Quote Comparison</div>
                            <span class="qt-pill gray">Project: ${escapeHtml(currentProject.name || '')}</span>
                            <span class="qt-pill gray">Default tier: ${escapeHtml(defaultTierLabel)}</span>
                        </div>
                        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                            <button class="btn-secondary" id="qt-compare-back" type="button">‚Üê Back</button>
                            <button class="btn-secondary" id="qt-compare-sync" type="button">Sync</button>
                        </div>
                    </div>

                    <div class="qt-compare-controls">
                        <div class="form-row">
                            <label>Item</label>
                            <select id="qt-compare-item" class="rfq-input">
                                ${dns.map(d => `<option value="${escapeHtml(d)}" ${d === st.compareDn ? 'selected' : ''}>${escapeHtml(d)}</option>`).join('')}
                            </select>
                        </div>

                        <div class="form-row">
                            <label>Qty tier (evaluate)</label>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <select id="qt-compare-tier" class="rfq-input" style="min-width:190px;">
                                    ${tiers.map(t => {
                const label = t.qty ? `Q${t.idx}: ${t.qty}` : `Q${t.idx}`;
                const isSel = t.idx === tierIdx;
                const isDef = t.idx === defaultTierIdx;
                return `<option value="${t.idx}" ${isSel ? 'selected' : ''}>${escapeHtml(label)}${isDef ? '  (default)' : ''}</option>`;
            }).join('')}
                                </select>
                                <button class="btn-secondary btn-mini" id="qt-compare-set-default" type="button">Set as default</button>
                            </div>
                        </div>

                        <div class="form-row" style="flex:1;">
                            <label>Description</label>
                            <input class="rfq-input" type="text" value="${escapeHtml(String((item && item.description) || ''))}" disabled>
                        </div>
                    </div>

                    <div class="qt-compare-body">
                        ${suppliers.length ? `
                        <table class="rfq-table qt-compare-table">
                            <thead>
                                <tr>
                                    <th>Supplier</th>
                                    <th>RFQ Bundles</th>
                                    <th>Tier winner</th>
                                    <th>Wins</th>
                                    <th>Status</th>
                                    <th>Currency</th>
                                    <th>Incoterms</th>
                                    <th>Lead time</th>
                                    <th>MOQ</th>
                                    <th>Price @ tier</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${suppliers.map(s => {
                const name = String(s.name || '').trim();
                const status = String(s.status || '').trim();
                const cur = String(s.currency || '').trim();
                const inc = String(s.incoterms || '').trim();
                const lt = String(s.lead_time || s.leadtime || '').trim();
                const moq = String(s.moq || '').trim();
                const pKey = `price_${tierIdx}`;
                const price = (s && s[pKey] !== undefined) ? s[pKey] : '';
                const priceTxt = (price === '' || price === null || typeof price === 'undefined') ? '' : String(price);

                const tierWinner = item ? getAwardWinnerForTier(item, tierKey) : '';
                const defWinner = item ? getAwardWinnerForTier(item, defaultTierKey) : '';
                const isTierWinner = tierWinner && String(tierWinner).trim() === name;
                const isDefaultWinner = defWinner && String(defWinner).trim() === name;

                const wins = item ? getSupplierWinsCountForItem(item, name) : { wins: 0, total: 0 };
                const winsTxt = wins.total ? `${wins.wins}/${wins.total}` : '';

                const badgeTier = isTierWinner ? '<span class="qt-badge ok">Winner</span>' : '';
                const badgeMain = isDefaultWinner ? '<span class="qt-badge warn">Main</span>' : '';

                // RFQ bundles related to this supplier + item
                let bundlesCell = '';
                try {
                    const rel = getProjectBatches(currentProject).filter(b => {
                        const bn = String(b && (b.supplier_name || b.supplier) || '').trim();
                        if (bn !== name) return false;
                        return (b.items || []).some(x => String(x && (x.drawing_no || x.item_drawing_no || '') || '').trim() === String(st.compareDn || '').trim());
                    }).sort((a, b) => String(b.created_at || '').localeCompare(String(a.created_at || '')));
                    if (rel.length) {
                        const firstId = String(rel[0].id || '').trim();
                        bundlesCell = `<button class="btn-secondary btn-mini" data-action="qt-open-bundle" data-batch-id="${escapeHtml(firstId)}" type="button">Open (${rel.length})</button>`;
                    } else {
                        bundlesCell = '<span class="muted">‚Äî</span>';
                    }
                } catch (e) { bundlesCell = '<span class="muted">‚Äî</span>'; }

                return `
                                        <tr class="${isDefaultWinner ? 'qt-row-main' : ''}">
                                            <td>${escapeHtml(name)} ${badgeMain}</td>
                                            <td>${bundlesCell}</td>
                                            <td>${badgeTier}</td>
                                            <td>${escapeHtml(winsTxt)}</td>
                                            <td>${escapeHtml(status)}</td>
                                            <td>${escapeHtml(cur)}</td>
                                            <td>${escapeHtml(inc)}</td>
                                            <td>${escapeHtml(lt)}</td>
                                            <td>${escapeHtml(moq)}</td>
                                            <td style="font-weight:700;">${escapeHtml(priceTxt)}</td>
                                            <td style="white-space:nowrap;">
                                                <button class="btn-primary btn-mini" data-action="qt-set-winner-tier" data-tier="${tierIdx}" data-dn="${encodeURIComponent(st.compareDn)}" data-supplier-enc="${encodeURIComponent(name)}" type="button">Win tier</button>
                                                <button class="btn-secondary btn-mini" data-action="qt-set-winner-all" data-dn="${encodeURIComponent(st.compareDn)}" data-supplier-enc="${encodeURIComponent(name)}" type="button">Win all</button>
                                            </td>
                                        </tr>
                                    `;
            }).join('')}
                            </tbody>
                        </table>
                        ` : `<div class="qt-empty" style="margin:14px;">No supplier quotes on this item yet.</div>`}
                    </div>
                </div>
            `;

            const btnBack = panel.querySelector('#qt-compare-back');
            if (btnBack) btnBack.onclick = () => { const s2 = getQuotingState(); s2.mode = 'home'; renderQuotingView(); };

            const btnSync = panel.querySelector('#qt-compare-sync');
            if (btnSync) btnSync.onclick = () => {
                if (!currentProject) return;
                try { syncAllBatchesToItems(currentProject); } catch (e) { }
                try { updateProject(currentProject); } catch (e) { }
                renderQuotingCompare();
            };

            const btnSetDefault = panel.querySelector('#qt-compare-set-default');
            if (btnSetDefault) btnSetDefault.onclick = () => {
                if (!currentProject) return;
                const it = getItemByDrawingNo(currentProject, st.compareDn);
                if (!it) return;
                setAwardDefaultTier(it, `qty_${tierIdx}`);
                try { updateProject(currentProject); } catch (e) { }
                renderQuotingCompare();
            };

            const selItem = panel.querySelector('#qt-compare-item');
            if (selItem) selItem.onchange = () => {
                const s2 = getQuotingState();
                s2.compareDn = String(selItem.value || '').trim();
                renderQuotingCompare();
            };

            const selTier = panel.querySelector('#qt-compare-tier');
            if (selTier) selTier.onchange = () => {
                const s2 = getQuotingState();
                s2.compareTier = parseInt(selTier.value || 1, 10) || 1;
                renderQuotingCompare();
            };
        }


        function setQuotingSupplier(name) {
            const st = getQuotingState();
            const keepWizard = (st.mode === 'create' && st.wizOpen);
            st.supplier = String(name || '').trim();
            st.batchId = '';
            if (!keepWizard) st.mode = st.supplier ? 'supplier' : 'home';
            renderQuotingView();
        }

        function setQuotingBatch(batchId) {
            const st = getQuotingState();
            st.batchId = String(batchId || '').trim();
            st.wizOpen = false;
            st.mode = st.batchId ? 'bundle' : (st.supplier ? 'supplier' : 'home');
            renderQuotingView();
        }


        // =========================================================
        // RFQ Bundle Detail (full page)
        // =========================================================
        window.__RFQ_BUNDLE_DETAIL__ = window.__RFQ_BUNDLE_DETAIL__ || { batchId: '', returnView: 'quoting', edit: null };

        function openBundleDetailPage(batchId, returnView = 'quoting') {
            const st = window.__RFQ_BUNDLE_DETAIL__ || { batchId: '', returnView: 'quoting', edit: null };
            st.batchId = String(batchId || '').trim();
            st.returnView = String(returnView || 'quoting').trim() || 'quoting';
            st.edit = null; // force reload
            window.__RFQ_BUNDLE_DETAIL__ = st;
            switchView('bundle-detail');
        }

        function bundleFindBatch(project, batchId) {
            if (!project || !batchId) return null;
            const batches = (window.RFQData && typeof window.RFQData.getRFQBatches === 'function') ? window.RFQData.getRFQBatches(project.id) : [];
            return (batches || []).find(b => String(b && b.id) === String(batchId)) || null;
        }

        function bundleDeepClone(obj) {
            try { return JSON.parse(JSON.stringify(obj)); } catch (e) { return obj ? { ...obj } : null; }
        }

        function bundleItemLookup(project) {
            const map = new Map();
            (project && Array.isArray(project.items) ? project.items : []).forEach(it => {
                const dn = String(it.item_drawing_no || '').trim();
                if (dn) map.set(dn, it);
            });
            return map;
        }

        function supplierRecForItem(item, supplierName) {
            const norm = (v) => String(v || '').trim().toLowerCase();
            const target = norm(supplierName);
            const list = (item && Array.isArray(item.suppliers)) ? item.suppliers : [];
            return list.find(s => norm(s && s.name) === target) || null;
        }

        function renderBundleDetailPage() {
            const st = clearlyGetBundleState();
            const content = (typeof bundleDetailPageContent !== 'undefined' && bundleDetailPageContent) ? bundleDetailPageContent : document.getElementById('bundle-detail-page-content');
            const titleEl = (typeof bundleDetailPageTitle !== 'undefined' && bundleDetailPageTitle) ? bundleDetailPageTitle : document.getElementById('bundle-detail-page-title');
            if (!content) return;

            if (!currentProject || !st.batchId) {
                if (titleEl) titleEl.textContent = 'RFQ Bundle';
                content.innerHTML = '<div class="main-card"><div class="muted">Select a project and open an RFQ bundle.</div></div>';
                return;
            }

            const batch = bundleFindBatch(currentProject, st.batchId);
            if (!batch) {
                if (titleEl) titleEl.textContent = 'RFQ Bundle';
                content.innerHTML = '<div class="main-card"><div class="muted">Bundle not found.</div></div>';
                return;
            }

            if (!st.edit) st.edit = bundleDeepClone(batch);
            const b = st.edit;

            const supplierName = String(b.supplier_name || b.supplier || '').trim();
            const created = b.created_at ? new Date(b.created_at).toLocaleString() : '';
            const updated = b.updated_at ? new Date(b.updated_at).toLocaleString() : '';
            const status = String(b.status || 'Draft').trim() || 'Draft';

            if (titleEl) titleEl.textContent = `RFQ Bundle ‚Äî ${supplierName || 'Supplier'}`;

            const itemsMap = bundleItemLookup(currentProject);

            // Build table rows
            const lines = Array.isArray(b.items) ? b.items : [];
            const rows = lines.map((ln, idx) => {
                const dn = String(ln.drawing_no || '').trim();
                const it = itemsMap.get(dn);
                const desc = it ? String(it.description || it.desc || '') : '';
                const mfr = it ? String(it.manufacturer || it.mfr || '') : '';
                const mpn = it ? String(it.mpn || it.part_no || '') : '';
                const supRec = it ? supplierRecForItem(it, supplierName) : null;

                const tiers = it ? getItemQtyTiers(it, { includeBlanks: false }) : [];
                const qtyKeys = (tiers && tiers.length) ? tiers.map(t => ({ k: `qty_${t.index}`, v: t.value })) : [{ k: 'qty_1', v: (it && (it.qty_1 ?? it.qty ?? '')) ?? '' }];

                const qtyCells = qtyKeys.map(t => `<div class="qt-mini">${escapeHtml(String(t.v || ''))}</div>`).join('');
                const pCells = qtyKeys.map(t => {
                    const pk = `price_${String(t.k).split('_')[1]}`;
                    const val = (ln && ln[pk] !== undefined) ? ln[pk] : '';
                    return `<input class="rfq-input qt-mini-input" data-bline="${idx}" data-field="${pk}" value="${escapeHtml(String(val ?? ''))}" placeholder="Price">`;
                }).join('');

                const moq = (ln && ln.moq !== undefined) ? ln.moq : (supRec ? (supRec.moq || '') : '');
                const mov = (ln && ln.mov !== undefined) ? ln.mov : (supRec ? (supRec.mov || '') : '');
                const lt = (ln && ln.lead_time_days !== undefined) ? ln.lead_time_days : (supRec ? (supRec.lead_time_days || supRec.lead_time || '') : '');
                const ship = (ln && ln.shipping_cost !== undefined) ? ln.shipping_cost : (supRec ? (supRec.shipping || supRec.shipping_cost || '') : '');
                const terms = (ln && ln.payment_terms !== undefined) ? ln.payment_terms : (supRec ? (supRec.payment_terms || supRec.terms || '') : '');

                const qStatus = String(ln.quote_status || 'Requested');

                return `
            <tr>
                <td><b>${escapeHtml(dn)}</b><div class="muted">${escapeHtml(mpn)}</div></td>
                <td>${escapeHtml(desc)}</td>
                <td style="white-space:nowrap;">${qtyCells}</td>
                <td>${escapeHtml(mfr)}</td>
                <td style="min-width:200px;">
                    <div class="qt-grid-qty">${pCells}</div>
                    <div class="qt-line-meta">
                        <span class="qt-mini-label">Status</span>
                        <select class="rfq-input qt-mini-input" data-bline="${idx}" data-field="quote_status">
                            ${['Requested', 'Quoted', 'No Bid', 'Need Info'].map(s => `<option value="${escapeHtml(s)}" ${s === qStatus ? 'selected' : ''}>${escapeHtml(s)}</option>`).join('')}
                        </select>
                        <span class="qt-mini-label">MOQ</span>
                        <input class="rfq-input qt-mini-input" data-bline="${idx}" data-field="moq" value="${escapeHtml(String(moq ?? ''))}" style="width:90px;">
                        <span class="qt-mini-label">MOV</span>
                        <input class="rfq-input qt-mini-input" data-bline="${idx}" data-field="mov" value="${escapeHtml(String(mov ?? ''))}" style="width:90px;">
                        <span class="qt-mini-label">LT</span>
                        <input class="rfq-input qt-mini-input" data-bline="${idx}" data-field="lead_time_days" value="${escapeHtml(String(lt ?? ''))}" style="width:90px;" placeholder="days">
                        <span class="qt-mini-label">Ship</span>
                        <input class="rfq-input qt-mini-input" data-bline="${idx}" data-field="shipping_cost" value="${escapeHtml(String(ship ?? ''))}" style="width:120px;">
                        <span class="qt-mini-label">Terms</span>
                        <input class="rfq-input qt-mini-input" data-bline="${idx}" data-field="payment_terms" value="${escapeHtml(String(terms ?? ''))}" style="width:160px;">
                    </div>
                </td>
            </tr>
        `;
            }).join('');

            content.innerHTML = `
        <div class="main-card">
            <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;">
                <div>
                    <div style="font-weight:800; font-size:16px;">${escapeHtml(currentProject.name || '')}</div>
                    <div class="muted" style="margin-top:4px;">Created: ${escapeHtml(created)}${updated ? ' ‚Ä¢ Updated: ' + escapeHtml(updated) : ''}</div>
                </div>
                <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                    <div class="form-row" style="min-width:220px;">
                        <label>Status</label>
                        <select id="bd-status" class="rfq-input">
                            ${getBatchStatuses().map(s => `<option value="${escapeHtml(s)}" ${s === status ? 'selected' : ''}>${escapeHtml(s)}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-row" style="min-width:160px;">
                        <label>Due date</label>
                        <input id="bd-due" type="date" class="rfq-input" value="${escapeHtml(String(b.due_date || ''))}">
                    </div>
                    <div class="form-row" style="min-width:120px;">
                        <label>Rev</label>
                        <input id="bd-rev" type="text" class="rfq-input" value="${escapeHtml(String(b.revision || ''))}">
                    </div>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                <div class="form-row">
                    <label>Currency</label>
                    <input id="bd-currency" type="text" class="rfq-input" value="${escapeHtml(String(b.currency || ''))}">
                </div>
                <div class="form-row">
                    <label>Incoterms</label>
                    <input id="bd-incoterms" type="text" class="rfq-input" value="${escapeHtml(String(b.incoterms || ''))}">
                </div>
                <div class="form-row">
                    <label>Contact</label>
                    <input id="bd-contact" type="text" class="rfq-input" value="${escapeHtml(String(b.contact_person || ''))}">
                </div>
                <div class="form-row">
                    <label>Email</label>
                    <input id="bd-email" type="text" class="rfq-input" value="${escapeHtml(String(b.contact_email || ''))}">
                </div>
                <div class="form-row" style="grid-column: 1 / -1;">
                    <label>Notes</label>
                    <textarea id="bd-notes" class="rfq-input" style="height:60px; resize:vertical;">${escapeHtml(String(b.notes || ''))}</textarea>
                </div>
            </div>
        </div>

        <div class="main-card" style="margin-top: 12px;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                <div style="font-weight:800;">Items</div>
                <div class="muted">${lines.length} lines</div>
            </div>

            <div class="table-wrapper" style="margin-top: 10px;">
                <table class="rfq-table">
                    <thead>
                        <tr>
                            <th style="width:160px;">Item</th>
                            <th>Description</th>
                            <th style="width:140px;">Qty tiers</th>
                            <th style="width:120px;">Mfr</th>
                            <th>Quote (tiers + extras)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows || `<tr><td colspan="5" style="padding:14px; color:#999; text-align:center;">No items in bundle</td></tr>`}
                    </tbody>
                </table>
            </div>
        </div>
    `;

            // Bind controls
            if (btnBundleDetailBack) btnBundleDetailBack.onclick = () => {
                const s = clearlyGetBundleState();
                if ((s.returnView || '') === 'quote-compare') { switchView('quote-compare'); return; }
                switchView(s.returnView || 'quoting');
            };

            if (btnBundleDetailExport) btnBundleDetailExport.onclick = () => {
                try { exportBatchCSV(b); } catch (e) { showToast('Export failed: ' + (e && e.message ? e.message : String(e)), 'error'); }
            };

            if (btnBundleDetailDelete) btnBundleDetailDelete.onclick = async () => {
                const confirmed = await window.showConfirmDialog({
                    title: 'Delete RFQ Bundle',
                    message: 'Delete this RFQ bundle?',
                    type: 'danger',
                    okText: 'Delete',
                    cancelText: 'Cancel'
                });
                if (!confirmed) return;
                try {
                    if (window.RFQData && typeof window.RFQData.deleteRFQBatch === 'function') {
                        window.RFQData.deleteRFQBatch(currentProject.id, b.id);
                        syncProjectBatchesIntoMemory(currentProject);
                        updateProject(currentProject);
                    }
                } catch (e) { }
                switchView(st.returnView || 'quoting');
                try { renderQuotingView(); } catch (e) { }
            };

            if (btnBundleDetailSave) btnBundleDetailSave.onclick = () => {
                try {
                    // Header fields
                    const getVal = (id) => {
                        const el = document.getElementById(id);
                        return el ? el.value : '';
                    };
                    b.status = getVal('bd-status') || b.status || 'Draft';
                    b.due_date = getVal('bd-due') || '';
                    b.revision = getVal('bd-rev') || '';
                    b.currency = getVal('bd-currency') || '';
                    b.incoterms = getVal('bd-incoterms') || '';
                    b.contact_person = getVal('bd-contact') || '';
                    b.contact_email = getVal('bd-email') || '';
                    const notesEl = document.getElementById('bd-notes');
                    b.notes = notesEl ? notesEl.value : (b.notes || '');

                    // Line edits (already stored in st.edit by delegation below)

                    const saved = (window.RFQData && typeof window.RFQData.saveRFQBatch === 'function') ? window.RFQData.saveRFQBatch(currentProject.id, b) : b;

                    // Sync into item suppliers/pricing
                    try {
                        const mode = (String(saved.status || '') === 'Sent') ? 'sent' : (String(saved.status || '') === 'Quote Received' ? 'received' : 'save');
                        applyBatchToItems(currentProject, saved, mode);
                    } catch (e) { }

                    syncProjectBatchesIntoMemory(currentProject);
                    updateProject(currentProject);

                    showSuccessModal({
                        title: 'Quote Saved',
                        message: 'Quote data has been saved successfully.',
                        icon: 'üíæ',
                        iconColor: '#10b981',
                        details: [
                            { label: 'Supplier', value: saved.supplier || '-' },
                            { label: 'Items', value: (saved.items || []).length },
                            { label: 'Status', value: saved.status || '-' }
                        ]
                    });
                    // refresh edit copy from latest
                    st.edit = bundleDeepClone(saved);
                    renderBundleDetailPage();
                } catch (e) {
                    console.error(e);
                    showToast('Save failed: ' + (e && e.message ? e.message : String(e)), 'error');
                }
            };

            // Delegated line editing
            content.querySelectorAll('[data-bline][data-field]').forEach(el => {
                el.onchange = () => {
                    try {
                        const idx = parseInt(el.getAttribute('data-bline') || '0', 10) || 0;
                        const field = String(el.getAttribute('data-field') || '');
                        if (!field) return;
                        if (!Array.isArray(b.items)) b.items = [];
                        if (!b.items[idx]) return;
                        b.items[idx][field] = el.value;
                    } catch (e) { }
                };
            });
        }


        function renderQuoteComparePage() {
            const content = document.getElementById('quote-compare-page-content');
            if (!content) return;

            if (!currentProject) {
                content.innerHTML = '<div class="main-card"><div class="muted">Select a project to use Quote Comparison.</div></div>';
                return;
            }

            // Back button
            try {
                const btnBack = document.getElementById('btn-quote-compare-back');
                if (btnBack) btnBack.onclick = () => { switchView('quoting'); };
            } catch (e) { }

            const itemsRaw = Array.isArray(currentProject.items) ? currentProject.items : (currentProject.data && Array.isArray(currentProject.data.items) ? currentProject.data.items : []);
            if (!itemsRaw.length) {
                content.innerHTML = '<div class="main-card"><div class="muted">No items in this project.</div></div>';
                return;
            }

            const getItemKeyLocal = (it, idx) => {
                const k = String(
                    it.item_drawing_no ||
                    it.drawing_no ||
                    it.part_no ||
                    it.part_number ||
                    it.item_no ||
                    it.mpn ||
                    it.id ||
                    ''
                ).trim();
                return k || ('row_' + idx);
            };

            const items = itemsRaw.map((it, idx) => ({
                _idx: idx,
                key: getItemKeyLocal(it, idx),
                dn: String(it.item_drawing_no || it.drawing_no || it.part_no || it.part_number || it.item_no || it.mpn || '').trim() || ('row_' + (idx + 1)),
                description: String(it.description || it.desc || '').trim(),
                _raw: it
            }));

            // Selected DN + tier state (stored)
            const stKeyDn = 'rfq_qc_dn';
            const stKeyTier = 'rfq_qc_tier';
            let selDn = String(localStorage.getItem(stKeyDn) || '').trim();
            if (!selDn || !items.some(x => x.dn === selDn)) selDn = items[0].dn;

            // Determine tiers from selected item
            const selItem = items.find(x => x.dn === selDn) || items[0];
            const tiers = getItemQtyTiers(selItem._raw, { includeBlanks: false }) || [];
            const tierKeys = (tiers && tiers.length) ? tiers.map(t => String(t.k || t.key || '').trim()).filter(Boolean) : ['qty_1'];
            let selTier = String(localStorage.getItem(stKeyTier) || '').trim();
            if (!selTier || !tierKeys.includes(selTier)) selTier = tierKeys[0];

            // Suppliers list: prefer master list
            const master = Array.isArray(currentProject.supplierMaster) ? currentProject.supplierMaster : [];
            let suppliers = master.map(s => String(s.name || s.supplier || '').trim()).filter(Boolean);
            if (!suppliers.length) {
                // fallback: infer from item supplier pricing
                const set = new Set();
                itemsRaw.forEach(it => {
                    (it && Array.isArray(it.suppliers) ? it.suppliers : []).forEach(s => {
                        const nm = String(s && (s.name || s.supplier || s.supplier_name || '')).trim();
                        if (nm) set.add(nm);
                    });
                });
                suppliers = Array.from(set);
            }
            suppliers.sort((a, b) => a.localeCompare(b));

            const batches = Array.isArray(currentProject.rfqBatches) ? currentProject.rfqBatches : (Array.isArray(currentProject.rfq_batches) ? currentProject.rfq_batches : []);

            const readLinePrice = (ln, tierKey) => {
                // tierKey like qty_1 => price_1
                const idx = String(tierKey).split('_')[1] || '1';
                const pk = 'price_' + idx;
                return (ln && ln[pk] !== undefined) ? ln[pk] : '';
            };

            const rows = suppliers.map(supplierName => {
                const related = batches.filter(b => norm(String(b && (b.supplier || b.supplier_name || b.name || ''))) === norm(supplierName));
                const relatedWithLine = related.map(b => {
                    const lines = Array.isArray(b.lines) ? b.lines : [];
                    const ln = lines.find(x => norm(String(x && (x.drawing_no || x.item_drawing_no || x.part_no || x.mpn || ''))) === norm(selDn));
                    return { b, ln };
                }).filter(x => !!x.ln);

                // Best price across batches for this supplier
                let best = null;
                relatedWithLine.forEach(({ b, ln }) => {
                    const p = readLinePrice(ln, selTier);
                    const pn = Number(String(p).replace(',', '.'));
                    if (!isNaN(pn) && pn > 0) {
                        if (!best || pn < best.pn) best = { pn, p, b, ln };
                    }
                });

                // Use last batch info for meta
                const last = relatedWithLine.length ? relatedWithLine[relatedWithLine.length - 1] : null;
                const ln = best ? best.ln : (last ? last.ln : null);
                const b = best ? best.b : (last ? last.b : null);

                const status = ln ? String(ln.quote_status || ln.status || 'Requested') : '‚Äî';
                const moq = ln ? (ln.moq ?? '') : '';
                const lt = ln ? (ln.lead_time_days ?? ln.lead_time ?? '') : '';
                const curr = b ? String(b.currency || '') : '';
                const price = best ? best.p : (ln ? readLinePrice(ln, selTier) : '');

                const batchId = b ? String(b.id || b.batchId || b.batch_id || '') : '';
                const open = batchId ? `<button class="btn-secondary qc-open-bundle" data-bid="${escapeHtml(batchId)}" type="button">Open bundle</button>` : '';

                return `
            <tr>
                <td><b>${escapeHtml(supplierName)}</b><div class="muted">${escapeHtml(batchId ? ('Bundle: ' + batchId) : '')}</div></td>
                <td>${escapeHtml(String(status))}</td>
                <td>${escapeHtml(String(moq))}</td>
                <td>${escapeHtml(String(lt))}</td>
                <td><b>${escapeHtml(String(price))}</b></td>
                <td>${escapeHtml(String(curr))}</td>
                <td>${open}</td>
            </tr>
        `;
            }).join('');

            content.innerHTML = `
        <div class="main-card">
            <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;">
                <div>
                    <div style="font-weight:800;">üìä Quote Comparison</div>
                    <div class="muted" style="margin-top:4px;">Project: ${escapeHtml(String(currentProject.name || ''))}</div>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <button class="btn-secondary" id="qc-sync" type="button">Sync</button>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 220px; gap: 12px; margin-top: 12px;">
                <div class="form-row">
                    <label>Item</label>
                    <select id="qc-item" class="rfq-input">
                        ${items.map(it => `<option value="${escapeHtml(it.dn)}" ${it.dn === selDn ? 'selected' : ''}>${escapeHtml(it.dn)}${it.description ? (' ‚Äî ' + escapeHtml(it.description.slice(0, 60))) : ''}</option>`).join('')}
                    </select>
                </div>
                <div class="form-row">
                    <label>Qty tier</label>
                    <select id="qc-tier" class="rfq-input">
                        ${tierKeys.map(k => `<option value="${escapeHtml(k)}" ${k === selTier ? 'selected' : ''}>${escapeHtml(k.replace('qty_', 'Q'))}</option>`).join('')}
                    </select>
                </div>
            </div>

            <div style="margin-top:12px; overflow:auto; border:1px solid rgba(0,0,0,.08); border-radius:12px; background:#fff;">
                <table class="rfq-table" style="width:100%; background:#fff;">
                    <thead>
                        <tr>
                            <th>Supplier</th>
                            <th style="width:120px;">Status</th>
                            <th style="width:90px;">MOQ</th>
                            <th style="width:90px;">LT</th>
                            <th style="width:120px;">Price</th>
                            <th style="width:90px;">Curr</th>
                            <th style="width:140px;">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows || `<tr><td colspan="7" class="muted" style="padding:14px;">No supplier quotes found for this item.</td></tr>`}
                    </tbody>
                </table>
            </div>
        </div>
    `;

            const elItem = document.getElementById('qc-item');
            const elTier = document.getElementById('qc-tier');
            if (elItem) elItem.onchange = () => {
                localStorage.setItem(stKeyDn, String(elItem.value || '').trim());
                renderQuoteComparePage();
            };
            if (elTier) elTier.onchange = () => {
                localStorage.setItem(stKeyTier, String(elTier.value || '').trim());
                renderQuoteComparePage();
            };

            const btnSync = document.getElementById('qc-sync');
            if (btnSync) btnSync.onclick = () => { try { syncToServerThrottled(); } catch (e) { } };

            // open bundle
            content.querySelectorAll('.qc-open-bundle').forEach(btn => {
                btn.onclick = () => {
                    const bid = btn.getAttribute('data-bid') || '';
                    if (!bid) return;
                    const st = clearlyGetBundleState();
                    st.batchId = bid;
                    st.returnView = 'quote-compare';
                    switchView('bundle-detail');
                };
            });
        }


        function clearlyGetBundleState() {
            window.__RFQ_BUNDLE_DETAIL__ = window.__RFQ_BUNDLE_DETAIL__ || { batchId: '', returnView: 'quoting', edit: null };
            const st = window.__RFQ_BUNDLE_DETAIL__;
            st.batchId = String(st.batchId || '').trim();
            st.returnView = String(st.returnView || 'quoting').trim() || 'quoting';
            return st;
        }

        function deriveAllSupplierNamesForProject(project) {
            if (!project) return [];
            ensureProjectSuppliers(project);
            const set = new Set();

            (project.supplierMaster || []).forEach(sm => {
                const n = String(sm && sm.name || '').trim();
                if (n) set.add(n);
            });

            (project.items || []).forEach(it => {
                const main = String(it.supplier || '').trim();
                if (main) set.add(main);
                (it.suppliers || []).forEach(s => {
                    const n = String(s && s.name || '').trim();
                    if (n) set.add(n);
                });
            });

            getProjectBatches(project).forEach(b => {
                const n = String(b && (b.supplier_name || b.supplier) || '').trim();
                if (n) set.add(n);
            });

            return Array.from(set).sort((a, b) => a.localeCompare(b));
        }

        function normalizeSupplierKey(val) {
            return String(val || '').trim().toLowerCase();
        }

        function buildSupplierMasterMaps(project) {
            const idToName = {};
            const nameToId = {};
            try {
                (project && project.supplierMaster || []).forEach(sm => {
                    const id = String(sm && (sm.master_id || sm.id || sm.code) || '').trim();
                    const name = String(sm && sm.name || '').trim();
                    if (id && name) {
                        idToName[id] = name;
                        nameToId[normalizeSupplierKey(name)] = id;
                    } else if (name) {
                        nameToId[normalizeSupplierKey(name)] = id || '';
                    }
                });
            } catch (e) { }
            return { idToName, nameToId };
        }

        function resolveSupplierName(project, supplierRec) {
            if (!supplierRec) return '';
            const n = String(supplierRec.name || supplierRec.supplier_name || '').trim();
            if (n) return n;
            const id = String(supplierRec.master_id || supplierRec.id || '').trim();
            if (!id) return '';
            try {
                const maps = buildSupplierMasterMaps(project);
                return String(maps.idToName[id] || '').trim();
            } catch (e) { return ''; }
        }

        function ensureProjectSupplierLinks(project) {
            if (!project) return;
            try { ensureProjectSuppliers(project); } catch (e) { }
            const maps = buildSupplierMasterMaps(project);
            // Fill missing supplier names in items.suppliers from master_id mapping (non-destructive)
            (project.items || []).forEach(it => {
                if (!it) return;
                if (!Array.isArray(it.suppliers)) it.suppliers = [];
                (it.suppliers || []).forEach(s => {
                    if (!s) return;
                    const hasName = String(s.name || '').trim();
                    if (hasName) return;
                    const id = String(s.master_id || s.id || '').trim();
                    if (id && maps.idToName[id]) s.name = maps.idToName[id];
                });
            });
        }

        function supplierRecMatches(project, supplierRec, supplierName) {
            const target = normalizeSupplierKey(supplierName);
            if (!target) return false;
            if (!supplierRec) return false;
            const recName = normalizeSupplierKey(resolveSupplierName(project, supplierRec) || supplierRec.name || '');
            if (recName && recName === target) return true;

            // If supplierName corresponds to a master_id, compare master_id as well
            try {
                const maps = buildSupplierMasterMaps(project);
                const targetId = maps.nameToId[target] || '';
                const recId = String(supplierRec.master_id || supplierRec.id || '').trim();
                if (targetId && recId && targetId === recId) return true;
            } catch (e) { }
            return false;
        }



        function getSupplierStats(project, supplierName) {
            const name = String(supplierName || '').trim();
            const norm = (v) => String(v || '').trim().toLowerCase();

            const itemsAll = project && Array.isArray(project.items) ? project.items : [];
            const batches = getProjectBatches(project);

            let targets = 0;
            let planned = 0;
            let rfqSent = 0;
            let quoteReceived = 0;

            itemsAll.forEach(it => {
                const sList = Array.isArray(it.suppliers) ? it.suppliers : [];
                const sup = sList.find(s => supplierRecMatches(project, s, name));
                if (sup) {
                    targets += 1;
                    const st = String(sup.status || '').trim();
                    if (st === 'Planned') planned += 1;
                    if (st === 'RFQ Sent') rfqSent += 1;
                    if (st === 'Quote Received') quoteReceived += 1;
                } else if (norm(it.supplier) === norm(name)) {
                    targets += 1;
                }
            });

            let bundleCount = 0;
            let openBundles = 0;
            batches.forEach(b => {
                const bn = String(b && (b.supplier_name || b.supplier) || '').trim();
                if (norm(bn) !== norm(name)) return;
                bundleCount += 1;
                const st = String(b.status || 'Draft').trim();
                if (!['Closed', 'Zru≈°itled'].includes(st)) openBundles += 1;
            });

            return { targets, planned, rfqSent, quoteReceived, bundleCount, openBundles };
        }

        function renderQuotingSuppliersPanel() {
            const st = getQuotingState();
            const proj = currentProject;

            const listContainer = getEl('quoting-suppliers-list');
            const countEl = getEl('qt-suppliers-count');
            const btnDetail = getEl('btn-qt-supplier-detail');
            const searchInput = getEl('qt-supplier-filter');

            if (!listContainer || !proj) {
                if (listContainer) listContainer.innerHTML = '<div class="quoting-empty-state"><div class="quoting-empty-icon">üìã</div><div class="quoting-empty-title">No Project Selected</div><div class="quoting-empty-text">Select a project to view suppliers</div></div>';
                if (countEl) countEl.textContent = '0';
                if (btnDetail) btnDetail.disabled = true;
                return;
            }

            const suppliers = (getProjectSuppliers(proj) || []).slice();
            suppliers.sort((a, b) => String((a.name || a.supplier_name || a.supplier || '')).localeCompare(String((b.name || b.supplier_name || b.supplier || ''))));

            const batches = (getProjectBatches(proj) || []).slice();
            const statsBySup = Object.create(null);

            for (const b of batches) {
                const sup = String((b.supplier_name || b.supplier || b.supplierName || '')).trim();
                if (!sup) continue;
                const key = sup.toLowerCase();
                if (!statsBySup[key]) statsBySup[key] = { total: 0, open: 0, received: 0, sent: 0 };
                statsBySup[key].total += 1;
                const s = String((b.status || b.batch_status || '')).toLowerCase();
                if (s.includes('quote') || s.includes('received')) statsBySup[key].received += 1;
                if (s.includes('sent') || s.includes('rfq')) statsBySup[key].sent += 1;
                if (s.includes('draft') || s.includes('new') || s.includes('pending') || s === '') statsBySup[key].open += 1;
            }

            // Filter by search
            const searchQ = (searchInput ? searchInput.value : '').toLowerCase().trim();
            const filteredSuppliers = suppliers.filter(supObj => {
                const name = String((supObj.name || supObj.supplier_name || supObj.supplier || '')).trim();
                return !searchQ || name.toLowerCase().includes(searchQ);
            });

            // Render supplier cards
            const cardsHtml = filteredSuppliers.map((supObj) => {
                const name = String((supObj.name || supObj.supplier_name || supObj.supplier || '')).trim();
                const key = name.toLowerCase();
                const stats = statsBySup[key] || { total: 0, open: 0, received: 0, sent: 0 };

                let targets = 0;
                if (Array.isArray(supObj.targets)) targets = supObj.targets.length;
                else if (Array.isArray(supObj.target_items)) targets = supObj.target_items.length;
                else if (Array.isArray(supObj.items)) targets = supObj.items.length;
                else if (Number.isFinite(supObj.targetsCount)) targets = supObj.targetsCount;

                const isActive = st.supplier && String(st.supplier).toLowerCase() === key;
                return `
            <div class="quoting-supplier-card ${isActive ? 'active' : ''}" data-action="qt-select-supplier" data-supplier-name="${escapeHtml(name)}" tabindex="0">
                <div class="quoting-supplier-name">${escapeHtml(name)}</div>
                <div class="quoting-supplier-stats">
                    <span class="quoting-supplier-stat"><span class="quoting-supplier-stat-icon">üéØ</span> ${targets} items</span>
                    <span class="quoting-supplier-stat"><span class="quoting-supplier-stat-icon">üì¶</span> ${stats.total} bundles</span>
                    <span class="quoting-supplier-stat"><span class="quoting-supplier-stat-icon">üì•</span> ${stats.received} quotes</span>
                </div>
            </div>
        `;
            }).join('');

            if (filteredSuppliers.length === 0) {
                listContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #888; font-size: 12px;">No suppliers found</div>';
            } else {
                listContainer.innerHTML = cardsHtml;
            }

            if (btnDetail) btnDetail.disabled = !st.supplier;
            if (countEl) countEl.textContent = String(filteredSuppliers.length);
        }

        function renderQuotingBundlesPanel() {
            const st = getQuotingState();
            const proj = currentProject;

            // Get Kanban columns
            const kanbanDraft = getEl('qt-kanban-draft');
            const kanbanSent = getEl('qt-kanban-sent');
            const kanbanReceived = getEl('qt-kanban-received');
            const kanbanDone = getEl('qt-kanban-done');

            // Get stats elements
            const statTotal = getEl('qt-stat-total');
            const statSent = getEl('qt-stat-sent');
            const statReceived = getEl('qt-stat-received');
            const statDone = getEl('qt-stat-done');

            // Get count elements
            const countDraft = getEl('qt-kanban-draft-count');
            const countSent = getEl('qt-kanban-sent-count');
            const countReceived = getEl('qt-kanban-received-count');
            const countDone = getEl('qt-kanban-done-count');

            if (!proj) {
                [kanbanDraft, kanbanSent, kanbanReceived, kanbanDone].forEach(el => {
                    if (el) el.innerHTML = '';
                });
                [statTotal, statSent, statReceived, statDone, countDraft, countSent, countReceived, countDone].forEach(el => {
                    if (el) el.textContent = '0';
                });
                return;
            }

            let batches = (getProjectBatches(proj) || []).slice();

            // Filter by selected supplier
            const wantedSup = st.supplier ? String(st.supplier).toLowerCase() : '';
            if (wantedSup) {
                batches = batches.filter(b => {
                    const sup = String((b.supplier_name || b.supplier || b.supplierName || '')).toLowerCase();
                    return sup === wantedSup;
                });
            }

            // Filter by search and status
            const searchQ = (getEl('qt-bundle-filter')?.value || '').toLowerCase().trim();
            const statusFilter = (getEl('qt-bundle-status-filter')?.value || '').trim();

            batches = batches.filter(b => {
                if (statusFilter && String((b.status || b.batch_status || 'Draft')).trim() !== statusFilter) return false;
                if (searchQ) {
                    const sup = String((b.supplier_name || b.supplier || b.supplierName || '')).toLowerCase();
                    const id = String(b.id || '').toLowerCase();
                    if (!sup.includes(searchQ) && !id.includes(searchQ)) return false;
                }
                return true;
            });

            // Sort newest first
            batches.sort((a, b) => {
                const da = new Date(a.created_at || a.created || a.date || 0).getTime() || 0;
                const db = new Date(b.created_at || b.created || b.date || 0).getTime() || 0;
                return db - da;
            });

            // Categorize bundles by status
            const draft = [], sent = [], received = [], done = [];

            batches.forEach(batch => {
                const status = String((batch.status || batch.batch_status || 'Draft')).trim().toLowerCase();
                if (status.includes('done') || status.includes('closed') || status.includes('won') || status.includes('completed')) {
                    done.push(batch);
                } else if (status.includes('received') || status.includes('quote')) {
                    received.push(batch);
                } else if (status.includes('sent') || status.includes('rfq')) {
                    sent.push(batch);
                } else {
                    draft.push(batch);
                }
            });

            // Render bundle card
            function renderBundleCard(batch) {
                const id = batch.id || batch.batch_id || batch.pk || '';
                const created = batch.created_at || batch.created || batch.date || '';
                const dateStr = created ? new Date(created).toLocaleDateString() : '';
                const sup = String((batch.supplier_name || batch.supplier || batch.supplierName || '')).trim();
                const itemCount = Array.isArray(batch.items) ? batch.items.length : (Number.isFinite(batch.item_count) ? batch.item_count : 0);
                const due = batch.due_date ? new Date(batch.due_date).toLocaleDateString() : '';

                return `
            <div class="quoting-bundle-card" data-action="qt-open-bundle" data-batch-id="${escapeHtml(String(id))}" tabindex="0">
                <div class="quoting-bundle-supplier">${escapeHtml(sup || 'Unknown')}</div>
                <div class="quoting-bundle-meta">
                    <span>${dateStr}</span>
                    <span class="quoting-bundle-items">${itemCount} items</span>
                </div>
                ${due ? `<div style="font-size: 10px; color: #888; margin-top: 6px;">Due: ${due}</div>` : ''}
            </div>
        `;
            }

            // Render each column
            if (kanbanDraft) kanbanDraft.innerHTML = draft.map(renderBundleCard).join('') || '<div style="text-align:center; color:#888; font-size:11px; padding:20px;">No drafts</div>';
            if (kanbanSent) kanbanSent.innerHTML = sent.map(renderBundleCard).join('') || '<div style="text-align:center; color:#888; font-size:11px; padding:20px;">No RFQs sent</div>';
            if (kanbanReceived) kanbanReceived.innerHTML = received.map(renderBundleCard).join('') || '<div style="text-align:center; color:#888; font-size:11px; padding:20px;">No quotes</div>';
            if (kanbanDone) kanbanDone.innerHTML = done.map(renderBundleCard).join('') || '<div style="text-align:center; color:#888; font-size:11px; padding:20px;">No completed</div>';

            // Update counts
            if (countDraft) countDraft.textContent = String(draft.length);
            if (countSent) countSent.textContent = String(sent.length);
            if (countReceived) countReceived.textContent = String(received.length);
            if (countDone) countDone.textContent = String(done.length);

            // Update stats
            if (statTotal) statTotal.textContent = String(batches.length);
            if (statSent) statSent.textContent = String(sent.length);
            if (statReceived) statReceived.textContent = String(received.length);
            if (statDone) statDone.textContent = String(done.length);
        }

        function bindQuotingCockpitOnce() {
            if (window.__RFQ_QUOTING_COCKPIT_BOUND__) return;
            window.__RFQ_QUOTING_COCKPIT_BOUND__ = true;

            function updateShownCount(tableId, outId) {
                const tbl = getEl(tableId);
                const out = getEl(outId);
                if (!tbl || !out) return;
                const tbody = tbl.querySelector('tbody');
                if (!tbody) return;
                const shown = Array.from(tbody.querySelectorAll('tr')).filter(r => r.dataset.utFiltered !== '1').length;
                out.textContent = String(shown);
            }

            function applyBundleStatusToHeaderFilter() {
                const statusSel = getEl('qt-bundle-status-filter');
                const tbl = getEl('qt-bundles-table');
                if (!statusSel || !tbl) return;
                const inp = tbl.querySelector('.ut-filter-row input[data-col-id="qc_status"]');
                if (inp) inp.value = statusSel.value || '';
            }

            const btnNew = getEl('btn-new-rfq-batch');
            if (btnNew) btnNew.addEventListener('click', () => {
                const st = getQuotingState();
                startRFQWizard(st.supplier || null);
            });

            const btnCompare = getEl('btn-qt-compare');
            if (btnCompare) btnCompare.addEventListener('click', () => {
                switchView('quote-compare');
            });

            const btnSync = getEl('btn-qt-sync');
            if (btnSync) btnSync.addEventListener('click', () => {
                syncAllBatchesToItems();
            });

            const btnSupplierDetail = getEl('btn-qt-supplier-detail');
            if (btnSupplierDetail) btnSupplierDetail.addEventListener('click', () => {
                const st = getQuotingState();
                if (!st.supplier) return;
                switchView('supplier-detail');
                openSupplierDetail(st.supplier);
            });

            const supSearch = getEl('qt-supplier-filter');
            if (supSearch) supSearch.addEventListener('input', () => {
                // Re-render supplier cards with filter applied
                try { renderQuotingSuppliersPanel(); } catch (e) { }
            });

            const bundleSearch = getEl('qt-bundle-filter');
            if (bundleSearch) bundleSearch.addEventListener('input', () => {
                // Re-render Kanban with filter applied
                try { renderQuotingBundlesPanel(); } catch (e) { }
            });

            const statusSel = getEl('qt-bundle-status-filter');
            if (statusSel) statusSel.addEventListener('change', () => {
                // Re-render Kanban with status filter applied
                try { renderQuotingBundlesPanel(); } catch (e) { }
            });

            // Row actions (delegation)
            document.addEventListener('click', function (ev) {
                const el = ev.target && ev.target.closest ? ev.target.closest('[data-action]') : null;
                if (!el) return;
                const action = el.dataset.action;

                if (action === 'qt-select-supplier') {
                    const name = el.dataset.supplierName || '';
                    const st = getQuotingState();
                    st.supplier = name || null;
                    st.mode = st.mode || 'cockpit';
                    saveQuotingState(st);
                    renderQuotingView();
                    return;
                }

                if (action === 'qt-clear-supplier') {
                    const st = getQuotingState();
                    st.supplier = null;
                    saveQuotingState(st);
                    renderQuotingView();
                    return;
                }

                if (action === 'qt-open-bundle') {
                    const id = el.dataset.batchId;
                    if (!id) return;
                    openBundleDetailPage(id, 'quoting');
                    return;
                }
            }, true);

            // Keyboard: Enter on qc rows should behave like click
            document.addEventListener('keydown', function (ev) {
                if (ev.key !== 'Enter') return;
                const el = ev.target && ev.target.closest ? ev.target.closest('[data-action]') : null;
                if (!el) return;
                el.click();
            }, true);

            // Initialize rendering after DOM is ready
            setTimeout(() => {
                try { renderQuotingSuppliersPanel(); } catch (e) { }
                try { renderQuotingBundlesPanel(); } catch (e) { }
            }, 0);
        }

        function renderRFQHistory(batchesOverride = null) {
            const st = getQuotingState();
            const proj = currentProject;

            let batches = [];
            if (Array.isArray(batchesOverride)) batches = batchesOverride.slice();
            else if (proj) batches = (getProjectBatches(proj) || []).slice();

            const wantedSup = st.supplier ? String(st.supplier).toLowerCase() : '';
            if (wantedSup) {
                batches = batches.filter((b) => {
                    const sup = String((b.supplier_name || b.supplier || b.supplierName || '')).toLowerCase();
                    return sup === wantedSup;
                });
            }

            // Sort newest first
            batches.sort((a, b) => {
                const da = new Date(a.created_at || a.created || a.date || 0).getTime() || 0;
                const db = new Date(b.created_at || b.created || b.date || 0).getTime() || 0;
                return db - da;
            });

            // Preferred rendering: the new unified table
            const tbl = getEl('qt-bundles-table');
            const tbody = tbl ? tbl.querySelector('tbody') : null;

            if (tbody) {
                const rowsHtml = batches.map((batch) => {
                    const id = batch.id || batch.batch_id || batch.pk || '';
                    const created = batch.created_at || batch.created || batch.date || '';
                    const dateStr = created ? new Date(created).toLocaleDateString() : '';
                    const sup = String((batch.supplier_name || batch.supplier || batch.supplierName || '')).trim();
                    const status = String((batch.status || batch.batch_status || 'Draft')).trim();
                    const due = batch.due_date ? new Date(batch.due_date).toLocaleDateString() : '';
                    const rev = String((batch.revision || batch.rev || '')).trim();
                    const itemCount = Array.isArray(batch.items) ? batch.items.length : (Number.isFinite(batch.item_count) ? batch.item_count : 0);

                    return `
                <tr class="qc-row" data-action="qt-open-bundle" data-batch-id="${escapeHtml(String(id))}" tabindex="0">
                    <td>${escapeHtml(dateStr)}</td>
                    <td class="cell-strong">${escapeHtml(sup)}</td>
                    <td>${escapeHtml(status)}</td>
                    <td class="cell-num">${itemCount}</td>
                    <td>${escapeHtml(due)}</td>
                    <td>${escapeHtml(rev)}</td>
                </tr>
            `;
                }).join('');

                tbody.innerHTML = rowsHtml || '';

                // Apply unified filters + update count label
                try { applyUnifiedTableFilters('qt-bundles-table'); } catch (e) { }
                try { refreshTablePagination('qt-bundles-table'); } catch (e) { }

                const countEl = getEl('qt-bundles-count');
                if (countEl) {
                    try {
                        const shown = Array.from(tbody.querySelectorAll('tr')).filter(r => r.dataset.utFiltered !== '1').length;
                        countEl.textContent = String(shown);
                    } catch (e) {
                        countEl.textContent = String(batches.length);
                    }
                }

                return;
            }

            // Fallback (legacy list rendering)
            const container = getEl('quoting-history-list');
            if (!container) return;

            const q = (getEl('qt-bundle-filter')?.value || '').toLowerCase();
            const statusFilter = (getEl('qt-bundle-status-filter')?.value || '').trim();

            const filtered = batches.filter((batch) => {
                if (statusFilter && String((batch.status || batch.batch_status || '')).trim() !== statusFilter) return false;
                if (!q) return true;
                const txt = `${batch.supplier_name || batch.supplier || ''} ${batch.status || ''} ${batch.revision || ''} ${batch.note || ''}`.toLowerCase();
                return txt.includes(q);
            });

            container.innerHTML = filtered.map((batch) => {
                const id = batch.id || batch.batch_id || batch.pk || '';
                const created = batch.created_at || batch.created || batch.date || '';
                const due = batch.due_date ? new Date(batch.due_date).toLocaleDateString() : '';
                const status = batch.status || batch.batch_status || 'Draft';
                const items = Array.isArray(batch.items) ? batch.items.length : (batch.item_count || 0);
                return `
            <div class="qt-row" data-action="qt-open-bundle" data-batch-id="${escapeHtml(String(id))}" title="Open Bundle">
                <div class="qt-row-main">
                    <div class="qt-row-title">${escapeHtml(batch.supplier_name || batch.supplier || 'Supplier')}</div>
                    <div class="qt-row-meta">
                        <span class="qt-pill">${escapeHtml(status)}</span>
                        <span>${items} items</span>
                        <span>${created ? new Date(created).toLocaleDateString() : ''}</span>
                        ${due ? `<span>Due: ${escapeHtml(due)}</span>` : ''}
                    </div>
                </div>
            </div>
        `;
            }).join('') || `<div class="qt-empty">No bundles found.</div>`;
        }


        // Open batch detail in wizard panel (editable)
        function openRFQBatchDetail(batchId) {
            // Prefer full page bundle detail
            try { if (typeof openBundleDetailPage === 'function') { openBundleDetailPage(batchId, 'quoting'); return; } } catch (e) { }
            if (!currentProject) return;
            const panel = getEl('quoting-wizard-panel');
            if (!panel) return;

            const batches = window.RFQData.getRFQBatches(currentProject.id);
            const batch = batches.find(b => String(b.id) === String(batchId));
            if (!batch) {
                panel.innerHTML = '<div style="padding:20px; color:#999;">Batch not found</div>';
                return;
            }

            const statusOptions = ['Draft', 'Sent', 'Quote Received', 'Closed', 'Zru≈°itled'];
            const currencyOptions = ['EUR', 'USD', 'CZK'];
            const incotermsOptions = (window.RFQData.INCOTERMS || ['EXW', 'FCA', 'FOB', 'CIF', 'DAP', 'DDP']);

            // Build item index for quick lookup
            const itemByDn = new Map((currentProject.items || []).map(it => [String(it.item_drawing_no || '').trim(), it]));
            const inBatch = new Set((batch.items || []).map(x => String(x.drawing_no || '').trim()));

            // eligible items: items that have this supplier in targets OR items not in batch (allow adding anyway)
            const eligibleItems = (currentProject.items || []).filter(it => {
                const dn = String(it.item_drawing_no || '').trim();
                if (!dn) return false;
                return !inBatch.has(dn);
            });

            panel.innerHTML = `
                <div style="padding: 16px; display:flex; flex-direction:column; gap: 12px; height: 100%;">
                    <div style="display:flex; justify-content:space-between; align-items:center; gap: 10px;">
                        <div style="font-weight:800; font-size:14px;">üì¶ RFQ Bundle ‚Äî ${batch.supplier_name || ''}</div>
                        <div style="display:flex; gap: 8px; align-items:center;">
                            <button id="btn-batch-export" class="btn-secondary">Export CSV</button>
                            <button id="btn-batch-delete" class="btn-danger">Delete</button>
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="form-row">
                            <label>Status</label>
                            <select id="batch-status" class="rfq-input">
                                ${statusOptions.map(s => `<option value="${s}" ${s === (batch.status || 'Draft') ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-row">
                            <label>Due date</label>
                            <input id="batch-due" type="date" class="rfq-input" value="${(batch.due_date || '').slice(0, 10)}">
                        </div>
                        <div class="form-row">
                            <label>Incoterms</label>
                            <select id="batch-incoterms" class="rfq-input">
                                ${incotermsOptions.map(s => `<option value="${s}" ${s === (batch.incoterms || 'EXW') ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-row">
                            <label>Currency</label>
                            <select id="batch-currency" class="rfq-input">
                                ${currencyOptions.map(c => `<option value="${c}" ${c === (batch.currency || 'EUR') ? 'selected' : ''}>${c}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-row">
                            <label>Contact name</label>
                            <input id="batch-contact-name" type="text" class="rfq-input" value="${batch.contact_person || ''}">
                        </div>
                        <div class="form-row">
                            <label>Contact email</label>
                            <input id="batch-contact-email" type="email" class="rfq-input" value="${batch.contact_email || ''}">
                        </div>
                    </div>

                    <div class="form-row">
                        <label>Notes</label>
                        <textarea id="batch-notes" class="rfq-input" style="height: 60px; resize: vertical;">${batch.notes || ''}</textarea>
                    </div>

                    <div style="display:flex; gap: 10px; align-items:center;">
                        <select id="batch-add-item" class="rfq-input" style="flex: 1;">
                            <option value="">+ Add item to bundle‚Ä¶</option>
                            ${eligibleItems.map(it => {
                const dn = String(it.item_drawing_no || '').trim();
                const desc = String(it.description || '').slice(0, 60);
                return `<option value="${dn}">${dn} ‚Äî ${desc}</option>`;
            }).join('')}
                        </select>
                        <button id="btn-batch-add-item" class="btn-primary">Add</button>
                        <button id="btn-batch-save" class="btn-success">Ulo≈æit</button>
                        <button id="btn-batch-mark-sent" class="btn-primary">Mark Sent</button>
                        <button id="btn-batch-mark-received" class="btn-primary">Mark Quote Received</button>
                        <button id="btn-batch-close" class="btn-secondary">Close</button>
                    </div>

                    <div style="flex: 1; overflow:auto; border: 1px solid #e5e5e5; border-radius: 10px; background: white;">
                        <table class="rfq-table" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th style="width:120px;">Item</th>
                                    <th>Description</th>
                                    <th style="width:170px;">Quantities</th>
                                    <th style="width:220px;">Prices</th>
                                    <th style="width:80px;">Curr</th>
                                    <th style="width:110px;">Lead time</th>
                                    <th style="width:90px;">MOQ</th>
                                    <th style="width:130px;">Valid until</th>
                                    <th style="width:120px;">Quote status</th>
                                    <th style="width:90px;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${(batch.items || []).map(bi => {
                const dn = String(bi.drawing_no || '').trim();
                const it = itemByDn.get(dn);
                const desc = it ? (it.description || '') : '';
                const tiers = it ? getItemQtyTiers(it, { includeBlanks: false }) : [];
                const qtyHtml = tiers
                    .map(t => String(t.value ?? '').trim() !== ''
                        ? `<div class="q-tier"><span class="q-label">Q${t.index}:</span> <span class="q-val">${escapeHtml(String(t.value))}</span></div>`
                        : '')
                    .join('') || '<div class="q-muted">‚Äî</div>';

                // Prices per tier (dynamic): inputs P1..PN follow item qty tiers
                const pricesHtml = tiers
                    .map(t => {
                        if (String(t.value ?? '').trim() === '') return '';
                        const k = `price_${t.index}`;
                        const val = (t.index === 1) ? (bi.price_1 ?? bi.price ?? '') : (bi[k] ?? '');
                        return `<div class="p-tier"><span class="p-label">P${t.index}:</span><input class="rfq-input bi-price bi-price-${t.index}" data-tier-index="${t.index}" type="number" step="0.0001" value="${escapeHtml(String(val))}"></div>`;
                    })
                    .join('') || `<div class="p-tier"><input class="rfq-input bi-price bi-price-1" data-tier-index="1" type="number" step="0.0001" value="${escapeHtml(String(bi.price ?? ''))}"></div>`;
                const qs = bi.quote_status || 'Requested';
                return `
                                        <tr data-dn="${dn}">
                                            <td><a href="#" class="link-open-item" data-dn="${dn}">${dn}</a></td>
                                            <td style="font-size:12px;">${escapeHtml(desc)}</td>
                                            <td>${qtyHtml}</td>
                                            <td>${pricesHtml}</td>
                                            <td>
                                                <select class="rfq-input bi-currency">
                                                    ${currencyOptions.map(c => `<option value="${c}" ${c === (bi.currency || batch.currency || 'EUR') ? 'selected' : ''}>${c}</option>`).join('')}
                                                </select>
                                            </td>
                                            <td><input class="rfq-input bi-lead" type="text" placeholder="days" value="${escapeHtml(String(bi.lead_time_days ?? ''))}"></td>
                                            <td><input class="rfq-input bi-moq" type="text" value="${escapeHtml(String(bi.moq ?? ''))}"></td>
                                            <td><input class="rfq-input bi-valid" type="date" value="${escapeHtml(String(bi.valid_until || '').slice(0, 10))}"></td>
                                            <td>
                                                <select class="rfq-input bi-qstatus">
                                                    ${['Requested', 'Quoted', 'No Bid'].map(s => `<option value="${s}" ${s === qs ? 'selected' : ''}>${s}</option>`).join('')}
                                                </select>
                                            </td>
                                            <td style="display:flex; gap:6px;">
                                                <button class="btn-secondary btn-mini btn-remove-bi">Remove</button>
                                            </td>
                                        </tr>
                                    `;
            }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            try { panel.dataset.activeBatchId = String(batch.id); } catch (e) { }

            // events
            const saveCurrent = () => {
                const updated = { ...batch };
                updated.status = panel.querySelector('#batch-status').value;
                updated.due_date = panel.querySelector('#batch-due').value || '';
                updated.incoterms = panel.querySelector('#batch-incoterms').value;
                updated.currency = panel.querySelector('#batch-currency').value;
                updated.contact_person = panel.querySelector('#batch-contact-name').value;
                updated.contact_email = panel.querySelector('#batch-contact-email').value;
                updated.notes = panel.querySelector('#batch-notes').value;

                // items
                updated.items = (updated.items || []).map(bi => ({ ...bi }));
                panel.querySelectorAll('tbody tr[data-dn]').forEach(tr => {
                    const dn = tr.dataset.dn;
                    const bi = updated.items.find(x => String(x.drawing_no) === String(dn));
                    if (!bi) return;
                    {
                        // Collect all tier prices from inputs (dynamic)
                        const inputs = tr.querySelectorAll('.bi-price[data-tier-index]');
                        inputs.forEach(inp => {
                            const idx = Number(inp.dataset.tierIndex);
                            if (!Number.isFinite(idx) || idx <= 0) return;
                            const val = inp.value ?? '';
                            bi[`price_${idx}`] = val;
                            if (idx === 1) {
                                bi.price_1 = val;
                                bi.price = val; // legacy alias
                            }
                        });

                        // Backward compatibility for older bundles (ensure at least price_1 exists)
                        if (bi.price_1 === undefined && bi.price !== undefined) bi.price_1 = bi.price;
                        if (bi.price === undefined && bi.price_1 !== undefined) bi.price = bi.price_1;
                    }
                    bi.currency = tr.querySelector('.bi-currency').value;
                    bi.lead_time_days = tr.querySelector('.bi-lead').value;
                    bi.moq = tr.querySelector('.bi-moq').value;
                    bi.valid_until = tr.querySelector('.bi-valid').value;
                    bi.quote_status = tr.querySelector('.bi-qstatus').value;
                });

                window.RFQData.saveRFQBatch(currentProject.id, updated);
                // keep currentProject in sync without overwriting unsaved item edits
                syncProjectBatchesIntoMemory(currentProject);
                // propagate edits into item suppliers & pricing (best-effort)
                try { applyBatchToItems(currentProject, updated, 'save'); } catch (e) { console.error('applyBatchToItems(save) failed', e); }
                try { updateProject(currentProject); } catch (e) { console.error('updateProject failed', e); }
                renderRFQHistory();
                return updated;
            };

            panel.querySelector('#btn-batch-save').addEventListener('click', () => {
                saveCurrent();
                showToast('Saved!', 'success');
            });

            panel.querySelector('#btn-batch-add-item').addEventListener('click', () => {
                const dn = panel.querySelector('#batch-add-item').value;
                if (!dn) return;
                const updated = { ...batch, items: [...(batch.items || [])] };
                if (updated.items.some(x => String(x.drawing_no) === String(dn))) return;

                updated.items.push({
                    drawing_no: dn,
                    quote_status: 'Requested',
                    price: '',
                    price_1: '',
                    price_2: '',
                    price_3: '',
                    price_4: '',
                    price_5: '',
                    currency: (batch.currency || 'EUR'),
                    lead_time_days: '',
                    moq: '',
                    valid_until: ''
                });

                // Ensure supplier record exists on the item
                const it = itemByDn.get(String(dn));
                if (it) {
                    if (!Array.isArray(it.suppliers)) it.suppliers = [];
                    let sup = it.suppliers.find(s => s && s.name === (batch.supplier_name || ''));
                    if (!sup) {
                        it.suppliers.push({ id: Date.now(), name: batch.supplier_name, status: 'Planned', currency: batch.currency || 'EUR', isMain: false, price: 0, price_1: 0 });
                    }
                }

                window.RFQData.saveRFQBatch(currentProject.id, updated);
                syncProjectBatchesIntoMemory(currentProject);
                try { applyBatchToItems(currentProject, updated, 'save'); } catch (e) { console.error('applyBatchToItems(save) failed', e); }
                try { updateProject(currentProject); } catch (e) { console.error('updateProject failed', e); }
                openRFQBatchDetail(updated.id);
                renderRFQHistory();
            });

            panel.querySelector('#btn-batch-mark-sent').addEventListener('click', () => {
                const updated = saveCurrent();
                updated.status = 'Sent';
                updated.sent_at = new Date().toISOString();

                // update item supplier statuses
                (updated.items || []).forEach(bi => {
                    const it = itemByDn.get(String(bi.drawing_no));
                    if (!it) return;
                    if (!Array.isArray(it.suppliers)) it.suppliers = [];
                    const sup = it.suppliers.find(s => s && s.name === updated.supplier_name);
                    if (sup) sup.status = 'RFQ Sent';
                    if (it.status === 'New') it.status = 'RFQ Sent';
                });

                window.RFQData.saveRFQBatch(currentProject.id, updated);
                syncProjectBatchesIntoMemory(currentProject);
                try { applyBatchToItems(currentProject, updated, 'sent'); } catch (e) { console.error('applyBatchToItems(sent) failed', e); }
                try { updateProject(currentProject); } catch (e) { console.error('updateProject failed', e); }
                showToast('Marked as Sent', 'success');
                openRFQBatchDetail(updated.id);
                renderRFQHistory();
            });

            panel.querySelector('#btn-batch-mark-received').addEventListener('click', () => {
                const updated = saveCurrent();
                updated.status = 'Quote Received';
                updated.quote_received_at = new Date().toISOString();

                (updated.items || []).forEach(bi => {
                    const it = itemByDn.get(String(bi.drawing_no));
                    if (!it) return;
                    if (!Array.isArray(it.suppliers)) it.suppliers = [];
                    const sup = it.suppliers.find(s => s && s.name === updated.supplier_name);
                    if (sup) {
                        sup.status = (bi.quote_status === 'No Bid') ? 'No Bid' : 'Quote Received';
                        if (bi.price !== '') {
                            const num = parseFloat(bi.price);
                            if (!isNaN(num)) {
                                sup.price = num;
                                sup.price_1 = num;
                            }
                        }
                        sup.currency = bi.currency || updated.currency;
                        sup.lead_time_days = bi.lead_time_days;
                        sup.moq = bi.moq;
                        sup.valid_until = bi.valid_until;
                        sup.last_quote_date = new Date().toISOString().slice(0, 10);

                        if (sup.isMain) {
                            it.supplier = sup.name;
                            it.price_1 = sup.price_1 || sup.price || it.price_1;
                            it.currency = sup.currency || it.currency;
                            calculateEuroValues(it);
                        }
                    }
                    if (it.status === 'RFQ Sent') it.status = 'Quote Received';
                });

                window.RFQData.saveRFQBatch(currentProject.id, updated);
                syncProjectBatchesIntoMemory(currentProject);
                try { applyBatchToItems(currentProject, updated, 'received'); } catch (e) { console.error('applyBatchToItems(received) failed', e); }
                try { updateProject(currentProject); } catch (e) { console.error('updateProject failed', e); }
                showSuccessModal({
                    title: 'Quote Received',
                    message: 'Quote data has been saved to items.',
                    icon: 'üì•',
                    iconColor: '#10b981',
                    details: [
                        { label: 'Supplier', value: updated.supplier || '-' },
                        { label: 'Items Updated', value: (updated.items || []).length }
                    ]
                });
                openRFQBatchDetail(updated.id);
                renderRFQHistory();
            });

            panel.querySelector('#btn-batch-close').addEventListener('click', () => {
                const updated = saveCurrent();
                updated.status = 'Closed';
                window.RFQData.saveRFQBatch(currentProject.id, updated);
                showSuccessModal({
                    title: 'Quote Closed',
                    message: 'This quote has been marked as closed.',
                    icon: '‚úì',
                    iconColor: '#6b7280'
                });
                renderRFQHistory();
                openRFQBatchDetail(updated.id);
            });

            panel.querySelector('#btn-batch-delete').addEventListener('click', async () => {
                const confirmed = await window.showConfirmDialog({
                    title: 'Delete RFQ Bundle',
                    message: 'Delete this RFQ bundle?',
                    type: 'danger',
                    okText: 'Delete',
                    cancelText: 'Cancel'
                });
                if (!confirmed) return;
                window.RFQData.deleteRFQBatch(currentProject.id, batch.id);
                resetRFQWizard();
                renderRFQHistory();
            });

            panel.querySelector('#btn-batch-export').addEventListener('click', () => {
                const updated = saveCurrent();
                exportBatchCSV(updated);
            });

            // row events
            panel.querySelectorAll('.btn-remove-bi').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tr = e.target.closest('tr[data-dn]');
                    if (!tr) return;
                    const dn = tr.dataset.dn;
                    const updated = { ...batch, items: (batch.items || []).filter(x => String(x.drawing_no) !== String(dn)) };
                    window.RFQData.saveRFQBatch(currentProject.id, updated);
                    openRFQBatchDetail(updated.id);
                    renderRFQHistory();
                });
            });

            panel.querySelectorAll('.link-open-item').forEach(a => {
                a.addEventListener('click', (e) => {
                    e.preventDefault();
                    const dn = e.target.dataset.dn;
                    // navigate to item detail
                    switchView('items');
                    openItemDetail((currentProject.items || []).findIndex(x => String(x.item_drawing_no) === String(dn)));
                });
            });
        }

        function exportBatchCSV(batch) {
            if (!currentProject) return;
            const itemByDn = new Map((currentProject.items || []).map(it => [String(it.item_drawing_no || '').trim(), it]));
            // Determine max qty tiers across items in this bundle (cap at 10 for CSV readability)
            let maxTier = 5;
            (batch.items || []).forEach(bi => {
                const it = itemByDn.get(String(bi.drawing_no || '').trim());
                const m = getMaxQtyIndex(it || {}, 5);
                if (m > maxTier) maxTier = m;
            });
            if (maxTier > 10) maxTier = 10;

            const rows = [
                ['Project', currentProject.name],
                ['Supplier', batch.supplier_name || ''],
                ['Status', batch.status || ''],
                ['Due date', batch.due_date || ''],
                ['Incoterms', batch.incoterms || ''],
                ['Currency', batch.currency || ''],
                ['Contact', batch.contact_person || ''],
                ['Email', batch.contact_email || ''],
                [],
                ['Item/Drawing No', 'Description', ...Array.from({ length: maxTier }, (_, i) => `Qty${i + 1}`), ...Array.from({ length: maxTier }, (_, i) => `Price${i + 1}`), 'Currency', 'Lead time (days)', 'MOQ', 'Valid until', 'Quote status']
            ];
            (batch.items || []).forEach(bi => {
                const it = itemByDn.get(String(bi.drawing_no || '').trim());
                const qtyCols = Array.from({ length: maxTier }, (_, i) => (it ? (it[`qty_${i + 1}`] || '') : ''));
                const priceCols = Array.from({ length: maxTier }, (_, i) => {
                    const idx = i + 1;
                    const k = `price_${idx}`;
                    if (idx === 1) return (bi.price_1 ?? bi.price ?? '');
                    return (bi[k] ?? '');
                });
                rows.push([
                    bi.drawing_no || '',
                    (it ? (it.description || '') : ''),
                    ...qtyCols,
                    ...priceCols,
                    (bi.currency || batch.currency || 'EUR'),
                    (bi.lead_time_days ?? ''),
                    (bi.moq ?? ''),
                    (bi.valid_until ?? ''),
                    (bi.quote_status || 'Requested')
                ]);
            });

            const csv = rows.map(r => r.map(v => {
                const s = String(v ?? '');
                return /[\",\n]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s;
            }).join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `RFQ_Bundle_${(batch.supplier_name || 'supplier').replace(/\s+/g, '_')}_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function escapeHtml(str) {
            return String(str ?? '').replace(/[&<>"']/g, (m) => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[m]));
        }


        function escapeAttr(str) {
            return escapeHtml(str);
        }

        // Safe helper for <input type="number"> value attributes
        // - prevents console errors / DOMExceptions when legacy data contains non-numeric strings (e.g. 'EXW')
        function toNumberInputValue(v) {
            const s = String(v ?? '').trim();
            if (!s) return '';
            // accept "12,34" as "12.34"
            const norm = s.replace(',', '.');
            const n = parseFloat(norm);
            if (!Number.isFinite(n)) return '';
            return String(n);
        }



        // ---------------------------------------------------------
        // Quoting: robust delegated handlers + save-from-DOM fallback
        // (prevents "click does nothing" even if per-render listeners fail)
        // ---------------------------------------------------------
        function _getQuotingPanel() {
            return getEl('quoting-wizard-panel');
        }

        function _getActiveBatchIdFromPanel() {
            const panel = _getQuotingPanel();
            const id = panel && panel.dataset ? panel.dataset.activeBatchId : '';
            return String(id || '').trim();
        }

        function _getBatchById(batchId) {
            if (!currentProject) return null;
            const batches = (window.RFQData && typeof window.RFQData.getRFQBatches === 'function')
                ? window.RFQData.getRFQBatches(currentProject.id)
                : [];
            return (batches || []).find(b => String(b.id) === String(batchId)) || null;
        }

        function saveActiveRFQBatchFromPanel() {
            if (!currentProject) { try { if (window.showToast) window.showToast('Select a project first', 'warning'); } catch (e) { } return null; }
            const panel = _getQuotingPanel();
            if (!panel) return null;

            const batchId = _getActiveBatchIdFromPanel();
            if (!batchId) return null;

            const batch = _getBatchById(batchId);
            if (!batch) return null;

            const updated = { ...batch };

            // header fields
            const q = (sel) => panel.querySelector(sel);
            if (q('#batch-status')) updated.status = q('#batch-status').value;
            if (q('#batch-due')) updated.due_date = q('#batch-due').value;
            if (q('#batch-incoterms')) updated.incoterms = q('#batch-incoterms').value;
            if (q('#batch-currency')) updated.currency = q('#batch-currency').value;
            if (q('#batch-contact-name')) updated.contact_person = q('#batch-contact-name').value;
            if (q('#batch-contact-email')) updated.contact_email = q('#batch-contact-email').value;
            if (q('#batch-notes')) updated.notes = q('#batch-notes').value;

            // items
            updated.items = (updated.items || []).map(bi => ({ ...bi }));

            panel.querySelectorAll('tbody tr[data-dn]').forEach(tr => {
                const dn = String(tr.dataset.dn || '').trim();
                if (!dn) return;
                const bi = (updated.items || []).find(x => String(x.drawing_no || '').trim() === dn);
                if (!bi) return;

                // prices (dynamic tiers)
                tr.querySelectorAll('.bi-price[data-tier-index]').forEach(inp => {
                    const idx = Number(inp.dataset.tierIndex);
                    if (!Number.isFinite(idx) || idx <= 0) return;
                    const val = inp.value ?? '';
                    bi[`price_${idx}`] = val;
                    if (idx === 1) {
                        bi.price_1 = val;
                        bi.price = val; // legacy alias
                    }
                });
                if (bi.price_1 === undefined && bi.price !== undefined) bi.price_1 = bi.price;
                if (bi.price === undefined && bi.price_1 !== undefined) bi.price = bi.price_1;

                const cur = tr.querySelector('.bi-currency');
                const lead = tr.querySelector('.bi-lead');
                const moq = tr.querySelector('.bi-moq');
                const valid = tr.querySelector('.bi-valid');
                const qs = tr.querySelector('.bi-qstatus');
                if (cur) bi.currency = cur.value;
                if (lead) bi.lead_time_days = lead.value;
                if (moq) bi.moq = moq.value;
                if (valid) bi.valid_until = valid.value;
                if (qs) bi.quote_status = qs.value;
            });

            // persist
            try { window.RFQData.saveRFQBatch(currentProject.id, updated); } catch (e) { console.error('saveRFQBatch failed', e); }
            try { syncProjectBatchesIntoMemory(currentProject); } catch (e) { console.error('syncProjectBatchesIntoMemory failed', e); }
            try { applyBatchToItems(currentProject, updated, 'save'); } catch (e) { console.error('applyBatchToItems(save) failed', e); }
            try { updateProject(currentProject); } catch (e) { console.error('updateProject failed', e); }
            try { renderRFQHistory(); } catch (e) { console.error('renderRFQHistory failed', e); }

            return updated;
        }

        function _withUlo≈æitdBatch(fn) {
            const b = saveActiveRFQBatchFromPanel();
            if (!b) return null;
            try { fn && fn(b); } catch (e) { console.error(e); }
            try { window.RFQData.saveRFQBatch(currentProject.id, b); } catch (e) { console.error('saveRFQBatch failed', e); }
            try { syncProjectBatchesIntoMemory(currentProject); } catch (e) { }
            try { applyBatchToItems(currentProject, b, 'save'); } catch (e) { }
            try { updateProject(currentProject); } catch (e) { }
            try { openRFQBatchDetail(b.id); } catch (e) { }
            try { renderRFQHistory(); } catch (e) { }
            return b;
        }

        function bindQuotingDelegationOnce() {
            if (window.__rfqQuotingDelegationBound) return;
            window.__rfqQuotingDelegationBound = true;

            document.addEventListener('click', (ev) => {
                const target = ev.target && ev.target.closest ? ev.target.closest('button, a, .rfq-history-card') : null;
                if (!target) return;

                // Open RFQ batch from history list (fallback)
                if (target.classList && target.classList.contains('rfq-history-card')) {
                    const id = target.dataset ? target.dataset.batchId : '';
                    if (id) { ev.preventDefault(); try { openRFQBatchDetail(id); } catch (e) { console.error(e); } }
                    return;
                }

                // Open item detail from batch table link
                if (target.classList && target.classList.contains('link-open-item')) {
                    ev.preventDefault();
                    const dn = target.dataset ? target.dataset.dn : '';
                    const idx = (currentProject && currentProject.items) ? (currentProject.items || []).findIndex(x => String(x.item_drawing_no || '').trim() === String(dn || '').trim()) : -1;
                    if (idx >= 0 && typeof openItemDetail === 'function') openItemDetail(idx);
                    return;
                }

                const id = target.id || '';

                if (id === 'btn-new-rfq-batch') {
                    ev.preventDefault();
                    try {
                        const st = (typeof getQuotingState === 'function') ? getQuotingState() : { supplier: '' };
                        let sup = String(st && st.supplier ? st.supplier : '').trim();

                        // Fallback: active supplier row in left panel
                        if (!sup) {
                            try {
                                const row = document.querySelector('#quoting-suppliers-list .qt-supplier-row.active[data-supplier-enc]');
                                if (row) {
                                    const enc = row.getAttribute('data-supplier-enc') || '';
                                    try { sup = decodeURIComponent(enc); } catch (e) { sup = enc; }
                                    sup = String(sup || '').trim();
                                }
                            } catch (e) { }
                        }

                        try {
                            if (st) {
                                st.mode = 'create';
                                st.batchId = '';
                                if (sup) st.supplier = sup;
                            }
                        } catch (e) { }

                        startRFQWizard(sup || null, []);
                    } catch (e) { console.error(e); }
                    return;
                }

                if (id === 'btn-batch-save') {
                    ev.preventDefault();
                    const b = saveActiveRFQBatchFromPanel();
                    if (b) { try { showToast('Saved!', 'success'); } catch (e) { } }
                    return;
                }

                if (id === 'btn-batch-mark-sent') {
                    ev.preventDefault();
                    _withUlo≈æitdBatch((b) => {
                        b.status = 'Sent';
                        b.sent_at = new Date().toISOString();
                        // update supplier statuses on items
                        const itemByDn = new Map((currentProject.items || []).map(it => [String(it.item_drawing_no || '').trim(), it]));
                        (b.items || []).forEach(bi => {
                            const it = itemByDn.get(String(bi.drawing_no || '').trim());
                            if (!it) return;
                            if (!Array.isArray(it.suppliers)) it.suppliers = [];
                            const sup = (it.suppliers || []).find(s => s && String(s.name || '').trim() === String(b.supplier_name || '').trim());
                            if (sup) sup.status = 'RFQ Sent';
                            if (it.status === 'New') it.status = 'RFQ Sent';
                        });
                    });
                    try { showToast('Marked as Sent', 'success'); } catch (e) { }
                    return;
                }

                if (id === 'btn-batch-mark-received') {
                    ev.preventDefault();
                    _withUlo≈æitdBatch((b) => {
                        b.status = 'Quote Received';
                        b.quote_received_at = new Date().toISOString();
                    });
                    try { showToast('Marked as Quote Received', 'success'); } catch (e) { }
                    return;
                }

                if (id === 'btn-batch-close') {
                    ev.preventDefault();
                    try { resetRFQWizard(); } catch (e) { console.error(e); }
                    return;
                }

                if (id === 'btn-batch-export') {
                    ev.preventDefault();
                    const batchId = _getActiveBatchIdFromPanel();
                    const b = batchId ? _getBatchById(batchId) : null;
                    if (b && typeof exportBatchCSV === 'function') {
                        try { exportBatchCSV(b); } catch (e) { console.error(e); }
                    }
                    return;
                }

                if (id === 'btn-batch-delete') {
                    ev.preventDefault();
                    const batchId = _getActiveBatchIdFromPanel();
                    if (!batchId) return;
                    (async () => {
                        const confirmed = await window.showConfirmDialog({
                            title: 'Delete RFQ Bundle',
                            message: 'Delete this RFQ bundle?',
                            type: 'danger',
                            okText: 'Delete',
                            cancelText: 'Cancel'
                        });
                        if (!confirmed) return;
                        try { window.RFQData.deleteRFQBatch(currentProject.id, batchId); } catch (e) { console.error(e); }
                        try { syncProjectBatchesIntoMemory(currentProject); } catch (e) { }
                        try { updateProject(currentProject); } catch (e) { }
                        try { resetRFQWizard(); } catch (e) { }
                        try { renderRFQHistory(); } catch (e) { }
                    })();
                    return;
                }

                // Remove line item in batch table
                if (target.classList && target.classList.contains('btn-remove-bi')) {
                    ev.preventDefault();
                    const tr = target.closest('tr[data-dn]');
                    const dn = tr ? String(tr.dataset.dn || '').trim() : '';
                    const batchId = _getActiveBatchIdFromPanel();
                    const batch = batchId ? _getBatchById(batchId) : null;
                    if (!dn || !batch) return;
                    const updated = { ...batch, items: (batch.items || []).filter(x => String(x.drawing_no || '').trim() !== dn) };
                    try { window.RFQData.saveRFQBatch(currentProject.id, updated); } catch (e) { console.error(e); }
                    try { syncProjectBatchesIntoMemory(currentProject); } catch (e) { }
                    try { applyBatchToItems(currentProject, updated, 'save'); } catch (e) { }
                    try { updateProject(currentProject); } catch (e) { }
                    try { openRFQBatchDetail(updated.id); } catch (e) { }
                    try { renderRFQHistory(); } catch (e) { }
                    return;
                }
            }, true);
        }
        bindQuotingDelegationOnce();

        function resetRFQWizard() {
            // reset quoting wizard state (non-destructive)
            try {
                const st = getQuotingState();
                st.wizOpen = false;
                if (st.mode === 'create') st.mode = st.supplier ? 'supplier' : 'home';
                st.batchId = '';
            } catch (e) { }

            // Hide wizard panel overlay
            const panel = getEl('quoting-wizard-panel');
            if (panel) {
                panel.classList.add('hidden');
                panel.innerHTML = '';
            }

            // route back to kanban view
            try { renderQuotingView(); } catch (e) { }
        }

        // Listener for New RFQ Bundle button (needs to be added once)
        const btnNewBatch = getEl('btn-new-rfq-batch');
        if (btnNewBatch) btnNewBatch.onclick = () => {
            const st = getQuotingState();
            st.mode = 'create';
            st.wizOpen = true;
            st.batchId = '';
            renderQuotingView();
        };


        function startRFQWizard(preselectedSupplierName = null, preselectedItemDNs = []) {
            if (!currentProject) { if (window.showToast) window.showToast('Select a project first', 'warning'); return; }

            const panel = getEl('quoting-wizard-panel');
            if (!panel) return;



            try { ensureProjectSupplierLinks(currentProject); } catch (e) { }
            // Auto-pick supplier from Quoting Cockpit if not provided
            try {
                if (!preselectedSupplierName && typeof getQuotingState === 'function') {
                    const st = getQuotingState();
                    const s = st && st.supplier ? String(st.supplier).trim() : '';
                    if (s) preselectedSupplierName = s;
                }
            } catch (e) { }

            // Fallback: active supplier row (when state is not set)
            try {
                if (!preselectedSupplierName) {
                    const row = document.querySelector('#quoting-suppliers-list .qt-supplier-row.active[data-supplier-enc]');
                    if (row) {
                        const enc = row.getAttribute('data-supplier-enc') || '';
                        let s = enc;
                        try { s = decodeURIComponent(enc); } catch (e) { }
                        s = String(s || '').trim();
                        if (s) preselectedSupplierName = s;
                    }
                }
            } catch (e) { }

            const today = new Date();
            const isoToday = today.toISOString().slice(0, 10);
            const dueDefault = new Date(today.getTime() + 14 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);

            // Build supplier candidates from targets + history
            const supplierSet = new Set(deriveAllSupplierNamesForProject(currentProject));
            (currentProject.items || []).forEach(it => (it.suppliers || []).forEach(s => {
                const n = resolveSupplierName(currentProject, s);
                if (n) supplierSet.add(n);
            }));
            (window.RFQData.getRFQBatches(currentProject.id) || []).forEach(b => {
                const n = String(b && (b.supplier_name || b.supplier) || '').trim();
                if (n) supplierSet.add(n);
            });

            // Planned suppliers first (so user sees targets on top)
            const plannedSet = new Set();
            (currentProject.items || []).forEach(it => (it.suppliers || []).forEach(s => {
                const status = String(s && (s.status || s.target_status || '') || '').trim().toLowerCase();
                const n = resolveSupplierName(currentProject, s);
                if (n && status === 'planned') plannedSet.add(n);
            }));

            const planned = Array.from(plannedSet).sort((a, b) => a.localeCompare(b));
            const others = Array.from(supplierSet).filter(x => !plannedSet.has(x)).sort((a, b) => a.localeCompare(b));
            const supplierOptions = [...planned, ...others];

            const dnSet = new Set((preselectedItemDNs || []).map(x => String(x || '').trim()).filter(Boolean));


            // Wizard selection state must survive re-renders (filtering / show-all toggles).
            // Using a Set avoids relying on DOM querySelectorAll(':checked'), which can be fragile after re-render.
            window.__RFQ_WIZ_SELECTED = window.__RFQ_WIZ_SELECTED || new Set();
            window.__RFQ_WIZ_SELECTED.clear();
            Array.from(dnSet).forEach(x => { if (x) window.__RFQ_WIZ_SELECTED.add(String(x).trim()); });
            const selectedDNsState = window.__RFQ_WIZ_SELECTED;
            let lastSupplierName = null;
            let seededPlanned = false;

            // Show wizard overlay
            panel.classList.remove('hidden');

            panel.innerHTML = `
                <div style="padding: 20px; display: flex; flex-direction: column; height: 100%; min-height: 0;">
                    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom: 14px;">
                        <h3 style="margin:0;">Create RFQ Bundle</h3>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="font-size: 11px; color:#888;">Project: <b>${escapeHtml(currentProject.name || '')}</b></div>
                            <button id="rfq-wiz-close" class="btn-secondary" style="padding: 4px 12px; font-size: 12px;">‚úï Close</button>
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                        <div class="form-row">
                            <label>Supplier (targets & history)</label>
                            <select id="rfq-wiz-supplier" class="rfq-input">
                                <option value="">-- Select supplier --</option>
                                ${supplierOptions.map(s => `<option value="${escapeHtml(s)}" ${preselectedSupplierName === s ? 'selected' : ''}>${escapeHtml(plannedSet.has(s) ? '‚≠ê ' + s : s)}</option>`).join('')}
                            </select>
                            <div style="font-size: 11px; color:#888; margin-top: 4px;">‚≠ê = has Planned targets in this project</div>
                        </div>

                        <div class="form-row">
                            <label>Or type supplier</label>
                            <input id="rfq-wiz-supplier-manual" type="text" class="rfq-input" placeholder="e.g. Bosch, W√ºrth..." value="${escapeHtml(preselectedSupplierName || '')}">
                            <div style="font-size: 11px; color:#888; margin-top: 4px;">Use this when supplier is not in the list yet.</div>
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                        <div class="form-row">
                            <label>Due date</label>
                            <input id="rfq-wiz-due" type="date" class="rfq-input" value="${dueDefault}">
                        </div>
                        <div class="form-row">
                            <label>Incoterms</label>
                            <select id="rfq-wiz-incoterms" class="rfq-input">
                                ${(window.RFQData.INCOTERMS || ['EXW', 'FCA', 'FOB', 'CIF', 'DAP', 'DDP']).map(s => `<option value="${s}" ${s === 'EXW' ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-row">
                            <label>Currency</label>
                            <select id="rfq-wiz-currency" class="rfq-input">
                                ${((window.RFQData && Array.isArray(window.RFQData.CURRENCIES) && window.RFQData.CURRENCIES.length) ? window.RFQData.CURRENCIES : ['EUR', 'USD', 'CZK']).slice(0, 20).map(c => `<option value="${c}" ${c === 'EUR' ? 'selected' : ''}>${c}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-row">
                            <label>Revision</label>
                            <input id="rfq-wiz-rev" type="text" class="rfq-input" value="A">
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                        <div class="form-row">
                            <label>Contact name</label>
                            <input id="rfq-wiz-contact" type="text" class="rfq-input" placeholder="Name">
                        </div>
                        <div class="form-row">
                            <label>Contact email</label>
                            <input id="rfq-wiz-email" type="email" class="rfq-input" placeholder="Email">
                        </div>
                    </div>

                    <div class="form-row" style="margin-bottom: 10px;">
                        <label>Notes (optional)</label>
                        <textarea id="rfq-wiz-notes" class="rfq-input" style="height: 54px; resize: vertical;" placeholder="Anything the supplier should know‚Ä¶"></textarea>
                    </div>

                    <div style="display:flex; gap: 10px; align-items:center; margin-bottom: 10px;">
                        <input id="rfq-wiz-filter" type="text" class="rfq-input" placeholder="Filter items (drawing no / description / mpn / manufacturer)" style="flex: 1;">
                        <label style="font-size:12px; color:#555; display:flex; align-items:center; gap:8px; white-space:nowrap;">
                            <input id="rfq-wiz-show-all" type="checkbox">
                            Show all items
                        </label>
                    </div>
                    <div class="qt-split" style="flex: 1; min-height: 0;">
                        <div id="rfq-wiz-items" style="border: 1px solid #eee; border-radius: 10px; overflow: auto; background: white; min-height: 0;">
                            <div style="text-align:center; color:#999; padding: 40px 12px;">Select a supplier (or type one) to load items</div>
                        </div>

                        <div class="qt-selected-box" style="min-height: 0; overflow: auto;">
                            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                                <div style="font-weight:800; color:#333;">Selected Items</div>
                                <span id="rfq-wiz-selected-count" class="qt-pill">0</span>
                            </div>
                            <div style="font-size:11px; color:#666; margin-top: 6px;">
                                Tip: click a row to select. Remove an item by clicking ‚úï on a chip.
                            </div>
                            <div id="rfq-wiz-selected" class="qt-selected-chips"></div>
                        </div>
                    </div>


                    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top: 12px;">
                        <div id="rfq-wiz-summary" style="font-size:12px; color:#666;">0 items selected</div>
                        <div style="display:flex; gap:10px;">
                            <button id="rfq-wiz-cancel" class="btn-secondary">Zru≈°it</button>
                            <button id="rfq-wiz-create-draft" class="btn-success rfq-disabled" data-rfq-action="wiz-create-draft" data-disabled="1">Create Draft Bundle</button>
                            <button id="rfq-wiz-create-sent" class="btn-primary rfq-disabled" data-rfq-action="wiz-create-sent" data-disabled="1">Create + Mark Sent + Export</button>
                        </div>
                    </div>
                </div>
            `;

            const elSel = panel.querySelector('#rfq-wiz-supplier');
            const elManual = panel.querySelector('#rfq-wiz-supplier-manual');

            // Normalize preselected supplier into controls (case-insensitive match)
            try {
                const norm = (v) => String(v || '').trim().toLowerCase();
                const pre = String(preselectedSupplierName || '').trim();
                if (pre) {
                    if (elManual && !String(elManual.value || '').trim()) elManual.value = pre;
                    if (elSel) {
                        const cur = String(elSel.value || '').trim();
                        if (!cur || norm(cur) !== norm(pre)) {
                            const opt = Array.from(elSel.options || []).find(o => norm(o && o.value) === norm(pre));
                            if (opt) elSel.value = opt.value;
                        }
                    }
                }
            } catch (e) { }
            const elFilter = panel.querySelector('#rfq-wiz-filter');
            const elShowAll = panel.querySelector('#rfq-wiz-show-all');
            const elItems = panel.querySelector('#rfq-wiz-items');
            const elSummary = panel.querySelector('#rfq-wiz-summary');
            const elSelectedCount = panel.querySelector('#rfq-wiz-selected-count');
            const elSelected = panel.querySelector('#rfq-wiz-selected');
            const btnDraft = panel.querySelector('#rfq-wiz-create-draft');
            const btnSent = panel.querySelector('#rfq-wiz-create-sent');

            // Supplier name helper (must be hoisted - used by window.__RFQ_WIZ_UPDATE_UI)
            function getSupplierName() {
                try {
                    const mEl = elManual || (panel && panel.querySelector ? panel.querySelector('#rfq-wiz-supplier-manual') : null) || document.getElementById('rfq-wiz-supplier-manual');
                    const sEl = elSel || (panel && panel.querySelector ? panel.querySelector('#rfq-wiz-supplier') : null) || document.getElementById('rfq-wiz-supplier');
                    const manual = String((mEl && mEl.value) || '').trim();
                    const sel = String((sEl && sEl.value) || '').trim();
                    return manual || sel;
                } catch (e) {
                    return '';
                }
            }

            // Supplier match helper (prevents wizard breakage if supplierRecMatches is missing)
            function supplierRecMatchesSafe(project, rec, supplierName) {
                try {
                    if (typeof supplierRecMatches === 'function') {
                        return !!supplierRecMatches(project, rec, supplierName);
                    }
                } catch (e) { }
                const norm = (v) => String(v || '').trim().toLowerCase();
                const target = norm(supplierName);
                if (!target || !rec) return false;
                const name = rec.name || rec.supplier_name || rec.supplier || rec.supplier_id || '';
                return norm(name) === target;
            }

            // Robust Wizard UI updater (does not rely on inner closures; survives re-renders)
            window.__RFQ_WIZ_UPDATE_UI = function () {
                try {
                    const selSet = window.__RFQ_WIZ_SELECTED || selectedDNsState || new Set();
                    const count = selSet.size;

                    if (elSummary) elSummary.textContent = `${count} item(s) selected`;
                    if (elSelectedCount) elSelectedCount.textContent = String(count);

                    // Chips
                    if (elSelected) {
                        const arr = Array.from(selSet).map(x => String(x || '').trim()).filter(Boolean).sort((a, b) => a.localeCompare(b));
                        if (arr.length === 0) {
                            elSelected.innerHTML = '<div class="qt-empty" style="padding:14px 0;">No items selected</div>';
                        } else {
                            elSelected.innerHTML = arr.map(dn => {
                                const enc = encodeURIComponent(dn);
                                return `<span class="qt-chip">${escapeHtml(dn)} <button type="button" data-action="rfq-wiz-remove" data-dn-enc="${enc}" title="Remove">‚úï</button></span>`;
                            }).join('');
                        }
                    }

                    // Sync visible checkboxes + row highlight to Set
                    try {
                        const root = panel.querySelector('#rfq-wiz-items');
                        if (root) {
                            root.querySelectorAll('input[type="checkbox"][data-dn-enc]').forEach(cb => {
                                const enc = cb.getAttribute('data-dn-enc') || '';
                                let dn = '';
                                try { dn = decodeURIComponent(enc); } catch (e) { dn = enc; }
                                dn = String(dn || '').trim();
                                const should = !!dn && selSet.has(dn);
                                cb.checked = should;
                                const tr = cb.closest ? cb.closest('tr') : null;
                                if (tr) tr.classList.toggle('rfq-wiz-selected', should);
                            });
                        }
                    } catch (e) { }

                    const supplierOk = !!getSupplierName();
                    setRFQWizardBtnState(btnDraft, !(count > 0 && supplierOk));
                    setRFQWizardBtnState(btnSent, !(count > 0 && supplierOk));
                } catch (e) {
                    console.error('RFQ wizard update UI failed', e);
                }
            };


            const setRFQWizardBtnState = (btn, disabled) => {
                if (!btn) return;
                if (disabled) {
                    btn.dataset.disabled = '1';
                    btn.classList.add('rfq-disabled');
                    btn.setAttribute('aria-disabled', 'true');
                } else {
                    btn.dataset.disabled = '0';
                    btn.classList.remove('rfq-disabled');
                    btn.removeAttribute('aria-disabled');
                }
            };


            panel.querySelector('#rfq-wiz-cancel').onclick = resetRFQWizard;

            // Close button handler (hides wizard overlay)
            const closeBtn = panel.querySelector('#rfq-wiz-close');
            if (closeBtn) {
                closeBtn.onclick = function () {
                    panel.classList.add('hidden');
                    panel.innerHTML = '';
                };
            }
            // Remove chip handler (updates Set + checkbox)
            if (!panel.__rfqWizChipBound) {
                panel.__rfqWizChipBound = true;
                panel.addEventListener('click', function (ev) {
                    const t = ev.target;
                    if (!t) return;
                    const act = t.getAttribute && t.getAttribute('data-action');
                    if (act !== 'rfq-wiz-remove') return;
                    ev.preventDefault();
                    const enc = t.getAttribute('data-dn-enc') || '';
                    let dn = '';
                    try { dn = decodeURIComponent(enc); } catch (e) { dn = enc; }
                    dn = String(dn || '').trim();
                    if (!dn) return;
                    const selSet = window.__RFQ_WIZ_SELECTED || selectedDNsState || new Set();
                    selSet.delete(dn);
                    window.__RFQ_WIZ_SELECTED = selSet;

                    // uncheck in table if visible
                    const cb = panel.querySelector(`input[type="checkbox"][data-dn-enc="${encodeURIComponent(dn)}"]`);
                    if (cb) {
                        cb.checked = false;
                        const tr = cb.closest ? cb.closest('tr') : null;
                        if (tr) tr.classList.remove('rfq-wiz-selected');
                    }
                    if (typeof window.__RFQ_WIZ_UPDATE_UI === 'function') window.__RFQ_WIZ_UPDATE_UI();
                }, true);
            }

            const _wizGet = (it, keys) => {
                for (const k of keys) {
                    const v = it ? it[k] : '';
                    if (v !== undefined && v !== null && String(v).trim() !== '') return v;
                }
                return '';
            };
            const wizGetDN = (it) => String(_wizGet(it, [
                'item_drawing_no', 'drawing_no', 'drawing', 'dn',
                'part_no', 'part_number', 'item_no',
                'Drawing No', 'Drawing No.', 'DrawingNo', 'Drawing Number', 'drawing number',
                'Part No', 'Part No.', 'PartNo',
                'Item No', 'Item No.', 'Item', 'ITEM',
                'MPN', 'mfg_part_no', 'mfr_part_no'
            ]) || '').trim();
            const wizGetDesc = (it) => String(_wizGet(it, ['description', 'desc', 'item_description', 'name']) || '').trim();
            const wizGetMPN = (it) => String(_wizGet(it, ['mpn', 'manufacturer_part_no', 'mfg_part_no', 'part_no', 'part_number']) || '').trim();
            const wizGetMfr = (it) => String(_wizGet(it, ['manufacturer', 'mfr', 'mfg', 'brand']) || '').trim();

            const itemMatches = (it, q) => {
                if (!q) return true;
                const qq = String(q || '').toLowerCase();
                const hay = [
                    wizGetDN(it),
                    wizGetDesc(it),
                    wizGetMPN(it),
                    wizGetMfr(it)
                ].map(x => String(x || '').toLowerCase()).join(' | ');
                return hay.includes(qq);
            };

            const getCandidateItems = (supplierName) => {
                const all = (currentProject && (currentProject.items || (currentProject.data && currentProject.data.items) || (currentProject.payload && currentProject.payload.items))) || [];
                if (elShowAll && elShowAll.checked) return all;

                // Default: show only items where this supplier exists as a target (any status) OR preselected items
                return all.filter(it => {
                    const dn = wizGetDN(it);
                    if (dnSet.has(dn)) return true;
                    const sList = Array.isArray(it.suppliers) ? it.suppliers : [];
                    return sList.some(s => supplierRecMatchesSafe(currentProject, s, supplierName));
                });
            };

            const renderItems = () => {
                try {
                    const supplierName = String(getSupplierName() || '').trim();
                    const q = String((elFilter && elFilter.value) || '').trim();
                    const showAll = !!(elShowAll && elShowAll.checked);

                    if (!supplierName && !showAll) {
                        elItems.innerHTML = '<div style="text-align:center; color:#999; padding: 40px 12px;">Select a supplier (or type one) to load items</div>';
                        if (elSummary) elSummary.textContent = '0 items selected';
                        setRFQWizardBtnState(btnDraft, true);
                        setRFQWizardBtnState(btnSent, true);
                        return;
                    }

                    const allItems = (currentProject && (currentProject.items || (currentProject.data && currentProject.data.items) || (currentProject.payload && currentProject.payload.items))) || [];
                    const candidates = (getCandidateItems(supplierName) || []).filter(it => itemMatches(it, q));

                    // If supplier is chosen but no targeted items exist, automatically fall back to Show All
                    if (candidates.length === 0 && supplierName && !showAll && allItems.length > 0) {
                        if (elShowAll) elShowAll.checked = true;
                        return renderItems();
                    }
                    // Reset/seed selection when supplier changes

                    if (supplierName !== lastSupplierName) {

                        selectedDNsState.clear();

                        // keep explicit preselection

                        dnSet.forEach(x => { if (x) selectedDNsState.add(String(x).trim()); });

                        seededPlanned = false;

                        lastSupplierName = supplierName;

                    }

                    // Seed: items that are Planned for this supplier (only once per supplier selection)

                    if (!seededPlanned) {


                        (allItems || []).forEach(it => {
                            const dn = wizGetDN(it);
                            const planned = (it.suppliers || []).some(s => {
                                if (!s) return false;
                                const st = String(s.status || s.target_status || '').trim().toLowerCase();
                                if (st !== 'planned') return false;
                                try { return supplierRecMatchesSafe(currentProject, s, supplierName); } catch (e) { return false; }
                            });
                            if (planned && dn) selectedDNsState.add(String(dn).trim());
                        });
                        seededPlanned = true;

                    }
                    const updateButtons = () => {
                        const count = selectedDNsState.size;
                        if (elSummary) elSummary.textContent = `${count} item(s) selected`;
                        if (elSelectedCount) elSelectedCount.textContent = String(count);

                        if (elSelected) {
                            const arr = Array.from(selectedDNsState).map(x => String(x || '').trim()).filter(Boolean).sort((a, b) => a.localeCompare(b));
                            if (arr.length === 0) {
                                elSelected.innerHTML = '<div class="qt-empty" style="padding:14px 0;">No items selected</div>';
                            } else {
                                elSelected.innerHTML = arr.map(dn => {
                                    const enc = encodeURIComponent(dn);
                                    return `<span class="qt-chip">${escapeHtml(dn)} <button type="button" data-action="rfq-wiz-remove" data-dn-enc="${enc}" title="Remove">‚úï</button></span>`;
                                }).join('');
                            }
                        }

                        setRFQWizardBtnState(btnDraft, !(count > 0 && !!getSupplierName()));
                        setRFQWizardBtnState(btnSent, !(count > 0 && !!getSupplierName()));
                    };

                    elItems.innerHTML = `
                    <table class="rfq-table" style="width:100%;">
                        <thead>
                            <tr>
                                <th style="width:42px;"></th>
                                <th style="width:130px;">Item</th>
                                <th>Description</th>
                                <th style="width:80px;">Qty</th>
                                <th style="width:70px;">MOQ</th>
                                <th style="width:70px;">LT</th>
                                <th style="width:90px;">Price</th>
                                <th style="width:70px;">Curr</th>
                                <th style="width:120px;">Target status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${candidates.map((it, idx) => {
                        const dnRaw = wizGetDN(it);
                        const dn = dnRaw || String(it && (it.id || it.item_id || it.line_id) ? (it.id || it.item_id || it.line_id) : `IDX-${idx + 1}`);
                        const qty = it.qty_1 ?? '';
                        let sup = null;
                        try { sup = (it.suppliers || []).find(s => supplierRecMatchesSafe(currentProject, s, supplierName)); } catch (e) { sup = null; }
                        const status = sup ? (sup.status || sup.target_status || 'Planned') : 'Not targeted';
                        const checked = selectedDNsState.has(dn) ? 'checked' : '';
                        const moq = sup ? (sup.moq || '') : '';
                        const lt = sup ? (sup.lead_time_days || sup.lead_time || '') : '';
                        const price = sup ? (sup.unit_price || sup.price || sup.price_1 || '') : '';
                        const curr = sup ? (sup.currency || sup.curr || '') : '';
                        return `
                                    <tr class="${selectedDNsState.has(dn) ? 'rfq-wiz-selected' : ''}">
                                        <td><input type="checkbox" data-dn-enc="${encodeURIComponent(dn)}" ${checked}></td>
                                        <td><b>${escapeHtml(dn)}</b></td>
                                        <td style="font-size:12px;">${escapeHtml(it.description || '')}</td>
                                        <td>${escapeHtml(String(qty))}</td>
                                        <td>${escapeHtml(String(moq))}</td>
                                        <td>${escapeHtml(String(lt))}</td>
                                        <td>${escapeHtml(String(price))}</td>
                                        <td>${escapeHtml(String(curr))}</td>
                                        <td>${escapeHtml(String(status))}</td>
                                    </tr>
                                `;
                    }).join('')}
                        </tbody>
                    </table>
                    ${candidates.length === 0 ? `<div style="text-align:center; color:#999; padding: 18px 12px;">No items match the current selection</div>` : ''}
                `;                // Selection handlers (delegated) - survives re-renders and avoids per-row listener loss
                    if (!panel.__rfqWizSelectionBound) {
                        panel.__rfqWizSelectionBound = true;

                        // Checkbox change updates the state Set (selectedDNsState)
                        panel.addEventListener('change', (ev) => {
                            const t = ev.target;
                            if (!t || String(t.tagName || '').toLowerCase() !== 'input') return;
                            if (String(t.type || '').toLowerCase() !== 'checkbox') return;
                            const enc = t.getAttribute('data-dn-enc');
                            if (!enc) return;

                            let dn = '';
                            try { dn = decodeURIComponent(String(enc).trim()); } catch (e) { dn = String(enc).trim(); }
                            dn = String(dn || '').trim();
                            if (!dn) return;

                            const selSet = window.__RFQ_WIZ_SELECTED || selectedDNsState || new Set();
                            if (t.checked) selSet.add(dn);
                            else selSet.delete(dn);
                            window.__RFQ_WIZ_SELECTED = selSet;

                            const tr = t.closest ? t.closest('tr') : null;
                            if (tr) tr.classList.toggle('rfq-wiz-selected', !!t.checked);

                            if (typeof window.__RFQ_WIZ_UPDATE_UI === 'function') window.__RFQ_WIZ_UPDATE_UI();
                        }, true);

                        // Clicking a row toggles its checkbox (better UX)
                        panel.addEventListener('click', (ev) => {
                            const t = ev.target;
                            if (!t) return;
                            if (String(t.tagName || '').toLowerCase() === 'input') return;
                            const tr = t.closest ? t.closest('tr') : null;
                            if (!tr) return;
                            const cb = tr.querySelector ? tr.querySelector('input[type="checkbox"][data-dn-enc]') : null;
                            if (!cb) return;
                            cb.checked = !cb.checked;
                            cb.dispatchEvent(new Event('change', { bubbles: true }));
                        });
                    }

                    // Ensure row highlight matches current state after render
                    elItems.querySelectorAll('tr').forEach(tr => {
                        const cb = tr.querySelector ? tr.querySelector('input[type="checkbox"][data-dn-enc]') : null;
                        if (!cb) return;
                        tr.classList.toggle('rfq-wiz-selected', !!cb.checked);
                    });

                    if (typeof window.__RFQ_WIZ_UPDATE_UI === 'function') window.__RFQ_WIZ_UPDATE_UI();
                } catch (e) {
                    console.error('RFQ wizard renderItems failed', e);
                    try {
                        if (elItems) elItems.innerHTML = '<div style="text-align:center; color:#b00; padding: 24px 12px;">Cannot render items (JS error). Open console for details.</div>';
                    } catch (e2) { }
                }
            };

            const refreshFromSupplierInputs = () => {
                // keep select/manual synchronized (manual wins)
                if (String(elManual.value || '').trim()) elSel.value = '';
                renderItems();
            };

            elSel.onchange = () => {
                if (String(elSel.value || '').trim()) elManual.value = String(elSel.value || '').trim();
                renderItems();
            };
            elManual.oninput = refreshFromSupplierInputs;
            if (elFilter) elFilter.oninput = renderItems;
            if (elShowAll) {
                elShowAll.onchange = renderItems;
                elShowAll.onclick = renderItems;
            }

            // Extra safety: sometimes framework re-renders can drop direct handlers.
            // Delegate inside the wizard panel so checkbox and supplier changes always refresh items.
            if (!panel.__rfqWizRefreshDelegated) {
                panel.__rfqWizRefreshDelegated = true;
                panel.addEventListener('change', (ev) => {
                    const t = ev.target;
                    if (!t || !t.id) return;
                    if (t.id === 'rfq-wiz-show-all' || t.id === 'rfq-wiz-supplier') {
                        renderItems();
                    }
                }, true);
                panel.addEventListener('input', (ev) => {
                    const t = ev.target;
                    if (!t || !t.id) return;
                    if (t.id === 'rfq-wiz-supplier-manual' || t.id === 'rfq-wiz-filter') {
                        renderItems();
                    }
                }, true);
            }

            // initial render
            renderItems();
            try { setTimeout(renderItems, 0); setTimeout(renderItems, 200); } catch (e) { }

            const createBundleFromSelection = (markSentAndExport) => {
                try {
                    if (window.__RFQ_CREATE_BUNDLE_LOCK) return;
                    window.__RFQ_CREATE_BUNDLE_LOCK = true;
                    if (!currentProject || !currentProject.id) {
                        showToast('Select a project first (top bar) before creating an RFQ bundle.', 'warning');
                        return;
                    }
                    if (!window.RFQData || typeof window.RFQData.saveRFQBatch !== 'function') {
                        showToast('RFQData not loaded. Please refresh (Ctrl+F5).', 'error');
                        return;
                    }
                    const supplierName = getSupplierName();
                    if (!supplierName) { showToast('Select or type a supplier.', 'warning'); return; }

                    const selectedDNs = Array.from((window.__RFQ_WIZ_SELECTED || selectedDNsState || new Set())).map(x => String(x || '').trim()).filter(Boolean);
                    if (selectedDNs.length === 0) { if (window.showToast) window.showToast('Select at least one item', 'warning'); return; }

                    const qv = (sel, fallback = '') => {
                        const el = panel ? panel.querySelector(sel) : null;
                        if (!el) return fallback;
                        const v = (el.value !== undefined && el.value !== null) ? el.value : fallback;
                        return (v === '' || v === null || v === undefined) ? fallback : v;
                    };

                    const due = qv('#rfq-wiz-due', dueDefault);

                    const incoterms = qv('#rfq-wiz-incoterms', 'EXW');
                    const currency = qv('#rfq-wiz-currency', 'EUR');
                    const rev = String(qv('#rfq-wiz-rev', 'A')).trim() || 'A';
                    const contact = String(qv('#rfq-wiz-contact', '')).trim();
                    const email = String(qv('#rfq-wiz-email', '')).trim();
                    const notes = String(qv('#rfq-wiz-notes', '')).trim();

                    // Ensure supplier records exist on selected items
                    const itemByDn = new Map((currentProject.items || []).map(it => [wizGetDN(it), it]));
                    selectedDNs.forEach(dn => {
                        const it = itemByDn.get(dn);
                        if (!it) return;
                        if (!Array.isArray(it.suppliers)) it.suppliers = [];
                        let sup = it.suppliers.find(s => s && String(s.name || '').trim() === supplierName);
                        if (!sup) {
                            it.suppliers.push({ id: Date.now() + Math.floor(Math.random() * 10000), name: supplierName, status: 'Planned', currency, isMain: false, price: 0, price_1: 0 });
                        }
                    });

                    const batch = {
                        id: Date.now(),
                        created_at: new Date().toISOString(),
                        revision: rev,
                        supplier_name: supplierName,
                        contact_person: contact,
                        contact_email: email,
                        status: markSentAndExport ? 'Sent' : 'Draft',
                        currency,
                        incoterms,
                        due_date: due,
                        notes,
                        items: selectedDNs.map(dn => ({
                            drawing_no: dn,
                            quote_status: 'Requested',
                            price: '',
                            price_1: '',
                            price_2: '',
                            price_3: '',
                            price_4: '',
                            price_5: '',
                            currency,
                            lead_time_days: '',
                            moq: '',
                            mov: '',
                            shipping_cost: '',
                            payment_terms: '',
                            packaging: '',
                            note: '',
                            valid_until: ''
                        }))
                    };


                    // Prefill extra fields from Item ‚Üí Suppliers & Pricing (if available)
                    try {
                        const itemByDn2 = new Map((currentProject.items || []).map(it => [wizGetDN(it), it]));
                        (batch.items || []).forEach(line => {
                            const dn = String(line.drawing_no || '').trim();
                            const it = itemByDn2.get(dn);
                            if (!it) return;
                            const sup = (it.suppliers || []).find(s => s && String(s.name || '').trim() === supplierName) || null;
                            if (!sup) return;
                            if (line.moq === '' || line.moq === null || line.moq === undefined) line.moq = sup.moq || '';
                            if (line.mov === '' || line.mov === null || line.mov === undefined) line.mov = sup.mov || '';
                            if (line.lead_time_days === '' || line.lead_time_days === null || line.lead_time_days === undefined) line.lead_time_days = sup.lead_time_days || sup.lead_time || '';
                            if (line.shipping_cost === '' || line.shipping_cost === null || line.shipping_cost === undefined) line.shipping_cost = sup.shipping || sup.shipping_cost || '';
                            if (line.payment_terms === '' || line.payment_terms === null || line.payment_terms === undefined) line.payment_terms = sup.payment_terms || sup.terms || '';
                            if (line.packaging === '' || line.packaging === null || line.packaging === undefined) line.packaging = sup.packaging || '';
                            if (line.note === '' || line.note === null || line.note === undefined) line.note = sup.note || sup.notes || '';
                        });
                    } catch (e) { }

                    // Persist
                    const saved = window.RFQData.saveRFQBatch(currentProject.id, batch);
                    syncProjectBatchesIntoMemory(currentProject);
                    applyBatchToItems(currentProject, batch, markSentAndExport ? 'sent' : 'save');
                    updateProject(currentProject);
                    renderRFQHistory();

                    // If sent: update target statuses and export
                    if (markSentAndExport) {
                        (currentProject.items || []).forEach(it => {
                            const dn = String(it.item_drawing_no || '').trim();
                            if (!selectedDNs.includes(dn)) return;
                            const sup = (it.suppliers || []).find(s => s && String(s.name || '').trim() === supplierName);
                            if (sup) sup.status = 'RFQ Sent';
                            if (String(it.status || '') === 'New') it.status = 'RFQ Sent';
                        });
                        window.RFQData.updateProject(currentProject);
                        exportBatchCSV(batch);
                    }

                    // Open detail
                    openBundleDetailPage((saved && saved.id) ? saved.id : batch.id, 'quoting');
                } catch (err) {
                    console.error('Create RFQ bundle failed', err);
                    showToast('Create bundle failed: ' + (err && err.message ? err.message : String(err)), 'error');
                } finally {
                    window.__RFQ_CREATE_BUNDLE_LOCK = false;
                }
            };

            window.RFQWizardHandlers = {
                _updateButtons: () => { try { if (typeof window.__RFQ_WIZ_UPDATE_UI === 'function') window.__RFQ_WIZ_UPDATE_UI(); } catch (e) { } },
                createDraft: () => createBundleFromSelection(false),
                createSent: () => createBundleFromSelection(true),
                cancel: () => resetRFQWizard()
            };
        }
    }
}


    // =========================================================
    // Global RFQ Wizard event delegation (robust buttons)
    // =========================================================
    ; (function () {
        if (window.__RFQ_WIZ_DELEGATED__) return;
        window.__RFQ_WIZ_DELEGATED__ = true;

        // Selection delegation for RFQ wizard items (robust across re-renders)
        if (!window.__RFQ_WIZ_SELECTION_DELEGATED__) {
            window.__RFQ_WIZ_SELECTION_DELEGATED__ = true;

            // checkbox change inside wizard item list
            document.addEventListener('change', function (ev) {
                const t = ev.target;
                if (!t) return;
                if (String(t.tagName || '').toLowerCase() !== 'input') return;
                if (String(t.type || '').toLowerCase() !== 'checkbox') return;
                const enc = t.getAttribute('data-dn-enc');
                if (!enc) return;
                // only handle inside wizard list
                const root = t.closest ? t.closest('#rfq-wiz-items') : null;
                if (!root) return;

                let dn = '';
                try { dn = decodeURIComponent(String(enc).trim()); } catch (e) { dn = String(enc).trim(); }
                dn = String(dn || '').trim();
                if (!dn) return;

                window.__RFQ_WIZ_SELECTED = window.__RFQ_WIZ_SELECTED || new Set();
                if (t.checked) window.__RFQ_WIZ_SELECTED.add(dn);
                else window.__RFQ_WIZ_SELECTED.delete(dn);

                const tr = t.closest ? t.closest('tr') : null;
                if (tr) tr.classList.toggle('rfq-wiz-selected', !!t.checked);

                // update wizard UI consistently even after re-renders
                if (window.RFQWizardHandlers && typeof window.RFQWizardHandlers._updateButtons === 'function') {
                    try { window.RFQWizardHandlers._updateButtons(); } catch (e) { }
                }
                if (typeof window.__RFQ_WIZ_UPDATE_UI === 'function') {
                    try { window.__RFQ_WIZ_UPDATE_UI(); } catch (e) { }
                }
            }, true);

            // click row toggles checkbox
            document.addEventListener('click', function (ev) {
                const t = ev.target;
                if (!t) return;
                const itemsRoot = t.closest ? t.closest('#rfq-wiz-items') : null;
                if (!itemsRoot) return;
                if (String(t.tagName || '').toLowerCase() === 'input') return;
                const tr = t.closest ? t.closest('tr') : null;
                if (!tr) return;
                const cb = tr.querySelector ? tr.querySelector('input[type="checkbox"][data-dn-enc]') : null;
                if (!cb) return;
                cb.checked = !cb.checked;
                cb.dispatchEvent(new Event('change', { bubbles: true }));
            }, false);
        }

        document.addEventListener('click', function (e) {
            const btn = e.target && e.target.closest ? e.target.closest('[data-rfq-action]') : null;
            if (!btn) return;
            const act = String(btn.getAttribute('data-rfq-action') || '');
            if (!act) return;
            if (String(btn.dataset.disabled || '') === '1' || btn.getAttribute('aria-disabled') === 'true') {
                e.preventDefault();
                showToast('Select at least one item to create an RFQ bundle.', 'warning');
                return;
            }
            const h = window.RFQWizardHandlers || {};
            if (act === 'wiz-create-draft' && typeof h.createDraft === 'function') {
                e.preventDefault();
                h.createDraft();
            } else if (act === 'wiz-create-sent' && typeof h.createSent === 'function') {
                e.preventDefault();
                h.createSent();
            }
        }, true);
    })();



// Standalone mount helper (no window manager required)
window.RFQStandalone = window.RFQStandalone || {};
window.RFQStandalone.mount = function (rootSelectorOrEl) {
    const root = typeof rootSelectorOrEl === 'string'
        ? document.querySelector(rootSelectorOrEl)
        : rootSelectorOrEl;
    if (!root) return;
    if (!window.SystemApps || !window.SystemApps.rfq) return;
    root.innerHTML = window.SystemApps.rfq.render();
    window.SystemApps.rfq.init(root);
};



/* ===================== v58 Deep Wizard Stability Patch (plus DATA Manager) ===================== */
(function () {
    try { window.__RFQ_BUILD_VERSION__ = 'v64_4'; } catch (e) { }
    // Guard: only patch once
    if (window.__RFQ_V58_WIZ_PATCH__) return;
    window.__RFQ_V58_WIZ_PATCH__ = true;

    function safeStr(x) { return (x === null || x === undefined) ? '' : String(x); }

    // Robustly resolve current project (wizard should always have items from a real project)
    function resolveWizardProject() {
        try {
            const st = window.__RFQ_WIZ_STATE__ || {};
            const pid = st.projectId || (typeof currentProject !== 'undefined' && currentProject ? currentProject.id : null);
            if (pid && window.RFQData && typeof window.RFQData.getProjects === 'function') {
                const ps = window.RFQData.getProjects();
                const p = ps.find(pp => String(pp.id) === String(pid));
                if (p) return p;
            }
        } catch (e) { }
        try { if (typeof currentProject !== 'undefined' && currentProject) return currentProject; } catch (e) { }
        return null;
    }

    function getWizardEls() {
        const panel = document.getElementById('rfq-bundle-wizard');
        if (!panel) return null;
        return {
            panel,
            supplier: panel.querySelector('#rfq-wiz-supplier'),
            supplierText: panel.querySelector('#rfq-wiz-supplier-text'),
            showAll: panel.querySelector('#rfq-wiz-show-all'),
            filter: panel.querySelector('#rfq-wiz-filter'),
            itemsRoot: panel.querySelector('#rfq-wiz-items'),
            summary: panel.querySelector('#rfq-wiz-summary'),
            btnDraft: panel.querySelector('#rfq-wiz-create-draft'),
            btnSent: panel.querySelector('#rfq-wiz-create-sent'),
            debug: panel.querySelector('#rfq-wiz-debug')
        };
    }

    function wizGet(it, keys) {
        for (const k of keys) {
            if (!k) continue;
            const v = it && it[k];
            if (v !== undefined && v !== null && String(v).trim() !== '') return v;
        }
        return '';
    }

    function wizDN(it) {
        return safeStr(wizGet(it, ['item_drawing_no', 'drawing_no', 'drawing', 'dn', 'part_no', 'part_number', 'item_no', 'mpn', 'mfg_part_no', 'mfr_part_no'])).trim();
    }
    function wizDesc(it) {
        return safeStr(wizGet(it, ['description', 'desc', 'item_description', 'name'])).trim();
    }
    function wizMPN(it) {
        return safeStr(wizGet(it, ['mpn', 'mfg_part_no', 'mfr_part_no', 'manufacturer_part', 'part_no', 'part_number'])).trim();
    }
    function wizMfr(it) {
        return safeStr(wizGet(it, ['manufacturer', 'mfr', 'brand', 'mfg'])).trim();
    }

    function supplierNameFromUI(els) {
        const sel = els.supplier;
        const txt = els.supplierText;
        const a = sel ? safeStr(sel.value).trim() : '';
        const b = txt ? safeStr(txt.value).trim() : '';
        return b || a;
    }

    function ensureState() {
        window.__RFQ_WIZ_STATE__ = window.__RFQ_WIZ_STATE__ || { projectId: null, selected: [] };
        const st = window.__RFQ_WIZ_STATE__;
        const p = resolveWizardProject();
        if (p && !st.projectId) st.projectId = p.id;
        if (!Array.isArray(st.selected)) st.selected = [];
        return st;
    }

    function getSelectedSet() {
        const st = ensureState();
        if (!st._set || !(st._set instanceof Set)) st._set = new Set(st.selected.map(x => safeStr(x).trim()).filter(Boolean));
        return st._set;
    }

    function persistSelectedSet() {
        const st = ensureState();
        const set = getSelectedSet();
        st.selected = Array.from(set);
    }

    function setBtnEnabled(btn, enabled) {
        if (!btn) return;
        // do not use true disabled (it looks dead). Keep clickable with explanation in handler.
        btn.setAttribute('data-disabled', enabled ? '0' : '1');
        btn.classList.toggle('is-disabled', !enabled);
    }

    function renderWizardItems(forceReason) {
        const els = getWizardEls();
        if (!els || !els.itemsRoot) return;

        const st = ensureState();
        const proj = resolveWizardProject();
        const items = proj && Array.isArray(proj.items) ? proj.items : [];

        const supplierName = supplierNameFromUI(els);
        const showAll = !!(els.showAll && els.showAll.checked);
        const q = safeStr(els.filter ? els.filter.value : '').trim().toLowerCase();

        st.supplier = supplierName;
        st.showAll = showAll;
        st.filter = q;

        const selectedSet = getSelectedSet();

        // Candidate items
        let candidates = items;
        if (!supplierName) {
            els.itemsRoot.innerHTML = '<div style="text-align:center; color:#999; padding: 40px 12px;">Select a supplier (or type one) to load items</div>';
            if (els.summary) els.summary.textContent = selectedSet.size + ' items selected';
            setBtnEnabled(els.btnDraft, false);
            setBtnEnabled(els.btnSent, false);
            if (els.debug) els.debug.textContent = '';
            return;
        }

        if (!showAll) {
            candidates = items.filter(it => {
                const dn = wizDN(it);
                if (selectedSet.has(dn)) return true;
                const sList = Array.isArray(it.suppliers) ? it.suppliers : [];
                // match by name OR by supplier_id (compat)
                return sList.some(s => s && (safeStr(s.name).trim() === supplierName || safeStr(s.supplier_id).trim() === supplierName));
            });
        }

        if (q) {
            candidates = candidates.filter(it => {
                const hay = (wizDN(it) + ' | ' + wizDesc(it) + ' | ' + wizMPN(it) + ' | ' + wizMfr(it)).toLowerCase();
                return hay.includes(q);
            });
        }

        // Render table (always)
        const rows = candidates.map(it => {
            const dn = wizDN(it);
            const qty = (it && (it.qty_1 ?? it.qty ?? '')) ?? '';
            const checked = selectedSet.has(dn);
            const trClass = checked ? 'rfq-wiz-selected' : '';
            const enc = encodeURIComponent(dn);
            return `
        <tr class="${trClass}" data-dn-enc="${enc}">
          <td><input type="checkbox" data-dn-enc="${enc}" ${checked ? 'checked' : ''}></td>
          <td><b>${escapeHtml(dn)}</b></td>
          <td style="font-size:12px;">${escapeHtml(wizDesc(it))}</td>
          <td>${escapeHtml(String(qty))}</td>
          <td>${escapeHtml(wizMfr(it))}</td>
          <td>${escapeHtml(wizMPN(it))}</td>
        </tr>
      `;
        }).join('');

        els.itemsRoot.innerHTML = `
      <table class="macos-table" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="width:38px;"></th>
            <th style="width:140px;">Item</th>
            <th>Description</th>
            <th style="width:80px;">Qty</th>
            <th style="width:120px;">Mfr</th>
            <th style="width:160px;">MPN</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      ${candidates.length === 0 ? '<div style="text-align:center; color:#999; padding:18px 12px;">No items match the current selection</div>' : ''}
    `;

        if (els.summary) els.summary.textContent = selectedSet.size + ' selected | Items: ' + items.length + ' | View: ' + candidates.length;

        const canCreate = supplierName && selectedSet.size > 0;
        setBtnEnabled(els.btnDraft, canCreate);
        setBtnEnabled(els.btnSent, canCreate);

        if (els.debug) {
            els.debug.textContent = `Project items: ${items.length} | Candidates: ${candidates.length} | Selected: ${selectedSet.size}` + (forceReason ? ` | ${forceReason}` : '');
        }
    }

    // Global delegation for wizard selection & controls (works even if wizard re-renders)
    if (!window.__RFQ_V56_WIZ_DELEGATED__) {
        window.__RFQ_V56_WIZ_DELEGATED__ = true;

        document.addEventListener('change', function (ev) {
            const t = ev.target;
            if (!t) return;
            const panel = t.closest ? t.closest('#rfq-bundle-wizard') : null;
            if (!panel) return;

            // Supplier change / show all / filter change -> re-render
            const id = t.id ? String(t.id) : '';
            if (id === 'rfq-wiz-supplier' || id === 'rfq-wiz-supplier-text' || id === 'rfq-wiz-show-all' || id === 'rfq-wiz-filter') {
                // If supplier selected and items list empty, force showAll to avoid "nothing" confusion
                try {
                    if (id === 'rfq-wiz-supplier' || id === 'rfq-wiz-supplier-text') {
                        const els = getWizardEls();
                        if (els && els.showAll && els.itemsRoot) {
                            // if no candidates under targets, user can still see all quickly
                            // (we do not auto-toggle here, just re-render)
                        }
                    }
                } catch (e) { }
                renderWizardItems('ui-change');
                return;
            }

            // Checkbox item selection
            if (String(t.tagName || '').toLowerCase() === 'input' && String(t.type || '').toLowerCase() === 'checkbox') {
                const enc = t.getAttribute('data-dn-enc');
                if (!enc) return;
                // only handle inside rfq-wiz-items
                const root = t.closest ? t.closest('#rfq-wiz-items') : null;
                if (!root) return;
                const dn = decodeURIComponent(enc);
                const set = getSelectedSet();
                if (t.checked) set.add(dn);
                else set.delete(dn);
                persistSelectedSet();
                // reflect row highlight
                try {
                    const tr = t.closest ? t.closest('tr') : null;
                    if (tr) tr.classList.toggle('rfq-wiz-selected', t.checked);
                } catch (e) { }
                renderWizardItems('selection');
            }
        }, true);

        // Click row toggles checkbox
        document.addEventListener('click', function (ev) {
            const t = ev.target;
            if (!t) return;
            const itemsRoot = t.closest ? t.closest('#rfq-wiz-items') : null;
            if (!itemsRoot) return;
            if (String(t.tagName || '').toLowerCase() === 'input') return;
            const tr = t.closest ? t.closest('tr[data-dn-enc]') : null;
            if (!tr) return;
            const cb = tr.querySelector ? tr.querySelector('input[type="checkbox"][data-dn-enc]') : null;
            if (!cb) return;
            cb.checked = !cb.checked;
            cb.dispatchEvent(new Event('change', { bubbles: true }));
        }, false);

        // Create buttons
        document.addEventListener('click', function (ev) {
            const btn = ev.target && ev.target.closest ? ev.target.closest('[data-rfq-action]') : null;
            if (!btn) return;
            const act = String(btn.getAttribute('data-rfq-action') || '');
            if (act !== 'wiz-create-draft' && act !== 'wiz-create-sent') return;

            const els = getWizardEls();
            const supplierName = els ? supplierNameFromUI(els) : '';
            const selectedSet = getSelectedSet();

            // validations with clear message
            if (!supplierName) { ev.preventDefault(); showToast('Select a supplier.', 'warning'); return; }
            if (selectedSet.size === 0) { ev.preventDefault(); if (window.showToast) window.showToast('Select at least one item', 'warning'); return; }

            // allow existing handlers to run
            try {
                if (window.RFQWizardHandlers) {
                    if (act === 'wiz-create-draft' && typeof window.RFQWizardHandlers.createDraft === 'function') {
                        ev.preventDefault();
                        window.RFQWizardHandlers.createDraft();
                    } else if (act === 'wiz-create-sent' && typeof window.RFQWizardHandlers.createSent === 'function') {
                        ev.preventDefault();
                        window.RFQWizardHandlers.createSent();
                    }
                }
            } catch (e) {
                console.error(e);
                showToast('Create bundle failed: ' + (e && e.message ? e.message : String(e)), 'error');
            }
        }, true);
    }

    // Patch startRFQWizard to store stable project id and force an initial render
    if (typeof startRFQWizard === 'function' && !startRFQWizard.__v56Patched) {
        const _orig = startRFQWizard;
        const wrapped = function (preselectedSupplierName = null, preselectedItemDNs = []) {
            // ensure state before original wizard builds
            try {
                const st = ensureState();
                const p = resolveWizardProject();
                if (p) st.projectId = p.id;
                const set = getSelectedSet();
                (Array.isArray(preselectedItemDNs) ? preselectedItemDNs : []).map(x => safeStr(x).trim()).filter(Boolean).forEach(dn => set.add(dn));
                persistSelectedSet();
                st.supplier = preselectedSupplierName ? safeStr(preselectedSupplierName).trim() : (st.supplier || '');
            } catch (e) { }
            const res = _orig(preselectedSupplierName, preselectedItemDNs);
            // force render after DOM is there
            try {
                requestAnimationFrame(() => { renderWizardItems('init'); });
                setTimeout(() => { renderWizardItems('init+150ms'); }, 150);
            } catch (e) { }
            return res;
        };
        wrapped.__v56Patched = true;
        // overwrite
        try { startRFQWizard = wrapped; } catch (e) { }
    }

})();

// ===== RFQ_BULK_UPLOAD_DELEGATION (safety) =====
(function () {
    try {
        document.addEventListener('click', function (ev) {
            const t = ev.target;
            if (!t) return;
            if (t.id === 'btn-upload-bulk-quote') {
                // if normal handler is attached, let it run
                // but if button is disabled due to layout bugs, provide guidance
                if (t.disabled) {
                    const sel = document.getElementById('bulk-supplier-select');
                    const name = sel ? String(sel.value || '').trim() : '';
                    if (!name) if (window.showToast) window.showToast('Select supplier first', 'warning');
                }
            }
        }, true);
    } catch (e) { }
})();





/* ===================== Detail Buttons Delegation Patch (v64_4) ===================== */
(function () {
    try { if (window.__RFQ_DETAIL_DELEGATES__) return; window.__RFQ_DETAIL_DELEGATES__ = true; } catch (e) { }

    function getBtn(target) {
        try { return target && target.closest ? target.closest('button') : null; } catch (e) { return null; }
    }

    function safeCall(fn, arg) {
        try { if (typeof fn === 'function') fn(arg); } catch (e) { console.error(e); }
    }

    document.addEventListener('click', function (ev) {
        const b = getBtn(ev.target) || ev.target;
        const id = b && b.id ? String(b.id) : '';
        if (!id) return;

        // Item Detail buttons
        if (id === 'btn-item-detail-save-back') { ev.preventDefault(); safeCall(window.handleUlo≈æitDetail, true); return; }
        if (id === 'btn-item-detail-save') { ev.preventDefault(); safeCall(window.handleUlo≈æitDetail, false); return; }
        if (id === 'btn-item-detail-back') { ev.preventDefault(); safeCall(window.closeDetailWindow); return; }

        // Supplier Detail buttons - trigger content buttons
        if (id === 'btn-supplier-detail-save-back') {
            ev.preventDefault();
            const btn = document.querySelector('#sd-save-close');
            if (btn) btn.click();
            return;
        }
        if (id === 'btn-supplier-detail-save') {
            ev.preventDefault();
            const btn = document.querySelector('#sd-save');
            if (btn) btn.click();
            return;
        }
        if (id === 'btn-supplier-detail-back') {
            ev.preventDefault();
            const btn = document.querySelector('#sd-close');
            if (btn) btn.click();
            return;
        }
        if (id === 'btn-supplier-detail-delete') {
            ev.preventDefault();
            if (typeof window.deleteCurrentSupplier === 'function') {
                window.deleteCurrentSupplier();
            }
            return;
        }

        // Legacy overlay buttons
        if (id === 'btn-save-detail') { ev.preventDefault(); safeCall(window.handleUlo≈æitDetail, true); return; }
        if (id === 'btn-save-detail-no-close') { ev.preventDefault(); safeCall(window.handleUlo≈æitDetail, false); return; }
        if (id === 'btn-close-detail-window') { ev.preventDefault(); safeCall(window.closeDetailWindow); return; }

        // Main tab Actions buttons
        if (id === 'btn-main-refresh') {
            ev.preventDefault();
            if (typeof window.renderMainOverview === 'function') {
                try { window.renderMainOverview(); } catch (e) { console.error('Main refresh error:', e); }
            }
            return;
        }
        if (id === 'btn-main-export') {
            ev.preventDefault();
            if (typeof window.exportMainProjectsCSV === 'function') {
                try { window.exportMainProjectsCSV(); } catch (e) { console.error('Main export error:', e); }
            }
            return;
        }
        if (id === 'btn-main-new-project') {
            ev.preventDefault();
            if (typeof window.openNewProjectModal === 'function') {
                try { window.openNewProjectModal(); } catch (e) { console.error('New project error:', e); }
            }
            return;
        }
    }, true);
})();


// =========================================================
// SIGNED DOCUMENT MANAGEMENT
// =========================================================

// Main entry point for adding a document
window.openAddSignedDocumentModal = function (supplier) {
    const escapeHtml = (text) => text ? String(text).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' })[m]) : '';

    // If no supplier provided (global button), try to get from state
    if (!supplier && window.fsState && window.fsState.selectedSupplier) {
        supplier = window.fsState.selectedSupplier;
    }

    if (!supplier) {
        if (window.showToast) window.showToast('Please select a supplier first\n(Click a supplier card on the left)', 'warning');
        return;
    }

    const modal = document.createElement('div');
    modal.id = 'signed-doc-modal';
    modal.className = 'rfq-modal-overlay';
    modal.innerHTML = `
        <div class="rfq-modal-content" style="max-width:500px;">
            <div class="rfq-modal-header">
                <h3 style="margin:0;">üìÇ Add Document</h3>
                <button onclick="document.getElementById('signed-doc-modal').remove()" class="rfq-btn-close">&times;</button>
            </div>
            <div style="padding:20px;">
                <div style="background: #f8fafc; padding: 10px; border-radius: 6px; margin-bottom: 16px; border: 1px solid #e2e8f0;">
                    <span style="font-size: 11px; color: #64748b; font-weight: 600; text-transform: uppercase;">Supplier</span>
                    <div style="font-weight: 700; color: #0f172a;">${escapeHtml(supplier)}</div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom:12px;">
                    <div>
                        <label class="rfq-label">Document Type</label>
                        <select id="doc-type" class="rfq-input" style="width:100%;">
                            <option value="Quote">Final Quote</option>
                            <option value="Contract">Supply Contract</option>
                            <option value="NDA">NDA</option>
                            <option value="LOI">Letter of Intent (LOI)</option>
                            <option value="Invoice">Proforma Invoice</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="rfq-label">Status</label>
                        <select id="doc-status" class="rfq-input" style="width:100%;">
                            <option value="signed">‚úÖ Signed & Valid</option>
                            <option value="received">üì• Received</option>
                            <option value="draft">üìù Draft</option>
                            <option value="expired">‚ö†Ô∏è Expired</option>
                        </select>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom:12px;">
                    <div>
                        <label class="rfq-label">Date Signed / Received</label>
                        <input type="date" id="doc-date" class="rfq-input" style="width:100%;" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    <div>
                        <label class="rfq-label">Expiration Date (Optional)</label>
                        <input type="date" id="doc-expiration" class="rfq-input" style="width:100%;">
                    </div>
                </div>
                
                <div style="margin-bottom:12px;">
                    <label class="rfq-label">Select File (PDF, Office)</label>
                    <input type="file" id="doc-file" class="rfq-input" style="width:100%;" accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg">
                    <div style="font-size:10px; color:#94a3b8; margin-top:4px;">* Metadata only. File storage requires backend.</div>
                </div>

                <div style="margin-bottom:12px;">
                    <label class="rfq-label">Notes</label>
                    <textarea id="doc-notes" class="rfq-input" style="width:100%; min-height:60px;" placeholder="Approval details, notes..."></textarea>
                </div>
            </div>
            <div class="rfq-modal-footer">
                <button onclick="document.getElementById('signed-doc-modal').remove()" class="rfq-btn-secondary">Cancel</button>
                <button onclick="window.saveSignedDocument('${escapeHtml(supplier)}')" class="rfq-btn-primary">Save Document</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
};

window.saveSignedDocument = function (supplier) {
    if (!currentProject) return;

    const fileInput = document.getElementById('doc-file');
    // For demo/prototype, we permit saving without a file if needed, but warning is good
    if (fileInput.files.length === 0) {
        if (window.showToast) window.showToast('Please select a file', 'warning');
        return;
    }

    const type = document.getElementById('doc-type').value;
    const status = document.getElementById('doc-status').value;
    const dateSigned = document.getElementById('doc-date').value;
    const dateExpire = document.getElementById('doc-expiration').value;
    const notes = document.getElementById('doc-notes').value;
    const fileName = fileInput.files[0].name;

    const newDoc = {
        id: 'doc_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
        supplier: supplier,
        name: fileName,
        type: type,
        status: status,
        date_signed: dateSigned,
        date_expiration: dateExpire,
        due_date: dateSigned, // Legacy backup
        notes: notes,
        is_upload: true,
        created: new Date().toISOString()
    };

    if (!Array.isArray(currentProject.final_documents)) {
        currentProject.final_documents = [];
    }

    currentProject.final_documents.push(newDoc);

    // Persist
    if (typeof updateProject === 'function') updateProject(currentProject);

    // Refresh
    window.renderDocumentTracking();
    document.getElementById('signed-doc-modal').remove();

    if (window.showToast) window.showToast('Document saved successfully', 'success');
};

// Deletion logic
window.deleteSignedDocument = async function (docId) {
    if (!currentProject || !currentProject.final_documents) return;

    const confirmed = await window.showConfirmDialog({
        title: 'Delete Document',
        message: 'Are you sure you want to remove this document tracking entry?',
        type: 'danger',
        okText: 'Delete'
    });

    if (!confirmed) return;

    currentProject.final_documents = currentProject.final_documents.filter(d => String(d.id) !== String(docId));

    if (typeof updateProject === 'function') updateProject(currentProject);
    window.renderDocumentTracking(); // Refresh UI
    if (window.showToast) window.showToast('Document removed', 'info');
};

// Edit / View Detail Logic
window.openSignedDocumentDetail = function (docId) {
    if (!currentProject || !currentProject.final_documents) return;
    const doc = currentProject.final_documents.find(d => String(d.id) === String(docId));
    if (!doc) return;

    const escapeHtml = (text) => text ? String(text).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' })[m]) : '';

    // Re-use the existing modal structure but pre-fill and change save handler
    const modal = document.createElement('div');
    modal.id = 'signed-doc-options-modal';
    modal.className = 'rfq-modal-overlay';

    const isExpired = doc.date_expiration ? (new Date(doc.date_expiration) < new Date()) : false;

    modal.innerHTML = `
        <div class="rfq-modal-content" style="max-width:500px;">
            <div class="rfq-modal-header">
                <h3 style="margin:0;">üìÑ Document Details</h3>
                <button onclick="document.getElementById('signed-doc-options-modal').remove()" class="rfq-btn-close">&times;</button>
            </div>
            <div style="padding:20px;">
                <div style="margin-bottom:15px;">
                    <h4 style="margin:0 0 5px 0; font-size:14px;">${escapeHtml(doc.name)}</h4>
                    <div style="font-size:12px; color:#64748b;">
                        Supplier: <b>${escapeHtml(doc.supplier)}</b> &bull; Added: ${new Date(doc.created).toLocaleDateString()}
                    </div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom:12px;">
                    <div>
                        <label class="rfq-label">Status</label>
                        <select id="edit-doc-status" class="rfq-input" style="width:100%;">
                            <option value="signed" ${doc.status === 'signed' ? 'selected' : ''}>‚úÖ Signed & Valid</option>
                            <option value="received" ${doc.status === 'received' ? 'selected' : ''}>üì• Received</option>
                            <option value="draft" ${doc.status === 'draft' ? 'selected' : ''}>üìù Draft</option>
                            <option value="expired" ${doc.status === 'expired' ? 'selected' : ''}>‚ö†Ô∏è Expired</option>
                        </select>
                    </div>
                    <div>
                         <label class="rfq-label">Expiration Date</label>
                         <input type="date" id="edit-doc-exp" class="rfq-input" style="width:100%;" value="${doc.date_expiration || ''}">
                    </div>
                </div>

                <div style="margin-bottom:12px;">
                    <label class="rfq-label">Notes</label>
                    <textarea id="edit-doc-notes" class="rfq-input" style="width:100%; min-height:60px;">${escapeHtml(doc.notes || '')}</textarea>
                </div>
            </div>
            <div class="rfq-modal-footer" style="justify-content: space-between;">
                <button onclick="window.deleteSignedDocument('${doc.id}'); document.getElementById('signed-doc-options-modal').remove();" class="rfq-btn-secondary" style="color: #ef4444; border-color: #fca5a5;">üóëÔ∏è Delete</button>
                <div style="display:flex; gap:8px;">
                     <button onclick="document.getElementById('signed-doc-options-modal').remove()" class="rfq-btn-secondary">Close</button>
                     <button id="btn-update-doc" class="rfq-btn-primary">Update</button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    document.getElementById('btn-update-doc').onclick = function () {
        doc.status = document.getElementById('edit-doc-status').value;
        doc.date_expiration = document.getElementById('edit-doc-exp').value;
        doc.notes = document.getElementById('edit-doc-notes').value;

        if (typeof updateProject === 'function') updateProject(currentProject);
        window.renderDocumentTracking();
        document.getElementById('signed-doc-options-modal').remove();
        if (window.showToast) window.showToast('Updated', 'success');
    };
};


// Render - Minimalist Table View
// Render - Minimalist Table View
window.renderDocumentTracking = function () {
    const container = document.getElementById('fs-doctrack-content');
    if (!container) return;

    // Use currentProject, not supplierGroups (fix data isolation)
    const docs = (typeof currentProject !== 'undefined' && currentProject && Array.isArray(currentProject.final_documents)) ? currentProject.final_documents : [];

    // Sort: Newest first
    const sortedDocs = [...docs].sort((a, b) => new Date(b.created || 0) - new Date(a.created || 0));

    // Header with "Open Manager" button (User Request)
    let html = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
            <h4 style="margin:0; font-size:14px; color:#333;">Synced Documents</h4>
            <button onclick="window.openDocumentManagerModal()" class="rfq-btn-secondary" style="font-size:11px; padding:4px 8px;">‚õ∂ Open Window</button>
        </div>
    `;

    if (sortedDocs.length === 0) {
        html += `
            <div class="empty-state" style="padding: 40px; text-align: center; color: #94a3b8; background: #f8fafc; border-radius: 8px; border: 1px dashed #cbd5e1;">
                <div style="font-size: 24px; margin-bottom: 8px;">üìÇ</div>
                <div style="font-size: 13px; font-weight: 500;">No documents tracked yet</div>
                <div style="font-size: 11px; margin-top: 4px;">Upload signed quotes, contracts, or NDAs here.</div>
            </div>
        `;
        container.innerHTML = html;
        return;
    }

    const escapeHtml = (text) => text ? String(text).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' })[m]) : '';

    const rows = sortedDocs.map(doc => {
        // Status Badge
        let statusBadge = `<span class="rfq-status-badge status-draft">Draft</span>`;
        if (doc.status === 'signed') statusBadge = `<span class="rfq-status-badge status-done">Signed</span>`;
        if (doc.status === 'received') statusBadge = `<span class="rfq-status-badge status-progress">Received</span>`;
        if (doc.status === 'expired') statusBadge = `<span class="rfq-status-badge status-issue">Expired</span>`;

        // Expiration Logic
        let expDateStr = '-';
        if (doc.date_expiration) {
            const exp = new Date(doc.date_expiration);
            const now = new Date();
            const daysLeft = Math.ceil((exp - now) / (1000 * 60 * 60 * 24));

            if (daysLeft < 0) {
                expDateStr = `<span style="color:#ef4444; font-weight:600;">Expired (${exp.toLocaleDateString()})</span>`;
            } else if (daysLeft < 30) {
                expDateStr = `<span style="color:#f59e0b; font-weight:600;">Expiring in ${daysLeft}d</span>`;
            } else {
                expDateStr = exp.toLocaleDateString();
            }
        }

        return `
            <tr onclick="window.openSignedDocumentDetail('${doc.id}')" style="cursor:pointer;" title="Click to view details" class="rfq-table-row">
                <td style="width: 40px; text-align: center; font-size: 16px;">
                    ${doc.name.endsWith('.pdf') ? 'üìï' : (doc.name.endsWith('.xls') || doc.name.endsWith('.xlsx')) ? 'üìó' : 'üìÑ'}
                </td>
                <td>
                    <div style="font-weight: 600; font-size: 13px; color: #1e293b;">${escapeHtml(doc.type || 'Document')}</div>
                    <div style="font-size: 11px; color: #64748b;">${escapeHtml(doc.name)}</div>
                </td>
                <td>
                    <div style="font-weight: 500;">${escapeHtml(doc.supplier)}</div>
                </td>
                <td>${statusBadge}</td>
                <td style="font-size: 12px;">${doc.date_signed ? new Date(doc.date_signed).toLocaleDateString() : '-'}</td>
                <td style="font-size: 12px;">${expDateStr}</td>
                <td style="text-align: right;">
                     <button onclick="event.stopPropagation(); window.showToast('Downloading ${escapeHtml(doc.name)}...', 'info')" class="rfq-btn-icon" title="Download">‚¨áÔ∏è</button>
                </td>
            </tr>
        `;
    }).join('');

    html += `
        <table class="rfq-table" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr>
                    <th></th>
                    <th style="text-align:left;">Document</th>
                    <th style="text-align:left;">Supplier</th>
                    <th style="text-align:left;">Status</th>
                    <th style="text-align:left;">Signed</th>
                    <th style="text-align:left;">Expiration</th>
                    <th style="width: 40px;"></th>
                </tr>
            </thead>
            <tbody>
                ${rows}
            </tbody>
        </table>
    `;

    container.innerHTML = html;
};

// NEW: Document Manager Modal (Requested Window)
window.openDocumentManagerModal = function () {
    const modal = document.createElement('div');
    modal.id = 'doc-manager-modal';
    modal.className = 'rfq-modal-overlay';

    // Create a temporary container for the logic to render into
    const contentId = 'doc-manager-content-' + Date.now();

    modal.innerHTML = `
        <div class="rfq-modal-content" style="max-width:900px; width:90%; height:80vh;">
            <div class="rfq-modal-header">
                <h3 style="margin:0;">üìÇ Document Tracking Manager</h3>
                <button onclick="document.getElementById('doc-manager-modal').remove()" class="rfq-btn-close">&times;</button>
            </div>
            <div style="padding:20px; flex:1; overflow-y:auto; display:flex; flex-direction:column;">
                <div style="margin-bottom:16px; display:flex; justify-content:space-between; align-items:center;">
                    <p style="margin:0; color:#666; font-size:13px;">Manage all signed documents, contracts, and quotes for this project.</p>
                    <button onclick="window.openAddSignedDocumentModal()" class="rfq-btn-primary">+ Add Document</button>
                </div>
                <!-- Reuse existing render logic by hijacking the container ID -->
                <div id="${contentId}" style="flex:1;"></div>
            </div>
            <div class="rfq-modal-footer">
                <button onclick="document.getElementById('doc-manager-modal').remove()" class="rfq-btn-secondary">Close</button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    // Wrap the original renderer to target our modal
    const originalContainer = document.getElementById('fs-doctrack-content');

    // We temporarily trick renderDocumentTracking to render into our modal
    // But better to pull the list logic out? 
    // Optimization: Just manually call the render logic targeting this new ID.
    // However, since renderDocumentTracking hardcodes 'fs-doctrack-content', let's use a small hack or refactor.
    // Hack: Replace getElementById just for this call? No.
    // Refactor: Pass containerId to renderDocumentTracking.

    // Let's call a new helper or modify renderDocumentTracking to accept an ID?
    // modifying renderDocumentTracking above to accept optional ID would be best.
    // But since I can't guarantee I changed it yet (Wait, I AM changing it in this tool call).
    // I will modify renderDocumentTracking signature in the same replacement block below.
};

// Adjusted renderDocumentTracking to accept containerID
window.renderDocumentTracking = function (targetId = 'fs-doctrack-content') {
    const container = document.getElementById(targetId);
    if (!container) return;

    // Use currentProject
    const docs = (typeof currentProject !== 'undefined' && currentProject && Array.isArray(currentProject.final_documents)) ? currentProject.final_documents : [];
    const sortedDocs = [...docs].sort((a, b) => new Date(b.created || 0) - new Date(a.created || 0));

    const escapeHtml = (text) => text ? String(text).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' })[m]) : '';

    let html = '';
    // Only show header in the main view, not modal (modal has its own header)
    if (targetId === 'fs-doctrack-content') {
        html += `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h4 style="margin:0; font-size:14px; color:#333;">Synced Documents</h4>
                <button onclick="window.openDocumentManagerModal()" class="rfq-btn-secondary" style="font-size:11px; padding:4px 8px;">‚õ∂ Open Window</button>
            </div>
        `;
    }

    if (sortedDocs.length === 0) {
        html += `
            <div class="empty-state" style="padding: 40px; text-align: center; color: #94a3b8; background: #f8fafc; border-radius: 8px; border: 1px dashed #cbd5e1;">
                <div style="font-size: 24px; margin-bottom: 8px;">üìÇ</div>
                <div style="font-size: 13px; font-weight: 500;">No documents tracked yet</div>
                <div style="font-size: 11px; margin-top: 4px;">Upload signed quotes, contracts, or NDAs here.</div>
            </div>
        `;
        container.innerHTML = html;
        return;
    }

    const rows = sortedDocs.map(doc => {
        let statusBadge = `<span class="rfq-status-badge status-draft">Draft</span>`;
        if (doc.status === 'signed') statusBadge = `<span class="rfq-status-badge status-done">Signed</span>`;
        if (doc.status === 'received') statusBadge = `<span class="rfq-status-badge status-progress">Received</span>`;
        if (doc.status === 'expired') statusBadge = `<span class="rfq-status-badge status-issue">Expired</span>`;

        let expDateStr = '-';
        if (doc.date_expiration) {
            const exp = new Date(doc.date_expiration);
            const now = new Date();
            const daysLeft = Math.ceil((exp - now) / (1000 * 60 * 60 * 24));
            if (daysLeft < 0) expDateStr = `<span style="color:#ef4444; font-weight:600;">Expired (${exp.toLocaleDateString()})</span>`;
            else if (daysLeft < 30) expDateStr = `<span style="color:#f59e0b; font-weight:600;">Expiring in ${daysLeft}d</span>`;
            else expDateStr = exp.toLocaleDateString();
        }

        // Added console.log to debug click
        return `
            <tr onclick="console.log('Opening doc:', '${doc.id}'); window.openSignedDocumentDetail('${doc.id}')" style="cursor:pointer;" title="Click to view details">
                <td style="width: 40px; text-align: center; font-size: 16px;">
                    ${doc.name.endsWith('.pdf') ? 'üìï' : (doc.name.endsWith('.xls') || doc.name.endsWith('.xlsx')) ? 'üìó' : 'üìÑ'}
                </td>
                <td>
                    <div style="font-weight: 600; font-size: 13px; color: #1e293b;">${escapeHtml(doc.type || 'Document')}</div>
                    <div style="font-size: 11px; color: #64748b;">${escapeHtml(doc.name)}</div>
                </td>
                <td><div style="font-weight: 500;">${escapeHtml(doc.supplier)}</div></td>
                <td>${statusBadge}</td>
                <td style="font-size: 12px;">${doc.date_signed ? new Date(doc.date_signed).toLocaleDateString() : '-'}</td>
                <td style="font-size: 12px;">${expDateStr}</td>
                <td style="text-align: right;">
                     <button onclick="event.stopPropagation(); window.showToast('Downloading ${escapeHtml(doc.name)}...', 'info')" class="rfq-btn-icon" title="Download">‚¨áÔ∏è</button>
                </td>
            </tr>
        `;
    }).join('');

    html += `
        <table class="rfq-table" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr>
                    <th></th>
                    <th style="text-align:left;">Document</th>
                    <th style="text-align:left;">Supplier</th>
                    <th style="text-align:left;">Status</th>
                    <th style="text-align:left;">Signed</th>
                    <th style="text-align:left;">Expiration</th>
                    <th style="width: 40px;"></th>
                </tr>
            </thead>
            <tbody>${rows}</tbody>
        </table>
    `;
    container.innerHTML = html;
};

// Redefine openDocumentManagerModal to use the new signature logic
window.openDocumentManagerModal = function () {
    const modal = document.createElement('div');
    modal.id = 'doc-manager-modal';
    modal.className = 'rfq-modal-overlay';
    const contentId = 'doc-manager-content-' + Date.now();
    modal.innerHTML = `
        <div class="rfq-modal-content" style="max-width:900px; width:90%; height:80vh;">
            <div class="rfq-modal-header">
                <h3 style="margin:0;">üìÇ Document Tracking Manager</h3>
                <button onclick="document.getElementById('doc-manager-modal').remove()" class="rfq-btn-close">&times;</button>
            </div>
            <div style="padding:20px; flex:1; overflow-y:auto; display:flex; flex-direction:column;">
                <div style="margin-bottom:16px; display:flex; justify-content:space-between; align-items:center;">
                    <p style="margin:0; color:#666; font-size:13px;">Manage all signed documents, contracts, and quotes for this project.</p>
                    <button onclick="window.openAddSignedDocumentModal()" class="rfq-btn-primary">+ Add Document</button>
                </div>
                <div id="${contentId}" style="flex:1;"></div>
            </div>
            <div class="rfq-modal-footer">
                <button onclick="document.getElementById('doc-manager-modal').remove()" class="rfq-btn-secondary">Close</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    // Call render with the new container ID
    setTimeout(() => window.renderDocumentTracking(contentId), 0);
};

// Backwards compatibility alias
window.renderDocumentTrackingBySupplier = window.renderDocumentTracking;

// =========================================================
// GLOBAL DOCUMENT TRACKING MANAGER
// =========================================================

// =========================================================
// GLOBAL DOCUMENT TRACKING MANAGER
// =========================================================
window.renderGlobalDocumentManager = function () {
    const container = document.getElementById('doc-manager-content');
    if (!container) return;

    const filterInput = document.getElementById('doc-manager-filter');
    const filterText = filterInput ? filterInput.value.toLowerCase().trim() : '';

    // Aggregate all documents
    const projects = window.RFQData.getProjects();
    let allDocs = [];

    projects.forEach(p => {
        if (Array.isArray(p.final_documents)) {
            p.final_documents.forEach(doc => {
                allDocs.push({
                    ...doc,
                    projectId: p.id,
                    projectName: p.name
                });
            });
        }
    });

    // Sort: Newest first
    allDocs.sort((a, b) => new Date(b.created || 0) - new Date(a.created || 0));

    // Filter
    if (filterText) {
        allDocs = allDocs.filter(d =>
            (d.name && d.name.toLowerCase().includes(filterText)) ||
            (d.supplier && d.supplier.toLowerCase().includes(filterText)) ||
            (d.projectName && d.projectName.toLowerCase().includes(filterText))
        );
    }

    if (allDocs.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="padding: 40px; text-align: center; color: #94a3b8; background: #f8fafc; border-radius: 8px; border: 1px dashed #cbd5e1;">
                <div style="font-size: 24px; margin-bottom: 8px;">üìÇ</div>
                <div style="font-size: 13px; font-weight: 500;">No documents found</div>
            </div>
        `;
        return;
    }

    const escapeHtml = (text) => text ? String(text).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' })[m]) : '';

    const rows = allDocs.map(doc => {
        let statusBadge = `<span class="rfq-status-badge status-draft">Draft</span>`;
        if (doc.status === 'signed') statusBadge = `<span class="rfq-status-badge status-done">Signed</span>`;
        if (doc.status === 'received') statusBadge = `<span class="rfq-status-badge status-progress">Received</span>`;
        if (doc.status === 'expired') statusBadge = `<span class="rfq-status-badge status-issue">Expired</span>`;
        if (doc.status === 'active') statusBadge = `<span class="rfq-status-badge status-done">Active</span>`;

        let expDateStr = '-';
        if (doc.date_expiration) {
            const exp = new Date(doc.date_expiration);
            const now = new Date();
            const daysLeft = Math.ceil((exp - now) / (1000 * 60 * 60 * 24));
            if (daysLeft < 0) expDateStr = `<span style="color:#ef4444; font-weight:600;">Expired</span>`;
            else if (daysLeft < 30) expDateStr = `<span style="color:#f59e0b; font-weight:600;">${daysLeft}d left</span>`;
            else expDateStr = exp.toLocaleDateString();
        }

        // Logic to properly serialize doc for onclick (escape quotes)
        const docJson = JSON.stringify(doc).replace(/'/g, "\\'").replace(/"/g, '&quot;');

        return `
            <tr>
                <td style="width: 40px; text-align: center; font-size: 16px;">
                    ${doc.name.endsWith('.pdf') ? 'üìï' : (doc.name.endsWith('.xls') || doc.name.endsWith('.xlsx')) ? 'üìó' : 'üìÑ'}
                </td>
                <td>
                    <div style="font-weight: 600; font-size: 13px; color: #1e293b;">${escapeHtml(doc.Name || doc.name)}</div>
                    <div style="font-size: 11px; color: #64748b;">${escapeHtml(doc.type || 'Document')}</div>
                </td>
                <td>
                    <div style="font-weight: 500; color: #3b82f6;">${escapeHtml(doc.projectName)}</div>
                </td>
                <td><div style="font-weight: 500;">${escapeHtml(doc.supplier)}</div></td>
                <td>${statusBadge}</td>
                <td style="font-size: 12px;">${doc.date_signed ? new Date(doc.date_signed).toLocaleDateString() : '-'}</td>
                <td style="font-size: 12px;">${expDateStr}</td>
                <td style="text-align: right; white-space: nowrap;">
                     <button onclick="window.downloadGlobalDocument('${docJson}')" class="rfq-btn-icon" title="Download">‚¨áÔ∏è</button>
                     <button onclick="window.deleteGlobalDocument('${doc.projectId}', '${doc.id}')" class="rfq-btn-icon" style="color:#ef4444;" title="Delete">üóëÔ∏è</button>
                </td>
            </tr>
        `;
    }).join('');

    container.innerHTML = `
        <table class="rfq-table" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr>
                    <th style="width:40px;"></th>
                    <th style="text-align:left;">Document</th>
                    <th style="text-align:left;">Project</th>
                    <th style="text-align:left;">Supplier</th>
                    <th style="text-align:left;">Status</th>
                    <th style="text-align:left;">Signed</th>
                    <th style="text-align:left;">Expiration</th>
                    <th style="width: 80px; text-align:right;">Actions</th>
                </tr>
            </thead>
            <tbody>${rows}</tbody>
        </table>
    `;
};

window.downloadGlobalDocument = function (docJsonOrObj) {
    let doc = docJsonOrObj;
    if (typeof doc === 'string') {
        try { doc = JSON.parse(doc); } catch (e) {
            // Fallback if passing string failed
            if (window.showToast) window.showToast('Error parsing document data', 'error');
            return;
        }
    }

    const url = doc.url || doc.file || doc.link || doc.src || doc.path;

    if (url) {
        const link = document.createElement('a');
        link.href = url;
        link.download = doc.name || 'document';
        link.target = '_blank';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        if (window.showToast) window.showToast('Downloading...', 'success');
    } else {
        console.warn('[Doc Manager] No URL found for document:', doc);
        if (window.showToast) window.showToast('File path not found for this document.', 'warning');
    }
};

window.deleteGlobalDocument = async function (projectId, docId) {
    // Custom confirm dialog
    const confirmed = await window.showConfirmDialog({
        title: 'Delete Document',
        message: 'Are you sure you want to permanently delete this document?',
        type: 'danger',
        okText: 'Delete',
        cancelText: 'Cancel'
    });

    if (!confirmed) return;

    const projects = window.RFQData.getProjects();
    const proj = projects.find(p => String(p.id) === String(projectId));
    if (!proj) return;

    if (Array.isArray(proj.final_documents)) {
        proj.final_documents = proj.final_documents.filter(d => String(d.id) !== String(docId));
        window.RFQData.updateProject(proj);
        window.showToast('Document deleted', 'success');
        window.renderGlobalDocumentManager(); // Refresh view
    }
};

// Auto-bind doc manager filter
document.addEventListener('input', function (e) {
    if (e.target && e.target.id === 'doc-manager-filter') {
        window.renderGlobalDocumentManager();
    }
});

// Auto-bind nav click (Handles View Switching Logic)
document.addEventListener('click', function (e) {
    // 1. Handle Document Manager Tab Click
    if (e.target && (e.target.id === 'nav-doc-manager' || e.target.closest('#nav-doc-manager'))) {
        // Reset project when going to GLOBAL view
        currentProject = null;
        window.currentProject = null;
        localStorage.removeItem('rfq_active_project_id');
        if (typeof setProjectNameUI === 'function') setProjectNameUI(null);
        const ptg = document.querySelector('.project-tabs-group');
        if (ptg) ptg.classList.remove('has-project');

        document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
        const view = document.getElementById('view-doc-manager');
        if (view) {
            view.classList.remove('hidden');
            window.renderGlobalDocumentManager();
        }

        // Handle Sidebar Active State
        document.querySelectorAll('.nav-dropdown-item').forEach(el => el.classList.remove('active'));
        const btn = document.getElementById('nav-doc-manager');
        if (btn) btn.classList.add('active');
    }

    // 2. Handle OTHER Navigation Clicks (Reset/Hide Doc Manager)
    const navItem = e.target.closest('.nav-item, .nav-dropdown-item, .tab, .nav-dropdown-btn');
    if (navItem && navItem.id !== 'nav-doc-manager') {
        // If clicking any other navigation item, ensure doc manager is hidden
        const view = document.getElementById('view-doc-manager');
        if (view) view.classList.add('hidden');

        // Also remove active class from doc manager btn
        const btn = document.getElementById('nav-doc-manager');
        if (btn) btn.classList.remove('active');
    }
});

// =========================================================
// SUPPLIER INTERACTION MODULE
// =========================================================

const escapeHtml = (text) => {
    if (!text) return '';
    return String(text).replace(/[&<>"']/g, function (m) {
        switch (m) {
            case '&': return '&amp;';
            case '<': return '&lt;';
            case '>': return '&gt;';
            case '"': return '&quot;';
            case "'": return '&#039;';
            default: return m;
        }
    });
};

const getCookie = (name) => {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
};

if (typeof window.showToast !== 'function') {
    window.showToast = function (msg, type) {
        console.log(`[Toast ${type}]: ${msg}`);
        // Fallback: create a simple toast element if it doesn't exist
        let t = document.getElementById('simple-toast-fallback');
        if (!t) {
            t = document.createElement('div');
            t.id = 'simple-toast-fallback';
            t.style.cssText = 'position:fixed; bottom:20px; right:20px; padding:10px 20px; background:#333; color:#fff; border-radius:4px; z-index:9999; display:none;';
            document.body.appendChild(t);
        }
        t.textContent = msg;
        t.style.display = 'block';
        if (type === 'error') t.style.background = '#dc2626';
        if (type === 'success') t.style.background = '#16a34a';
        setTimeout(() => { t.style.display = 'none'; }, 3000);
    };
}

/* --- SIM helper: relative time --- */
function _simRelativeTime(isoDate) {
    if (!isoDate) return '';
    const d = new Date(isoDate);
    const now = new Date();
    const diffMs = now - d;
    if (diffMs < 0) return '';
    const mins = Math.floor(diffMs / 60000);
    if (mins < 1) return 'just now';
    if (mins < 60) return mins + 'm ago';
    const hours = Math.floor(mins / 60);
    if (hours < 24) return hours + 'h ago';
    const days = Math.floor(hours / 24);
    if (days < 30) return days + 'd ago';
    const months = Math.floor(days / 30);
    return months + 'mo ago';
}

/* --- SIM helper: short date format --- */
function _simFormatDate(isoDate) {
    if (!isoDate) return '';
    const d = new Date(isoDate);
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    return months[d.getMonth()] + ' ' + d.getDate();
}

/* --- SIM helper: time delta between two ISO dates --- */
function _simTimeDelta(fromIso, toIso) {
    if (!fromIso || !toIso) return '';
    const from = new Date(fromIso);
    const to = new Date(toIso);
    const diffMs = to - from;
    if (diffMs < 0) return '';
    const hours = Math.floor(diffMs / 3600000);
    if (hours < 24) return hours + 'h';
    const days = Math.floor(hours / 24);
    return days + 'd';
}

/**
 * Renders the Supplier Interaction Dashboard ‚Äî v2.
 * KPI cards + SuperTable with timeline columns + row expand.
 */
window.renderSupplierInteraction = async function () {
    const container = document.getElementById('tab-supplier-interaction');
    if (!container) return;

    // Check project context
    if (typeof currentProject === 'undefined' || !currentProject) {
        if (typeof window.RFQData !== 'undefined' && window.RFQData.activeProject) {
            // Fallback
        } else {
            container.innerHTML = '<div style="padding:20px;"><div class="main-card"><div class="muted">No active project loaded. Please select a project.</div></div></div>';
            return;
        }
    }
    const project = (typeof currentProject !== 'undefined') ? currentProject : window.RFQData.activeProject;

    // Build layout shell once
    if (!container.querySelector('.sim-shell')) {
        container.innerHTML = `
            <div class="sim-shell">
                <div class="sim-header">
                    <h2>Supplier Interaction</h2>
                    <div class="sim-header-actions">
                        <button class="btn-primary btn-sm" id="sim-bulk-btn" onclick="window.bulkGenerateLinks()" style="display:none;">Generate Selected</button>
                        <span id="sim-sel-count" style="font-size:11px;color:#64748b;"></span>
                        <button class="btn-secondary btn-sm" onclick="window.renderSupplierInteraction()" style="display:flex;align-items:center;gap:4px;">
                            <span style="font-size:14px;">&#8635;</span> Refresh
                        </button>
                    </div>
                </div>
                <div id="sim-kpi-bar" class="sim-kpi-bar"></div>
                <div id="sim-super-table-container" class="main-card" style="flex:1; display:flex; flex-direction:column; padding:0; overflow:hidden;"></div>
            </div>`;
    }

    // Show loading
    const stContainer = document.getElementById('sim-super-table-container');
    if (!stContainer) return;
    stContainer.innerHTML = '<div style="text-align:center; padding:50px; color:#94a3b8;">Loading...</div>';

    // Fetch existing tokens
    let accessList = [];
    const accessMap = {};
    try {
        const res = await fetch(`/api/projects/${project.id}/supplier_access`);
        if (res.ok) {
            const json = await res.json();
            accessList = json.accesses || [];
            window.RFQData.currentAccessList = accessList;
            accessList.forEach(acc => {
                const key = String(acc.supplier_name).trim().toLowerCase();
                if (!accessMap[key]) accessMap[key] = acc;
            });
        }
    } catch (e) {
        console.error("Failed to fetch access list", e);
    }

    // Group items by supplier
    const suppliersMap = {};
    const items = project.items || [];

    items.forEach(it => {
        const candidates = new Set();
        if (it.supplier) candidates.add(String(it.supplier).trim());
        if (Array.isArray(it.suppliers)) {
            it.suppliers.forEach(s => {
                if (s.name) candidates.add(String(s.name).trim());
            });
        }
        candidates.forEach(sName => {
            if (!sName) return;
            if (!suppliersMap[sName]) suppliersMap[sName] = { name: sName, itemsCount: 0 };
            suppliersMap[sName].itemsCount++;
        });
    });

    accessList.forEach(acc => {
        const sName = acc.supplier_name;
        if (!suppliersMap[sName]) suppliersMap[sName] = { name: sName, itemsCount: 0 };
    });

    const supplierNames = Object.keys(suppliersMap).sort();

    // --- Helper functions ---
    function getTrafficLight(acc) {
        if (!acc || !acc.valid_until) return '<span class="sim-traffic-dot sim-dot-gray" title="No deadline"></span>';
        const due = new Date(acc.valid_until);
        const daysLeft = (due - new Date()) / 86400000;
        if (daysLeft < 0) return '<span class="sim-traffic-dot sim-dot-red" title="Overdue!"></span>';
        if (daysLeft < 3) return '<span class="sim-traffic-dot sim-dot-yellow" title="Due soon"></span>';
        return '<span class="sim-traffic-dot sim-dot-green" title="On track"></span>';
    }

    function countNewItems(acc, sName) {
        if (!acc || !acc.requested_items) return 0;
        const accItemIds = new Set((acc.requested_items || []).map(ri => String(ri.id || ri.item_drawing_no || ri.mpn)));
        let count = 0;
        items.forEach(it => {
            let assigned = false;
            if (it.supplier && String(it.supplier).trim().toLowerCase() === sName.toLowerCase()) assigned = true;
            if (!assigned && Array.isArray(it.suppliers)) {
                it.suppliers.forEach(s => {
                    if (s.name && String(s.name).trim().toLowerCase() === sName.toLowerCase()) assigned = true;
                });
            }
            if (assigned) {
                const itemKey = String(it.id || it.item_drawing_no || it.mpn);
                if (!accItemIds.has(itemKey)) count++;
            }
        });
        return count;
    }

    function getStatusLabel(acc) {
        if (!acc) return 'Ready';
        const s = acc.status;
        if (s === 'sent') return 'Sent';
        if (s === 'viewed') return 'Viewed';
        if (s === 'submitted' || s === 'replied') return 'Quoted';
        if (s === 'approved') return 'Approved';
        if (s === 're_quote_requested') return 'Re-Quote';
        if (s === 'rejected') return 'Rejected';
        if (s === 'lost') return 'Lost';
        if (s === 'expired') return 'Cancelled';
        return s;
    }

    function getStatusBadge(acc) {
        if (!acc) return '<span class="sim-status-badge sim-status-ready">Ready</span>';
        const s = acc.status;
        let cls = 'sim-status-ready';
        if (s === 'sent') cls = 'sim-status-sent';
        else if (s === 'viewed') cls = 'sim-status-viewed';
        else if (s === 'submitted' || s === 'replied') cls = 'sim-status-quoted';
        else if (s === 'approved') cls = 'sim-status-approved';
        else if (s === 're_quote_requested') cls = 'sim-status-requote';
        else if (s === 'rejected' || s === 'lost') cls = 'sim-status-rejected';
        else if (s === 'expired') cls = 'sim-status-cancelled';
        let badge = `<span class="sim-status-badge ${cls}">${getStatusLabel(acc)}</span>`;
        if (acc.reopen_requested) {
            const reason = (acc.submission_data || {}).reopen_reason || '';
            badge += ` <span class="sim-reopen-tag" title="${escapeHtml(reason)}">REOPEN</span>`;
        }
        return badge;
    }

    // --- Build data rows for SuperTable ---
    const rows = supplierNames.map(sName => {
        const data = suppliersMap[sName];
        const key = sName.toLowerCase().trim();
        const acc = accessMap[key] || null;
        return {
            supplier_name: sName,
            items_count: data.itemsCount,
            acc: acc,
            status_label: getStatusLabel(acc),
            new_items_count: acc ? countNewItems(acc, sName) : 0,
            due_date: acc && acc.valid_until ? acc.valid_until : '',
            has_link: !!acc,
            round: acc ? acc.round : 0,
            files_count: acc && acc.files ? acc.files.length : 0,
            created_at: acc ? acc.created_at : '',
            viewed_at: acc ? acc.viewed_at : '',
            submitted_at: acc ? acc.submitted_at : '',
            approved_at: acc ? acc.approved_at : '',
            reopen_requested: acc ? !!acc.reopen_requested : false,
        };
    });

    // --- KPI Stats ---
    const totalCount = rows.length;
    const pendingCount = rows.filter(r => !r.has_link).length;
    const awaitingCount = rows.filter(r => r.acc && ['sent','viewed'].includes(r.acc.status)).length;
    const quotedCount = rows.filter(r => r.acc && ['submitted','replied','re_quote_requested'].includes(r.acc.status)).length;
    const approvedCount = rows.filter(r => r.acc && r.acc.status === 'approved').length;
    const overdueCount = rows.filter(r => {
        if (!r.acc || !r.acc.valid_until) return false;
        return new Date(r.acc.valid_until) < new Date() && !['approved','rejected','lost','expired'].includes(r.acc.status);
    }).length;

    const kpiBar = document.getElementById('sim-kpi-bar');
    if (kpiBar) {
        kpiBar.innerHTML = `
            <div class="sim-kpi-card sim-kpi-total">
                <div class="sim-kpi-value">${totalCount}</div>
                <div class="sim-kpi-label">Total</div>
            </div>
            <div class="sim-kpi-card sim-kpi-pending">
                <div class="sim-kpi-value">${pendingCount}</div>
                <div class="sim-kpi-label">Pending</div>
            </div>
            <div class="sim-kpi-card sim-kpi-awaiting">
                <div class="sim-kpi-value">${awaitingCount}</div>
                <div class="sim-kpi-label">Awaiting</div>
            </div>
            <div class="sim-kpi-card sim-kpi-quoted">
                <div class="sim-kpi-value">${quotedCount}</div>
                <div class="sim-kpi-label">Quoted</div>
            </div>
            <div class="sim-kpi-card sim-kpi-approved">
                <div class="sim-kpi-value">${approvedCount}</div>
                <div class="sim-kpi-label">Approved</div>
            </div>
            <div class="sim-kpi-card sim-kpi-overdue">
                <div class="sim-kpi-value">${overdueCount}</div>
                <div class="sim-kpi-label">Overdue</div>
            </div>`;
    }

    // --- Empty state ---
    if (rows.length === 0) {
        stContainer.innerHTML = `
            <div class="sim-empty">
                <div class="sim-empty-icon">&#128587;</div>
                <h3>No suppliers found</h3>
                <p>Add suppliers to your project items to start the quoting process.</p>
            </div>`;
        return;
    }

    // --- Define SuperTable columns (9 columns) ---
    const simColumns = [
        {
            id: 'sim_select', title: '<input type="checkbox" class="sim-chk-all" title="Select all" onchange="event.stopPropagation();document.querySelectorAll(\'.sim-chk:not(:disabled)\').forEach(c=>c.checked=this.checked);const n=document.querySelectorAll(\'.sim-chk:checked\').length;const el=document.getElementById(\'sim-sel-count\');const btn=document.getElementById(\'sim-bulk-btn\');if(el)el.textContent=n?n+\' selected\':\'\';if(btn)btn.style.display=n?\'\':\'none\';">', width: 36, filterable: false, resizable: false,
            render: (row) => {
                if (row.has_link) return '<input type="checkbox" class="sim-chk" disabled title="Link already exists">';
                return `<input type="checkbox" class="sim-chk" value="${escapeHtml(row.supplier_name)}"
                    onchange="event.stopPropagation(); const n=document.querySelectorAll('.sim-chk:checked').length; const el=document.getElementById('sim-sel-count'); const btn=document.getElementById('sim-bulk-btn'); if(el)el.textContent=n?n+' selected':''; if(btn)btn.style.display=n?'':'none';">`;
            }
        },
        {
            id: 'supplier_name', title: 'Supplier', width: 180,
            getValue: (row) => row.supplier_name,
            render: (row) => {
                let nameHtml = '<span class="sim-expand-chevron">&#9654;</span> ';
                nameHtml += `<span class="sim-supplier-name">${escapeHtml(row.supplier_name)}</span>`;
                if (row.acc) nameHtml += ` <span class="sim-round-badge">R${row.round}</span>`;
                return nameHtml;
            }
        },
        {
            id: 'items_count', title: 'Items', width: 70,
            getValue: (row) => {
                if (row.acc && row.acc.items_count) {
                    const q = row.acc.submission_summary ? (row.acc.submission_summary.items_count || 0) : 0;
                    return `${q}/${row.acc.items_count}`;
                }
                return String(row.items_count);
            },
            render: (row) => {
                if (row.acc && row.acc.items_count) {
                    const q = row.acc.submission_summary ? (row.acc.submission_summary.items_count || 0) : 0;
                    return `<span class="sim-items-count">${q}/${row.acc.items_count}</span>`;
                }
                return `<span class="sim-items-count">${row.items_count}</span>`;
            }
        },
        {
            id: 'status', title: 'Status', width: 140,
            getValue: (row) => {
                let v = row.status_label;
                if (row.files_count) v += ` (${row.files_count} files)`;
                return v;
            },
            render: (row) => {
                let h = getStatusBadge(row.acc);
                if (row.files_count > 0) {
                    h += ` <span class="sim-files-badge" title="${row.files_count} file(s)">&#128206;${row.files_count}</span>`;
                }
                return h;
            }
        },
        {
            id: 'sent_at', title: 'Sent', width: 100,
            getValue: (row) => row.created_at ? _simFormatDate(row.created_at) : '',
            render: (row) => {
                if (!row.created_at) return '<span style="color:#cbd5e1;">-</span>';
                return `<span class="sim-ts-cell">
                    <span class="sim-ts-date">${_simFormatDate(row.created_at)}</span>
                </span>`;
            }
        },
        {
            id: 'viewed_at', title: 'Opened', width: 120,
            getValue: (row) => row.viewed_at ? _simFormatDate(row.viewed_at) + ' ' + _simRelativeTime(row.viewed_at) : '',
            render: (row) => {
                if (!row.viewed_at) {
                    if (row.acc && row.acc.status === 'sent') return '<span style="color:#94a3b8;font-size:12px;">Not yet</span>';
                    return '<span style="color:#cbd5e1;">-</span>';
                }
                // Warn if viewed > 3 days ago but not yet quoted
                const isWarn = row.acc && row.acc.status === 'viewed' &&
                    (new Date() - new Date(row.viewed_at)) > 3 * 86400000;
                const cls = isWarn ? 'sim-ts-cell sim-ts-warn' : 'sim-ts-cell';
                return `<span class="${cls}">
                    <span class="sim-ts-date">${_simFormatDate(row.viewed_at)}</span>
                    <span class="sim-ts-relative">${_simRelativeTime(row.viewed_at)}</span>
                </span>`;
            }
        },
        {
            id: 'submitted_at', title: 'Quoted', width: 110,
            getValue: (row) => row.submitted_at ? _simFormatDate(row.submitted_at) : '',
            render: (row) => {
                if (!row.submitted_at) return '<span style="color:#cbd5e1;">-</span>';
                const delta = _simTimeDelta(row.viewed_at, row.submitted_at);
                return `<span class="sim-ts-cell">
                    <span class="sim-ts-date">${_simFormatDate(row.submitted_at)}</span>
                    ${delta ? `<span class="sim-ts-delta">(${delta})</span>` : ''}
                </span>`;
            }
        },
        {
            id: 'due_date', title: 'Due Date', width: 110,
            getValue: (row) => row.due_date ? new Date(row.due_date).toLocaleDateString() : '',
            render: (row) => {
                if (row.acc && row.due_date) {
                    return `${getTrafficLight(row.acc)}<span class="sim-due-date">${_simFormatDate(row.due_date)}</span>`;
                }
                return '<span class="sim-due-date" style="color:#cbd5e1;">-</span>';
            }
        },
        {
            id: 'actions', title: 'Actions', width: 260, filterable: false, resizable: true,
            render: (row) => {
                let btns = [];
                if (!row.acc) {
                    btns.push(`<button class="btn-sm sim-btn-generate" onclick="event.stopPropagation();window.generateSupplierLink('${escapeHtml(row.supplier_name)}')">Generate Link</button>`);
                    return `<div class="sim-actions">${btns.join('')}</div>`;
                }
                const s = row.acc.status;
                const id = row.acc.id;
                const portalLink = `${location.origin}/portal/${id}/`;
                // Portal + Copy
                btns.push(`<button class="btn-sm sim-btn-portal" onclick="event.stopPropagation();window.open('${portalLink}','_blank')" title="Open Supplier Portal">Portal</button>`);
                btns.push(`<button class="btn-sm sim-btn-copy" onclick="event.stopPropagation();navigator.clipboard.writeText('${portalLink}');window.showToast('Link copied!','success')" title="Copy portal link">Copy</button>`);
                // Review ‚Äî always available
                btns.push(`<button class="btn-sm sim-btn-review" onclick="event.stopPropagation();window.reviewSupplierSubmission('${id}')">Review</button>`);
                // Update
                if (row.new_items_count > 0 && s !== 'expired') {
                    btns.push(`<button class="btn-sm sim-btn-update" onclick="event.stopPropagation();window.updateSupplierItems('${id}')" title="${row.new_items_count} new item(s)">Update (${row.new_items_count})</button>`);
                }
                // Reopen ‚Äî for rejected/lost/expired OR when supplier requested reopen
                if (['rejected', 'lost', 'expired'].includes(s) || row.reopen_requested) {
                    btns.push(`<button class="btn-sm sim-btn-reopen" onclick="event.stopPropagation();window.reopenSupplierAccess('${id}')">Reopen</button>`);
                }
                // Cancel
                if (['sent', 'viewed', 're_quote_requested', 'submitted'].includes(s)) {
                    btns.push(`<button class="btn-sm sim-btn-cancel" onclick="event.stopPropagation();window.cancelSupplierAccess('${id}')">Cancel</button>`);
                }
                return `<div class="sim-actions">${btns.join('')}</div>`;
            }
        }
    ];

    // --- Create / refresh SuperTable ---
    stContainer.innerHTML = '';
    const simTable = window.createSuperTable('sim-super-table-container', {
        columns: simColumns,
        storageKey: 'rfq_sim_super_table',
        pageSize: 200,
    });
    simTable.setData(rows);

    // --- Row expand on click + reopen highlight ---
    // Build a row lookup by supplier name for click handler
    const _simRowLookup = {};
    rows.forEach((r, i) => { _simRowLookup[r.supplier_name] = r; });

    // Use event delegation on tbody (survives re-renders)
    setTimeout(() => {
        const tableBody = stContainer.querySelector('tbody');
        if (!tableBody) return;

        // Tag original rows with supplier name + apply reopen highlight
        const origTrs = tableBody.querySelectorAll('tr');
        origTrs.forEach((tr, idx) => {
            const row = rows[idx];
            if (!row) return;
            tr.setAttribute('data-sim-supplier', row.supplier_name);
            tr.style.cursor = 'pointer';
            if (row.reopen_requested) tr.classList.add('sim-row-reopen');
        });

        // Single click handler via delegation
        tableBody.addEventListener('click', (e) => {
            if (e.target.closest('button') || e.target.closest('input') || e.target.closest('a')) return;
            const tr = e.target.closest('tr[data-sim-supplier]');
            if (!tr) return;

            const sName = tr.getAttribute('data-sim-supplier');
            const row = _simRowLookup[sName];
            if (!row) return;

            // Toggle chevron
            const chevron = tr.querySelector('.sim-expand-chevron');

            // If already expanded, collapse
            const existingExpand = tr.nextElementSibling;
            if (existingExpand && existingExpand.classList.contains('sim-row-expand-tr')) {
                existingExpand.remove();
                if (chevron) chevron.classList.remove('sim-expand-chevron-open');
                return;
            }

            // Close all other expands & reset chevrons
            stContainer.querySelectorAll('.sim-row-expand-tr').forEach(el => el.remove());
            stContainer.querySelectorAll('.sim-expand-chevron-open').forEach(el => el.classList.remove('sim-expand-chevron-open'));

            if (!row.acc) return;
            const acc = row.acc;
            if (chevron) chevron.classList.add('sim-expand-chevron-open');

            const link = `${location.origin}/portal/${acc.id}/`;
            // Show supplier contact from submission_data (not buyer contact)
            const sub = acc.submission_data || {};
            const scName = sub.supplier_contact_name || '';
            const scEmail = sub.supplier_contact_email || '';
            const scPhone = sub.supplier_contact_phone || '';
            const contact = (scName || scEmail)
                ? `${escapeHtml(scName)}${scEmail ? ' &lt;' + escapeHtml(scEmail) + '&gt;' : ''}${scPhone ? ' | ' + escapeHtml(scPhone) : ''}`
                : '<span style="color:#94a3b8;">Not provided by supplier</span>';
            const notes = (sub.notes) ? escapeHtml(sub.notes).substring(0, 200) : '<span style="color:#94a3b8;">No notes</span>';

            // Status progress cards (replacement for timeline)
            const statusSteps = [
                { label: 'Sent', date: acc.created_at, color: '#3b82f6' },
                { label: 'Opened', date: acc.viewed_at, color: '#f59e0b' },
                { label: 'Quoted', date: acc.submitted_at, color: '#22c55e' },
                { label: 'Decision', date: acc.approved_at, color: acc.status === 'approved' ? '#10b981' : (acc.status === 'rejected' ? '#ef4444' : '#6366f1') },
            ];

            // Determine decision label
            let decisionLabel = '-';
            if (acc.status === 'approved') decisionLabel = 'Approved';
            else if (acc.status === 'rejected') decisionLabel = 'Rejected';
            else if (acc.status === 'lost') decisionLabel = 'Lost';
            else if (acc.status === 're_quote_requested') decisionLabel = 'Re-Quote';

            let statusCardsHtml = statusSteps.map(step => {
                const hasDate = !!step.date;
                const dateStr = hasDate ? _simFormatDate(step.date) + ' ' + _simRelativeTime(step.date) : '-';
                const opacity = hasDate ? '1' : '0.35';
                const displayLabel = step.label === 'Decision' && hasDate ? decisionLabel : step.label;
                return `<div style="flex:1;padding:10px 14px;background:#fff;border:1px solid #e2e8f0;border-radius:8px;border-top:3px solid ${hasDate ? step.color : '#d1d5db'};opacity:${opacity};">
                    <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.4px;color:#64748b;margin-bottom:3px;">${displayLabel}</div>
                    <div style="font-size:13px;font-weight:500;color:#0f172a;">${dateStr}</div>
                </div>`;
            }).join('');

            const expandTr = document.createElement('tr');
            expandTr.className = 'sim-row-expand-tr';
            const td = document.createElement('td');
            td.colSpan = simColumns.length;
            td.innerHTML = `<div class="sim-row-expand">
                <div style="display:flex;gap:10px;margin-bottom:16px;">${statusCardsHtml}</div>
                <div class="sim-expand-grid">
                    <div class="sim-expand-section">
                        <h4>Portal Link</h4>
                        <div class="sim-portal-url">
                            <span style="flex:1;overflow:hidden;text-overflow:ellipsis;">${link}</span>
                            <button onclick="navigator.clipboard.writeText('${link}');window.showToast('Copied!','success')" title="Copy">&#128203;</button>
                        </div>
                    </div>
                    <div class="sim-expand-section">
                        <h4>Supplier Contact</h4>
                        <p>${contact}</p>
                    </div>
                    <div class="sim-expand-section">
                        <h4>Notes</h4>
                        <p>${notes}</p>
                    </div>
                </div>
            </div>`;
            expandTr.appendChild(td);
            tr.after(expandTr);
        });
    }, 100);

    // Show/hide bulk button based on current selection
    const bulkBtn = document.getElementById('sim-bulk-btn');
    if (bulkBtn) bulkBtn.style.display = 'none';
};

// ... generateSupplierLink is below ...

/**
 * Open Review Modal for Supplier Submission
 */
window.reviewSupplierSubmission = function (tokenId) {
    const list = window.RFQData.currentAccessList || [];
    const acc = list.find(a => a.id === tokenId);
    if (!acc) {
        alert("Submission data not found. Please refresh.");
        return;
    }

    const submission = acc.submission_data || {};
    const subItems = submission.items || [];
    const notes = submission.notes || '';
    const files = acc.files || [];

    // Quote-level fields from supplier submission
    const supCurrency = submission.currency || acc.currency || 'EUR';
    const quoteIncoterms = submission.incoterms || '';
    const quotePaymentTerms = submission.payment_terms || '';
    const quoteShipping = submission.shipping || '';
    const quoteNumber = submission.quote_number || '';
    const quoteValidUntil = submission.quote_valid_until || '';
    const quotePackaging = submission.packaging || '';

    const project = (typeof currentProject !== 'undefined') ? currentProject : window.RFQData.activeProject;
    const projectItems = project.items || [];

    // Currency conversion rate lookup
    const rates = (project.currency_rates || project.settings?.exchange_rates || {});
    let exchangeRate = 1;
    let currencyWarning = false;
    if (supCurrency !== 'EUR') {
        const r = parseFloat(rates[supCurrency]);
        if (r && Number.isFinite(r) && r > 0) {
            exchangeRate = r; // rate = how many EUR per 1 unit of supCurrency
        } else {
            currencyWarning = true; // no rate available
        }
    }

    let rows = '';
    let totalProjectTarget = 0;
    let totalQuotedEUR = 0;
    let totalQuotedOriginal = 0;
    let matchedCount = 0;
    let unmatchedCount = 0;
    let noBidCount = 0;

    // Helper: compute delta HTML
    function priceDelta(quoted, target, rate) {
        const qEUR = quoted * rate;
        if (qEUR > 0 && target > 0) {
            const d = ((qEUR - target) / target) * 100;
            if (d < -0.01) return `<span style="font-size:10px; color:#10b981;">(${d.toFixed(1)}%)</span>`;
            if (d > 0.01) return `<span style="font-size:10px; color:#ef4444;">(+${d.toFixed(1)}%)</span>`;
        }
        return '';
    }

    subItems.forEach(si => {
        // --- ROBUST MATCHING LOGIC (V2) ---
        let pItem = null;
        const siId = String(si.id || '');
        const siDn = String(si.item_drawing_no || si.drawing_no || '').trim().toLowerCase();
        const siMpn = String(si.mpn || '').trim().toLowerCase();

        if (siId) pItem = projectItems.find(pi => String(pi.id) === siId);
        if (!pItem && siDn) pItem = projectItems.find(pi => String(pi.item_drawing_no || pi.drawing_no || '').trim().toLowerCase() === siDn);
        if (!pItem && siMpn) pItem = projectItems.find(pi => String(pi.mpn || '').trim().toLowerCase() === siMpn);

        if (!pItem) { unmatchedCount++; return; }
        matchedCount++;

        const isNoBid = si.no_bid;
        if (isNoBid) { noBidCount++; }

        // Build tier data
        const tiers = [];
        if (pItem.qty_1) {
            tiers.push({ qty: pItem.qty_1, target: parseFloat(pItem.price_1 || pItem.target_price || 0), quoted: parseFloat(si.price || 0) });
        }
        if (pItem.qty_2) {
            tiers.push({ qty: pItem.qty_2, target: parseFloat(pItem.price_2 || 0), quoted: parseFloat(si.price_2 || 0) });
        }
        if (pItem.qty_3) {
            tiers.push({ qty: pItem.qty_3, target: parseFloat(pItem.price_3 || 0), quoted: parseFloat(si.price_3 || 0) });
        }
        if (tiers.length === 0) {
            tiers.push({ qty: '-', target: parseFloat(pItem.price || pItem.price_1 || 0), quoted: parseFloat(si.price || 0) });
        }

        // Accumulate totals from first tier only
        if (!isNoBid) {
            totalProjectTarget += tiers[0].target;
            totalQuotedOriginal += tiers[0].quoted;
            totalQuotedEUR += tiers[0].quoted * exchangeRate;
        }

        // Build tier lines
        let tierHtml = '';
        tiers.forEach(t => {
            const delta = isNoBid ? '' : priceDelta(t.quoted, t.target, exchangeRate);
            tierHtml += `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:2px 0; ${tiers.length > 1 ? 'border-bottom:1px dashed #f1f5f9;' : ''}">
                    <span style="font-size:11px; color:#64748b; min-width:60px;">@${t.qty}</span>
                    <span style="font-size:12px; color:#64748b; min-width:80px; text-align:right;">${t.target ? t.target.toFixed(2) + ' EUR' : '-'}</span>
                    <span style="font-size:12px; font-weight:600; min-width:80px; text-align:right; ${isNoBid ? 'color:#94a3b8;' : ''}">${isNoBid ? '-' : (t.quoted ? t.quoted.toFixed(2) + ' ' + supCurrency : '-')}</span>
                    <span style="min-width:50px; text-align:right;">${delta}</span>
                </div>`;
        });

        // Status badge
        let statusHtml = '';
        if (isNoBid) {
            statusHtml = `<div style="display:flex; flex-direction:column; align-items:center; gap:2px;">
                <span style="background:#fee2e2; color:#dc2626; font-size:10px; font-weight:700; padding:2px 8px; border-radius:4px;">NO BID</span>
                ${si.no_bid_reason ? `<span style="font-size:10px; color:#64748b;">${escapeHtml(si.no_bid_reason)}</span>` : ''}
            </div>`;
        } else {
            statusHtml = `<div style="font-size:11px; color:#64748b;">
                <div>MOQ: <strong>${escapeHtml(si.moq || '-')}</strong></div>
                <div>Lead: <strong>${escapeHtml(si.lead_time || '-')}</strong></div>
            </div>`;
        }

        rows += `
            <tr style="${isNoBid ? 'opacity:0.6;' : ''}">
                <td>
                    <div style="font-weight:600; font-size:13px;">${escapeHtml(pItem.item_drawing_no || pItem.drawing_no || 'Unknown')}</div>
                    <div style="font-size:10px; color:#64748b;">MPN: ${escapeHtml(pItem.mpn || '-')}</div>
                    <div style="font-size:10px; color:#94a3b8; max-width:160px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(pItem.description || '')}</div>
                </td>
                <td style="padding:6px 8px;">
                    <div style="font-size:10px; font-weight:600; color:#64748b; margin-bottom:4px; display:flex; justify-content:space-between;">
                        <span>Tier</span><span>Target</span><span>Quote</span><span>Œî</span>
                    </div>
                    ${tierHtml}
                </td>
                <td style="text-align:center; vertical-align:middle; padding:8px;">
                    ${statusHtml}
                </td>
            </tr>
        `;
    });

    const savings = totalProjectTarget - totalQuotedEUR;
    const savingsPercent = totalProjectTarget > 0 ? (savings / totalProjectTarget) * 100 : 0;

    // Unmatched items warning
    let unmatchedWarning = '';
    if (unmatchedCount > 0) {
        unmatchedWarning = `<div style="background:#fef3c7; border:1px solid #f59e0b; border-radius:8px; padding:12px; margin-bottom:16px; font-size:13px; color:#92400e;">
            &#9888; ${unmatchedCount} item(s) could not be matched to project items and are not shown.
        </div>`;
    }

    // Currency warning
    let currencyWarningHtml = '';
    if (currencyWarning) {
        currencyWarningHtml = `<div style="background:#eff6ff; border:1px solid #3b82f6; border-radius:8px; padding:12px; margin-bottom:16px; font-size:13px; color:#1e40af;">
            &#9432; Currency conversion rate for ${escapeHtml(supCurrency)} not available &mdash; values shown in original currency without EUR conversion.
        </div>`;
    }

    // Files Section
    let filesHtml = '';
    if (files.length > 0) {
        filesHtml = `
            <div style="margin-top:20px; padding-top:15px; border-top:1px solid #eee;">
                <div style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; margin-bottom:8px;">Attachments</div>
                <div style="display:flex; flex-wrap:wrap; gap:8px;">
                    ${files.map(f => `
                        <a href="/api/supplier_interaction/file/${f.id}" target="_blank" class="macos-btn-secondary" style="font-size:12px; padding:6px 12px; text-decoration:none;">
                            üìé ${escapeHtml(f.name)} <span style="font-size:10px; opacity:0.6;">(${(f.size / 1024).toFixed(1)}KB)</span>
                        </a>
                    `).join('')}
                </div>
            </div>
        `;
    }

    const isClosed = ['approved', 'rejected', 'lost'].includes(acc.status);
    let footerActions = '';

    if (isClosed) {
        footerActions = `
            <div style="margin-right:auto; display:flex; align-items:center; gap:8px;">
                <span style="width:10px; height:10px; border-radius:50%; background:${acc.status === 'approved' ? '#10b981' : '#ef4444'};"></span>
                <span style="font-size:13px; font-weight:600; text-transform:uppercase; color:#64748b;">${acc.status}</span>
            </div>
            <button class="rfq-btn-secondary" onclick="window.closeRfqModal()">Close</button>
        `;
    } else {
        footerActions = `
            <button class="rfq-btn-secondary" style="color:#ef4444; border-color:#fee2e2; margin-right:auto;" onclick="window.rejectSupplierSubmission('${tokenId}', 'reject')">Reject Quote</button>
            <button class="rfq-btn-secondary" style="color:#f59e0b; border-color:#fcd34d; margin-right:8px;" onclick="window.rejectSupplierSubmission('${tokenId}', 're_quote')">üîÑ Re-Quote</button>
            <button class="rfq-btn-secondary" onclick="window.closeRfqModal()">Cancel</button>
            <button class="rfq-btn" onclick="window.approveSupplierSubmission('${tokenId}')">‚úÖ Approve Submission</button>
        `;
    }

    // Reopen requested badge
    const reopenRequested = acc.reopen_requested || (submission.reopen_requested);
    let reopenBadge = '';
    if (reopenRequested) {
        reopenBadge = `<span style="background:#fef3c7; color:#92400e; font-size:11px; font-weight:600; padding:3px 10px; border-radius:99px; margin-left:8px;">Re-Open Requested</span>`;
    }

    // Round History (B4)
    const roundHistory = acc.round_history || [];
    let historyHtml = '';
    if (roundHistory.length > 0) {
        let historyRows = '';
        roundHistory.forEach(rh => {
            const rhItems = (rh.submission_data && rh.submission_data.items) || [];
            const rhNotes = (rh.submission_data && rh.submission_data.notes) || '';
            const rhCurrency = (rh.submission_data && rh.submission_data.currency) || 'EUR';
            const itemSummary = rhItems.map(ri => {
                const noBid = ri.no_bid ? '<span style="color:#dc2626; font-size:10px;">[No Bid]</span>' : '';
                return `<div style="font-size:11px; padding:1px 0;">${escapeHtml(ri.item_drawing_no || ri.id || '?')}: ${ri.no_bid ? '-' : (ri.price || '-') + ' ' + rhCurrency} ${noBid}</div>`;
            }).join('');
            const decisionBadge = rh.buyer_decision
                ? `<span style="font-size:10px; font-weight:700; padding:2px 6px; border-radius:4px; background:${rh.buyer_decision === 'approved' ? '#dcfce7; color:#16a34a' : rh.buyer_decision === 're_quote' ? '#fef3c7; color:#92400e' : '#fee2e2; color:#dc2626'};">${escapeHtml(rh.buyer_decision)}</span>`
                : '<span style="font-size:10px; color:#94a3b8;">pending</span>';
            historyRows += `
                <div style="border:1px solid #e2e8f0; border-radius:8px; padding:12px; margin-bottom:8px; background:#fafbfc;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span style="font-weight:700; font-size:13px;">Round ${rh.round}</span>
                            ${decisionBadge}
                        </div>
                        <span style="font-size:11px; color:#64748b;">${rh.submitted_at ? new Date(rh.submitted_at).toLocaleDateString() : '-'}</span>
                    </div>
                    ${rh.decision_reason ? `<div style="font-size:11px; color:#64748b; margin-bottom:6px;">Reason: ${escapeHtml(rh.decision_reason)}</div>` : ''}
                    <details style="cursor:pointer;">
                        <summary style="font-size:11px; color:#2563eb; font-weight:600;">View Items (${rhItems.length})</summary>
                        <div style="margin-top:6px; padding:8px; background:white; border-radius:4px; border:1px solid #e2e8f0;">
                            ${itemSummary || '<div style="font-size:11px; color:#94a3b8;">No data</div>'}
                            ${rhNotes ? `<div style="font-size:11px; color:#64748b; margin-top:6px; padding-top:6px; border-top:1px solid #e2e8f0;">Notes: ${escapeHtml(rhNotes)}</div>` : ''}
                        </div>
                    </details>
                </div>`;
        });
        historyHtml = `
            <div style="margin-top:24px; padding-top:20px; border-top:1px solid #e2e8f0;">
                <div style="font-size:14px; font-weight:700; margin-bottom:12px; color:#1e293b;">Round History</div>
                ${historyRows}
            </div>`;
    }

    // Portal Link
    const portalUrl = `/supplier_portal/${acc.id}`;

    const modalHtml = `
        <div class="rfq-modal-header">
            <div style="display:flex; align-items:center; gap:12px;">
                <h2 style="margin:0; font-size:18px; font-weight:700;">${escapeHtml(acc.supplier_name)}</h2>
                <span class="round-badge" style="background:var(--accent-blue);">Round ${acc.round}</span>
                <a href="${portalUrl}" target="_blank" class="text-link" style="font-size:12px; margin-left:8px;">View as Supplier ‚Üó</a>
                ${reopenBadge}
            </div>
            <button class="btn-icon" onclick="window.closeRfqModal()" style="font-size:24px;">&times;</button>
        </div>
        
        <div class="rfq-modal-content" style="padding:0;">
            <!-- Summary Bar -->
            <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:1px; background:#e2e8f0; border-bottom:1px solid #e2e8f0;">
                <div style="background:white; padding:15px; text-align:center;">
                    <div style="font-size:11px; color:#64748b; font-weight:600; text-transform:uppercase;">Items Quoted</div>
                    <div style="font-size:18px; font-weight:700;">${matchedCount} / ${acc.items_count}</div>
                </div>
                <div style="background:white; padding:15px; text-align:center;">
                    <div style="font-size:11px; color:#64748b; font-weight:600; text-transform:uppercase;">Target Total (Internal)</div>
                    <div style="font-size:18px; font-weight:700;">${totalProjectTarget.toFixed(2)} <span style="font-size:12px;">EUR</span></div>
                </div>
                <div style="background:white; padding:15px; text-align:center;">
                    <div style="font-size:11px; color:#64748b; font-weight:600; text-transform:uppercase;">Quote Total (${supCurrency})</div>
                    <div style="font-size:18px; font-weight:700; color:${totalQuotedEUR <= totalProjectTarget ? '#10b981' : '#ef4444'};">
                        ${totalQuotedOriginal.toFixed(2)} <span style="font-size:12px;">${supCurrency}</span>
                    </div>
                    ${supCurrency !== 'EUR' && !currencyWarning ? `<div style="font-size:11px; color:#64748b; margin-top:2px;">~${totalQuotedEUR.toFixed(2)} EUR</div>` : ''}
                </div>
                <div style="background:white; padding:15px; text-align:center;">
                    <div style="font-size:11px; color:#64748b; font-weight:600; text-transform:uppercase;">Savings est. (EUR)</div>
                    <div style="font-size:18px; font-weight:700; color:${savings >= 0 ? '#10b981' : '#ef4444'};">
                        ${savings >= 0 ? '+' : ''}${savings.toFixed(2)} <span style="font-size:11px;">(${savingsPercent.toFixed(1)}%)</span>
                    </div>
                </div>
            </div>

            <div style="padding:24px;">
                ${currencyWarningHtml}
                ${unmatchedWarning}
                ${(() => {
                    const scn = submission.supplier_contact_name || '';
                    const sce = submission.supplier_contact_email || '';
                    const scp = submission.supplier_contact_phone || '';
                    if (!scn && !sce && !scp) return '';
                    return `<div style="background:#f0fdf4; border:1px solid #bbf7d0; border-radius:10px; padding:16px; margin-bottom:24px;">
                        <div style="font-size:11px; font-weight:700; color:#16a34a; text-transform:uppercase; margin-bottom:8px;">Supplier Contact</div>
                        <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:16px;">
                            ${scn ? `<div><div style="font-size:11px; color:#64748b;">Name</div><div style="font-weight:600;">${escapeHtml(scn)}</div></div>` : ''}
                            ${sce ? `<div><div style="font-size:11px; color:#64748b;">Email</div><div style="font-weight:600;"><a href="mailto:${escapeHtml(sce)}" style="color:#2563eb;">${escapeHtml(sce)}</a></div></div>` : ''}
                            ${scp ? `<div><div style="font-size:11px; color:#64748b;">Phone</div><div style="font-weight:600;">${escapeHtml(scp)}</div></div>` : ''}
                        </div>
                    </div>`;
                })()}
                <!-- Internal Notes -->
                <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; padding:16px; margin-bottom:24px;">
                    <div style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; margin-bottom:6px;">Supplier Remarks</div>
                    <div style="font-size:13px; color:#334155; line-height:1.5; white-space:pre-wrap;">${escapeHtml(notes || 'No remarks provided.')}</div>
                    ${filesHtml}
                </div>

                <div style="font-size:14px; font-weight:700; margin-bottom:12px; color:#1e293b;">Quote Details</div>
                <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin-bottom:24px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; padding:16px;">
                    <div><div style="font-size:11px; font-weight:600; color:#64748b; text-transform:uppercase;">Currency</div><div style="font-weight:600; margin-top:4px;">${escapeHtml(supCurrency)}</div></div>
                    <div><div style="font-size:11px; font-weight:600; color:#64748b; text-transform:uppercase;">Incoterms</div><div style="font-weight:600; margin-top:4px;">${escapeHtml(quoteIncoterms || '-')}</div></div>
                    <div><div style="font-size:11px; font-weight:600; color:#64748b; text-transform:uppercase;">Payment Terms</div><div style="font-weight:600; margin-top:4px;">${escapeHtml(quotePaymentTerms || '-')}</div></div>
                    <div><div style="font-size:11px; font-weight:600; color:#64748b; text-transform:uppercase;">Shipping</div><div style="font-weight:600; margin-top:4px;">${quoteShipping ? escapeHtml(quoteShipping) + ' ' + escapeHtml(supCurrency) : '-'}</div></div>
                    <div><div style="font-size:11px; font-weight:600; color:#64748b; text-transform:uppercase;">Quote #</div><div style="font-weight:600; margin-top:4px;">${escapeHtml(quoteNumber || '-')}</div></div>
                    <div><div style="font-size:11px; font-weight:600; color:#64748b; text-transform:uppercase;">Valid Until</div><div style="font-weight:600; margin-top:4px;">${escapeHtml(quoteValidUntil || '-')}</div></div>
                    <div><div style="font-size:11px; font-weight:600; color:#64748b; text-transform:uppercase;">Packaging</div><div style="font-weight:600; margin-top:4px;">${escapeHtml(quotePackaging || '-')}</div></div>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <div style="font-size:14px; font-weight:700; color:#1e293b;">Detailed Comparison</div>
                    ${noBidCount > 0 ? `<span style="background:#fee2e2; color:#dc2626; font-size:11px; font-weight:600; padding:3px 10px; border-radius:99px;">${noBidCount} No Bid</span>` : ''}
                </div>
                <div class="table-wrapper" style="border:1px solid #e2e8f0; border-radius:8px;">
                    <table class="rfq-table">
                        <thead>
                            <tr>
                                <th style="width:25%;">Item</th>
                                <th style="width:50%;">Price Tiers (Target vs Quote)</th>
                                <th style="width:25%; text-align:center;">MOQ / Lead / Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows || '<tr><td colspan="3" style="text-align:center; padding:30px; color:#94a3b8;">No matching items found.</td></tr>'}
                        </tbody>
                    </table>
                </div>
                ${historyHtml}
            </div>
        </div>

        <div class="rfq-modal-footer">
            ${footerActions}
        </div>
    `;

    window.closeRfqModal();

    const overlay = document.createElement('div');
    overlay.className = 'rfq-modal-overlay';
    overlay.innerHTML = `<div class="rfq-modal">${modalHtml}</div>`;
    document.body.appendChild(overlay);

    overlay.onclick = (e) => {
        if (e.target === overlay) window.closeRfqModal();
    };
};

window.closeRfqModal = function () {
    document.querySelectorAll('.rfq-modal-overlay, .modal-overlay').forEach(el => el.remove());
};

window.rejectSupplierSubmission = function (tokenId) {
    // Open Dialog for Action Selection
    const backdrop = document.createElement('div');
    backdrop.className = 'rfq-dialog-backdrop';
    // Nested removal logic
    const close = () => { backdrop.remove(); };

    const dialog = document.createElement('div');
    dialog.className = 'rfq-custom-dialog';
    dialog.style.width = '400px';
    dialog.innerHTML = `
        <div style="font-size:16px; font-weight:600; margin-bottom:15px;">Decision: Reject or Re-Quote</div>
        
        <label style="display:block; margin-bottom:4px; font-size:12px; font-weight:600;">Action</label>
        <select id="rj-action" style="width:100%; padding:8px; margin-bottom:15px; border:1px solid #ccc; border-radius:4px;">
            <option value="re_quote">Request New Quote (Round +1)</option>
            <option value="lost">Mark as Lost (Too high / No capacity)</option>
            <option value="reject">Reject (Close Interaction)</option>
        </select>
        
        <label style="display:block; margin-bottom:4px; font-size:12px; font-weight:600;">Reason (Required)</label>
        <textarea id="rj-reason" rows="3" style="width:100%; padding:8px; margin-bottom:15px; border:1px solid #ccc; border-radius:4px;" placeholder="Message to supplier..."></textarea>
        
        <div class="rfq-dialog-buttons">
            <button class="btn-secondary" id="rj-cancel">Cancel</button>
            <button class="btn-primary" id="rj-confirm">Confirm Decision</button>
        </div>
    `;

    backdrop.appendChild(dialog);
    document.body.appendChild(backdrop);

    dialog.querySelector('#rj-cancel').onclick = close;
    dialog.querySelector('#rj-confirm').onclick = async () => {
        const action = document.getElementById('rj-action').value;
        const reason = document.getElementById('rj-reason').value;

        if (!reason.trim()) {
            window.showAlert("Please enter a reason.");
            return;
        }

        // Call API
        try {
            const res = await fetch(`/api/supplier_access/${tokenId}/reject`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ action, reason })
            });

            if (res.ok) {
                const json = await res.json();
                close(); // close reject dialog
                document.querySelector('.rfq-modal-overlay')?.remove(); // close parent modal
                window.showAlert(`Updated: Status is now ${json.new_status}`);
                // Refresh project data in-place (no page reload)
                // NOTE: outside init closure ‚Äî must use window.currentProject
                const project = window.currentProject || (window.RFQData && window.RFQData.activeProject);
                if (project && project.id) {
                    try {
                        const freshRes = await fetch(`/api/projects/${project.id}`);
                        if (freshRes.ok) {
                            const freshJson = await freshRes.json();
                            if (freshJson.project) {
                                Object.assign(project, freshJson.project);
                                if (window.RFQData) window.RFQData.activeProject = project;
                                window.currentProject = project;
                            }
                        }
                    } catch (err) {
                        console.error('Failed to refresh project after reject:', err);
                    }
                }
                // Re-render Supplier Interaction tab
                if (typeof window.renderSupplierInteraction === 'function') {
                    window.renderSupplierInteraction();
                }
            } else {
                window.showAlert("Error updating status.");
            }
        } catch (e) {
            console.error(e);
            window.showAlert("Network error.");
        }
    };
};

window.approveSupplierSubmission = async function (tokenId) {
    window.showConfirm("Are you sure you want to approve this quote?\n\nThis will sync all quote data (prices, currency, incoterms, etc.) into Suppliers & Pricing for the matched items.", async () => {
        try {
            const res = await fetch(`/api/supplier_access/${tokenId}/approve`, {
                method: 'POST',
                headers: { 'X-CSRFToken': getCookie('csrftoken') }
            });

            if (res.ok) {
                const json = await res.json();
                document.querySelector('.rfq-modal-overlay')?.remove();
                window.showAlert(`Success! Updated ${json.updated_items} items.${json.unmatched_items ? ' (' + json.unmatched_items + ' unmatched)' : ''}`);

                // Refresh project data in-place (no page reload)
                // NOTE: outside init closure ‚Äî must use window.currentProject
                const project = window.currentProject || (window.RFQData && window.RFQData.activeProject);
                if (project && project.id) {
                    try {
                        const freshRes = await fetch(`/api/projects/${project.id}`);
                        if (freshRes.ok) {
                            const freshJson = await freshRes.json();
                            if (freshJson.project) {
                                Object.assign(project, freshJson.project);
                                if (window.RFQData) window.RFQData.activeProject = project;
                                window.currentProject = project;
                            }
                        }
                    } catch (err) {
                        console.error('Failed to refresh project after approve:', err);
                    }
                }
                // Re-render Supplier Interaction tab
                if (typeof window.renderSupplierInteraction === 'function') {
                    window.renderSupplierInteraction();
                }

            } else {
                window.showAlert("Error approving quote.");
            }
        } catch (e) {
            console.error(e);
            window.showAlert("Network error.");
        }
    });
};

// Custom Dialog Helpers
window.showConfirm = function (message, onConfirm) {
    const backdrop = document.createElement('div');
    backdrop.className = 'rfq-dialog-backdrop';

    // Escape first, then convert newlines for HTML
    const htmlMsg = escapeHtml(String(message)).replace(/\n/g, '<br>');

    const dialog = document.createElement('div');
    dialog.className = 'rfq-custom-dialog';
    dialog.innerHTML = `
        <div style="font-size:16px; font-weight:600; margin-bottom:10px;">Confirmation Required</div>
        <div style="font-size:14px; color:#333; line-height:1.4;">${htmlMsg}</div>
        <div class="rfq-dialog-buttons">
            <button class="btn-secondary" id="rfq-confirm-cancel">Cancel</button>
            <button class="btn-primary" id="rfq-confirm-ok">Confirm</button>
        </div>
    `;

    backdrop.appendChild(dialog);
    document.body.appendChild(backdrop);

    const close = () => {
        backdrop.remove();
        dialog.remove();
    };

    document.getElementById('rfq-confirm-cancel').onclick = close;
    document.getElementById('rfq-confirm-ok').onclick = () => {
        close();
        onConfirm();
    };
};

window.showAlert = function (message) {
    const backdrop = document.createElement('div');
    backdrop.className = 'rfq-dialog-backdrop';

    const htmlMsg = escapeHtml(String(message)).replace(/\n/g, '<br>');

    const dialog = document.createElement('div');
    dialog.className = 'rfq-custom-dialog';
    dialog.innerHTML = `
        <div style="font-size:16px; font-weight:600; margin-bottom:10px;">Notice</div>
        <div style="font-size:14px; color:#333; line-height:1.4;">${htmlMsg}</div>
        <div class="rfq-dialog-buttons">
            <button class="btn-primary" id="rfq-alert-ok">OK</button>
        </div>
    `;

    backdrop.appendChild(dialog);
    document.body.appendChild(backdrop);

    const close = () => {
        backdrop.remove();
        dialog.remove();
    };

    document.getElementById('rfq-alert-ok').onclick = close;
};


/**
 * Calls API to generate a secure link for a supplier
 */
// Instruction message templates
window._instructionTemplates = [
    { id: 'default', label: 'Default ‚Äî Best pricing & lead times', text: 'Please provide your best pricing and lead times for the items below.' },
    { id: 'competitive', label: 'Most competitive offer', text: 'Please review the items below and submit your most competitive offer.' },
    { id: 'moq', label: 'Include MOQ and lead time', text: 'We invite you to quote on the following items. Please include MOQ and lead time.' },
    { id: 'tiers', label: 'All quantity tiers', text: 'Kindly provide pricing for all quantity tiers listed. Target prices are for reference only.' },
    { id: 'deadline', label: 'Deadline warning', text: 'Please submit your quotation by the deadline shown. Late submissions may not be considered.' },
    { id: 'survey', label: 'Market survey', text: 'We are conducting a market survey. Please provide indicative pricing for the items below.' },
];

window._showGenerateConfigModal = function(supplierNames, isBulk) {
    const project = (typeof currentProject !== 'undefined') ? currentProject : window.RFQData.activeProject;
    if (!project) return;

    const title = isBulk
        ? `Generate Portal Links (${supplierNames.length} suppliers)`
        : `Generate Portal Link ‚Äî ${escapeHtml(supplierNames[0])}`;

    const templates = window._instructionTemplates;
    const templateOptions = templates.map(t =>
        `<option value="${t.id}">${escapeHtml(t.label)}</option>`
    ).join('') + '<option value="custom">Custom Text</option>';

    const modalHtml = `
        <div class="rfq-modal-header">
            <h2 style="margin:0; font-size:18px; font-weight:700;">${title}</h2>
            <button class="btn-icon" onclick="window.closeRfqModal()" style="font-size:24px;">&times;</button>
        </div>
        <div class="rfq-modal-content" style="padding:24px;">
            <div style="font-size:13px; font-weight:600; color:#64748b; margin-bottom:16px;">Buyer Contact Information (visible to supplier)</div>
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-bottom:20px;">
                <div>
                    <label style="font-size:12px; font-weight:600; display:block; margin-bottom:4px;">Contact Name</label>
                    <input id="gen-contact-name" class="rfq-input" style="width:100%;" placeholder="Your name" value="${escapeHtml(project.contact_person || '')}">
                </div>
                <div>
                    <label style="font-size:12px; font-weight:600; display:block; margin-bottom:4px;">Email</label>
                    <input id="gen-contact-email" class="rfq-input" style="width:100%;" type="email" placeholder="your@company.com">
                </div>
                <div>
                    <label style="font-size:12px; font-weight:600; display:block; margin-bottom:4px;">Phone</label>
                    <input id="gen-contact-phone" class="rfq-input" style="width:100%;" type="tel" placeholder="+1 234 567 890">
                </div>
            </div>

            <div style="margin-bottom:20px;">
                <label style="font-size:12px; font-weight:600; display:block; margin-bottom:4px;">Instruction Message</label>
                <select id="gen-instruction-template" class="rfq-input" style="width:100%; margin-bottom:8px;" onchange="document.getElementById('gen-instruction-custom').style.display = this.value === 'custom' ? 'block' : 'none';">
                    ${templateOptions}
                </select>
                <textarea id="gen-instruction-custom" class="rfq-input" style="width:100%; min-height:60px; display:none;" placeholder="Enter your custom instruction text..."></textarea>
            </div>

            <div style="margin-bottom:20px;">
                <label style="font-size:12px; font-weight:600; display:block; margin-bottom:4px;">Response Deadline</label>
                <input id="gen-valid-until" class="rfq-input" type="date" style="width:200px;">
            </div>
        </div>
        <div class="rfq-modal-footer">
            <button class="rfq-btn-secondary" onclick="window.closeRfqModal()">Cancel</button>
            <button class="rfq-btn" id="gen-submit-btn">Generate Link${isBulk ? 's' : ''}</button>
        </div>
    `;

    window.closeRfqModal();
    const overlay = document.createElement('div');
    overlay.className = 'rfq-modal-overlay';
    overlay.innerHTML = `<div class="rfq-modal" style="max-width:600px;">${modalHtml}</div>`;
    document.body.appendChild(overlay);
    overlay.onclick = (e) => { if (e.target === overlay) window.closeRfqModal(); };

    document.getElementById('gen-submit-btn').onclick = async function() {
        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Generating...';

        const contactName = document.getElementById('gen-contact-name').value.trim();
        const contactEmail = document.getElementById('gen-contact-email').value.trim();
        const contactPhone = document.getElementById('gen-contact-phone').value.trim();
        const templateId = document.getElementById('gen-instruction-template').value;
        const customText = document.getElementById('gen-instruction-custom').value.trim();
        const validUntil = document.getElementById('gen-valid-until').value;

        let instructionMessage = '';
        if (templateId === 'custom') {
            instructionMessage = customText;
        } else if (templateId !== 'default') {
            const tmpl = templates.find(t => t.id === templateId);
            if (tmpl) instructionMessage = tmpl.text;
        }

        try {
            // Ensure project data is synced to DB before generating link
            try {
                if (window.RFQData && window.RFQData.updateProject) {
                    window.RFQData.updateProject(project);
                }
                if (window.RFQData && window.RFQData.syncNowAsync) {
                    await window.RFQData.syncNowAsync();
                }
            } catch (syncErr) {
                console.warn('Pre-generate sync warning:', syncErr);
            }

            if (isBulk) {
                const res = await fetch('/api/supplier_access/bulk_generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                    body: JSON.stringify({
                        project_id: project.id,
                        supplier_names: supplierNames,
                        contact_name: contactName, contact_email: contactEmail, contact_phone: contactPhone,
                        instruction_message: instructionMessage, valid_until: validUntil
                    })
                });
                if (!res.ok) {
                    const errText = await res.text();
                    throw new Error(`API Error ${res.status}: ${errText || 'bulk_generate failed'}`);
                }
                const json = await res.json();
                window.closeRfqModal();
                window.showAlert(`${json.count} portal link(s) generated successfully.`);
                window.renderSupplierInteraction();
            } else {
                const sName = supplierNames[0];
                const res = await fetch('/api/supplier_access/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                    body: JSON.stringify({
                        project_id: project.id, supplier_name: sName,
                        contact_name: contactName, contact_email: contactEmail, contact_phone: contactPhone,
                        instruction_message: instructionMessage, valid_until: validUntil
                    })
                });
                if (!res.ok) {
                    const errText = await res.text();
                    throw new Error(`API Error ${res.status}: ${errText || 'generate failed'}`);
                }
                const json = await res.json();
                if (json.access && json.access.id) {
                    const link = `${location.origin}/portal/${json.access.id}/`;
                    window.closeRfqModal();

                    const canClipboard = !!(navigator && navigator.clipboard && navigator.clipboard.writeText);
                    if (canClipboard) {
                        navigator.clipboard.writeText(link).catch(() => {});
                        window.showAlert(`Portal link generated for ${sName}. Link copied to clipboard.`);
                    } else {
                        // HTTP / non-secure context fallback
                        window.showAlert(`Portal link generated for ${sName}: ${link}`);
                    }

                    window.renderSupplierInteraction();
                }
            }
        } catch (e) {
            console.error(e);
            btn.disabled = false;
            btn.innerHTML = `Generate Link${isBulk ? 's' : ''}`;
            const msg = (e && e.message) ? e.message : 'Error generating link. Please try again.';
            window.showAlert(`Error generating link: ${msg}`);
        }
    };
};

window.generateSupplierLink = function (sName) {
    window._showGenerateConfigModal([sName], false);
};

window.bulkGenerateLinks = function () {
    const checked = document.querySelectorAll('.sim-chk:checked:not(:disabled)');
    const names = Array.from(checked).map(cb => cb.value).filter(Boolean);
    if (names.length === 0) { window.showAlert('Select at least one supplier.'); return; }
    window._showGenerateConfigModal(names, true);
};

window.updateSupplierItems = async function(tokenId) {
    window.showConfirm('Add newly assigned items to this supplier\'s portal? The supplier will be notified.', async () => {
        try {
            const res = await fetch(`/api/supplier_access/${tokenId}/update_items`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') }
            });
            if (!res.ok) throw new Error('API Error');
            const json = await res.json();
            window.showAlert(json.message || 'Items updated.');
            window.renderSupplierInteraction();
        } catch (e) {
            console.error(e);
            window.showAlert('Error updating items. Please try again.');
        }
    });
};

window.cancelSupplierAccess = async function(tokenId) {
    window.showConfirm('Cancel this portal link? The supplier will no longer be able to submit.', async () => {
        try {
            const res = await fetch(`/api/supplier_access/${tokenId}/cancel`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') }
            });
            if (!res.ok) throw new Error('API Error');
            window.showAlert('Portal cancelled.');
            window.renderSupplierInteraction();
        } catch (e) {
            console.error(e);
            window.showAlert('Error cancelling portal.');
        }
    });
};

window.reopenSupplierAccess = async function(tokenId) {
    window.showConfirm('Reopen this portal? A new round will be created and the supplier can submit again.', async () => {
        try {
            const res = await fetch(`/api/supplier_access/${tokenId}/reopen`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') }
            });
            if (!res.ok) {
                const errText = await res.text();
                throw new Error(`API Error ${res.status}: ${errText || 'reopen failed'}`);
            }
            window.showAlert('Portal reopened.');
            window.renderSupplierInteraction();
        } catch (e) {
            console.error(e);
            const msg = (e && e.message) ? e.message : 'Error reopening portal.';
            window.showAlert(`Error reopening portal: ${msg}`);
        }
    });
};

// Event Delegation for Supplier Interaction Tab Switching
document.addEventListener('click', function (e) {
    // Check if clicked element is our new tab
    if (e.target && e.target.closest) {
        const tabBtn = e.target.closest('.rfq-tab[data-tab="supplier-interaction"]');
        if (tabBtn) {
            // 1. Deactivate other tabs in the same container
            const container = tabBtn.parentElement;
            if (container) {
                container.querySelectorAll('.rfq-tab').forEach(t => t.classList.remove('active'));
            }
            tabBtn.classList.add('active');

            // 2. Hide all common tab content sections in the Quoting view
            ['supplier-selection', 'rfq-planner', 'price-comparison', 'final-summary', 'supplier-interaction'].forEach(k => {
                const el = document.getElementById(`tab-${k}`);
                if (el) el.classList.add('hidden');
            });

            // 3. Show our content
            const content = document.getElementById('tab-supplier-interaction');
            if (content) {
                content.classList.remove('hidden');
                window.renderSupplierInteraction();
            }
            return;
        }

        // Handle SIBLING tabs in the SAME header
        const otherTab = e.target.closest('.rfq-tab[data-tab]:not([data-tab="supplier-interaction"])');
        // Only if inside the same header (to avoid conflict with other tabs elsewhere)
        if (otherTab && otherTab.closest('.rfq-tabs-header')) {
            // If another tab is clicked in the quoting header, ensure ours is hidden
            const myContent = document.getElementById('tab-supplier-interaction');
            if (myContent) myContent.classList.add('hidden');
        }
    }
});

// =========================================================
// QUOTES CENTER - Centr√°ln√≠ datab√°ze nab√≠dek (global scope)
// 3-level hierarchical view: Supplier Cards ‚Üí Quotes ‚Üí Detail
// =========================================================

const _qEsc = (text) => text ? String(text).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' })[m]) : '';

function _qFetchJson(url, opts = {}) {
    const headers = Object.assign({ 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') }, opts.headers || {});
    return fetch(url, Object.assign({}, opts, { headers })).then(r => r.json());
}

function _qGetProjects() {
    return (window.RFQData && typeof window.RFQData.getProjects === 'function') ? window.RFQData.getProjects() : [];
}

/* --- Quotes Center state --- */
let _quotesCache = [];
let _quotesLevel = 1;
let _quotesSupplier = null;
let _quotesCurrentId = null;

/* --- Helper functions --- */
function _updateQuotesStats(quotes) {
    const suppliers = new Set();
    let totalItems = 0;
    let activeCount = 0;
    const now = new Date();
    quotes.forEach(q => {
        if (q.supplier_name) suppliers.add(q.supplier_name);
        totalItems += (q.lines_count || q.lines?.length || 0);
        const exp = q.expire_date ? new Date(q.expire_date) : null;
        if (!exp || exp >= now) activeCount++;
    });
    const el = id => document.getElementById(id);
    const s = el('qs-total-suppliers');
    const t = el('qs-total-quotes');
    const i = el('qs-total-items');
    const a = el('qs-active-quotes');
    if (s) s.textContent = suppliers.size;
    if (t) t.textContent = quotes.length;
    if (i) i.textContent = totalItems;
    if (a) a.textContent = activeCount;
}

function _showBreadcrumb(show) {
    const bc = document.getElementById('quotes-breadcrumb');
    if (bc) bc.classList.toggle('hidden', !show);
}

function _setBreadcrumb(supplier, quoteNum) {
    const bcSup = document.getElementById('quotes-bc-supplier');
    const bcSep2 = document.getElementById('quotes-bc-sep2');
    const bcQ = document.getElementById('quotes-bc-quote');
    if (bcSup) {
        bcSup.textContent = supplier || '';
        bcSup.style.cursor = supplier ? 'pointer' : 'default';
    }
    if (bcSep2) bcSep2.classList.toggle('hidden', !quoteNum);
    if (bcQ) {
        bcQ.textContent = quoteNum || '';
        bcQ.classList.toggle('hidden', !quoteNum);
        bcQ.style.cursor = quoteNum ? 'pointer' : 'default';
        if (_quotesCurrentId) bcQ.setAttribute('data-quote-id', String(_quotesCurrentId));
    }
}

function _avatarColor(name) {
    const colors = ['#007AFF', '#5856d6', '#ff9500', '#34c759', '#ff3b30', '#af52de', '#ff2d55', '#00c7be', '#30b0c7', '#a2845e'];
    let h = 0;
    for (let i = 0; i < name.length; i++) h = name.charCodeAt(i) + ((h << 5) - h);
    return colors[Math.abs(h) % colors.length];
}

function _fmtDate(d) {
    if (!d) return '\u2014';
    const dt = new Date(d);
    if (isNaN(dt)) return '\u2014';
    return dt.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
}

/* --- Level 1: Supplier Cards --- */
function _renderQuotesLevel1() {
    const content = document.getElementById('quotes-content');
    if (!content) return;
    _quotesLevel = 1;
    _quotesSupplier = null;
    _quotesCurrentId = null;
    _showBreadcrumb(false);

    if (_quotesCache.length === 0) {
        content.innerHTML = `<div class="quotes-empty">
            <div class="quotes-empty-icon">üìã</div>
            <div class="quotes-empty-title">No Quotes Yet</div>
            <div class="quotes-empty-sub">Create your first quote by clicking "‚ûï New Quote" above, or quotes will appear here when imported from the Quoting module or Supplier Portal.</div>
        </div>`;
        return;
    }

    const bySupplier = {};
    const now = new Date();
    _quotesCache.forEach(q => {
        const sup = q.supplier_name || 'Unknown';
        if (!bySupplier[sup]) bySupplier[sup] = { quotes: [], projects: new Set(), items: 0, active: 0, lastDate: null };
        const grp = bySupplier[sup];
        grp.quotes.push(q);
        if (q.project_name) grp.projects.add(q.project_name);
        grp.items += (q.lines_count || q.lines?.length || 0);
        const exp = q.expire_date ? new Date(q.expire_date) : null;
        if (!exp || exp >= now) grp.active++;
        const cd = q.create_date ? new Date(q.create_date) : null;
        if (cd && (!grp.lastDate || cd > grp.lastDate)) grp.lastDate = cd;
    });

    const sorted = Object.entries(bySupplier).sort((a, b) => b[1].quotes.length - a[1].quotes.length);

    let html = '<div class="quotes-supplier-grid">';
    sorted.forEach(([name, grp]) => {
        const initials = name.split(/\s+/).map(w => w[0]).join('').substring(0, 2).toUpperCase();
        const color = _avatarColor(name);
        const projStr = grp.projects.size > 0 ? Array.from(grp.projects).slice(0, 3).join(', ') + (grp.projects.size > 3 ? ` +${grp.projects.size - 3}` : '') : 'No project';
        const expired = grp.quotes.length - grp.active;
        const lastDt = grp.lastDate ? _fmtDate(grp.lastDate) : '\u2014';

        html += `<div class="quotes-supplier-card" data-supplier="${_qEsc(name)}">
            <div class="qs-card-header">
                <div class="qs-card-avatar" style="background:${color}">${initials}</div>
                <div style="flex:1; min-width:0;">
                    <div class="qs-card-name">${_qEsc(name)}</div>
                    <div class="qs-card-projects">${_qEsc(projStr)}</div>
                </div>
            </div>
            <div class="qs-card-stats">
                <div class="qs-card-stat"><div class="qs-card-stat-val">${grp.quotes.length}</div><div class="qs-card-stat-label">Quotes</div></div>
                <div class="qs-card-stat"><div class="qs-card-stat-val">${grp.items}</div><div class="qs-card-stat-label">Items</div></div>
                <div class="qs-card-stat"><div class="qs-card-stat-val">${grp.active}</div><div class="qs-card-stat-label">Active</div></div>
            </div>
            <div class="qs-card-footer">
                <span>Last: ${lastDt}</span>
                ${expired > 0 ? `<span class="qs-card-badge expired">${expired} expired</span>` : `<span class="qs-card-badge active">All active</span>`}
            </div>
        </div>`;
    });
    html += '</div>';
    content.innerHTML = html;

    content.querySelectorAll('.quotes-supplier-card[data-supplier]').forEach(card => {
        card.addEventListener('click', () => {
            const supplierName = card.getAttribute('data-supplier');
            if (supplierName) window._quotesOpenSupplier(supplierName);
        });
    });
}

window._quotesOpenSupplier = function(name) {
    _quotesSupplier = name;
    _renderQuotesLevel2(name);
};

/* --- Level 2: Quote List for Supplier --- */
function _renderQuotesLevel2(supplierName) {
    const content = document.getElementById('quotes-content');
    if (!content) return;
    _quotesLevel = 2;
    _quotesCurrentId = null;
    _showBreadcrumb(true);
    _setBreadcrumb(supplierName, null);

    const quotes = _quotesCache.filter(q => q.supplier_name === supplierName);
    const now = new Date();

    if (quotes.length === 0) {
        content.innerHTML = `<div class="quotes-empty">
            <div class="quotes-empty-icon">üìÑ</div>
            <div class="quotes-empty-title">No quotes for ${_qEsc(supplierName)}</div>
            <div class="quotes-empty-sub">This supplier has no quotes matching current filters.</div>
        </div>`;
        return;
    }

    quotes.sort((a, b) => {
        const da = a.create_date ? new Date(a.create_date) : new Date(0);
        const db = b.create_date ? new Date(b.create_date) : new Date(0);
        return db - da;
    });

    let html = `<div style="background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:14px; overflow:hidden;">
        <table class="quotes-list-table"><thead><tr>
            <th>Quote #</th><th>Project</th><th>Items</th><th>Currency</th><th>Expire Date</th><th>Status</th><th>Created</th><th>Actions</th>
        </tr></thead><tbody>`;

    quotes.forEach(q => {
        const expD = q.expire_date ? new Date(q.expire_date) : null;
        const isExpired = expD && expD < now;
        const statusHtml = isExpired
            ? '<span class="qs-status-badge" style="background:#ff3b30;">Expired</span>'
            : '<span class="qs-status-badge" style="background:#34c759;">Active</span>';
        const linesCount = q.lines_count || q.lines?.length || 0;
        const qId = _qEsc(String(q.id));

        html += `<tr data-quote-id="${qId}">
            <td class="qs-quote-num" style="cursor:pointer;" onclick="window._quotesOpenDetail('${qId}')">${_qEsc(q.quote_number || '\u2014')}</td>
            <td>${_qEsc(q.project_name || '\u2014')}</td>
            <td style="text-align:center;">${linesCount}</td>
            <td>${_qEsc(q.currency || 'EUR')}</td>
            <td style="color:${isExpired ? '#ff3b30' : '#34c759'}; font-weight:600;">${_fmtDate(q.expire_date)}</td>
            <td>${statusHtml}</td>
            <td style="color:#888;">${_fmtDate(q.create_date)}</td>
            <td>
                <button class="btn-primary btn-sm" onclick="event.stopPropagation(); window._quotesOpenDetail('${qId}')" type="button">View</button>
                <button class="btn-secondary btn-sm" onclick="event.stopPropagation(); window.showQuoteEditModal('${qId}')" type="button">Edit</button>
                <button class="btn-text btn-sm" style="color:#d00;" onclick="event.stopPropagation(); window.deleteQuote('${qId}')" type="button">üóë</button>
            </td>
        </tr>`;
    });

    html += '</tbody></table></div>';
    content.innerHTML = html;
}

/* --- Level 3: Quote Detail --- */
window._quotesOpenDetail = function(quoteId) {
    const q = _quotesCache.find(q => String(q.id) === String(quoteId));
    if (q) {
        _renderQuotesLevel3(q);
    } else {
        _qFetchJson(`/api/quotes/${quoteId}/`, { method: 'GET' })
            .then(res => {
                if (res && res.quote) _renderQuotesLevel3(res.quote);
                else window.showAlert && window.showAlert('Quote not found');
            })
            .catch(err => { console.error('Error loading quote:', err); window.showAlert && window.showAlert('Error loading quote'); });
    }
};

function _renderQuotesLevel3(quote) {
    const content = document.getElementById('quotes-content');
    if (!content) return;
    _quotesLevel = 3;
    _quotesCurrentId = quote && quote.id ? String(quote.id) : null;
    _showBreadcrumb(true);
    _setBreadcrumb(quote.supplier_name || '\u2014', quote.quote_number || quote.id);

    const lines = quote.lines || [];
    if (lines.length === 0 && (quote.lines_count > 0 || !quote.hasOwnProperty('lines'))) {
        content.innerHTML = '<div style="padding:32px; text-align:center; color:#888;">Loading quote details...</div>';
        _qFetchJson(`/api/quotes/${quote.id}/`, { method: 'GET' })
            .then(res => { _renderQuoteDetailCard(res && res.quote ? res.quote : quote); })
            .catch(() => _renderQuoteDetailCard(quote));
        return;
    }
    _renderQuoteDetailCard(quote);
}

function _renderQuoteDetailCard(quote) {
    const content = document.getElementById('quotes-content');
    if (!content) return;

    const now = new Date();
    const expD = quote.expire_date ? new Date(quote.expire_date) : null;
    const isExpired = expD && expD < now;
    const statusLabel = isExpired ? 'üî¥ Expired' : 'üü¢ Active';
    const lines = quote.lines || [];
    const qId = _qEsc(String(quote.id));

    const field = (label, value, extraClass) => {
        if (!value && value !== 0) return '';
        return `<div class="qd-field"><div class="qd-field-label">${label}</div><div class="qd-field-value ${extraClass || ''}">${_qEsc(String(value))}</div></div>`;
    };

    const buildTiers = (line) => {
        let html = '';
        for (let i = 1; i <= 10; i++) {
            const qty = line['qty_' + i];
            const price = line['price_' + i];
            if (qty && price !== null && price !== undefined) {
                html += `<div style="display:flex; gap:6px; font-size:12px; margin-bottom:2px;">
                    <span style="color:#888; min-width:60px;">${_qEsc(String(qty))} ${_qEsc(line.uom || 'pcs')}:</span>
                    <span style="font-weight:700;">${_qEsc(String(price))} ${_qEsc(quote.currency || 'EUR')}</span>
                </div>`;
            }
        }
        return html || '<span style="color:#bbb;">\u2014</span>';
    };

    let linesHtml = '';
    if (lines.length === 0) {
        linesHtml = '<tr><td colspan="12" style="padding:20px; text-align:center; color:#888;">No line items</td></tr>';
    } else {
        lines.forEach((ln, idx) => {
            const stockInfo = ln.available_stock ? `${ln.available_stock} <span style="font-size:10px; color:#888;">(${_fmtDate(ln.available_stock_date)})</span>` : '\u2014';
            const leadTime = _qEsc(ln.supplier_lead_time || ln.manufacturing_lead_time || '\u2014');
            linesHtml += `<tr>
                <td style="font-weight:600;">${idx + 1}</td>
                <td>${_qEsc(ln.drawing_number || '\u2014')}</td>
                <td>${_qEsc(ln.manufacturer || '\u2014')}</td>
                <td style="font-weight:600;">${_qEsc(ln.mpn || '\u2014')}</td>
                <td style="max-width:180px; color:#666; font-size:11px;">${_qEsc(ln.description || '\u2014')}</td>
                <td>${_qEsc(ln.uom || 'pcs')}</td>
                <td style="min-width:140px;">${buildTiers(ln)}</td>
                <td style="text-align:center;">${_qEsc(String(ln.moq || 1))}</td>
                <td>${leadTime}</td>
                <td>${stockInfo}</td>
                <td style="color:#666; font-style:italic; font-size:11px;">${_qEsc(ln.notes || '')}</td>
                <td>
                    <button class="btn-secondary btn-sm" onclick="window.exportQuoteLineToItem('${_qEsc(quote.project_id || '')}', '${ln.id}', '${_qEsc(quote.quote_number || '')}')" title="Export to Project Item">‚á™ Item</button>
                </td>
            </tr>`;
        });
    }

    const html = `<div class="quotes-detail-wrap">
        <div class="quotes-detail-header">
            <div class="qd-title-area">
                <div class="qd-quote-num">üìÑ ${_qEsc(quote.quote_number || quote.id || '\u2014')}</div>
                <div class="qd-supplier">${_qEsc(quote.supplier_name || '\u2014')}</div>
                <div class="qd-project">Project: ${_qEsc(quote.project_name || '\u2014')}</div>
            </div>
            <div class="qd-actions">
                <span class="qs-status-badge" style="background:${isExpired ? '#ff3b30' : '#34c759'}; padding:6px 14px; font-size:12px;">${statusLabel}</span>
                <button class="btn-secondary btn-sm" onclick="window.showQuoteEditModal('${qId}')" type="button">‚úèÔ∏è Edit</button>
                <button class="btn-text btn-sm" style="color:#d00;" onclick="window.deleteQuote('${qId}')" type="button">üóë Delete</button>
            </div>
        </div>
        <div class="quotes-detail-meta">
            ${field('Status', statusLabel, isExpired ? 'expired' : 'active')}
            ${field('Created', _fmtDate(quote.create_date))}
            ${field('Expires', _fmtDate(quote.expire_date), isExpired ? 'expired' : 'active')}
            ${field('Currency', quote.currency || 'EUR')}
            ${field('Received From', quote.received_from)}
            ${field('Incoterm', quote.incoterm)}
            ${field('Payment Terms', quote.payment_terms)}
            ${field('Shipping Cost', quote.shipping_cost)}
            ${field('MOV', quote.mov)}
            ${field('Extra Charge', quote.extra_charge)}
            ${field('Packaging', quote.packaging)}
            ${field('Source', quote.source || 'manual')}
        </div>
        <div class="quotes-detail-section">
            <div class="qd-section-title">Line Items (${lines.length})</div>
            <div style="overflow-x:auto; border:1px solid #e2e8f0; border-radius:6px;">
                <table class="rfq-table" style="font-size:12px;">
                    <thead><tr><th style="width:40px;">#</th><th>Drawing No</th><th>Manufacturer</th><th>MPN</th><th>Description</th><th>UOM</th><th>Price Tiers</th><th>MOQ</th><th>Lead Time</th><th>Stock</th><th>Line Notes</th><th>Actions</th></tr></thead>
                    <tbody>${linesHtml}</tbody>
                </table>
            </div>
        </div>
        ${quote.notes ? `<div class="quotes-detail-section"><div class="qd-section-title">Notes</div><div class="qd-notes">${_qEsc(quote.notes)}</div></div>` : ''}
        ${quote.attachment_name ? `<div class="quotes-detail-section"><div class="qd-section-title">Attachment</div><a href="${_qEsc(quote.attachment || '#')}" target="_blank" style="color:#007AFF; font-size:13px; text-decoration:underline;">üìé ${_qEsc(quote.attachment_name)}</a></div>` : ''}
        <div class="qd-footer">
            ${quote.created_by ? `<span>Created by: ${_qEsc(quote.created_by)}</span>` : ''}
            ${quote.updated_at ? `<span>Updated: ${_fmtDate(quote.updated_at)}</span>` : ''}
            <span>Source: ${_qEsc(quote.source || 'manual')}</span>
        </div>
    </div>`;

    content.innerHTML = html;
}

/* --- Main renderQuotes (Level 1 entry point) --- */
function renderQuotes() {
    const projects = _qGetProjects();
    const content = document.getElementById('quotes-content');
    if (!content) return;

    const projectFilterEl = document.getElementById('quotes-project-filter');
    if (projectFilterEl && projectFilterEl.options.length <= 1) {
        (projects || []).forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.name;
            projectFilterEl.appendChild(opt);
        });
    }

    const searchEl = document.getElementById('quotes-search');
    const statusFilterEl = document.getElementById('quotes-status-filter');
    const supplierFilterEl = document.getElementById('quotes-supplier-filter');
    const numberFilterEl = document.getElementById('quotes-number-filter');

    const search = searchEl ? String(searchEl.value || '').trim() : '';
    const projectId = projectFilterEl ? projectFilterEl.value : '';
    const status = statusFilterEl ? statusFilterEl.value : '';
    const supplierFilter = supplierFilterEl ? supplierFilterEl.value : '';
    const numberFilter = numberFilterEl ? String(numberFilterEl.value || '').trim().toLowerCase() : '';

    let url = '/api/quotes/';
    const params = new URLSearchParams();
    if (search) params.append('search', search);
    if (projectId) params.append('project_id', projectId);
    if (supplierFilter) params.append('supplier', supplierFilter);
    if (status === 'active') params.append('expired', 'false');
    else if (status === 'expired') params.append('expired', 'true');
    if (params.toString()) url += '?' + params.toString();

    content.innerHTML = '<div style="padding:32px; text-align:center; color:#888;">Loading quotes...</div>';

    _qFetchJson(url, { method: 'GET' })
        .then(res => {
            let quotes = (res && res.quotes) ? res.quotes : [];
            if (numberFilter) {
                quotes = quotes.filter(q => (q.quote_number || '').toLowerCase().includes(numberFilter));
            }
            _quotesCache = quotes;
            _quotesLevel = 1;
            _quotesSupplier = null;
            _updateQuotesStats(_quotesCache);
            _renderQuotesLevel1();

            if (supplierFilterEl && supplierFilterEl.options.length <= 1 && res && res.quotes) {
                const allSuppliers = new Set();
                res.quotes.forEach(q => { if (q.supplier_name) allSuppliers.add(q.supplier_name); });
                Array.from(allSuppliers).sort().forEach(sup => {
                    const opt = document.createElement('option');
                    opt.value = sup;
                    opt.textContent = sup;
                    supplierFilterEl.appendChild(opt);
                });
            }
        })
        .catch(err => {
            console.error('Failed to load quotes:', err);
            content.innerHTML = '<div style="padding:32px; text-align:center; color:#dc2626;">Error loading quotes</div>';
        });
}
window.renderQuotes = renderQuotes;

/* --- Modal: Quote Detail (popup) --- */
window.showQuoteDetail = function(quoteId) {
    if (!quoteId) return;
    _qFetchJson(`/api/quotes/${quoteId}/`, { method: 'GET' })
        .then(res => {
            if (!res || !res.quote) { window.showAlert('Failed to load quote details'); return; }
            const quote = res.quote;
            const lines = quote.lines || [];
            let linesHtml = '';
            if (lines.length === 0) {
                linesHtml = '<tr><td colspan="8" style="padding:14px; text-align:center; color:#888;">No items</td></tr>';
            } else {
                linesHtml = lines.map(line => {
                    let tierCells = '';
                    for (let i = 1; i <= 10; i++) {
                        const qty = line[`qty_${i}`];
                        const price = line[`price_${i}`];
                        if (qty && price !== null) {
                            tierCells += `<div style="display:flex; gap:8px; margin-bottom:4px;">
                                <span style="color:#64748b; min-width:60px;">${_qEsc(String(qty))} ${_qEsc(line.uom || 'pcs')}:</span>
                                <span style="font-weight:600;">${_qEsc(String(price))} ${_qEsc(quote.currency || 'EUR')}</span>
                            </div>`;
                        }
                    }
                    if (!tierCells) tierCells = '<span style="color:#888;">-</span>';
                    return `<tr>
                        <td>${_qEsc(line.drawing_number || '-')}</td>
                        <td>${_qEsc(line.manufacturer || '-')}</td>
                        <td>${_qEsc(line.mpn || '-')}</td>
                        <td style="max-width:200px; color:#64748b; font-size:12px;">${_qEsc(line.description || '-')}</td>
                        <td style="min-width:150px;">${tierCells}</td>
                        <td style="text-align:center;">${_qEsc(String(line.moq || 1))}</td>
                        <td>${_qEsc(line.supplier_lead_time || '14 days')}</td>
                        <td>${_qEsc(line.notes || '-')}</td>
                    </tr>`;
                }).join('');
            }
            const expireDate = quote.expire_date ? new Date(quote.expire_date) : null;
            const isExpired = expireDate && expireDate < new Date();
            const statusBadge = isExpired
                ? '<span style="padding:4px 10px; background:#fee2e2; color:#dc2626; border-radius:6px; font-size:12px; font-weight:600;">Expired</span>'
                : '<span style="padding:4px 10px; background:#d1fae5; color:#059669; border-radius:6px; font-size:12px; font-weight:600;">Active</span>';
            const createDate = quote.create_date ? new Date(quote.create_date).toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'}) : '-';
            const expireDateStr = expireDate ? expireDate.toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'}) : '-';
            const modalHtml = `<div class="rfq-modal-overlay" id="quote-detail-modal">
                <div class="rfq-modal" style="max-width: 1200px; width: 90%;">
                    <div class="rfq-modal-header">
                        <div class="rfq-modal-title">Quote: ${_qEsc(quote.quote_number || '')}</div>
                        <button class="rfq-btn-close" onclick="document.getElementById('quote-detail-modal').remove()">&times;</button>
                    </div>
                    <div class="rfq-modal-body" style="max-height: 70vh; overflow-y: auto;">
                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:16px; padding:16px; background:#f8fafc; border-radius:8px; margin-bottom:20px;">
                            <div><div style="font-size:11px; color:#64748b; margin-bottom:4px;">Supplier</div>
                                <div style="font-weight:600;">${_qEsc(quote.supplier_name || '-')}</div>
                                ${quote.received_from ? `<div style="font-size:12px; color:#64748b; margin-top:2px;">Contact: ${_qEsc(quote.received_from)}</div>` : ''}</div>
                            <div><div style="font-size:11px; color:#64748b; margin-bottom:4px;">Project</div>
                                <div style="font-weight:600;">${_qEsc(quote.project_name || '-')}</div></div>
                            <div><div style="font-size:11px; color:#64748b; margin-bottom:4px;">Status</div><div>${statusBadge}</div></div>
                            <div><div style="font-size:11px; color:#64748b; margin-bottom:4px;">Created</div><div>${createDate}</div></div>
                            <div><div style="font-size:11px; color:#64748b; margin-bottom:4px;">Expires</div>
                                <div style="color:${isExpired ? '#dc2626' : '#059669'}; font-weight:600;">${expireDateStr}</div></div>
                            <div><div style="font-size:11px; color:#64748b; margin-bottom:4px;">Currency</div><div>${_qEsc(quote.currency || 'EUR')}</div></div>
                            ${quote.incoterm ? `<div><div style="font-size:11px; color:#64748b; margin-bottom:4px;">Incoterm</div><div>${_qEsc(quote.incoterm)}</div></div>` : ''}
                            ${quote.payment_terms ? `<div><div style="font-size:11px; color:#64748b; margin-bottom:4px;">Payment Terms</div><div>${_qEsc(quote.payment_terms)}</div></div>` : ''}
                        </div>
                        <div style="margin-bottom:16px;">
                            <h4 style="margin:0 0 12px 0; font-size:14px;">Items (${lines.length})</h4>
                            <div class="table-wrapper" style="max-height:400px; overflow-y:auto;">
                                <table class="rfq-table">
                                    <thead><tr><th>Drawing No</th><th>Manufacturer</th><th>MPN</th><th>Description</th><th>Price Tiers</th><th>MOQ</th><th>Lead Time</th><th>Notes</th></tr></thead>
                                    <tbody>${linesHtml}</tbody>
                                </table>
                            </div>
                        </div>
                        ${quote.notes ? `<div style="padding:12px; background:#fffbeb; border-left:3px solid #f59e0b; border-radius:0 6px 6px 0; margin-top:16px;">
                            <div style="font-size:11px; color:#92400e; margin-bottom:6px; font-weight:600;">Notes:</div>
                            <div style="font-size:13px; color:#78350f; white-space:pre-wrap;">${_qEsc(quote.notes)}</div></div>` : ''}
                        <div style="margin-top:16px; padding-top:12px; border-top:1px solid #e2e8f0; font-size:11px; color:#94a3b8;">
                            Source: ${_qEsc(quote.source || 'manual')}${quote.created_by ? ` \u2022 Created by: ${_qEsc(quote.created_by)}` : ''}</div>
                    </div>
                    <div class="rfq-modal-footer">
                        <button class="rfq-btn-secondary" onclick="document.getElementById('quote-detail-modal').remove()">Close</button>
                        <button class="rfq-btn-primary" onclick="document.getElementById('quote-detail-modal').remove(); window.showQuoteEditModal('${_qEsc(quoteId)}')">Edit</button>
                    </div>
                </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = document.getElementById('quote-detail-modal');
            if (modal) modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
        })
        .catch(err => { console.error('Failed to load quote detail:', err); window.showAlert('Error loading quote details'); });
};

/* --- Edit Modal (full inline, not admin redirect) --- */
window.showQuoteEditModal = function(quoteId) {
    const quote = _quotesCache.find(q => String(q.id) === String(quoteId));
    if (!quote) { window.showAlert('Quote not found'); return; }
    const existingModal = document.getElementById('quote-edit-modal');
    if (existingModal) existingModal.remove();

    const modalHtml = `<div id="quote-edit-modal" class="rfq-modal-overlay">
        <div class="rfq-modal" style="max-width:900px; width:90%;">
            <div class="rfq-modal-header">
                <div class="rfq-modal-title">Edit Quote ${_qEsc(quote.quote_number || '')}</div>
                <button class="rfq-btn-close" onclick="document.getElementById('quote-edit-modal').remove()">‚úï</button>
            </div>
            <div class="rfq-modal-body" style="max-height:70vh; overflow-y:auto;">
                <div style="padding:16px; background:#f8fafc; border-radius:8px; margin-bottom:16px;">
                    <h4 style="margin:0 0 12px 0; font-size:14px; font-weight:600;">Dates & Currency</h4>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                        <div><label style="display:block; font-size:12px; color:#64748b; margin-bottom:4px;">Expire Date <span style="color:#dc2626;">*</span></label>
                            <input type="date" id="qe-expire-date" class="inp-control" style="width:100%;" value="${quote.expire_date ? quote.expire_date.split('T')[0] : ''}"></div>
                        <div><label style="display:block; font-size:12px; color:#64748b; margin-bottom:4px;">Currency</label>
                            <select id="qe-currency" class="inp-control" style="width:100%;">
                                <option value="EUR" ${quote.currency === 'EUR' ? 'selected' : ''}>EUR</option>
                                <option value="USD" ${quote.currency === 'USD' ? 'selected' : ''}>USD</option>
                                <option value="CZK" ${quote.currency === 'CZK' ? 'selected' : ''}>CZK</option>
                                <option value="GBP" ${quote.currency === 'GBP' ? 'selected' : ''}>GBP</option>
                                <option value="PLN" ${quote.currency === 'PLN' ? 'selected' : ''}>PLN</option>
                            </select></div>
                    </div>
                </div>
                <div style="padding:16px; background:#fff; border:1px solid #e2e8f0; border-radius:8px; margin-bottom:16px;">
                    <h4 style="margin:0 0 12px 0; font-size:14px; font-weight:600;">Terms & Costs</h4>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:12px;">
                        <div><label style="display:block; font-size:12px; color:#64748b; margin-bottom:4px;">Incoterm</label>
                            <input type="text" id="qe-incoterm" class="inp-control" style="width:100%;" value="${_qEsc(quote.incoterm || '')}"></div>
                        <div><label style="display:block; font-size:12px; color:#64748b; margin-bottom:4px;">Payment Terms</label>
                            <input type="text" id="qe-payment-terms" class="inp-control" style="width:100%;" value="${_qEsc(quote.payment_terms || '')}"></div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px;">
                        <div><label style="display:block; font-size:12px; color:#64748b; margin-bottom:4px;">Shipping Cost</label>
                            <input type="number" id="qe-shipping-cost" class="inp-control" step="0.01" min="0" style="width:100%;" value="${quote.shipping_cost || ''}"></div>
                        <div><label style="display:block; font-size:12px; color:#64748b; margin-bottom:4px;">MOV</label>
                            <input type="number" id="qe-mov" class="inp-control" step="0.01" min="0" style="width:100%;" value="${quote.mov || ''}"></div>
                        <div><label style="display:block; font-size:12px; color:#64748b; margin-bottom:4px;">Extra Charge</label>
                            <input type="number" id="qe-extra-charge" class="inp-control" step="0.01" min="0" style="width:100%;" value="${quote.extra_charge || ''}"></div>
                    </div>
                </div>
                <div style="margin-bottom:16px;"><label style="display:block; font-size:12px; color:#64748b; margin-bottom:4px;">Notes</label>
                    <textarea id="qe-notes" class="inp-control" rows="3" style="width:100%;">${_qEsc(quote.notes || '')}</textarea></div>
            </div>
            <div class="rfq-modal-footer">
                <button class="rfq-btn-secondary" onclick="document.getElementById('quote-edit-modal').remove()">Cancel</button>
                <button class="rfq-btn-primary" onclick="window.updateQuote('${_qEsc(quote.id)}')">üíæ Save Changes</button>
            </div>
        </div>
    </div>`;

    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = document.getElementById('quote-edit-modal');
    if (modal) modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
};

window.updateQuote = function(quoteId) {
    const expireDate = document.getElementById('qe-expire-date')?.value;
    if (!expireDate) { window.showAlert('Expire Date is required'); return; }
    const data = {
        expire_date: expireDate,
        currency: document.getElementById('qe-currency')?.value,
        incoterm: document.getElementById('qe-incoterm')?.value,
        payment_terms: document.getElementById('qe-payment-terms')?.value,
        shipping_cost: document.getElementById('qe-shipping-cost')?.value,
        mov: document.getElementById('qe-mov')?.value,
        extra_charge: document.getElementById('qe-extra-charge')?.value,
        notes: document.getElementById('qe-notes')?.value,
    };
    _qFetchJson(`/api/quotes/${quoteId}/update/`, { method: 'POST', body: JSON.stringify(data) })
        .then(res => {
            if (res.ok) {
                window.showAlert('Quote updated successfully');
                document.getElementById('quote-edit-modal')?.remove();
                renderQuotes();
            } else {
                window.showAlert(res.error || 'Failed to update quote');
            }
        })
        .catch(err => { console.error('Update error:', err); window.showAlert('Error updating quote'); });
};

/* --- Create Modal --- */
window.showQuoteCreateModal = function() {
    const projects = _qGetProjects();
    const projectOptions = (projects || []).map(p => `<option value="${_qEsc(p.id)}">${_qEsc(p.name || p.id)}</option>`).join('');

    const modalHtml = `<div class="rfq-modal-overlay" id="quote-create-modal">
        <div class="rfq-modal" style="max-width: 900px; width: 90%;">
            <div class="rfq-modal-header">
                <div class="rfq-modal-title">‚ûï Create New Quote</div>
                <button class="rfq-btn-close" onclick="document.getElementById('quote-create-modal').remove()">&times;</button>
            </div>
            <div class="rfq-modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div style="padding:16px; background:#f8fafc; border-radius:8px; margin-bottom:16px;">
                    <h4 style="margin:0 0 12px 0; font-size:14px; font-weight:600;">Basic Information</h4>
                    <div style="display:grid; gap:12px;">
                        <div><label style="display:block; font-size:12px; color:#64748b; margin-bottom:4px;">Supplier Name <span style="color:#dc2626;">*</span></label>
                            <input type="text" id="qc-supplier-name" class="inp-control" required placeholder="Enter supplier name" style="width:100%;"></div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                            <div><label style="display:block; font-size:12px; color:#64748b; margin-bottom:4px;">Project</label>
                                <select id="qc-project" class="inp-control" style="width:100%;"><option value="">-- No Project --</option>${projectOptions}</select></div>
                            <div><label style="display:block; font-size:12px; color:#64748b; margin-bottom:4px;">Project Name (fallback)</label>
                                <input type="text" id="qc-project-name" class="inp-control" placeholder="Manual project name" style="width:100%;"></div>
                        </div>
                        <div><label style="display:block; font-size:12px; color:#64748b; margin-bottom:4px;">Received From (Contact Person)</label>
                            <input type="text" id="qc-received-from" class="inp-control" placeholder="Contact person" style="width:100%;"></div>
                        <div><label style="display:block; font-size:12px; color:#64748b; margin-bottom:4px;">Quote Number</label>
                            <input type="text" id="qc-quote-number" class="inp-control" placeholder="Auto-generated if empty" style="width:100%;">
                            <div style="font-size:11px; color:#64748b; margin-top:2px;">Leave empty to auto-generate: SUPPLIER_YYYYMMDD_HHMM</div></div>
                    </div>
                </div>
                <div style="padding:16px; background:#f8fafc; border-radius:8px; margin-bottom:16px;">
                    <h4 style="margin:0 0 12px 0; font-size:14px; font-weight:600;">Dates & Currency</h4>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px;">
                        <div><label style="display:block; font-size:12px; color:#64748b; margin-bottom:4px;">Expire Date <span style="color:#dc2626;">*</span></label>
                            <input type="date" id="qc-expire-date" class="inp-control" required style="width:100%;"></div>
                        <div><label style="display:block; font-size:12px; color:#64748b; margin-bottom:4px;">Expire Preset</label>
                            <select id="qc-expire-preset" class="inp-control" style="width:100%;"><option value="">-- Manual Date --</option><option value="30">30 days</option><option value="60">60 days</option><option value="90">90 days</option><option value="120">120 days</option><option value="360">360 days</option></select></div>
                        <div><label style="display:block; font-size:12px; color:#64748b; margin-bottom:4px;">Currency</label>
                            <select id="qc-currency" class="inp-control" style="width:100%;"><option value="EUR">EUR</option><option value="USD">USD</option><option value="CZK">CZK</option><option value="GBP">GBP</option><option value="PLN">PLN</option></select></div>
                    </div>
                </div>
                <details style="margin-bottom:16px;">
                    <summary style="padding:12px; background:#f1f5f9; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600;">Terms & Costs (Optional)</summary>
                    <div style="padding:16px; border:1px solid #e2e8f0; border-top:none; border-radius:0 0 6px 6px;">
                        <div style="display:grid; gap:12px;">
                            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                                <div><label style="display:block; font-size:12px; color:#64748b; margin-bottom:4px;">Incoterm</label><input type="text" id="qc-incoterm" class="inp-control" placeholder="e.g. EXW, FOB, DDP" style="width:100%;"></div>
                                <div><label style="display:block; font-size:12px; color:#64748b; margin-bottom:4px;">Payment Terms</label><input type="text" id="qc-payment-terms" class="inp-control" placeholder="e.g. Net 30" style="width:100%;"></div>
                            </div>
                            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px;">
                                <div><label style="display:block; font-size:12px; color:#64748b; margin-bottom:4px;">Shipping Cost</label><input type="number" id="qc-shipping-cost" class="inp-control" placeholder="0.00" step="0.01" min="0" style="width:100%;"></div>
                                <div><label style="display:block; font-size:12px; color:#64748b; margin-bottom:4px;">MOV (Min Order Value)</label><input type="number" id="qc-mov" class="inp-control" placeholder="0.00" step="0.01" min="0" style="width:100%;"></div>
                                <div><label style="display:block; font-size:12px; color:#64748b; margin-bottom:4px;">Extra Charge</label><input type="number" id="qc-extra-charge" class="inp-control" placeholder="0.00" step="0.01" min="0" style="width:100%;"></div>
                            </div>
                            <div><label style="display:block; font-size:12px; color:#64748b; margin-bottom:4px;">Packaging</label><input type="text" id="qc-packaging" class="inp-control" placeholder="Packaging details" style="width:100%;"></div>
                        </div>
                    </div>
                </details>
                <div style="padding:16px; background:#f8fafc; border-radius:8px; margin-bottom:16px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <h4 style="margin:0; font-size:14px; font-weight:600;">Items / Lines</h4>
                        <button type="button" class="rfq-btn-secondary" onclick="window.addQuoteLineRow()" style="padding:4px 12px; font-size:12px;">‚ûï Add Line</button>
                    </div>
                    <div style="max-height:300px; overflow-y:auto; border:1px solid #e2e8f0; border-radius:6px;">
                        <table id="qc-lines-table" class="rfq-table" style="font-size:12px;">
                            <thead><tr><th style="min-width:120px;">Drawing No</th><th style="min-width:100px;">Manufacturer</th><th style="min-width:100px;">MPN</th><th style="min-width:80px;">QTY</th><th style="min-width:80px;">Price</th><th style="min-width:60px;">MOQ</th><th style="min-width:100px;">Lead Time</th><th style="width:40px;"></th></tr></thead>
                            <tbody id="qc-lines-tbody"></tbody>
                        </table>
                    </div>
                </div>
                <details style="margin-bottom:16px;">
                    <summary style="padding:12px; background:#f1f5f9; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600;">Notes & Attachment (Optional)</summary>
                    <div style="padding:16px; border:1px solid #e2e8f0; border-top:none; border-radius:0 0 6px 6px;">
                        <div style="display:grid; gap:12px;">
                            <div><label style="display:block; font-size:12px; color:#64748b; margin-bottom:4px;">Notes</label><textarea id="qc-notes" class="inp-control" rows="3" placeholder="Additional notes" style="width:100%;"></textarea></div>
                            <div><label style="display:block; font-size:12px; color:#64748b; margin-bottom:4px;">Attachment</label><input type="file" id="qc-attachment" class="inp-control" style="width:100%;"><div style="font-size:11px; color:#64748b; margin-top:2px;">Max 10MB, PDF/Excel/Images only</div></div>
                        </div>
                    </div>
                </details>
            </div>
            <div class="rfq-modal-footer">
                <div style="font-size:11px; color:#64748b; flex:1;"><a href="/admin/rfq/quote/add/" target="_blank" style="color:#3b82f6; text-decoration:underline;">Open in Admin (fallback)</a></div>
                <button class="rfq-btn-secondary" onclick="document.getElementById('quote-create-modal').remove()">Cancel</button>
                <button class="rfq-btn-primary" onclick="window.saveNewQuote()">üíæ Save Quote</button>
            </div>
        </div>
    </div>`;

    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = document.getElementById('quote-create-modal');
    if (modal) modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

    const presetSelect = document.getElementById('qc-expire-preset');
    const expireDateInput = document.getElementById('qc-expire-date');
    if (presetSelect && expireDateInput) {
        presetSelect.onchange = function() {
            const days = parseInt(this.value);
            if (days > 0) {
                const date = new Date();
                date.setDate(date.getDate() + days);
                expireDateInput.value = date.toISOString().split('T')[0];
            }
        };
    }

    window.addQuoteLineRow();
};

window.addQuoteLineRow = function() {
    const tbody = document.getElementById('qc-lines-tbody');
    if (!tbody) return;
    const rowId = 'qc-line-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    const row = document.createElement('tr');
    row.id = rowId;
    row.innerHTML = `
        <td><input type="text" class="inp-control qc-line-drawing" placeholder="Drawing" style="width:100%;"></td>
        <td><input type="text" class="inp-control qc-line-manufacturer" placeholder="Mfr" style="width:100%;"></td>
        <td><input type="text" class="inp-control qc-line-mpn" placeholder="MPN" style="width:100%;"></td>
        <td><input type="text" class="inp-control qc-line-qty1" placeholder="100" style="width:100%;"></td>
        <td><input type="number" class="inp-control qc-line-price1" placeholder="0.00" step="0.0001" min="0" style="width:100%;"></td>
        <td><input type="number" class="inp-control qc-line-moq" placeholder="1" min="1" style="width:100%;"></td>
        <td><input type="text" class="inp-control qc-line-lead" placeholder="14 days" style="width:100%;"></td>
        <td><button type="button" class="rfq-btn-danger" onclick="document.getElementById('${rowId}').remove()" style="padding:2px 8px; font-size:11px;">‚úï</button></td>`;
    tbody.appendChild(row);
};

window.saveNewQuote = function() {
    const supplierName = document.getElementById('qc-supplier-name')?.value.trim();
    const expireDate = document.getElementById('qc-expire-date')?.value;
    if (!supplierName) { window.showAlert('Supplier Name is required'); return; }
    if (!expireDate) { window.showAlert('Expire Date is required'); return; }

    const quoteData = {
        supplier_name: supplierName,
        project_id: document.getElementById('qc-project')?.value || '',
        project_name: document.getElementById('qc-project-name')?.value.trim() || '',
        received_from: document.getElementById('qc-received-from')?.value.trim() || '',
        quote_number: document.getElementById('qc-quote-number')?.value.trim() || '',
        expire_date: expireDate,
        currency: document.getElementById('qc-currency')?.value || 'EUR',
        incoterm: document.getElementById('qc-incoterm')?.value.trim() || '',
        payment_terms: document.getElementById('qc-payment-terms')?.value.trim() || '',
        shipping_cost: parseFloat(document.getElementById('qc-shipping-cost')?.value) || null,
        mov: parseFloat(document.getElementById('qc-mov')?.value) || null,
        extra_charge: parseFloat(document.getElementById('qc-extra-charge')?.value) || null,
        packaging: document.getElementById('qc-packaging')?.value.trim() || '',
        notes: document.getElementById('qc-notes')?.value.trim() || '',
        source: 'manual',
        lines: []
    };

    document.querySelectorAll('#qc-lines-tbody tr').forEach(row => {
        const drawing = row.querySelector('.qc-line-drawing')?.value.trim();
        const mpn = row.querySelector('.qc-line-mpn')?.value.trim();
        if (drawing || mpn) {
            quoteData.lines.push({
                drawing_number: drawing,
                manufacturer: row.querySelector('.qc-line-manufacturer')?.value.trim(),
                mpn: mpn,
                qty_1: row.querySelector('.qc-line-qty1')?.value.trim(),
                price_1: parseFloat(row.querySelector('.qc-line-price1')?.value) || null,
                moq: parseInt(row.querySelector('.qc-line-moq')?.value) || 1,
                supplier_lead_time: row.querySelector('.qc-line-lead')?.value.trim() || '14 days'
            });
        }
    });

    const saveBtn = document.querySelector('#quote-create-modal .rfq-btn-primary');
    if (saveBtn) { saveBtn.disabled = true; saveBtn.textContent = 'Saving...'; }

    _qFetchJson('/api/quotes/create/', { method: 'POST', body: JSON.stringify(quoteData) })
        .then(res => {
            if (res && res.ok) {
                window.showAlert('Quote created successfully!');
                document.getElementById('quote-create-modal')?.remove();
                renderQuotes();
            } else {
                window.showAlert('Failed to create quote: ' + (res.error || 'Unknown error'));
                if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'üíæ Save Quote'; }
            }
        })
        .catch(err => {
            console.error('Error creating quote:', err);
            window.showAlert('Error creating quote: ' + (err.message || 'Unknown error'));
            if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'üíæ Save Quote'; }
        });
};

window.deleteQuote = function(quoteId) {
    if (!quoteId) return;
    window.showConfirm('Are you sure you want to delete this quote?', (confirmed) => {
        if (!confirmed) return;
        _qFetchJson(`/api/quotes/${quoteId}/delete/`, { method: 'DELETE' })
            .then(res => {
                if (res && res.ok) { window.showAlert('Quote deleted successfully'); renderQuotes(); }
                else { window.showAlert('Failed to delete quote: ' + (res.error || 'Unknown error')); }
            })
            .catch(err => { console.error('Delete quote error:', err); window.showAlert('Error deleting quote'); });
    });
};

/* --- Export / Import helpers --- */
window.exportQuoteLineToItem = function(projectId, lineId, quoteNumber) {
    if (!projectId || projectId === 'null' || projectId === 'undefined') {
        window.showAlert('Quote not linked to a project.');
        return;
    }
    window.showConfirm('Update Project Item with pricing from Quote ' + quoteNumber + '?', (confirmed) => {
        if (!confirmed) return;
        _qFetchJson('/api/quotes/export_to_item/', { method: 'POST', body: JSON.stringify({ project_id: projectId, line_id: lineId }) })
            .then(res => {
                if (res.ok) {
                    window.showAlert('Item updated successfully!');
                    // Refresh project data so RFQ Planner reflects updated prices
                    if (window.RFQData && window.RFQData.loadProjects) window.RFQData.loadProjects();
                }
                else window.showAlert('Error: ' + (res.error || 'Unknown error'));
            })
            .catch(err => { console.error(err); window.showAlert('Request failed'); });
    });
};

window.saveItemToQuote = function(projectId, itemId, supplierName) {
    if (!projectId || !itemId || !supplierName) { window.showAlert('Missing data for quote creation.'); return; }
    window.showConfirm(`Create/Update Quote for ${supplierName}?`, (confirmed) => {
        if (!confirmed) return;
        _qFetchJson('/api/quotes/create_from_item/', { method: 'POST', body: JSON.stringify({ project_id: projectId, item_id: itemId, supplier_name: supplierName }) })
            .then(res => {
                if (res.ok) window.showAlert('Quote saved successfully!');
                else window.showAlert('Error: ' + (res.error || 'Unknown error'));
            })
            .catch(err => { console.error(err); window.showAlert('Request failed'); });
    });
};

/* --- Event listeners --- */
const quotesSearch = document.getElementById('quotes-search');
const quotesProjectFilter = document.getElementById('quotes-project-filter');
const quotesSupplierFilter = document.getElementById('quotes-supplier-filter');
const quotesNumberFilter = document.getElementById('quotes-number-filter');
const quotesStatusFilter = document.getElementById('quotes-status-filter');
const btnQuotesRefresh = document.getElementById('btn-quotes-refresh');
const btnQuotesClearFilters = document.getElementById('btn-quotes-clear-filters');
const btnQuotesCreate = document.getElementById('btn-quotes-create');
const btnQuotesBcHome = document.getElementById('quotes-bc-home');

if (quotesSearch) quotesSearch.addEventListener('input', renderQuotes);
if (quotesProjectFilter) quotesProjectFilter.addEventListener('change', renderQuotes);
if (quotesSupplierFilter) quotesSupplierFilter.addEventListener('change', renderQuotes);
if (quotesNumberFilter) quotesNumberFilter.addEventListener('input', renderQuotes);
if (quotesStatusFilter) quotesStatusFilter.addEventListener('change', renderQuotes);
if (btnQuotesRefresh) btnQuotesRefresh.onclick = renderQuotes;

if (btnQuotesClearFilters) btnQuotesClearFilters.onclick = () => {
    if (quotesSearch) quotesSearch.value = '';
    if (quotesProjectFilter) quotesProjectFilter.value = '';
    if (quotesSupplierFilter) quotesSupplierFilter.value = '';
    if (quotesNumberFilter) quotesNumberFilter.value = '';
    if (quotesStatusFilter) quotesStatusFilter.value = '';
    renderQuotes();
};

if (btnQuotesCreate) btnQuotesCreate.onclick = () => { window.showQuoteCreateModal(); };

if (btnQuotesBcHome) btnQuotesBcHome.onclick = () => {
    if (_quotesLevel === 3 && _quotesSupplier) _renderQuotesLevel2(_quotesSupplier);
    else _renderQuotesLevel1();
};

const btnQuotesBcSupplier = document.getElementById('quotes-bc-supplier');
if (btnQuotesBcSupplier) btnQuotesBcSupplier.onclick = () => {
    if (_quotesSupplier) _renderQuotesLevel2(_quotesSupplier);
};

const btnQuotesBcQuote = document.getElementById('quotes-bc-quote');
if (btnQuotesBcQuote) btnQuotesBcQuote.onclick = () => {
    if (_quotesCurrentId) window._quotesOpenDetail(_quotesCurrentId);
};

// Fallback delegated handlers (covers dynamic re-renders / stale bindings)
document.addEventListener('click', (e) => {
    const home = e.target && e.target.closest && e.target.closest('#quotes-bc-home');
    if (home) {
        e.preventDefault();
        if (_quotesLevel === 3 && _quotesSupplier) _renderQuotesLevel2(_quotesSupplier);
        else _renderQuotesLevel1();
        return;
    }

    const sup = e.target && e.target.closest && e.target.closest('#quotes-bc-supplier');
    if (sup) {
        e.preventDefault();
        const name = _quotesSupplier || (sup.textContent || '').trim();
        if (name) _renderQuotesLevel2(name);
        return;
    }

    const qbtn = e.target && e.target.closest && e.target.closest('#quotes-bc-quote');
    if (qbtn) {
        e.preventDefault();
        const qid = _quotesCurrentId || qbtn.getAttribute('data-quote-id');
        if (qid) window._quotesOpenDetail(qid);
    }
});

