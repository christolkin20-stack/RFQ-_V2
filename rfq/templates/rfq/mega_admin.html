<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mega Admin Dashboard</title>
  <style>
    body{font-family:Inter,system-ui,Arial;margin:0;background:#0b1020;color:#e5e7eb}
    .wrap{max-width:1280px;margin:0 auto;padding:18px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:14px;flex-wrap:wrap}
    .navmeta{display:flex;align-items:center;gap:10px;font-size:12px;color:#cbd5e1}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .card{background:#121a31;border:1px solid #243056;border-radius:12px;padding:12px}
    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px}
    .stat{background:#0f172a;border:1px solid #243056;border-radius:10px;padding:10px}
    .stat b{display:block;font-size:20px}
    h1{margin:0;font-size:22px}.muted{color:#94a3b8;font-size:12px}
    h3{margin:0 0 8px;font-size:14px}
    input,select,button{border-radius:8px;border:1px solid #334155;background:#0f172a;color:#e5e7eb;padding:7px 8px;font-size:12px}
    button{cursor:pointer;background:#334155}
    button.primary{background:#2563eb;border-color:#1d4ed8}
    button.warn{background:#7c2d12;border-color:#9a3412}
    .list{max-height:360px;overflow:auto;border:1px solid #334155;border-radius:8px}
    .row{padding:8px;border-bottom:1px solid #1f2937;font-size:12px;display:flex;justify-content:space-between;gap:8px;align-items:flex-start}
    .row:last-child{border-bottom:0}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0;align-items:center}
    .badge{display:inline-block;padding:2px 6px;border-radius:99px;border:1px solid #334155;background:#0b1224;font-size:11px}
    .toast{position:fixed;right:14px;bottom:14px;background:#0f172a;border:1px solid #334155;padding:10px 12px;border-radius:10px;display:none;max-width:340px}
    .danger{color:#fca5a5}.ok{color:#86efac}
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,.68);display:flex;align-items:center;justify-content:center;z-index:9999}
    .modal-card{width:min(460px,92vw);background:#0f172a;border:1px solid #334155;border-radius:12px;padding:14px}
    .modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
    .bulk-bar{background:#1e293b;border:1px solid #334155;border-radius:8px;padding:8px 12px;display:none;align-items:center;gap:8px;margin:8px 0;font-size:12px}
    .bulk-bar b{color:#60a5fa}
    input[type="date"]{color-scheme:dark}
    @media (max-width:1000px){.grid{grid-template-columns:1fr}.stats{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>üõ°Ô∏è Mega Admin Dashboard</h1>
        <div class="muted">Intern√≠ administrace pro zamƒõstnance ‚Äî firmy, u≈æivatel√©, locky, audit ‚Ä¢ Scope dat v RFQ app p≈ôep√≠n√°≈° v horn√≠m navbaru (All/Company)</div>
      </div>
      <div class="controls">
        <div class="navmeta">
          <span id="mega-clock"></span>
          <span>üë§ {{ request.user.username }}</span>
        </div>
        <a href="/"><button>RFQ App</button></a>
        <a href="/logout/?next=/login/"><button>Logout</button></a>
      </div>
    </div>

    <div class="stats">
      <div class="stat"><span class="muted">Companies</span><b id="sCompanies">0</b></div>
      <div class="stat"><span class="muted">Users</span><b id="sUsers">0</b></div>
      <div class="stat"><span class="muted">Active Locks</span><b id="sLocks">0</b></div>
      <div class="stat"><span class="muted">Audit (loaded)</span><b id="sAudit">0</b></div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>üè¢ Companies</h3>
        <div class="controls">
          <input id="cname" placeholder="Company name" />
          <input id="cvat" placeholder="VAT" />
          <input id="creg" placeholder="Registration No" />
          <input id="caddr" placeholder="Address line 1" />
          <input id="ccity" placeholder="City" />
          <input id="czip" placeholder="Postal code" />
          <input id="ccountry" placeholder="Country" />
          <label class="muted"><input id="cactive" type="checkbox" checked /> active</label>
          <button class="primary" id="cadd">Add / Update</button>
          <button id="ccancel" style="display:none">Cancel edit</button>
        </div>
        <div class="muted" id="cedit" style="display:none">Editing company ID: <span id="ceditid"></span></div>
        <div id="companies" class="list"></div>
      </div>

      <div class="card">
        <h3>üë• Users / Roles</h3>
        <div class="controls">
          <input id="uname" placeholder="username" />
          <input id="uemail" placeholder="email" />
          <input id="upass" placeholder="password" type="password" />
          <label class="muted"><input id="ushowpass" type="checkbox" /> show</label>
          <select id="urole"><option>viewer</option><option>editor</option><option>admin</option><option>superadmin</option></select>
          <select id="ucompany"></select>
          <button class="primary" id="ucreate">Create user</button>
        </div>
        <div class="controls">
          <select id="ucompany-filter"><option value="">All companies</option></select>
          <input id="usearch" placeholder="Filter users (name/email/role/company)" />
          <button id="urefresh">Refresh</button>
        </div>
        <div class="bulk-bar" id="ubulk-bar">
          <b id="ubulk-count">0</b> selected
          <select id="ubulk-role"><option value="">Bulk role...</option><option>viewer</option><option>editor</option><option>admin</option></select>
          <button id="ubulk-apply" class="primary">Apply Role</button>
          <button id="ubulk-deactivate" class="warn">Deactivate</button>
          <button id="ubulk-clear">Clear</button>
        </div>
        <div id="users" class="list"></div>
      </div>

      <div class="card">
        <h3>üîí Active Locks</h3>
        <div class="controls">
          <button id="lrefresh">Refresh</button>
          <button id="lbulk-unlock" class="warn" style="display:none">Unlock Selected (<span id="lbulk-count">0</span>)</button>
        </div>
        <div id="locks" class="list"></div>
      </div>

      <div class="card">
        <h3>üìú Audit Logs</h3>
        <div class="controls">
          <input id="af" placeholder="action filter" />
          <input id="ef" placeholder="entity filter" />
          <input id="actorf" placeholder="actor contains" />
          <input type="date" id="adate-from" title="From date" />
          <input type="date" id="adate-to" title="To date" />
          <button id="arefresh">Refresh</button>
        </div>
        <div id="audit" class="list"></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
let state = { companies: [], users: [], locks: [], logs: [], editingCompanyId: null, selectedUserIds: new Set(), selectedLocks: new Set() };

function _csrf(){return (document.cookie.match(/csrftoken=([^;]+)/)||[])[1]||'';}
async function j(url, o={}){const h={'Content-Type':'application/json',...(o.headers||{})};const m=(o.method||'GET').toUpperCase();if(m!=='GET'&&m!=='HEAD')h['X-CSRFToken']=_csrf();const r=await fetch(url,{credentials:'same-origin',...o,headers:h});const d=await r.json().catch(()=>({}));if(!r.ok) throw new Error(d.error||r.status);return d;}
const esc=s=>String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

function toast(msg, ok=true){const el=document.getElementById('toast');el.className='toast '+(ok?'ok':'danger');el.textContent=msg;el.style.display='block';setTimeout(()=>el.style.display='none',2800)}

function appConfirm(message, title='Confirm action'){
  return new Promise(resolve => {
    const b=document.createElement('div'); b.className='modal-backdrop';
    b.innerHTML=`<div class='modal-card'>
      <div style='font-size:15px;font-weight:700;margin-bottom:8px;'>${esc(title)}</div>
      <div class='muted'>${esc(message)}</div>
      <div class='modal-actions'>
        <button id='m-no'>Cancel</button>
        <button id='m-yes' class='primary'>Continue</button>
      </div>
    </div>`;
    document.body.appendChild(b);
    b.querySelector('#m-no').onclick=()=>{b.remove();resolve(false)};
    b.querySelector('#m-yes').onclick=()=>{b.remove();resolve(true)};
  });
}

function appPrompt(message, title='Input required', placeholder=''){
  return new Promise(resolve => {
    const b=document.createElement('div'); b.className='modal-backdrop';
    b.innerHTML=`<div class='modal-card'>
      <div style='font-size:15px;font-weight:700;margin-bottom:8px;'>${esc(title)}</div>
      <div class='muted' style='margin-bottom:8px;'>${esc(message)}</div>
      <input id='m-input' style='width:100%;' placeholder='${esc(placeholder)}' />
      <div class='modal-actions'>
        <button id='m-no'>Cancel</button>
        <button id='m-yes' class='primary'>Save</button>
      </div>
    </div>`;
    document.body.appendChild(b);
    const inp=b.querySelector('#m-input'); if(inp) inp.focus();
    b.querySelector('#m-no').onclick=()=>{b.remove();resolve(null)};
    b.querySelector('#m-yes').onclick=()=>{const v=(inp?.value||'').trim(); b.remove(); resolve(v||null)};
  });
}

function updateStats(){
  document.getElementById('sCompanies').textContent = state.companies.length;
  document.getElementById('sUsers').textContent = state.users.length;
  document.getElementById('sLocks').textContent = state.locks.length;
  document.getElementById('sAudit').textContent = state.logs.length;
}

function resetCompanyForm(){
  state.editingCompanyId = null;
  ['cname','cvat','creg','caddr','ccity','czip','ccountry'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('cactive').checked=true;
  document.getElementById('cedit').style.display='none';
  document.getElementById('ccancel').style.display='none';
}

function setCompanyEdit(c){
  state.editingCompanyId = c.id;
  document.getElementById('cname').value = c.name || '';
  document.getElementById('cvat').value = c.vat_number || '';
  document.getElementById('creg').value = c.registration_number || '';
  document.getElementById('caddr').value = c.address_line1 || '';
  document.getElementById('ccity').value = c.city || '';
  document.getElementById('czip').value = c.postal_code || '';
  document.getElementById('ccountry').value = c.country || '';
  document.getElementById('cactive').checked = !!c.is_active;
  document.getElementById('ceditid').textContent = c.id;
  document.getElementById('cedit').style.display='block';
  document.getElementById('ccancel').style.display='inline-block';
}

async function loadCompanies(){
  const d=await j('/api/admin/companies');
  state.companies = d.companies||[];
  const el=document.getElementById('companies');
  el.innerHTML=state.companies.map(c=>`<div class='row'>
    <div>
      <b>${esc(c.name)}</b> ${c.is_active?'<span class="badge">active</span>':'<span class="badge">inactive</span>'}
      <div class='muted'>VAT: ${esc(c.vat_number||'‚Äî')} ‚Ä¢ REG: ${esc(c.registration_number||'‚Äî')}</div>
      <div class='muted'>${esc([c.address_line1,c.city,c.postal_code,c.country].filter(Boolean).join(', ')||'No address')}</div>
    </div>
    <div class='controls'>
      <button data-ce='${c.id}'>Edit</button>
      <button data-ct='${c.id}' class='warn'>${c.is_active?'Deactivate':'Activate'}</button>
    </div>
  </div>`).join('')||"<div class='row'>No companies</div>";

  el.querySelectorAll('[data-ce]').forEach(b=>b.onclick=()=>{const c=state.companies.find(x=>String(x.id)===String(b.dataset.ce)); if(c) setCompanyEdit(c)});
  el.querySelectorAll('[data-ct]').forEach(b=>b.onclick=async()=>{
    const c=state.companies.find(x=>String(x.id)===String(b.dataset.ct)); if(!c) return;
    if(!(await appConfirm(`${c.is_active?'Deactivate':'Activate'} company ${c.name}?`, 'Company status change'))) return;
    await j('/api/admin/companies',{method:'POST',body:JSON.stringify({id:c.id,is_active:!c.is_active})});
    toast('Company status updated');
    await loadCompanies();
  });
  updateStats();
}

function updateUserBulkBar(){
  const bar=document.getElementById('ubulk-bar');
  const count=state.selectedUserIds.size;
  document.getElementById('ubulk-count').textContent=count;
  bar.style.display=count>0?'flex':'none';
}

async function loadUsers(){
  const d=await j('/api/admin/users');
  state.users = d.users||[];
  const companies=state.companies;
  const ucompany=document.getElementById('ucompany');
  if (ucompany) {
    const prevU = ucompany.value || '';
    ucompany.innerHTML = `<option value=''>company...</option>` + companies.map(c=>`<option value='${c.id}'>${esc(c.name)}</option>`).join('');
    ucompany.value = prevU || (companies[0] ? String(companies[0].id) : '');
  }
  const ucompanyFilter=document.getElementById('ucompany-filter');
  if (ucompanyFilter) {
    const prev = ucompanyFilter.value || '';
    ucompanyFilter.innerHTML = `<option value=''>All companies</option>` + companies.map(c=>`<option value='${c.id}'>${esc(c.name)}</option>`).join('');
    ucompanyFilter.value = prev;
  }

  const q=(document.getElementById('usearch').value||'').toLowerCase().trim();
  const fCompany=(document.getElementById('ucompany-filter')?.value||'').trim();
  let users = state.users.slice();
  if (fCompany) users = users.filter(u => String(u.company_id||'') === String(fCompany));
  if (q) users = users.filter(u=>`${u.username} ${u.email||''} ${u.role||''} ${u.company_name||''}`.toLowerCase().includes(q));

  const cOpts=(id)=>`<option value=''>none</option>`+companies.map(c=>`<option value='${c.id}' ${String(id)===String(c.id)?'selected':''}>${esc(c.name)}</option>`).join('');
  const el=document.getElementById('users');

  const grouped = {};
  users.forEach(u => {
    const k = u.company_name || 'No company';
    grouped[k] = grouped[k] || [];
    grouped[k].push(u);
  });
  const groupNames = Object.keys(grouped).sort((a,b)=>a.localeCompare(b));

  el.innerHTML=groupNames.map(g=>`<div style='padding:6px 8px;background:#0b1224;border-bottom:1px solid #334155;font-size:11px;font-weight:700;color:#cbd5e1;'>${esc(g)} (${grouped[g].length})</div>${grouped[g].map(u=>`<div class='row'>
      <div style='display:flex;align-items:flex-start;gap:8px;'>
        <input type='checkbox' class='uchk' data-uid='${u.user_id}' ${state.selectedUserIds.has(String(u.user_id))?'checked':''} style='margin-top:3px;' />
        <div>
          <b>${esc(u.username)}</b> <span class='badge'>${esc(u.role)}</span> ${u.is_management?'<span class="badge">mgmt</span>':''} ${u.is_active?'':'<span class="badge">inactive</span>'}
          <div class='muted'>${esc(u.email||'')} ‚Ä¢ ${esc(u.company_name||'no company')}</div>
          <div class='muted'>Last login: ${esc(u.last_login?u.last_login.replace('T',' ').slice(0,19):'never')}</div>
        </div>
      </div>
      <div class='controls'>
        <select data-r='${u.user_id}'>${['viewer','editor','admin','superadmin'].map(r=>`<option ${u.role===r?'selected':''}>${r}</option>`).join('')}</select>
        <label class='muted'><input type='checkbox' data-m='${u.user_id}' ${u.is_management?'checked':''}/>mgmt</label>
        <label class='muted'><input type='checkbox' data-a='${u.user_id}' ${u.is_active?'checked':''}/>active</label>
        <select data-c='${u.user_id}'>${cOpts(u.company_id)}</select>
        <button data-s='${u.user_id}' class='primary'>Save</button>
        <button data-rp='${u.user_id}'>Reset pass</button>
        <button data-del='${u.user_id}' class='warn'>Delete</button>
      </div>
    </div>`).join('')}`).join('')||"<div class='row'>No users</div>";

  // User selection checkboxes
  el.querySelectorAll('.uchk').forEach(cb=>cb.onchange=()=>{
    const uid=cb.dataset.uid;
    if(cb.checked) state.selectedUserIds.add(uid); else state.selectedUserIds.delete(uid);
    updateUserBulkBar();
  });

  el.querySelectorAll('[data-s]').forEach(b=>b.onclick=async()=>{
    const id=b.dataset.s;
    const role=el.querySelector(`[data-r='${id}']`).value;
    const mg=el.querySelector(`[data-m='${id}']`).checked;
    const active=el.querySelector(`[data-a='${id}']`).checked;
    const cid=el.querySelector(`[data-c='${id}']`).value||null;
    if(role==='superadmin' && !(await appConfirm('Assigning superadmin is critical. Continue?', 'Privilege escalation'))) return;
    await j('/api/admin/users',{method:'POST',body:JSON.stringify({user_id:Number(id),role,is_management:mg,is_active:active,company_id:cid})});
    toast('User updated');
    await loadUsers();
  });

  el.querySelectorAll('[data-rp]').forEach(b=>b.onclick=async()=>{
    const id=b.dataset.rp;
    const newp = await appPrompt('Set new password for user #' + id, 'Reset password', 'new password');
    if (!newp) return;
    await j('/api/admin/users',{method:'POST',body:JSON.stringify({user_id:Number(id),reset_password:true,new_password:newp})});
    toast('Password reset done');
  });

  el.querySelectorAll('[data-del]').forEach(b=>b.onclick=async()=>{
    const id=b.dataset.del;
    if(!(await appConfirm('Deactivate/delete this user?', 'Delete user'))) return;
    await j('/api/admin/users',{method:'POST',body:JSON.stringify({user_id:Number(id),delete_user:true})});
    toast('User deleted (deactivated)');
    await loadUsers();
  });
  updateStats();
  updateUserBulkBar();
}

function updateLockBulkBtn(){
  const btn=document.getElementById('lbulk-unlock');
  const count=state.selectedLocks.size;
  document.getElementById('lbulk-count').textContent=count;
  btn.style.display=count>0?'inline-block':'none';
}

async function loadLocks(){
  const d=await j('/api/admin/locks?limit=200');
  state.locks = d.locks||[];
  state.selectedLocks.clear();
  const el=document.getElementById('locks');
  el.innerHTML=state.locks.map(l=>`<div class='row'>
    <div style='display:flex;align-items:flex-start;gap:8px;'>
      <input type='checkbox' class='lchk' data-lk='${esc(l.resource_key)}' style='margin-top:3px;' />
      <div><b>${esc(l.context)}</b><div class='muted'>${esc(l.project_name||l.project_id)} ‚Ä¢ ${esc(l.locked_by)} ‚Ä¢ exp: ${esc((l.expires_at||'').replace('T',' ').slice(0,19))}</div></div>
    </div>
    <div><button data-f='${esc(l.resource_key)}' class='warn'>Force unlock</button></div>
  </div>`).join('')||"<div class='row'>No active locks</div>";

  el.querySelectorAll('.lchk').forEach(cb=>cb.onchange=()=>{
    if(cb.checked) state.selectedLocks.add(cb.dataset.lk); else state.selectedLocks.delete(cb.dataset.lk);
    updateLockBulkBtn();
  });

  el.querySelectorAll('[data-f]').forEach(b=>b.onclick=async()=>{
    if(!(await appConfirm('Force unlock this record?', 'Force unlock'))) return;
    await j('/api/locks/force_unlock',{method:'POST',body:JSON.stringify({resource_key:b.dataset.f})});
    toast('Lock force-unlocked');
    await loadLocks();
  });
  updateStats();
  updateLockBulkBtn();
}

async function loadAudit(){
  const a=document.getElementById('af').value||'';
  const e=document.getElementById('ef').value||'';
  const dateFrom=document.getElementById('adate-from').value||'';
  const dateTo=document.getElementById('adate-to').value||'';
  let url='/api/admin/audit_logs?limit=200&action='+encodeURIComponent(a)+'&entity_type='+encodeURIComponent(e);
  if(dateFrom) url+='&date_from='+encodeURIComponent(dateFrom);
  if(dateTo) url+='&date_to='+encodeURIComponent(dateTo);
  const d=await j(url);
  const actorFilter=(document.getElementById('actorf').value||'').toLowerCase().trim();
  state.logs = (d.logs||[]).filter(x=>!actorFilter || String(x.actor||'').toLowerCase().includes(actorFilter));
  const el=document.getElementById('audit');
  el.innerHTML=state.logs.map(x=>`<div class='row'>
    <div><b>${esc(x.action)}</b><div class='muted'>${esc(x.entity_type)} ‚Ä¢ ${esc(x.entity_id)} ‚Ä¢ actor: ${esc(x.actor||'')}</div></div>
    <div class='muted'>${esc((x.time||'').replace('T',' ').slice(0,19))}</div>
  </div>`).join('')||"<div class='row'>No logs</div>";
  updateStats();
}

document.getElementById('cadd').onclick=async()=>{
  const n=document.getElementById('cname').value.trim(); if(!n){toast('Company name is required', false); return;}
  await j('/api/admin/companies',{method:'POST',body:JSON.stringify({id:state.editingCompanyId,name:n,vat_number:document.getElementById('cvat').value.trim(),registration_number:document.getElementById('creg').value.trim(),address_line1:document.getElementById('caddr').value.trim(),city:document.getElementById('ccity').value.trim(),postal_code:document.getElementById('czip').value.trim(),country:document.getElementById('ccountry').value.trim(),is_active:document.getElementById('cactive').checked})});
  toast(state.editingCompanyId?'Company updated':'Company created');
  resetCompanyForm();
  await loadCompanies();
  await loadUsers();
};
document.getElementById('ccancel').onclick=resetCompanyForm;
document.getElementById('lrefresh').onclick=loadLocks;
document.getElementById('arefresh').onclick=loadAudit;
document.getElementById('urefresh').onclick=loadUsers;
document.getElementById('ushowpass').onchange=(e)=>{const p=document.getElementById('upass'); if(p) p.type=e.target.checked?'text':'password';};
document.getElementById('urole').onchange=(e)=>{const c=document.getElementById('ucompany'); if(!c) return; c.disabled=(e.target.value==='superadmin');};
document.getElementById('usearch').oninput=()=>loadUsers();
document.getElementById('ucompany-filter').onchange=()=>loadUsers();
document.getElementById('actorf').oninput=()=>loadAudit();
document.getElementById('adate-from').onchange=()=>loadAudit();
document.getElementById('adate-to').onchange=()=>loadAudit();

// Bulk user actions
document.getElementById('ubulk-apply').onclick=async()=>{
  const role=document.getElementById('ubulk-role').value;
  if(!role){toast('Select a role first',false);return;}
  const ids=Array.from(state.selectedUserIds);
  if(ids.length===0) return;
  if(!(await appConfirm(`Assign role "${role}" to ${ids.length} user(s)?`, 'Bulk role change'))) return;
  let ok=0;
  for(const id of ids){
    try{ await j('/api/admin/users',{method:'POST',body:JSON.stringify({user_id:Number(id),role})}); ok++; }catch(e){ toast('Error updating user #'+id+': '+e.message, false); }
  }
  state.selectedUserIds.clear();
  toast(`Role updated for ${ok} user(s)`);
  await loadUsers();
};

document.getElementById('ubulk-deactivate').onclick=async()=>{
  const ids=Array.from(state.selectedUserIds);
  if(ids.length===0) return;
  if(!(await appConfirm(`Deactivate ${ids.length} user(s)?`, 'Bulk deactivate'))) return;
  let ok=0;
  for(const id of ids){
    try{ await j('/api/admin/users',{method:'POST',body:JSON.stringify({user_id:Number(id),is_active:false})}); ok++; }catch(e){ toast('Error deactivating user #'+id+': '+e.message, false); }
  }
  state.selectedUserIds.clear();
  toast(`Deactivated ${ok} user(s)`);
  await loadUsers();
};

document.getElementById('ubulk-clear').onclick=()=>{
  state.selectedUserIds.clear();
  document.querySelectorAll('.uchk').forEach(cb=>cb.checked=false);
  updateUserBulkBar();
};

// Bulk lock unlock
document.getElementById('lbulk-unlock').onclick=async()=>{
  const keys=Array.from(state.selectedLocks);
  if(keys.length===0) return;
  if(!(await appConfirm(`Force unlock ${keys.length} lock(s)?`, 'Bulk force unlock'))) return;
  let ok=0;
  for(const key of keys){
    try{ await j('/api/locks/force_unlock',{method:'POST',body:JSON.stringify({resource_key:key})}); ok++; }catch(e){ toast('Error unlocking: '+e.message, false); }
  }
  toast(`Unlocked ${ok} lock(s)`);
  await loadLocks();
};

document.getElementById('ucreate').onclick=async()=>{
  const username=document.getElementById('uname').value.trim();
  const password=document.getElementById('upass').value.trim();
  const role=document.getElementById('urole').value;
  const companyId=document.getElementById('ucompany').value||null;
  if(!username||!password){toast('username + password required', false);return;}
  if(role!=='superadmin' && !companyId){toast('Select company for this user', false);return;}
  await j('/api/admin/users',{method:'POST',body:JSON.stringify({create_user:true,username,email:document.getElementById('uemail').value.trim(),password,role,company_id:companyId})});
  ['uname','uemail','upass'].forEach(id=>document.getElementById(id).value='');
  toast('User created');
  await loadUsers();
};

function updateMegaClock(){
  const d = new Date();
  const txt = d.toLocaleDateString('cs-CZ', { weekday:'short', day:'2-digit', month:'2-digit', year:'numeric' }) + ' ‚Ä¢ ' + d.toLocaleTimeString('cs-CZ', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
  const el = document.getElementById('mega-clock');
  if (el) el.textContent = txt;
}
updateMegaClock();
setInterval(updateMegaClock, 1000);

Promise.all([loadCompanies(), loadUsers(), loadLocks(), loadAudit()]).catch(e=>toast('Admin load failed: '+e.message,false));
</script>
</body>
</html>
